<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commercial / Sales Finance Model ¬∑ FP&A Portfolio</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    /* Prevent horizontal overflow */
    html, body { overflow-x: clip; }

    /* module-hero, module-label, module-title, module-pill, module-subtitle,
       module-problem, module-role, feature-chips, chip ‚Äî all in style.css */
    
    /* Main layout with sidebar */
    .module-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      align-items: start;
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    
    /* Sticky sidebar */
    .data-badge {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15,118,110,0.10);
      border: 1px solid rgba(15,118,110,0.20);
      color: var(--accent);
      font-weight: 600;
      display: inline-block;
      margin-bottom: 12px;
    }
    
    /* Main content area */
    .main-content {
      min-width: 0;
    }
    
    /* Module sections */
    .module-section {
      padding: 0 0 48px 0;
    }
    .module-section-title {
      font-size: 24px;
      margin-bottom: 20px;
      letter-spacing: -0.02em;
    }
    .module-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-soft);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .card-title {
      font-size: 18px;
      font-weight: 650;
    }
    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* Buttons */
    .btn-small {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 999px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 140ms ease;
      white-space: nowrap;
    }
    .btn-small:hover {
      border-color: rgba(12, 23, 45, 0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.06);
    }
    .btn-small:active {
      transform: translateY(1px);
    }
    .btn-primary {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }
    .btn-primary:hover {
      box-shadow: 0 6px 18px rgba(11,18,32,0.12);
    }
    .btn-full {
      width: 100%;
      justify-content: center;
      display: flex;
    }
    
    /* KPI grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .kpi-box {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: rgba(246,248,251,0.6);
    }
    .kpi-box-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .kpi-box-value {
      font-size: 20px;
      font-weight: 650;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin: 16px 0;
    }
    .data-table th {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 2px solid var(--border);
      font-weight: 650;
      color: var(--text);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .data-table tr:last-child td {
      border-bottom: none;
    }
    .data-table tr:hover {
      background: rgba(246,248,251,0.5);
    }
    
    /* Charts */
    .chart-container { overflow-anchor: none;
      margin: 20px 0;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .chart-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 16px;
      color: var(--text);
    }
    .chart-canvas {
      display: block;
      width: 100%;
      height: auto;
    }
    
    /* Input grid */
    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }
    .input-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-field label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }
    .input-field input {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: var(--font-sans);
      background: white;
    }
    .input-field input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* File upload */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    /* Demo section */
    .demo-section {
      padding: 32px 0;
      border-top: 1px solid var(--border);
    }
    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
    }
    .demo-card {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .demo-card-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 8px;
    }
    .demo-card-text {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    
    /* Tooltips */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      border-bottom: 1px dotted var(--muted);
    }
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: var(--text);
      color: white;
      font-size: 12px;
      border-radius: 8px;
      white-space: nowrap;
      z-index: 100;
      margin-bottom: 6px;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .module-layout {
        grid-template-columns: 1fr;
      }
    }

    /* ---- Decision Box ---- */
    .decision-box {
      background: white;
      border: 1.5px solid var(--accent);
      border-radius: var(--radius);
      padding: 20px 24px;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.08), var(--shadow-soft);
      margin-bottom: 24px;
      transition: border-color 200ms ease, box-shadow 200ms ease, background 200ms ease;
    }
    /* Positive ‚Äî green */
    .decision-box--positive {
      border-color: #0f766e;
      background: #f0fdf9;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.10), var(--shadow-soft);
    }
    .decision-box--positive .decision-box-eyebrow { color: #0f766e; }
    .decision-box--positive .verdict-action        { color: #0f766e; }
    .decision-box--positive .decision-box-bullets li::before { color: #0f766e; }
    /* Negative ‚Äî red */
    .decision-box--negative {
      border-color: #dc2626;
      background: #fef2f2;
      box-shadow: 0 0 0 4px rgba(220,38,38,0.10), var(--shadow-soft);
    }
    .decision-box--negative .decision-box-eyebrow { color: #dc2626; }
    .decision-box--negative .verdict-action        { color: #dc2626; }
    .decision-box--negative .decision-box-bullets li::before { color: #dc2626; }
    .decision-box-eyebrow {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--accent);
      margin-bottom: 8px;
    }
    .decision-box-verdict {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
      margin-bottom: 12px;
    }
    .decision-box-verdict .verdict-action {
      color: var(--accent);
    }
    .decision-box-bullets {
      list-style: none;
      margin: 0 0 10px 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .decision-box-bullets li {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: flex-start;
      gap: 8px;
      line-height: 1.4;
    }
    .decision-box-bullets li::before {
      content: '‚Ä∫';
      color: var(--accent);
      font-weight: 700;
      flex-shrink: 0;
    }
    .decision-box-next {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }
    .decision-box-next span {
      color: var(--accent-2);
    }
    .decision-box-fallback {
      font-size: 14px;
      color: var(--muted);
      font-style: italic;
    }
      .main-content { overflow-anchor: none; }
    .module-card { overflow-anchor: none; }
    .data-table { overflow-anchor: none; }
  
    /* ‚îÄ‚îÄ Data-needed strip ‚îÄ‚îÄ */
    .data-needed-section {
      padding: 0 0 0 0;
      border-bottom: 1px solid var(--border, #e5e8ef);
    }
    .data-needed-wrap {
      max-width: var(--max-w, 1200px);
      margin: 0 auto;
      padding: 20px 32px 24px;
    }
    .data-needed-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--muted, #6b7280);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .data-needed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(185px, 1fr));
      gap: 8px;
      align-items: stretch;
    }
    .data-needed-item {
      padding: 10px 12px;
      border: 1px solid var(--border, #e5e8ef);
      border-radius: 9px;
      display: flex;
      align-items: flex-start;
      gap: 9px;
      background: #fafbfc;
      min-height: 88px;
      box-sizing: border-box;
    }
    .data-needed-icon {
      width: 26px;
      height: 26px;
      font-size: 13px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .data-needed-name {
      font-size: 11px;
      font-weight: 700;
      color: var(--text, #0b1220);
      margin-bottom: 3px;
      line-height: 1.35;
    }
    .data-needed-desc {
      font-size: 10px;
      color: var(--muted, #6b7280);
      line-height: 1.5;
    }


    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SIDEBAR ‚Äî Accordion (shared across all modules)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .sidebar {
      position: sticky;
      top: 80px;
      padding: 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(12,23,45,0.15) transparent;
    }
    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }
    .sidebar::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.28); }

    /* Static top section (data mode badge + always-visible controls) */
    .sb-static {
      padding-bottom: 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }
    .sb-static-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    /* Accordion group */
    .sb-acc-group {
      border-bottom: 1px solid var(--border);
    }
    .sb-acc-group:last-child { border-bottom: none; }

    .sb-acc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 12px 0;
      cursor: pointer;
      user-select: none;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      transition: color 120ms ease;
    }
    .sb-acc-header:hover { color: var(--text); }
    .sb-acc-header.open  { color: var(--text); }
    .sb-acc-chevron {
      font-size: 10px;
      color: var(--muted);
      transition: transform 200ms ease;
      flex-shrink: 0;
    }
    .sb-acc-header.open .sb-acc-chevron {
      transform: rotate(180deg);
      color: var(--text);
    }
    .sb-acc-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft, rgba(15,118,110,0.10));
      color: var(--accent, #0f766e);
      flex-shrink: 0;
      margin-left: auto;
    }

    .sb-acc-body {
      display: none;
      padding-bottom: 14px;
    }
    .sb-acc-body.open { display: block; }

    /* Buttons inside accordion */
    .sb-acc-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      transition: all 140ms ease;
      text-align: left;
      white-space: nowrap;
      font-family: inherit;
    }
    .sb-acc-btn:first-child { margin-top: 0; }
    .sb-acc-btn:hover {
      border-color: rgba(12,23,45,0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.06);
    }
    .sb-acc-btn:active { transform: translateY(1px); }
    .sb-acc-btn.primary { background: var(--text, #0b1220); color: white; border-color: var(--text, #0b1220); }
    .sb-acc-btn.primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-acc-btn.accent  { background: var(--accent, #0f766e); color: white; border-color: var(--accent, #0f766e); }

    /* Scenario tabs inside accordion */
    .sb-acc-tabs { display: flex; flex-direction: column; gap: 6px; }
    .sb-acc-tab {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 140ms ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }
    .sb-acc-tab:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-tab.active { background: var(--text, #0b1220); color: white; border-color: var(--text, #0b1220); }

    /* Input rows inside accordion */
    .sb-acc-input-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .sb-acc-input-row:last-child { margin-bottom: 0; }
    .sb-acc-input-row label {
      font-size: 11px;
      color: var(--muted, #5d6b7a);
      flex: 1;
      line-height: 1.3;
    }
    .sb-acc-input-row input[type="number"] {
      width: 76px;
      padding: 5px 7px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      background: white;
      text-align: right;
      flex-shrink: 0;
      -moz-appearance: textfield;
    }
    .sb-acc-input-row input[type="number"]::-webkit-outer-spin-button,
    .sb-acc-input-row input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .sb-acc-input-row input[type="number"]:focus {
      outline: none;
      border-color: var(--accent, #0f766e);
      box-shadow: 0 0 0 2px rgba(15,118,110,0.15);
    }
    .sb-acc-sub {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.07em;
      text-transform: uppercase;
      margin: 10px 0 8px;
      border-top: 1px solid var(--border);
      padding-top: 9px;
    }

    /* Responsive: on mobile sidebar goes full width, no sticky, no scroll */
    @media (max-width: 860px) {
      .sidebar {
        position: static;
        max-height: none;
        overflow-y: visible;
      }
    }

  
    /* ‚îÄ‚îÄ Tooltip engine: body-level fixed div, never clipped by overflow ‚îÄ‚îÄ */
    /* Kill ALL CSS ::after tooltip rules ‚Äî they clip inside overflow containers */
    .help-icon::after,
    .help-icon:hover::after,
    .help-icon[data-help]::after,
    [data-tt]::after,
    [data-tt]:hover::after,
    .term-helper::after,
    .term-helper:hover::after {
      content: none !important;
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }

    /* #tt-root ‚Äî single fixed tooltip bubble appended to <body> by JS */
    #tt-root {
      position: fixed;
      z-index: 99999;
      pointer-events: none;
      padding: 9px 13px;
      background: rgba(11,18,32,0.95);
      color: #f0f4f8;
      font-size: 12px;
      font-weight: 400;
      line-height: 1.55;
      border-radius: 9px;
      white-space: normal;
      width: 270px;
      max-width: calc(100vw - 24px);
      box-shadow: 0 4px 18px rgba(0,0,0,0.28);
      text-align: left;
      opacity: 0;
      transition: opacity 120ms ease;
    }
    #tt-root.tt-visible { opacity: 1; }

    /* .help-icon visual ‚Äî keep the badge, remove position:relative (no longer needed) */
    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(15,118,110,0.10);
      border: 1px solid rgba(15,118,110,0.20);
      color: var(--accent);
      font-size: 11px;
      font-weight: 700;
      cursor: help;
      flex-shrink: 0;
      position: static;   /* was relative ‚Äî not needed with body-level tooltip */
    }
    .help-icon::before { content: '?'; line-height: 1; }

  
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SHARED SIDEBAR SHELL ‚Äî standardised across all modules
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* Layout */
    .module-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      align-items: start;
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .main-content { min-width: 0; }

    /* Mobile Controls Toggle Button */
    .mobile-controls-btn {
      display: none;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      cursor: pointer;
      margin-bottom: 4px;
      box-shadow: var(--shadow-soft);
      transition: all 140ms ease;
    }
    .mobile-controls-btn:hover {
      border-color: rgba(12,23,45,0.18);
      box-shadow: var(--shadow);
    }
    .mobile-controls-btn .mcb-icon { font-size: 16px; flex-shrink: 0; }
    .mobile-controls-btn .mcb-label { flex: 1; text-align: left; }
    .mobile-controls-btn .mcb-chevron {
      font-size: 11px; color: var(--muted);
      transition: transform 200ms ease;
    }
    .mobile-controls-btn[aria-expanded="true"] .mcb-chevron { transform: rotate(180deg); }

    /* Sidebar shell */
    .sidebar {
      position: sticky;
      top: 84px;
      padding: 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      max-height: calc(100vh - 104px);
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(12,23,45,0.15) transparent;
      width: 280px;
    }
    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }
    .sidebar::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.28); }

    /* Static section (Data Mode etc ‚Äî always visible) */
    .sb-static {
      padding-bottom: 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }
    .sb-static-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    /* ‚îÄ‚îÄ Data Mode segmented control (fixed height, no wrapping) ‚îÄ‚îÄ */
    .sb-data-mode-row {
      display: flex;
      gap: 0;
      height: 34px;              /* fixed height ‚Äî prevents layout shift */
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: var(--bg-muted);
      flex-wrap: nowrap;         /* never wrap */
    }
    .sb-data-mode-btn {
      flex: 1;
      min-width: 0;
      height: 100%;
      padding: 0 4px;
      background: transparent;
      border: none;
      border-right: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: background 120ms ease, color 120ms ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: inherit;
    }
    .sb-data-mode-btn:last-child { border-right: none; }
    .sb-data-mode-btn:hover { background: rgba(12,23,45,0.04); color: var(--text); }
    .sb-data-mode-btn.active {
      background: var(--text);
      color: white;
    }

    /* Mode pills (2-option) ‚Äî also fixed height */
    .sb-mode-pills {
      display: flex;
      gap: 0;
      height: 34px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: var(--bg-muted);
      flex-wrap: nowrap;
    }
    .sb-mode-pill {
      flex: 1;
      height: 100%;
      padding: 0 6px;
      border: none;
      border-right: 1px solid var(--border);
      background: transparent;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: background 120ms ease, color 120ms ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: inherit;
      text-align: center;
    }
    .sb-mode-pill:last-child { border-right: none; }
    .sb-mode-pill:hover { background: rgba(12,23,45,0.04); color: var(--text); }
    .sb-mode-pill.active { background: var(--text); color: white; }

    /* Badge */
    .data-badge {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15,118,110,0.10);
      border: 1px solid rgba(15,118,110,0.20);
      color: var(--accent);
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .data-badge.random {
      background: #fef3c7;
      border-color: #fbbf24;
      color: #92400e;
    }

    /* Accordion groups */
    .sb-acc-group {
      border-bottom: 1px solid var(--border);
    }
    .sb-acc-group:last-child { border-bottom: none; }

    .sb-acc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 12px 0;
      cursor: pointer;
      user-select: none;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      transition: color 120ms ease;
      font-family: inherit;
    }
    .sb-acc-header:hover { color: var(--text); }
    .sb-acc-header.open  { color: var(--text); }
    .sb-acc-chevron {
      font-size: 10px;
      color: var(--muted);
      transition: transform 200ms ease;
      flex-shrink: 0;
    }
    .sb-acc-header.open .sb-acc-chevron { transform: rotate(180deg); color: var(--text); }
    .sb-acc-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      flex-shrink: 0;
      margin-left: auto;
    }

    .sb-acc-body {
      display: none;
      padding-bottom: 14px;
    }
    .sb-acc-body.open { display: block; }

    /* Buttons inside accordion */
    .sb-acc-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      transition: all 140ms ease;
      text-align: left;
      white-space: nowrap;
      font-family: inherit;
    }
    .sb-acc-btn:first-child { margin-top: 0; }
    .sb-acc-btn:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-btn:active { transform: translateY(1px); }
    .sb-acc-btn.primary { background: var(--text); color: white; border-color: var(--text); }
    .sb-acc-btn.primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-acc-btn.accent  { background: var(--accent); color: white; border-color: var(--accent); }

    /* Tabs (scenario selectors etc.) */
    .sb-acc-tabs { display: flex; flex-direction: column; gap: 6px; }
    .sb-acc-tab {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 140ms ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }
    .sb-acc-tab:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-tab.active { background: var(--text); color: white; border-color: var(--text); }

    /* Input rows */
    .sb-acc-input-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .sb-acc-input-row:last-child { margin-bottom: 0; }
    .sb-acc-input-row label {
      font-size: 11px;
      color: var(--muted);
      flex: 1;
      line-height: 1.3;
    }
    .sb-acc-input-row input[type="number"] {
      width: 76px;
      padding: 5px 7px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      background: white;
      text-align: right;
      flex-shrink: 0;
      -moz-appearance: textfield;
    }
    .sb-acc-input-row input[type="number"]::-webkit-outer-spin-button,
    .sb-acc-input-row input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .sb-acc-input-row input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(15,118,110,0.15);
    }
    .sb-acc-sub {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.07em;
      text-transform: uppercase;
      margin: 10px 0 8px;
      border-top: 1px solid var(--border);
      padding-top: 9px;
    }

    /* Action buttons (full-width) */
    .sb-action-btn {
      display: flex; align-items: center; gap: 8px;
      width: 100%; padding: 7px 12px;
      border-radius: 999px; border: 1px solid var(--border);
      background: white; font-size: 12px; font-weight: 600;
      cursor: pointer; margin-top: 6px;
      transition: all 140ms ease; text-align: left;
      white-space: nowrap; font-family: inherit;
    }
    .sb-action-btn:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-action-btn:active { transform: translateY(1px); }
    .sb-action-btn.sb-action-primary { background: var(--text); color: white; border-color: var(--text); }
    .sb-action-btn.sb-action-primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-action-btn.sb-action-accent  { background: var(--accent); color: white; border-color: var(--accent); }
    .sb-file-hidden { position: absolute; opacity: 0; width: 0; height: 0; }

    /* Sliders */
    .control-item { margin-bottom: 16px; }
    .control-item:last-child { margin-bottom: 0; }
    .control-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }
    .control-value {
      font-size: 13px;
      font-weight: 700;
      color: var(--accent-2);
      font-family: var(--font-mono, monospace);
    }
    .control-input {
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 6px;
      border-radius: 3px;
      background: var(--bg-muted);
      outline: none; cursor: pointer;
    }
    .control-input::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
      box-shadow: 0 2px 8px rgba(15,118,110,0.3);
      transition: all 140ms ease;
    }
    .control-input::-webkit-slider-thumb:hover { transform: scale(1.1); }
    .control-input::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
      box-shadow: 0 2px 8px rgba(15,118,110,0.3); border: none;
    }

    /* ‚îÄ‚îÄ Mobile responsive ‚îÄ‚îÄ */
    @media (max-width: 860px) {
      .module-layout {
        grid-template-columns: 1fr;
        padding: 16px;
      }
      .mobile-controls-btn { display: flex; }
      .sidebar {
        position: static;
        top: 0;
        width: 100%;
        max-height: none;
        overflow-y: visible;
        display: none;            /* hidden by default; JS toggles */
        border-radius: var(--radius-sm);
        margin-bottom: 8px;
      }
      .sidebar.mobile-open { display: block; }
    }

    @media (max-width: 560px) {
      .module-layout { padding: 12px; }
    }


</style>
</head>
<body>

  <a href="#main-content" class="skip-link">Skip to content</a>

  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html" class="brand">
          <span class="brand-mark" aria-hidden="true"></span>
          Ralph Patrick Divina
        </a>
        <div class="nav-cta">
          <a href="index.html#card-commercial-sales" class="btn btn-ghost">‚Üê Back to Portfolio</a>
        </div>
      </nav>
    </div>
  </header>

  <main id="main-content">
    
    <!-- Hero -->
    <section class="module-hero">
      <div class="container">
        <div class="module-eyebrow">Commercial &bull; Revenue Decisions</div>
        <h1 class="module-title">Commercial / Sales Finance Model</h1>
        <p class="module-subtitle">Quantify price, volume, mix, and trade spend impact on margin and profitability.</p>
        <div class="feature-chips">
          <span class="chip">Price/Volume/Mix</span>
          <span class="chip">Promo ROI</span>
          <span class="chip">Channel P&amp;L</span>
          <span class="chip">Accrual Logic</span>
        </div>
      </div>
    </section>

  <!-- DATA NEEDED STRIP -->
  <div class="data-needed-section">
    <div class="data-needed-wrap">
      <div class="data-needed-label">üìÇ &nbsp;Data needed for this module</div>
      <div class="data-needed-grid">
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#eff6ff;">üìä</div><div><div class="data-needed-name">Channel P&L Report</div><div class="data-needed-desc">Revenue &amp; cost broken out by sales channel ‚Üí drives margin analysis</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#f0fdf9;">üè∑Ô∏è</div><div><div class="data-needed-name">Pricing &amp; Rate Cards</div><div class="data-needed-desc">List prices, discount tiers &amp; promotional rates ‚Üí price/volume/mix</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#fef3c7;">üìã</div><div><div class="data-needed-name">Promotion Log</div><div class="data-needed-desc">Past and current promo details &amp; spend ‚Üí measures ROI pre/post</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#f5f3ff;">üí∞</div><div><div class="data-needed-name">Accrual Schedule</div><div class="data-needed-desc">Trade spend accruals &amp; settlements ‚Üí keeps P&L from being misstated</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#fdf2f8;">üìÑ</div><div><div class="data-needed-name">Sales Order Data</div><div class="data-needed-desc">Volume sold per SKU/channel by period ‚Üí quantity &amp; mix drivers</div></div></div>
      </div>
    </div>
  </div>

    <!-- Main Layout with Sidebar -->
    <div class="module-layout">
      
      <!-- Sticky Sidebar -->
          <!-- Mobile Controls Toggle (hidden on desktop) -->
    <button class="mobile-controls-btn" id="mobileControlsBtn" aria-expanded="false">
      <span class="mcb-icon">&#9881;</span>
      <span class="mcb-label">Controls</span>
      <span class="mcb-chevron">&#9660;</span>
    </button>
    <aside class="sidebar" id="sidebarPanel">

      <!-- DATA MODE ‚Äî always visible -->
      <div class="sb-static">
        <div class="sb-static-title">
          <span>DATA MODE</span>
          <span id="dataModeBadge" class="data-badge">SAMPLE</span>
        </div>
        <div style="display:flex;gap:0;height:34px;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--bg-muted);flex-wrap:nowrap;">
          <button id="btnSampleMode" onclick="loadWinningPromo()" style="flex:1;height:100%;padding:0 4px;background:var(--text);color:white;border:none;border-right:1px solid var(--border);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;">Sample</button>
          <button id="btnRandomMode" onclick="randomizeSampleData()" style="flex:1;height:100%;padding:0 4px;background:transparent;border:none;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;font-family:inherit;">Random</button>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:6px;line-height:1.4;">Sample = fixed demo dataset &bull; Random = generated dataset</div>
      </div>

      <!-- Actions -->
      <div class="sb-acc-group">
        <button class="sb-acc-header" onclick="sidebarAccordion(this)">
          <span>Actions</span>
          <span class="sb-acc-chevron">‚ñº</span>
        </button>
        <div class="sb-acc-body">
          <button onclick="downloadAllTemplates()" class="sb-acc-btn">Download Templates</button>
        </div>
      </div>

    </aside>

      <!-- Main Content -->
      <div class="main-content">

        <!-- Promotion ROI Analysis -->
        <section class="module-section">

          <!-- DECISION BOX: pinned at very top of Promo ROI section -->
          <div class="decision-box" id="promoDecisionBox" aria-label="Promo ROI Decision">
            <div class="decision-box-eyebrow">Decision</div>
            <div class="decision-box-fallback" id="promoDecisionFallback">Load sample or upload data to see the decision.</div>
            <div id="promoDecisionContent" style="display:none;">
              <div class="decision-box-verdict" id="promoDecisionVerdict"></div>
              <ul class="decision-box-bullets" id="promoDecisionBullets"></ul>
              <div class="decision-box-next" id="promoDecisionNext"></div>
            </div>
          </div>

          <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
            1. Promotion ROI Analysis
            <span class="help-icon" data-help="Shows whether a promotion actually made money. Compare revenue and profit before vs. during a promo ‚Äî after accounting for discounts and campaign costs ‚Äî to decide if it's worth running again."></span>
          </h2>

          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">Before / After Comparison</h3>
              <div class="card-actions">
                <button onclick="downloadPromoCSV()" class="btn-small">Export Results</button>
                <button onclick="downloadPromoTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="promoUpload" accept=".csv" onchange="handlePromoUpload(event)">
                </div>
              </div>
            </div>

            <div class="input-grid">
              <div class="input-field">
                <label>Baseline Revenue <span class="help-icon" data-help="How much money you made before the promotion ran. This is your normal, business-as-usual sales number ‚Äî the starting point to measure uplift against."></span></label>
                <input type="number" id="baselineRev" value="50000" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Promo Revenue <span class="help-icon" data-help="How much money you made during the promotion period. Compare this to Baseline Revenue to see if the promo actually drove more sales."></span></label>
                <input type="number" id="promoRev" value="85000" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Baseline GP% <span class="help-icon" data-help="Gross Profit % before the promo ‚Äî for every $100 in normal sales, how many dollars are left after paying for the product itself. Your healthy, unaffected margin benchmark."></span></label>
                <input type="number" step="0.1" id="baselineGP" value="42" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Promo GP% <span class="help-icon" data-help="Gross Profit % during the promo. Discounts usually push this lower than baseline. If this drops too much, the extra volume from the promo may not be worth it."></span></label>
                <input type="number" step="0.1" id="promoGP" value="28" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Promo Cost <span class="help-icon" data-help="What you spent to run the promotion ‚Äî ads, coupons, retailer fees, display materials, etc. This is the investment you need to earn back through incremental profit."></span></label>
                <input type="number" id="promoCost" value="12000" onchange="withStableScroll(computePromoROI)">
              </div>
            </div>

            <div class="kpi-grid" id="promoKPIs">
              <!-- KPIs populated by JS -->
            </div>

            <div style="overflow-x:auto;"><table class="data-table" id="promoTable">
              <!-- Table populated by JS -->
            </table></div>
          </div>
        </section>

        <!-- Channel P&L -->
        <section class="module-section">
          <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
            2. Channel-level P&amp;L
            <span class="help-icon" data-help="Breaks down revenue and profit by sales channel (e.g. retail, online, direct). Helps you see which channels are actually profitable after costs ‚Äî not just which ones sell the most."></span>
          </h2>
          
          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">12-Month Channel Performance</h3>
              <div class="card-actions">
                <label>Month:</label>
                <select id="channelMonthFilter" onchange="withStableScroll(renderChannelPL)">
                  <option value="all">All Months</option>
                </select>
                <label>Channel:</label>
                <select id="channelFilter" onchange="withStableScroll(renderChannelPL)">
                  <option value="all">All Channels</option>
                </select>
                <button onclick="downloadChannelCSV()" class="btn-small">Export Data</button>
                <button onclick="downloadChannelTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="channelUpload" accept=".csv" onchange="handleChannelUpload(event)">
                </div>
              </div>
            </div>

            <div class="chart-container">
              <div class="chart-title">Revenue by Channel</div>
              <canvas id="channelChart" class="chart-canvas"></canvas>
            </div>

            <!-- So What: 12-Month Channel Performance -->
            <div style="margin:16px 0 8px;padding:18px 20px;border:1.5px solid rgba(15,118,110,0.25);border-radius:14px;background:#f0fdf9;box-shadow:0 2px 8px rgba(15,118,110,0.06);">
              <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#0f766e;margin-bottom:8px;">üí° So What ‚Äî 12-Month Channel Performance</div>
              <ul style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;">
                <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚Ä∫</span>This chart shows which channels are generating the most revenue and which are underperforming relative to their cost and promotion investment ‚Äî the foundation for trade spend reallocation decisions.</li>
                <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚Ä∫</span>Channels with high revenue but low gross margin are consuming promotion budget without delivering bottom-line return ‚Äî a common pattern in trade spend that signals price or discount architecture issues.</li>
                <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚Ä∫</span><strong style="color:#0b1220;">If one channel dominates revenue:</strong> Assess concentration risk ‚Äî dependence on a single retailer or platform creates negotiating leverage risk. Model the impact of a 15% volume loss in that channel.</li>
                <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚Ä∫</span><strong style="color:#0b1220;">If a channel is declining:</strong> Run a price/volume/mix decomposition before cutting the budget ‚Äî revenue decline may reflect mix shift, not structural volume loss, requiring different remediation.</li>
              </ul>
            </div>

            <div style="overflow-x:auto;"><table class="data-table" id="channelTable">
              <!-- Table populated by JS -->
            </table></div>
          </div>
        </section>

        <!-- Price/Volume/Mix Bridge -->
        <section class="module-section">
          <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
            3. Price / Volume / Mix Bridge
            <span class="help-icon" data-help="Explains why revenue went up or down. Was it because you raised prices? Sold more units? Or sold a different mix of products? This splits the total change into those three causes so you know exactly what to fix."></span>
          </h2>
          
          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">Revenue Variance Decomposition <span class="help-icon" data-help="'Variance' just means 'the difference.' This card decomposes (breaks apart) the revenue difference between two periods into exactly what caused it ‚Äî price changes, volume changes, or product mix changes ‚Äî so leadership knows where to act."></span></h3>
              <div class="card-actions">
                <button onclick="downloadPVMCSV()" class="btn-small">Export Analysis</button>
                <button onclick="downloadPVMTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="pvmUpload" accept=".csv" onchange="handlePVMUpload(event)">
                </div>
              </div>
            </div>

            <div class="input-grid">
              <div class="input-field">
                <label>Prior Period Revenue <span class="help-icon" data-help="Your total revenue in the previous period (e.g. last quarter or last year). This is the starting point ‚Äî the number you're measuring the change from."></span></label>
                <input type="number" id="priorRev" value="120000" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Current Period Revenue <span class="help-icon" data-help="Your total revenue in the current period. The gap between this and Prior Period Revenue is what we're breaking down into its three root causes: price, volume, and mix."></span></label>
                <input type="number" id="currentRev" value="138000" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Price Effect (%) <span class="help-icon" data-help="How much of the revenue change came from charging more (or less) per unit. Positive = you raised prices. Negative = you cut prices. Helps isolate pricing decisions from sales volume."></span></label>
                <input type="number" step="0.1" id="priceEffect" value="5.2" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Volume Effect (%) <span class="help-icon" data-help="How much of the revenue change came from selling more (or fewer) units. Positive = you sold more. This is usually the clearest signal of whether demand is growing or shrinking."></span></label>
                <input type="number" step="0.1" id="volumeEffect" value="8.5" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Mix Effect (%) <span class="help-icon" data-help="How much of the revenue change came from selling a different blend of products ‚Äî more premium vs. entry-level SKUs. Positive mix = shifted toward higher-priced items. Negative = shifted toward cheaper ones."></span></label>
                <input type="number" step="0.1" id="mixEffect" value="1.3" onchange="computePVM()">
              </div>
            </div>

            <div class="kpi-grid" id="pvmKPIs">
              <!-- KPIs populated by JS -->
            </div>

            <div class="chart-container">
              <div class="chart-title">Waterfall Bridge</div>
              <canvas id="pvmChart" class="chart-canvas"></canvas>
            </div>

            <!-- ‚îÄ‚îÄ PVM Explainer Box ‚îÄ‚îÄ -->
            <div id="pvmExplainer" style="display:none;margin-top:20px;padding-top:20px;border-top:1px solid var(--border);">

              <!-- Live callout strip -->
              <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:14px;margin-bottom:18px;padding:14px 18px;border-radius:12px;background:rgba(15,118,110,0.05);border:1.5px solid rgba(15,118,110,0.16);">
                <div>
                  <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);margin-bottom:4px;">Total Revenue Variance</div>
                  <div style="display:flex;align-items:baseline;gap:10px;">
                    <span id="pvmTotalValue" style="font-size:34px;font-weight:800;letter-spacing:-0.03em;color:var(--text);">‚Äî</span>
                    <span id="pvmTotalPct" style="font-size:14px;font-weight:700;color:var(--muted);"></span>
                    <span id="pvmTotalBadge" style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:999px;"></span>
                  </div>
                </div>
                <div style="display:flex;gap:16px;flex-wrap:wrap;padding-top:4px;">
                  <div style="text-align:center;">
                    <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);margin-bottom:4px;">üí∞ Price</div>
                    <div id="pvmPricePill" style="font-size:12px;font-weight:700;padding:4px 11px;border-radius:999px;"></div>
                  </div>
                  <div style="text-align:center;">
                    <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);margin-bottom:4px;">üì¶ Volume</div>
                    <div id="pvmVolumePill" style="font-size:12px;font-weight:700;padding:4px 11px;border-radius:999px;"></div>
                  </div>
                  <div style="text-align:center;">
                    <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);margin-bottom:4px;">üîÄ Mix</div>
                    <div id="pvmMixPill" style="font-size:12px;font-weight:700;padding:4px 11px;border-radius:999px;"></div>
                  </div>
                </div>
              </div>

              <!-- Section label -->
              <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--text);margin-bottom:10px;">üìñ What you're looking at</div>

              <!-- Dynamic verdict block -->
              <div id="pvmVerdictBlock" style="padding:14px 16px;border-radius:10px;font-size:13px;line-height:1.65;margin-bottom:14px;"></div>

              <!-- Biggest lever highlight -->
              <div id="pvmLeverBlock" style="padding:10px 14px;border-radius:8px;font-size:12px;line-height:1.6;margin-bottom:16px;background:rgba(27,77,122,0.05);border:1px solid rgba(27,77,122,0.12);color:var(--text);"></div>

              <!-- Static framework explanation -->
              <div style="font-size:12px;color:var(--muted);line-height:1.75;border-top:1px solid var(--border);padding-top:14px;">
                <strong style="color:var(--text);">How to read this bridge:</strong>
                Every dollar of revenue variance has exactly one of three root causes ‚Äî and the waterfall stacks them to show how you got from Prior to Current.
                <strong>Price</strong> captures what changed because you charged more or less per unit.
                <strong>Volume</strong> captures what changed because you sold more or fewer units overall.
                <strong>Mix</strong> captures what changed because the blend of what you sold shifted toward higher- or lower-priced products.
                If Volume is green but Mix is red, you're selling more units of the wrong thing ‚Äî a classic sign to rebalance the portfolio or revisit SKU strategy.
              </div>
            </div>
            <!-- ‚îÄ‚îÄ end PVM Explainer ‚îÄ‚îÄ -->
          </div>
        </section>

        <!-- Discount & Accrual Schedule -->
        <section class="module-section">
          <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
            4. Discount &amp; Accrual Schedule
            <span class="help-icon" data-help="Tracks how discount costs are spread evenly across months instead of hitting all at once. This keeps your monthly profit figures accurate and prevents surprises at quarter-end when trade deals get settled."></span>
          </h2>
          
          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">Straight-line Accrual Logic <span class="help-icon" data-help="'Straight-line' means the cost is divided equally across every month of the deal ‚Äî no lumpy spikes. 'Accrual' means recognizing the cost as it's earned/incurred, not when cash actually moves. This prevents your December P&L from getting hit with the full year's discount bill at once."></span></h3>
              <div class="card-actions">
                <button onclick="downloadAccrualCSV()" class="btn-small">Export Schedule</button>
                <button onclick="downloadAccrualTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="accrualUpload" accept=".csv" onchange="handleAccrualUpload(event)">
                </div>
              </div>
            </div>

            <div class="input-grid">
              <div class="input-field">
                <label>Total Discount Pool ($) <span class="help-icon" data-help="The total amount of discounts or trade spend committed for the deal or campaign. Instead of booking this all in one month, it gets spread evenly ‚Äî keeping your monthly P&L clean and predictable."></span></label>
                <input type="number" id="discountPool" value="48000" onchange="computeAccrual()">
              </div>
              <div class="input-field">
                <label>Start Month <span class="help-icon" data-help="The first month the discount or trade deal kicks in. Accruals begin here, so your books show the cost building up from day one rather than all hitting at settlement."></span></label>
                <input type="number" id="startMonth" value="1" min="1" max="12" onchange="computeAccrual()">
              </div>
              <div class="input-field">
                <label>End Month <span class="help-icon" data-help="The last month of the deal. The total discount pool is divided equally across all months between Start and End ‚Äî so each period absorbs its fair share of the cost."></span></label>
                <input type="number" id="endMonth" value="12" min="1" max="12" onchange="computeAccrual()">
              </div>
            </div>

            <div style="overflow-x:auto;"><table class="data-table" id="accrualTable">
              <!-- Table populated by JS -->
            </table></div>
          </div>
        </section>

        <!-- What This Demonstrates -->
        <section class="demo-section">
          <h2 class="module-section-title">What This Demonstrates</h2>
          <div class="demo-grid">
            <div class="demo-card">
              <div class="demo-card-title">Revenue Quality, Not Just Quantity</div>
              <div class="demo-card-text">
                Promotion ROI and PVM analysis reveal whether growth is margin-accretive or just expensive volume.
              </div>
            </div>
            <div class="demo-card">
              <div class="demo-card-title">Channel Economics That Matter</div>
              <div class="demo-card-text">
                Move beyond top-line dashboards to channel-level P&Ls that expose true profitability.
              </div>
            </div>
            <div class="demo-card">
              <div class="demo-card-title">Finance-Grade Accrual Logic</div>
              <div class="demo-card-text">
                Clean discount accrual schedules reduce audit risk and month-end chaos.
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>

  
  <!-- ‚îÄ‚îÄ Next Module ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <nav class="next-module-bar" aria-label="Next recommended module">
    <div>
      <div class="next-module-label">Next recommended</div>
      <div class="next-module-title">Revenue Bridge &amp; Cohort Retention</div>
      <div class="next-module-why">You know channel profit ‚Äî now see if that revenue is actually being retained over time.</div>
    </div>
    <div class="next-module-actions">
      <a class="btn btn-solid" href="revenue-bridge.html">Open Revenue Bridge ‚Üí</a>
      <a class="btn btn-ghost" href="index.html">‚Üê Back to Portfolio</a>
    </div>
  </nav>

</main>

  <a href="#" class="to-top" aria-label="Back to top">‚Üë</a>

  <script src="main.js"></script>
  <script>
    /* =========================================
       Commercial / Sales Finance - JavaScript
       ========================================= */

    // ========== GLOBAL STATE ==========
    
    let dataMode = 'sample';
    
    let promoData = {};
    let channelData = [];
    let pvmData = {};
    let accrualSchedule = [];
    
    // ========== UTILITY FUNCTIONS ==========
    
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function randFloat(min, max) {
      return Math.random() * (max - min) + min;
    }
    
    function formatCurrency(val) {
      return '$' + Math.round(val).toLocaleString();
    }
    
    function formatPercent(val) {
      return val.toFixed(1) + '%';
    }
    
    // ========== CSV PARSING ==========
    
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = values[idx] || '';
        });
        data.push(row);
      }
      return { headers, data };
    }
    
    function validateHeaders(actual, required) {
      return required.every(h => actual.includes(h));
    }
    
    function downloadCSV(filename, headers, rows) {
      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += headers.map(h => row[h] !== undefined ? row[h] : '').join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    }
    
    // ========== SAMPLE DATA GENERATION ==========

    function _setSampleBtnState() {
      var s = document.getElementById('btnSampleMode');
      var r = document.getElementById('btnRandomMode');
      if (s) { s.style.background = 'var(--text)'; s.style.color = 'white'; }
      if (r) { r.style.background = 'transparent'; r.style.color = 'var(--muted)'; }
    }
    function useSampleData() {
      withStableScroll(function() {
        dataMode = 'sample';
        document.getElementById('dataModeBadge').textContent = 'SAMPLE'; document.getElementById('dataModeBadge').classList.remove('random');
        _setSampleBtnState();
        initializeSampleData();
        renderAll();
      });
    }

    // ‚îÄ‚îÄ PRESET: Promo that clearly LOSES money ‚îÄ‚îÄ
    // The margin hit (-14pp) + high cost ($14k) means net profit is deeply negative.
    function loadLosingPromo() {
      withStableScroll(function() {
        dataMode = 'sample';
        document.getElementById('dataModeBadge').textContent = 'SAMPLE'; document.getElementById('dataModeBadge').classList.remove('random');
        _setSampleBtnState();
        document.getElementById('baselineRev').value  = 50000;
        document.getElementById('promoRev').value     = 85000;
        document.getElementById('baselineGP').value   = 42;
        document.getElementById('promoGP').value      = 22;   // -20pp ‚Äî wipes the GP lift
        document.getElementById('promoCost').value    = 14000; // heavy spend on top
        _setDefaultPVM();
        _buildChannelData();
        populateChannelFilters();
        renderAll();
      });
    }

    // ‚îÄ‚îÄ PRESET: Promo that clearly MAKES money ‚îÄ‚îÄ
    // GP% holds (even improves slightly), promo cost is lean, volume doubles ‚Üí strong net profit.
    function loadWinningPromo() {
      withStableScroll(function() {
        dataMode = 'sample';
        document.getElementById('dataModeBadge').textContent = 'SAMPLE'; document.getElementById('dataModeBadge').classList.remove('random');
        _setSampleBtnState();
        document.getElementById('baselineRev').value  = 50000;
        document.getElementById('promoRev').value     = 105000; // ~2√ó uplift
        document.getElementById('baselineGP').value   = 40;
        document.getElementById('promoGP').value      = 42;    // +2pp ‚Äî margin holds and improves
        document.getElementById('promoCost').value    = 4500;  // lean spend ‚Üí strong net profit
        // PVM: all three drivers are positive tailwinds
        document.getElementById('priorRev').value     = 120000;
        document.getElementById('currentRev').value   = 168000;
        document.getElementById('priceEffect').value  = 7.5;
        document.getElementById('volumeEffect').value = 18.2;
        document.getElementById('mixEffect').value    = 4.3;
        document.getElementById('discountPool').value = 48000;
        document.getElementById('startMonth').value   = 1;
        document.getElementById('endMonth').value     = 12;
        _buildChannelData();
        populateChannelFilters();
        renderAll();
      });
    }

    function _setDefaultPVM() {
      document.getElementById('priorRev').value     = 120000;
      document.getElementById('currentRev').value   = 138000;
      document.getElementById('priceEffect').value  = 5.2;
      document.getElementById('volumeEffect').value = 8.5;
      document.getElementById('mixEffect').value    = 1.3;
      document.getElementById('discountPool').value = 48000;
      document.getElementById('startMonth').value   = 1;
      document.getElementById('endMonth').value     = 12;
    }

    // Fixed sample channel data ‚Äî never changes on refresh (deterministic)
    const FIXED_CHANNEL_DATA = (function() {
      // Pre-seeded values: [revenue, cogsPct, opex] per month√óchannel
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const channels = ['Direct','Online','Retail','Partner','Enterprise'];
      // One fixed row of seeds per slot (60 rows = 12 months √ó 5 channels)
      const seeds = [
        [18200,0.42,3800],[14500,0.38,4200],[21000,0.45,5100],[11300,0.51,2800],[9800,0.47,3100],
        [16700,0.40,3600],[19500,0.44,4800],[13200,0.36,3900],[22100,0.46,5400],[10500,0.50,2600],[12400,0.43,3300],[8900,0.48,2400],
        [17300,0.41,3700],[15100,0.39,4100],[20400,0.44,5000],[12800,0.52,2900],[10200,0.46,3200],
        [18600,0.42,3500],[21300,0.45,4700],[14700,0.37,4000],[23500,0.47,5500],[11000,0.49,2700],[13100,0.44,3400],[9400,0.47,2500],
        [16900,0.40,3600],[15800,0.38,4300],[19700,0.44,4900],[13500,0.51,3000],[11600,0.48,3300],
        [20100,0.43,3800],[22000,0.46,4600],[15400,0.37,4100],[24200,0.47,5300],[10700,0.50,2600],[12700,0.43,3200],[9100,0.46,2300],
        [17600,0.41,3700],[16300,0.39,4200],[21100,0.45,5100],[14100,0.52,2900],[12000,0.47,3400],
        [19300,0.42,3900],[22800,0.46,4700],[16000,0.38,4000],[24900,0.48,5600],[11200,0.51,2800],[13400,0.44,3500],[9700,0.48,2600],
        [18100,0.41,3600],[16800,0.40,4300],[20800,0.44,5000],[13900,0.51,2900],[12300,0.47,3300],
        [20500,0.43,3800],[23200,0.46,4800],[16500,0.37,4100],[25300,0.47,5400],[11500,0.50,2700],[13800,0.44,3400],[10000,0.47,2500]
      ];
      const rows = [];
      let idx = 0;
      months.forEach(month => {
        channels.forEach(channel => {
          const [rev, cogsPct, opex] = seeds[idx % seeds.length];
          idx++;
          const cogs = rev * cogsPct;
          rows.push({
            month, channel,
            revenue: rev.toFixed(2),
            cogs: cogs.toFixed(2),
            opex: opex.toFixed(2),
            gp: ((rev - cogs) / rev * 100).toFixed(1),
            contribution: (rev - cogs - opex).toFixed(2)
          });
        });
      });
      return rows;
    })();

    function _buildChannelData() {
      // In sample mode: always use the fixed deterministic dataset (no random)
      if (dataMode === 'sample') {
        channelData = FIXED_CHANNEL_DATA.map(r => Object.assign({}, r));
      } else {
        // Random mode: generate fresh random data
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const channels = ['Direct','Online','Retail','Partner','Enterprise'];
        channelData = [];
        months.forEach(month => {
          channels.forEach(channel => {
            const revenue = randInt(8000, 25000);
            const cogs = revenue * randFloat(0.35, 0.55);
            const opex = randInt(2000, 6000);
            channelData.push({
              month, channel,
              revenue: revenue.toFixed(2),
              cogs: cogs.toFixed(2),
              opex: opex.toFixed(2),
              gp: ((revenue - cogs) / revenue * 100).toFixed(1),
              contribution: (revenue - cogs - opex).toFixed(2)
            });
          });
        });
      }
    }
    
    function initializeSampleData() {
      dataMode = 'sample'; // ensure sample mode before building channel data
      // Default promo = losing scenario (same numbers as original sample)
      promoData = { baseline_revenue: 50000, promo_revenue: 85000, baseline_gp: 42, promo_gp: 28, promo_cost: 12000 };
      document.getElementById('baselineRev').value = promoData.baseline_revenue;
      document.getElementById('promoRev').value    = promoData.promo_revenue;
      document.getElementById('baselineGP').value  = promoData.baseline_gp;
      document.getElementById('promoGP').value     = promoData.promo_gp;
      document.getElementById('promoCost').value   = promoData.promo_cost;
      _buildChannelData();
      _setDefaultPVM();
    }
    
    function randomizeSampleData() {
      withStableScroll(function() {
        dataMode = 'random';
        document.getElementById('dataModeBadge').textContent = 'RANDOM';
        document.getElementById('dataModeBadge').classList.add('random');
        var s = document.getElementById('btnSampleMode');
        var r = document.getElementById('btnRandomMode');
        if (s) { s.style.background = 'transparent'; s.style.color = 'var(--muted)'; }
        if (r) { r.style.background = 'var(--text)'; r.style.color = 'white'; }

        // 60% chance of a profitable promo so users see healthy outcomes more often
        const makeWinner = Math.random() < 0.6;

        let baseRev, promoRev, baseGP, promoGP, promoCost;
        if (makeWinner) {
          baseRev   = randInt(40000, 100000);
          promoRev  = Math.round(baseRev * randFloat(1.7, 2.5));  // strong volume lift
          baseGP    = randFloat(38, 55);
          promoGP   = baseGP - randFloat(0, 5);                   // GP% holds mostly
          promoCost = randInt(2000, 8000);                         // lean spend
        } else {
          baseRev   = randInt(30000, 80000);
          promoRev  = Math.round(baseRev * randFloat(1.2, 1.6));
          baseGP    = randFloat(35, 50);
          promoGP   = Math.max(8, baseGP - randFloat(12, 22));    // GP% craters
          promoCost = randInt(10000, 22000);                       // heavy spend
        }

        document.getElementById('baselineRev').value = baseRev;
        document.getElementById('promoRev').value    = promoRev;
        document.getElementById('baselineGP').value  = baseGP.toFixed(1);
        document.getElementById('promoGP').value     = promoGP.toFixed(1);
        document.getElementById('promoCost').value   = promoCost;

        // Random channel data
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const numChannels = randInt(3, 5);
        const channelNames = ['Direct','Online','Retail','Partner','Enterprise'].slice(0, numChannels);
        channelData = [];
        months.forEach(month => {
          channelNames.forEach(channel => {
            const revenue = randInt(5000, 35000);
            const cogs = revenue * randFloat(0.30, 0.60);
            const opex = randInt(1500, 8000);
            channelData.push({
              month, channel,
              revenue: revenue.toFixed(2),
              cogs: cogs.toFixed(2),
              opex: opex.toFixed(2),
              gp: ((revenue - cogs) / revenue * 100).toFixed(1),
              contribution: (revenue - cogs - opex).toFixed(2)
            });
          });
        });

        // Random PVM ‚Äî allow negative price or mix to show headwinds
        const priorRev = randInt(80000, 180000);
        const variance = randFloat(0.05, 0.30);
        document.getElementById('priorRev').value     = priorRev;
        document.getElementById('currentRev').value   = Math.round(priorRev * (1 + variance));
        document.getElementById('priceEffect').value  = randFloat(-4, 10).toFixed(1);
        document.getElementById('volumeEffect').value = randFloat(2, 18).toFixed(1);
        document.getElementById('mixEffect').value    = randFloat(-6, 8).toFixed(1);
        document.getElementById('discountPool').value = randInt(20000, 80000);
        document.getElementById('startMonth').value   = randInt(1, 3);
        document.getElementById('endMonth').value     = randInt(10, 12);

        populateChannelFilters();
        renderAll();
      });
    }
    
    // ========== PROMO ROI FUNCTIONS ==========
    
    function computePromoROI() {
      const baselineRev = parseFloat(document.getElementById('baselineRev').value) || 0;
      const promoRev = parseFloat(document.getElementById('promoRev').value) || 0;
      const baselineGP = parseFloat(document.getElementById('baselineGP').value) || 0;
      const promoGP = parseFloat(document.getElementById('promoGP').value) || 0;
      const promoCost = parseFloat(document.getElementById('promoCost').value) || 0;
      
      const incrementalRev = promoRev - baselineRev;
      const baselineGPDollar = baselineRev * (baselineGP / 100);
      const promoGPDollar = promoRev * (promoGP / 100);
      const incrementalGP = promoGPDollar - baselineGPDollar;
      const netProfit = incrementalGP - promoCost;
      const roi = promoCost > 0 ? (netProfit / promoCost) * 100 : 0;
      const cmPct = promoRev > 0 ? ((promoGPDollar - promoCost) / promoRev) * 100 : 0;
      
      document.getElementById('promoKPIs').innerHTML = `
        <div class="kpi-box">
          <div class="kpi-box-label">Incremental Revenue <span class="help-icon" data-help="The extra revenue generated because of the promo ‚Äî simply Promo Revenue minus Baseline Revenue. This is how much more you sold than you would have without it."></span></div>
          <div class="kpi-box-value">${formatCurrency(incrementalRev)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Incremental GP <span class="help-icon" data-help="The extra gross profit dollars from the promo, after accounting for lower margins during the deal. More revenue means nothing if the margin collapse wipes out the gain."></span></div>
          <div class="kpi-box-value">${formatCurrency(incrementalGP)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Net Promo Profit <span class="help-icon" data-help="The true bottom-line result of the promo: Incremental GP minus what you spent to run it. Positive = the promo paid for itself. Negative = you spent more than you earned back."></span></div>
          <div class="kpi-box-value">${formatCurrency(netProfit)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">ROI <span class="help-icon" data-help="Return on Investment ‚Äî for every $1 you spent on the promo, how many cents came back as profit. 100% ROI means you doubled your money. Negative ROI means the promo lost money."></span></div>
          <div class="kpi-box-value">${formatPercent(roi)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">CM% <span class="help-icon" data-help="Contribution Margin % ‚Äî what percentage of promo revenue is left after product costs AND promo spend. Tells you how efficiently the promotion converts revenue into real contribution toward overhead and profit."></span></div>
          <div class="kpi-box-value">${formatPercent(cmPct)}</div>
        </div>
      `;
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Metric <span class="help-icon" data-help="The financial measure being compared across baseline and promo periods."></span></th>
            <th>Baseline <span class="help-icon" data-help="Your normal performance before the promotion ‚Äî the benchmark everything gets measured against."></span></th>
            <th>Promo <span class="help-icon" data-help="Performance during the promotion period, including any discounts and uplift in volume."></span></th>
            <th>Change <span class="help-icon" data-help="The difference between Promo and Baseline. Positive = the promo helped. Negative = the promo hurt that metric."></span></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Revenue</td>
            <td>${formatCurrency(baselineRev)}</td>
            <td>${formatCurrency(promoRev)}</td>
            <td>${formatCurrency(incrementalRev)}</td>
          </tr>
          <tr>
            <td>GP%</td>
            <td>${formatPercent(baselineGP)}</td>
            <td>${formatPercent(promoGP)}</td>
            <td>${formatPercent(promoGP - baselineGP)}</td>
          </tr>
          <tr>
            <td>GP $</td>
            <td>${formatCurrency(baselineGPDollar)}</td>
            <td>${formatCurrency(promoGPDollar)}</td>
            <td>${formatCurrency(incrementalGP)}</td>
          </tr>
          <tr>
            <td>Promo Cost</td>
            <td>-</td>
            <td>${formatCurrency(promoCost)}</td>
            <td>${formatCurrency(promoCost)}</td>
          </tr>
          <tr>
            <td><strong>Net Profit</strong></td>
            <td>${formatCurrency(baselineGPDollar)}</td>
            <td>${formatCurrency(promoGPDollar - promoCost)}</td>
            <td>${formatCurrency(netProfit)}</td>
          </tr>
        </tbody>
      `;
      document.getElementById('promoTable').innerHTML = tableHTML;
      renderPromoDecisionBox();
    }
    
    // ========== CHANNEL P&L FUNCTIONS ==========
    
    function renderChannelPL() {
      const monthFilter = document.getElementById('channelMonthFilter').value;
      const channelFilter = document.getElementById('channelFilter').value;
      
      let filtered = channelData.filter(d => {
        if (monthFilter !== 'all' && d.month !== monthFilter) return false;
        if (channelFilter !== 'all' && d.channel !== channelFilter) return false;
        return true;
      });
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Month <span class="help-icon" data-help="The calendar month of the data. Lets you spot seasonal patterns ‚Äî e.g. if Retail spikes in December but Online is flat."></span></th>
            <th>Channel <span class="help-icon" data-help="The sales route ‚Äî e.g. Direct (you sell), Retail (through a store), Online (e-commerce), Partner (resellers). Each has different cost structures and margin profiles."></span></th>
            <th>Revenue <span class="help-icon" data-help="Total sales dollars generated by this channel in this month. High revenue doesn't always mean high profit ‚Äî check GP% and Contribution too."></span></th>
            <th>COGS <span class="help-icon" data-help="Cost of Goods Sold ‚Äî what it costs to produce or source the products sold. Subtract this from Revenue to get Gross Profit. Lower COGS = better margin."></span></th>
            <th>GP% <span class="help-icon" data-help="Gross Profit % ‚Äî the share of revenue left after product costs. A GP% of 40% means 40 cents of every dollar sold goes toward covering overheads and profit."></span></th>
            <th>OpEx <span class="help-icon" data-help="Operating Expenses specific to this channel ‚Äî e.g. sales team costs, trade spend, delivery fees, platform commissions. Subtract this from Gross Profit to get Contribution."></span></th>
            <th>Contribution <span class="help-icon" data-help="How much this channel actually contributes to company profit after all channel-specific costs. This is the real scorecard ‚Äî a channel with high revenue but negative Contribution is losing money."></span></th>
          </tr>
        </thead>
        <tbody>
      `;
      filtered.forEach(d => {
        tableHTML += `
          <tr>
            <td>${d.month}</td>
            <td>${d.channel}</td>
            <td>${formatCurrency(parseFloat(d.revenue))}</td>
            <td>${formatCurrency(parseFloat(d.cogs))}</td>
            <td>${d.gp}%</td>
            <td>${formatCurrency(parseFloat(d.opex))}</td>
            <td>${formatCurrency(parseFloat(d.contribution))}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('channelTable').innerHTML = tableHTML;
      
      renderChannelChart();
    }
    
    function renderChannelChart() {
      const canvas = document.getElementById('channelChart');
      const container = canvas.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const channels = [...new Set(channelData.map(d => d.channel))];
      const channelTotals = channels.map(ch => {
        const total = channelData.filter(d => d.channel === ch).reduce((sum, d) => sum + parseFloat(d.revenue), 0);
        return { channel: ch, total };
      }).sort((a, b) => b.total - a.total);
      
      const maxTotal = Math.max(...channelTotals.map(c => c.total));
      const paddingLeft = 100;
      const paddingRight = 60;
      const paddingTop = 20;
      const paddingBottom = 30;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const barHeight = 30;
      const barGap = 10;
      
      channelTotals.forEach((c, i) => {
        const barW = (c.total / maxTotal) * chartW;
        const y = paddingTop + i * (barHeight + barGap);
        
        ctx.fillStyle = '#0f766e';
        ctx.fillRect(paddingLeft, y, barW, barHeight);
        
        ctx.fillStyle = '#0b1220';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        ctx.fillText(c.channel, paddingLeft - 10, y + barHeight / 2);
        
        ctx.fillStyle = '#0b1220';
        ctx.textAlign = 'left';
        ctx.fillText(formatCurrency(c.total), paddingLeft + barW + 8, y + barHeight / 2);
      });
    }
    
    function populateChannelFilters() {
      const months = [...new Set(channelData.map(d => d.month))];
      const channels = [...new Set(channelData.map(d => d.channel))];
      
      document.getElementById('channelMonthFilter').innerHTML = '<option value="all">All Months</option>' +
        months.map(m => `<option value="${m}">${m}</option>`).join('');
      
      document.getElementById('channelFilter').innerHTML = '<option value="all">All Channels</option>' +
        channels.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    // ========== PVM FUNCTIONS ==========
    
    function computePVM() {
      const priorRev = parseFloat(document.getElementById('priorRev').value) || 0;
      const currentRev = parseFloat(document.getElementById('currentRev').value) || 0;
      const priceEffect = parseFloat(document.getElementById('priceEffect').value) || 0;
      const volumeEffect = parseFloat(document.getElementById('volumeEffect').value) || 0;
      const mixEffect = parseFloat(document.getElementById('mixEffect').value) || 0;
      
      const totalVariance = currentRev - priorRev;
      const priceDollar = priorRev * (priceEffect / 100);
      const volumeDollar = priorRev * (volumeEffect / 100);
      const mixDollar = priorRev * (mixEffect / 100);
      
      document.getElementById('pvmKPIs').innerHTML = `
        <div class="kpi-box">
          <div class="kpi-box-label">Total Variance</div>
          <div class="kpi-box-value">${formatCurrency(totalVariance)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"><span class="tooltip" data-tooltip="Revenue change from price">Price Effect</span></div>
          <div class="kpi-box-value">${formatCurrency(priceDollar)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"><span class="tooltip" data-tooltip="Revenue change from volume">Volume Effect</span></div>
          <div class="kpi-box-value">${formatCurrency(volumeDollar)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"><span class="tooltip" data-tooltip="Revenue change from mix">Mix Effect</span></div>
          <div class="kpi-box-value">${formatCurrency(mixDollar)}</div>
        </div>
      `;
      
      renderPVMChart(priorRev, priceDollar, volumeDollar, mixDollar, currentRev);
      renderPVMExplainer(priorRev, currentRev, priceEffect, volumeEffect, mixEffect, priceDollar, volumeDollar, mixDollar);
    }

    function renderPVMExplainer(priorRev, currentRev, priceEff, volEff, mixEff, priceDollar, volumeDollar, mixDollar) {
      const box = document.getElementById('pvmExplainer');
      if (!priorRev) { box.style.display = 'none'; return; }
      box.style.display = '';

      const totalVariance = currentRev - priorRev;
      const totalPct = priorRev > 0 ? (totalVariance / priorRev * 100) : 0;
      const isGrowth = totalVariance >= 0;

      // Color helpers
      const posC = '#0f766e', posBg = 'rgba(15,118,110,0.10)';
      const negC = '#dc2626', negBg = 'rgba(220,38,38,0.10)';
      const warnC = '#b45309', warnBg = 'rgba(180,83,9,0.10)';
      const pillStyle = (val) => `background:${val >= 0 ? posBg : negBg};color:${val >= 0 ? posC : negC};`;
      const fmt = (v) => (v >= 0 ? '+' : '') + '$' + Math.abs(Math.round(v)).toLocaleString();
      const fmtPct = (v) => (v >= 0 ? '+' : '') + v.toFixed(1) + '%';

      // Total badge
      document.getElementById('pvmTotalValue').textContent = (totalVariance >= 0 ? '+' : '') + '$' + Math.abs(Math.round(totalVariance)).toLocaleString();
      document.getElementById('pvmTotalPct').textContent = fmtPct(totalPct);
      const badge = document.getElementById('pvmTotalBadge');
      badge.textContent = isGrowth ? '‚ñ≤ Growth' : '‚ñº Decline';
      badge.style.cssText = `font-size:11px;font-weight:700;padding:3px 10px;border-radius:999px;background:${isGrowth ? posBg : negBg};color:${isGrowth ? posC : negC};`;

      // Effect pills
      const setPill = (id, val) => {
        const el = document.getElementById(id);
        el.textContent = fmt(val);
        el.style.cssText = pillStyle(val);
      };
      setPill('pvmPricePill', priceDollar);
      setPill('pvmVolumePill', volumeDollar);
      setPill('pvmMixPill', mixDollar);

      // Identify biggest driver and any headwinds
      const drivers = [
        { name: 'Price', dollar: priceDollar, pct: priceEff },
        { name: 'Volume', dollar: volumeDollar, pct: volEff },
        { name: 'Mix', dollar: mixDollar, pct: mixEff }
      ];
      const sorted = [...drivers].sort((a,b) => Math.abs(b.dollar) - Math.abs(a.dollar));
      const biggest = sorted[0];
      const headwinds = drivers.filter(d => d.dollar < 0);
      const tailwinds = drivers.filter(d => d.dollar > 0);
      const allPositive = headwinds.length === 0;
      const allNegative = tailwinds.length === 0;

      // Verdict block
      let verdictStyle, verdictHTML;
      if (isGrowth && allPositive) {
        verdictStyle = `background:#f0fdf9;border-left:3px solid ${posC};`;
        verdictHTML = `<strong style="color:${posC};">‚úì Broad-based growth ‚Äî all three drivers are tailwinds.</strong><br>
          Revenue grew <strong>${fmtPct(totalPct)}</strong> vs prior period.
          Price contributed <strong>${fmt(priceDollar)}</strong>, Volume contributed <strong>${fmt(volumeDollar)}</strong>, and Mix contributed <strong>${fmt(mixDollar)}</strong>.
          This is the healthiest PVM profile ‚Äî you're charging more, selling more, and shifting toward higher-value products simultaneously.`;
      } else if (isGrowth && headwinds.length > 0) {
        verdictStyle = `background:#fffbeb;border-left:3px solid ${warnC};`;
        const drag = headwinds.map(d => `${d.name} (${fmt(d.dollar)})`).join(', ');
        verdictHTML = `<strong style="color:${warnC};">‚ö° Growth with a hidden headwind ‚Äî ${drag} is dragging against the tailwinds.</strong><br>
          Revenue grew <strong>${fmtPct(totalPct)}</strong> overall, but it would have been higher without the drag.
          The biggest tailwind is <strong>${biggest.name}</strong> at <strong>${fmt(biggest.dollar)}</strong>.
          Watch the headwind closely ‚Äî if it widens, the growth story weakens.`;
      } else if (!isGrowth && allNegative) {
        verdictStyle = `background:#fef2f2;border-left:3px solid ${negC};`;
        verdictHTML = `<strong style="color:${negC};">‚ö† Revenue declined across all three dimensions.</strong><br>
          Revenue fell <strong>${fmtPct(totalPct)}</strong> vs prior period ‚Äî Price, Volume, and Mix are all headwinds.
          This is a broad-based deterioration requiring a full commercial review: pricing power, sales capacity, and SKU portfolio all need attention.`;
      } else {
        verdictStyle = `background:#fef2f2;border-left:3px solid ${negC};`;
        verdictHTML = `<strong style="color:${negC};">‚ö† Revenue declined ${fmtPct(totalPct)} vs prior period.</strong><br>
          ${tailwinds.length > 0 ? `Some drivers helped (${tailwinds.map(d => d.name + ' ' + fmt(d.dollar)).join(', ')}), but they weren't enough to offset the headwinds.` : ''}
          Focus on the largest drag: <strong>${biggest.name}</strong> at <strong>${fmt(biggest.dollar)}</strong>.`;
      }
      const vb = document.getElementById('pvmVerdictBlock');
      vb.style.cssText = `padding:14px 16px;border-radius:10px;font-size:13px;line-height:1.65;margin-bottom:14px;${verdictStyle}`;
      vb.innerHTML = verdictHTML;

      // Lever block
      const lb = document.getElementById('pvmLeverBlock');
      if (headwinds.length > 0) {
        const worst = headwinds.sort((a,b) => a.dollar - b.dollar)[0];
        lb.innerHTML = `<strong>üéØ Key action:</strong> The <strong>${worst.name}</strong> effect is dragging revenue by <strong>${fmt(worst.dollar)}</strong>.
          ${worst.name === 'Mix' ? 'Consider rebalancing the product portfolio toward higher-revenue SKUs.' :
            worst.name === 'Price' ? 'Review discount depth, price erosion, or competitive pricing pressure.' :
            'Investigate volume decline by channel, region, or customer segment.'}`;
      } else {
        lb.innerHTML = `<strong>üéØ Biggest growth lever:</strong> <strong>${biggest.name}</strong> drove <strong>${fmt(biggest.dollar)}</strong> of the total uplift.
          To sustain momentum, protect this driver while strengthening the smaller contributors.`;
      }
    }
    
    function renderPVMChart(prior, price, volume, mix, current) {
      const canvas = document.getElementById('pvmChart');
      const container = canvas.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const values = [prior, prior + price, prior + price + volume, prior + price + volume + mix, current];
      const labels = ['Prior', '+ Price', '+ Volume', '+ Mix', 'Current'];
      
      const maxVal = Math.max(...values);
      const minVal = Math.min(...values, 0);
      const range = maxVal - minVal;
      
      const paddingLeft = 60;
      const paddingRight = 40;
      const paddingTop = 40;
      const paddingBottom = 50;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const barWidth = chartW / (values.length * 1.5);
      const barGap = barWidth * 0.5;
      
      // Zero line
      const zeroY = paddingTop + chartH - ((0 - minVal) / range) * chartH;
      ctx.strokeStyle = '#0b1220';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, zeroY);
      ctx.lineTo(w - paddingRight, zeroY);
      ctx.stroke();
      
      // Bars
      values.forEach((val, i) => {
        const x = paddingLeft + i * (barWidth + barGap);
        const barH = Math.abs((val - minVal) / range * chartH - (0 - minVal) / range * chartH);
        const y = val >= 0 ? zeroY - barH : zeroY;
        
        ctx.fillStyle = i === 0 || i === values.length - 1 ? '#1b4d7a' : '#0f766e';
        ctx.fillRect(x, y, barWidth, barH);
        
        // Label
        ctx.fillStyle = '#0b1220';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.fillText(labels[i], x + barWidth / 2, h - paddingBottom + 5);
        
        // Value
        ctx.font = 'bold 11px sans-serif';
        ctx.textBaseline = 'bottom';
        ctx.fillText(formatCurrency(val), x + barWidth / 2, y - 5);
      });
    }
    
    // ========== ACCRUAL FUNCTIONS ==========
    
    function computeAccrual() {
      const pool = parseFloat(document.getElementById('discountPool').value) || 0;
      const start = parseInt(document.getElementById('startMonth').value) || 1;
      const end = parseInt(document.getElementById('endMonth').value) || 12;
      
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const numMonths = end - start + 1;
      const monthlyAccrual = numMonths > 0 ? pool / numMonths : 0;
      
      accrualSchedule = [];
      let cumulative = 0;
      months.forEach((month, i) => {
        const monthNum = i + 1;
        const accrual = (monthNum >= start && monthNum <= end) ? monthlyAccrual : 0;
        cumulative += accrual;
        accrualSchedule.push({
          month,
          accrual: accrual.toFixed(2),
          cumulative: cumulative.toFixed(2),
          remaining: (pool - cumulative).toFixed(2)
        });
      });
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Month</th>
            <th>Monthly Accrual</th>
            <th>Cumulative</th>
            <th>Remaining Pool</th>
          </tr>
        </thead>
        <tbody>
      `;
      accrualSchedule.forEach(a => {
        tableHTML += `
          <tr>
            <td>${a.month}</td>
            <td>${formatCurrency(parseFloat(a.accrual))}</td>
            <td>${formatCurrency(parseFloat(a.cumulative))}</td>
            <td>${formatCurrency(parseFloat(a.remaining))}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('accrualTable').innerHTML = tableHTML;
    }
    
    // ========== CSV DOWNLOADS ==========
    
    function downloadPromoCSV() {
      const headers = ['metric', 'baseline', 'promo', 'change'];
      const baselineRev = parseFloat(document.getElementById('baselineRev').value) || 0;
      const promoRev = parseFloat(document.getElementById('promoRev').value) || 0;
      const baselineGP = parseFloat(document.getElementById('baselineGP').value) || 0;
      const promoGP = parseFloat(document.getElementById('promoGP').value) || 0;
      const rows = [
        { metric: 'Revenue', baseline: baselineRev, promo: promoRev, change: promoRev - baselineRev },
        { metric: 'GP%', baseline: baselineGP, promo: promoGP, change: promoGP - baselineGP }
      ];
      downloadCSV('promotion_roi.csv', headers, rows);
    }
    
    function downloadPromoTemplate() {
      const headers = ['baseline_revenue', 'promo_revenue', 'baseline_gp', 'promo_gp', 'promo_cost'];
      const rows = [{ baseline_revenue: 50000, promo_revenue: 85000, baseline_gp: 42, promo_gp: 28, promo_cost: 12000 }];
      downloadCSV('promotions_template.csv', headers, rows);
    }
    
    function downloadChannelCSV() {
      const headers = ['month', 'channel', 'revenue', 'cogs', 'gp', 'opex', 'contribution'];
      downloadCSV('channel_pnl.csv', headers, channelData);
    }
    
    function downloadChannelTemplate() {
      const headers = ['month', 'channel', 'revenue', 'cogs', 'gp', 'opex', 'contribution'];
      const rows = [
        { month: 'Jan', channel: 'Direct', revenue: 15000, cogs: 6000, gp: 60, opex: 3000, contribution: 6000 },
        { month: 'Jan', channel: 'Online', revenue: 12000, cogs: 5000, gp: 58.3, opex: 2500, contribution: 4500 }
      ];
      downloadCSV('channel_pnl_template.csv', headers, rows);
    }
    
    function downloadPVMCSV() {
      const headers = ['prior_revenue', 'current_revenue', 'price_effect', 'volume_effect', 'mix_effect'];
      const rows = [{
        prior_revenue: document.getElementById('priorRev').value,
        current_revenue: document.getElementById('currentRev').value,
        price_effect: document.getElementById('priceEffect').value,
        volume_effect: document.getElementById('volumeEffect').value,
        mix_effect: document.getElementById('mixEffect').value
      }];
      downloadCSV('pvm_analysis.csv', headers, rows);
    }
    
    function downloadPVMTemplate() {
      const headers = ['prior_revenue', 'current_revenue', 'price_effect', 'volume_effect', 'mix_effect'];
      const rows = [{ prior_revenue: 120000, current_revenue: 138000, price_effect: 5.2, volume_effect: 8.5, mix_effect: 1.3 }];
      downloadCSV('pvm_template.csv', headers, rows);
    }
    
    function downloadAccrualCSV() {
      const headers = ['month', 'accrual', 'cumulative', 'remaining'];
      downloadCSV('accrual_schedule.csv', headers, accrualSchedule);
    }
    
    function downloadAccrualTemplate() {
      const headers = ['discount_pool', 'start_month', 'end_month'];
      const rows = [{ discount_pool: 48000, start_month: 1, end_month: 12 }];
      downloadCSV('accrual_template.csv', headers, rows);
    }
    
    function downloadAllTemplates() {
      downloadPromoTemplate();
      setTimeout(() => downloadChannelTemplate(), 300);
      setTimeout(() => downloadPVMTemplate(), 600);
      setTimeout(() => downloadAccrualTemplate(), 900);
    }
    
    // ========== CSV UPLOADS ==========
    
    function handlePromoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['baseline_revenue', 'promo_revenue', 'baseline_gp', 'promo_gp', 'promo_cost'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          const row = data[0];
          document.getElementById('baselineRev').value = row.baseline_revenue;
          document.getElementById('promoRev').value = row.promo_revenue;
          document.getElementById('baselineGP').value = row.baseline_gp;
          document.getElementById('promoGP').value = row.promo_gp;
          document.getElementById('promoCost').value = row.promo_cost;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'CSV'; document.getElementById('dataModeBadge').classList.remove('random');
          computePromoROI();
          alert('Promo data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handleChannelUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['month', 'channel', 'revenue', 'cogs', 'gp', 'opex', 'contribution'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          channelData = data;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'CSV'; document.getElementById('dataModeBadge').classList.remove('random');
          populateChannelFilters();
          renderChannelPL();
          alert('Channel data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handlePVMUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['prior_revenue', 'current_revenue', 'price_effect', 'volume_effect', 'mix_effect'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          const row = data[0];
          document.getElementById('priorRev').value = row.prior_revenue;
          document.getElementById('currentRev').value = row.current_revenue;
          document.getElementById('priceEffect').value = row.price_effect;
          document.getElementById('volumeEffect').value = row.volume_effect;
          document.getElementById('mixEffect').value = row.mix_effect;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'CSV'; document.getElementById('dataModeBadge').classList.remove('random');
          computePVM();
          alert('PVM data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handleAccrualUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['discount_pool', 'start_month', 'end_month'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          const row = data[0];
          document.getElementById('discountPool').value = row.discount_pool;
          document.getElementById('startMonth').value = row.start_month;
          document.getElementById('endMonth').value = row.end_month;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'CSV'; document.getElementById('dataModeBadge').classList.remove('random');
          computeAccrual();
          alert('Accrual data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    // ========== DECISION BOX (PROMO ROI) ==========

    function renderPromoDecisionBox() {
      const fallback = document.getElementById('promoDecisionFallback');
      const content  = document.getElementById('promoDecisionContent');

      const baselineRev = parseFloat(document.getElementById('baselineRev').value) || 0;
      const promoRev    = parseFloat(document.getElementById('promoRev').value)    || 0;
      const baselineGP  = parseFloat(document.getElementById('baselineGP').value)  || 0;
      const promoGP     = parseFloat(document.getElementById('promoGP').value)     || 0;
      const promoCost   = parseFloat(document.getElementById('promoCost').value)   || 0;

      // Need at least revenue values
      if (!baselineRev && !promoRev) {
        fallback.style.display = '';
        content.style.display = 'none';
        return;
      }

      const baselineGPDollar  = baselineRev * (baselineGP / 100);
      const promoGPDollar     = promoRev    * (promoGP    / 100);
      const incrementalGP     = promoGPDollar - baselineGPDollar;
      const netProfit         = incrementalGP - promoCost;
      const marginImpactPp    = promoGP - baselineGP;           // percentage points

      // Decision logic
      const profitable    = netProfit > 0;
      const marginOk      = marginImpactPp >= 0;                // not negative pp
      const runPromo      = profitable && marginOk;

      // "What to do next" recommendation based on what hurts most
      let nextAction;
      if (runPromo) {
        nextAction = 'Scale this promo ‚Äî profit is positive and margin holds.';
      } else if (!profitable && marginImpactPp < 0) {
        // Both hurting ‚Äî biggest lever?
        const discountDamage = Math.abs(marginImpactPp);
        const costDamage     = promoCost / (promoRev || 1) * 100;
        nextAction = discountDamage > costDamage
          ? 'Reduce discount depth to recover margin before running.'
          : 'Limit redemptions or cut promo cost ‚Äî spend outweighs the uplift.';
      } else if (!profitable) {
        nextAction = 'Limit redemptions ‚Äî promo cost exceeds the profit it generates.';
      } else {
        // Profitable but margin compressed
        nextAction = 'Shift budget to the highest-margin channel to protect overall GP%.';
      }

      fallback.style.display = 'none';
      content.style.display  = '';

      // Apply color state: Yes = positive, No = negative
      const box = document.getElementById('promoDecisionBox');
      box.classList.remove('decision-box--positive', 'decision-box--negative');
      box.classList.add(runPromo ? 'decision-box--positive' : 'decision-box--negative');

      const verdictLabel = runPromo ? 'Yes ‚Äî run the promo' : 'No ‚Äî don\'t run the promo';
      document.getElementById('promoDecisionVerdict').innerHTML =
        `Run promo? <span class="verdict-action">${verdictLabel}</span>`;

      const marginSign = marginImpactPp >= 0 ? '+' : '';
      document.getElementById('promoDecisionBullets').innerHTML = `
        <li>Expected profit impact: <strong>$${Math.round(netProfit).toLocaleString()}</strong></li>
        <li>Margin impact: <strong>${marginSign}${marginImpactPp.toFixed(1)} pp</strong> (promo GP% vs baseline)</li>
      `;

      document.getElementById('promoDecisionNext').innerHTML =
        `What to do next: <span>${nextAction}</span>`;
    }

    // ========== RENDER ALL ==========
    
    function renderAll() {
      computePromoROI();
      populateChannelFilters();
      renderChannelPL();
      computePVM();
      computeAccrual();
      renderPromoDecisionBox();
    }
    
    // ========== INIT ==========
    
    window.addEventListener('DOMContentLoaded', () => {
      initializeSampleData();
      renderAll();
    });
  
    /* ‚îÄ‚îÄ Sidebar accordion: one section open at a time ‚îÄ‚îÄ */
    function sidebarAccordion(headerEl) {
      var sidebar = headerEl.closest('.sidebar');
      var allHeaders = sidebar.querySelectorAll('.sb-acc-header');
      allHeaders.forEach(function(h) {
        if (h === headerEl) return;
        h.classList.remove('open');
        var b = h.nextElementSibling;
        if (b && b.classList.contains('sb-acc-body')) b.classList.remove('open');
      });
      headerEl.classList.toggle('open');
      var body = headerEl.nextElementSibling;
      if (body && body.classList.contains('sb-acc-body')) body.classList.toggle('open');
    }


    /* Mobile sidebar toggle */
    (function() {
      var btn = document.getElementById('mobileControlsBtn');
      var sb  = document.querySelector('.sidebar');
      if (!btn || !sb) return;
      btn.addEventListener('click', function() {
        var open = sb.classList.toggle('mobile-open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    })();


    /* ‚îÄ‚îÄ Body-level tooltip engine (fixes sidebar overflow clipping) ‚îÄ‚îÄ */
    function initTooltips() {
      var ttEl = document.getElementById('tt-root');
      if (!ttEl) {
        ttEl = document.createElement('div');
        ttEl.id = 'tt-root';
        document.body.appendChild(ttEl);
      }

      var hideTimer = null;
      var activeEl = null;

      function show(text, targetEl) {
        clearTimeout(hideTimer);
        activeEl = targetEl;
        ttEl.textContent = text;
        ttEl.classList.add('tt-visible');
        position(targetEl);
      }

      function hide() {
        hideTimer = setTimeout(function() {
          ttEl.classList.remove('tt-visible');
          activeEl = null;
        }, 80);
      }

      function position(el) {
        var rect = el.getBoundingClientRect();
        var ttW = 270;
        var gap = 8;
        // Horizontal: center on element, clamp to viewport
        var left = rect.left + rect.width / 2 - ttW / 2;
        left = Math.max(12, Math.min(left, window.innerWidth - ttW - 12));
        ttEl.style.width = ttW + 'px';
        ttEl.style.left = left + 'px';
        // Vertical: show above by default, flip below if too close to top
        var ttH = ttEl.offsetHeight || 60;
        var top;
        if (rect.top - ttH - gap - 8 < 0) {
          top = rect.bottom + gap;
        } else {
          top = rect.top - ttH - gap;
        }
        ttEl.style.top = top + 'px';
        ttEl.style.position = 'fixed';
        ttEl.style.transform = 'none';
      }

      /* Kill CSS ::after tooltips ‚Äî they clip in overflow containers */
      var killStyle = document.createElement('style');
      killStyle.textContent = '.help-icon::after,.help-icon:hover::after,[data-help]::after,[data-tt]::after,.term-helper::after,.term-helper:hover::after{content:none!important;display:none!important;}';
      document.head.appendChild(killStyle);

      /* Desktop: mouse events (event delegation) */
      document.addEventListener('mouseover', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (!el) return;
        var text = el.getAttribute('data-help') || el.getAttribute('data-tt');
        if (text && text !== 'Loading...') show(text, el);
      });

      document.addEventListener('mouseout', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (el) hide();
      });

      /* Mobile: tap to toggle */
      document.addEventListener('click', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (!el) {
          if (ttEl.classList.contains('tt-visible')) {
            ttEl.classList.remove('tt-visible');
            activeEl = null;
          }
          return;
        }
        var text = el.getAttribute('data-help') || el.getAttribute('data-tt');
        if (!text || text === 'Loading...') return;
        if (activeEl === el && ttEl.classList.contains('tt-visible')) {
          ttEl.classList.remove('tt-visible');
          activeEl = null;
        } else {
          show(text, el);
        }
        e.stopPropagation();
      });

      /* Reposition on scroll */
      window.addEventListener('scroll', function() {
        if (activeEl && ttEl.classList.contains('tt-visible')) {
          position(activeEl);
        }
      }, { passive: true });

      /* Hide on resize */
      window.addEventListener('resize', function() {
        ttEl.classList.remove('tt-visible');
        activeEl = null;
      }, { passive: true });
    }

    // ‚îÄ‚îÄ Call tooltip engine on page load ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', function() {
      initTooltips();
    });

</script>

</body>
</html>

<!--
  COMMERCIAL-SALES.HTML ‚Äî UI/UX Upgrade Notes
  ============================================
  Changes made (patterns copied from operations-spend.html):
  1. Decision Box ‚Üí Hero Insight: added plain-English summary line at top,
     fixed min/max height to prevent layout jumping, added exception-row
     linking pattern (same grid + anchor links as ops-spend).
  2. "What ‚Ä¢ So What ‚Ä¢ Now What" framework: added wswn CSS + restructured
     PVM explainer and channel P&L insights using .wswn/.wswn-row/.wswn-label.
  3. Threshold tooltips: added ‚ìò help-icon beside GP%/Margin labels with
     Health ‚Üî High Risk explanation in data-help attributes.
  4. Fixed-height containers + scroll: channel P&L table wrapped in
     #channelTableScroll (height:340px, overflow-y:auto). Accrual table
     wrapped in #accrualTableScroll. Table layouts set to table-layout:fixed.
  5. Tables: fixed column widths via colgroup, stable 40px row height,
     sticky thead, no layout jumping.
  6. Sidebar export button: "Export current dataset" ‚Üí exportCurrentDataset()
     downloads CSV of the currently active/filtered view.
  7. Data section copy: "üìÇ One file powers this entire module" with four
     analysis cards (Promo ROI, Channel P&L, PVM, Accrual).
  8. Decision Box linking: exception rows with anchor links to sections +
     smooth scroll + highlight (scrollToSection pattern from ops-spend).
  9. wswn CSS / scrollbar CSS / exception-row CSS all ported from ops-spend.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commercial & Sales Finance ¬∑ FP&A Portfolio</title>
  <style>
    /* ‚îÄ‚îÄ CSS Variables & Reset (from style.css) ‚îÄ‚îÄ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:          #ffffff;
      --bg-muted:    #f6f8fb;
      --text:        #0b1220;
      --muted:       #5d6b7a;
      --border:      rgba(12, 23, 45, 0.10);
      --shadow:      0 10px 30px rgba(11, 18, 32, 0.08);
      --shadow-soft: 0 8px 18px rgba(11, 18, 32, 0.06);
      --accent:      #0f766e;
      --accent-2:    #1b4d7a;
      --accent-soft: rgba(15, 118, 110, 0.10);
      --radius:      18px;
      --radius-sm:   14px;
      --max:         1120px;
      --font-sans:   ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --font-mono:   'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
    }
    html { scroll-behavior: auto; }
    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
    }
    a { color: inherit; text-decoration: none; }
    img { max-width: 100%; display: block; }

    /* ‚îÄ‚îÄ Skip link ‚îÄ‚îÄ */
    .skip-link {
      position: absolute;
      left: -999px;
      top: 12px;
      padding: 10px 12px;
      background: var(--text);
      color: white;
      border-radius: 10px;
      z-index: 9999;
    }
    .skip-link:focus { left: 12px; }

    /* ‚îÄ‚îÄ Site Header ‚îÄ‚îÄ */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,0.97);
      border-bottom: 1px solid var(--border);
      will-change: transform;
    }
    .container {
      width: min(var(--max), calc(100% - 48px));
      margin: 0 auto;
    }
    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      gap: 16px;
    }
    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 650;
      letter-spacing: -0.02em;
    }
    .brand-mark {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 6px var(--accent-soft);
    }
    .nav-cta {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid transparent;
      transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease, border-color 140ms ease;
      user-select: none;
      text-decoration: none;
    }
    .btn:active { transform: translateY(1px); }
    .btn[aria-disabled="true"] { opacity: 0.55; pointer-events: none; }
    .btn-solid {
      background: var(--text);
      color: white;
      box-shadow: var(--shadow-soft);
    }
    .btn-solid:hover { box-shadow: var(--shadow); }
    .btn-ghost {
      background: white;
      border-color: var(--border);
      color: var(--text);
    }
    .btn-ghost:hover { border-color: rgba(12, 23, 45, 0.18); box-shadow: 0 6px 18px rgba(11,18,32,0.06); }

    /* ‚îÄ‚îÄ Module Hero ‚îÄ‚îÄ */
    .module-hero {
      padding: 40px 0 36px 0;
      border-bottom: 1px solid var(--border);
      height: 284px;
      box-sizing: border-box;
      overflow: hidden;
    }
    .module-eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.09em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 10px;
    }
    .module-title {
      font-size: 36px;
      line-height: 1.1;
      letter-spacing: -0.03em;
      margin: 0 0 10px 0;
    }
    .module-subtitle {
      font-size: 15px;
      color: var(--muted);
      line-height: 1.5;
      margin: 0 0 0 0;
      max-width: 70ch;
      height: calc(15px * 1.5 * 2);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .feature-chips {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      margin-top: 16px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: 2px;
    }
    .feature-chips::-webkit-scrollbar { display: none; }
    .chip {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(246,248,251,0.8);
      color: var(--text);
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ Help icon ‚îÄ‚îÄ */
    .help-icon {
      display: inline-flex; align-items: center; justify-content: center;
      width: 16px; height: 16px; border-radius: 50%;
      background: rgba(12,23,45,0.07); color: var(--muted);
      font-size: 10px; font-weight: 700; cursor: help;
      vertical-align: middle; flex-shrink: 0;
      transition: background 120ms ease;
      user-select: none;
    }
    .help-icon::before { content: 'i'; font-style: italic; }
    .help-icon:hover { background: rgba(15,118,110,0.15); color: var(--accent); }

    /* ‚îÄ‚îÄ Tooltip root element (JS-powered) ‚îÄ‚îÄ */
    #tt-root {
      position: fixed; z-index: 99999;
      background: rgba(11,18,32,0.92);
      color: white; font-size: 12px; line-height: 1.45;
      padding: 8px 12px; border-radius: 10px;
      max-width: 280px; pointer-events: none;
      opacity: 0; transition: opacity 120ms ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.18);
    }
    #tt-root.tt-visible { opacity: 1; }

    /* ‚îÄ‚îÄ Next module bar ‚îÄ‚îÄ */
    .next-module-bar {
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 16px;
      padding: 24px 32px; border-top: 1px solid var(--border);
      background: white; margin-top: 0;
    }
    .next-module-label {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.08em; color: var(--muted); margin-bottom: 4px;
    }
    .next-module-title {
      font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: 4px;
    }
    .next-module-why { font-size: 13px; color: var(--muted); }
    .next-module-actions { display: flex; gap: 10px; flex-wrap: wrap; }

    /* ‚îÄ‚îÄ Back to top ‚îÄ‚îÄ */
    .to-top {
      position: fixed; bottom: 24px; right: 24px;
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--text); color: white;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; text-decoration: none;
      box-shadow: var(--shadow); transition: all 140ms ease;
      z-index: 100;
    }
    .to-top:hover { transform: translateY(-2px); }
  </style>
  <style>
    /* Prevent horizontal overflow */
    html, body { overflow-x: clip; }

    /* module-hero, module-label, module-title, module-pill, module-subtitle,
       module-problem, module-role, feature-chips, chip ‚Äî all in style.css */
    
    /* Main layout with sidebar */
    .module-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      align-items: start;
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    
    /* Main content area */
    .main-content {
      min-width: 0;
    }
    
    /* Module sections */
    .module-section {
      padding: 0 0 48px 0;
    }
    .module-section-title {
      font-size: 24px;
      margin-bottom: 20px;
      letter-spacing: -0.02em;
    }
    .module-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-soft);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .card-title {
      font-size: 18px;
      font-weight: 650;
    }
    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* Buttons */
    .btn-small {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 999px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 140ms ease;
      white-space: nowrap;
    }
    .btn-small:hover {
      border-color: rgba(12, 23, 45, 0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.06);
    }
    .btn-small:active {
      transform: translateY(1px);
    }
    .btn-primary {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }
    .btn-primary:hover {
      box-shadow: 0 6px 18px rgba(11,18,32,0.12);
    }
    .btn-full {
      width: 100%;
      justify-content: center;
      display: flex;
    }
    
    /* KPI grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .kpi-box {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: rgba(246,248,251,0.6);
    }
    .kpi-box-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .kpi-box-value {
      font-size: 20px;
      font-weight: 650;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin: 16px 0;
    }
    .data-table th {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 2px solid var(--border);
      font-weight: 650;
      color: var(--text);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .data-table tr:last-child td {
      border-bottom: none;
    }
    .data-table tr:hover {
      background: rgba(246,248,251,0.5);
    }
    
    /* Charts */
    .chart-container { overflow-anchor: none;
      margin: 20px 0;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .chart-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 16px;
      color: var(--text);
    }
    .chart-canvas {
      display: block;
      width: 100%;
      height: auto;
    }
    
    /* Input grid */
    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }
    .input-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-field label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }
    .input-field input {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: var(--font-sans);
      background: white;
    }
    .input-field input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* File upload */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    /* Demo section */
    .demo-section {
      padding: 32px 0;
      border-top: 1px solid var(--border);
    }
    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
    }
    .demo-card {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .demo-card-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 8px;
    }
    .demo-card-text {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    
    /* Tooltips */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      border-bottom: 1px dotted var(--muted);
    }
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: var(--text);
      color: white;
      font-size: 12px;
      border-radius: 8px;
      white-space: nowrap;
      z-index: 100;
      margin-bottom: 6px;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .module-layout {
        grid-template-columns: 1fr;
      }
    }

    /* ---- Decision Box ---- */
    .decision-box {
      background: white;
      border: 1.5px solid var(--accent);
      border-radius: var(--radius);
      padding: 20px 24px;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.08), var(--shadow-soft);
      margin-bottom: 24px;
      transition: border-color 200ms ease, box-shadow 200ms ease, background 200ms ease;
    }
    /* Positive ‚Äî green */
    .decision-box--positive {
      border-color: #0f766e;
      background: #f0fdf9;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.10), var(--shadow-soft);
    }
    .decision-box--positive .decision-box-eyebrow { color: #0f766e; }
    .decision-box--positive .verdict-action        { color: #0f766e; }
    .decision-box--positive .decision-box-bullets li::before { color: #0f766e; }
    /* Negative ‚Äî red */
    .decision-box--negative {
      border-color: #dc2626;
      background: #fef2f2;
      box-shadow: 0 0 0 4px rgba(220,38,38,0.10), var(--shadow-soft);
    }
    .decision-box--negative .decision-box-eyebrow { color: #dc2626; }
    .decision-box--negative .verdict-action        { color: #dc2626; }
    .decision-box--negative .decision-box-bullets li::before { color: #dc2626; }
    /* Caution ‚Äî amber (Proceed with Conditions) */
    .decision-box--caution {
      border-color: #d97706;
      background: #fffbeb;
      box-shadow: 0 0 0 4px rgba(217,119,6,0.10), var(--shadow-soft);
    }
    .decision-box--caution .decision-box-eyebrow { color: #b45309; }
    .decision-box--caution .verdict-action        { color: #b45309; }
    .decision-box--caution .decision-box-bullets li::before { color: #d97706; }

    /* ‚îÄ‚îÄ Inline term tooltip (pp explainer etc.) ‚îÄ‚îÄ */
    .term-tt {
      border-bottom: 1px dashed rgba(12,23,45,0.35);
      cursor: help;
      white-space: nowrap;
    }

    /* ‚îÄ‚îÄ Issues popover ‚îÄ‚îÄ */
    .issues-trigger {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      border-bottom: 1px dashed #dc2626;
      color: #dc2626;
      font-weight: 700;
      position: relative;
      white-space: nowrap;
    }
    .issues-trigger::after {
      content: ' ‚ìò';
      font-size: 11px;
      opacity: 0.75;
    }
    #issuesPopover {
      position: fixed;
      z-index: 99998;
      background: white;
      border: 1.5px solid #dc2626;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(220,38,38,0.15), 0 2px 8px rgba(0,0,0,0.10);
      min-width: 280px;
      max-width: 340px;
      padding: 0;
      overflow: hidden;
      opacity: 0;
      pointer-events: none;
      transition: opacity 140ms ease, transform 140ms ease;
      transform: translateY(4px);
    }
    #issuesPopover.pop-visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    .pop-header {
      background: #fef2f2;
      border-bottom: 1px solid rgba(220,38,38,0.15);
      padding: 10px 14px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #dc2626;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .pop-close { background: none; border: none; cursor: pointer; font-size: 14px; color: #dc2626; opacity: 0.6; line-height: 1; padding: 0; }
    .pop-close:hover { opacity: 1; }
    .pop-body { padding: 10px 14px; display: flex; flex-direction: column; gap: 8px; }
    .pop-issue-row { display: flex; align-items: flex-start; gap: 10px; font-size: 12px; color: var(--text); line-height: 1.45; }
    .pop-issue-icon { flex-shrink: 0; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; margin-top: 1px; }
    .pop-issue-icon.red   { background: rgba(220,38,38,0.12); color: #dc2626; }
    .pop-issue-icon.amber { background: rgba(217,119,6,0.12); color: #d97706; }
    .pop-issue-label { font-weight: 600; color: var(--text); }
    .pop-issue-desc  { color: var(--muted); font-size: 11px; margin-top: 1px; }
    .decision-box-eyebrow {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--accent);
      margin-bottom: 8px;
    }
    .decision-box-verdict {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
      margin-bottom: 12px;
    }
    .decision-box-verdict .verdict-action {
      color: var(--accent);
    }
    .decision-box-bullets {
      list-style: none;
      margin: 0 0 10px 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .decision-box-bullets li {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: flex-start;
      gap: 8px;
      line-height: 1.4;
    }
    .decision-box-bullets li::before {
      content: '‚Ä∫';
      color: var(--accent);
      font-weight: 700;
      flex-shrink: 0;
    }
    .decision-box-next {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }
    .decision-box-next span {
      color: var(--accent-2);
    }
    .decision-box-fallback {
      font-size: 14px;
      color: var(--muted);
      font-style: italic;
    }
      .main-content { overflow-anchor: none; }
    .module-card { overflow-anchor: none; }
    .data-table { overflow-anchor: none; }

    /* ‚îÄ‚îÄ Decision Box fixed size (no layout jump on data change) ‚îÄ‚îÄ */
    .decision-box {
      min-height: 440px;
      max-height: 440px;
      overflow: hidden;
    }
    /* ‚îÄ‚îÄ Decision Box hero summary line ‚îÄ‚îÄ */
    .decision-box-summary {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
      line-height: 1.4;
      padding: 10px 14px;
      background: rgba(12,23,45,0.04);
      border-radius: 8px;
    }
    /* ‚îÄ‚îÄ Exception rows (ops-spend pattern) ‚îÄ‚îÄ */
    .decision-box-exceptions {
      margin: 0 0 10px 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .exception-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      padding: 9px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      align-items: center;
    }
    .exception-row:last-child { border-bottom: none; }
    .exception-row[onclick]:hover { background: rgba(246,248,251,0.8); cursor: pointer; }
    .exception-row-header {
      background: rgba(246,248,251,0.8);
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
    }
    .exception-label { color: var(--text); font-weight: 600; }
    .exception-count { color: #dc2626; font-weight: 700; font-family: var(--font-mono, monospace); text-align: right; }
    .exception-action { color: var(--accent); font-size: 12px; font-weight: 600; text-align: right; }

    /* ‚îÄ‚îÄ What / So What / Now What framework ‚îÄ‚îÄ */
    .wswn { display: flex; flex-direction: column; gap: 0; }
    .wswn-row {
      display: grid;
      grid-template-columns: 82px 1fr;
      gap: 10px;
      align-items: start;
      padding: 6px 0;
      border-top: 1px solid rgba(12,23,45,0.06);
    }
    .wswn-row:first-child { border-top: none; }
    .wswn-label {
      font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.09em;
      padding: 3px 7px; border-radius: 4px; white-space: nowrap; text-align: center;
      margin-top: 3px; flex-shrink: 0;
    }
    .wswn-label.lbl-what    { background: rgba(12,23,45,0.07);   color: #374151; }
    .wswn-label.lbl-sowhat  { background: rgba(245,158,11,0.14); color: #92400e; }
    .wswn-label.lbl-nowwhat { background: rgba(15,118,110,0.13); color: #134e4a; }
    /* Content: styled for readability within fixed-height container */
    .wswn-content {
      font-size: 13px; color: #5d6b7a; line-height: 1.55;
      padding-right: 4px;
    }
    /* .scrollable kept for markup compat */
    .wswn-content.scrollable { }
    /* ‚ïê‚ïê‚ïê WSWN Dynamic Risk States ‚ïê‚ïê‚ïê */
    /* Default ‚Äî teal/green (Healthy) */
    .wswn-wrap {
      margin: 16px 0 8px;
      padding: 18px 20px;
      border: 1.5px solid rgba(15,118,110,0.25);
      border-radius: 14px;
      background: #f0fdf9;
      transition: border-color 250ms ease, background 250ms ease, box-shadow 250ms ease;
      /* Fixed container height ‚Äî prevents layout jumping when content changes */
      min-height: 180px;
      max-height: 180px;
      overflow-y: auto;
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: rgba(12,23,45,0.18) transparent;
    }
    /* WSWN scrollbar styling */
    .wswn-wrap::-webkit-scrollbar { width: 4px; }
    .wswn-wrap::-webkit-scrollbar-track { background: transparent; }
    .wswn-wrap::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.18); border-radius: 4px; }
    .wswn-wrap::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.32); }
    .wswn-wrap-header {
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em;
      color: var(--muted); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
      transition: color 250ms ease;
    }
    /* Risk state: moderate/amber */
    .wswn-wrap--moderate {
      border-color: rgba(217,119,6,0.35);
      background: #fffbeb;
      box-shadow: 0 0 0 3px rgba(217,119,6,0.07);
    }
    .wswn-wrap--moderate .wswn-wrap-header { color: #92400e; }
    /* Risk state: high/red */
    .wswn-wrap--high {
      border-color: rgba(220,38,38,0.35);
      background: #fef2f2;
      box-shadow: 0 0 0 3px rgba(220,38,38,0.07);
    }
    .wswn-wrap--high .wswn-wrap-header { color: #991b1b; }
    /* Risk state: healthy/green explicit */
    .wswn-wrap--healthy {
      border-color: rgba(15,118,110,0.30);
      background: #f0fdf9;
      box-shadow: 0 0 0 3px rgba(15,118,110,0.07);
    }
    .wswn-wrap--healthy .wswn-wrap-header { color: #134e4a; }
    /* Bold Now What content */
    .wswn-nowwhat-bold { font-weight: 700; color: var(--text) !important; font-size: 13px; }
    .wswn-nowwhat-bold.risk-red { color: #dc2626 !important; }
    .wswn-nowwhat-bold.risk-amber { color: #b45309 !important; }
    .wswn-nowwhat-bold.risk-green { color: #0f766e !important; }
    /* WSWN label with threshold cursor */
    .wswn-label[data-help] { cursor: help; }
    /* Bold numbers inside WSWN content */
    .wswn-content strong { font-weight: 700; color: var(--text); }
    .wswn-wrap-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #0f766e;
      margin-bottom: 10px;
    }

    /* ‚îÄ‚îÄ Fixed-layout tables ‚îÄ‚îÄ */
    #channelTable, #accrualTable, #promoTable {
      table-layout: fixed;
      width: 100%;
    }
    #channelTable tbody tr,
    #accrualTable tbody tr,
    #promoTable tbody tr { height: 40px; }
    /* Break-even row in promo table overrides the fixed height */
    #promoTable tbody tr.breakeven-row { height: auto; }
    #channelTable td, #channelTable th,
    #accrualTable td, #accrualTable th,
    #promoTable td, #promoTable th {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    /* Break-even row td can wrap */
    #promoTable tbody tr.breakeven-row td {
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      height: auto;
    }
    /* Column widths: Channel table */
    #channelTable colgroup col:nth-child(1) { width: 10%; }
    #channelTable colgroup col:nth-child(2) { width: 14%; }
    #channelTable colgroup col:nth-child(3) { width: 14%; }
    #channelTable colgroup col:nth-child(4) { width: 14%; }
    #channelTable colgroup col:nth-child(5) { width: 14%; }
    #channelTable colgroup col:nth-child(6) { width: 14%; }
    #channelTable colgroup col:nth-child(7) { width: 20%; }
    /* Column widths: Accrual table */
    #accrualTable colgroup col:nth-child(1) { width: 12%; }
    #accrualTable colgroup col:nth-child(2) { width: 22%; }
    #accrualTable colgroup col:nth-child(3) { width: 22%; }
    #accrualTable colgroup col:nth-child(4) { width: 22%; }
    #accrualTable colgroup col:nth-child(5) { width: 22%; }

    /* ‚îÄ‚îÄ Fixed-height scroll containers ‚îÄ‚îÄ */
    #channelTableScroll {
      height: 340px;
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
    }
    #channelTableScroll table { margin: 0; }
    #channelTableScroll thead th {
      position: sticky;
      top: 0;
      background: white;
      z-index: 2;
      border-bottom: 2px solid var(--border);
    }
    #accrualTableScroll {
      height: 300px;
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
    }
    #accrualTableScroll table { margin: 0; }
    #accrualTableScroll thead th {
      position: sticky;
      top: 0;
      background: white;
      z-index: 2;
      border-bottom: 2px solid var(--border);
    }
    /* Scrollbar styling (from ops-spend) */
    #channelTableScroll::-webkit-scrollbar { width: 5px; }
    #channelTableScroll::-webkit-scrollbar-track { background: transparent; }
    #channelTableScroll::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }
    #channelTableScroll::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.28); }
    #accrualTableScroll::-webkit-scrollbar { width: 5px; }
    #accrualTableScroll::-webkit-scrollbar-track { background: transparent; }
    #accrualTableScroll::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }
    #accrualTableScroll::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.28); }
    /* Channel-level insight wswn scroll */
    #channelWswn::-webkit-scrollbar { width: 4px; }
    #channelWswn::-webkit-scrollbar-track { background: transparent; }
    #channelWswn::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }

    /* Section highlight flash (from ops-spend scrollToSection) */
    .section-highlight h2 { transition: color 300ms ease !important; color: var(--accent) !important; }
  
    /* ‚îÄ‚îÄ Data-needed strip ‚îÄ‚îÄ */
    .data-needed-section {
      padding: 0 0 0 0;
      border-bottom: 1px solid var(--border, #e5e8ef);
    }
    .data-needed-wrap {
      max-width: var(--max-w, 1200px);
      margin: 0 auto;
      padding: 20px 32px 24px;
    }
    .data-needed-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--muted, #6b7280);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .data-needed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(185px, 1fr));
      gap: 8px;
      align-items: stretch;
    }
    .data-needed-item {
      padding: 10px 12px;
      border: 1px solid var(--border, #e5e8ef);
      border-radius: 9px;
      display: flex;
      align-items: flex-start;
      gap: 9px;
      background: #fafbfc;
      min-height: 88px;
      box-sizing: border-box;
    }
    .data-needed-icon {
      width: 26px;
      height: 26px;
      font-size: 13px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .data-needed-name {
      font-size: 11px;
      font-weight: 700;
      color: var(--text, #0b1220);
      margin-bottom: 3px;
      line-height: 1.35;
    }
    .data-needed-desc {
      font-size: 10px;
      color: var(--muted, #6b7280);
      line-height: 1.5;
    }


    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SIDEBAR ‚Äî Accordion (shared across all modules)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .sidebar {
      position: sticky;
      top: 80px;
      padding: 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(12,23,45,0.15) transparent;
    }
    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }
    .sidebar::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.28); }

    /* Static top section (data mode badge + always-visible controls) */
    .sb-static {
      padding-bottom: 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }
    .sb-static-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    /* Accordion group */
    .sb-acc-group {
      border-bottom: 1px solid var(--border);
    }
    .sb-acc-group:last-child { border-bottom: none; }

    .sb-acc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 12px 0;
      cursor: pointer;
      user-select: none;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      transition: color 120ms ease;
    }
    .sb-acc-header:hover { color: var(--text); }
    .sb-acc-header.open  { color: var(--text); }
    .sb-acc-chevron {
      font-size: 10px;
      color: var(--muted);
      transition: transform 200ms ease;
      flex-shrink: 0;
    }
    .sb-acc-header.open .sb-acc-chevron {
      transform: rotate(180deg);
      color: var(--text);
    }
    .sb-acc-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft, rgba(15,118,110,0.10));
      color: var(--accent, #0f766e);
      flex-shrink: 0;
      margin-left: auto;
    }

    .sb-acc-body {
      display: none;
      padding-bottom: 14px;
    }
    .sb-acc-body.open { display: block; }

    /* Buttons inside accordion */
    .sb-acc-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      transition: all 140ms ease;
      text-align: left;
      white-space: nowrap;
      font-family: inherit;
    }
    .sb-acc-btn:first-child { margin-top: 0; }
    .sb-acc-btn:hover {
      border-color: rgba(12,23,45,0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.06);
    }
    .sb-acc-btn:active { transform: translateY(1px); }
    .sb-acc-btn.primary { background: var(--text, #0b1220); color: white; border-color: var(--text, #0b1220); }
    .sb-acc-btn.primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-acc-btn.accent  { background: var(--accent, #0f766e); color: white; border-color: var(--accent, #0f766e); }

    /* Scenario tabs inside accordion */
    .sb-acc-tabs { display: flex; flex-direction: column; gap: 6px; }
    .sb-acc-tab {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 140ms ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }
    .sb-acc-tab:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-tab.active { background: var(--text, #0b1220); color: white; border-color: var(--text, #0b1220); }

    /* Input rows inside accordion */
    .sb-acc-input-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .sb-acc-input-row:last-child { margin-bottom: 0; }
    .sb-acc-input-row label {
      font-size: 11px;
      color: var(--muted, #5d6b7a);
      flex: 1;
      line-height: 1.3;
    }
    .sb-acc-input-row input[type="number"] {
      width: 76px;
      padding: 5px 7px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      background: white;
      text-align: right;
      flex-shrink: 0;
      -moz-appearance: textfield;
    }
    .sb-acc-input-row input[type="number"]::-webkit-outer-spin-button,
    .sb-acc-input-row input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .sb-acc-input-row input[type="number"]:focus {
      outline: none;
      border-color: var(--accent, #0f766e);
      box-shadow: 0 0 0 2px rgba(15,118,110,0.15);
    }
    .sb-acc-sub {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.07em;
      text-transform: uppercase;
      margin: 10px 0 8px;
      border-top: 1px solid var(--border);
      padding-top: 9px;
    }

    /* Responsive: on mobile sidebar goes full width, no sticky, no scroll */
    @media (max-width: 860px) {
      .sidebar {
        position: static;
        max-height: none;
        overflow-y: visible;
      }
    }

  
    /* ‚îÄ‚îÄ Tooltip engine: body-level fixed div, never clipped by overflow ‚îÄ‚îÄ */
    /* Kill ALL CSS ::after tooltip rules ‚Äî they clip inside overflow containers */
    .help-icon::after,
    .help-icon:hover::after,
    .help-icon[data-help]::after,
    [data-tt]::after,
    [data-tt]:hover::after,
    .term-helper::after,
    .term-helper:hover::after {
      content: none !important;
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }

    /* #tt-root ‚Äî single fixed tooltip bubble appended to <body> by JS */
    #tt-root {
      position: fixed;
      z-index: 99999;
      pointer-events: none;
      padding: 9px 13px;
      background: rgba(11,18,32,0.95);
      color: #f0f4f8;
      font-size: 12px;
      font-weight: 400;
      line-height: 1.55;
      border-radius: 9px;
      white-space: normal;
      width: 270px;
      max-width: calc(100vw - 24px);
      box-shadow: 0 4px 18px rgba(0,0,0,0.28);
      text-align: left;
      opacity: 0;
      transition: opacity 120ms ease;
    }
    #tt-root.tt-visible { opacity: 1; }

    /* .help-icon visual ‚Äî keep the badge, remove position:relative (no longer needed) */
    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(15,118,110,0.10);
      border: 1px solid rgba(15,118,110,0.20);
      color: var(--accent);
      font-size: 11px;
      font-weight: 700;
      cursor: help;
      flex-shrink: 0;
      position: static;   /* was relative ‚Äî not needed with body-level tooltip */
    }
    .help-icon::before { content: '?'; line-height: 1; }

  
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SHARED SIDEBAR SHELL ‚Äî standardised across all modules
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* Layout */
    .module-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      align-items: start;
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .main-content { min-width: 0; }

    /* Mobile Controls Toggle Button */
    .mobile-controls-btn {
      display: none;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      cursor: pointer;
      margin-bottom: 4px;
      box-shadow: var(--shadow-soft);
      transition: all 140ms ease;
    }
    .mobile-controls-btn:hover {
      border-color: rgba(12,23,45,0.18);
      box-shadow: var(--shadow);
    }
    .mobile-controls-btn .mcb-icon { font-size: 16px; flex-shrink: 0; }
    .mobile-controls-btn .mcb-label { flex: 1; text-align: left; }
    .mobile-controls-btn .mcb-chevron {
      font-size: 11px; color: var(--muted);
      transition: transform 200ms ease;
    }
    .mobile-controls-btn[aria-expanded="true"] .mcb-chevron { transform: rotate(180deg); }

    /* Sidebar shell */
    .sidebar {
      position: sticky;
      top: calc(var(--nav-h, 56px) + 36px);
      padding: 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      max-height: calc(100vh - var(--nav-h, 56px) - 52px);
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(12,23,45,0.15) transparent;
      width: 280px;
    }
    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }
    .sidebar::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.28); }

    /* Static section (Data Mode etc ‚Äî always visible) */
    .sb-static {
      padding-bottom: 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }
    .sb-static-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    /* ‚îÄ‚îÄ Data Mode segmented control (fixed height, no wrapping) ‚îÄ‚îÄ */
    .sb-data-mode-row {
      display: flex;
      gap: 0;
      height: 34px;              /* fixed height ‚Äî prevents layout shift */
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: var(--bg-muted);
      flex-wrap: nowrap;         /* never wrap */
    }
    .sb-data-mode-btn {
      flex: 1;
      min-width: 0;
      height: 100%;
      padding: 0 4px;
      background: transparent;
      border: none;
      border-right: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: background 120ms ease, color 120ms ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: inherit;
    }
    .sb-data-mode-btn:last-child { border-right: none; }
    .sb-data-mode-btn:hover { background: rgba(12,23,45,0.04); color: var(--text); }
    .sb-data-mode-btn.active {
      background: var(--text);
      color: white;
    }

    /* Mode pills (2-option) ‚Äî also fixed height */
    .sb-mode-pills {
      display: flex;
      gap: 0;
      height: 34px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: var(--bg-muted);
      flex-wrap: nowrap;
    }
    .sb-mode-pill {
      flex: 1;
      height: 100%;
      padding: 0 6px;
      border: none;
      border-right: 1px solid var(--border);
      background: transparent;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: background 120ms ease, color 120ms ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: inherit;
      text-align: center;
    }
    .sb-mode-pill:last-child { border-right: none; }
    .sb-mode-pill:hover { background: rgba(12,23,45,0.04); color: var(--text); }
    .sb-mode-pill.active { background: var(--text); color: white; }

    /* Badge */
    .data-badge {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15,118,110,0.10);
      border: 1px solid rgba(15,118,110,0.20);
      color: var(--accent);
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .data-badge.random {
      background: #fef3c7;
      border-color: #fbbf24;
      color: #92400e;
    }

    /* Accordion groups */
    .sb-acc-group {
      border-bottom: 1px solid var(--border);
    }
    .sb-acc-group:last-child { border-bottom: none; }

    .sb-acc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 12px 0;
      cursor: pointer;
      user-select: none;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      transition: color 120ms ease;
      font-family: inherit;
    }
    .sb-acc-header:hover { color: var(--text); }
    .sb-acc-header.open  { color: var(--text); }
    .sb-acc-chevron {
      font-size: 10px;
      color: var(--muted);
      transition: transform 200ms ease;
      flex-shrink: 0;
    }
    .sb-acc-header.open .sb-acc-chevron { transform: rotate(180deg); color: var(--text); }
    .sb-acc-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      flex-shrink: 0;
      margin-left: auto;
    }

    .sb-acc-body {
      display: none;
      padding-bottom: 14px;
    }
    .sb-acc-body.open { display: block; }

    /* Buttons inside accordion */
    .sb-acc-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      transition: all 140ms ease;
      text-align: left;
      white-space: nowrap;
      font-family: inherit;
    }
    .sb-acc-btn:first-child { margin-top: 0; }
    .sb-acc-btn:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-btn:active { transform: translateY(1px); }
    .sb-acc-btn.primary { background: var(--text); color: white; border-color: var(--text); }
    .sb-acc-btn.primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-acc-btn.accent  { background: var(--accent); color: white; border-color: var(--accent); }

    /* Tabs (scenario selectors etc.) */
    .sb-acc-tabs { display: flex; flex-direction: column; gap: 6px; }
    .sb-acc-tab {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 140ms ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }
    .sb-acc-tab:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-tab.active { background: var(--text); color: white; border-color: var(--text); }

    /* Input rows */
    .sb-acc-input-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .sb-acc-input-row:last-child { margin-bottom: 0; }
    .sb-acc-input-row label {
      font-size: 11px;
      color: var(--muted);
      flex: 1;
      line-height: 1.3;
    }
    .sb-acc-input-row input[type="number"] {
      width: 76px;
      padding: 5px 7px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      background: white;
      text-align: right;
      flex-shrink: 0;
      -moz-appearance: textfield;
    }
    .sb-acc-input-row input[type="number"]::-webkit-outer-spin-button,
    .sb-acc-input-row input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .sb-acc-input-row input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(15,118,110,0.15);
    }
    .sb-acc-sub {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.07em;
      text-transform: uppercase;
      margin: 10px 0 8px;
      border-top: 1px solid var(--border);
      padding-top: 9px;
    }

    /* Action buttons (full-width) */
    .sb-action-btn {
      display: flex; align-items: center; gap: 8px;
      width: 100%; padding: 7px 12px;
      border-radius: 999px; border: 1px solid var(--border);
      background: white; font-size: 12px; font-weight: 600;
      cursor: pointer; margin-top: 6px;
      transition: all 140ms ease; text-align: left;
      white-space: nowrap; font-family: inherit;
    }
    .sb-action-btn:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-action-btn:active { transform: translateY(1px); }
    .sb-action-btn.sb-action-primary { background: var(--text); color: white; border-color: var(--text); }
    .sb-action-btn.sb-action-primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-action-btn.sb-action-accent  { background: var(--accent); color: white; border-color: var(--accent); }
    .sb-file-hidden { position: absolute; opacity: 0; width: 0; height: 0; }

    /* Sliders */
    .control-item { margin-bottom: 16px; }
    .control-item:last-child { margin-bottom: 0; }
    .control-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }
    .control-value {
      font-size: 13px;
      font-weight: 700;
      color: var(--accent-2);
      font-family: var(--font-mono, monospace);
    }
    .control-input {
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 6px;
      border-radius: 3px;
      background: var(--bg-muted);
      outline: none; cursor: pointer;
    }
    .control-input::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
      box-shadow: 0 2px 8px rgba(15,118,110,0.3);
      transition: all 140ms ease;
    }
    .control-input::-webkit-slider-thumb:hover { transform: scale(1.1); }
    .control-input::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
      box-shadow: 0 2px 8px rgba(15,118,110,0.3); border: none;
    }

    /* ‚îÄ‚îÄ Mobile responsive ‚îÄ‚îÄ */
    @media (max-width: 860px) {
      .module-layout {
        grid-template-columns: 1fr;
        padding: 16px;
      }
      .mobile-controls-btn { display: flex; }
      .sidebar {
        position: static;
        top: 0;
        width: 100%;
        max-height: none;
        overflow-y: visible;
        display: none;            /* hidden by default; JS toggles */
        border-radius: var(--radius-sm);
        margin-bottom: 8px;
      }
      .sidebar.mobile-open { display: block; }
    }

    @media (max-width: 560px) {
      .module-layout { padding: 12px; }
    }

    /* ‚îÄ‚îÄ Demo data pill ‚îÄ‚îÄ */
    .demo-data-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #4a5568;
      padding: 4px 11px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(246,248,251,0.9);
      letter-spacing: 0.01em;
      white-space: nowrap;
      margin-top: 10px;
    }
    .demo-data-pill::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #94a3b8;
      flex-shrink: 0;
    }
    .module-hero-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    /* ‚îÄ‚îÄ Framework section shared classes ‚îÄ‚îÄ */
    .fw-intro {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.6;
      margin-bottom: 0;
      max-width: 760px;
    }

    /* ‚îÄ‚îÄ Unified outline button ‚îÄ‚îÄ */
    .btn-outline {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 18px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      color: var(--text);
      transition: border-color 140ms ease, box-shadow 140ms ease;
      white-space: nowrap;
    }
    .btn-outline:hover {
      border-color: rgba(12,23,45,0.20);
      box-shadow: 0 4px 12px rgba(11,18,32,0.08);
    }
    .btn-outline:active { transform: translateY(1px); }

    /* ‚îÄ‚îÄ Chip refinement ‚îÄ‚îÄ */
    .chip { font-size: 11px; padding: 5px 11px; }

    /* ‚îÄ‚îÄ muted color match with style.css ‚îÄ‚îÄ */
    :root { --muted: #4a5568; }

</style>
<style>
/* ‚îÄ‚îÄ Global Time Ticker ‚îÄ‚îÄ */
.tz-live-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#10b981;box-shadow:0 0 0 0 rgba(16,185,129,.4);animation:tzPulse 2.4s ease-in-out infinite;flex-shrink:0}
@keyframes tzPulse{0%{box-shadow:0 0 0 0 rgba(16,185,129,.4)}60%{box-shadow:0 0 0 5px rgba(16,185,129,0)}100%{box-shadow:0 0 0 0 rgba(16,185,129,0)}}
.tz-ticker{position:sticky;top:var(--nav-h,56px);z-index:89;background:rgba(250,251,252,.96);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-bottom:1px solid var(--border);height:36px;display:flex;align-items:center;opacity:0;pointer-events:none;transform:translateY(-4px);transition:opacity 220ms ease,transform 220ms ease}
.tz-ticker.tz-ticker--visible{opacity:1;pointer-events:auto;transform:translateY(0)}
.tz-ticker-inner{max-width:900px;width:100%;margin:0 auto;padding:0 24px;display:flex;align-items:center;overflow:hidden}
.tz-ticker-brand{display:inline-flex;align-items:center;gap:5px;font-size:10px;font-weight:750;letter-spacing:.07em;text-transform:uppercase;color:var(--accent);text-decoration:none;flex-shrink:0;padding-right:10px}
.tz-ticker-brand:hover{opacity:.75}
.tz-ticker-divider{width:1px;height:16px;background:var(--border);flex-shrink:0;margin-right:10px}
.tz-ticker-items{display:flex;align-items:center;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;flex:1;min-width:0}
.tz-ticker-items::-webkit-scrollbar{display:none}
.tz-ticker-item{display:inline-flex;align-items:center;gap:5px;padding:0 12px;height:36px;font-size:11px;flex-shrink:0;border-right:1px solid var(--border);white-space:nowrap}
.tz-ticker-item:first-child{padding-left:0}.tz-ticker-item:last-child{border-right:none}
.tz-ticker-item-label{font-size:9px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted)}
.tz-ticker-item-value{font-size:11px;font-weight:620;color:var(--text);font-variant-numeric:tabular-nums}
.tz-ticker-item-value.tk-active{color:#059669;font-weight:700}.tz-ticker-item-value.tk-ending{color:#d97706;font-weight:700}.tz-ticker-item-value.tk-offline{color:#94a3b8}.tz-ticker-item-value.tk-window{color:var(--accent);font-weight:680}
.tz-ticker-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.tz-ticker-dot.tk-active{background:#059669}.tz-ticker-dot.tk-ending{background:#d97706}.tz-ticker-dot.tk-offline{background:#cbd5e1}
@media(max-width:640px){.tz-ticker-inner{padding:0 12px}.tz-ticker-item{padding:0 9px}}
</style>
</head>
<body>

  <a href="#main-content" class="skip-link">Skip to content</a>

  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html" class="brand">
          <span class="brand-mark" aria-hidden="true"></span>
          Ralph Patrick Divina
        </a>
        <div class="nav-cta">
          <a href="index.html#card-commercial-sales" class="btn btn-ghost">‚Üê Back to Portfolio</a>
        </div>
      </nav>
    </div>
  </header>
</header>
<!-- Global Time Ticker -->
<div class="tz-ticker tz-ticker--visible" id="tz-ticker" aria-label="Global time coordination summary">
  <div class="tz-ticker-inner">
    <a class="tz-ticker-brand" href="index.html#tz-world" aria-label="Go to Time section">
      <span class="tz-live-dot"></span>
      <span>Time</span>
    </a>
    <div class="tz-ticker-divider"></div>
    <div class="tz-ticker-items" id="tz-ticker-items"><!-- JS-rendered --></div>
  </div>
</div>

  <main id="main-content">
    
    <!-- Hero -->
    <section class="module-hero">
      <div class="container">
        <div class="module-eyebrow">Commercial Finance &bull; GTM Decision Support <span class="help-icon" data-help="GTM = Go-to-Market. This refers to the commercial strategy for how products reach customers ‚Äî including which channels, pricing tiers, promotions, and trade terms are used. GTM finance connects revenue analysis to those decisions." style="vertical-align:middle;"></span></div>
        <h1 class="module-title">Commercial &amp; Sales Finance</h1>
        <p class="module-subtitle">Four connected analyses that answer the core commercial question: where is revenue actually coming from, what is it costing, and where should resources shift next period?</p>
        <div class="feature-chips">
          <span class="chip">Promo ROI</span>
          <span class="chip">Channel P&amp;L</span>
          <span class="chip">Price / Volume / Mix</span>
          <span class="chip">Trade Accrual</span>
          <span class="chip">Break-even Analysis</span>
          <span class="chip">Single CSV Upload</span>
        </div>
        <div class="module-hero-meta">
          <span class="demo-data-pill">Demo dataset &bull; Synthetic, non-confidential</span>
        </div>
      </div>
    </section>

  <!-- WHY THIS MATTERS STRIP -->
  <div style="background:#f8fafb;border-bottom:1px solid var(--border);padding:18px 0;">
    <div style="max-width:1400px;margin:0 auto;padding:0 24px;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <span style="font-size:16px;flex-shrink:0;">üìä</span>
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Better promo &amp; channel decisions</div>
            <div style="font-size:11px;color:var(--muted);line-height:1.4;">Know which promos are actually worth repeating and which channels earn their cost.</div>
          </div>
        </div>
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <span style="font-size:16px;flex-shrink:0;">üîÄ</span>
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Cleaner performance comparisons</div>
            <div style="font-size:11px;color:var(--muted);line-height:1.4;">Separate price, volume, and mix effects so leadership sees what actually drove the number.</div>
          </div>
        </div>
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <span style="font-size:16px;flex-shrink:0;">üí°</span>
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Better budget reallocation logic</div>
            <div style="font-size:11px;color:var(--muted);line-height:1.4;">Channel P&amp;L and contribution margins point clearly to where resources should shift.</div>
          </div>
        </div>
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <span style="font-size:16px;flex-shrink:0;">üìã</span>
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Fewer quarter-end surprises</div>
            <div style="font-size:11px;color:var(--muted);line-height:1.4;">Straight-line accrual logic distributes trade spend evenly ‚Äî no P&amp;L spikes at settlement.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DATA NEEDED STRIP -->
  <div class="data-needed-section">
    <div class="data-needed-wrap">
      <div class="data-needed-label">üìÇ &nbsp;One flat CSV powers all 4 analyses ‚Äî upload in the sidebar to use your own data</div>
      <div class="data-needed-grid" style="grid-template-columns:1fr 1fr 1fr 1fr 1fr;">
        <div class="data-needed-item" style="border-color:rgba(15,118,110,0.30);background:#f0fdf9;">
          <div class="data-needed-icon" style="background:rgba(15,118,110,0.12);">üìÑ</div>
          <div>
            <div class="data-needed-name">Single Flat CSV</div>
            <div class="data-needed-desc">One row per channel/month. All 4 analyses run from this one file ‚Äî no joins, no extra sheets.</div>
          </div>
        </div>
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#fef3c7;">üéØ</div><div><div class="data-needed-name">Promo ROI</div><div class="data-needed-desc">Was the promotion worth it? Compares GP before and during promo minus campaign cost ‚Äî so you know whether to repeat, resize, or stop.</div></div></div>
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#eff6ff;">üìä</div><div><div class="data-needed-name">Channel P&amp;L</div><div class="data-needed-desc">Which channels earn their cost? Breaks down revenue and profit after COGS &amp; OpEx to guide budget reallocation.</div></div></div>
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#f0fdf9;">üîÄ</div><div><div class="data-needed-name">Price / Volume / Mix</div><div class="data-needed-desc">Why did revenue change? Splits variance into 3 root causes so leadership knows what to protect ‚Äî not just that numbers moved.</div></div></div>
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#f5f3ff;">üí∞</div><div><div class="data-needed-name">Accrual Schedule</div><div class="data-needed-desc">Straight-line trade accrual keeps P&amp;L clean ‚Äî no spikes at quarter-end when deal settlements hit.</div></div></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       DATA COLLECTION PLAYBOOK
       Collapsible section ‚Äî open by default, placed before all 4 modules
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="playbook-section" style="border-bottom:1px solid var(--border);background:#fafbfc;">
    <div style="max-width:1400px;margin:0 auto;padding:0 24px;">

      <!-- Playbook toggle header -->
      <button
        id="playbookToggleBtn"
        onclick="togglePlaybook()"
        style="width:100%;display:flex;align-items:center;justify-content:space-between;gap:16px;
               padding:18px 0;background:none;border:none;cursor:pointer;font-family:inherit;text-align:left;"
        aria-expanded="true"
        aria-controls="playbookBody">
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="font-size:18px;">üóÇÔ∏è</span>
          <div>
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--muted);margin-bottom:2px;">Behind the Model</div>
            <div style="font-size:16px;font-weight:700;color:var(--text);letter-spacing:-0.02em;">Commercial Data Framework ‚Äî How I Build a Decision-Ready Dataset From Messy, Multi-Stakeholder Inputs</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;flex-shrink:0;">
          <span class="playbook-hint" style="font-size:11px;font-weight:600;color:var(--muted);white-space:nowrap;">Click to collapse</span>
          <span id="playbookChevron" style="font-size:14px;color:var(--muted);transition:transform 200ms ease;">‚ñ≤</span>
        </div>
      </button>

      <!-- Playbook body ‚Äî open by default -->
      <div id="playbookBody" style="padding-bottom:32px;">
        <div style="max-width:960px;margin:0 auto;">

        <!-- Intro statement -->
        <div style="margin-bottom:24px;">
          <p class="fw-intro">
            Revenue lives in the ERP, campaign spend with budget owners, COGS in Finance, trade deal terms in procurement ‚Äî each team uses different definitions of the same metric. Below is how I map field ownership upfront, resolve definition conflicts before collection starts, and keep intake lightweight enough that owners can contribute without a meeting.
          </p>
        </div>

        <!-- ‚îÄ‚îÄ Step 1: Stakeholder ‚Üí Field Ownership Map ‚îÄ‚îÄ -->
        <div style="margin-bottom:32px;">
          <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:0.09em;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px;">
            <span style="width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0;">1</span>
            Stakeholder ‚Üí Field Ownership Map
          </div>
          <p style="font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:16px;">
            Before collection starts, every field maps to a single owner. This prevents the most common failure: multiple teams partially filling the same column with different definitions.
          </p>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;">

            <div style="padding:14px 16px;border:1px solid var(--border);border-radius:12px;background:white;border-left:3px solid #0f766e;">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#0f766e;margin-bottom:6px;">Finance (FP&amp;A)</div>
              <div style="font-size:12px;color:var(--text);font-weight:600;margin-bottom:4px;">Prior &amp; Current Revenue, PVM Effects</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.5;">Source of truth for total revenue, period-over-period variance, and price/volume/mix decomposition. Typically pulled from ERP or financial reporting layer.</div>
              <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;">
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,118,110,0.08);color:#0f766e;font-weight:600;">prior_revenue</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,118,110,0.08);color:#0f766e;font-weight:600;">current_revenue</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,118,110,0.08);color:#0f766e;font-weight:600;">price_effect</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,118,110,0.08);color:#0f766e;font-weight:600;">volume_effect</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,118,110,0.08);color:#0f766e;font-weight:600;">mix_effect</span>
              </div>
            </div>

            <div style="padding:14px 16px;border:1px solid var(--border);border-radius:12px;background:white;border-left:3px solid #1b4d7a;">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#1b4d7a;margin-bottom:6px;">Accounting / Revenue Ops</div>
              <div style="font-size:12px;color:var(--text);font-weight:600;margin-bottom:4px;">Channel Revenue, COGS, OpEx, GP%</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.5;">Owns the actuals by channel and month. Usually exported from ERP (e.g. Workday, NetSuite). COGS and OpEx allocation methodology must be agreed upfront ‚Äî channel-level splits often differ between teams.</div>
              <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;">
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(27,77,122,0.08);color:#1b4d7a;font-weight:600;">revenue</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(27,77,122,0.08);color:#1b4d7a;font-weight:600;">cogs</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(27,77,122,0.08);color:#1b4d7a;font-weight:600;">opex</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(27,77,122,0.08);color:#1b4d7a;font-weight:600;">gp_pct</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(27,77,122,0.08);color:#1b4d7a;font-weight:600;">contribution</span>
              </div>
            </div>

            <div style="padding:14px 16px;border:1px solid var(--border);border-radius:12px;background:white;border-left:3px solid #d97706;">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#d97706;margin-bottom:6px;">Marketing / Growth (Budget Owners)</div>
              <div style="font-size:12px;color:var(--text);font-weight:600;margin-bottom:4px;">Baseline Revenue, Promo Revenue, GP During Promo, Promo Cost</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.5;">Each budget owner knows their campaign spend and the revenue numbers during the promo window. In orgs with many distributed budget owners, this must be collected via a structured template ‚Äî not ad hoc emails.</div>
              <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;">
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(217,119,6,0.10);color:#b45309;font-weight:600;">baseline_revenue</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(217,119,6,0.10);color:#b45309;font-weight:600;">promo_revenue</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(217,119,6,0.10);color:#b45309;font-weight:600;">baseline_gp</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(217,119,6,0.10);color:#b45309;font-weight:600;">promo_gp</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(217,119,6,0.10);color:#b45309;font-weight:600;">promo_cost</span>
              </div>
            </div>

            <div style="padding:14px 16px;border:1px solid var(--border);border-radius:12px;background:white;border-left:3px solid #7c3aed;">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#7c3aed;margin-bottom:6px;">Procurement / Commercial</div>
              <div style="font-size:12px;color:var(--text);font-weight:600;margin-bottom:4px;">Discount Pool, Deal Start &amp; End Month</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.5;">Owns the trade deal terms. The discount pool size and timing window are typically set at deal negotiation. Procurement sign-off is needed before accrual can be booked ‚Äî misalignment here causes quarter-end P&amp;L surprises.</div>
              <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;">
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(124,58,237,0.08);color:#7c3aed;font-weight:600;">discount_pool</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(124,58,237,0.08);color:#7c3aed;font-weight:600;">start_month</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(124,58,237,0.08);color:#7c3aed;font-weight:600;">end_month</span>
              </div>
            </div>

          </div>
        </div>

        <!-- ‚îÄ‚îÄ Step 2: Messy ‚Üí Clean Transformation ‚îÄ‚îÄ -->
        <div style="margin-bottom:32px;">
          <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:0.09em;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px;">
            <span style="width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0;">2</span>
            Messy Input ‚Üí Clean Schema ‚Äî What the Reality Looks Like
          </div>
          <p style="font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:16px;">
            Here's what typical intake looks like ‚Äî and how each issue is handled before it reaches the model.
          </p>
          <div style="overflow-x:auto;border:1px solid var(--border);border-radius:12px;">
            <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:640px;">
              <thead>
                <tr style="background:rgba(246,248,251,0.9);">
                  <th style="padding:10px 14px;text-align:left;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);border-bottom:1px solid var(--border);">What Comes In</th>
                  <th style="padding:10px 14px;text-align:left;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);border-bottom:1px solid var(--border);">Why It's a Problem</th>
                  <th style="padding:10px 14px;text-align:left;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);border-bottom:1px solid var(--border);">How I Handle It</th>
                </tr>
              </thead>
              <tbody>
                <tr style="border-bottom:1px solid var(--border);">
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">Month as "January", "jan", "1", "01/2024"</td>
                  <td style="padding:10px 14px;color:#dc2626;">4 different formats = lookup failures, broken filters</td>
                  <td style="padding:10px 14px;color:#0f766e;">Template enforces dropdown selection (Jan‚ÄìDec). Parser normalises on intake.</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border);background:rgba(246,248,251,0.4);">
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">Revenue in local currency (EUR, SGD, GBP) with no FX note</td>
                  <td style="padding:10px 14px;color:#dc2626;">Totals are meaningless without a common currency base</td>
                  <td style="padding:10px 14px;color:#0f766e;">Template header requires: currency + FX rate used. Finance team provides a shared rate card per period.</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border);">
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">COGS missing for certain channels ‚Äî "finance will add later"</td>
                  <td style="padding:10px 14px;color:#dc2626;">GP% and contribution are blank = model can't compute Channel P&amp;L</td>
                  <td style="padding:10px 14px;color:#0f766e;">Validation flags missing COGS rows before submission. Default: use prior-period COGS% as placeholder, flagged in output.</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border);background:rgba(246,248,251,0.4);">
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">Promo cost split across 3 budget lines by 2 different owners</td>
                  <td style="padding:10px 14px;color:#dc2626;">Double-counting or under-counting campaign cost = wrong ROI</td>
                  <td style="padding:10px 14px;color:#0f766e;">Single "promo_cost" field. Template notes: include all fully-loaded campaign costs. One owner per campaign signs off the total.</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border);">
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">Discount pool agreed verbally, no deal memo</td>
                  <td style="padding:10px 14px;color:#dc2626;">Procurement and Accounting have different numbers ‚Äî accrual disputes at quarter-end</td>
                  <td style="padding:10px 14px;color:#0f766e;">Procurement required to submit signed deal summary before data collection opens. Pool amount locked at that point.</td>
                </tr>
                <tr>
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">ERP export has 12 tabs (one per month) instead of flat rows</td>
                  <td style="padding:10px 14px;color:#dc2626;">Model needs flat format ‚Äî one row per channel/month. Tabs = manual reformatting risk.</td>
                  <td style="padding:10px 14px;color:#0f766e;">Pre-built Power Query / Python script flattens the export into the unified schema before upload. Template also accepts flat paste-in.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ Step 3: CSV Template + async-first process ‚îÄ‚îÄ -->
        <div style="margin-bottom:32px;">
          <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:0.09em;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px;">
            <span style="width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0;">3</span>
            The Intake Template ‚Äî One File, Clear Ownership, No Ambiguity
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div style="padding:16px 18px;border:1px solid var(--border);border-radius:12px;background:white;">
              <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px;">What's in the template</div>
              <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px;">
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚úì</span>All 20 required columns across four analyses: channel P&amp;L, promo ROI, price/volume/mix, and trade accrual ‚Äî pre-labelled with field name and expected format</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚úì</span>Column naming signals owner: channel and margin columns belong to Finance/Revenue Ops; promo columns to Marketing/Budget Owners; discount pool and deal timing columns to Procurement</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚úì</span>Two pre-filled example rows (Direct and Online channels for January) so contributors see exactly what a complete, correctly formatted row looks like</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚úì</span>All monetary values should be in a single agreed currency before submission ‚Äî the model applies no FX conversion, so alignment on currency must happen before the template goes out</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚úì</span>Upload validation checks for all required columns and returns the specific missing column names ‚Äî no silent failures</li>
              </ul>
            </div>
            <div style="padding:16px 18px;border:1px solid var(--border);border-radius:12px;background:white;">
              <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px;">The async-first collection process</div>
              <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px;">
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#1b4d7a;font-weight:700;flex-shrink:0;">1.</span>Template + deadline sent to each owner via async message (Slack/email) with clear field instructions ‚Äî no meeting required to kick off</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#1b4d7a;font-weight:700;flex-shrink:0;">2.</span>Shared tracker (e.g. Airtable) shows submission status per owner and region ‚Äî no chasing over email threads</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#1b4d7a;font-weight:700;flex-shrink:0;">3.</span>Validation script runs on each submission ‚Äî flags gaps and sends back a specific query, not a generic "please fix"</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#1b4d7a;font-weight:700;flex-shrink:0;">4.</span>Regional leads each have a single point of contact who consolidates their region's inputs ‚Äî reduces noise for Finance</li>
              </ul>
            </div>
          </div>
          <div style="margin-top:12px;">
            <button onclick="downloadFlatTemplate()" class="btn-outline">
              ‚¨á Download the Unified CSV Template
            </button>
            <span style="font-size:11px;color:var(--muted);margin-left:12px;">All 4 modules. One file. Pre-labelled columns with owner guidance.</span>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ Step 4: Alignment note ‚îÄ‚îÄ -->
        <div style="margin-bottom:8px;">
          <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:0.09em;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px;">
            <span style="width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0;">4</span>
            Stakeholder Alignment ‚Äî What I Do When Teams Can't Agree on the Numbers
          </div>
          <div style="padding:20px 24px;border:1px solid rgba(15,118,110,0.25);border-radius:14px;background:#f0fdf9;">
            <p style="font-size:13px;color:var(--text);line-height:1.65;margin-bottom:12px;">
              The hardest part of a model like this isn't the analysis ‚Äî it's getting distributed owners across time zones to agree on what the numbers mean. Here's how I approach it:
            </p>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div style="display:flex;align-items:flex-start;gap:12px;">
                <span style="width:24px;height:24px;border-radius:6px;background:rgba(15,118,110,0.15);color:#0f766e;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">A</span>
                <div>
                  <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Define terms before collecting data</div>
                  <div style="font-size:12px;color:var(--muted);line-height:1.55;">What counts as "baseline revenue"? Prior 4-week average, same period last year, or a statistical forecast? Does it include renewals and expansions, or new logo only? I publish a one-page definition doc before collection opens ‚Äî disagreements get resolved then, not after the model is built.</div>
                </div>
              </div>
              <div style="display:flex;align-items:flex-start;gap:12px;">
                <span style="width:24px;height:24px;border-radius:6px;background:rgba(15,118,110,0.15);color:#0f766e;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">B</span>
                <div>
                  <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Use lightweight async sign-off, not long meetings</div>
                  <div style="font-size:12px;color:var(--muted);line-height:1.55;">A 60-minute alignment call with 12 stakeholders is expensive and often unproductive. Instead: send an async brief ‚Äî definition, two example data points, and a "does this match your understanding?" question ‚Äî with a 48-hour window. Most approvals happen without a meeting.</div>
                </div>
              </div>
              <div style="display:flex;align-items:flex-start;gap:12px;">
                <span style="width:24px;height:24px;border-radius:6px;background:rgba(15,118,110,0.15);color:#0f766e;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">C</span>
                <div>
                  <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Flag data quality explicitly ‚Äî don't hide uncertainty</div>
                  <div style="font-size:12px;color:var(--muted);line-height:1.55;">If COGS are estimated because the ERP export isn't reconciled, the model says so. A "Confidence: Medium" tag is more useful to a decision-maker than a clean-looking placeholder ‚Äî and it protects the analyst when the real number comes in different.</div>
                </div>
              </div>
              <div style="display:flex;align-items:flex-start;gap:12px;">
                <span style="width:24px;height:24px;border-radius:6px;background:rgba(15,118,110,0.15);color:#0f766e;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">D</span>
                <div>
                  <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Reduce the burden on high-volume regions with limited Finance coverage</div>
                  <div style="font-size:12px;color:var(--muted);line-height:1.55;">For lean teams: pre-fill from existing data, limit the template to fields that genuinely need human input, and give a clear default instruction. The goal is accurate data with minimum effort from people who are already stretched.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        </div><!-- /inner-centered-wrapper -->
      </div><!-- /playbookBody -->
    </div><!-- /container -->
  </section>

    <!-- Main Layout with Sidebar -->
    <div class="module-layout">
      
      <!-- Sticky Sidebar -->
          <!-- Mobile Controls Toggle (hidden on desktop) -->
    <button class="mobile-controls-btn" id="mobileControlsBtn" aria-expanded="false">
      <span class="mcb-icon">&#9881;</span>
      <span class="mcb-label">Controls</span>
      <span class="mcb-chevron">&#9660;</span>
    </button>
    <aside class="sidebar" id="sidebarPanel">

      <!-- DATA MODE ‚Äî always visible -->
      <div class="sb-static">
        <div class="sb-static-title">
          <span>DATA MODE</span>
          <span id="dataModeBadge" class="data-badge">SAMPLE</span>
        </div>
        <div style="display:flex;gap:0;height:34px;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--bg-muted);flex-wrap:nowrap;">
          <button id="btnSampleMode" onclick="loadWinningPromo()" style="flex:1;height:100%;padding:0 4px;background:var(--text);color:white;border:none;border-right:1px solid var(--border);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;">Sample</button>
          <button id="btnRandomMode" onclick="randomizeSampleData()" style="flex:1;height:100%;padding:0 4px;background:transparent;border:none;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;font-family:inherit;">Random</button>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:6px;line-height:1.4;">Sample = fixed demo dataset &bull; Random = generated dataset</div>
      </div>

      <!-- UPLOAD YOUR DATA -->
      <div class="sb-acc-group">
        <button class="sb-acc-header" onclick="sidebarAccordion(this)">
          <span>üìÇ Upload Your Data</span>
          <span class="sb-acc-chevron">‚ñº</span>
        </button>
        <div class="sb-acc-body">
          <div style="font-size:11px;color:var(--muted);line-height:1.5;margin-bottom:10px;">
            Upload a single flat CSV ‚Äî one row per channel/month record. The module auto-populates all 4 sections.
          </div>
          <!-- Drop zone -->
          <div id="csvDropZone"
            style="border:2px dashed var(--border);border-radius:10px;padding:14px 10px;text-align:center;cursor:pointer;transition:border-color 150ms,background 150ms;background:#fafbfc;"
            onclick="document.getElementById('flatCsvUpload').click()"
            ondragover="event.preventDefault();this.style.borderColor='var(--accent)';this.style.background='rgba(15,118,110,0.05)';"
            ondragleave="this.style.borderColor='var(--border)';this.style.background='#fafbfc';"
            ondrop="handleFlatCsvDrop(event)">
            <div style="font-size:20px;margin-bottom:4px;">üìÑ</div>
            <div style="font-size:12px;font-weight:600;color:var(--text);">Drop CSV here or click to browse</div>
            <div style="font-size:10px;color:var(--muted);margin-top:3px;">Flat CSV ‚Äî all sections in one file</div>
            <input type="file" id="flatCsvUpload" accept=".csv" style="display:none;" onchange="handleFlatCsvUpload(event)">
          </div>
          <!-- Upload status -->
          <div id="csvUploadStatus" style="display:none;margin-top:8px;padding:8px 10px;border-radius:8px;font-size:11px;line-height:1.5;"></div>
          <!-- Download template button -->
          <button onclick="downloadFlatTemplate()" class="sb-acc-btn" style="margin-top:8px;">‚¨á Download CSV Template</button>
          <!-- Column guide -->
          <div style="margin-top:10px;padding:8px 10px;background:rgba(12,23,45,0.03);border-radius:8px;font-size:10px;color:var(--muted);line-height:1.6;">
            <strong style="color:var(--text);display:block;margin-bottom:4px;">Required columns:</strong>
            month, channel, revenue, cogs, gp_pct, opex, contribution<br>
            baseline_revenue, promo_revenue, baseline_gp, promo_gp, promo_cost<br>
            prior_revenue, current_revenue, price_effect, volume_effect, mix_effect<br>
            discount_pool, start_month, end_month
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="sb-acc-group">
        <button class="sb-acc-header" onclick="sidebarAccordion(this)">
          <span>Actions</span>
          <span class="sb-acc-chevron">‚ñº</span>
        </button>
        <div class="sb-acc-body">
          <button onclick="exportCurrentDataset()" class="sb-acc-btn primary">‚¨á Export current dataset</button>
          <button onclick="loadWorstCase()" class="sb-acc-btn" style="background:#fef2f2;border-color:rgba(220,38,38,0.35);color:#dc2626;margin-top:4px;">üî¥ Worst Case Demo</button>
        </div>
      </div>

    </aside>

      <!-- Main Content -->
      <div class="main-content">

        <!-- Promotion ROI Analysis -->
        <section class="module-section" id="section-promo">

          <!-- DECISION BOX: pinned at very top of Promo ROI section -->
          <div class="decision-box" id="promoDecisionBox" aria-label="Commercial Sales Decision">
            <div class="decision-box-eyebrow">Decision</div>
            <div id="promoDecisionSubtitle" style="font-size:13px;color:var(--muted);margin-bottom:10px;line-height:1.5;display:none;"></div>
            <div class="decision-box-fallback" id="promoDecisionFallback">Load sample or upload data to see the decision.</div>
            <div id="promoDecisionContent" style="display:none;">
              <div class="decision-box-summary" id="promoDecisionSummary"></div>
              <div class="decision-box-verdict" id="promoDecisionVerdict"></div>
              <div class="decision-box-exceptions" id="promoDecisionExceptions"></div>
            </div>
          </div>

          <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
            1. Promotion ROI Analysis
            <span class="help-icon" data-help="Shows whether a promotion actually made money ‚Äî after accounting for margin, discounts, and campaign costs. The goal is a clear repeat / resize / stop decision for the next planning cycle, not just a post-event report."></span>
          </h2>
          <p style="font-size:13px;color:var(--muted);margin:-8px 0 16px;line-height:1.5;">Use this to drive the <strong style="color:var(--text);">next-cycle decision</strong>: if the promo is profitable and margin holds, scale it. If net profit is positive but GP% is compressing, trim the discount depth before repeating. If net profit is negative, restructure the deal or pause it ‚Äî volume uplift alone is not a success if margin is destroyed in the process.</p>

          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">Before / After Comparison</h3>
              <div class="card-actions">
                <button onclick="downloadPromoCSV()" class="btn-small">Export Results</button>
                <button onclick="downloadPromoTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="promoUpload" accept=".csv" onchange="handlePromoUpload(event)">
                </div>
              </div>
            </div>

            <div class="input-grid">
              <div class="input-field">
                <label>Baseline Revenue <span class="help-icon" data-help="How much money you made before the promotion ran. This is your normal, business-as-usual sales number ‚Äî the starting point to measure uplift against."></span></label>
                <input type="number" id="baselineRev" value="50000" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Promo Revenue <span class="help-icon" data-help="How much money you made during the promotion period. Compare this to Baseline Revenue to see if the promo actually drove more sales."></span></label>
                <input type="number" id="promoRev" value="85000" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Baseline GP% <span class="help-icon" data-help="Healthy: GP% above 35% ‚Äî the promo is adding margin without eroding the base. High Risk: GP% drops below 20% during promo ‚Äî discounts are wiping out profit faster than volume can recover it."></span></label>
                <input type="number" step="0.1" id="baselineGP" value="42" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Promo GP% <span class="help-icon" data-help="Healthy: Promo GP% stays within 5pp of Baseline GP% ‚Äî margin holds even with discounts. High Risk: Promo GP% falls more than 10pp vs baseline ‚Äî the promotion is destroying margin. High Risk threshold also triggered if Promo GP% drops below 20% absolute."></span></label>
                <input type="number" step="0.1" id="promoGP" value="28" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Promo Cost <span class="help-icon" data-help="What you spent to run the promotion ‚Äî ads, coupons, retailer fees, display materials, etc. This is the investment you need to earn back through incremental profit."></span></label>
                <input type="number" id="promoCost" value="12000" onchange="withStableScroll(computePromoROI)">
              </div>
            </div>

            <div class="kpi-grid" id="promoKPIs">
              <!-- KPIs populated by JS -->
            </div>

            <div style="overflow-x:auto;"><table class="data-table" id="promoTable">
              <!-- Table populated by JS -->
            </table></div>

            <!-- ‚îÄ‚îÄ Promo ROI WSWN Explainer ‚îÄ‚îÄ -->
            <div class="wswn-wrap" id="promoWswn" style="display:none;">
              <div class="wswn-wrap-header">
                üí° Promo ROI Insight
                <span class="help-icon" data-help="Thresholds ‚Äî Healthy: Net Profit &gt; 0 and GP% drop &lt; 5pp. At Risk: Net Profit &gt; 0 but GP% dropped 5‚Äì10pp. High Risk: Net Profit &lt; 0, OR GP% dropped more than 10pp."></span>
              </div>
              <div class="wswn">
                <div class="wswn-row">
                  <span class="wswn-label lbl-what" data-help="What: The raw factual output ‚Äî revenue uplift, GP% movement, net profit, and ROI. No interpretation yet.">What</span>
                  <span class="wswn-content" id="promoWswnWhat">‚Äî</span>
                </div>
                <div class="wswn-row">
                  <span class="wswn-label lbl-sowhat" data-help="So What ‚Äî thresholds: ‚úÖ Healthy = Net Profit &gt; 0 AND GP% drop &lt; 5pp. ‚ö†Ô∏è Caution = Net Profit &gt; 0 BUT GP% dropped 5‚Äì10pp. üî¥ High Risk = Net Profit ‚â§ 0 OR GP% dropped &gt; 10pp.">So What</span>
                  <span class="wswn-content scrollable" id="promoWswnSoWhat">‚Äî</span>
                </div>
                <div class="wswn-row">
                  <span class="wswn-label lbl-nowwhat" data-help="Now What: The recommended action based on where this promo lands. Healthy ‚Üí scale it. Caution ‚Üí trim discount. High Risk ‚Üí restructure before re-running.">Now What</span>
                  <span class="wswn-content" id="promoWswnNowWhat">‚Äî</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Channel P&L -->
        <section class="module-section" id="section-channel">
          <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
            2. Channel-level P&amp;L
            <span class="help-icon" data-help="Breaks down revenue and profit by sales channel (e.g. retail, online, direct, enterprise). The key question: which channels are profitable after all costs ‚Äî not just which ones sell the most? Use contribution margin to rank channels and redirect budget toward the healthiest routes."></span>
          </h2>
          <p style="font-size:13px;color:var(--muted);margin:-8px 0 16px;line-height:1.5;">Compare channels by contribution margin to identify where to <strong style="color:var(--text);">reallocate budget</strong>. Channels with high GP% and positive contribution are where investment should concentrate. High-revenue channels with negative contribution are consuming budget without returning profit ‚Äî they require pricing, cost, or exit decisions before the next planning cycle.</p>
          
          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">12-Month Channel Performance</h3>
              <div class="card-actions">
                <label>Month:</label>
                <select id="channelMonthFilter" onchange="withStableScroll(renderChannelPL)">
                  <option value="all">All Months</option>
                </select>
                <label>Channel:</label>
                <select id="channelFilter" onchange="withStableScroll(renderChannelPL)">
                  <option value="all">All Channels</option>
                </select>
                <button onclick="downloadChannelCSV()" class="btn-small">Export Data</button>
                <button onclick="downloadChannelTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="channelUpload" accept=".csv" onchange="handleChannelUpload(event)">
                </div>
              </div>
            </div>

            <div class="chart-container">
              <div class="chart-title">Revenue by Channel</div>
              <canvas id="channelChart" class="chart-canvas"></canvas>
            </div>

            <!-- What ‚Ä¢ So What ‚Ä¢ Now What ‚Äî Channel insight -->
            <div class="wswn-wrap" id="channelWswnWrap" style="display:none;">
              <div class="wswn-wrap-header">
                üí° Channel Performance Insight
                <span class="help-icon" data-help="Thresholds ‚Äî Healthy: GP% above 40%, contribution margin positive for all channels. At Risk: GP% 30‚Äì40%, any channel contribution negative. High Risk: GP% below 30%, or a single channel drives more than 70% of revenue (concentration risk)."></span>
              </div>
              <div class="wswn">
                <div class="wswn-row">
                  <span class="wswn-label lbl-what" data-help="What: Channel-level breakdown ‚Äî revenue, blended GP%, top channel share, and count of contribution-positive vs. negative channels.">What</span>
                  <span class="wswn-content" id="channelWswnWhat">‚Äî</span>
                </div>
                <div class="wswn-row">
                  <span class="wswn-label lbl-sowhat" data-help="So What ‚Äî thresholds: ‚úÖ Healthy = all channels contribution-positive AND no single channel &gt; 70% of revenue. ‚ö†Ô∏è Moderate = all positive BUT one channel &gt; 70% (concentration risk). üî¥ High Risk = any channel contribution-negative (costs exceed revenue for that channel).">So What</span>
                  <span class="wswn-content scrollable" id="channelWswnSoWhat">‚Äî</span>
                </div>
                <div class="wswn-row">
                  <span class="wswn-label lbl-nowwhat" data-help="Now What: Healthy ‚Üí maintain mix discipline and recheck monthly. Moderate ‚Üí build out secondary channels. High Risk ‚Üí investigate negative channels: raise price, cut OpEx, or exit.">Now What</span>
                  <span class="wswn-content" id="channelWswnNowWhat">‚Äî</span>
                </div>
              </div>
            </div>

            <div id="channelTableScroll"><table class="data-table" id="channelTable">
              <colgroup><col><col><col><col><col><col><col></colgroup>
              <!-- Table populated by JS -->
            </table></div>
          </div>
        </section>

        <!-- Price/Volume/Mix Bridge -->
        <section class="module-section" id="section-pvm">
          <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
            3. Price / Volume / Mix Bridge
            <span class="help-icon" data-help="I use this to separate real growth from commercial noise. Revenue going up doesn't mean the business is healthier ‚Äî it could be driven by temporary volume, a one-time price increase, or a shift toward lower-margin products. PVM breaks it into the three root causes so leadership knows what's actually driving the number and what to protect."></span>
          </h2>
          <p style="font-size:13px;color:var(--muted);margin:-8px 0 16px;line-height:1.5;"><strong style="color:var(--text);">Plain English:</strong> &nbsp;<span class="help-icon" data-help="Price / Volume / Mix (PVM) is a standard finance technique for explaining revenue changes. Price effect = did you charge more? Volume effect = did you sell more? Mix effect = did you sell a different blend of high- vs. low-value products? Together they explain 100% of the revenue variance."></span>&nbsp;Revenue changes are rarely one-dimensional. PVM breaks total variance into its three structural causes ‚Äî so leadership knows whether growth is driven by real pricing power, genuine volume gains, or a temporary portfolio shift. The answer determines whether to hold the strategy or act.</p>
          
          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">Revenue Variance Decomposition <span class="help-icon" data-help="'Variance' just means 'the difference.' This card decomposes (breaks apart) the revenue difference between two periods into exactly what caused it ‚Äî price changes, volume changes, or product mix changes ‚Äî so leadership knows where to act."></span></h3>
              <div class="card-actions">
                <button onclick="downloadPVMCSV()" class="btn-small">Export Analysis</button>
                <button onclick="downloadPVMTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="pvmUpload" accept=".csv" onchange="handlePVMUpload(event)">
                </div>
              </div>
            </div>

            <div class="input-grid">
              <div class="input-field">
                <label>Prior Period Revenue <span class="help-icon" data-help="Your total revenue in the previous period (e.g. last quarter or last year). This is the starting point ‚Äî the number you're measuring the change from."></span></label>
                <input type="number" id="priorRev" value="120000" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Current Period Revenue <span class="help-icon" data-help="Your total revenue in the current period. The gap between this and Prior Period Revenue is what we're breaking down into its three root causes: price, volume, and mix."></span></label>
                <input type="number" id="currentRev" value="138000" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Price Effect (%) <span class="help-icon" data-help="How much of the revenue change came from charging more (or less) per unit. Positive = you raised prices. Negative = you cut prices. Helps isolate pricing decisions from sales volume."></span></label>
                <input type="number" step="0.1" id="priceEffect" value="5.2" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Volume Effect (%) <span class="help-icon" data-help="How much of the revenue change came from selling more (or fewer) units. Positive = you sold more. This is usually the clearest signal of whether demand is growing or shrinking."></span></label>
                <input type="number" step="0.1" id="volumeEffect" value="8.5" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Mix Effect (%) <span class="help-icon" data-help="How much of the revenue change came from selling a different blend of products ‚Äî more premium vs. entry-level SKUs. Positive mix = shifted toward higher-priced items. Negative = shifted toward cheaper ones."></span></label>
                <input type="number" step="0.1" id="mixEffect" value="1.3" onchange="computePVM()">
              </div>
            </div>

            <div class="kpi-grid" id="pvmKPIs">
              <!-- KPIs populated by JS -->
            </div>

            <div class="chart-container">
              <div class="chart-title">Waterfall Bridge</div>
              <canvas id="pvmChart" class="chart-canvas"></canvas>
            </div>

            <!-- ‚îÄ‚îÄ PVM Explainer Box ‚îÄ‚îÄ -->
            <div id="pvmExplainer" style="display:none;margin-top:20px;padding-top:20px;border-top:1px solid var(--border);">

              <!-- Live callout strip -->
              <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:14px;margin-bottom:18px;padding:14px 18px;border-radius:12px;background:rgba(15,118,110,0.05);border:1.5px solid rgba(15,118,110,0.16);">
                <div>
                  <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:var(--muted);margin-bottom:4px;">Total Revenue Variance</div>
                  <div style="display:flex;align-items:baseline;gap:10px;">
                    <span id="pvmTotalValue" style="font-size:34px;font-weight:800;letter-spacing:-0.03em;color:var(--text);">‚Äî</span>
                    <span id="pvmTotalPct" style="font-size:14px;font-weight:700;color:var(--muted);"></span>
                    <span id="pvmTotalBadge" style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:999px;"></span>
                  </div>
                </div>
                <div style="display:flex;gap:16px;flex-wrap:wrap;padding-top:4px;">
                  <div style="text-align:center;">
                    <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);margin-bottom:4px;">üí∞ Price</div>
                    <div id="pvmPricePill" style="font-size:12px;font-weight:700;padding:4px 11px;border-radius:999px;"></div>
                  </div>
                  <div style="text-align:center;">
                    <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);margin-bottom:4px;">üì¶ Volume</div>
                    <div id="pvmVolumePill" style="font-size:12px;font-weight:700;padding:4px 11px;border-radius:999px;"></div>
                  </div>
                  <div style="text-align:center;">
                    <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);margin-bottom:4px;">üîÄ Mix</div>
                    <div id="pvmMixPill" style="font-size:12px;font-weight:700;padding:4px 11px;border-radius:999px;"></div>
                  </div>
                </div>
              </div>

              <!-- Section label -->
              <div class="wswn-wrap" id="pvmWswn" style="margin-top:0;border-radius:0 0 14px 14px;border-top:1.5px solid rgba(15,118,110,0.25)!important;">
                <div class="wswn-wrap-header">
                  üí° PVM Insight
                  <span class="help-icon" data-help="Thresholds ‚Äî Healthy: all three drivers positive (broad-based growth). At Risk: growth but one driver is negative (headwind). High Risk: overall revenue decline, or Volume and Mix both negative (demand and portfolio deteriorating together)."></span>
                </div>
                <div class="wswn">
                  <div class="wswn-row">
                    <span class="wswn-label lbl-what" data-help="What: The factual variance split ‚Äî total revenue change vs. prior period, and how much of that came from Price, Volume, and Mix respectively.">What</span>
                    <span class="wswn-content" id="pvmWswnWhat">‚Äî</span>
                  </div>
                  <div class="wswn-row">
                    <span class="wswn-label lbl-sowhat" data-help="So What ‚Äî thresholds: ‚úÖ Healthy = all 3 drivers positive (broad-based growth). ‚ö†Ô∏è Moderate = growing overall but 1 driver is a headwind (masked drag). üî¥ High Risk = revenue declining AND 2+ drivers negative, or all 3 negative (broad deterioration needing full commercial review).">So What</span>
                    <span class="wswn-content scrollable" id="pvmWswnSoWhat">‚Äî</span>
                  </div>
                  <div class="wswn-row">
                    <span class="wswn-label lbl-nowwhat" data-help="Now What: Fix the biggest headwind driver. Price negative ‚Üí review discounts. Volume negative ‚Üí check demand or supply. Mix negative ‚Üí shift portfolio toward higher-revenue SKUs. All positive ‚Üí protect the top driver.">Now What</span>
                    <span class="wswn-content" id="pvmWswnNowWhat">‚Äî</span>
                  </div>
                </div>
              </div>
            </div>
            <!-- ‚îÄ‚îÄ end PVM Explainer ‚îÄ‚îÄ -->
          </div>
        </section>

        <!-- Discount & Accrual Schedule -->
        <section class="module-section" id="section-accrual">
          <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
            4. Trade Discount &amp; Accrual Schedule
            <span class="help-icon" data-help="Trade discount accruals spread the cost of a deal evenly across its months ‚Äî so the P&L reflects steady monthly charges rather than one large hit when the deal settles. This makes your monthly margin numbers trustworthy and avoids quarter-end surprises."></span>
          </h2>
          <p style="font-size:13px;color:var(--muted);margin:-8px 0 16px;line-height:1.5;">Post monthly journal entries as the schedule runs. At deal settlement, reconcile the actual invoice against the cumulative accrual ‚Äî any gap is an adjustment that should be documented in close commentary. A clean, straight-line accrual schedule reduces audit exposure and keeps period P&amp;L free of quarter-end settlement spikes.</p>
          
          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">Straight-line Accrual Logic <span class="help-icon" data-help="'Straight-line' means the cost is divided equally across every month of the deal ‚Äî no lumpy spikes. 'Accrual' means recognizing the cost as it's earned/incurred, not when cash actually moves. This prevents your December P&L from getting hit with the full year's discount bill at once."></span></h3>
              <div class="card-actions">
                <button onclick="downloadAccrualCSV()" class="btn-small">Export Schedule</button>
                <button onclick="downloadAccrualTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="accrualUpload" accept=".csv" onchange="handleAccrualUpload(event)">
                </div>
              </div>
            </div>

            <div class="input-grid">
              <div class="input-field">
                <label>Total Discount Pool ($) <span class="help-icon" data-help="The total amount of discounts or trade spend committed for the deal or campaign. Instead of booking this all in one month, it gets spread evenly ‚Äî keeping your monthly P&L clean and predictable."></span></label>
                <input type="number" id="discountPool" value="48000" onchange="computeAccrual()">
              </div>
              <div class="input-field">
                <label>Start Month <span class="help-icon" data-help="The first month the discount or trade deal kicks in. Accruals begin here, so your books show the cost building up from day one rather than all hitting at settlement."></span></label>
                <input type="number" id="startMonth" value="1" min="1" max="12" onchange="computeAccrual()">
              </div>
              <div class="input-field">
                <label>End Month <span class="help-icon" data-help="The last month of the deal. The total discount pool is divided equally across all months between Start and End ‚Äî so each period absorbs its fair share of the cost."></span></label>
                <input type="number" id="endMonth" value="12" min="1" max="12" onchange="computeAccrual()">
              </div>
            </div>

            <div id="accrualTableScroll"><table class="data-table" id="accrualTable">
              <colgroup><col><col><col><col><col></colgroup>
              <!-- Table populated by JS -->
            </table></div>

            <!-- ‚îÄ‚îÄ Accrual WSWN Explainer ‚îÄ‚îÄ -->
            <div class="wswn-wrap" id="accrualWswn" style="display:none;margin-top:16px;">
              <div class="wswn-wrap-header">
                üí° Accrual Schedule Insight
                <span class="help-icon" data-help="Thresholds ‚Äî Healthy: discount pool spread over 6+ months, monthly accrual below 5% of expected monthly revenue. At Risk: deal compressed into fewer than 4 months, accrual spikes month-end. High Risk: entire pool hits in 1‚Äì2 months ‚Äî P&amp;L will show distorted loss that month, creating audit and forecasting risk."></span>
              </div>
              <div class="wswn">
                <div class="wswn-row">
                  <span class="wswn-label lbl-what" data-help="What: The total discount pool, the accrual spread period, monthly charge, and how many months have zero accrual.">What</span>
                  <span class="wswn-content" id="accrualWswnWhat">‚Äî</span>
                </div>
                <div class="wswn-row">
                  <span class="wswn-label lbl-sowhat" data-help="So What ‚Äî thresholds: ‚úÖ Healthy = pool spread over 6+ months (manageable monthly charge). ‚ö†Ô∏è Moderate = 3‚Äì5 months (elevated but workable ‚Äî flag for FP&A). üî¥ High Risk = 1‚Äì2 months (entire pool hits in one period, distorting P&L and creating audit risk).">So What</span>
                  <span class="wswn-content scrollable" id="accrualWswnSoWhat">‚Äî</span>
                </div>
                <div class="wswn-row">
                  <span class="wswn-label lbl-nowwhat" data-help="Now What: Healthy ‚Üí post monthly journal entries and reconcile at settlement. Moderate ‚Üí add P&L footnote per accrual month. High Risk ‚Üí renegotiate deal spread or document the spike clearly for audit and board pack.">Now What</span>
                  <span class="wswn-content" id="accrualWswnNowWhat">‚Äî</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- What This Demonstrates -->
        <section class="demo-section">
          <h2 class="module-section-title">What This Demonstrates</h2>
          <div class="demo-grid">
            <div class="demo-card">
              <div class="demo-card-title">Decision Systems, Not Just Retrospectives</div>
              <div class="demo-card-text">
                Every analysis produces a clear, actionable output ‚Äî repeat, resize, or stop a promo; invest, maintain, or exit a channel. Finance is connected directly to commercial decisions, not just reporting what already happened.
              </div>
            </div>
            <div class="demo-card">
              <div class="demo-card-title">Separating Signal from Commercial Noise</div>
              <div class="demo-card-text">
                Price / Volume / Mix decomposition prevents leadership from reacting to revenue variance driven by mix shifts or timing rather than genuine commercial performance. The right analysis prevents the wrong actions.
              </div>
            </div>
            <div class="demo-card">
              <div class="demo-card-title">Resource Allocation by Contribution, Not Revenue</div>
              <div class="demo-card-text">
                Channel P&amp;L contribution margins direct budget where it actually earns a return ‚Äî not based on top-line revenue rank, but on which routes to market are profitable after all channel-specific costs.
              </div>
            </div>
            <div class="demo-card">
              <div class="demo-card-title">Finance Outputs Marketing Can Act On</div>
              <div class="demo-card-text">
                Plain-English framing, clear decision outputs, and visual consistency mean commercial and marketing leaders can work directly from this ‚Äî without a Finance translation layer between analysis and decision.
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>

  
  <!-- ‚îÄ‚îÄ Next Module ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <nav class="next-module-bar" aria-label="Next recommended module">
    <div>
      <div class="next-module-label">Next recommended</div>
      <div class="next-module-title">Revenue Bridge &amp; Cohort Retention</div>
      <div class="next-module-why">Channel P&L is clear ‚Äî now verify whether that revenue base is actually being retained and compounding over time.</div>
    </div>
    <div class="next-module-actions">
      <a class="btn btn-solid" href="revenue-bridge.html">Open Revenue Bridge ‚Üí</a>
      <a class="btn btn-ghost" href="index.html">‚Üê Back to Portfolio</a>
    </div>
  </nav>

</main>

  <a href="#" class="to-top" aria-label="Back to top">‚Üë</a>

  <script>
    /* ‚îÄ‚îÄ withStableScroll: run fn without the page jumping ‚îÄ‚îÄ */
    function withStableScroll(fn) {
      var scrollY = window.scrollY;
      if (typeof fn === 'function') fn();
      else if (typeof fn === 'string') window[fn] && window[fn]();
      // Restore scroll position after a tick
      requestAnimationFrame(function() {
        window.scrollTo(0, scrollY);
      });
    }
    /* ‚îÄ‚îÄ fmt: accounting-style currency formatter ‚îÄ‚îÄ */
    function fmt(val) {
      var v = Math.round(val);
      if (v < 0) return '($' + Math.abs(v).toLocaleString() + ')';
      return '$' + v.toLocaleString();
    }
  </script>
  <script>
    /* =========================================
       Commercial / Sales Finance - JavaScript
       ========================================= */

    // ========== GLOBAL STATE ==========
    
    let dataMode = 'sample';
    
    let promoData = {};
    let channelData = [];
    let pvmData = {};
    let accrualSchedule = [];
    
    // ========== UTILITY FUNCTIONS ==========
    
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function randFloat(min, max) {
      return Math.random() * (max - min) + min;
    }
    
    function formatCurrency(val) {
      const rounded = Math.round(val);
      if (rounded < 0) return '($' + Math.abs(rounded).toLocaleString() + ')';
      return '$' + rounded.toLocaleString();
    }
    
    function formatPercent(val) {
      if (val < 0) return '(' + Math.abs(val).toFixed(1) + '%)';
      return val.toFixed(1) + '%';
    }

    // For KPI boxes ‚Äî returns HTML with red/green color based on sign
    function formatCurrencyColored(val, positiveIsGood = true) {
      const rounded = Math.round(val);
      const isGood = positiveIsGood ? rounded >= 0 : rounded <= 0;
      const isNeutral = rounded === 0;
      const color = isNeutral ? 'var(--text)' : (isGood ? '#0f766e' : '#dc2626');
      const text = rounded < 0 ? '($' + Math.abs(rounded).toLocaleString() + ')' : '$' + rounded.toLocaleString();
      return `<span style="color:${color}">${text}</span>`;
    }
    function formatPercentColored(val, positiveIsGood = true) {
      const isGood = positiveIsGood ? val >= 0 : val <= 0;
      const isNeutral = Math.abs(val) < 0.01;
      const color = isNeutral ? 'var(--text)' : (isGood ? '#0f766e' : '#dc2626');
      const text = val < 0 ? '(' + Math.abs(val).toFixed(1) + '%)' : val.toFixed(1) + '%';
      return `<span style="color:${color}">${text}</span>`;
    }

    // Wraps numbers and percentages in WSWN text with <strong>
    function wrapNumbers(text) {
      // Match: $1,234 / $1,234,567 / +$... / ($...) / 12.3% / +12.3% / 12.3pp / -12pp etc.
      return text.replace(/(\(?\$[\d,]+\)?|\+?\$[\d,]+|-?\$[\d,]+|\(?\d+\.?\d*pp\)?|\+?\d+\.?\d*pp|-?\d+\.?\d*pp|\(?\d+\.?\d*%\)?|\+?\d+\.?\d*%|-?\d+\.?\d*%|\d+\.?\d*x)/g, '<strong>$1</strong>');
    }
    
    // ========== CSV PARSING ==========
    
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = values[idx] || '';
        });
        data.push(row);
      }
      return { headers, data };
    }
    
    function validateHeaders(actual, required) {
      return required.every(h => actual.includes(h));
    }
    
    function downloadCSV(filename, headers, rows) {
      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += headers.map(h => row[h] !== undefined ? row[h] : '').join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    }
    
    // ========== SAMPLE DATA GENERATION ==========

    function _setSampleBtnState() {
      var s = document.getElementById('btnSampleMode');
      var r = document.getElementById('btnRandomMode');
      if (s) { s.style.background = 'var(--text)'; s.style.color = 'white'; }
      if (r) { r.style.background = 'transparent'; r.style.color = 'var(--muted)'; }
      // Reset any inline styles left by loadWorstCase (red badge override)
      var badge = document.getElementById('dataModeBadge');
      if (badge) {
        badge.style.background  = '';
        badge.style.borderColor = '';
        badge.style.color       = '';
        badge.classList.remove('random');
        badge.textContent = 'SAMPLE';
      }
    }
    function useSampleData() {
      withStableScroll(function() {
        dataMode = 'sample';
        document.getElementById('dataModeBadge').textContent = 'SAMPLE'; document.getElementById('dataModeBadge').classList.remove('random');
        _setSampleBtnState();
        initializeSampleData();
        renderAll();
      });
    }

    // ‚îÄ‚îÄ PRESET: Promo that clearly LOSES money ‚îÄ‚îÄ
    // The margin hit (-14pp) + high cost ($14k) means net profit is deeply negative.
    function loadLosingPromo() {
      withStableScroll(function() {
        dataMode = 'sample';
        document.getElementById('dataModeBadge').textContent = 'SAMPLE'; document.getElementById('dataModeBadge').classList.remove('random');
        _setSampleBtnState();
        document.getElementById('baselineRev').value  = 50000;
        document.getElementById('promoRev').value     = 85000;
        document.getElementById('baselineGP').value   = 42;
        document.getElementById('promoGP').value      = 22;   // -20pp ‚Äî wipes the GP lift
        document.getElementById('promoCost').value    = 14000; // heavy spend on top
        _setDefaultPVM();
        _buildChannelData();
        populateChannelFilters();
        renderAll();
      });
    }

    // ‚îÄ‚îÄ PRESET: Promo that clearly MAKES money ‚îÄ‚îÄ
    // GP% holds (even improves slightly), promo cost is lean, volume doubles ‚Üí strong net profit.
    function loadWinningPromo() {
      withStableScroll(function() {
        dataMode = 'sample';
        document.getElementById('dataModeBadge').textContent = 'SAMPLE'; document.getElementById('dataModeBadge').classList.remove('random');
        _setSampleBtnState();
        document.getElementById('baselineRev').value  = 50000;
        document.getElementById('promoRev').value     = 105000; // ~2√ó uplift
        document.getElementById('baselineGP').value   = 40;
        document.getElementById('promoGP').value      = 42;    // +2pp ‚Äî margin holds and improves
        document.getElementById('promoCost').value    = 4500;  // lean spend ‚Üí strong net profit
        // PVM: all three drivers are positive tailwinds
        document.getElementById('priorRev').value     = 120000;
        document.getElementById('currentRev').value   = 168000;
        document.getElementById('priceEffect').value  = 7.5;
        document.getElementById('volumeEffect').value = 18.2;
        document.getElementById('mixEffect').value    = 4.3;
        document.getElementById('discountPool').value = 48000;
        document.getElementById('startMonth').value   = 1;
        document.getElementById('endMonth').value     = 12;
        _buildChannelData();
        populateChannelFilters();
        renderAll();
      });
    }

    function _setDefaultPVM() {
      document.getElementById('priorRev').value     = 120000;
      document.getElementById('currentRev').value   = 138000;
      document.getElementById('priceEffect').value  = 5.2;
      document.getElementById('volumeEffect').value = 8.5;
      document.getElementById('mixEffect').value    = 1.3;
      document.getElementById('discountPool').value = 48000;
      document.getElementById('startMonth').value   = 1;
      document.getElementById('endMonth').value     = 12;
    }

    // Fixed sample channel data ‚Äî never changes on refresh (deterministic)
    const FIXED_CHANNEL_DATA = (function() {
      // Pre-seeded values: [revenue, cogsPct, opex] per month√óchannel
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const channels = ['Direct','Online','Retail','Partner','Enterprise'];
      // One fixed row of seeds per slot (60 rows = 12 months √ó 5 channels)
      const seeds = [
        [18200,0.42,3800],[14500,0.38,4200],[21000,0.45,5100],[11300,0.51,2800],[9800,0.47,3100],
        [16700,0.40,3600],[19500,0.44,4800],[13200,0.36,3900],[22100,0.46,5400],[10500,0.50,2600],[12400,0.43,3300],[8900,0.48,2400],
        [17300,0.41,3700],[15100,0.39,4100],[20400,0.44,5000],[12800,0.52,2900],[10200,0.46,3200],
        [18600,0.42,3500],[21300,0.45,4700],[14700,0.37,4000],[23500,0.47,5500],[11000,0.49,2700],[13100,0.44,3400],[9400,0.47,2500],
        [16900,0.40,3600],[15800,0.38,4300],[19700,0.44,4900],[13500,0.51,3000],[11600,0.48,3300],
        [20100,0.43,3800],[22000,0.46,4600],[15400,0.37,4100],[24200,0.47,5300],[10700,0.50,2600],[12700,0.43,3200],[9100,0.46,2300],
        [17600,0.41,3700],[16300,0.39,4200],[21100,0.45,5100],[14100,0.52,2900],[12000,0.47,3400],
        [19300,0.42,3900],[22800,0.46,4700],[16000,0.38,4000],[24900,0.48,5600],[11200,0.51,2800],[13400,0.44,3500],[9700,0.48,2600],
        [18100,0.41,3600],[16800,0.40,4300],[20800,0.44,5000],[13900,0.51,2900],[12300,0.47,3300],
        [20500,0.43,3800],[23200,0.46,4800],[16500,0.37,4100],[25300,0.47,5400],[11500,0.50,2700],[13800,0.44,3400],[10000,0.47,2500]
      ];
      const rows = [];
      let idx = 0;
      months.forEach(month => {
        channels.forEach(channel => {
          const [rev, cogsPct, opex] = seeds[idx % seeds.length];
          idx++;
          const cogs = rev * cogsPct;
          rows.push({
            month, channel,
            revenue: rev.toFixed(2),
            cogs: cogs.toFixed(2),
            opex: opex.toFixed(2),
            gp: ((rev - cogs) / rev * 100).toFixed(1),
            contribution: (rev - cogs - opex).toFixed(2)
          });
        });
      });
      return rows;
    })();

    function _buildChannelData() {
      // In sample mode: always use the fixed deterministic dataset (no random)
      if (dataMode === 'sample') {
        channelData = FIXED_CHANNEL_DATA.map(r => Object.assign({}, r));
      } else {
        // Random mode: generate fresh random data
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const channels = ['Direct','Online','Retail','Partner','Enterprise'];
        channelData = [];
        months.forEach(month => {
          channels.forEach(channel => {
            const revenue = randInt(8000, 25000);
            const cogs = revenue * randFloat(0.35, 0.55);
            const opex = randInt(2000, 6000);
            channelData.push({
              month, channel,
              revenue: revenue.toFixed(2),
              cogs: cogs.toFixed(2),
              opex: opex.toFixed(2),
              gp: ((revenue - cogs) / revenue * 100).toFixed(1),
              contribution: (revenue - cogs - opex).toFixed(2)
            });
          });
        });
      }
    }
    
    function initializeSampleData() {
      dataMode = 'sample'; // ensure sample mode before building channel data
      // Default promo = losing scenario (same numbers as original sample)
      promoData = { baseline_revenue: 50000, promo_revenue: 85000, baseline_gp: 42, promo_gp: 28, promo_cost: 12000 };
      document.getElementById('baselineRev').value = promoData.baseline_revenue;
      document.getElementById('promoRev').value    = promoData.promo_revenue;
      document.getElementById('baselineGP').value  = promoData.baseline_gp;
      document.getElementById('promoGP').value     = promoData.promo_gp;
      document.getElementById('promoCost').value   = promoData.promo_cost;
      _buildChannelData();
      _setDefaultPVM();
    }
    
    function randomizeSampleData() {
      withStableScroll(function() {
        dataMode = 'random';
        document.getElementById('dataModeBadge').textContent = 'RANDOM';
        document.getElementById('dataModeBadge').classList.add('random');
        // Reset badge style (in case Worst Case was active)
        document.getElementById('dataModeBadge').style.background = '';
        document.getElementById('dataModeBadge').style.borderColor = '';
        document.getElementById('dataModeBadge').style.color = '';
        var s = document.getElementById('btnSampleMode');
        var r = document.getElementById('btnRandomMode');
        if (s) { s.style.background = 'transparent'; s.style.color = 'var(--muted)'; }
        if (r) { r.style.background = 'var(--text)'; r.style.color = 'white'; }

        // Pick a random scenario type for variety
        // 0=winning promo, 1=losing promo, 2=cautionary (profitable but squeezed margin)
        const scenarioRoll = Math.random();
        let baseRev, promoRev, baseGP, promoGP, promoCost;
        if (scenarioRoll < 0.40) {
          // WINNING: profitable, margin holds
          baseRev   = randInt(40000, 100000);
          promoRev  = Math.round(baseRev * randFloat(1.7, 2.5));
          baseGP    = randFloat(38, 55);
          promoGP   = baseGP - randFloat(0, 4);
          promoCost = randInt(2000, 8000);
        } else if (scenarioRoll < 0.65) {
          // CAUTION: profitable but margin 5‚Äì10pp squeezed
          baseRev   = randInt(40000, 90000);
          promoRev  = Math.round(baseRev * randFloat(1.4, 2.0));
          baseGP    = randFloat(38, 52);
          promoGP   = baseGP - randFloat(5.5, 9.5);  // just into caution zone
          promoCost = randInt(4000, 12000);
        } else {
          // LOSING: GP% craters, high spend
          baseRev   = randInt(30000, 80000);
          promoRev  = Math.round(baseRev * randFloat(1.2, 1.6));
          baseGP    = randFloat(35, 50);
          promoGP   = Math.max(8, baseGP - randFloat(12, 22));
          promoCost = randInt(10000, 22000);
        }

        document.getElementById('baselineRev').value = baseRev;
        document.getElementById('promoRev').value    = promoRev;
        document.getElementById('baselineGP').value  = baseGP.toFixed(1);
        document.getElementById('promoGP').value     = promoGP.toFixed(1);
        document.getElementById('promoCost').value   = promoCost;

        // Random channel data ‚Äî 30% chance some channels go negative (contribution < 0)
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const numChannels = randInt(3, 5);
        const channelNames = ['Direct','Online','Retail','Partner','Enterprise'].slice(0, numChannels);
        const negChannelCount = Math.random() < 0.35 ? randInt(1, Math.max(1, numChannels - 1)) : 0;
        // Decide which channels go negative
        const negChannelSet = new Set();
        while (negChannelSet.size < negChannelCount) {
          negChannelSet.add(channelNames[Math.floor(Math.random() * channelNames.length)]);
        }
        channelData = [];
        months.forEach(month => {
          channelNames.forEach(channel => {
            const isNeg = negChannelSet.has(channel);
            const revenue = randInt(isNeg ? 4000 : 5000, isNeg ? 14000 : 35000);
            // Negative channels: COGS eats 60‚Äì80% + heavy opex ‚Üí guaranteed negative contribution
            const cogsPct = isNeg ? randFloat(0.60, 0.80) : randFloat(0.30, 0.58);
            const cogs = revenue * cogsPct;
            const opex = isNeg ? randInt(5000, 9000) : randInt(1500, 8000);
            channelData.push({
              month, channel,
              revenue: revenue.toFixed(2),
              cogs: cogs.toFixed(2),
              opex: opex.toFixed(2),
              gp: ((revenue - cogs) / revenue * 100).toFixed(1),
              contribution: (revenue - cogs - opex).toFixed(2)
            });
          });
        });

        // Random PVM ‚Äî allow negative price or mix to show headwinds
        const priorRev = randInt(80000, 180000);
        const variance = randFloat(-0.10, 0.30);
        document.getElementById('priorRev').value     = priorRev;
        document.getElementById('currentRev').value   = Math.round(priorRev * (1 + variance));
        document.getElementById('priceEffect').value  = randFloat(-6, 10).toFixed(1);
        document.getElementById('volumeEffect').value = randFloat(-5, 18).toFixed(1);
        document.getElementById('mixEffect').value    = randFloat(-6, 8).toFixed(1);

        // Random accrual ‚Äî spread across all risk bands (low/moderate/high) equally
        document.getElementById('discountPool').value = randInt(20000, 80000);
        const accrualScenario = Math.random();
        if (accrualScenario < 0.33) {
          // HIGH RISK: 1‚Äì2 months
          document.getElementById('startMonth').value = randInt(4, 8);
          document.getElementById('endMonth').value   = document.getElementById('startMonth').value + randInt(0, 1);
        } else if (accrualScenario < 0.66) {
          // MODERATE: 3‚Äì5 months
          const s = randInt(2, 7);
          document.getElementById('startMonth').value = s;
          document.getElementById('endMonth').value   = s + randInt(2, 4);
        } else {
          // HEALTHY: 6‚Äì12 months
          document.getElementById('startMonth').value = randInt(1, 3);
          document.getElementById('endMonth').value   = randInt(9, 12);
        }

        populateChannelFilters();
        renderAll();
      });
    }
    
    // ========== WSWN RISK COLOR HELPER ==========
    // riskLevel: 'healthy' | 'moderate' | 'high'
    function applyWswnRisk(wrapEl, headerEl, riskLevel, headerText) {
      if (!wrapEl) return;
      wrapEl.classList.remove('wswn-wrap--healthy','wswn-wrap--moderate','wswn-wrap--high');
      wrapEl.classList.add('wswn-wrap--' + riskLevel);
      if (headerEl) {
        const icon = riskLevel === 'healthy' ? '‚úÖ' : riskLevel === 'moderate' ? '‚ö†Ô∏è' : 'üî¥';
        const label = riskLevel === 'healthy' ? 'Healthy ‚Äî On Track' : riskLevel === 'moderate' ? 'Moderate ‚Äî Monitor Closely' : 'High Risk ‚Äî Action Required';
        headerEl.innerHTML = `${icon} ${headerText} &nbsp;<span style="font-weight:600;font-size:10px;opacity:0.8;">${label}</span> `;
      }
    }
    function boldNowWhat(el, riskLevel) {
      if (!el) return;
      el.classList.add('wswn-nowwhat-bold');
      el.classList.remove('risk-red','risk-amber','risk-green');
      if (riskLevel === 'high') el.classList.add('risk-red');
      else if (riskLevel === 'moderate') el.classList.add('risk-amber');
      else el.classList.add('risk-green');
    }

    // ========== PROMO ROI FUNCTIONS ==========
    
    function computePromoROI() {
      const baselineRev = parseFloat(document.getElementById('baselineRev').value) || 0;
      const promoRev = parseFloat(document.getElementById('promoRev').value) || 0;
      const baselineGP = parseFloat(document.getElementById('baselineGP').value) || 0;
      const promoGP = parseFloat(document.getElementById('promoGP').value) || 0;
      const promoCost = parseFloat(document.getElementById('promoCost').value) || 0;
      
      const incrementalRev = promoRev - baselineRev;
      const baselineGPDollar = baselineRev * (baselineGP / 100);
      const promoGPDollar = promoRev * (promoGP / 100);
      const incrementalGP = promoGPDollar - baselineGPDollar;
      const netProfit = incrementalGP - promoCost;
      const roi = promoCost > 0 ? (netProfit / promoCost) * 100 : 0;
      const cmPct = promoRev > 0 ? ((promoGPDollar - promoCost) / promoRev) * 100 : 0;
      
      document.getElementById('promoKPIs').innerHTML = `
        <div class="kpi-box">
          <div class="kpi-box-label">Incremental Revenue <span class="help-icon" data-help="The extra revenue generated because of the promo ‚Äî simply Promo Revenue minus Baseline Revenue. This is how much more you sold than you would have without it."></span></div>
          <div class="kpi-box-value">${formatCurrencyColored(incrementalRev)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Incremental GP <span class="help-icon" data-help="The extra gross profit dollars from the promo, after accounting for lower margins during the deal. More revenue means nothing if the margin collapse wipes out the gain."></span></div>
          <div class="kpi-box-value">${formatCurrencyColored(incrementalGP)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Net Promo Profit <span class="help-icon" data-help="The true bottom-line result of the promo: Incremental GP minus what you spent to run it. Positive = the promo paid for itself. Negative = you spent more than you earned back."></span></div>
          <div class="kpi-box-value">${formatCurrencyColored(netProfit)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">ROI <span class="help-icon" data-help="Return on Investment ‚Äî for every $1 you spent on the promo, how many cents came back as profit. 100% ROI means you doubled your money. Negative ROI means the promo lost money."></span></div>
          <div class="kpi-box-value">${formatPercentColored(roi)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">CM% <span class="help-icon" data-help="Contribution Margin % ‚Äî what percentage of promo revenue is left after product costs AND promo spend. Tells you how efficiently the promotion converts revenue into real contribution toward overhead and profit."></span></div>
          <div class="kpi-box-value">${formatPercentColored(cmPct)}</div>
        </div>
      `;
      
      // Break-even GP% calculation for the manager
      const breakEvenGP = promoCost > 0 && promoRev > 0
        ? ((baselineGPDollar + promoCost) / promoRev * 100)
        : null;
      const breakEvenNote = breakEvenGP !== null
        ? (() => {
            const gap = promoGP - breakEvenGP;
            const absGap = Math.abs(gap);
            let gapText, metColor;
            if (absGap < 0.05) {
              // Exactly at break-even
              gapText   = '‚úÖ Break-even exactly reached';
              metColor  = '#0f766e';
            } else if (gap > 0) {
              gapText   = `‚úÖ Profitable ‚Äî ${gap.toFixed(1)}pp above break-even`;
              metColor  = '#0f766e';
            } else {
              gapText   = `üî¥ ${absGap.toFixed(1)}pp short ‚Äî promo is losing money`;
              metColor  = '#dc2626';
            }
            return `<tr class="breakeven-row" style="background:rgba(217,119,6,0.05);border-top:2px solid rgba(217,119,6,0.25);">
              <td colspan="3" style="font-size:12px;color:#92400e;font-weight:600;padding:8px 12px;white-space:nowrap;overflow:visible;">
                üéØ Break-even Promo GP%
                <span class="help-icon" data-help="The minimum Promo GP% needed to fully cover the promo cost AND match baseline profit. Above this = profitable promo. Below = net loss."></span>
              </td>
              <td style="font-size:13px;font-weight:700;color:${metColor};white-space:normal;overflow:visible;padding:8px 12px;line-height:1.4;">
                ${breakEvenGP.toFixed(1)}% needed &mdash; currently ${promoGP.toFixed(1)}% &mdash; ${gapText}
              </td>
            </tr>`;
          })()
        : '';

      // Color helper for Change column
      const chgColor = (v, lowerIsBetter = false) => {
        if (Math.abs(v) < 0.01) return 'var(--muted)';
        const good = lowerIsBetter ? v < 0 : v > 0;
        return good ? '#0f766e' : '#dc2626';
      };

      let tableHTML = `
        <thead>
          <tr>
            <th>Metric <span class="help-icon" data-help="The financial measure being compared across baseline and promo periods."></span></th>
            <th>Baseline <span class="help-icon" data-help="Your normal performance before the promotion ‚Äî the benchmark everything gets measured against."></span></th>
            <th>Promo <span class="help-icon" data-help="Performance during the promotion period, including any discounts and uplift in volume."></span></th>
            <th>Change <span class="help-icon" data-help="The difference between Promo and Baseline. Green = promo helped this metric. Red = promo hurt it."></span></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Revenue</td>
            <td>${formatCurrency(baselineRev)}</td>
            <td>${formatCurrency(promoRev)}</td>
            <td style="color:${chgColor(incrementalRev)};font-weight:600;">${formatCurrency(incrementalRev)}</td>
          </tr>
          <tr>
            <td>GP%</td>
            <td>${formatPercent(baselineGP)}</td>
            <td>${formatPercent(promoGP)}</td>
            <td style="color:${chgColor(promoGP - baselineGP)};font-weight:600;">${formatPercent(promoGP - baselineGP)}</td>
          </tr>
          <tr>
            <td>GP $</td>
            <td>${formatCurrency(baselineGPDollar)}</td>
            <td>${formatCurrency(promoGPDollar)}</td>
            <td style="color:${chgColor(incrementalGP)};font-weight:600;">${formatCurrency(incrementalGP)}</td>
          </tr>
          <tr>
            <td>Promo Cost</td>
            <td>‚Äî</td>
            <td>${formatCurrency(promoCost)}</td>
            <td style="color:#dc2626;font-weight:600;">${formatCurrency(promoCost)}</td>
          </tr>
          <tr style="border-top:2px solid var(--border);">
            <td><strong>Net Profit</strong></td>
            <td>${formatCurrency(baselineGPDollar)}</td>
            <td>${formatCurrency(promoGPDollar - promoCost)}</td>
            <td style="color:${chgColor(netProfit)};font-weight:700;font-size:14px;">${formatCurrency(netProfit)}</td>
          </tr>
          ${breakEvenNote}
        </tbody>
      `;
      document.getElementById('promoTable').innerHTML = tableHTML;
      renderPromoDecisionBox();
      renderPromoWswn();
    }
    
    // ========== CHANNEL P&L FUNCTIONS ==========
    
    function renderChannelPL() {
      const monthFilter = document.getElementById('channelMonthFilter').value;
      const channelFilter = document.getElementById('channelFilter').value;
      
      let filtered = channelData.filter(d => {
        if (monthFilter !== 'all' && d.month !== monthFilter) return false;
        if (channelFilter !== 'all' && d.channel !== channelFilter) return false;
        return true;
      });
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Month <span class="help-icon" data-help="The calendar month of the data. Lets you spot seasonal patterns ‚Äî e.g. if Retail spikes in December but Online is flat."></span></th>
            <th>Channel <span class="help-icon" data-help="The sales route ‚Äî e.g. Direct (you sell), Retail (through a store), Online (e-commerce), Partner (resellers). Each has different cost structures and margin profiles."></span></th>
            <th>Revenue <span class="help-icon" data-help="Total sales dollars generated by this channel in this month. High revenue doesn't always mean high profit ‚Äî check GP% and Contribution too."></span></th>
            <th>COGS <span class="help-icon" data-help="Cost of Goods Sold ‚Äî what it costs to produce or source the products sold. Subtract this from Revenue to get Gross Profit. Lower COGS = better margin."></span></th>
            <th>GP% <span class="help-icon" data-help="Gross Profit % ‚Äî the share of revenue left after product costs. A GP% of 40% means 40 cents of every dollar sold goes toward covering overheads and profit."></span></th>
            <th>OpEx <span class="help-icon" data-help="Operating Expenses specific to this channel ‚Äî e.g. sales team costs, trade spend, delivery fees, platform commissions. Subtract this from Gross Profit to get Contribution."></span></th>
            <th>Contribution <span class="help-icon" data-help="How much this channel actually contributes to company profit after all channel-specific costs. This is the real scorecard ‚Äî a channel with high revenue but negative Contribution is losing money."></span></th>
          </tr>
        </thead>
        <tbody>
      `;
      filtered.forEach(d => {
        const contrib = parseFloat(d.contribution);
        const isNegContrib = contrib < 0;
        const rowStyle = isNegContrib ? ' style="background:rgba(220,38,38,0.06);"' : '';
        const contribStyle = isNegContrib ? ' style="color:#dc2626;font-weight:600;"' : '';
        tableHTML += `
          <tr${rowStyle}>
            <td>${d.month}</td>
            <td>${d.channel}</td>
            <td>${formatCurrency(parseFloat(d.revenue))}</td>
            <td>${formatCurrency(parseFloat(d.cogs))}</td>
            <td style="color:${parseFloat(d.gp) >= 40 ? '#0f766e' : parseFloat(d.gp) >= 30 ? '#b45309' : '#dc2626'};font-weight:600;">${d.gp}%</td>
            <td>${formatCurrency(parseFloat(d.opex))}</td>
            <td${contribStyle}>${formatCurrency(contrib)}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('channelTable').innerHTML = tableHTML;
      
      renderChannelChart();
      renderChannelWswn();
    }
    
    function renderChannelChart() {
      const canvas = document.getElementById('channelChart');
      const container = canvas.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const channels = [...new Set(channelData.map(d => d.channel))];
      const channelTotals = channels.map(ch => {
        const total = channelData.filter(d => d.channel === ch).reduce((sum, d) => sum + parseFloat(d.revenue), 0);
        return { channel: ch, total };
      }).sort((a, b) => b.total - a.total);
      
      const maxTotal = Math.max(...channelTotals.map(c => c.total));
      const paddingLeft = 100;
      const paddingRight = 60;
      const paddingTop = 20;
      const paddingBottom = 30;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const barHeight = 30;
      const barGap = 10;
      
      channelTotals.forEach((c, i) => {
        const barW = (c.total / maxTotal) * chartW;
        const y = paddingTop + i * (barHeight + barGap);
        
        ctx.fillStyle = '#0f766e';
        ctx.fillRect(paddingLeft, y, barW, barHeight);
        
        ctx.fillStyle = '#0b1220';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        ctx.fillText(c.channel, paddingLeft - 10, y + barHeight / 2);
        
        ctx.fillStyle = '#0b1220';
        ctx.textAlign = 'left';
        ctx.fillText(formatCurrency(c.total), paddingLeft + barW + 8, y + barHeight / 2);
      });
    }
    
    function populateChannelFilters() {
      const months = [...new Set(channelData.map(d => d.month))];
      const channels = [...new Set(channelData.map(d => d.channel))];
      
      document.getElementById('channelMonthFilter').innerHTML = '<option value="all">All Months</option>' +
        months.map(m => `<option value="${m}">${m}</option>`).join('');
      
      document.getElementById('channelFilter').innerHTML = '<option value="all">All Channels</option>' +
        channels.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    // ========== PVM FUNCTIONS ==========
    
    function computePVM() {
      const priorRev = parseFloat(document.getElementById('priorRev').value) || 0;
      const currentRev = parseFloat(document.getElementById('currentRev').value) || 0;
      const priceEffect = parseFloat(document.getElementById('priceEffect').value) || 0;
      const volumeEffect = parseFloat(document.getElementById('volumeEffect').value) || 0;
      const mixEffect = parseFloat(document.getElementById('mixEffect').value) || 0;
      
      const totalVariance = currentRev - priorRev;
      const priceDollar = priorRev * (priceEffect / 100);
      const volumeDollar = priorRev * (volumeEffect / 100);
      const mixDollar = priorRev * (mixEffect / 100);
      
      document.getElementById('pvmKPIs').innerHTML = `
        <div class="kpi-box">
          <div class="kpi-box-label">Total Variance</div>
          <div class="kpi-box-value">${formatCurrencyColored(totalVariance)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"><span class="tooltip" data-tooltip="Revenue change from price">Price Effect</span></div>
          <div class="kpi-box-value">${formatCurrencyColored(priceDollar)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"><span class="tooltip" data-tooltip="Revenue change from volume">Volume Effect</span></div>
          <div class="kpi-box-value">${formatCurrencyColored(volumeDollar)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"><span class="tooltip" data-tooltip="Revenue change from mix">Mix Effect</span></div>
          <div class="kpi-box-value">${formatCurrencyColored(mixDollar)}</div>
        </div>
      `;
      
      renderPVMChart(priorRev, priceDollar, volumeDollar, mixDollar, currentRev);
      renderPVMExplainer(priorRev, currentRev, priceEffect, volumeEffect, mixEffect, priceDollar, volumeDollar, mixDollar);
    }

    function renderPVMExplainer(priorRev, currentRev, priceEff, volEff, mixEff, priceDollar, volumeDollar, mixDollar) {
      const box = document.getElementById('pvmExplainer');
      if (!priorRev) { box.style.display = 'none'; return; }
      box.style.display = '';

      const totalVariance = currentRev - priorRev;
      const totalPct = priorRev > 0 ? (totalVariance / priorRev * 100) : 0;
      const isGrowth = totalVariance >= 0;

      // Color helpers
      const posC = '#0f766e', posBg = 'rgba(15,118,110,0.10)';
      const negC = '#dc2626', negBg = 'rgba(220,38,38,0.10)';
      const pillStyle = (val) => `background:${val >= 0 ? posBg : negBg};color:${val >= 0 ? posC : negC};`;
      const fmt = (v) => (v >= 0 ? '+' : '') + '$' + Math.abs(Math.round(v)).toLocaleString();
      const fmtPct = (v) => (v >= 0 ? '+' : '') + v.toFixed(1) + '%';

      // Total badge
      const pvmTotalEl = document.getElementById('pvmTotalValue');
      const tvSign = totalVariance >= 0 ? '+' : '';
      pvmTotalEl.textContent = tvSign + '$' + Math.abs(Math.round(totalVariance)).toLocaleString();
      pvmTotalEl.style.color = totalVariance >= 0 ? '#0f766e' : '#dc2626';
      document.getElementById('pvmTotalPct').textContent = fmtPct(totalPct);
      const badge = document.getElementById('pvmTotalBadge');
      badge.textContent = isGrowth ? '‚ñ≤ Growth' : '‚ñº Decline';
      badge.style.cssText = `font-size:11px;font-weight:700;padding:3px 10px;border-radius:999px;background:${isGrowth ? posBg : negBg};color:${isGrowth ? posC : negC};`;

      // Effect pills
      const setPill = (id, val) => {
        const el = document.getElementById(id);
        el.textContent = fmt(val);
        el.style.cssText = pillStyle(val);
      };
      setPill('pvmPricePill', priceDollar);
      setPill('pvmVolumePill', volumeDollar);
      setPill('pvmMixPill', mixDollar);

      // Identify biggest driver and any headwinds
      const drivers = [
        { name: 'Price', dollar: priceDollar, pct: priceEff },
        { name: 'Volume', dollar: volumeDollar, pct: volEff },
        { name: 'Mix', dollar: mixDollar, pct: mixEff }
      ];
      const sorted = [...drivers].sort((a,b) => Math.abs(b.dollar) - Math.abs(a.dollar));
      const biggest = sorted[0];
      const headwinds = drivers.filter(d => d.dollar < 0);
      const tailwinds = drivers.filter(d => d.dollar > 0);
      const allPositive = headwinds.length === 0;
      const allNegative = tailwinds.length === 0;

      // Build WSWN content
      let whatText, soWhatText, nowWhatText;

      // WHAT ‚Äî factual description of the data
      whatText = `Revenue ${isGrowth ? 'grew' : 'declined'} ${fmtPct(totalPct)} vs prior period (${fmt(totalVariance)}). ` +
        `Price: ${fmt(priceDollar)} (${fmtPct(priceEff)}), Volume: ${fmt(volumeDollar)} (${fmtPct(volEff)}), Mix: ${fmt(mixDollar)} (${fmtPct(mixEff)}).`;

      // SO WHAT ‚Äî interpretation
      if (isGrowth && allPositive) {
        soWhatText = `Broad-based growth ‚Äî all three drivers are tailwinds. This is the healthiest PVM profile: you're charging more, selling more, and shifting toward higher-value products simultaneously. The biggest contributor is ${biggest.name} at ${fmt(biggest.dollar)}.`;
      } else if (isGrowth && headwinds.length > 0) {
        const drag = headwinds.map(d => `${d.name} (${fmt(d.dollar)})`).join(', ');
        soWhatText = `Growth is happening but masked by a headwind: ${drag} is dragging against the tailwinds. If the headwind widens, the growth story weakens. The biggest positive lever is ${biggest.name} at ${fmt(biggest.dollar)}.`;
      } else if (!isGrowth && allNegative) {
        soWhatText = `Revenue declined across all three dimensions ‚Äî this is a broad-based deterioration. Pricing power, sales volume, and product mix are all moving in the wrong direction simultaneously. Requires a full commercial review.`;
      } else {
        const worstDrag = headwinds.sort((a,b) => a.dollar - b.dollar)[0];
        soWhatText = `Revenue declined ${fmtPct(totalPct)} despite some positive drivers. ${tailwinds.length > 0 ? `${tailwinds.map(d=>d.name+' ('+fmt(d.dollar)+')').join(', ')} helped, but wasn't enough.` : ''} The largest drag is ${worstDrag.name} at ${fmt(worstDrag.dollar)}.`;
      }

      // NOW WHAT ‚Äî action
      if (headwinds.length > 0) {
        const worst = headwinds.sort((a,b) => a.dollar - b.dollar)[0];
        nowWhatText = `Focus on the ${worst.name} headwind (${fmt(worst.dollar)}). ` +
          (worst.name === 'Mix' ? 'Rebalance the product portfolio toward higher-revenue SKUs ‚Äî if Volume is green but Mix is red, you\'re selling more of the wrong product.' :
           worst.name === 'Price' ? 'Review discount depth, price erosion, and competitive pricing pressure. Consider selective price recovery on high-margin SKUs.' :
           'Investigate volume decline by channel, region, or customer segment. Check if this is demand-led or supply/capacity constrained.') +
          ` Protect ${biggest.name} (current top driver).`;
      } else {
        nowWhatText = `Protect ${biggest.name} ‚Äî it drove ${fmt(biggest.dollar)} of the uplift. To sustain momentum, invest in the smaller contributors to make this growth more diversified and resilient.`;
      }

      document.getElementById('pvmWswnWhat').innerHTML = wrapNumbers(whatText);
      document.getElementById('pvmWswnSoWhat').innerHTML = wrapNumbers(soWhatText);
      document.getElementById('pvmWswnNowWhat').innerHTML = wrapNumbers(nowWhatText);

      // Determine risk level for PVM
      let pvmRisk;
      if (!isGrowth && allNegative) pvmRisk = 'high';
      else if (!isGrowth || headwinds.length > 1) pvmRisk = 'moderate';
      else if (headwinds.length === 1) pvmRisk = 'moderate';
      else pvmRisk = 'healthy';

      const pvmWrap = document.getElementById('pvmWswn');
      const pvmHeader = pvmWrap ? pvmWrap.querySelector('.wswn-wrap-header') : null;
      applyWswnRisk(pvmWrap, pvmHeader, pvmRisk, 'üí° PVM Insight');
      boldNowWhat(document.getElementById('pvmWswnNowWhat'), pvmRisk);
    }

    function renderPVMChart(prior, price, volume, mix, current) {
      const canvas = document.getElementById('pvmChart');
      const container = canvas.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const values = [prior, prior + price, prior + price + volume, prior + price + volume + mix, current];
      const labels = ['Prior', '+ Price', '+ Volume', '+ Mix', 'Current'];
      
      const maxVal = Math.max(...values);
      const minVal = Math.min(...values, 0);
      const range = maxVal - minVal;
      
      const paddingLeft = 60;
      const paddingRight = 40;
      const paddingTop = 40;
      const paddingBottom = 50;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const barWidth = chartW / (values.length * 1.5);
      const barGap = barWidth * 0.5;
      
      // Zero line
      const zeroY = paddingTop + chartH - ((0 - minVal) / range) * chartH;
      ctx.strokeStyle = '#0b1220';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, zeroY);
      ctx.lineTo(w - paddingRight, zeroY);
      ctx.stroke();
      
      // Bars
      values.forEach((val, i) => {
        const x = paddingLeft + i * (barWidth + barGap);
        const barH = Math.abs((val - minVal) / range * chartH - (0 - minVal) / range * chartH);
        const y = val >= 0 ? zeroY - barH : zeroY;
        
        ctx.fillStyle = i === 0 || i === values.length - 1 ? '#1b4d7a' : '#0f766e';
        ctx.fillRect(x, y, barWidth, barH);
        
        // Label
        ctx.fillStyle = '#0b1220';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.fillText(labels[i], x + barWidth / 2, h - paddingBottom + 5);
        
        // Value
        ctx.font = 'bold 11px sans-serif';
        ctx.textBaseline = 'bottom';
        ctx.fillText(formatCurrency(val), x + barWidth / 2, y - 5);
      });
    }
    
    // ========== ACCRUAL FUNCTIONS ==========
    
    function computeAccrual() {
      const pool = parseFloat(document.getElementById('discountPool').value) || 0;
      const start = parseInt(document.getElementById('startMonth').value) || 1;
      const end = parseInt(document.getElementById('endMonth').value) || 12;
      
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const numMonths = end - start + 1;
      const monthlyAccrual = numMonths > 0 ? pool / numMonths : 0;
      
      accrualSchedule = [];
      let cumulative = 0;
      months.forEach((month, i) => {
        const monthNum = i + 1;
        const accrual = (monthNum >= start && monthNum <= end) ? monthlyAccrual : 0;
        cumulative += accrual;
        accrualSchedule.push({
          month,
          accrual: accrual.toFixed(2),
          cumulative: cumulative.toFixed(2),
          remaining: (pool - cumulative).toFixed(2)
        });
      });
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Month</th>
            <th>Monthly Accrual <span class="help-icon" data-help="The share of the total discount pool booked in this month. Zero means the deal is not active in this period."></span></th>
            <th>Cumulative <span class="help-icon" data-help="Running total of discount cost recognised so far. Should reach the full pool by the end month."></span></th>
            <th>Remaining Pool <span class="help-icon" data-help="How much of the discount pool has not yet been accrued. Should hit $0 by the deal end month."></span></th>
          </tr>
        </thead>
        <tbody>
      `;
      accrualSchedule.forEach(a => {
        const isActive = parseFloat(a.accrual) > 0;
        const rowStyle = isActive ? ' style="background:rgba(15,118,110,0.04);"' : ' style="color:var(--muted);"';
        tableHTML += `
          <tr${rowStyle}>
            <td>${a.month}${isActive ? ' <span style="font-size:9px;font-weight:700;color:#0f766e;background:rgba(15,118,110,0.10);padding:1px 5px;border-radius:999px;vertical-align:middle;">ACTIVE</span>' : ''}</td>
            <td style="font-weight:${isActive ? '600' : '400'};">${isActive ? formatCurrency(parseFloat(a.accrual)) : '‚Äî'}</td>
            <td>${formatCurrency(parseFloat(a.cumulative))}</td>
            <td style="color:${parseFloat(a.remaining) > 0 ? 'var(--muted)' : '#0f766e'};">${formatCurrency(parseFloat(a.remaining))}</td>
          </tr>
        `;
      });
      // Totals row
      tableHTML += `
          <tr style="border-top:2px solid var(--border);background:rgba(12,23,45,0.03);">
            <td><strong>Total</strong></td>
            <td><strong>${formatCurrency(pool)}</strong></td>
            <td><strong>${formatCurrency(pool)}</strong></td>
            <td style="color:#0f766e;font-weight:700;">$0 remaining</td>
          </tr>
        </tbody>`;
      document.getElementById('accrualTable').innerHTML = tableHTML;
      renderAccrualWswn();
    }
    
    // ========== CSV DOWNLOADS ==========
    
    function downloadPromoCSV() {
      const headers = ['metric', 'baseline', 'promo', 'change'];
      const baselineRev = parseFloat(document.getElementById('baselineRev').value) || 0;
      const promoRev = parseFloat(document.getElementById('promoRev').value) || 0;
      const baselineGP = parseFloat(document.getElementById('baselineGP').value) || 0;
      const promoGP = parseFloat(document.getElementById('promoGP').value) || 0;
      const rows = [
        { metric: 'Revenue', baseline: baselineRev, promo: promoRev, change: promoRev - baselineRev },
        { metric: 'GP%', baseline: baselineGP, promo: promoGP, change: promoGP - baselineGP }
      ];
      downloadCSV('promotion_roi.csv', headers, rows);
    }
    
    function downloadPromoTemplate() {
      const headers = ['baseline_revenue', 'promo_revenue', 'baseline_gp', 'promo_gp', 'promo_cost'];
      const rows = [{ baseline_revenue: 50000, promo_revenue: 85000, baseline_gp: 42, promo_gp: 28, promo_cost: 12000 }];
      downloadCSV('promotions_template.csv', headers, rows);
    }
    
    function downloadChannelCSV() {
      const headers = ['month', 'channel', 'revenue', 'cogs', 'gp_pct', 'opex', 'contribution'];
      downloadCSV('channel_pnl.csv', headers, channelData);
    }
    
    function downloadChannelTemplate() {
      const headers = ['month', 'channel', 'revenue', 'cogs', 'gp_pct', 'opex', 'contribution'];
      const rows = [
        { month: 'Jan', channel: 'Direct', revenue: 15000, cogs: 6000, gp_pct: 60, opex: 3000, contribution: 6000 },
        { month: 'Jan', channel: 'Online', revenue: 12000, cogs: 5000, gp_pct: 58.3, opex: 2500, contribution: 4500 }
      ];
      downloadCSV('channel_pnl_template.csv', headers, rows);
    }
    
    function downloadPVMCSV() {
      const headers = ['prior_revenue', 'current_revenue', 'price_effect', 'volume_effect', 'mix_effect'];
      const rows = [{
        prior_revenue: document.getElementById('priorRev').value,
        current_revenue: document.getElementById('currentRev').value,
        price_effect: document.getElementById('priceEffect').value,
        volume_effect: document.getElementById('volumeEffect').value,
        mix_effect: document.getElementById('mixEffect').value
      }];
      downloadCSV('pvm_analysis.csv', headers, rows);
    }
    
    function downloadPVMTemplate() {
      const headers = ['prior_revenue', 'current_revenue', 'price_effect', 'volume_effect', 'mix_effect'];
      const rows = [{ prior_revenue: 120000, current_revenue: 138000, price_effect: 5.2, volume_effect: 8.5, mix_effect: 1.3 }];
      downloadCSV('pvm_template.csv', headers, rows);
    }
    
    function downloadAccrualCSV() {
      const headers = ['month', 'accrual', 'cumulative', 'remaining'];
      downloadCSV('accrual_schedule.csv', headers, accrualSchedule);
    }
    
    function downloadAccrualTemplate() {
      const headers = ['discount_pool', 'start_month', 'end_month'];
      const rows = [{ discount_pool: 48000, start_month: 1, end_month: 12 }];
      downloadCSV('accrual_template.csv', headers, rows);
    }
    
    function downloadAllTemplates() {
      downloadPromoTemplate();
      setTimeout(() => downloadChannelTemplate(), 300);
      setTimeout(() => downloadPVMTemplate(), 600);
      setTimeout(() => downloadAccrualTemplate(), 900);
    }
    
    // ========== CSV UPLOADS ==========
    
    function handlePromoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['baseline_revenue', 'promo_revenue', 'baseline_gp', 'promo_gp', 'promo_cost'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          const row = data[0];
          document.getElementById('baselineRev').value = row.baseline_revenue;
          document.getElementById('promoRev').value = row.promo_revenue;
          document.getElementById('baselineGP').value = row.baseline_gp;
          document.getElementById('promoGP').value = row.promo_gp;
          document.getElementById('promoCost').value = row.promo_cost;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'CSV'; document.getElementById('dataModeBadge').classList.remove('random');
          computePromoROI();
          alert('Promo data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handleChannelUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['month', 'channel', 'revenue', 'cogs', 'gp_pct', 'opex', 'contribution'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          // Map gp_pct ‚Üí gp for internal use
          channelData = data.map(r => ({ ...r, gp: r.gp_pct !== undefined ? r.gp_pct : r.gp }));
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'CSV'; document.getElementById('dataModeBadge').classList.remove('random');
          populateChannelFilters();
          renderChannelPL();
          alert('Channel data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handlePVMUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['prior_revenue', 'current_revenue', 'price_effect', 'volume_effect', 'mix_effect'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          const row = data[0];
          document.getElementById('priorRev').value = row.prior_revenue;
          document.getElementById('currentRev').value = row.current_revenue;
          document.getElementById('priceEffect').value = row.price_effect;
          document.getElementById('volumeEffect').value = row.volume_effect;
          document.getElementById('mixEffect').value = row.mix_effect;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'CSV'; document.getElementById('dataModeBadge').classList.remove('random');
          computePVM();
          alert('PVM data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handleAccrualUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['discount_pool', 'start_month', 'end_month'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          const row = data[0];
          document.getElementById('discountPool').value = row.discount_pool;
          document.getElementById('startMonth').value = row.start_month;
          document.getElementById('endMonth').value = row.end_month;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'CSV'; document.getElementById('dataModeBadge').classList.remove('random');
          computeAccrual();
          alert('Accrual data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    // ========== DECISION BOX (PROMO ROI) ==========

    function scrollToSection(event, href) {
      event.preventDefault();
      const target = document.querySelector(href);
      if (!target) return;
      const offset = 80;
      const top = target.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top, behavior: 'smooth' });
      const heading = target.querySelector('h2');
      if (heading) {
        heading.style.transition = 'color 300ms ease';
        heading.style.color = 'var(--accent)';
        setTimeout(() => { heading.style.color = ''; }, 1800);
      }
    }

    function renderPromoDecisionBox() {
      const fallback = document.getElementById('promoDecisionFallback');
      const content  = document.getElementById('promoDecisionContent');

      const baselineRev = parseFloat(document.getElementById('baselineRev').value) || 0;
      const promoRev    = parseFloat(document.getElementById('promoRev').value)    || 0;
      const baselineGP  = parseFloat(document.getElementById('baselineGP').value)  || 0;
      const promoGP     = parseFloat(document.getElementById('promoGP').value)     || 0;
      const promoCost   = parseFloat(document.getElementById('promoCost').value)   || 0;

      if (!baselineRev && !promoRev) {
        fallback.style.display = '';
        content.style.display = 'none';
        return;
      }

      const baselineGPDollar  = baselineRev * (baselineGP / 100);
      const promoGPDollar     = promoRev    * (promoGP    / 100);
      const incrementalGP     = promoGPDollar - baselineGPDollar;
      const netProfit         = incrementalGP - promoCost;
      const marginImpactPp    = promoGP - baselineGP;
      const revenueUplift     = promoRev - baselineRev;

      const profitable    = netProfit > 0;
      const marginOk      = marginImpactPp >= -5;
      const marginCaution = marginImpactPp < -5 && marginImpactPp >= -10;
      const runPromo    = profitable && marginOk;
      const cautionPromo = profitable && marginCaution;

      // ‚îÄ‚îÄ SECTION 1: Promo ROI signal (mirrors renderPromoWswn) ‚îÄ‚îÄ
      const promoRisk = runPromo ? 'healthy' : cautionPromo ? 'moderate' : 'high';
      const promoSignal = (netProfit >= 0 ? '+' : '') + '$' + Math.abs(Math.round(netProfit)).toLocaleString() +
        ' net ¬∑ ' + (marginImpactPp >= 0 ? '+' : '') + marginImpactPp.toFixed(1) + 'pp GP';
      const promoSignalColor = promoRisk === 'healthy' ? '#059669' : promoRisk === 'moderate' ? '#b45309' : '#dc2626';
      const promoAction = runPromo ? 'Scale this promo'
        : cautionPromo ? 'Reduce discount depth by 2‚Äì3pp'
        : 'Restructure: cut cost or raise Promo GP%';

      // ‚îÄ‚îÄ SECTION 2: Channel P&L signal (mirrors renderChannelWswn) ‚îÄ‚îÄ
      const negChannelsMap = {};
      if (channelData && channelData.length > 0) {
        channelData.forEach(d => {
          negChannelsMap[d.channel] = (negChannelsMap[d.channel] || 0) + parseFloat(d.contribution);
        });
      }
      const negChannelNames = Object.entries(negChannelsMap).filter(([,v]) => v < 0).map(([k]) => k);
      const negCount = negChannelNames.length;
      // Compute blended GP% for channel signal
      const allRevTotal = channelData.reduce((s,d) => s + parseFloat(d.revenue), 0);
      const blendedGP   = allRevTotal > 0
        ? channelData.reduce((s,d) => s + parseFloat(d.gp) * parseFloat(d.revenue), 0) / allRevTotal
        : 0;
      const channelRisk = negCount > 0 ? 'high' : 'healthy';
      let channelSignal, channelSignalColor, channelAction;
      if (negCount > 0) {
        channelSignal = negCount + ' channel' + (negCount > 1 ? 's' : '') + ' negative ¬∑ GP ' + blendedGP.toFixed(1) + '%';
        channelSignalColor = '#dc2626';
        channelAction = 'Investigate ' + negChannelNames.slice(0,2).join(', ') + (negChannelNames.length > 2 ? '‚Ä¶' : '');
      } else {
        channelSignal = 'All profitable ¬∑ Blended GP ' + blendedGP.toFixed(1) + '%';
        channelSignalColor = '#059669';
        channelAction = blendedGP >= 40 ? 'Maintain mix discipline' : 'Monitor GP% erosion';
      }

      // ‚îÄ‚îÄ SECTION 3: PVM signal (mirrors renderPVMExplainer) ‚îÄ‚îÄ
      const priorRev    = parseFloat(document.getElementById('priorRev').value)     || 0;
      const currentRevV = parseFloat(document.getElementById('currentRev').value)   || 0;
      const priceEff    = parseFloat(document.getElementById('priceEffect').value)  || 0;
      const volEff      = parseFloat(document.getElementById('volumeEffect').value) || 0;
      const mixEff      = parseFloat(document.getElementById('mixEffect').value)    || 0;
      const totalVariance = currentRevV - priorRev;
      const priceDollar = priorRev * (priceEff / 100);
      const volumeDollar = priorRev * (volEff / 100);
      const mixDollar   = priorRev * (mixEff / 100);
      const pvmDrivers  = [
        { name: 'Price', dollar: priceDollar },
        { name: 'Volume', dollar: volumeDollar },
        { name: 'Mix', dollar: mixDollar }
      ];
      const pvmHeadwinds = pvmDrivers.filter(d => d.dollar < 0);
      const isGrowth     = totalVariance >= 0;
      const allNegPVM    = pvmHeadwinds.length === 3;
      const pvmRisk      = (!isGrowth && allNegPVM) ? 'high' : (!isGrowth || pvmHeadwinds.length > 1) ? 'moderate' : pvmHeadwinds.length === 1 ? 'moderate' : 'healthy';
      const pvmSign      = totalVariance >= 0 ? '+' : '';
      const pvmSignal    = pvmSign + '$' + Math.abs(Math.round(totalVariance)).toLocaleString() + ' variance ¬∑ '
        + pvmHeadwinds.length + ' headwind' + (pvmHeadwinds.length !== 1 ? 's' : '');
      const pvmSignalColor = pvmRisk === 'healthy' ? '#059669' : pvmRisk === 'moderate' ? '#b45309' : '#dc2626';
      let pvmAction;
      if (pvmHeadwinds.length > 0) {
        const worst = pvmHeadwinds.sort((a,b) => a.dollar - b.dollar)[0];
        pvmAction = 'Fix ' + worst.name + ' headwind (' + (worst.dollar >= 0 ? '+' : '') + '$' + Math.abs(Math.round(worst.dollar)).toLocaleString() + ')';
      } else {
        pvmAction = 'Protect top growth driver';
      }

      // ‚îÄ‚îÄ SECTION 4: Accrual signal (mirrors renderAccrualWswn) ‚îÄ‚îÄ
      const accrualPool   = parseFloat(document.getElementById('discountPool').value) || 0;
      const accrualStart  = parseInt(document.getElementById('startMonth').value)    || 1;
      const accrualEnd    = parseInt(document.getElementById('endMonth').value)      || 12;
      const accrualMonths = Math.max(1, accrualEnd - accrualStart + 1);
      const monthlyAccr   = accrualPool > 0 ? accrualPool / accrualMonths : 0;
      const accrualRiskLevel = accrualMonths < 3 ? 'high' : accrualMonths < 6 ? 'moderate' : 'healthy';
      const accrualSignal = '$' + Math.round(monthlyAccr).toLocaleString() + '/mo ¬∑ '
        + accrualMonths + ' month' + (accrualMonths !== 1 ? 's' : '');
      const accrualSignalColor = accrualRiskLevel === 'healthy' ? '#059669' : accrualRiskLevel === 'moderate' ? '#b45309' : '#dc2626';
      const accrualAction = accrualRiskLevel === 'healthy' ? 'Post monthly journals & reconcile'
        : accrualRiskLevel === 'moderate' ? 'Add P&L footnote per accrual month'
        : 'Renegotiate spread or document spike';

      // ‚îÄ‚îÄ Hero summary line ‚îÄ‚îÄ
      let summaryText;
      if (runPromo) {
        summaryText = `Promo is profitable ‚Äî net gain of $${Math.round(netProfit).toLocaleString()} after all costs. Margin holds within acceptable range.`;
      } else if (cautionPromo) {
        summaryText = `Promo is profitable (+$${Math.round(netProfit).toLocaleString()}) but margin compressed ${Math.abs(marginImpactPp).toFixed(1)}pp ‚Äî above the 5pp caution threshold. Reduce discount depth before scaling.`;
      } else if (!profitable && marginImpactPp < -10) {
        summaryText = `Promo is losing money ‚Äî discount depth destroyed margin (${Math.abs(marginImpactPp).toFixed(1)}pp drop) and promo cost of $${promoCost.toLocaleString()} cannot be recovered.`;
      } else if (!profitable) {
        summaryText = `Promo cost of $${promoCost.toLocaleString()} exceeds incremental profit of $${Math.max(0,Math.round(incrementalGP)).toLocaleString()}. Reduce spend or raise qualifying spend threshold.`;
      } else {
        summaryText = `Revenue uplift of $${Math.round(revenueUplift).toLocaleString()} is positive but margin compressed ${Math.abs(marginImpactPp).toFixed(1)}pp ‚Äî monitor closely.`;
      }
      document.getElementById('promoDecisionSummary').textContent = summaryText;

      // ‚îÄ‚îÄ Subtitle bar ‚îÄ‚îÄ
      const accrualRiskEmoji = accrualRiskLevel === 'healthy' ? '‚úÖ Low' : accrualRiskLevel === 'moderate' ? '‚ö†Ô∏è Moderate' : 'üî¥ High';
      const issuesList = [];
      if (!runPromo && !cautionPromo) issuesList.push({ sev:'red',  label:'Promo losing money',   desc:`Net profit: ($${Math.round(Math.abs(netProfit)).toLocaleString()}). Cost exceeds incremental GP.` });
      if (cautionPromo)               issuesList.push({ sev:'amber',label:'Margin squeezed',       desc:`GP% dropped ${Math.abs(marginImpactPp).toFixed(1)}pp ‚Äî above 5pp caution threshold.` });
      if (!marginOk && !cautionPromo) issuesList.push({ sev:'red',  label:'Margin destruction',   desc:`GP% collapsed ${Math.abs(marginImpactPp).toFixed(1)}pp ‚Äî exceeds the 10pp danger threshold.` });
      if (negCount > 0)               issuesList.push({ sev:'red',  label:`${negCount} channel${negCount>1?'s':''} underwater`, desc:`${negChannelNames.join(', ')} contribution-negative.` });
      if (accrualMonths < 3)          issuesList.push({ sev:'red',  label:'Accrual spike risk',   desc:`Entire pool in ${accrualMonths} month${accrualMonths>1?'s':''}. Will distort P&L.` });
      else if (accrualMonths < 6)     issuesList.push({ sev:'amber',label:'Moderate accrual risk', desc:`Pool over ${accrualMonths} months ‚Äî flag for FP&A commentary.` });
      window._decisionIssues = issuesList;

      const subtitleEl = document.getElementById('promoDecisionSubtitle');
      if (subtitleEl) {
        const netProfitFmt = netProfit < 0
          ? `($${Math.round(Math.abs(netProfit)).toLocaleString()})`
          : `+$${Math.round(netProfit).toLocaleString()}`;
        const riskFlags = issuesList.length;
        const ppTip = `data-tt="pp = percentage points ‚Äî a direct arithmetic difference between two percentages. E.g. going from 42% to 22% GP is a 20pp drop, not 20%."`;
        subtitleEl.innerHTML =
          `<strong>${netProfitFmt}</strong> promo net profit &middot; ` +
          `<strong>${Math.abs(marginImpactPp).toFixed(1)}</strong><span class="term-tt" ${ppTip}>pp</span> margin ${marginImpactPp < 0 ? 'compression' : 'expansion'} &middot; ` +
          `<strong>${negCount}</strong> negative-contribution channel${negCount !== 1 ? 's' : ''} &middot; ` +
          `accrual risk: <strong>${accrualRiskEmoji}</strong>` +
          (riskFlags > 0 ? ` &middot; <span class="issues-trigger" onclick="toggleIssuesPopover(event, this)">${riskFlags} issue${riskFlags !== 1 ? 's' : ''} require your attention</span>` : ' &middot; <span style="color:#059669;font-weight:600;">‚úÖ No critical issues</span>');
        subtitleEl.style.display = '';
      }

      fallback.style.display = 'none';
      content.style.display  = '';

      const box = document.getElementById('promoDecisionBox');
      box.classList.remove('decision-box--positive', 'decision-box--negative', 'decision-box--caution');
      if (runPromo)          box.classList.add('decision-box--positive');
      else if (cautionPromo) box.classList.add('decision-box--caution');
      else                   box.classList.add('decision-box--negative');

      let verdictLabel, verdictDetail;
      if (runPromo) {
        verdictLabel  = 'Yes ‚Äî run the promo';
        verdictDetail = `Net profit of ${formatCurrency(netProfit)} on $${promoCost.toLocaleString()} spend. GP% held within ${Math.abs(marginImpactPp).toFixed(1)}pp of baseline ‚Äî safe to scale.`;
      } else if (cautionPromo) {
        verdictLabel  = 'Proceed with conditions';
        verdictDetail = `Profitable (+${formatCurrency(netProfit)}) but GP% compressed ${Math.abs(marginImpactPp).toFixed(1)}pp. Reduce discount depth by 2‚Äì3pp before scaling.`;
      } else {
        verdictLabel  = 'No ‚Äî don\'t run the promo';
        verdictDetail = `Net loss of ${formatCurrency(netProfit)}. The $${promoCost.toLocaleString()} spend could not be recovered from incremental GP. Restructure parameters first.`;
      }
      document.getElementById('promoDecisionVerdict').innerHTML =
        `Run promo? <span class="verdict-action">${verdictLabel}</span> <span style="font-size:13px;font-weight:400;color:var(--muted);display:block;margin-top:3px;">${verdictDetail}</span>`;

      // ‚îÄ‚îÄ Exception rows ‚Äî signals & actions mirror WSWN sections exactly ‚îÄ‚îÄ
      document.getElementById('promoDecisionExceptions').innerHTML = `
        <div class="exception-row exception-row-header">
          <span>Focus Area</span>
          <span>Signal</span>
          <span>Action</span>
        </div>
        <div class="exception-row" onclick="scrollToSection(event,'#section-promo')" style="cursor:pointer;">
          <span class="exception-label">
            <a href="#section-promo" onclick="scrollToSection(event,'#section-promo')" style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:6px;">
              üéØ Promo ROI
              <span style="font-size:11px;font-weight:600;padding:2px 7px;border-radius:999px;background:rgba(12,23,45,0.07);color:var(--muted);">‚Üì Section 1</span>
            </a>
          </span>
          <span class="exception-count" style="color:${promoSignalColor};">${promoSignal}</span>
          <span class="exception-action">${promoAction}</span>
        </div>
        <div class="exception-row" onclick="scrollToSection(event,'#section-channel')" style="cursor:pointer;">
          <span class="exception-label">
            <a href="#section-channel" onclick="scrollToSection(event,'#section-channel')" style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:6px;">
              üìä Channel P&amp;L
              <span style="font-size:11px;font-weight:600;padding:2px 7px;border-radius:999px;background:rgba(12,23,45,0.07);color:var(--muted);">‚Üì Section 2</span>
            </a>
          </span>
          <span class="exception-count" style="color:${channelSignalColor};">${channelSignal}</span>
          <span class="exception-action">${channelAction}</span>
        </div>
        <div class="exception-row" onclick="scrollToSection(event,'#section-pvm')" style="cursor:pointer;">
          <span class="exception-label">
            <a href="#section-pvm" onclick="scrollToSection(event,'#section-pvm')" style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:6px;">
              üîÄ Price / Volume / Mix
              <span style="font-size:11px;font-weight:600;padding:2px 7px;border-radius:999px;background:rgba(12,23,45,0.07);color:var(--muted);">‚Üì Section 3</span>
            </a>
          </span>
          <span class="exception-count" style="color:${pvmSignalColor};">${pvmSignal}</span>
          <span class="exception-action">${pvmAction}</span>
        </div>
        <div class="exception-row" onclick="scrollToSection(event,'#section-accrual')" style="cursor:pointer;">
          <span class="exception-label">
            <a href="#section-accrual" onclick="scrollToSection(event,'#section-accrual')" style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:6px;">
              üí∞ Accrual Schedule
              <span style="font-size:11px;font-weight:600;padding:2px 7px;border-radius:999px;background:rgba(12,23,45,0.07);color:var(--muted);">‚Üì Section 4</span>
            </a>
          </span>
          <span class="exception-count" style="color:${accrualSignalColor};">${accrualSignal}</span>
          <span class="exception-action">${accrualAction}</span>
        </div>
      `;
    }

    // ========== FLAT CSV UPLOAD ==========

    // Flat CSV format ‚Äî ALL sections in one file, one row per channel-month record.
    // Promo ROI, PVM, and Accrual are scalar fields repeated on every row (same value).
    // Required columns:
    //   month, channel, revenue, cogs, gp_pct, opex, contribution  (Section 2 ‚Äî per row)
    //   baseline_revenue, promo_revenue, baseline_gp, promo_gp, promo_cost  (Section 1 ‚Äî scalar)
    //   prior_revenue, current_revenue, price_effect, volume_effect, mix_effect  (Section 3 ‚Äî scalar)
    //   discount_pool, start_month, end_month  (Section 4 ‚Äî scalar)

    const FLAT_REQUIRED = ['month','channel','revenue','cogs','gp_pct','opex','contribution',
      'baseline_revenue','promo_revenue','baseline_gp','promo_gp','promo_cost',
      'prior_revenue','current_revenue','price_effect','volume_effect','mix_effect',
      'discount_pool','start_month','end_month'];

    function showCsvStatus(msg, type) {
      // type: 'ok' | 'error' | 'info'
      const el = document.getElementById('csvUploadStatus');
      if (!el) return;
      el.style.display = '';
      el.style.background = type === 'ok' ? 'rgba(15,118,110,0.10)' : type === 'error' ? 'rgba(220,38,38,0.08)' : 'rgba(12,23,45,0.04)';
      el.style.color = type === 'ok' ? '#0f766e' : type === 'error' ? '#dc2626' : 'var(--muted)';
      el.style.border = type === 'ok' ? '1px solid rgba(15,118,110,0.25)' : type === 'error' ? '1px solid rgba(220,38,38,0.25)' : '1px solid var(--border)';
      el.innerHTML = msg;
    }

    function handleFlatCsvDrop(event) {
      event.preventDefault();
      const dz = document.getElementById('csvDropZone');
      if (dz) { dz.style.borderColor = 'var(--border)'; dz.style.background = '#fafbfc'; }
      const file = event.dataTransfer.files[0];
      if (!file || !file.name.endsWith('.csv')) {
        showCsvStatus('‚ùå Please drop a .csv file.', 'error'); return;
      }
      _readAndParseFlatCsv(file);
    }

    function handleFlatCsvUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      _readAndParseFlatCsv(file);
      event.target.value = ''; // allow re-upload of same file
    }

    function _readAndParseFlatCsv(file) {
      showCsvStatus('‚è≥ Parsing‚Ä¶', 'info');
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const { headers, data } = parseCSV(e.target.result);
          // Validate required columns
          const missing = FLAT_REQUIRED.filter(c => !headers.includes(c));
          if (missing.length > 0) {
            showCsvStatus('‚ùå Missing columns: <strong>' + missing.join(', ') + '</strong><br>Download the template to see the expected format.', 'error');
            return;
          }
          if (data.length === 0) {
            showCsvStatus('‚ùå CSV has headers but no data rows.', 'error'); return;
          }

          // Section 1 ‚Äî Promo ROI (take from first data row ‚Äî scalar across all rows)
          const r0 = data[0];
          document.getElementById('baselineRev').value  = parseFloat(r0.baseline_revenue) || 0;
          document.getElementById('promoRev').value     = parseFloat(r0.promo_revenue)    || 0;
          document.getElementById('baselineGP').value   = parseFloat(r0.baseline_gp)      || 0;
          document.getElementById('promoGP').value      = parseFloat(r0.promo_gp)         || 0;
          document.getElementById('promoCost').value    = parseFloat(r0.promo_cost)        || 0;

          // Section 2 ‚Äî Channel P&L (ALL rows, just the channel columns)
          channelData = data.map(row => ({
            month:        row.month,
            channel:      row.channel,
            revenue:      parseFloat(row.revenue).toFixed(2),
            cogs:         parseFloat(row.cogs).toFixed(2),
            gp:           parseFloat(row.gp_pct).toFixed(1),
            opex:         parseFloat(row.opex).toFixed(2),
            contribution: parseFloat(row.contribution).toFixed(2)
          }));

          // Section 3 ‚Äî PVM (scalar from first row)
          document.getElementById('priorRev').value     = parseFloat(r0.prior_revenue)    || 0;
          document.getElementById('currentRev').value   = parseFloat(r0.current_revenue)  || 0;
          document.getElementById('priceEffect').value  = parseFloat(r0.price_effect)     || 0;
          document.getElementById('volumeEffect').value = parseFloat(r0.volume_effect)    || 0;
          document.getElementById('mixEffect').value    = parseFloat(r0.mix_effect)       || 0;

          // Section 4 ‚Äî Accrual (scalar from first row)
          document.getElementById('discountPool').value = parseFloat(r0.discount_pool)    || 0;
          document.getElementById('startMonth').value   = parseInt(r0.start_month)        || 1;
          document.getElementById('endMonth').value     = parseInt(r0.end_month)          || 12;

          // Update badge
          dataMode = 'uploaded';
          var badge = document.getElementById('dataModeBadge');
          if (badge) {
            badge.textContent = 'CSV';
            badge.style.background = 'rgba(8,145,178,0.12)';
            badge.style.borderColor = 'rgba(8,145,178,0.30)';
            badge.style.color = '#0369a1';
          }

          populateChannelFilters();
          renderAll();
          showCsvStatus(
            '‚úÖ Loaded <strong>' + data.length + ' rows</strong> from <em>' + file.name + '</em><br>' +
            'Channels: ' + [...new Set(channelData.map(d => d.channel))].join(', '),
            'ok'
          );
        } catch (err) {
          showCsvStatus('‚ùå Parse error: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
    }

    function downloadFlatTemplate() {
      // Build a template with 2 sample rows (Jan Direct + Jan Online)
      const headers = [
        'month','channel','revenue','cogs','gp_pct','opex','contribution',
        'baseline_revenue','promo_revenue','baseline_gp','promo_gp','promo_cost',
        'prior_revenue','current_revenue','price_effect','volume_effect','mix_effect',
        'discount_pool','start_month','end_month'
      ];
      const rows = [
        {
          month:'Jan', channel:'Direct', revenue:18200, cogs:7644, gp_pct:58, opex:3800, contribution:6756,
          baseline_revenue:50000, promo_revenue:105000, baseline_gp:40, promo_gp:42, promo_cost:4500,
          prior_revenue:120000, current_revenue:168000, price_effect:7.5, volume_effect:18.2, mix_effect:4.3,
          discount_pool:48000, start_month:1, end_month:12
        },
        {
          month:'Jan', channel:'Online', revenue:14500, cogs:5510, gp_pct:62, opex:4200, contribution:4790,
          baseline_revenue:50000, promo_revenue:105000, baseline_gp:40, promo_gp:42, promo_cost:4500,
          prior_revenue:120000, current_revenue:168000, price_effect:7.5, volume_effect:18.2, mix_effect:4.3,
          discount_pool:48000, start_month:1, end_month:12
        }
      ];
      downloadCSV('commercial_sales_template.csv', headers, rows);
    }

    // ========== EXPORT CURRENT DATASET (flat format) ==========

    function exportCurrentDataset() {
      const now = new Date();
      const ts = now.toISOString().slice(0,16).replace('T','_').replace(':','-');
      const mode = dataMode || 'sample';

      // Scalar values from inputs
      const bRev  = parseFloat(document.getElementById('baselineRev').value)  || 0;
      const pRev  = parseFloat(document.getElementById('promoRev').value)     || 0;
      const bGP   = parseFloat(document.getElementById('baselineGP').value)   || 0;
      const pGP   = parseFloat(document.getElementById('promoGP').value)      || 0;
      const pCost = parseFloat(document.getElementById('promoCost').value)     || 0;
      const priorR  = parseFloat(document.getElementById('priorRev').value)    || 0;
      const currR   = parseFloat(document.getElementById('currentRev').value)  || 0;
      const priceE  = parseFloat(document.getElementById('priceEffect').value) || 0;
      const volE    = parseFloat(document.getElementById('volumeEffect').value)|| 0;
      const mixE    = parseFloat(document.getElementById('mixEffect').value)   || 0;
      const pool    = parseFloat(document.getElementById('discountPool').value) || 0;
      const sMonth  = parseInt(document.getElementById('startMonth').value)    || 1;
      const eMonth  = parseInt(document.getElementById('endMonth').value)      || 12;

      const headers = [
        'month','channel','revenue','cogs','gp_pct','opex','contribution',
        'baseline_revenue','promo_revenue','baseline_gp','promo_gp','promo_cost',
        'prior_revenue','current_revenue','price_effect','volume_effect','mix_effect',
        'discount_pool','start_month','end_month'
      ];

      // One row per channel-month; scalars repeated on every row
      const rows = channelData.map(d => ({
        month:            d.month,
        channel:          d.channel,
        revenue:          d.revenue,
        cogs:             d.cogs,
        gp_pct:           d.gp,
        opex:             d.opex,
        contribution:     d.contribution,
        baseline_revenue: bRev,
        promo_revenue:    pRev,
        baseline_gp:      bGP,
        promo_gp:         pGP,
        promo_cost:       pCost,
        prior_revenue:    priorR,
        current_revenue:  currR,
        price_effect:     priceE,
        volume_effect:    volE,
        mix_effect:       mixE,
        discount_pool:    pool,
        start_month:      sMonth,
        end_month:        eMonth
      }));

      downloadCSV(`commercial-sales_${mode}_${ts}.csv`, headers, rows);
    }

    // ========== WSWN EXPLAINERS ==========

    function renderPromoWswn() {
      const el = document.getElementById('promoWswn');
      if (!el) return;
      const baselineRev = parseFloat(document.getElementById('baselineRev').value) || 0;
      const promoRev    = parseFloat(document.getElementById('promoRev').value) || 0;
      const baselineGP  = parseFloat(document.getElementById('baselineGP').value) || 0;
      const promoGP     = parseFloat(document.getElementById('promoGP').value) || 0;
      const promoCost   = parseFloat(document.getElementById('promoCost').value) || 0;
      if (!baselineRev && !promoRev) { el.style.display = 'none'; return; }
      el.style.display = '';

      const baselineGPDollar = baselineRev * (baselineGP / 100);
      const promoGPDollar    = promoRev * (promoGP / 100);
      const incrementalGP    = promoGPDollar - baselineGPDollar;
      const netProfit        = incrementalGP - promoCost;
      const marginDrop       = promoGP - baselineGP;
      const revenueUplift    = promoRev - baselineRev;
      const upliftPct        = baselineRev > 0 ? (revenueUplift / baselineRev * 100) : 0;
      const roi              = promoCost > 0 ? (netProfit / promoCost * 100) : 0;

      // WHAT
      document.getElementById('promoWswnWhat').innerHTML = wrapNumbers(
        `Promo drove ${upliftPct >= 0 ? '+' : ''}${upliftPct.toFixed(1)}% revenue uplift ($${Math.round(revenueUplift).toLocaleString()}). ` +
        `GP% moved from ${baselineGP.toFixed(1)}% to ${promoGP.toFixed(1)}% (${marginDrop >= 0 ? '+' : ''}${marginDrop.toFixed(1)}pp). ` +
        `Net promo profit: ${netProfit >= 0 ? '+' : ''}$${Math.round(netProfit).toLocaleString()} after $${promoCost.toLocaleString()} spend. ROI: ${roi.toFixed(0)}%.`
      );

      // SO WHAT
      let soWhat;
      let promoRisk;
      if (netProfit > 0 && marginDrop >= -5) {
        soWhat = `‚úÖ Healthy outcome. The promo paid for itself ‚Äî margin held within the 5pp threshold and incremental GP ($${Math.round(incrementalGP).toLocaleString()}) more than covered the campaign cost. This profile is repeatable.`;
        promoRisk = 'healthy';
      } else if (netProfit > 0 && marginDrop < -5 && marginDrop >= -10) {
        soWhat = `‚ö†Ô∏è Profitable but margin compressed ${Math.abs(marginDrop).toFixed(1)}pp ‚Äî above the 5pp warning threshold. Revenue grew, but GP% erosion is notable. If discount depth continues at this level across multiple promos, cumulative margin damage will compound.`;
        promoRisk = 'moderate';
      } else if (netProfit <= 0 && marginDrop < -10) {
        soWhat = `üî¥ High Risk. GP% dropped ${Math.abs(marginDrop).toFixed(1)}pp ‚Äî exceeding the 10pp danger threshold. The discount wiped out too much margin, and the $${promoCost.toLocaleString()} campaign cost could not be recovered from incremental profit ($${Math.round(Math.max(0, incrementalGP)).toLocaleString()}). Net loss: $${Math.round(Math.abs(netProfit)).toLocaleString()}.`;
        promoRisk = 'high';
      } else {
        soWhat = `‚ö†Ô∏è Promo lost $${Math.round(Math.abs(netProfit)).toLocaleString()} net. Campaign cost ($${promoCost.toLocaleString()}) exceeded incremental gross profit ($${Math.round(Math.max(0, incrementalGP)).toLocaleString()}). The revenue uplift did not compensate for the spend.`;
        promoRisk = 'moderate';
      }
      document.getElementById('promoWswnSoWhat').innerHTML = wrapNumbers(soWhat);

      // NOW WHAT
      let nowWhat;
      if (netProfit > 0 && marginDrop >= -5) {
        nowWhat = `Scale this promo ‚Äî increase frequency or budget. Track sustained volume after the promo ends to confirm it builds lasting demand, not just a demand pull-forward.`;
      } else if (netProfit > 0 && marginDrop < -5) {
        nowWhat = `Reduce discount depth by 2‚Äì3pp on the next run to see if volume holds. If uplift degrades minimally, you can recover margin significantly. Also check if the same GP result can be achieved with a smaller campaign budget.`;
      } else {
        nowWhat = `Do not repeat at current parameters. Either reduce the discount depth (raise Promo GP%), cut campaign cost, or require a higher qualifying basket/order size. Target: Net Profit > 0 with GP% drop < 5pp.`;
      }
      document.getElementById('promoWswnNowWhat').innerHTML = wrapNumbers(nowWhat);

      // Apply dynamic risk coloring
      applyWswnRisk(
        document.getElementById('promoWswn'),
        document.getElementById('promoWswn') ? document.getElementById('promoWswn').querySelector('.wswn-wrap-header') : null,
        promoRisk, 'üí° Promo ROI Insight'
      );
      boldNowWhat(document.getElementById('promoWswnNowWhat'), promoRisk);
    }

    function renderChannelWswn() {
      const wrap    = document.getElementById('channelWswnWrap');
      const whatEl    = document.getElementById('channelWswnWhat');
      const soWhatEl  = document.getElementById('channelWswnSoWhat');
      const nowWhatEl = document.getElementById('channelWswnNowWhat');
      if (!whatEl || !channelData || !channelData.length) {
        if (wrap) wrap.style.display = 'none';
        return;
      }

      const monthFilter   = document.getElementById('channelMonthFilter').value;
      const channelFilter = document.getElementById('channelFilter').value;
      const filtered = channelData.filter(d => {
        if (monthFilter !== 'all' && d.month !== monthFilter) return false;
        if (channelFilter !== 'all' && d.channel !== channelFilter) return false;
        return true;
      });
      if (!filtered.length) {
        if (wrap) wrap.style.display = 'none';
        return;
      }
      if (wrap) wrap.style.display = '';

      const channels = [...new Set(filtered.map(d => d.channel))];
      const channelStats = channels.map(ch => {
        const rows = filtered.filter(d => d.channel === ch);
        const rev  = rows.reduce((s, d) => s + parseFloat(d.revenue), 0);
        const gp   = rows.reduce((s, d) => s + parseFloat(d.gp) * parseFloat(d.revenue), 0) / rev;
        const contrib = rows.reduce((s, d) => s + parseFloat(d.contribution), 0);
        return { ch, rev, gp, contrib };
      }).sort((a, b) => b.rev - a.rev);

      const totalRev   = channelStats.reduce((s, c) => s + c.rev, 0);
      const topChannel = channelStats[0];
      const topShare   = totalRev > 0 ? (topChannel.rev / totalRev * 100) : 0;
      const avgGP      = channelStats.reduce((s, c) => s + c.gp * c.rev, 0) / totalRev;
      const negContrib = channelStats.filter(c => c.contrib < 0);

      const viewLabel = monthFilter !== 'all' ? monthFilter : (channelFilter !== 'all' ? channelFilter : 'all channels / all months');

      whatEl.innerHTML = wrapNumbers(
        `Showing ${viewLabel}: ${channels.length} channel${channels.length > 1 ? 's' : ''} with total revenue $${Math.round(totalRev).toLocaleString()}. ` +
        `Blended GP%: ${avgGP.toFixed(1)}%. Top channel: ${topChannel.ch} (${topShare.toFixed(0)}% of revenue).`
      );

      let channelRisk;
      if (negContrib.length > 0) {
        soWhatEl.innerHTML = wrapNumbers(`üî¥ ${negContrib.map(c => c.ch).join(', ')} ${negContrib.length > 1 ? 'are' : 'is'} contribution-negative ‚Äî revenue is not covering COGS + OpEx. ` +
          `${topShare > 70 ? `Also: ${topChannel.ch} drives ${topShare.toFixed(0)}% of revenue ‚Äî dangerous concentration risk if this channel softens.` : ''}` +
          ` Average GP% of ${avgGP.toFixed(1)}% is ${avgGP >= 40 ? 'healthy' : avgGP >= 30 ? 'below 40% target ‚Äî at risk' : 'below 30% ‚Äî high risk, scaling will worsen losses'}.`);
        channelRisk = 'high';
      } else if (topShare > 70) {
        soWhatEl.innerHTML = wrapNumbers(`‚ö†Ô∏è All channels are contribution-positive (healthy). However, ${topChannel.ch} drives ${topShare.toFixed(0)}% of revenue ‚Äî high concentration. If this channel faces pricing pressure or a buyer pullback, the entire P&L is exposed.`);
        channelRisk = 'moderate';
      } else {
        soWhatEl.innerHTML = wrapNumbers(`‚úÖ All channels profitable with diversified revenue. GP% of ${avgGP.toFixed(1)}% is ${avgGP >= 40 ? 'above the 40% healthy threshold' : 'approaching the 40% threshold ‚Äî monitor COGS trends'}. No immediate concerns.`);
        channelRisk = 'healthy';
      }

      if (negContrib.length > 0) {
        nowWhatEl.innerHTML = wrapNumbers(`Investigate ${negContrib.map(c => c.ch).join(', ')} ‚Äî either raise channel pricing, reduce allocated OpEx, or exit if the channel cannot reach contribution breakeven. Run PVM decomposition on these channels before cutting to confirm the issue is structural.`);
      } else if (topShare > 70) {
        nowWhatEl.innerHTML = wrapNumbers(`Invest in building out the #2 and #3 channels to reduce concentration risk. Set a target: no single channel above 50% of revenue within 3 quarters.`);
      } else {
        nowWhatEl.innerHTML = wrapNumbers(`Maintain channel mix discipline. Re-run this view monthly to catch early GP% erosion ‚Äî small COGS or OpEx creep is easier to correct before it compounds.`);
      }

      // Apply dynamic risk colors
      const channelHeader = wrap ? wrap.querySelector('.wswn-wrap-header') : null;
      applyWswnRisk(wrap, channelHeader, channelRisk, 'üí° Channel Performance Insight');
      boldNowWhat(nowWhatEl, channelRisk);
    }

    function renderAccrualWswn() {
      const el = document.getElementById('accrualWswn');
      if (!el) return;
      const pool  = parseFloat(document.getElementById('discountPool').value) || 0;
      const start = parseInt(document.getElementById('startMonth').value) || 1;
      const end   = parseInt(document.getElementById('endMonth').value) || 12;
      if (!pool) { el.style.display = 'none'; return; }
      el.style.display = '';

      const numMonths    = Math.max(1, end - start + 1);
      const monthlyAccr  = pool / numMonths;
      const monthNames   = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const spanLabel    = numMonths === 12 ? 'full year' : `${monthNames[start-1]}‚Äì${monthNames[end-1]} (${numMonths} months)`;

      document.getElementById('accrualWswnWhat').innerHTML = wrapNumbers(
        `$${Math.round(pool).toLocaleString()} total discount pool spread evenly over ${spanLabel}. ` +
        `Monthly accrual: $${Math.round(monthlyAccr).toLocaleString()}/mo. ${12 - numMonths} months have zero accrual.`
      );

      let soWhat;
      let accrualRisk;
      if (numMonths >= 6) {
        soWhat = `‚úÖ Healthy spread. The pool is distributed over ${numMonths} months, keeping monthly P&L impact manageable at $${Math.round(monthlyAccr).toLocaleString()}/mo. Straight-line accrual prevents any single month from absorbing a disproportionate charge.`;
        accrualRisk = 'healthy';
      } else if (numMonths >= 3) {
        soWhat = `‚ö†Ô∏è Moderate concentration ‚Äî ${numMonths} months is workable but each month absorbs $${Math.round(monthlyAccr).toLocaleString()}. If the deal period aligns with a soft revenue month, that period's P&L may look temporarily weak. Flag for FP&A commentary.`;
        accrualRisk = 'moderate';
      } else {
        soWhat = `üî¥ High Accrual Risk. The entire $${Math.round(pool).toLocaleString()} pool hits in ${numMonths === 1 ? 'a single month' : numMonths + ' months'}, creating a spike of $${Math.round(monthlyAccr).toLocaleString()}/mo. This will distort the P&L for those months and may trigger audit questions or forecasting confusion without clear accrual documentation.`;
        accrualRisk = 'high';
      }
      document.getElementById('accrualWswnSoWhat').innerHTML = wrapNumbers(soWhat);

      let nowWhat;
      if (numMonths >= 6) {
        nowWhat = `Ensure the accrual journal entry is posted monthly so no catch-up adjustments are needed at quarter-end. Reconcile cumulative accrual vs. actual cash paid at deal settlement.`;
      } else if (numMonths >= 3) {
        nowWhat = `Add a footnote to the P&L for each accrual month explaining the charge. Confirm the deal end date is firm ‚Äî if the deal extends, the accrual schedule must be updated immediately to avoid over-accruing.`;
      } else {
        nowWhat = `Consider negotiating the deal to span a longer period, or document the spike clearly in the board/management pack. If possible, restructure the trade terms to spread the spend over 6+ months for cleaner P&L presentation.`;
      }
      document.getElementById('accrualWswnNowWhat').innerHTML = wrapNumbers(nowWhat);

      // Apply dynamic risk colors
      applyWswnRisk(el, el ? el.querySelector('.wswn-wrap-header') : null, accrualRisk, 'üí° Accrual Schedule Insight');
      boldNowWhat(document.getElementById('accrualWswnNowWhat'), accrualRisk);
    }

    // ========== WORST CASE DEMO ==========
    // Sets all inputs to their most extreme negative values to showcase high-risk states
    function loadWorstCase() {
      withStableScroll(function() {
        dataMode = 'sample';
        document.getElementById('dataModeBadge').textContent = 'WORST CASE';
        document.getElementById('dataModeBadge').style.background = 'rgba(220,38,38,0.12)';
        document.getElementById('dataModeBadge').style.borderColor = 'rgba(220,38,38,0.30)';
        document.getElementById('dataModeBadge').style.color = '#dc2626';
        _setSampleBtnState();

        // Section 1: Promo ‚Äî devastating loss scenario
        document.getElementById('baselineRev').value  = 80000;
        document.getElementById('promoRev').value     = 90000;   // very small volume uplift
        document.getElementById('baselineGP').value   = 45;
        document.getElementById('promoGP').value      = 14;      // GP% craters: -31pp
        document.getElementById('promoCost').value    = 28000;   // massive spend

        // Section 3: PVM ‚Äî all three drivers negative
        document.getElementById('priorRev').value     = 200000;
        document.getElementById('currentRev').value   = 148000;  // -26% decline
        document.getElementById('priceEffect').value  = -8.5;
        document.getElementById('volumeEffect').value = -12.3;
        document.getElementById('mixEffect').value    = -4.7;

        // Section 4: Accrual ‚Äî single-month spike
        document.getElementById('discountPool').value = 72000;
        document.getElementById('startMonth').value   = 6;
        document.getElementById('endMonth').value     = 6;       // all in one month

        // Section 2: Channel data ‚Äî manufacture worst-case channel P&L
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const channels = ['Direct','Online','Retail','Partner','Enterprise'];
        channelData = [];
        months.forEach(month => {
          channels.forEach(channel => {
            const revenue = Math.round(5000 + Math.random() * 8000);
            const cogsPct = 0.72 + Math.random() * 0.15;  // very high COGS 72‚Äì87%
            const cogs = revenue * cogsPct;
            const opex = 4000 + Math.random() * 4000;     // heavy opex
            channelData.push({
              month, channel,
              revenue: revenue.toFixed(2),
              cogs: cogs.toFixed(2),
              opex: opex.toFixed(2),
              gp: ((revenue - cogs) / revenue * 100).toFixed(1),
              contribution: (revenue - cogs - opex).toFixed(2)
            });
          });
        });

        populateChannelFilters();
        renderAll();
      });
    }

    // ========== PLAYBOOK TOGGLE ==========
    function togglePlaybook() {
      var body = document.getElementById('playbookBody');
      var btn  = document.getElementById('playbookToggleBtn');
      var chev = document.getElementById('playbookChevron');
      if (!body) return;
      var isOpen = body.style.display !== 'none';
      if (isOpen) {
        body.style.display = 'none';
        btn.setAttribute('aria-expanded','false');
        chev.style.transform = 'rotate(180deg)';
        var hint = btn.querySelector('.playbook-hint');
        if (hint) hint.textContent = 'Click to expand';
      } else {
        body.style.display = '';
        btn.setAttribute('aria-expanded','true');
        chev.style.transform = '';
        var hint = btn.querySelector('.playbook-hint');
        if (hint) hint.textContent = 'Click to collapse';
      }
    }

    // ========== RENDER ALL ==========
    
    function renderAll() {
      computePromoROI();        // builds promo KPIs + promo WSWN (no channel dependency)
      populateChannelFilters();
      renderChannelPL();        // builds channelData into table + channel WSWN
      computePVM();
      computeAccrual();
      renderChannelWswn();
      renderAccrualWswn();
      renderPromoDecisionBox(); // called last so channelData is fully populated for subtitle
    }
    
    // ========== INIT ==========
    
    window.addEventListener('DOMContentLoaded', () => {
      // Pre-load the winning promo sample so the module is ready to use immediately
      _setSampleBtnState();
      document.getElementById('baselineRev').value  = 50000;
      document.getElementById('promoRev').value     = 105000;
      document.getElementById('baselineGP').value   = 40;
      document.getElementById('promoGP').value      = 42;
      document.getElementById('promoCost').value    = 4500;
      document.getElementById('priorRev').value     = 120000;
      document.getElementById('currentRev').value   = 168000;
      document.getElementById('priceEffect').value  = 7.5;
      document.getElementById('volumeEffect').value = 18.2;
      document.getElementById('mixEffect').value    = 4.3;
      document.getElementById('discountPool').value = 48000;
      document.getElementById('startMonth').value   = 1;
      document.getElementById('endMonth').value     = 12;
      _buildChannelData();
      populateChannelFilters();
      renderAll();
    });
  
    /* ‚îÄ‚îÄ Sidebar accordion: one section open at a time ‚îÄ‚îÄ */
    function sidebarAccordion(headerEl) {
      var sidebar = headerEl.closest('.sidebar');
      var allHeaders = sidebar.querySelectorAll('.sb-acc-header');
      allHeaders.forEach(function(h) {
        if (h === headerEl) return;
        h.classList.remove('open');
        var b = h.nextElementSibling;
        if (b && b.classList.contains('sb-acc-body')) b.classList.remove('open');
      });
      headerEl.classList.toggle('open');
      var body = headerEl.nextElementSibling;
      if (body && body.classList.contains('sb-acc-body')) body.classList.toggle('open');
    }


    /* Mobile sidebar toggle */
    (function() {
      var btn = document.getElementById('mobileControlsBtn');
      var sb  = document.querySelector('.sidebar');
      if (!btn || !sb) return;
      btn.addEventListener('click', function() {
        var open = sb.classList.toggle('mobile-open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    })();


    /* ‚îÄ‚îÄ Body-level tooltip engine (fixes sidebar overflow clipping) ‚îÄ‚îÄ */
    function initTooltips() {
      var ttEl = document.getElementById('tt-root');
      if (!ttEl) {
        ttEl = document.createElement('div');
        ttEl.id = 'tt-root';
        document.body.appendChild(ttEl);
      }

      var hideTimer = null;
      var activeEl = null;

      function show(text, targetEl) {
        clearTimeout(hideTimer);
        activeEl = targetEl;
        ttEl.textContent = text;
        ttEl.classList.add('tt-visible');
        position(targetEl);
      }

      function hide() {
        hideTimer = setTimeout(function() {
          ttEl.classList.remove('tt-visible');
          activeEl = null;
        }, 80);
      }

      function position(el) {
        var rect = el.getBoundingClientRect();
        var ttW = 270;
        var gap = 8;
        // Horizontal: center on element, clamp to viewport
        var left = rect.left + rect.width / 2 - ttW / 2;
        left = Math.max(12, Math.min(left, window.innerWidth - ttW - 12));
        ttEl.style.width = ttW + 'px';
        ttEl.style.left = left + 'px';
        // Vertical: show above by default, flip below if too close to top
        var ttH = ttEl.offsetHeight || 60;
        var top;
        if (rect.top - ttH - gap - 8 < 0) {
          top = rect.bottom + gap;
        } else {
          top = rect.top - ttH - gap;
        }
        ttEl.style.top = top + 'px';
        ttEl.style.position = 'fixed';
        ttEl.style.transform = 'none';
      }

      /* Kill CSS ::after tooltips ‚Äî they clip in overflow containers */
      var killStyle = document.createElement('style');
      killStyle.textContent = '.help-icon::after,.help-icon:hover::after,[data-help]::after,[data-tt]::after,.term-helper::after,.term-helper:hover::after{content:none!important;display:none!important;}';
      document.head.appendChild(killStyle);

      /* Desktop: mouse events (event delegation) */
      document.addEventListener('mouseover', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (!el) return;
        var text = el.getAttribute('data-help') || el.getAttribute('data-tt');
        if (text && text !== 'Loading...') show(text, el);
      });

      document.addEventListener('mouseout', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (el) hide();
      });

      /* Mobile: tap to toggle */
      document.addEventListener('click', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (!el) {
          if (ttEl.classList.contains('tt-visible')) {
            ttEl.classList.remove('tt-visible');
            activeEl = null;
          }
          return;
        }
        var text = el.getAttribute('data-help') || el.getAttribute('data-tt');
        if (!text || text === 'Loading...') return;
        if (activeEl === el && ttEl.classList.contains('tt-visible')) {
          ttEl.classList.remove('tt-visible');
          activeEl = null;
        } else {
          show(text, el);
        }
        e.stopPropagation();
      });

      /* Reposition on scroll */
      window.addEventListener('scroll', function() {
        if (activeEl && ttEl.classList.contains('tt-visible')) {
          position(activeEl);
        }
      }, { passive: true });

      /* Hide on resize */
      window.addEventListener('resize', function() {
        ttEl.classList.remove('tt-visible');
        activeEl = null;
      }, { passive: true });
    }

    // ‚îÄ‚îÄ Call tooltip engine on page load ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', function() {
      initTooltips();
      // Create issues popover element
      var pop = document.createElement('div');
      pop.id = 'issuesPopover';
      pop.innerHTML = '<div class="pop-header"><span>‚ö† Issues Requiring Attention</span><button class="pop-close" onclick="closeIssuesPopover()">‚úï</button></div><div class="pop-body" id="issuesPopoverBody"></div>';
      document.body.appendChild(pop);
      // Close popover when clicking outside
      document.addEventListener('click', function(e) {
        var p = document.getElementById('issuesPopover');
        if (!p) return;
        if (!p.contains(e.target) && !e.target.closest('.issues-trigger')) {
          p.classList.remove('pop-visible');
        }
      });
    });

    var _issuesPopoverOpen = false;
    function toggleIssuesPopover(event, triggerEl) {
      event.stopPropagation();
      var pop = document.getElementById('issuesPopover');
      var body = document.getElementById('issuesPopoverBody');
      if (!pop || !body) return;
      // Build issue rows
      var issues = window._decisionIssues || [];
      if (!issues.length) { pop.classList.remove('pop-visible'); return; }
      body.innerHTML = issues.map(function(issue) {
        return '<div class="pop-issue-row">' +
          '<div class="pop-issue-icon ' + issue.sev + '">' + (issue.sev === 'red' ? '!' : '~') + '</div>' +
          '<div><div class="pop-issue-label">' + issue.label + '</div>' +
          '<div class="pop-issue-desc">' + issue.desc + '</div></div>' +
          '</div>';
      }).join('');
      // Position near trigger
      if (pop.classList.contains('pop-visible')) {
        pop.classList.remove('pop-visible');
        return;
      }
      pop.classList.add('pop-visible');
      var rect = triggerEl.getBoundingClientRect();
      var popW = 320;
      var left = rect.left;
      if (left + popW > window.innerWidth - 12) left = window.innerWidth - popW - 12;
      left = Math.max(12, left);
      var top = rect.bottom + 8;
      if (top + 200 > window.innerHeight) top = rect.top - 8 - pop.offsetHeight;
      pop.style.left = left + 'px';
      pop.style.top  = top + 'px';
    }
    function closeIssuesPopover() {
      var pop = document.getElementById('issuesPopover');
      if (pop) pop.classList.remove('pop-visible');
    }

</script>

<script>
/* Global Time Ticker */
(function(){
  var R=[{l:'APAC',t:'Asia/Singapore'},{l:'EMEA',t:'Europe/London'},{l:'USA',t:'America/New_York'},{l:'LATAM',t:'America/Sao_Paulo'}];
  var WS=6,WN=17,WE=18;
  function fmt(tz){return new Intl.DateTimeFormat('en-US',{timeZone:tz,hour:'numeric',minute:'2-digit',hour12:true}).format(new Date())}
  function hm(tz){var p=new Intl.DateTimeFormat('en-US',{timeZone:tz,hour:'numeric',minute:'2-digit',hour12:false}).formatToParts(new Date()),h=0,m=0;p.forEach(function(x){if(x.type==='hour')h=+x.value;if(x.type==='minute')m=+x.value});return{h:h||0,m:m||0}}
  function st(tz){var h=hm(tz).h;return h>=WS&&h<WN?'active':h===WN?'ending':'offline'}
  function wake(tz){var x=hm(tz),d=WS*60-(x.h*60+x.m);return d<=0?d+1440:d}
  function slp(tz){var x=hm(tz);return Math.max(0,WE*60-(x.h*60+x.m))}
  function dur(m){var h=Math.floor(m/60),n=m%60;return h===0?n+'m':n===0?h+'h':h+'h '+n+'m'}
  function bestWin(ltz){
    var now=new Date(),s=new Date(now);s.setUTCMinutes(0,0,0);s.setUTCHours(s.getUTCHours()+1);
    var bu=null,bc=0;
    for(var i=0;i<48;i++){
      var pr=new Date(s.getTime()+i*3600000),iw=0;
      R.forEach(function(r){var p=new Intl.DateTimeFormat('en-US',{timeZone:r.t,hour:'numeric',hour12:false}).formatToParts(pr),h=0;p.forEach(function(x){if(x.type==='hour')h=+x.value});if(h>=WS&&h<WE)iw++});
      if(iw>bc){bc=iw;bu=pr}
      if(bc===R.length)break;
    }
    if(!bu||bc<2)return null;
    var e=new Date(bu.getTime()+7200000),o={timeZone:ltz,hour:'numeric',minute:'2-digit',hour12:true};
    var t1=new Intl.DateTimeFormat('en-US',o).format(bu),t2=new Intl.DateTimeFormat('en-US',o).format(e);
    var fd={timeZone:ltz,year:'numeric',month:'2-digit',day:'2-digit'};
    var tm=new Intl.DateTimeFormat('en-US',fd).format(now)!==new Intl.DateTimeFormat('en-US',fd).format(bu)?' (tom)':'';
    return{time:t1+'‚Äì'+t2+tm,count:bc}
  }
  function render(){
    var el=document.getElementById('tz-ticker-items');if(!el)return;
    var ltz=Intl.DateTimeFormat().resolvedOptions().timeZone,h='';
    h+='<span class="tz-ticker-item"><span class="tz-ticker-item-label">You</span><span class="tz-ticker-item-value" style="font-weight:700">'+fmt(ltz)+'</span></span>';
    R.forEach(function(r){
      var s=st(r.t),dc=s==='active'?'tk-active':s==='ending'?'tk-ending':'tk-offline',vt;
      if(s==='active'){var ml=slp(r.t);vt=ml<180?'Active ¬∑ ends '+dur(ml):'Active'}
      else if(s==='ending')vt='Ending ¬∑ '+dur(slp(r.t));
      else vt='Online '+dur(wake(r.t));
      h+='<span class="tz-ticker-item"><span class="tz-ticker-dot '+dc+'"></span><span class="tz-ticker-item-label">'+r.l+'</span><span class="tz-ticker-item-value '+dc+'">'+vt+'</span></span>';
    });
    var w=bestWin(ltz),wt=w?w.time.split('(')[0].trim(): '‚Äî';
    h+='<span class="tz-ticker-item"><span class="tz-ticker-item-label">Best window</span><span class="tz-ticker-item-value tk-window">'+wt+'</span></span>';
    el.innerHTML=h;
  }
  function init(){
    var hdr=document.querySelector('.site-header')||document.querySelector('header');
    document.documentElement.style.setProperty('--nav-h',(hdr?hdr.offsetHeight:56)+'px');
    window.addEventListener('resize',function(){var h2=document.querySelector('.site-header')||document.querySelector('header');document.documentElement.style.setProperty('--nav-h',(h2?h2.offsetHeight:56)+'px')});
    render();setInterval(render,30000);
  }
  document.readyState==='loading'?document.addEventListener('DOMContentLoaded',init):init();
})();
</script>
</body>
</html>

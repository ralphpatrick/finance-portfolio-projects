<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Commercial / Sales Finance Model ¬∑ FP&A Portfolio</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    /* Prevent horizontal overflow */
    html, body { overflow-x: clip; }

    /* Module-specific styles */
    .module-hero {
      padding: 48px 0 32px 0;
      border-bottom: 1px solid var(--border);
    }
    .module-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
    }
    .module-title {
      font-size: 36px;
      line-height: 1.1;
      letter-spacing: -0.03em;
      margin-bottom: 10px;
    }
    .module-pill {
      display: inline-flex;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(246,248,251,0.8);
      color: var(--text);
      margin-bottom: 12px;
    }
    .module-subtitle {
      font-size: 16px;
      color: var(--muted);
      margin-bottom: 16px;
    }
    .module-problem {
      font-size: 15px;
      color: var(--text);
      font-weight: 520;
      max-width: 68ch;
      margin-bottom: 12px;
    }
    .module-role {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 14px;
    }
    .feature-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
    }
    .chip {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(246,248,251,0.8);
      color: var(--text);
    }
    
    /* Main layout with sidebar */
    .module-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      align-items: start;
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    
    /* Sticky sidebar */
    .sidebar {
      position: sticky;
      top: 80px;
      padding: 20px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
    }
    .sidebar-section {
      margin-bottom: 24px;
    }
    .sidebar-section:last-child {
      margin-bottom: 0;
    }
    .sidebar-title {
      font-size: 13px;
      font-weight: 650;
      color: var(--text);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .data-badge {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15,118,110,0.10);
      border: 1px solid rgba(15,118,110,0.20);
      color: var(--accent);
      font-weight: 600;
      display: inline-block;
      margin-bottom: 12px;
    }
    .sidebar-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    /* Main content area */
    .main-content {
      min-width: 0;
    }
    
    /* Module sections */
    .module-section {
      padding: 0 0 48px 0;
    }
    .module-section-title {
      font-size: 24px;
      margin-bottom: 20px;
      letter-spacing: -0.02em;
    }
    .module-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-soft);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .card-title {
      font-size: 18px;
      font-weight: 650;
    }
    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* Buttons */
    .btn-small {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 999px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 140ms ease;
      white-space: nowrap;
    }
    .btn-small:hover {
      border-color: rgba(12, 23, 45, 0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.06);
    }
    .btn-small:active {
      transform: translateY(1px);
    }
    .btn-primary {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }
    .btn-primary:hover {
      box-shadow: 0 6px 18px rgba(11,18,32,0.12);
    }
    .btn-full {
      width: 100%;
      justify-content: center;
      display: flex;
    }
    
    /* KPI grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .kpi-box {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: rgba(246,248,251,0.6);
    }
    .kpi-box-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .kpi-box-value {
      font-size: 20px;
      font-weight: 650;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin: 16px 0;
    }
    .data-table th {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 2px solid var(--border);
      font-weight: 650;
      color: var(--text);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .data-table tr:last-child td {
      border-bottom: none;
    }
    .data-table tr:hover {
      background: rgba(246,248,251,0.5);
    }
    
    /* Charts */
    .chart-container { overflow-anchor: none;
      margin: 20px 0;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .chart-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 16px;
      color: var(--text);
    }
    .chart-canvas {
      display: block;
      width: 100%;
      height: auto;
    }
    
    /* Input grid */
    .input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
      margin-bottom: 20px;
    }
    .input-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .input-field label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }
    .input-field input {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px;
      font-family: var(--font-sans);
      background: white;
    }
    .input-field input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* File upload */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    /* Demo section */
    .demo-section {
      padding: 32px 0;
      border-top: 1px solid var(--border);
    }
    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
    }
    .demo-card {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .demo-card-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 8px;
    }
    .demo-card-text {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    
    /* Tooltips */
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
      border-bottom: 1px dotted var(--muted);
    }
    .tooltip:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 12px;
      background: var(--text);
      color: white;
      font-size: 12px;
      border-radius: 8px;
      white-space: nowrap;
      z-index: 100;
      margin-bottom: 6px;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .module-layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: relative;
        top: 0;
      }
      .sidebar-buttons {
        flex-direction: row;
        flex-wrap: wrap;
      }
    }

    /* ---- Decision Box ---- */
    .decision-box {
      background: white;
      border: 1.5px solid var(--accent);
      border-radius: var(--radius);
      padding: 20px 24px;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.08), var(--shadow-soft);
      margin-bottom: 24px;
      transition: border-color 200ms ease, box-shadow 200ms ease, background 200ms ease;
    }
    /* Positive ‚Äî green */
    .decision-box--positive {
      border-color: #0f766e;
      background: #f0fdf9;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.10), var(--shadow-soft);
    }
    .decision-box--positive .decision-box-eyebrow { color: #0f766e; }
    .decision-box--positive .verdict-action        { color: #0f766e; }
    .decision-box--positive .decision-box-bullets li::before { color: #0f766e; }
    /* Negative ‚Äî red */
    .decision-box--negative {
      border-color: #dc2626;
      background: #fef2f2;
      box-shadow: 0 0 0 4px rgba(220,38,38,0.10), var(--shadow-soft);
    }
    .decision-box--negative .decision-box-eyebrow { color: #dc2626; }
    .decision-box--negative .verdict-action        { color: #dc2626; }
    .decision-box--negative .decision-box-bullets li::before { color: #dc2626; }
    .decision-box-eyebrow {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--accent);
      margin-bottom: 8px;
    }
    .decision-box-verdict {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
      margin-bottom: 12px;
    }
    .decision-box-verdict .verdict-action {
      color: var(--accent);
    }
    .decision-box-bullets {
      list-style: none;
      margin: 0 0 10px 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .decision-box-bullets li {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: flex-start;
      gap: 8px;
      line-height: 1.4;
    }
    .decision-box-bullets li::before {
      content: '‚Ä∫';
      color: var(--accent);
      font-weight: 700;
      flex-shrink: 0;
    }
    .decision-box-next {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }
    .decision-box-next span {
      color: var(--accent-2);
    }
    .decision-box-fallback {
      font-size: 14px;
      color: var(--muted);
      font-style: italic;
    }
      .main-content { overflow-anchor: none; }
    .module-card { overflow-anchor: none; }
    .data-table { overflow-anchor: none; }
  
    /* ‚îÄ‚îÄ Data-needed strip ‚îÄ‚îÄ */
    .data-needed-section {
      padding: 0 0 0 0;
      border-bottom: 1px solid var(--border, #e5e8ef);
    }
    .data-needed-wrap {
      max-width: var(--max-w, 1200px);
      margin: 0 auto;
      padding: 20px 32px 24px;
    }
    .data-needed-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--muted, #6b7280);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .data-needed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(185px, 1fr));
      gap: 8px;
    }
    .data-needed-item {
      padding: 10px 12px;
      border: 1px solid var(--border, #e5e8ef);
      border-radius: 9px;
      display: flex;
      align-items: flex-start;
      gap: 9px;
      background: #fafbfc;
    }
    .data-needed-icon {
      width: 26px;
      height: 26px;
      font-size: 13px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .data-needed-name {
      font-size: 11px;
      font-weight: 700;
      color: var(--text, #0b1220);
      margin-bottom: 3px;
      line-height: 1.35;
    }
    .data-needed-desc {
      font-size: 10px;
      color: var(--muted, #6b7280);
      line-height: 1.5;
    }

</style>
</head>
<body>

  <a href="#main-content" class="skip-link">Skip to content</a>

  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html" class="brand">
          <span class="brand-mark" aria-hidden="true"></span>
          FP&A Portfolio
        </a>
        <div class="nav-cta">
          <a href="index.html#card-commercial-sales" class="btn btn-ghost">‚Üê Back to Portfolio</a>
        </div>
      </nav>
    </div>
  </header>

  <main id="main-content">
    
    <!-- Hero -->
    <section class="module-hero">
      <div class="container">
        <div class="module-label">Revenue-decision support</div>
        <h1 class="module-title">Commercial / Sales Finance Model</h1>
        <div class="module-pill">Commercial</div>
        <p class="module-subtitle">Evaluating revenue decisions beyond top-line growth.</p>
        <p class="module-problem">Go beyond "more revenue = good" and answer: what's the true margin impact, volume/mix risk, and P&L reality?</p>
        <p class="module-role">Sales Finance ‚Ä¢ Commercial Finance ‚Ä¢ Revenue Analytics</p>
        <div class="feature-chips">
          <span class="chip">Promotion ROI (pre/post)</span>
          <span class="chip">Channel-level P&L</span>
          <span class="chip">Price/Volume/Mix</span>
          <span class="chip">Discount & accrual logic</span>
        </div>
      </div>
    </section>

  <!-- DATA NEEDED STRIP -->
  <div class="data-needed-section">
    <div class="data-needed-wrap">
      <div class="data-needed-label">üìÇ &nbsp;Data needed for this module</div>
      <div class="data-needed-grid">
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#eff6ff;">üìä</div><div><div class="data-needed-name">Channel P&L Report</div><div class="data-needed-desc">Revenue &amp; cost broken out by sales channel ‚Üí drives margin analysis</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#f0fdf9;">üè∑Ô∏è</div><div><div class="data-needed-name">Pricing &amp; Rate Cards</div><div class="data-needed-desc">List prices, discount tiers &amp; promotional rates ‚Üí price/volume/mix</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#fef3c7;">üìã</div><div><div class="data-needed-name">Promotion Log</div><div class="data-needed-desc">Past and current promo details &amp; spend ‚Üí measures ROI pre/post</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#f5f3ff;">üí∞</div><div><div class="data-needed-name">Accrual Schedule</div><div class="data-needed-desc">Trade spend accruals &amp; settlements ‚Üí keeps P&L from being misstated</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#fdf2f8;">üìÑ</div><div><div class="data-needed-name">Sales Order Data</div><div class="data-needed-desc">Volume sold per SKU/channel by period ‚Üí quantity &amp; mix drivers</div></div></div>
      </div>
    </div>
  </div>

    <!-- Main Layout with Sidebar -->
    <div class="module-layout">
      
      <!-- Sticky Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-section">
          <div class="sidebar-title">Data Mode</div>
          <div class="data-badge" id="dataModeBadge">Sample Data</div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-title">Actions</div>
          <div class="sidebar-buttons">
            <button onclick="useSampleData()" class="btn-small btn-full">Use Sample</button>
            <button onclick="randomizeSampleData()" class="btn-small btn-primary btn-full">üé≤ Generate Random</button>
            <button onclick="downloadAllTemplates()" class="btn-small btn-full">Download Templates</button>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <div class="main-content">

        <!-- Promotion ROI Analysis -->
        <section class="module-section">
          <h2 class="module-section-title">1. Promotion ROI Analysis</h2>

          <!-- DECISION BOX: pinned at top of Promo ROI -->
          <div class="decision-box" id="promoDecisionBox" aria-label="Promo ROI Decision">
            <div class="decision-box-eyebrow">Decision</div>
            <div class="decision-box-fallback" id="promoDecisionFallback">Load sample or upload data to see the decision.</div>
            <div id="promoDecisionContent" style="display:none;">
              <div class="decision-box-verdict" id="promoDecisionVerdict"></div>
              <ul class="decision-box-bullets" id="promoDecisionBullets"></ul>
              <div class="decision-box-next" id="promoDecisionNext"></div>
            </div>
          </div>
          
          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">Before / After Comparison</h3>
              <div class="card-actions">
                <button onclick="downloadPromoCSV()" class="btn-small">Export Results</button>
                <button onclick="downloadPromoTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="promoUpload" accept=".csv" onchange="handlePromoUpload(event)">
                </div>
              </div>
            </div>

            <div class="input-grid">
              <div class="input-field">
                <label>Baseline Revenue</label>
                <input type="number" id="baselineRev" value="50000" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Promo Revenue</label>
                <input type="number" id="promoRev" value="85000" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Baseline GP%</label>
                <input type="number" step="0.1" id="baselineGP" value="42" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Promo GP%</label>
                <input type="number" step="0.1" id="promoGP" value="28" onchange="withStableScroll(computePromoROI)">
              </div>
              <div class="input-field">
                <label>Promo Cost</label>
                <input type="number" id="promoCost" value="12000" onchange="withStableScroll(computePromoROI)">
              </div>
            </div>

            <div class="kpi-grid" id="promoKPIs">
              <!-- KPIs populated by JS -->
            </div>

            <div style="overflow-x:auto;"><table class="data-table" id="promoTable">
              <!-- Table populated by JS -->
            </table></div>
          </div>
        </section>

        <!-- Channel P&L -->
        <section class="module-section">
          <h2 class="module-section-title">2. Channel-level P&L</h2>
          
          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">12-Month Channel Performance</h3>
              <div class="card-actions">
                <label>Month:</label>
                <select id="channelMonthFilter" onchange="withStableScroll(renderChannelPL)">
                  <option value="all">All Months</option>
                </select>
                <label>Channel:</label>
                <select id="channelFilter" onchange="withStableScroll(renderChannelPL)">
                  <option value="all">All Channels</option>
                </select>
                <button onclick="downloadChannelCSV()" class="btn-small">Export Data</button>
                <button onclick="downloadChannelTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="channelUpload" accept=".csv" onchange="handleChannelUpload(event)">
                </div>
              </div>
            </div>

            <div class="chart-container">
              <div class="chart-title">Revenue by Channel</div>
              <canvas id="channelChart" class="chart-canvas"></canvas>
            </div>

            <div style="overflow-x:auto;"><table class="data-table" id="channelTable">
              <!-- Table populated by JS -->
            </table></div>
          </div>
        </section>

        <!-- Price/Volume/Mix Bridge -->
        <section class="module-section">
          <h2 class="module-section-title">3. Price / Volume / Mix Bridge</h2>
          
          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">Revenue Variance Decomposition</h3>
              <div class="card-actions">
                <button onclick="downloadPVMCSV()" class="btn-small">Export Analysis</button>
                <button onclick="downloadPVMTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="pvmUpload" accept=".csv" onchange="handlePVMUpload(event)">
                </div>
              </div>
            </div>

            <div class="input-grid">
              <div class="input-field">
                <label>Prior Period Revenue</label>
                <input type="number" id="priorRev" value="120000" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Current Period Revenue</label>
                <input type="number" id="currentRev" value="138000" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Price Effect (%)</label>
                <input type="number" step="0.1" id="priceEffect" value="5.2" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Volume Effect (%)</label>
                <input type="number" step="0.1" id="volumeEffect" value="8.5" onchange="computePVM()">
              </div>
              <div class="input-field">
                <label>Mix Effect (%)</label>
                <input type="number" step="0.1" id="mixEffect" value="1.3" onchange="computePVM()">
              </div>
            </div>

            <div class="kpi-grid" id="pvmKPIs">
              <!-- KPIs populated by JS -->
            </div>

            <div class="chart-container">
              <div class="chart-title">Waterfall Bridge</div>
              <canvas id="pvmChart" class="chart-canvas"></canvas>
            </div>
          </div>
        </section>

        <!-- Discount & Accrual Schedule -->
        <section class="module-section">
          <h2 class="module-section-title">4. Discount & Accrual Schedule</h2>
          
          <div class="module-card">
            <div class="card-header">
              <h3 class="card-title">Straight-line Accrual Logic</h3>
              <div class="card-actions">
                <button onclick="downloadAccrualCSV()" class="btn-small">Export Schedule</button>
                <button onclick="downloadAccrualTemplate()" class="btn-small">Download Template</button>
                <div class="file-input-wrapper">
                  <button class="btn-small btn-primary">Upload CSV</button>
                  <input type="file" id="accrualUpload" accept=".csv" onchange="handleAccrualUpload(event)">
                </div>
              </div>
            </div>

            <div class="input-grid">
              <div class="input-field">
                <label>Total Discount Pool ($)</label>
                <input type="number" id="discountPool" value="48000" onchange="computeAccrual()">
              </div>
              <div class="input-field">
                <label>Start Month</label>
                <input type="number" id="startMonth" value="1" min="1" max="12" onchange="computeAccrual()">
              </div>
              <div class="input-field">
                <label>End Month</label>
                <input type="number" id="endMonth" value="12" min="1" max="12" onchange="computeAccrual()">
              </div>
            </div>

            <div style="overflow-x:auto;"><table class="data-table" id="accrualTable">
              <!-- Table populated by JS -->
            </table></div>
          </div>
        </section>

        <!-- What This Demonstrates -->
        <section class="demo-section">
          <h2 class="module-section-title">What This Demonstrates</h2>
          <div class="demo-grid">
            <div class="demo-card">
              <div class="demo-card-title">Revenue Quality, Not Just Quantity</div>
              <div class="demo-card-text">
                Promotion ROI and PVM analysis reveal whether growth is margin-accretive or just expensive volume.
              </div>
            </div>
            <div class="demo-card">
              <div class="demo-card-title">Channel Economics That Matter</div>
              <div class="demo-card-text">
                Move beyond top-line dashboards to channel-level P&Ls that expose true profitability.
              </div>
            </div>
            <div class="demo-card">
              <div class="demo-card-title">Finance-Grade Accrual Logic</div>
              <div class="demo-card-text">
                Clean discount accrual schedules reduce audit risk and month-end chaos.
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>

  
  <!-- ‚îÄ‚îÄ Next Module ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <nav class="next-module-bar" aria-label="Next recommended module">
    <div>
      <div class="next-module-label">Next recommended</div>
      <div class="next-module-title">Revenue Bridge &amp; Cohort Retention</div>
      <div class="next-module-why">You know channel profit ‚Äî now see if that revenue is actually being retained over time.</div>
    </div>
    <div class="next-module-actions">
      <a class="btn btn-solid" href="revenue-bridge.html">Open Revenue Bridge ‚Üí</a>
      <a class="btn btn-ghost" href="index.html">‚Üê Back to Portfolio</a>
    </div>
  </nav>

</main>

  <a href="#" class="to-top" aria-label="Back to top">‚Üë</a>

  <script src="main.js"></script>
  <script>
    /* =========================================
       Commercial / Sales Finance - JavaScript
       ========================================= */

    // ========== GLOBAL STATE ==========
    
    let dataMode = 'sample';
    
    let promoData = {};
    let channelData = [];
    let pvmData = {};
    let accrualSchedule = [];
    
    // ========== UTILITY FUNCTIONS ==========
    
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function randFloat(min, max) {
      return Math.random() * (max - min) + min;
    }
    
    function formatCurrency(val) {
      return '$' + Math.round(val).toLocaleString();
    }
    
    function formatPercent(val) {
      return val.toFixed(1) + '%';
    }
    
    // ========== CSV PARSING ==========
    
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = values[idx] || '';
        });
        data.push(row);
      }
      return { headers, data };
    }
    
    function validateHeaders(actual, required) {
      return required.every(h => actual.includes(h));
    }
    
    function downloadCSV(filename, headers, rows) {
      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += headers.map(h => row[h] !== undefined ? row[h] : '').join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    }
    
    // ========== SAMPLE DATA GENERATION ==========
    
    function useSampleData() {
      withStableScroll(function() {
      dataMode = 'sample';
      document.getElementById('dataModeBadge').textContent = 'Sample Data';
      initializeSampleData();
      renderAll();
      });
    }
    
    function initializeSampleData() {
      // Promo data
      promoData = {
        baseline_revenue: 50000,
        promo_revenue: 85000,
        baseline_gp: 42,
        promo_gp: 28,
        promo_cost: 12000
      };
      
      document.getElementById('baselineRev').value = promoData.baseline_revenue;
      document.getElementById('promoRev').value = promoData.promo_revenue;
      document.getElementById('baselineGP').value = promoData.baseline_gp;
      document.getElementById('promoGP').value = promoData.promo_gp;
      document.getElementById('promoCost').value = promoData.promo_cost;
      
      // Channel data
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const channels = ['Direct', 'Online', 'Retail', 'Partner', 'Enterprise'];
      channelData = [];
      months.forEach(month => {
        channels.forEach(channel => {
          const revenue = randInt(8000, 25000);
          const cogs = revenue * randFloat(0.35, 0.55);
          const opex = randInt(2000, 6000);
          channelData.push({
            month,
            channel,
            revenue: revenue.toFixed(2),
            cogs: cogs.toFixed(2),
            opex: opex.toFixed(2),
            gp: ((revenue - cogs) / revenue * 100).toFixed(1),
            contribution: (revenue - cogs - opex).toFixed(2)
          });
        });
      });
      
      // PVM data
      pvmData = {
        prior_revenue: 120000,
        current_revenue: 138000,
        price_effect: 5.2,
        volume_effect: 8.5,
        mix_effect: 1.3
      };
      
      document.getElementById('priorRev').value = pvmData.prior_revenue;
      document.getElementById('currentRev').value = pvmData.current_revenue;
      document.getElementById('priceEffect').value = pvmData.price_effect;
      document.getElementById('volumeEffect').value = pvmData.volume_effect;
      document.getElementById('mixEffect').value = pvmData.mix_effect;
      
      // Accrual schedule
      document.getElementById('discountPool').value = 48000;
      document.getElementById('startMonth').value = 1;
      document.getElementById('endMonth').value = 12;
    }
    
    function randomizeSampleData() {
      withStableScroll(function() {
      dataMode = 'sample';
      document.getElementById('dataModeBadge').textContent = 'Randomized Data';
      
      // Random promo data
      const baseRev = randInt(30000, 80000);
      const promoRev = baseRev * randFloat(1.3, 1.8);
      promoData = {
        baseline_revenue: baseRev,
        promo_revenue: Math.round(promoRev),
        baseline_gp: randFloat(35, 50),
        promo_gp: randFloat(20, 35),
        promo_cost: randInt(8000, 18000)
      };
      
      document.getElementById('baselineRev').value = promoData.baseline_revenue;
      document.getElementById('promoRev').value = promoData.promo_revenue;
      document.getElementById('baselineGP').value = promoData.baseline_gp.toFixed(1);
      document.getElementById('promoGP').value = promoData.promo_gp.toFixed(1);
      document.getElementById('promoCost').value = promoData.promo_cost;
      
      // Random channel data
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const numChannels = randInt(3, 5);
      const channelNames = ['Direct', 'Online', 'Retail', 'Partner', 'Enterprise'].slice(0, numChannels);
      channelData = [];
      months.forEach(month => {
        channelNames.forEach(channel => {
          const revenue = randInt(5000, 35000);
          const cogs = revenue * randFloat(0.30, 0.60);
          const opex = randInt(1500, 8000);
          channelData.push({
            month,
            channel,
            revenue: revenue.toFixed(2),
            cogs: cogs.toFixed(2),
            opex: opex.toFixed(2),
            gp: ((revenue - cogs) / revenue * 100).toFixed(1),
            contribution: (revenue - cogs - opex).toFixed(2)
          });
        });
      });
      
      // Random PVM data
      const priorRev = randInt(80000, 180000);
      const variance = randFloat(0.05, 0.25);
      pvmData = {
        prior_revenue: priorRev,
        current_revenue: Math.round(priorRev * (1 + variance)),
        price_effect: randFloat(2, 8),
        volume_effect: randFloat(3, 15),
        mix_effect: randFloat(-2, 5)
      };
      
      document.getElementById('priorRev').value = pvmData.prior_revenue;
      document.getElementById('currentRev').value = pvmData.current_revenue;
      document.getElementById('priceEffect').value = pvmData.price_effect.toFixed(1);
      document.getElementById('volumeEffect').value = pvmData.volume_effect.toFixed(1);
      document.getElementById('mixEffect').value = pvmData.mix_effect.toFixed(1);
      
      // Random accrual
      document.getElementById('discountPool').value = randInt(20000, 80000);
      document.getElementById('startMonth').value = randInt(1, 3);
      document.getElementById('endMonth').value = randInt(10, 12);
      
      renderAll();
      });
    }
    
    // ========== PROMO ROI FUNCTIONS ==========
    
    function computePromoROI() {
      const baselineRev = parseFloat(document.getElementById('baselineRev').value) || 0;
      const promoRev = parseFloat(document.getElementById('promoRev').value) || 0;
      const baselineGP = parseFloat(document.getElementById('baselineGP').value) || 0;
      const promoGP = parseFloat(document.getElementById('promoGP').value) || 0;
      const promoCost = parseFloat(document.getElementById('promoCost').value) || 0;
      
      const incrementalRev = promoRev - baselineRev;
      const baselineGPDollar = baselineRev * (baselineGP / 100);
      const promoGPDollar = promoRev * (promoGP / 100);
      const incrementalGP = promoGPDollar - baselineGPDollar;
      const netProfit = incrementalGP - promoCost;
      const roi = promoCost > 0 ? (netProfit / promoCost) * 100 : 0;
      const cmPct = promoRev > 0 ? ((promoGPDollar - promoCost) / promoRev) * 100 : 0;
      
      document.getElementById('promoKPIs').innerHTML = `
        <div class="kpi-box">
          <div class="kpi-box-label">Incremental Revenue</div>
          <div class="kpi-box-value">${formatCurrency(incrementalRev)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Incremental GP</div>
          <div class="kpi-box-value">${formatCurrency(incrementalGP)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Net Promo Profit</div>
          <div class="kpi-box-value">${formatCurrency(netProfit)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">ROI</div>
          <div class="kpi-box-value">${formatPercent(roi)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">CM%</div>
          <div class="kpi-box-value">${formatPercent(cmPct)}</div>
        </div>
      `;
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Metric</th>
            <th>Baseline</th>
            <th>Promo</th>
            <th>Change</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Revenue</td>
            <td>${formatCurrency(baselineRev)}</td>
            <td>${formatCurrency(promoRev)}</td>
            <td>${formatCurrency(incrementalRev)}</td>
          </tr>
          <tr>
            <td>GP%</td>
            <td>${formatPercent(baselineGP)}</td>
            <td>${formatPercent(promoGP)}</td>
            <td>${formatPercent(promoGP - baselineGP)}</td>
          </tr>
          <tr>
            <td>GP $</td>
            <td>${formatCurrency(baselineGPDollar)}</td>
            <td>${formatCurrency(promoGPDollar)}</td>
            <td>${formatCurrency(incrementalGP)}</td>
          </tr>
          <tr>
            <td>Promo Cost</td>
            <td>-</td>
            <td>${formatCurrency(promoCost)}</td>
            <td>${formatCurrency(promoCost)}</td>
          </tr>
          <tr>
            <td><strong>Net Profit</strong></td>
            <td>${formatCurrency(baselineGPDollar)}</td>
            <td>${formatCurrency(promoGPDollar - promoCost)}</td>
            <td>${formatCurrency(netProfit)}</td>
          </tr>
        </tbody>
      `;
      document.getElementById('promoTable').innerHTML = tableHTML;
      renderPromoDecisionBox();
    }
    
    // ========== CHANNEL P&L FUNCTIONS ==========
    
    function renderChannelPL() {
      const monthFilter = document.getElementById('channelMonthFilter').value;
      const channelFilter = document.getElementById('channelFilter').value;
      
      let filtered = channelData.filter(d => {
        if (monthFilter !== 'all' && d.month !== monthFilter) return false;
        if (channelFilter !== 'all' && d.channel !== channelFilter) return false;
        return true;
      });
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Month</th>
            <th>Channel</th>
            <th>Revenue</th>
            <th>COGS</th>
            <th>GP%</th>
            <th>OpEx</th>
            <th>Contribution</th>
          </tr>
        </thead>
        <tbody>
      `;
      filtered.forEach(d => {
        tableHTML += `
          <tr>
            <td>${d.month}</td>
            <td>${d.channel}</td>
            <td>${formatCurrency(parseFloat(d.revenue))}</td>
            <td>${formatCurrency(parseFloat(d.cogs))}</td>
            <td>${d.gp}%</td>
            <td>${formatCurrency(parseFloat(d.opex))}</td>
            <td>${formatCurrency(parseFloat(d.contribution))}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('channelTable').innerHTML = tableHTML;
      
      renderChannelChart();
    }
    
    function renderChannelChart() {
      const canvas = document.getElementById('channelChart');
      const container = canvas.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const channels = [...new Set(channelData.map(d => d.channel))];
      const channelTotals = channels.map(ch => {
        const total = channelData.filter(d => d.channel === ch).reduce((sum, d) => sum + parseFloat(d.revenue), 0);
        return { channel: ch, total };
      }).sort((a, b) => b.total - a.total);
      
      const maxTotal = Math.max(...channelTotals.map(c => c.total));
      const paddingLeft = 100;
      const paddingRight = 60;
      const paddingTop = 20;
      const paddingBottom = 30;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const barHeight = 30;
      const barGap = 10;
      
      channelTotals.forEach((c, i) => {
        const barW = (c.total / maxTotal) * chartW;
        const y = paddingTop + i * (barHeight + barGap);
        
        ctx.fillStyle = '#0f766e';
        ctx.fillRect(paddingLeft, y, barW, barHeight);
        
        ctx.fillStyle = '#0b1220';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        ctx.fillText(c.channel, paddingLeft - 10, y + barHeight / 2);
        
        ctx.fillStyle = '#0b1220';
        ctx.textAlign = 'left';
        ctx.fillText(formatCurrency(c.total), paddingLeft + barW + 8, y + barHeight / 2);
      });
    }
    
    function populateChannelFilters() {
      const months = [...new Set(channelData.map(d => d.month))];
      const channels = [...new Set(channelData.map(d => d.channel))];
      
      document.getElementById('channelMonthFilter').innerHTML = '<option value="all">All Months</option>' +
        months.map(m => `<option value="${m}">${m}</option>`).join('');
      
      document.getElementById('channelFilter').innerHTML = '<option value="all">All Channels</option>' +
        channels.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    // ========== PVM FUNCTIONS ==========
    
    function computePVM() {
      const priorRev = parseFloat(document.getElementById('priorRev').value) || 0;
      const currentRev = parseFloat(document.getElementById('currentRev').value) || 0;
      const priceEffect = parseFloat(document.getElementById('priceEffect').value) || 0;
      const volumeEffect = parseFloat(document.getElementById('volumeEffect').value) || 0;
      const mixEffect = parseFloat(document.getElementById('mixEffect').value) || 0;
      
      const totalVariance = currentRev - priorRev;
      const priceDollar = priorRev * (priceEffect / 100);
      const volumeDollar = priorRev * (volumeEffect / 100);
      const mixDollar = priorRev * (mixEffect / 100);
      
      document.getElementById('pvmKPIs').innerHTML = `
        <div class="kpi-box">
          <div class="kpi-box-label">Total Variance</div>
          <div class="kpi-box-value">${formatCurrency(totalVariance)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"><span class="tooltip" data-tooltip="Revenue change from price">Price Effect</span></div>
          <div class="kpi-box-value">${formatCurrency(priceDollar)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"><span class="tooltip" data-tooltip="Revenue change from volume">Volume Effect</span></div>
          <div class="kpi-box-value">${formatCurrency(volumeDollar)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"><span class="tooltip" data-tooltip="Revenue change from mix">Mix Effect</span></div>
          <div class="kpi-box-value">${formatCurrency(mixDollar)}</div>
        </div>
      `;
      
      renderPVMChart(priorRev, priceDollar, volumeDollar, mixDollar, currentRev);
    }
    
    function renderPVMChart(prior, price, volume, mix, current) {
      const canvas = document.getElementById('pvmChart');
      const container = canvas.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const values = [prior, prior + price, prior + price + volume, prior + price + volume + mix, current];
      const labels = ['Prior', '+ Price', '+ Volume', '+ Mix', 'Current'];
      
      const maxVal = Math.max(...values);
      const minVal = Math.min(...values, 0);
      const range = maxVal - minVal;
      
      const paddingLeft = 60;
      const paddingRight = 40;
      const paddingTop = 40;
      const paddingBottom = 50;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const barWidth = chartW / (values.length * 1.5);
      const barGap = barWidth * 0.5;
      
      // Zero line
      const zeroY = paddingTop + chartH - ((0 - minVal) / range) * chartH;
      ctx.strokeStyle = '#0b1220';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(paddingLeft, zeroY);
      ctx.lineTo(w - paddingRight, zeroY);
      ctx.stroke();
      
      // Bars
      values.forEach((val, i) => {
        const x = paddingLeft + i * (barWidth + barGap);
        const barH = Math.abs((val - minVal) / range * chartH - (0 - minVal) / range * chartH);
        const y = val >= 0 ? zeroY - barH : zeroY;
        
        ctx.fillStyle = i === 0 || i === values.length - 1 ? '#1b4d7a' : '#0f766e';
        ctx.fillRect(x, y, barWidth, barH);
        
        // Label
        ctx.fillStyle = '#0b1220';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        ctx.fillText(labels[i], x + barWidth / 2, h - paddingBottom + 5);
        
        // Value
        ctx.font = 'bold 11px sans-serif';
        ctx.textBaseline = 'bottom';
        ctx.fillText(formatCurrency(val), x + barWidth / 2, y - 5);
      });
    }
    
    // ========== ACCRUAL FUNCTIONS ==========
    
    function computeAccrual() {
      const pool = parseFloat(document.getElementById('discountPool').value) || 0;
      const start = parseInt(document.getElementById('startMonth').value) || 1;
      const end = parseInt(document.getElementById('endMonth').value) || 12;
      
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const numMonths = end - start + 1;
      const monthlyAccrual = numMonths > 0 ? pool / numMonths : 0;
      
      accrualSchedule = [];
      let cumulative = 0;
      months.forEach((month, i) => {
        const monthNum = i + 1;
        const accrual = (monthNum >= start && monthNum <= end) ? monthlyAccrual : 0;
        cumulative += accrual;
        accrualSchedule.push({
          month,
          accrual: accrual.toFixed(2),
          cumulative: cumulative.toFixed(2),
          remaining: (pool - cumulative).toFixed(2)
        });
      });
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Month</th>
            <th>Monthly Accrual</th>
            <th>Cumulative</th>
            <th>Remaining Pool</th>
          </tr>
        </thead>
        <tbody>
      `;
      accrualSchedule.forEach(a => {
        tableHTML += `
          <tr>
            <td>${a.month}</td>
            <td>${formatCurrency(parseFloat(a.accrual))}</td>
            <td>${formatCurrency(parseFloat(a.cumulative))}</td>
            <td>${formatCurrency(parseFloat(a.remaining))}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('accrualTable').innerHTML = tableHTML;
    }
    
    // ========== CSV DOWNLOADS ==========
    
    function downloadPromoCSV() {
      const headers = ['metric', 'baseline', 'promo', 'change'];
      const baselineRev = parseFloat(document.getElementById('baselineRev').value) || 0;
      const promoRev = parseFloat(document.getElementById('promoRev').value) || 0;
      const baselineGP = parseFloat(document.getElementById('baselineGP').value) || 0;
      const promoGP = parseFloat(document.getElementById('promoGP').value) || 0;
      const rows = [
        { metric: 'Revenue', baseline: baselineRev, promo: promoRev, change: promoRev - baselineRev },
        { metric: 'GP%', baseline: baselineGP, promo: promoGP, change: promoGP - baselineGP }
      ];
      downloadCSV('promotion_roi.csv', headers, rows);
    }
    
    function downloadPromoTemplate() {
      const headers = ['baseline_revenue', 'promo_revenue', 'baseline_gp', 'promo_gp', 'promo_cost'];
      const rows = [{ baseline_revenue: 50000, promo_revenue: 85000, baseline_gp: 42, promo_gp: 28, promo_cost: 12000 }];
      downloadCSV('promotions_template.csv', headers, rows);
    }
    
    function downloadChannelCSV() {
      const headers = ['month', 'channel', 'revenue', 'cogs', 'gp', 'opex', 'contribution'];
      downloadCSV('channel_pnl.csv', headers, channelData);
    }
    
    function downloadChannelTemplate() {
      const headers = ['month', 'channel', 'revenue', 'cogs', 'gp', 'opex', 'contribution'];
      const rows = [
        { month: 'Jan', channel: 'Direct', revenue: 15000, cogs: 6000, gp: 60, opex: 3000, contribution: 6000 },
        { month: 'Jan', channel: 'Online', revenue: 12000, cogs: 5000, gp: 58.3, opex: 2500, contribution: 4500 }
      ];
      downloadCSV('channel_pnl_template.csv', headers, rows);
    }
    
    function downloadPVMCSV() {
      const headers = ['prior_revenue', 'current_revenue', 'price_effect', 'volume_effect', 'mix_effect'];
      const rows = [{
        prior_revenue: document.getElementById('priorRev').value,
        current_revenue: document.getElementById('currentRev').value,
        price_effect: document.getElementById('priceEffect').value,
        volume_effect: document.getElementById('volumeEffect').value,
        mix_effect: document.getElementById('mixEffect').value
      }];
      downloadCSV('pvm_analysis.csv', headers, rows);
    }
    
    function downloadPVMTemplate() {
      const headers = ['prior_revenue', 'current_revenue', 'price_effect', 'volume_effect', 'mix_effect'];
      const rows = [{ prior_revenue: 120000, current_revenue: 138000, price_effect: 5.2, volume_effect: 8.5, mix_effect: 1.3 }];
      downloadCSV('pvm_template.csv', headers, rows);
    }
    
    function downloadAccrualCSV() {
      const headers = ['month', 'accrual', 'cumulative', 'remaining'];
      downloadCSV('accrual_schedule.csv', headers, accrualSchedule);
    }
    
    function downloadAccrualTemplate() {
      const headers = ['discount_pool', 'start_month', 'end_month'];
      const rows = [{ discount_pool: 48000, start_month: 1, end_month: 12 }];
      downloadCSV('accrual_template.csv', headers, rows);
    }
    
    function downloadAllTemplates() {
      downloadPromoTemplate();
      setTimeout(() => downloadChannelTemplate(), 300);
      setTimeout(() => downloadPVMTemplate(), 600);
      setTimeout(() => downloadAccrualTemplate(), 900);
    }
    
    // ========== CSV UPLOADS ==========
    
    function handlePromoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['baseline_revenue', 'promo_revenue', 'baseline_gp', 'promo_gp', 'promo_cost'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          const row = data[0];
          document.getElementById('baselineRev').value = row.baseline_revenue;
          document.getElementById('promoRev').value = row.promo_revenue;
          document.getElementById('baselineGP').value = row.baseline_gp;
          document.getElementById('promoGP').value = row.promo_gp;
          document.getElementById('promoCost').value = row.promo_cost;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'Uploaded Data';
          computePromoROI();
          alert('Promo data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handleChannelUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['month', 'channel', 'revenue', 'cogs', 'gp', 'opex', 'contribution'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          channelData = data;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'Uploaded Data';
          populateChannelFilters();
          renderChannelPL();
          alert('Channel data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handlePVMUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['prior_revenue', 'current_revenue', 'price_effect', 'volume_effect', 'mix_effect'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          const row = data[0];
          document.getElementById('priorRev').value = row.prior_revenue;
          document.getElementById('currentRev').value = row.current_revenue;
          document.getElementById('priceEffect').value = row.price_effect;
          document.getElementById('volumeEffect').value = row.volume_effect;
          document.getElementById('mixEffect').value = row.mix_effect;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'Uploaded Data';
          computePVM();
          alert('PVM data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handleAccrualUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['discount_pool', 'start_month', 'end_month'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          const row = data[0];
          document.getElementById('discountPool').value = row.discount_pool;
          document.getElementById('startMonth').value = row.start_month;
          document.getElementById('endMonth').value = row.end_month;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'Uploaded Data';
          computeAccrual();
          alert('Accrual data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    // ========== DECISION BOX (PROMO ROI) ==========

    function renderPromoDecisionBox() {
      const fallback = document.getElementById('promoDecisionFallback');
      const content  = document.getElementById('promoDecisionContent');

      const baselineRev = parseFloat(document.getElementById('baselineRev').value) || 0;
      const promoRev    = parseFloat(document.getElementById('promoRev').value)    || 0;
      const baselineGP  = parseFloat(document.getElementById('baselineGP').value)  || 0;
      const promoGP     = parseFloat(document.getElementById('promoGP').value)     || 0;
      const promoCost   = parseFloat(document.getElementById('promoCost').value)   || 0;

      // Need at least revenue values
      if (!baselineRev && !promoRev) {
        fallback.style.display = '';
        content.style.display = 'none';
        return;
      }

      const baselineGPDollar  = baselineRev * (baselineGP / 100);
      const promoGPDollar     = promoRev    * (promoGP    / 100);
      const incrementalGP     = promoGPDollar - baselineGPDollar;
      const netProfit         = incrementalGP - promoCost;
      const marginImpactPp    = promoGP - baselineGP;           // percentage points

      // Decision logic
      const profitable    = netProfit > 0;
      const marginOk      = marginImpactPp >= 0;                // not negative pp
      const runPromo      = profitable && marginOk;

      // "What to do next" recommendation based on what hurts most
      let nextAction;
      if (runPromo) {
        nextAction = 'Scale this promo ‚Äî profit is positive and margin holds.';
      } else if (!profitable && marginImpactPp < 0) {
        // Both hurting ‚Äî biggest lever?
        const discountDamage = Math.abs(marginImpactPp);
        const costDamage     = promoCost / (promoRev || 1) * 100;
        nextAction = discountDamage > costDamage
          ? 'Reduce discount depth to recover margin before running.'
          : 'Limit redemptions or cut promo cost ‚Äî spend outweighs the uplift.';
      } else if (!profitable) {
        nextAction = 'Limit redemptions ‚Äî promo cost exceeds the profit it generates.';
      } else {
        // Profitable but margin compressed
        nextAction = 'Shift budget to the highest-margin channel to protect overall GP%.';
      }

      fallback.style.display = 'none';
      content.style.display  = '';

      // Apply color state: Yes = positive, No = negative
      const box = document.getElementById('promoDecisionBox');
      box.classList.remove('decision-box--positive', 'decision-box--negative');
      box.classList.add(runPromo ? 'decision-box--positive' : 'decision-box--negative');

      const verdictLabel = runPromo ? 'Yes ‚Äî run the promo' : 'No ‚Äî don\'t run the promo';
      document.getElementById('promoDecisionVerdict').innerHTML =
        `Run promo? <span class="verdict-action">${verdictLabel}</span>`;

      const marginSign = marginImpactPp >= 0 ? '+' : '';
      document.getElementById('promoDecisionBullets').innerHTML = `
        <li>Expected profit impact: <strong>$${Math.round(netProfit).toLocaleString()}</strong></li>
        <li>Margin impact: <strong>${marginSign}${marginImpactPp.toFixed(1)} pp</strong> (promo GP% vs baseline)</li>
      `;

      document.getElementById('promoDecisionNext').innerHTML =
        `What to do next: <span>${nextAction}</span>`;
    }

    // ========== RENDER ALL ==========
    
    function renderAll() {
      computePromoROI();
      populateChannelFilters();
      renderChannelPL();
      computePVM();
      computeAccrual();
      renderPromoDecisionBox();
    }
    
    // ========== INIT ==========
    
    window.addEventListener('DOMContentLoaded', () => {
      initializeSampleData();
      renderAll();
    });
  </script>

</body>
</html>

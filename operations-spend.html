<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Operations Finance &amp; Spend Analytics · FP&amp;A Portfolio</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    /* module-hero, module-label, module-title, module-pill, module-subtitle,
       module-problem, module-role, feature-chips — all in style.css */

    /* Module sections */
    .module-section {
      padding: 0 0 48px 0;
    }

    .chip {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(246,248,251,0.8);
      color: var(--text);
    }
    

    .module-section-title {
      font-size: 24px;
      margin-bottom: 20px;
      letter-spacing: -0.02em;
    }
    .module-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-soft);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .card-title {
      font-size: 18px;
      font-weight: 650;
    }
    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* Buttons */
    .btn-small {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 999px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 140ms ease;
      white-space: nowrap;
    }
    .btn-small:hover {
      border-color: rgba(12, 23, 45, 0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.06);
    }
    .btn-small:active {
      transform: translateY(1px);
    }
    .btn-primary {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }
    .btn-primary:hover {
      box-shadow: 0 6px 18px rgba(11,18,32,0.12);
    }
    .btn-full {
      width: 100%;
      justify-content: center;
      display: flex;
    }
    
    /* KPI grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .kpi-box {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: rgba(246,248,251,0.6);
    }
    .kpi-box-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .kpi-box-value {
      font-size: 20px;
      font-weight: 650;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin: 16px 0;
      overflow-x: auto;
    }
    .data-table th {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 2px solid var(--border);
      font-weight: 650;
      color: var(--text);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .data-table tr:last-child td {
      border-bottom: none;
    }
    .data-table tr:hover {
      background: rgba(246,248,251,0.5);
    }
    .highlight-red {
      color: #dc2626;
      font-weight: 600;
    }
    .highlight-green {
      color: #059669;
      font-weight: 600;
    }
    
    /* Charts */
    .chart-container { overflow-anchor: none;
      margin: 20px 0;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
      position: relative;
    }
    .chart-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 16px;
      color: var(--text);
    }
    .chart-wrapper {
      position: relative;
      width: 100%;
    }
    .chart-canvas {
      display: block;
      width: 100%;
      height: auto;
    }
    
    /* Filters */
    .filter-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .filter-row select,
    .filter-row input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      background: white;
      font-family: var(--font-sans);
    }
    .filter-row label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      margin-right: 6px;
    }
    
    /* File upload */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    /* Alert cards */
    .alert-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 14px;
      margin-top: 16px;
    }
    .alert-card {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .alert-card.high {
      border-left: 4px solid #dc2626;
      background: rgba(220, 38, 38, 0.02);
    }
    .alert-card.med {
      border-left: 4px solid #f59e0b;
      background: rgba(245, 158, 11, 0.02);
    }
    .alert-card.low {
      border-left: 4px solid #6b7280;
      background: rgba(107, 114, 128, 0.02);
    }
    .alert-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .alert-title {
      font-size: 14px;
      font-weight: 650;
      color: var(--text);
    }
    .severity-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .severity-badge.high {
      background: rgba(220, 38, 38, 0.15);
      color: #dc2626;
    }
    .severity-badge.med {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }
    .severity-badge.low {
      background: rgba(107, 114, 128, 0.15);
      color: #6b7280;
    }
    .alert-text {
      font-size: 13px;
      color: var(--text);
      line-height: 1.5;
      margin-bottom: 8px;
    }
    .alert-why {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .alert-action {
      font-size: 12px;
      color: var(--accent);
      font-weight: 600;
    }
    
    /* Threshold controls */
    .threshold-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
      padding: 16px;
      background: rgba(246,248,251,0.6);
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
    }
    .threshold-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .threshold-field label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .threshold-field input {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      font-family: var(--font-sans);
      background: white;
      transition: border-color 120ms ease;
    }
    .threshold-field input:focus { outline: none; border-color: rgba(12,23,45,0.30); }

    /* ── Risk v2: helper text & inline warnings ── */
    .threshold-helper {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }
    .threshold-warn {
      display: none;
      font-size: 11px;
      font-weight: 600;
      padding: 3px 7px;
      border-radius: 5px;
      line-height: 1.4;
    }
    .threshold-warn.w-noisy  { color: #92400e; background: rgba(245,158,11,0.13); }
    .threshold-warn.w-strict { color: #374151; background: rgba(12,23,45,0.07);   }
    .threshold-warn.w-dead   { color: #dc2626; background: rgba(220,38,38,0.09);  }

    /* ── Risk v2: preset + mode config bar ── */
    .risk-cfg-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 14px;
      padding-bottom: 14px;
      border-bottom: 1px solid var(--border);
    }
    .risk-cfg-left, .risk-cfg-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .risk-cfg-lbl {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      white-space: nowrap;
    }
    /* Preset select reuses filter-row styling */
    .preset-sel {
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      font-family: var(--font-sans);
      background: white;
      color: var(--text);
      cursor: pointer;
    }
    /* Sensitivity pill */
    .sens-pill {
      font-size: 11px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 999px;
      white-space: nowrap;
      transition: background 160ms, color 160ms;
    }
    .sens-pill.sp-high { background: rgba(220,38,38,0.10);   color: #dc2626; }
    .sens-pill.sp-mid  { background: rgba(12,23,45,0.07);    color: var(--muted); }
    .sens-pill.sp-low  { background: rgba(107,114,128,0.10); color: #6b7280; }

    /* ── Reset-to-preset link (appears when custom is active) ── */
    #resetPresetLink {
      display: none;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      text-decoration: underline;
      cursor: pointer;
      white-space: nowrap;
      background: none;
      border: none;
      padding: 0;
      font-family: inherit;
    }
    #resetPresetLink:hover { opacity: 0.75; }

    /* ── Risk v2: triggered-by badge on alert cards ── */
    .trig-badge {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 2px 7px;
      border-radius: 999px;
    }
    .trig-badge.tb-thr  { background: rgba(12,23,45,0.08);   color: #374151; }
    .trig-badge.tb-adap { background: rgba(99,102,241,0.12); color: #4338ca; }
    .trig-badge.tb-both { background: rgba(220,38,38,0.10);  color: #dc2626; }

    /* ── Risk v2: friendly empty state ── */
    .alerts-empty {
      padding: 40px 20px;
      text-align: center;
    }
    .alerts-empty-icon  { font-size: 24px; margin-bottom: 10px; }
    .alerts-empty-title { font-size: 14px; font-weight: 650; color: var(--text); margin-bottom: 4px; }
    .alerts-empty-sub   { font-size: 13px; color: var(--muted); line-height: 1.5; max-width: 360px; margin: 0 auto; }

    /* ── Forecast Confidence Bar (dynamic) ── */
    .conf-bar-wrap {
      margin-top: 14px;
      padding: 12px 14px;
      background: rgba(15,118,110,0.04);
      border-radius: 10px;
      border: 1px solid rgba(15,118,110,0.14);
    }
    .conf-bar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .conf-bar-title {
      font-size: 11px;
      font-weight: 700;
      color: #0f766e;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .conf-summary-pill {
      font-size: 10px;
      font-weight: 700;
      padding: 2px 9px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .conf-summary-pill.high   { background: rgba(5,150,105,0.12);  color: #065f46; }
    .conf-summary-pill.medium { background: rgba(245,158,11,0.12); color: #92400e; }
    .conf-summary-pill.low    { background: rgba(220,38,38,0.10);  color: #dc2626; }
    .conf-stacked-bar {
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      background: rgba(12,23,45,0.06);
      margin-bottom: 8px;
    }
    .conf-seg {
      height: 100%;
      transition: width 400ms ease;
    }
    .conf-seg.high   { background: #10b981; }
    .conf-seg.medium { background: #f59e0b; }
    .conf-seg.low    { background: #ef4444; }
    .conf-legend {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }
    .conf-legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 10px;
      color: var(--muted);
    }
    .conf-legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .conf-legend-dot.high   { background: #10b981; }
    .conf-legend-dot.medium { background: #f59e0b; }
    .conf-legend-dot.low    { background: #ef4444; }
    .conf-legend-pct {
      font-weight: 700;
      color: var(--text);
    }

    /* ── Alert card owner badge ── */
    .alert-owner-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      white-space: nowrap;
      margin-top: 8px;
    }
    .alert-owner-badge.owner-procurement { background: rgba(59,130,246,0.10); color: #1d4ed8; }
    .alert-owner-badge.owner-ap          { background: rgba(124,58,237,0.10); color: #6d28d9; }
    .alert-owner-badge.owner-budget      { background: rgba(245,158,11,0.12); color: #92400e; }
    .alert-owner-badge.owner-finance     { background: rgba(15,118,110,0.10); color: #0f766e; }

    /* Demo section */
    .demo-section {
      padding: 32px 0;
      border-top: 1px solid var(--border);
    }
    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
    }
    .demo-card {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .demo-card-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 8px;
    }
    .demo-card-text {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    
    /* Toggle */
    .toggle-group {
      display: flex;
      gap: 8px;
      padding: 4px;
      background: rgba(246,248,251,0.8);
      border-radius: 999px;
      border: 1px solid var(--border);
    }
    .toggle-btn {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 140ms ease;
      color: var(--muted);
    }
    .toggle-btn.active {
      background: white;
      color: var(--text);
      box-shadow: 0 2px 4px rgba(11,18,32,0.08);
    }

    /* ---- Variance Toggle Helper Microcopy ---- */
    .toggle-hint {
      font-size: 10px;
      color: var(--muted);
      line-height: 1.3;
      max-width: 130px;
      text-align: center;
    }
    .toggle-with-hint {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .toggle-hints-row {
      display: flex;
      gap: 8px;
      font-size: 10px;
      color: var(--muted);
      padding: 0 4px;
    }
    .toggle-hint-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 0;
    }
    .toggle-hint-label {
      font-weight: 600;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      opacity: 0.75;
      white-space: nowrap;
    }

    /* ---- Plan Builder Sub-card ---- */
    .plan-builder-card {
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
      background: rgba(246,248,251,0.4);
      overflow: hidden;
    }
    .plan-builder-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      background: white;
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .plan-builder-title {
      font-size: 14px;
      font-weight: 650;
      color: var(--text);
      flex: 1;
      min-width: 200px;
    }
    .plan-builder-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }
    /* Toggle switch */
    .pb-switch {
      display: flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
      user-select: none;
    }
    .pb-switch input[type="checkbox"] { display: none; }
    .pb-switch-track {
      width: 32px;
      height: 18px;
      border-radius: 999px;
      background: rgba(12,23,45,0.15);
      position: relative;
      transition: background 150ms ease;
      flex-shrink: 0;
    }
    .pb-switch input:checked + .pb-switch-track {
      background: var(--text);
    }
    .pb-switch-thumb {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      transition: transform 150ms ease;
    }
    .pb-switch input:checked + .pb-switch-track .pb-switch-thumb {
      transform: translateX(14px);
    }
    .pb-switch-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
    }
    /* Status chip */
    .pb-status-chip {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 999px;
      white-space: nowrap;
      transition: background 150ms, color 150ms;
    }
    .pb-status-chip.not-locked {
      background: rgba(245,158,11,0.12);
      color: #92400e;
    }
    .pb-status-chip.locked {
      background: rgba(5,150,105,0.12);
      color: #065f46;
    }
    /* Plan builder body */
    .plan-builder-body {
      padding: 16px;
    }
    .plan-builder-body.pb-hidden { display: none; }
    .pb-disabled-msg {
      padding: 20px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
    }
    /* Plan builder table wrapper */
    .pb-table-section {
      margin-bottom: 20px;
    }
    .pb-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
    }
    .pb-section-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
    }
    .pb-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      overflow-x: auto;
      display: block;
      white-space: nowrap;
    }
    .pb-table th {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 2px solid var(--border);
      font-weight: 650;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
      background: white;
    }
    .pb-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    .pb-table tr:last-child td { border-bottom: none; }
    .pb-table tr:hover td { background: rgba(246,248,251,0.5); }
    .pb-table-empty td {
      text-align: center;
      color: var(--muted);
      font-style: italic;
      padding: 18px;
    }
    /* Status badges in plan builder */
    .pb-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }
    .pb-badge.draft      { background: rgba(107,114,128,0.12); color: #6b7280; }
    .pb-badge.submitted  { background: rgba(245,158,11,0.12); color: #92400e; }
    .pb-badge.approved   { background: rgba(5,150,105,0.12); color: #065f46; }
    .pb-badge.rejected   { background: rgba(220,38,38,0.12); color: #dc2626; }
    .pb-badge.committed  { background: rgba(59,130,246,0.12); color: #1d4ed8; }
    .pb-badge.invoiced   { background: rgba(5,150,105,0.12); color: #065f46; }
    .pb-badge.cancelled  { background: rgba(107,114,128,0.12); color: #6b7280; text-decoration: line-through; }
    /* Modal overlay */
    .pb-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .pb-modal-overlay.open { display: flex; }
    .pb-modal {
      background: white;
      border-radius: var(--radius);
      padding: 24px;
      width: 100%;
      max-width: 480px;
      margin: 16px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.18);
    }
    .pb-modal-title {
      font-size: 16px;
      font-weight: 650;
      margin-bottom: 16px;
    }
    .pb-form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .pb-form-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .pb-form-field.full { grid-column: 1 / -1; }
    .pb-form-field label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
    }
    .pb-form-field input,
    .pb-form-field select {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      font-family: var(--font-sans);
      background: white;
      color: var(--text);
      transition: border-color 120ms;
    }
    .pb-form-field input:focus,
    .pb-form-field select:focus {
      outline: none;
      border-color: rgba(12,23,45,0.3);
    }
    .pb-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 18px;
    }
    .btn-small.btn-danger {
      color: #dc2626;
      border-color: rgba(220,38,38,0.25);
    }
    .btn-small.btn-danger:hover {
      background: rgba(220,38,38,0.06);
    }
    .btn-small.btn-accent {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }
    .btn-small.btn-accent:hover {
      box-shadow: 0 4px 14px rgba(11,18,32,0.18);
    }
    .pb-action-btn {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
      transition: all 120ms ease;
      white-space: nowrap;
    }
    .pb-action-btn:hover {
      border-color: rgba(12,23,45,0.2);
      background: rgba(246,248,251,0.8);
    }
    .pb-action-btn.danger {
      color: #dc2626;
      border-color: rgba(220,38,38,0.2);
    }
    .pb-action-btn.danger:hover {
      background: rgba(220,38,38,0.05);
    }
    .pb-source-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(59,130,246,0.1);
      color: #1d4ed8;
    }

    /* ---- Plan Builder Guide Panel (floating) ---- */
    .pb-guide-fab {
      position: fixed;
      bottom: 28px;
      right: 28px;
      z-index: 900;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--text);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 18px rgba(11,18,32,0.22);
      transition: transform 140ms ease, box-shadow 140ms ease;
    }
    .pb-guide-fab:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 24px rgba(11,18,32,0.28);
    }
    .pb-guide-fab .pb-guide-fab-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #f59e0b;
      border: 2px solid white;
      font-size: 9px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .pb-guide-panel {
      position: fixed;
      bottom: 84px;
      right: 28px;
      z-index: 900;
      width: 320px;
      background: white;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 12px 48px rgba(11,18,32,0.18);
      overflow: hidden;
      display: none;
      flex-direction: column;
      max-height: calc(100vh - 120px);
    }
    .pb-guide-panel.open { display: flex; }
    .pb-guide-panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px 12px;
      background: var(--text);
      color: white;
    }
    .pb-guide-panel-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .pb-guide-panel-subtitle {
      font-size: 10px;
      opacity: 0.65;
      margin-top: 1px;
    }
    .pb-guide-close {
      background: rgba(255,255,255,0.15);
      border: none;
      border-radius: 8px;
      color: white;
      width: 26px;
      height: 26px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 120ms;
      flex-shrink: 0;
    }
    .pb-guide-close:hover { background: rgba(255,255,255,0.25); }
    .pb-guide-body {
      overflow-y: auto;
      flex: 1;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: rgba(12,23,45,0.12) transparent;
    }
    .pb-guide-step {
      display: flex;
      gap: 12px;
      padding: 13px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 100ms;
      position: relative;
    }
    .pb-guide-step:last-child { border-bottom: none; }
    .pb-guide-step:hover { background: rgba(246,248,251,0.7); }
    .pb-guide-step.done { opacity: 0.55; }
    .pb-guide-step.active { background: rgba(15,118,110,0.04); }
    .pb-guide-num {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      flex-shrink: 0;
      margin-top: 1px;
      transition: background 150ms, color 150ms;
    }
    .pb-guide-num.pending {
      background: rgba(12,23,45,0.08);
      color: var(--muted);
    }
    .pb-guide-num.active {
      background: var(--text);
      color: white;
    }
    .pb-guide-num.done {
      background: rgba(5,150,105,0.15);
      color: #059669;
    }
    .pb-guide-content {}
    .pb-guide-step-title {
      font-size: 13px;
      font-weight: 650;
      color: var(--text);
      margin-bottom: 3px;
      line-height: 1.3;
    }
    .pb-guide-step-desc {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.5;
    }
    .pb-guide-step-action {
      display: inline-block;
      margin-top: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    .pb-guide-done-tick {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: #059669;
    }
    .pb-guide-progress-bar-wrap {
      padding: 10px 16px 12px;
      background: rgba(246,248,251,0.6);
      border-top: 1px solid var(--border);
    }
    .pb-guide-progress-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
    }
    .pb-guide-progress-track {
      height: 4px;
      background: rgba(12,23,45,0.08);
      border-radius: 999px;
      overflow: hidden;
    }
    .pb-guide-progress-fill {
      height: 100%;
      background: #0f766e;
      border-radius: 999px;
      transition: width 300ms ease;
    }
    /* pb-info icon: inline ⓘ used in section titles */
    .pb-info {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(12,23,45,0.08);
      color: var(--muted);
      font-size: 10px;
      font-weight: 700;
      font-style: normal;
      cursor: pointer;
      vertical-align: middle;
      margin-left: 5px;
      line-height: 1;
      transition: background 120ms, color 120ms;
      flex-shrink: 0;
    }
    .pb-info:hover {
      background: var(--text);
      color: white;
    }
    @media (max-width: 480px) {
      .pb-guide-panel {
        right: 12px;
        bottom: 80px;
        width: calc(100vw - 24px);
      }
      .pb-guide-fab {
        right: 12px;
        bottom: 16px;
      }
    }

    /* ---- Decision Box ---- */
    .decision-box {
      background: white;
      border: 1.5px solid var(--accent);
      border-radius: var(--radius);
      padding: 20px 24px;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.08), var(--shadow-soft);
      margin-bottom: 24px;
      transition: border-color 200ms ease, box-shadow 200ms ease, background 200ms ease;
      /* Fixed size: eyebrow + summary + verdict + header row + 4 data rows — never resizes with data changes */
      min-height: 345px;
      max-height: 345px;
      overflow: hidden;
    }
    /* Positive — green */
    .decision-box--positive {
      border-color: #0f766e;
      background: #f0fdf9;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.10), var(--shadow-soft);
    }
    .decision-box--positive .decision-box-eyebrow { color: #0f766e; }
    .decision-box--positive .verdict-action        { color: #0f766e; }
    /* Caution — amber (Freeze spend: no leakage but overrun risk) */
    .decision-box--caution {
      border-color: #d97706;
      background: #fffbeb;
      box-shadow: 0 0 0 4px rgba(217,119,6,0.10), var(--shadow-soft);
    }
    .decision-box--caution .decision-box-eyebrow { color: #b45309; }
    .decision-box--caution .verdict-action        { color: #b45309; }
    /* Negative — red (Fix leakage first) */
    .decision-box--negative {
      border-color: #dc2626;
      background: #fef2f2;
      box-shadow: 0 0 0 4px rgba(220,38,38,0.10), var(--shadow-soft);
    }
    .decision-box--negative .decision-box-eyebrow { color: #dc2626; }
    .decision-box--negative .verdict-action        { color: #dc2626; }
    .decision-box-eyebrow {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--accent);
      margin-bottom: 8px;
    }
    .decision-box-verdict {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
      margin-bottom: 14px;
    }
    .decision-box-verdict .verdict-action {
      color: var(--accent);
    }
    .decision-box-exceptions {
      margin: 0 0 12px 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .exception-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      padding: 9px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      align-items: center;
    }
    .exception-row:last-child {
      border-bottom: none;
    }
    .exception-row[onclick]:hover {
      background: rgba(246,248,251,0.8);
    }
    .exception-row-header {
      background: rgba(246,248,251,0.8);
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
    }
    .exception-label {
      color: var(--text);
      font-weight: 600;
    }
    .exception-count {
      color: #dc2626;
      font-weight: 700;
      font-family: var(--font-mono);
      text-align: right;
    }
    .exception-action {
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
      text-align: right;
    }
    .decision-box-fallback {
      font-size: 14px;
      color: var(--muted);
      font-style: italic;
    }
      .main-content { overflow-anchor: none; }
    .module-card { overflow-anchor: none; }
    .data-table { overflow-anchor: none; }
    #alertsScroll::-webkit-scrollbar { width: 4px; }
    #alertsScroll::-webkit-scrollbar-track { background: transparent; }
    #alertsScroll::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }
    #alertsScroll::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.28); }
    /* Rate table scroll container */
    #rateTableScroll::-webkit-scrollbar { width: 5px; height: 5px; }
    #rateTableScroll::-webkit-scrollbar-track { background: transparent; }
    #rateTableScroll::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }
    #rateTableScroll::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.28); }
    /* So What explainer scrollbars */
    #rateSoWhat::-webkit-scrollbar,
    #accrualSoWhat::-webkit-scrollbar,
    #forecastSoWhat::-webkit-scrollbar,
    #riskSoWhat::-webkit-scrollbar { width: 4px; }
    #rateSoWhat::-webkit-scrollbar-track,
    #accrualSoWhat::-webkit-scrollbar-track,
    #forecastSoWhat::-webkit-scrollbar-track,
    #riskSoWhat::-webkit-scrollbar-track { background: transparent; }
    #rateSoWhat::-webkit-scrollbar-thumb,
    #accrualSoWhat::-webkit-scrollbar-thumb,
    #forecastSoWhat::-webkit-scrollbar-thumb,
    #riskSoWhat::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.18); border-radius: 4px; }
    #rateSoWhat::-webkit-scrollbar-thumb:hover,
    #accrualSoWhat::-webkit-scrollbar-thumb:hover,
    #forecastSoWhat::-webkit-scrollbar-thumb:hover,
    #riskSoWhat::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.32); }
    /* ── What / So What / Now What framework ── */
    .wswn { display: flex; flex-direction: column; gap: 0; }
    .wswn-row { display: grid; grid-template-columns: 82px 1fr; gap: 10px; align-items: baseline; padding: 5px 0; border-top: 1px solid rgba(12,23,45,0.06); }
    .wswn-row:first-child { border-top: none; }
    .wswn-label {
      font-size: 9px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      padding: 3px 7px;
      border-radius: 4px;
      white-space: nowrap;
      text-align: center;
      margin-top: 2px;
    }
    .wswn-label.lbl-what    { background: rgba(12,23,45,0.07);  color: #374151; }
    .wswn-label.lbl-sowhat  { background: rgba(245,158,11,0.14); color: #92400e; }
    .wswn-label.lbl-nowwhat { background: rgba(15,118,110,0.13); color: #134e4a; }
    .wswn-content { font-size: 13px; color: #5d6b7a; line-height: 1.55; }

    /* Fixed-layout tables: rate & accrual */
    #rateTable,
    #accrualTable {
      table-layout: fixed;
      width: 100%;
    }
    #rateTable tbody tr,
    #accrualTable tbody tr {
      height: 40px;
    }
    #rateTable td,
    #rateTable th,
    #accrualTable td,
    #accrualTable th {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    /* Rate table column widths */
    #rateTable colgroup col:nth-child(1) { width: 22%; }  /* Vendor */
    #rateTable colgroup col:nth-child(2) { width: 18%; }  /* Service */
    #rateTable colgroup col:nth-child(3) { width: 14%; }  /* Category */
    #rateTable colgroup col:nth-child(4) { width: 13%; }  /* Contract Rate */
    #rateTable colgroup col:nth-child(5) { width: 13%; }  /* Avg Paid Rate */
    #rateTable colgroup col:nth-child(6) { width: 11%; }  /* Rate Variance % */
    #rateTable colgroup col:nth-child(7) { width: 9%; }   /* Leakage $ */
    /* Accrual table column widths */
    #accrualTable colgroup col:nth-child(1) { width: 10%; }  /* Month */
    #accrualTable colgroup col:nth-child(2) { width: 14%; }  /* Invoice Count */
    #accrualTable colgroup col:nth-child(3) { width: 13%; }  /* Open Records */
    #accrualTable colgroup col:nth-child(4) { width: 16%; }  /* Incurred */
    #accrualTable colgroup col:nth-child(5) { width: 16%; }  /* Invoiced */
    #accrualTable colgroup col:nth-child(6) { width: 16%; }  /* Accrual Amount */
    #accrualTable colgroup col:nth-child(7) { width: 15%; }  /* Status */
  
    /* ── Data-needed strip ── */
    .data-needed-section {
      padding: 0 0 0 0;
      border-bottom: 1px solid var(--border, #e5e8ef);
    }
    .data-needed-wrap {
      max-width: var(--max-w, 1200px);
      margin: 0 auto;
      padding: 20px 32px 24px;
    }
    .data-needed-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--muted, #6b7280);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .data-needed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(185px, 1fr));
      gap: 8px;
      align-items: stretch;
    }
    .data-needed-item {
      padding: 10px 12px;
      border: 1px solid var(--border, #e5e8ef);
      border-radius: 9px;
      display: flex;
      align-items: flex-start;
      gap: 9px;
      background: #fafbfc;
      min-height: 88px;
      box-sizing: border-box;
    }
    .data-needed-icon {
      width: 26px;
      height: 26px;
      font-size: 13px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .data-needed-name {
      font-size: 11px;
      font-weight: 700;
      color: var(--text, #0b1220);
      margin-bottom: 3px;
      line-height: 1.35;
    }
    .data-needed-desc {
      font-size: 10px;
      color: var(--muted, #6b7280);
      line-height: 1.5;
    }




    /* ── Sidebar accordion ── */
    .sb-acc-header:hover { color: var(--text); }
    .sb-acc-header.open  { color: var(--text); }
    .sb-acc-chevron {
      font-size: 10px;
      color: var(--muted);
      transition: transform 200ms ease;
      flex-shrink: 0;
    }
    .sb-acc-header.open .sb-acc-chevron {
      transform: rotate(180deg);
      color: var(--text);
    }
    .sb-acc-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft, rgba(15,118,110,0.10));
      color: var(--accent, #0f766e);
      flex-shrink: 0;
      margin-left: auto;
    }

    .sb-acc-body {
      display: none;
      padding-bottom: 14px;
    }
    .sb-acc-body.open { display: block; }

    /* Buttons inside accordion */
    .sb-acc-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      transition: all 140ms ease;
      text-align: left;
      white-space: nowrap;
      font-family: inherit;
    }
    .sb-acc-btn:first-child { margin-top: 0; }
    .sb-acc-btn:hover {
      border-color: rgba(12,23,45,0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.06);
    }
    .sb-acc-btn:active { transform: translateY(1px); }
    .sb-acc-btn.primary { background: var(--text, #0b1220); color: white; border-color: var(--text, #0b1220); }
    .sb-acc-btn.primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-acc-btn.accent  { background: var(--accent, #0f766e); color: white; border-color: var(--accent, #0f766e); }

    /* Scenario tabs inside accordion */
    .sb-acc-tabs { display: flex; flex-direction: column; gap: 6px; }
    .sb-acc-tab {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 140ms ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }
    .sb-acc-tab:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-tab.active { background: var(--text, #0b1220); color: white; border-color: var(--text, #0b1220); }

    /* Input rows inside accordion */
    .sb-acc-input-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .sb-acc-input-row:last-child { margin-bottom: 0; }
    .sb-acc-input-row label {
      font-size: 11px;
      color: var(--muted, #5d6b7a);
      flex: 1;
      line-height: 1.3;
    }
    .sb-acc-input-row input[type="number"] {
      width: 76px;
      padding: 5px 7px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      background: white;
      text-align: right;
      flex-shrink: 0;
      -moz-appearance: textfield;
    }
    .sb-acc-input-row input[type="number"]::-webkit-outer-spin-button,
    .sb-acc-input-row input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .sb-acc-input-row input[type="number"]:focus {
      outline: none;
      border-color: var(--accent, #0f766e);
      box-shadow: 0 0 0 2px rgba(15,118,110,0.15);
    }
    .sb-acc-sub {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.07em;
      text-transform: uppercase;
      margin: 10px 0 8px;
      border-top: 1px solid var(--border);
      padding-top: 9px;
    }

    /* Responsive: on mobile sidebar goes full width, no sticky, no scroll */
    @media (max-width: 860px) {
      .sidebar {
        position: static;
        max-height: none;
        overflow-y: visible;
      }
    }

  
    /* ── Tooltip engine: body-level fixed div, never clipped by overflow ── */
    /* Kill ALL CSS ::after tooltip rules — they clip inside overflow containers */
    .help-icon::after,
    .help-icon:hover::after,
    .help-icon[data-help]::after,
    [data-tt]::after,
    [data-tt]:hover::after,
    .term-helper::after,
    .term-helper:hover::after {
      content: none !important;
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }

    /* #tt-root — single fixed tooltip bubble appended to <body> by JS */
    #tt-root {
      position: fixed;
      z-index: 99999;
      pointer-events: none;
      padding: 9px 13px;
      background: rgba(11,18,32,0.95);
      color: #f0f4f8;
      font-size: 12px;
      font-weight: 400;
      line-height: 1.55;
      border-radius: 9px;
      white-space: normal;
      width: 270px;
      max-width: calc(100vw - 24px);
      box-shadow: 0 4px 18px rgba(0,0,0,0.28);
      text-align: left;
      opacity: 0;
      transition: opacity 120ms ease;
    }
    #tt-root.tt-visible { opacity: 1; }

    /* .help-icon visual — keep the badge, remove position:relative (no longer needed) */
    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(15,118,110,0.10);
      border: 1px solid rgba(15,118,110,0.20);
      color: var(--accent);
      font-size: 11px;
      font-weight: 700;
      cursor: help;
      flex-shrink: 0;
      position: static;   /* was relative — not needed with body-level tooltip */
    }
    .help-icon::before { content: '?'; line-height: 1; }

  
    /* ═══════════════════════════════════════════════
       SHARED SIDEBAR SHELL — standardised across all modules
       ═══════════════════════════════════════════════ */

    /* Layout */
    .module-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      align-items: start;
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .main-content { min-width: 0; }

    /* Mobile Controls Toggle Button */
    .mobile-controls-btn {
      display: none;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      cursor: pointer;
      margin-bottom: 4px;
      box-shadow: var(--shadow-soft);
      transition: all 140ms ease;
    }
    .mobile-controls-btn:hover {
      border-color: rgba(12,23,45,0.18);
      box-shadow: var(--shadow);
    }
    .mobile-controls-btn .mcb-icon { font-size: 16px; flex-shrink: 0; }
    .mobile-controls-btn .mcb-label { flex: 1; text-align: left; }
    .mobile-controls-btn .mcb-chevron {
      font-size: 11px; color: var(--muted);
      transition: transform 200ms ease;
    }
    .mobile-controls-btn[aria-expanded="true"] .mcb-chevron { transform: rotate(180deg); }

    /* Sidebar shell */
    .sidebar {
      position: sticky;
      top: 84px;
      padding: 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      max-height: calc(100vh - 104px);
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(12,23,45,0.15) transparent;
      width: 280px;
    }
    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }
    .sidebar::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.28); }

    /* Static section (Data Mode etc — always visible) */
    .sb-static {
      padding-bottom: 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }
    .sb-static-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    /* ── Data Mode segmented control (fixed height, no wrapping) ── */
    .sb-data-mode-row {
      display: flex;
      gap: 0;
      height: 34px;              /* fixed height — prevents layout shift */
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: var(--bg-muted);
      flex-wrap: nowrap;         /* never wrap */
    }
    .sb-data-mode-btn {
      flex: 1;
      min-width: 0;
      height: 100%;
      padding: 0 4px;
      background: transparent;
      border: none;
      border-right: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: background 120ms ease, color 120ms ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: inherit;
    }
    .sb-data-mode-btn:last-child { border-right: none; }
    .sb-data-mode-btn:hover { background: rgba(12,23,45,0.04); color: var(--text); }
    .sb-data-mode-btn.active {
      background: var(--text);
      color: white;
    }

    /* Mode pills (2-option) — also fixed height */
    .sb-mode-pills {
      display: flex;
      gap: 0;
      height: 34px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: var(--bg-muted);
      flex-wrap: nowrap;
    }
    .sb-mode-pill {
      flex: 1;
      height: 100%;
      padding: 0 6px;
      border: none;
      border-right: 1px solid var(--border);
      background: transparent;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: background 120ms ease, color 120ms ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: inherit;
      text-align: center;
    }
    .sb-mode-pill:last-child { border-right: none; }
    .sb-mode-pill:hover { background: rgba(12,23,45,0.04); color: var(--text); }
    .sb-mode-pill.active { background: var(--text); color: white; }

    /* Badge */
    .data-badge {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15,118,110,0.10);
      border: 1px solid rgba(15,118,110,0.20);
      color: var(--accent);
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .data-badge.random {
      background: #fef3c7;
      border-color: #fbbf24;
      color: #92400e;
    }

    /* Accordion groups */
    .sb-acc-group {
      border-bottom: 1px solid var(--border);
    }
    .sb-acc-group:last-child { border-bottom: none; }

    .sb-acc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 12px 0;
      cursor: pointer;
      user-select: none;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      transition: color 120ms ease;
      font-family: inherit;
    }
    .sb-acc-header:hover { color: var(--text); }
    .sb-acc-header.open  { color: var(--text); }
    .sb-acc-chevron {
      font-size: 10px;
      color: var(--muted);
      transition: transform 200ms ease;
      flex-shrink: 0;
    }
    .sb-acc-header.open .sb-acc-chevron { transform: rotate(180deg); color: var(--text); }
    .sb-acc-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      flex-shrink: 0;
      margin-left: auto;
    }

    .sb-acc-body {
      display: none;
      padding-bottom: 14px;
    }
    .sb-acc-body.open { display: block; }

    /* Buttons inside accordion */
    .sb-acc-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      transition: all 140ms ease;
      text-align: left;
      white-space: nowrap;
      font-family: inherit;
    }
    .sb-acc-btn:first-child { margin-top: 0; }
    .sb-acc-btn:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-btn:active { transform: translateY(1px); }
    .sb-acc-btn.primary { background: var(--text); color: white; border-color: var(--text); }
    .sb-acc-btn.primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-acc-btn.accent  { background: var(--accent); color: white; border-color: var(--accent); }

    /* Tabs (scenario selectors etc.) */
    .sb-acc-tabs { display: flex; flex-direction: column; gap: 6px; }
    .sb-acc-tab {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 140ms ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }
    .sb-acc-tab:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-tab.active { background: var(--text); color: white; border-color: var(--text); }

    /* Input rows */
    .sb-acc-input-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .sb-acc-input-row:last-child { margin-bottom: 0; }
    .sb-acc-input-row label {
      font-size: 11px;
      color: var(--muted);
      flex: 1;
      line-height: 1.3;
    }
    .sb-acc-input-row input[type="number"] {
      width: 76px;
      padding: 5px 7px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      background: white;
      text-align: right;
      flex-shrink: 0;
      -moz-appearance: textfield;
    }
    .sb-acc-input-row input[type="number"]::-webkit-outer-spin-button,
    .sb-acc-input-row input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .sb-acc-input-row input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(15,118,110,0.15);
    }
    .sb-acc-sub {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.07em;
      text-transform: uppercase;
      margin: 10px 0 8px;
      border-top: 1px solid var(--border);
      padding-top: 9px;
    }

    /* Action buttons (full-width) */
    .sb-action-btn {
      display: flex; align-items: center; gap: 8px;
      width: 100%; padding: 7px 12px;
      border-radius: 999px; border: 1px solid var(--border);
      background: white; font-size: 12px; font-weight: 600;
      cursor: pointer; margin-top: 6px;
      transition: all 140ms ease; text-align: left;
      white-space: nowrap; font-family: inherit;
    }
    .sb-action-btn:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-action-btn:active { transform: translateY(1px); }
    .sb-action-btn.sb-action-primary { background: var(--text); color: white; border-color: var(--text); }
    .sb-action-btn.sb-action-primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-action-btn.sb-action-accent  { background: var(--accent); color: white; border-color: var(--accent); }
    .sb-file-hidden { position: absolute; opacity: 0; width: 0; height: 0; }

    /* Sliders */
    .control-item { margin-bottom: 16px; }
    .control-item:last-child { margin-bottom: 0; }
    .control-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }
    .control-value {
      font-size: 13px;
      font-weight: 700;
      color: var(--accent-2);
      font-family: var(--font-mono, monospace);
    }
    .control-input {
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 6px;
      border-radius: 3px;
      background: var(--bg-muted);
      outline: none; cursor: pointer;
    }
    .control-input::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
      box-shadow: 0 2px 8px rgba(15,118,110,0.3);
      transition: all 140ms ease;
    }
    .control-input::-webkit-slider-thumb:hover { transform: scale(1.1); }
    .control-input::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
      box-shadow: 0 2px 8px rgba(15,118,110,0.3); border: none;
    }

    /* ── Mobile responsive ── */
    @media (max-width: 860px) {
      .module-layout {
        grid-template-columns: 1fr;
        padding: 16px;
      }
      .mobile-controls-btn { display: flex; }
      .sidebar {
        position: static;
        top: 0;
        width: 100%;
        max-height: none;
        overflow-y: visible;
        display: none;            /* hidden by default; JS toggles */
        border-radius: var(--radius-sm);
        margin-bottom: 8px;
      }
      .sidebar.mobile-open { display: block; }
    }

    @media (max-width: 560px) {
      .module-layout { padding: 12px; }
    }

    /* Download template button — hover via CSS, not inline JS */
    .btn-download-template {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: border-color 140ms ease, box-shadow 140ms ease;
    }
    .btn-download-template:hover {
      border-color: rgba(12, 23, 45, 0.2);
      box-shadow: 0 4px 12px rgba(11, 18, 32, 0.08);
    }

</style>
</head>
<body>

  <a href="#main-content" class="skip-link">Skip to content</a>

  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html" class="brand">
          <span class="brand-mark" aria-hidden="true"></span>
          Ralph Patrick Divina
        </a>
        <div class="nav-cta">
          <a href="index.html#card-operations-spend" class="btn btn-ghost">← Back to Portfolio</a>
        </div>
      </nav>
    </div>
  </header>

  <main id="main-content">
    
    <!-- Hero -->
    <section class="module-hero">
      <div class="container">
        <div class="module-eyebrow">Operations Finance &bull; Budget Operations</div>
        <h1 class="module-title">Operations Finance &amp; Spend Analytics</h1>
        <p class="module-subtitle">Four connected analyses that answer the core operations question: is spend tracking the plan, where is it leaking, and what needs to be resolved before close?</p>
        <div class="feature-chips">
          <span class="chip">Forecast Confidence</span>
          <span class="chip">Accrual Support</span>
          <span class="chip">Rate Discipline</span>
          <span class="chip">Exception Routing</span>
          <span class="chip">Owner Accountability</span>
        </div>
      </div>
    </section>

  <!-- WHY THIS MATTERS STRIP -->
  <div style="background:#f8fafb;border-bottom:1px solid var(--border);padding:18px 0;">
    <div style="max-width:1400px;margin:0 auto;padding:0 24px;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <span style="font-size:16px;flex-shrink:0;">📈</span>
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Forecast signals that hold under review</div>
            <div style="font-size:11px;color:var(--muted);line-height:1.4;">Owner commitments and variance drivers surface before month-end surprises hit the P&amp;L.</div>
          </div>
        </div>
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <span style="font-size:16px;flex-shrink:0;">🔍</span>
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Rate discipline before payment</div>
            <div style="font-size:11px;color:var(--muted);line-height:1.4;">Rate mismatches and missing POs are caught and routed to Procurement before invoices are released.</div>
          </div>
        </div>
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <span style="font-size:16px;flex-shrink:0;">📋</span>
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Accrual visibility before period close</div>
            <div style="font-size:11px;color:var(--muted);line-height:1.4;">Open accruals tracked by vendor and month — AP knows exactly what to chase before the close deadline.</div>
          </div>
        </div>
        <div style="display:flex;align-items:flex-start;gap:10px;">
          <span style="font-size:16px;flex-shrink:0;">🤝</span>
          <div>
            <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Structured intake, less manual chasing</div>
            <div style="font-size:11px;color:var(--muted);line-height:1.4;">Clear field ownership and async-first data collection reduce back-and-forth across regions and time zones.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DATA NEEDED STRIP -->
  <div class="data-needed-section">
    <div class="data-needed-wrap">
      <div class="data-needed-label">📂 &nbsp;One structured intake drives a complete spend management workflow</div>
      <div class="data-needed-grid" style="grid-template-columns:1fr 1fr 1fr 1fr 1fr;">
        <div class="data-needed-item" style="border-color:rgba(15,118,110,0.30);background:#f0fdf9;">
          <div class="data-needed-icon" style="background:rgba(15,118,110,0.12);">📄</div>
          <div>
            <div class="data-needed-name">Single Flat CSV</div>
            <div class="data-needed-desc">One row per invoice line — all 4 workflow layers run from this file. Owner fields built in.</div>
          </div>
        </div>
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#eff6ff;">🔍</div><div><div class="data-needed-name">Rate Checks</div><div class="data-needed-desc">Vendor billed above contract? Flags every overbilled line with dollar leakage quantified for Procurement.</div></div></div>
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#fef3c7;">📦</div><div><div class="data-needed-name">Accrual Review</div><div class="data-needed-desc">Costs incurred but not yet invoiced? Surfaces open accruals by vendor and month before period close.</div></div></div>
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#f5f3ff;">📊</div><div><div class="data-needed-name">Forecast Variance</div><div class="data-needed-desc">Is spend tracking the plan? Separates timing-only variance from true overruns so action is targeted.</div></div></div>
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#fdf2f8;">⚑</div><div><div class="data-needed-name">Exception Follow-up</div><div class="data-needed-desc">Missing POs, duplicate invoices, spend spikes — each flagged with a likely owner and next action.</div></div></div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════
       DATA COLLECTION PLAYBOOK — OPS FINANCE / SPEND ANALYTICS
       Collapsible, open by default, placed before all 4 modules
  ═══════════════════════════════════════════════════════ -->
  <section id="playbook-section" style="border-bottom:1px solid var(--border);background:#fafbfc;">
    <div style="max-width:1400px;margin:0 auto;padding:0 24px;">

      <!-- Toggle header -->
      <button
        id="playbookToggleBtn"
        onclick="togglePlaybook()"
        style="width:100%;display:flex;align-items:center;justify-content:space-between;gap:16px;
               padding:18px 0;background:none;border:none;cursor:pointer;font-family:inherit;text-align:left;"
        aria-expanded="true"
        aria-controls="playbookBody">
        <div style="display:flex;align-items:center;gap:12px;">
          <span style="font-size:18px;">🗂️</span>
          <div>
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--muted);margin-bottom:2px;">Behind the Model</div>
            <div style="font-size:16px;font-weight:700;color:var(--text);letter-spacing:-0.02em;">Operations Data Framework — How Fragmented Owner Inputs Become a Forecast-Ready Baseline</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;flex-shrink:0;">
          <span class="playbook-hint" style="font-size:11px;font-weight:600;color:var(--muted);white-space:nowrap;">Click to collapse</span>
          <span id="playbookChevron" style="font-size:14px;color:var(--muted);transition:transform 200ms ease;">▲</span>
        </div>
      </button>

      <!-- Playbook body — open by default -->
      <div id="playbookBody" style="padding-bottom:32px;">
        <div style="max-width:960px;margin:0 auto;">

        <!-- Intro -->
        <div style="margin-bottom:28px;">
          <p style="font-size:14px;color:var(--muted);line-height:1.65;margin-bottom:10px;">
            In a large, globally distributed organisation, spend data rarely arrives clean or centralised. Invoice lines live in the AP system, contract rates sit in procurement, accruals are tracked in spreadsheets, and forecast figures come from cost center managers across multiple regions and time zones — with no single person responsible for reconciling them. The result: Finance discovers gaps only at month-end, when it's too late to act cleanly.
          </p>
          <p style="font-size:14px;color:var(--muted);line-height:1.65;">
            Below is how I approach this systematically — mapping field ownership before collection starts, handling data quality issues before they reach the model, and giving budget owners a structured, lightweight way to contribute. The goal is forecast-ready visibility without creating overhead for teams that are already stretched.
          </p>
        </div>

        <!-- ── Step 1: Stakeholder → Field Ownership Map ── -->
        <div style="margin-bottom:32px;">
          <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:0.09em;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px;">
            <span style="width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0;">1</span>
            Stakeholder → Field Ownership Map
          </div>
          <p style="font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:16px;">
            Every column in this module's schema has a single owner. Mapping this before data collection starts prevents the most common failure: three teams partially filling in the same field with different definitions and different source systems.
          </p>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;">

            <!-- Procurement -->
            <div style="padding:14px 16px;border:1px solid var(--border);border-radius:12px;background:white;border-left:3px solid #0f766e;">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#0f766e;margin-bottom:6px;">Procurement</div>
              <div style="font-size:12px;color:var(--text);font-weight:600;margin-bottom:4px;">Contract Terms &amp; Vendor Master</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.5;">Source of truth for agreed rates and vendor identity. Owns the contract — so any discrepancy between <code>contract_rate</code> and what the vendor bills is a procurement issue to resolve, not a Finance guess to make.</div>
              <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;">
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,118,110,0.08);color:#0f766e;font-weight:600;">vendor_id</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,118,110,0.08);color:#0f766e;font-weight:600;">vendor_name</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,118,110,0.08);color:#0f766e;font-weight:600;">contract_rate</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,118,110,0.08);color:#0f766e;font-weight:600;">unit</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,118,110,0.08);color:#0f766e;font-weight:600;">po_id</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(15,118,110,0.08);color:#0f766e;font-weight:600;">service</span>
              </div>
            </div>

            <!-- Accounts Payable / Finance Ops -->
            <div style="padding:14px 16px;border:1px solid var(--border);border-radius:12px;background:white;border-left:3px solid #1b4d7a;">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#1b4d7a;margin-bottom:6px;">Accounts Payable / Finance Ops</div>
              <div style="font-size:12px;color:var(--text);font-weight:600;margin-bottom:4px;">Invoice Actuals &amp; Accruals</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.5;">Owns what was actually billed and what has been accrued. In leaner Finance teams — particularly in regions with limited coverage — this data often lives in the AP system but hasn't been reconciled to the accrual ledger, which is where open accruals accumulate silently.</div>
              <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;">
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(27,77,122,0.08);color:#1b4d7a;font-weight:600;">invoice_id</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(27,77,122,0.08);color:#1b4d7a;font-weight:600;">invoiced_amount</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(27,77,122,0.08);color:#1b4d7a;font-weight:600;">accrual_amount</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(27,77,122,0.08);color:#1b4d7a;font-weight:600;">date</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(27,77,122,0.08);color:#1b4d7a;font-weight:600;">amount</span>
              </div>
            </div>

            <!-- Budget Owners / Cost Center Managers -->
            <div style="padding:14px 16px;border:1px solid var(--border);border-radius:12px;background:white;border-left:3px solid #d97706;">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#d97706;margin-bottom:6px;">Budget Owners / Cost Center Managers</div>
              <div style="font-size:12px;color:var(--text);font-weight:600;margin-bottom:4px;">Forecast &amp; Budget Figures</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.5;">In large orgs with many budget owners across regions, forecast accuracy varies significantly. Each cost center manager owns their planned spend — but without a structured intake, forecast submissions arrive in different formats, at different levels of granularity, and sometimes after the close window.</div>
              <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;">
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(217,119,6,0.10);color:#b45309;font-weight:600;">cost_center</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(217,119,6,0.10);color:#b45309;font-weight:600;">forecast_amount</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(217,119,6,0.10);color:#b45309;font-weight:600;">budget_amount</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(217,119,6,0.10);color:#b45309;font-weight:600;">category</span>
              </div>
            </div>

            <!-- Vendor / Operations -->
            <div style="padding:14px 16px;border:1px solid var(--border);border-radius:12px;background:white;border-left:3px solid #7c3aed;">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#7c3aed;margin-bottom:6px;">Vendor / Operations</div>
              <div style="font-size:12px;color:var(--text);font-weight:600;margin-bottom:4px;">Actual Unit Consumption</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.5;">What was delivered, and at what rate. The gap between <code>unit_rate</code> (what the vendor charged) and <code>contract_rate</code> (what was agreed) is the core of rate leakage detection. This data comes from vendor invoices — and is the field most likely to arrive late or inconsistently formatted in decentralized or regional teams.</div>
              <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;">
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(124,58,237,0.08);color:#7c3aed;font-weight:600;">unit_rate</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(124,58,237,0.08);color:#7c3aed;font-weight:600;">units</span>
                <span style="font-size:10px;padding:2px 7px;border-radius:999px;background:rgba(124,58,237,0.08);color:#7c3aed;font-weight:600;">service</span>
              </div>
            </div>

          </div>
        </div>

        <!-- ── Step 2: Messy → Clean ── -->
        <div style="margin-bottom:32px;">
          <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:0.09em;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px;">
            <span style="width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0;">2</span>
            Messy Input → Clean Schema — What the Reality Looks Like
          </div>
          <p style="font-size:13px;color:var(--muted);line-height:1.6;margin-bottom:16px;max-width:700px;">
            In a global ops finance environment managing significant program spend across a large distributed network of budget owners, this is the data that actually arrives — and what to do with each problem before it reaches the model.
          </p>
          <div style="overflow-x:auto;border:1px solid var(--border);border-radius:12px;">
            <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:640px;">
              <thead>
                <tr style="background:rgba(246,248,251,0.9);">
                  <th style="padding:10px 14px;text-align:left;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);border-bottom:1px solid var(--border);">What Comes In</th>
                  <th style="padding:10px 14px;text-align:left;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);border-bottom:1px solid var(--border);">Why It's a Problem</th>
                  <th style="padding:10px 14px;text-align:left;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);border-bottom:1px solid var(--border);">How I Handle It</th>
                </tr>
              </thead>
              <tbody>
                <tr style="border-bottom:1px solid var(--border);">
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">Vendor invoice has no PO reference (<code>po_id</code> is blank)</td>
                  <td style="padding:10px 14px;color:#dc2626;">Rate leakage and anomaly detection both require a matched PO. Unmatched invoices are the most common source of duplicate payments and off-contract spend.</td>
                  <td style="padding:10px 14px;color:#0f766e;">Invoice is flagged automatically as "Missing PO" in Section 4. AP team is notified before payment is released. Procurement confirms whether a verbal approval exists or whether the invoice should be rejected.</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border);background:rgba(246,248,251,0.4);">
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;"><code>unit_rate</code> on invoice is 3–5% above <code>contract_rate</code> — no explanation provided</td>
                  <td style="padding:10px 14px;color:#dc2626;">Silent rate leakage. Vendors incrementally overbill without raising a formal amendment — it goes undetected unless someone compares the invoice rate to the contracted rate line by line.</td>
                  <td style="padding:10px 14px;color:#0f766e;">Rate variance is calculated for every invoice line. Any line above the threshold (default 20%) is flagged in Section 1 with dollar leakage quantified. Procurement is the resolver — Finance provides the evidence.</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border);">
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">Accruals tracked in a regional spreadsheet, not matched to the AP system</td>
                  <td style="padding:10px 14px;color:#dc2626;">Accrued amounts and invoiced amounts can't be reconciled. Open accruals accumulate month after month — especially in regions with limited Finance headcount — creating P&amp;L distortion at period close.</td>
                  <td style="padding:10px 14px;color:#0f766e;">The intake template requires both <code>accrual_amount</code> and <code>invoiced_amount</code> per line. The model computes the gap. Section 2 surfaces every open accrual with the vendor and month it belongs to — no manual hunting required.</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border);background:rgba(246,248,251,0.4);">
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">Same service billed twice in the same period by the same vendor (<code>invoice_id</code> duplicated or varied slightly)</td>
                  <td style="padding:10px 14px;color:#dc2626;">Duplicate invoices cause double-payment. Vendors sometimes resubmit with a slightly different invoice number — which passes basic duplicate checks but represents the same spend event.</td>
                  <td style="padding:10px 14px;color:#0f766e;">Section 4 anomaly detection flags statistical spend spikes per category and month. AP team is responsible for confirming whether a spike is a genuine duplicate or a legitimate volume increase.</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border);">
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">Cost center codes inconsistent across regions — some regions use a different CC format than the ERP standard</td>
                  <td style="padding:10px 14px;color:#dc2626;">Forecast vs actual variance analysis breaks if cost center codes don't match. Regional submissions often arrive with local CC identifiers that don't map cleanly to the global chart of accounts.</td>
                  <td style="padding:10px 14px;color:#0f766e;">The template includes a CC lookup tab with the global-to-regional mapping pre-filled. Regional leads validate their CC codes against this before submission. A validation script flags any unrecognised CC on upload.</td>
                </tr>
                <tr style="border-bottom:1px solid var(--border);background:rgba(246,248,251,0.4);">
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">Forecast data from Workday, actuals from the AP system — different levels of aggregation, never reconciled before the model</td>
                  <td style="padding:10px 14px;color:#dc2626;">Forecast is at category+month level; actuals are at invoice line level. Without a reconciliation step, comparing them produces meaningless variance figures.</td>
                  <td style="padding:10px 14px;color:#0f766e;">The flat schema is the reconciliation layer. <code>forecast_amount</code> and <code>budget_amount</code> are repeated on each invoice row, then aggregated by the model to the right level for comparison. One upload, one reconciliation pass.</td>
                </tr>
                <tr>
                  <td style="padding:10px 14px;color:var(--text);font-weight:600;">Regional vendors submit invoices 15–30 days after the service period, after the close window</td>
                  <td style="padding:10px 14px;color:#dc2626;">Late invoices mean accruals are understated at close. The P&amp;L looks better than it is — then corrects sharply when invoices arrive. Finance teams with limited regional coverage can't chase vendors manually.</td>
                  <td style="padding:10px 14px;color:#0f766e;">The intake process sets a submission deadline 5 days before close. Any vendor not invoiced by that date is flagged as an open accrual using the prior-period average as the estimated amount. Section 2 highlights these explicitly.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ── Step 3: Template + Process ── -->
        <div style="margin-bottom:32px;">
          <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:0.09em;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px;">
            <span style="width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0;">3</span>
            The Intake Template — 17 Columns, 4 Owners, One File
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div style="padding:16px 18px;border:1px solid var(--border);border-radius:12px;background:white;">
              <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px;">What's in the template</div>
              <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px;">
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">✓</span>All 17 required columns pre-labelled with data type and accepted values</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">✓</span>An "Owner" row at row 1 mapping each column to Procurement / AP / Budget Owner / Vendor Ops</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">✓</span>A "Source System" row at row 2 — ERP / AP system / Procurement portal / manual — so contributors know where to pull each field from</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">✓</span>A CC lookup tab with global-to-regional cost center mappings pre-filled for each region</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">✓</span>Two pre-filled example rows — one with rate leakage, one clean — so contributors immediately see what correct vs. flagged data looks like</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">✓</span>A "Confidence" field (Confirmed / Estimated / Pending) — so the model can flag which rows are based on assumptions vs. verified actuals</li>
              </ul>
            </div>
            <div style="padding:16px 18px;border:1px solid var(--border);border-radius:12px;background:white;">
              <div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:8px;">The async-first collection process for a remote, multi-region team</div>
              <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px;">
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#1b4d7a;font-weight:700;flex-shrink:0;">1.</span>Template + submission deadline shared via async message (Slack / email) to each regional lead — one contact per region consolidates their own team's inputs. No cross-timezone kick-off call needed.</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#1b4d7a;font-weight:700;flex-shrink:0;">2.</span>Shared tracker (e.g. Airtable) shows submission status per owner, region, and vendor — Finance has live visibility without chasing individuals over email.</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#1b4d7a;font-weight:700;flex-shrink:0;">3.</span>Validation script runs on each submission — flags specific errors (missing PO, unrecognised CC, <code>unit_rate</code> above contract) and sends back a targeted query, not a generic "please fix".</li>
                <li style="font-size:12px;color:var(--muted);display:flex;align-items:flex-start;gap:8px;"><span style="color:#1b4d7a;font-weight:700;flex-shrink:0;">4.</span>For regions with leaner Finance coverage — the template is pre-populated with prior-period actuals as defaults. Contributors only need to update what changed, reducing the effort to submit.</li>
              </ul>
            </div>
          </div>
          <div style="margin-top:12px;">
            <button onclick="downloadFlatTemplate()" class="btn-download-template">
              ⬇ Download the Unified CSV Template
            </button>
            <span style="font-size:11px;color:var(--muted);margin-left:12px;">17 columns. 4 owners. One file. All 4 modules update on upload.</span>
          </div>
        </div>

        <!-- ── Step 4: Alignment Note ── -->
        <div style="margin-bottom:8px;">
          <div style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:0.09em;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px;">
            <span style="width:20px;height:20px;border-radius:50%;background:var(--accent);color:white;font-size:10px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0;">4</span>
            Stakeholder Alignment — What I Do When Procurement, AP, and Budget Owners Don't Agree on the Numbers
          </div>
          <div style="padding:20px 24px;border:1px solid rgba(15,118,110,0.25);border-radius:14px;background:#f0fdf9;">
            <p style="font-size:13px;color:var(--text);line-height:1.7;margin-bottom:12px;">
              In a large, fully remote, multi-region ops finance environment — with a distributed network of budget owners, regional Finance teams, and data split across an ERP, an AP system, and procurement tooling — alignment doesn't happen automatically. Here's how I structure it:
            </p>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div style="display:flex;align-items:flex-start;gap:12px;">
                <span style="width:24px;height:24px;border-radius:6px;background:rgba(15,118,110,0.15);color:#0f766e;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">A</span>
                <div>
                  <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Agree on definitions before the template goes out — not after the data comes back</div>
                  <div style="font-size:12px;color:var(--muted);line-height:1.55;">The most common conflict in ops finance data collection: Procurement defines "contract rate" as the rate in the signed MSA; AP defines it as the rate on the most recent PO amendment; the budget owner doesn't distinguish between the two. A one-page definition doc, shared and signed off by all three before collection opens, eliminates most disputes before they start. In a distributed team, I publish this asynchronously and give 48 hours to flag disagreements — most stakeholders respond within one working day, regardless of time zone.</div>
                </div>
              </div>
              <div style="display:flex;align-items:flex-start;gap:12px;">
                <span style="width:24px;height:24px;border-radius:6px;background:rgba(15,118,110,0.15);color:#0f766e;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">B</span>
                <div>
                  <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Make Procurement the resolver, not Finance — Finance provides the evidence</div>
                  <div style="font-size:12px;color:var(--muted);line-height:1.55;">When the model flags a rate mismatch, Finance's job is to quantify and surface it — not to adjudicate it. The escalation path is clear: Finance flags the leakage with the dollar amount and the invoice line, Procurement confirms whether it was approved or not, and AP either holds or releases the payment. This keeps Finance out of vendor relationship decisions while ensuring nothing falls through the cracks between teams.</div>
                </div>
              </div>
              <div style="display:flex;align-items:flex-start;gap:12px;">
                <span style="width:24px;height:24px;border-radius:6px;background:rgba(15,118,110,0.15);color:#0f766e;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">C</span>
                <div>
                  <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Be explicit about data quality — especially where coverage is limited</div>
                  <div style="font-size:12px;color:var(--muted);line-height:1.55;">When accruals are estimated rather than confirmed — because the vendor hasn't invoiced yet or the AP team hasn't had time to reconcile — the model output says so. A "Confidence: Estimated" tag on an accrual row is more useful to a Finance Director than a clean-looking number that's actually a placeholder. It also protects the analyst: when the actual invoice arrives and differs from the estimate, the discrepancy is documented and expected, not a surprise.</div>
                </div>
              </div>
              <div style="display:flex;align-items:flex-start;gap:12px;">
                <span style="width:24px;height:24px;border-radius:6px;background:rgba(15,118,110,0.15);color:#0f766e;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">D</span>
                <div>
                  <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;">Reduce the collection burden on high-volume, under-resourced regions</div>
                  <div style="font-size:12px;color:var(--muted);line-height:1.55;">A Finance team supporting a region with significant vendor complexity but limited headcount can't afford a heavy data collection process every month. The solution: pre-populate the template with prior-period data and mark what's changed. Require input only on the delta. Keep the submission to 10–15 minutes of effort for a regional contact who already has the source data open. The goal is accurate spend data with the least possible friction for the people responsible for producing it.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        </div><!-- /inner-centered-wrapper -->
      </div><!-- /playbookBody -->
    </div><!-- /container -->
  </section>

    <!-- Main Layout with Sidebar -->
    <div class="module-layout">
      
      <!-- Sticky Sidebar -->
          <!-- Mobile Controls Toggle (hidden on desktop) -->
    <button class="mobile-controls-btn" id="mobileControlsBtn" aria-expanded="false">
      <span class="mcb-icon">&#9881;</span>
      <span class="mcb-label">Controls</span>
      <span class="mcb-chevron">&#9660;</span>
    </button>
    <aside class="sidebar" id="sidebarPanel">

      <!-- Data Mode — always visible -->
      <div class="sb-static">
        <div class="sb-static-title">
          <span>DATA MODE</span>
          <span id="dataModeBadge" class="data-badge">SAMPLE</span>
        </div>
        <div style="display:flex;gap:0;height:34px;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--bg-muted);flex-wrap:nowrap;">
          <button id="btnSampleMode" onclick="useSampleData()" style="flex:1;height:100%;padding:0 4px;background:var(--text);color:white;border:none;border-right:1px solid var(--border);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;">Sample</button>
          <button id="btnRandomMode" onclick="randomizeSampleData()" style="flex:1;height:100%;padding:0 4px;background:transparent;border:none;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;font-family:inherit;">Random</button>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:6px;line-height:1.4;">Sample = fixed demo dataset &bull; Random = generated dataset</div>
      </div>

      <!-- Actions -->
      <div class="sb-acc-group">
        <button class="sb-acc-header" onclick="sidebarAccordion(this)">
          <span>Actions</span>
          <span class="sb-acc-chevron">▼</span>
        </button>
        <div class="sb-acc-body">
          <button onclick="useSampleData()" class="sb-acc-btn">Use Sample Data</button>
          <button onclick="randomizeSampleData()" class="sb-acc-btn primary">🎲 Generate Random</button>
          <button onclick="loadWorstCase()" class="sb-acc-btn" style="background:#fef2f2;border-color:rgba(220,38,38,0.35);color:#dc2626;margin-top:4px;">🔴 Worst Case Demo</button>
        </div>
      </div>

      <!-- Upload Data -->
      <div class="sb-acc-group">
        <button class="sb-acc-header" onclick="sidebarAccordion(this)">
          <span>Upload Your Data</span>
          <span id="sbUploadLabel" class="sb-acc-badge">CSV</span>
          <span class="sb-acc-chevron">▼</span>
        </button>
        <div class="sb-acc-body">
          <div style="font-size:10px;color:var(--muted);margin-bottom:10px;line-height:1.6;">Upload <strong>one flat CSV</strong> — one row per invoice line with all columns. The module derives rate leakage, accruals, and forecast from this single file.</div>
          <div style="position:relative;margin-top:4px;">
            <input type="file" id="flatUpload" accept=".csv" onchange="handleFlatUpload(event)" style="position:absolute;opacity:0;width:100%;height:100%;cursor:pointer;z-index:2;">
            <button class="sb-acc-btn primary" style="width:100%;">📄 Upload Spend CSV</button>
          </div>
          <button onclick="downloadFlatTemplate()" class="sb-acc-btn" style="margin-top:6px;width:100%;">⬇ Download Template</button>
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);margin-bottom:8px;">Export Current Dataset</div>
            <button onclick="exportDatasetXLSX()" class="sb-acc-btn" style="width:100%;">📊 Export as Excel (.xlsx)</button>
            <button onclick="exportDatasetCSV()" class="sb-acc-btn" style="margin-top:4px;width:100%;">📋 Export as CSV</button>
          </div>
        </div>
      </div>

    </aside>

      <!-- Main Content -->
      <div class="main-content">

        <!-- DECISION BOX -->
        <div class="decision-box" id="spendDecisionBox" aria-label="Spend Decision Summary">
          <div class="decision-box-eyebrow">Decision</div>
          <div class="decision-box-fallback" id="spendDecisionFallback">Load sample or upload data to see the decision.</div>
          <div id="spendDecisionContent" style="display:none;">
            <div id="spendDecisionSummary" style="font-size:13px;color:var(--muted);margin-bottom:10px;line-height:1.5;"></div>
            <div class="decision-box-verdict" id="spendDecisionVerdict"></div>
            <div class="decision-box-exceptions" id="spendDecisionExceptions"></div>
          </div>
        </div>

        <!-- BUDGET OWNER WATCHLIST -->
        <div style="margin-bottom:28px;padding:18px 20px;border:1px solid var(--border);border-radius:var(--radius);background:white;box-shadow:var(--shadow-soft);">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:12px;flex-wrap:wrap;">
            <div>
              <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:var(--muted);margin-bottom:3px;">Owner Accountability</div>
              <div style="font-size:15px;font-weight:700;color:var(--text);">Budget-Owner Watchlist
                <span class="help-icon" data-help="A budget owner is the person responsible for a specific area of spend — e.g. a campaign manager, regional marketing lead, or operations head. This watchlist surfaces items that need their input or follow-up before Finance can close cleanly."></span>
              </div>
            </div>
            <span style="font-size:11px;font-weight:600;padding:3px 10px;border-radius:999px;background:rgba(245,158,11,0.12);color:#92400e;">Requires follow-up</span>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;">
            <div style="padding:12px 14px;border:1px solid rgba(220,38,38,0.20);border-radius:10px;background:rgba(220,38,38,0.02);">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#dc2626;margin-bottom:5px;">🔴 Missing PO Support</div>
              <div style="font-size:12px;color:var(--text);margin-bottom:3px;font-weight:600;">Invoice received, no PO attached</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.4;">AP cannot process. Owner must confirm verbal approval or reject invoice. → <strong>Procurement</strong></div>
            </div>
            <div style="padding:12px 14px;border:1px solid rgba(245,158,11,0.25);border-radius:10px;background:rgba(245,158,11,0.02);">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#b45309;margin-bottom:5px;">⚠️ Estimate-Only Rows</div>
              <div style="font-size:12px;color:var(--text);margin-bottom:3px;font-weight:600;">Accrual based on estimate, not confirmed</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.4;">Forecast confidence is Medium. Owner needs to confirm or submit invoice before close. → <strong>Budget Owner</strong></div>
            </div>
            <div style="padding:12px 14px;border:1px solid rgba(245,158,11,0.25);border-radius:10px;background:rgba(245,158,11,0.02);">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#b45309;margin-bottom:5px;">⚠️ Delivered Not Invoiced</div>
              <div style="font-size:12px;color:var(--text);margin-bottom:3px;font-weight:600;">Service delivered, invoice outstanding</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.4;">Accrual posted but no invoice to match against. Chase vendor or use prior-period average. → <strong>AP / Finance Ops</strong></div>
            </div>
            <div style="padding:12px 14px;border:1px solid rgba(107,114,128,0.20);border-radius:10px;background:rgba(107,114,128,0.02);">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#6b7280;margin-bottom:5px;">📋 Forecast Input Pending</div>
              <div style="font-size:12px;color:var(--text);margin-bottom:3px;font-weight:600;">Owner hasn't submitted for this period</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.4;">Forecast confidence is Low. Template deadline has passed — Finance uses prior-period default until submission arrives. → <strong>Budget Owner</strong></div>
            </div>
            <div style="padding:12px 14px;border:1px solid rgba(107,114,128,0.20);border-radius:10px;background:rgba(107,114,128,0.02);">
              <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;color:#6b7280;margin-bottom:5px;">📋 Pending Procurement Sign-off</div>
              <div style="font-size:12px;color:var(--text);margin-bottom:3px;font-weight:600;">Committed spend, contract not yet finalised</div>
              <div style="font-size:11px;color:var(--muted);line-height:1.4;">Cannot book accrual until deal terms are confirmed. Escalate if within 10 days of close. → <strong>Procurement</strong></div>
            </div>
          </div>
          <!-- Dynamic Forecast Confidence Bar -->
          <div class="conf-bar-wrap" id="forecastConfidenceBar">
            <div class="conf-bar-header">
              <div class="conf-bar-title">
                📊 Forecast Confidence
                <span class="help-icon" data-help="Sourced from the invoiced_amount and accrual_amount columns of the same flat CSV that powers all 4 sections. These two columns split each row's total spend into: (1) the portion already matched to a confirmed invoice, and (2) the portion incurred but not yet billed. The confidence total will differ from Section 1's Total Spend because Section 1 sums the raw amount column (everything vendors billed), while confidence measures only the reconciled invoice-matched portion."></span>
              </div>
              <span class="conf-summary-pill high" id="confOverallPill">Load data to compute</span>
            </div>
            <div class="conf-stacked-bar" id="confStackedBar">
              <div class="conf-seg high"   id="confSegHigh"   style="width:0%"></div>
              <div class="conf-seg medium" id="confSegMedium" style="width:0%"></div>
              <div class="conf-seg low"    id="confSegLow"    style="width:0%"></div>
            </div>
            <div class="conf-legend">
              <div class="conf-legend-item">
                <div class="conf-legend-dot high"></div>
                <span class="conf-legend-pct" id="confPctHigh">—</span>
                <span>High — <code style="font-size:9px;background:rgba(12,23,45,0.06);padding:1px 4px;border-radius:3px;">invoiced_amount</code> confirmed &amp; matched</span>
              </div>
              <div class="conf-legend-item">
                <div class="conf-legend-dot medium"></div>
                <span class="conf-legend-pct" id="confPctMedium">—</span>
                <span>Medium — <code style="font-size:9px;background:rgba(12,23,45,0.06);padding:1px 4px;border-radius:3px;">accrual_amount</code> incurred, not yet invoiced</span>
              </div>
              <div class="conf-legend-item">
                <div class="conf-legend-dot low"></div>
                <span class="conf-legend-pct" id="confPctLow">—</span>
                <span>Low — forecast rows with no transaction backing</span>
              </div>
            </div>
            <div id="confNarrative" style="margin-top:8px;font-size:11px;color:var(--muted);line-height:1.5;display:none;"></div>
            <div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(15,118,110,0.12);font-size:10px;color:var(--muted);line-height:1.5;">
              <strong style="color:#0f766e;">Same CSV, different columns.</strong> Section 1 sums the <code style="background:rgba(12,23,45,0.06);padding:1px 4px;border-radius:3px;">amount</code> column (everything vendors billed). Confidence sums <code style="background:rgba(12,23,45,0.06);padding:1px 4px;border-radius:3px;">invoiced_amount</code> + <code style="background:rgba(12,23,45,0.06);padding:1px 4px;border-radius:3px;">accrual_amount</code> (the reconciled split). The difference between the two totals is the unreconciled gap — costs billed but not yet matched to the accrual ledger.
            </div>
          </div>
        </div>

        <!-- Rate Leakage -->
        <section class="module-section" id="section-rate-leakage">
        <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
          1. Vendor Rate Cards &amp; Rate Discipline
          <span class="help-icon" data-help="Checks whether vendors are billing at exactly the rate agreed in the contract. Silent overbilling — where the invoiced rate is even a few percent above the contracted rate — compounds across high-volume vendors and drains budget without raising a flag. This section catches it line by line."></span>
        </h2>
        <p style="font-size:13px;color:var(--muted);margin:-8px 0 16px;line-height:1.5;">Vendors billing above contracted rates is the most common silent budget drain — it compounds across high-volume vendors and rarely surfaces unless explicitly checked. Route flagged lines to <strong style="color:var(--text);">Procurement</strong> for contract validation. Finance quantifies the leakage; Procurement resolves and documents any approved rate exceptions before the next payment cycle.</p>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Rate Leakage Analysis <span class="help-icon" data-help="'Leakage' is the money that quietly flows out because actual invoiced rates exceed contracted rates. This analysis totals up that gap across all vendors so you can see the financial impact and prioritise who to challenge first."></span></h3>
            <div class="card-actions">
              <button onclick="downloadRateLeakageCSV()" class="btn-small">Export Results</button>
            </div>
          </div>

          <div class="filter-row">
            <label>Month:</label>
            <select id="rateMonthFilter" onchange="renderRateLeakage()">
              <option value="all">All Months</option>
            </select>
            <label>Category:</label>
            <select id="rateCategoryFilter" onchange="renderRateLeakage()">
              <option value="all">All Categories</option>
            </select>
            <label>Vendor:</label>
            <select id="rateVendorFilter" onchange="renderRateLeakage()">
              <option value="all">All Vendors</option>
            </select>
          </div>

          <div class="kpi-grid" id="rateKPIs">
            <!-- KPIs populated by JS -->
          </div>

          <div class="chart-container">
            <div class="chart-title">Top 8 Vendors by Leakage</div>
            <div class="chart-wrapper">
              <canvas id="leakageChart" class="chart-canvas"></canvas>
            </div>
          </div>

          <!-- So What: Rate Leakage — rendered dynamically by JS -->
          <div id="rateSoWhat" style="margin:16px 0 8px;padding:18px 20px;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,0.06);display:none;min-height:180px;max-height:180px;overflow-y:auto;box-sizing:border-box;scrollbar-width:thin;scrollbar-color:rgba(12,23,45,0.18) transparent;">
            <div id="rateSoWhatLabel" style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;"></div>
            <ul id="rateSoWhatList" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;"></ul>
          </div>

          <div id="rateTableScroll" style="height:401px;min-height:401px;overflow-y:auto;overflow-x:auto;border:1px solid var(--border);border-radius:10px;scrollbar-width:thin;scrollbar-color:rgba(12,23,45,0.15) transparent;">
            <table class="data-table" id="rateTable" style="margin:0;border:none;border-radius:0;">
              <!-- Table populated by JS -->
            </table>
          </div>
        </div>
    </section>

    <!-- Accrual Tracking -->
    <section class="module-section section-muted" id="section-accruals">
      <div class="container">
        <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
          2. Accrual Tracking — Incurred Not Yet Invoiced
          <span class="help-icon" data-help="An accrual is a cost already incurred (e.g. a month of IT services or facilities support) but not yet billed. Tracking accruals keeps your P&L accurate at close — it shows true costs for the period, not just what invoices happened to arrive. Open accruals left unresolved create P&L distortion and close-risk."></span>
        </h2>
        <p style="font-size:13px;color:var(--muted);margin:-8px 0 16px;line-height:1.5;">Open accruals left unresolved at period close create P&amp;L distortion and audit exposure. Flag outstanding vendor-months <em>before</em> close — not after. <strong style="color:var(--text);">AP / Finance Ops</strong> should reconcile each open balance against the expected invoice and document large items in close commentary. A clean accrual schedule is the difference between a close that runs on time and one that doesn't.</p>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Accrual Schedule <span class="help-icon" data-help="A month-by-month record of costs incurred vs. invoices actually received. The gap between the two is the 'accrual' — money owed but not yet billed. Invoice Count shows how many distinct invoices were received that month, so you can cross-check the Decision Box's 'Open accruals' count directly."></span></h3>
            <div class="card-actions">
              <button onclick="downloadAccrualsCSV()" class="btn-small">Export Schedule</button>
            </div>
          </div>

          <div class="kpi-grid" id="accrualKPIs">
            <!-- KPIs populated by JS -->
          </div>

          <div class="chart-container">
            <div class="chart-title">Accrued vs Invoiced Trend</div>
            <div class="chart-wrapper">
              <canvas id="accrualChart" class="chart-canvas"></canvas>
            </div>
          </div>

          <!-- So What: Accrual Schedule — rendered dynamically by JS -->
          <div id="accrualSoWhat" style="margin:16px 0 8px;padding:18px 20px;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,0.06);display:none;min-height:180px;max-height:180px;overflow-y:auto;box-sizing:border-box;scrollbar-width:thin;scrollbar-color:rgba(12,23,45,0.18) transparent;">
            <div id="accrualSoWhatLabel" style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;"></div>
            <ul id="accrualSoWhatList" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;"></ul>
          </div>

          <div id="accrualTableBanner"></div>

          <table class="data-table" id="accrualTable">
            <!-- Table populated by JS -->
          </table>
        </div>
    </section>

    <!-- Forecast vs Actual -->
    <section class="module-section" id="section-forecast">
        <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
          3. Forecast vs Actual Spend
          <span class="help-icon" data-help="Compares planned spend against what was actually incurred. The goal is to separate true overruns from timing-only variance — and catch budget risk early enough to act. A variance isn't always a problem: some months run high because invoices arrive late, not because spending increased."></span>
        </h2>
        <p style="font-size:13px;color:var(--muted);margin:-8px 0 16px;line-height:1.5;">Not every unfavorable variance is a real spend problem — and escalating the wrong ones erodes trust with budget owners. Before escalating, identify the driver: <strong style="color:var(--text);">timing</strong> (invoice arrived in the wrong period), <strong style="color:var(--text);">rate</strong> (vendor overbilled versus contract), or <strong style="color:var(--text);">volume</strong> (genuine activity increase). Timing-only variances belong in close commentary; rate and volume variances require owner action and a documented response before the next forecast cycle.</p>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Variance Analysis <span class="help-icon" data-help="'Variance' simply means the difference between plan and reality. A positive variance means you spent more than planned (bad). A negative variance means you came in under plan (good). This table breaks it down month by month so you can see trends and spot which months went off-track."></span></h3>
            <div class="card-actions">
              <div class="toggle-with-hint">
                <div class="toggle-group">
                  <button class="toggle-btn active" onclick="setCompareMode('forecast')" data-mode="forecast" data-help="Compare actual spend against the rolling forecast — your most up-to-date prediction of what you'd spend.">vs Forecast</button>
                  <button class="toggle-btn" onclick="setCompareMode('budget')" data-mode="budget" data-help="Compare actual spend against the original approved budget — the number signed off at the start of the year. Useful for formal accountability.">vs Budget</button>
                </div>
                <div class="toggle-hints-row">
                  <div class="toggle-hint-item">
                    <span class="toggle-hint-label">Forecast</span>
                    <span style="font-size:9px;color:var(--muted);opacity:0.7;">Rolling / Latest</span>
                  </div>
                  <div style="width:8px;"></div>
                  <div class="toggle-hint-item">
                    <span class="toggle-hint-label">Budget</span>
                    <span style="font-size:9px;color:var(--muted);opacity:0.7;">Approved Baseline / Forecast v1</span>
                  </div>
                </div>
              </div>
              <button onclick="downloadForecastCSV()" class="btn-small">Export Analysis</button>
            </div>
          </div>

          <!-- ═══ Plan Builder: Intake → Commitments ═══ -->
          <div class="plan-builder-card" id="planBuilderCard">
            <div class="plan-builder-header">
              <div class="plan-builder-title">
                Plan Builder: Intake → Commitments → Locked Baseline
                <span class="pb-info" data-help="This is how fragmented spend requests from multiple budget owners become a forecast-ready baseline. Intake captures what owners are requesting. Commitments are what Finance has formally approved and will track. Locking the baseline freezes it as the official budget — so future changes show up as real variance, not noise.">i</span>
              </div>
              <div class="plan-builder-actions">
                <label class="pb-switch" title="Enable Plan Builder to use commitments as forecast source">
                  <input type="checkbox" id="pbToggle" onchange="pbToggleChanged()">
                  <span class="pb-switch-track"><span class="pb-switch-thumb"></span></span>
                  <span class="pb-switch-label">Enable Plan Builder</span>
                </label>
                <span class="pb-status-chip not-locked" id="pbStatusChip">Budget Baseline: Not locked</span>
              </div>
            </div>

            <div id="pbDisabledMsg" class="pb-disabled-msg">
              Plan Builder is off — the module uses Sample / Random / Upload data as forecast source.<br>
              <span style="color:var(--accent);font-weight:600;cursor:pointer;" onclick="document.getElementById('pbToggle').checked=true;pbToggleChanged();">Enable Plan Builder →</span>
            </div>

            <div id="pbBody" class="plan-builder-body pb-hidden">
              <!-- Action buttons row -->
              <div style="display:flex;gap:7px;flex-wrap:wrap;margin-bottom:16px;">
                <button class="btn-small btn-accent" onclick="pbBuildPlan()" data-help="Recalculates the forecast from all current Commitments and refreshes the Forecast chart and Variance table below. Run this after any changes to commitments.">Build Plan</button>
                <button class="btn-small" id="pbLockBtn" onclick="pbLockBudget()" data-help="Snapshots today's commitment totals as the Budget Baseline (your Approved Forecast v1). After locking, editing commitments updates the rolling Forecast but the Budget stays frozen — this is what creates meaningful variance analysis.">Lock Budget Baseline</button>
                <button class="btn-small btn-danger" onclick="pbResetBudget()" data-help="Clears the locked budget snapshot. While unlocked, Budget = Forecast (no variance). Use Reset if the baseline was set too early or needs to be re-approved.">Reset Baseline</button>
                <button class="btn-small btn-danger" onclick="pbResetAllData()" data-help="Wipes everything — all intake requests, all commitments, and the budget baseline. Use this to start completely fresh. Cannot be undone, so export your plan first if you want a backup." style="border-color:rgba(220,38,38,0.4);">🗑 Reset All Data</button>
                <button class="btn-small" onclick="pbExportJSON()" data-help="Downloads all intake rows, commitments, and the budget baseline as a JSON file — useful for version control, sharing with another finance team member, or backing up before major changes.">Export Plan (JSON)</button>
                <label class="btn-small" style="cursor:pointer;display:inline-flex;align-items:center;" data-help="Load a previously exported plan JSON file. This will overwrite the current intake, commitments, and baseline. Use Import to restore a backup or load a plan shared by a colleague.">
                  Import Plan (JSON)
                  <input type="file" accept=".json" style="display:none;" onchange="pbImportJSON(event)">
                </label>
              </div>

              <!-- ── Intake table ── -->
              <div class="pb-table-section">
                <div class="pb-section-header">
                  <span class="pb-section-title">
                    Intake — Requests Pipeline
                    <span class="pb-info" data-help="Intake is the &quot;ask&quot; layer. Any team can submit a spend request here — campaign name, owner, cost center, amount, and the months it spans. Requests start as Draft, get Submitted for review, then either Approved (moves to Commitments) or Rejected. Finance owns the approval gate. Intake alone has no effect on the forecast — only approved Commitments drive the numbers.">i</span>
                  </span>
                  <button class="btn-small" onclick="pbOpenIntakeModal()">+ Add Intake</button>
                </div>
                <div style="overflow-x:auto;">
                  <table class="pb-table" id="pbIntakeTable">
                    <thead>
                      <tr>
                        <th>Request ID</th><th>Campaign</th><th>Owner</th><th>Category</th>
                        <th>Cost Center</th><th>Amount</th><th>Start Month</th><th>End Month</th>
                        <th>Status</th><th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="pbIntakeTbody">
                      <tr class="pb-table-empty"><td colspan="10">No intake requests yet — click "+ Add Intake" to begin.</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- ── Commitments table ── -->
              <div class="pb-table-section">
                <div class="pb-section-header">
                  <span class="pb-section-title">
                    Commitments — Finance-Trust Source
                    <span class="pb-info" data-help="Commitments are finance&apos;s source of truth. Once an intake request is approved, it becomes a Commitment — a formal record of a vendor, amount, and time range that finance stands behind. Committed and Invoiced rows are phased evenly across months and summed to build the rolling Forecast. When you click &quot;Lock Budget Baseline&quot;, the current commitment totals become the frozen Budget that actuals are measured against.">i</span>
                  </span>
                  <button class="btn-small" onclick="pbOpenCommitmentModal()">+ Add Commitment</button>
                </div>
                <div style="overflow-x:auto;">
                  <table class="pb-table" id="pbCommitmentsTable">
                    <thead>
                      <tr>
                        <th>Commitment ID</th><th>Linked Request</th><th>Vendor</th><th>Category</th>
                        <th>Cost Center</th><th>Amount</th><th>Start Month</th><th>End Month</th>
                        <th>Status</th><th>Phasing</th><th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="pbCommitTbody">
                      <tr class="pb-table-empty"><td colspan="11">No commitments yet — approve an intake request or click "+ Add Commitment".</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div id="pbSourceBadgeRow" style="display:none;margin-bottom:8px;">
                <span class="pb-source-badge">📋 Plan Builder Active — Forecast sourced from Commitments</span>
              </div>
            </div>
          </div>
          <!-- ═══ /Plan Builder ═══ -->

          <div class="chart-container">
            <div class="chart-title" id="forecastChartTitle">Actual vs Forecast</div>
            <div class="chart-wrapper">
              <canvas id="forecastChart" class="chart-canvas"></canvas>
            </div>
          </div>

          <!-- So What: Forecast vs Actual — rendered dynamically by JS -->
          <div id="forecastSoWhat" style="margin:16px 0 8px;padding:18px 20px;border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,0.06);display:none;min-height:180px;max-height:180px;overflow-y:auto;box-sizing:border-box;scrollbar-width:thin;scrollbar-color:rgba(12,23,45,0.18) transparent;">
            <div id="forecastSoWhatLabel" style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;"></div>
            <ul id="forecastSoWhatList" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;"></ul>
          </div>

          <table class="data-table" id="forecastTable">
            <!-- Table populated by JS -->
          </table>
        </div>
    </section>

    <!-- Exception Queue -->
    <section class="module-section section-muted" id="section-risk">
      <div class="container">
        <h2 class="module-section-title" style="display:flex;align-items:center;gap:8px;">
          4. Exception Queue &amp; Actionable Flags
          <span class="help-icon" data-help="An automatic early-warning system that scans spend data for anything that needs follow-up — vendors overbilling above contract, spend spikes above average, invoices not yet received for costs already incurred, or a single supplier absorbing too much of the budget. Each flag includes a suggested action owner."></span>
        </h2>
        <p style="font-size:13px;color:var(--muted);margin:-8px 0 16px;line-height:1.5;">Exception routing is where most spend risk gets resolved or ignored. Every flagged item routes to the team that can actually act on it — not to a generic Finance inbox: <strong style="color:var(--text);">Procurement</strong> for rate issues and missing POs, <strong style="color:var(--text);">AP / Finance Ops</strong> for duplicate invoices and open accruals, <strong style="color:var(--text);">Budget Owner</strong> for spend spikes that need a documented explanation. High-severity flags should be closed before the next reporting period, with resolution notes retained for the audit file.</p>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Alert Configuration
              <span class="help-icon" data-help="Set the trigger point for each alert type. Higher value = fewer alerts (only the most extreme cases fire). Lower value = more alerts (catches smaller issues early). Tune to match your organisation's risk appetite."></span>
            </h3>
            <div class="card-actions">
              <button onclick="downloadRiskFlagsCSV()" class="btn-small">Export Alerts</button>
            </div>
          </div>

          <!-- ── v2: Preset + Detection mode bar ── -->
          <div class="risk-cfg-bar">
            <div class="risk-cfg-left">
              <span class="risk-cfg-lbl">Preset</span>
              <select id="riskPreset" class="preset-sel" onchange="applyRiskPreset(this.value)">
                <option value="conservative">Conservative — lower thresholds, more alerts</option>
                <option value="balanced" selected>Balanced — default</option>
                <option value="strict">Strict — higher thresholds, fewer alerts</option>
                <option value="custom" disabled hidden>Custom</option>
              </select>
              <span class="risk-cfg-lbl" style="margin-left:4px;">Sensitivity</span>
              <span id="sensitivityPill" class="sens-pill sp-mid">Balanced</span>
              <button id="resetPresetLink" onclick="resetToLastPreset()" title="Revert threshold inputs back to the last named preset">↺ Reset to preset</button>
            </div>
            <div class="risk-cfg-right">
              <span class="risk-cfg-lbl">Detection</span>
              <div class="toggle-group">
                <button id="modeThreshBtn" class="toggle-btn active"
                  onclick="setDetectionMode('threshold')">Threshold <span id="modeThreshCount" style="font-size:10px;font-weight:700;background:rgba(12,23,45,0.12);padding:1px 6px;border-radius:999px;margin-left:3px;"></span></button>
                <button id="modeAdaptBtn"  class="toggle-btn"
                  onclick="setDetectionMode('adaptive')"
                  data-help="Adaptive mode adds a MAD (Median Absolute Deviation) statistical layer for spend spikes. A spike fires if: the threshold condition OR the adaptive condition is met — whichever triggers first. This catches real anomalies even when they don't cross the fixed % trigger.">Adaptive ✦ <span id="modeAdaptCount" style="font-size:10px;font-weight:700;background:rgba(99,102,241,0.15);color:#4338ca;padding:1px 6px;border-radius:999px;margin-left:3px;"></span></button>
              </div>
            </div>
          </div>

          <!-- ── v2: Four threshold inputs with helper + warnings ── -->
          <div class="threshold-controls">
            <div class="threshold-field">
              <label>Rate variance trigger (%)
                <span class="help-icon" data-help="Flags a vendor when their average billed rate exceeds the contract rate by more than this %. Higher = fewer alerts. E.g. at 20%, a $10/unit vendor is only flagged if they charge above $12."></span>
              </label>
              <input type="number" id="thresholdRate" value="20" min="1" max="100" step="1" oninput="onThresholdInput()">
              <span class="threshold-helper">Higher = fewer alerts. Flags when metric exceeds this %.</span>
              <span id="warnRate" class="threshold-warn"></span>
            </div>
            <div class="threshold-field">
              <label>Spend spike trigger (%)
                <span class="help-icon" data-help="Flags a category-month when spend is more than this % above the category's monthly average. In Adaptive mode a MAD outlier check also runs — the flag fires if either condition is met."></span>
              </label>
              <input type="number" id="thresholdSpike" value="35" min="1" max="500" step="1" oninput="onThresholdInput()">
              <span class="threshold-helper">Higher = fewer alerts. Flags when metric exceeds this %.</span>
              <span id="warnSpike" class="threshold-warn"></span>
            </div>
            <div class="threshold-field">
              <label>Accrual risk trigger (%)
                <span class="help-icon" data-help="Flags a vendor-month when un-invoiced spend exceeds this % of total incurred cost. Higher = fewer alerts."></span>
              </label>
              <input type="number" id="thresholdAccrual" value="25" min="1" max="100" step="1" oninput="onThresholdInput()">
              <span class="threshold-helper">Higher = fewer alerts. Flags when metric exceeds this %.</span>
              <span id="warnAccrual" class="threshold-warn"></span>
            </div>
            <div class="threshold-field">
              <label>Vendor concentration trigger (%)
                <span class="help-icon" data-help="Flags any vendor whose share of total spend exceeds this %. Capped at 65% — above that, alerts become mathematically improbable. Higher = fewer alerts."></span>
              </label>
              <input type="number" id="thresholdConcentration" value="30" min="1" max="65" step="1" oninput="onThresholdInput()">
              <span class="threshold-helper">Higher = fewer alerts. Flags when metric exceeds this %.</span>
              <span id="warnConcentration" class="threshold-warn"></span>
            </div>
          </div>

          <!-- So What: Risk & Anomaly Flags -->
          <div id="riskSoWhat" style="margin:0 0 16px 0;padding:18px 20px;border:1.5px solid rgba(245,158,11,0.30);border-radius:14px;background:#fffbeb;box-shadow:0 2px 8px rgba(245,158,11,0.08);display:none;min-height:180px;max-height:180px;overflow-y:auto;box-sizing:border-box;scrollbar-width:thin;scrollbar-color:rgba(12,23,45,0.18) transparent;">
            <div id="riskSoWhatLabel" style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#b45309;margin-bottom:8px;">💡 What · So What · Now What — Risk &amp; Anomaly Flags</div>
            <ul id="riskSoWhatList" style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;"></ul>
          </div>

          <!-- Alert counter -->
          <div id="alertCounterBar" style="display:none;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
              <span style="font-size:13px;font-weight:600;color:var(--text);margin-right:4px;">Flagged Issues</span>
              <button id="alertCountTotal" onclick="filterAlerts('all')"   style="font-size:12px;font-weight:700;padding:4px 11px;border-radius:999px;background:rgba(12,23,45,0.08);color:var(--text);border:2px solid transparent;cursor:pointer;transition:all 120ms ease;" title="Show all">0</button>
              <button id="alertCountHigh"  onclick="filterAlerts('high')"  style="font-size:12px;font-weight:700;padding:4px 11px;border-radius:999px;background:rgba(220,38,38,0.12);color:#dc2626;border:2px solid transparent;cursor:pointer;transition:all 120ms ease;display:none;" title="Show High only"></button>
              <button id="alertCountMed"   onclick="filterAlerts('med')"   style="font-size:12px;font-weight:700;padding:4px 11px;border-radius:999px;background:rgba(245,158,11,0.12);color:#d97706;border:2px solid transparent;cursor:pointer;transition:all 120ms ease;display:none;" title="Show Med only"></button>
              <button id="alertCountLow"   onclick="filterAlerts('low')"   style="font-size:12px;font-weight:700;padding:4px 11px;border-radius:999px;background:rgba(107,114,128,0.12);color:#6b7280;border:2px solid transparent;cursor:pointer;transition:all 120ms ease;display:none;" title="Show Low only"></button>
            </div>
            <span style="font-size:11px;color:var(--muted);">Click a badge to filter · Scroll inside to see all</span>
          </div>

          <!-- Scrollable alerts container -->
          <div id="alertsScroll" style="max-height:480px;overflow-y:auto;padding-right:4px;scrollbar-width:thin;scrollbar-color:rgba(12,23,45,0.15) transparent;">
            <div class="alert-grid" id="alertsContainer">
              <!-- Alert cards populated by JS -->
            </div>
          </div>
        </div>
    </section>

    <!-- What This Demonstrates -->
    <section class="demo-section">
      <div class="container">
        <h2 class="module-section-title">What This Demonstrates</h2>
        <div class="demo-grid">
          <div class="demo-card">
            <div class="demo-card-title">Budget Operations, Not Just Dashboards</div>
            <div class="demo-card-text">
              Structured intake, clear field ownership, and exception routing — the full monthly workflow from spend submission to close support, not a retrospective view of what already happened.
            </div>
          </div>
          <div class="demo-card">
            <div class="demo-card-title">Forecast Signals That Hold Under Scrutiny</div>
            <div class="demo-card-text">
              Separating timing-only variance from true overruns, and flagging low-confidence forecast items before close, gives leadership a cleaner signal and reduces the noise that leads to wrong decisions.
            </div>
          </div>
          <div class="demo-card">
            <div class="demo-card-title">Close-Ready Accrual Visibility</div>
            <div class="demo-card-text">
              Open accruals tracked by vendor and month, surfaced before period close — not discovered during it. AP knows exactly what to chase and Finance can sign off without last-minute corrections.
            </div>
          </div>
          <div class="demo-card">
            <div class="demo-card-title">Every Exception Has a Named Owner</div>
            <div class="demo-card-text">
              Rate mismatches, missing POs, and spend spikes each route to the team that can resolve them — with resolution tracked. Finance quantifies; Procurement, AP, and budget owners act.
            </div>
          </div>
        </div>
    </section>

      </div>
    </div>
    </div>
  </div>
  </div>

  <!-- ── Next Module ──────────────────────────────────────── -->
  <nav class="next-module-bar" aria-label="Next recommended module">
    <div>
      <div class="next-module-label">Next recommended</div>
      <div class="next-module-title">Indirect Cost &amp; Headcount CoE</div>
      <div class="next-module-why">Vendor spend is tracked — now model the biggest internal cost driver: headcount, benefits, and contractor commitments.</div>
    </div>
    <div class="next-module-actions">
      <a class="btn btn-solid" href="indirect-cost-headcount.html">Open Headcount →</a>
      <a class="btn btn-ghost" href="index.html">← Back to Portfolio</a>
    </div>
  </nav>

</main>

  <a href="#" class="to-top" aria-label="Back to top">↑</a>

  <script src="main.js"></script>
  <script>
    /* =========================================
       Operations Spend Analytics - JavaScript
       ========================================= */

    // ========== GLOBAL STATE ==========
    
    let dataMode = 'sample';
    let compareMode = 'forecast';
    
    let rateCards = [];
    let transactions = [];
    let accruals = [];
    let forecastBudget = [];
    
    let thresholds = {
      rateVariance: 20,
      spike: 35,
      accrual: 25,
      concentration: 30
    };

    // ── Risk v2 state ─────────────────────────────────────────────────────
    // preset:        'conservative' | 'balanced' | 'strict' | 'custom'
    // detectionMode: 'threshold' | 'adaptive'
    //
    // Preset table — Conservative = low triggers (more alerts),
    //                Strict       = high triggers (fewer alerts)
    const RISK_PRESETS = {
      conservative: { rateVariance: 10, spike: 20, accrual: 15, concentration: 20 },
      balanced:     { rateVariance: 20, spike: 35, accrual: 25, concentration: 30 },
      strict:       { rateVariance: 40, spike: 60, accrual: 40, concentration: 50 }
    };
    let _riskPreset    = 'balanced';   // current preset name
    let _lastNamedPreset = 'balanced'; // last named (non-custom) preset — used for reset
    let _detectionMode = 'threshold';  // 'threshold' | 'adaptive'
    // ─────────────────────────────────────────────────────────────────────

    // Cached risk alert counts — updated by computeRiskFlags(), read by renderSpendDecisionBox()
    let _riskAlertCounts = { total: 0, high: 0, med: 0, low: 0 };
    
    // ========== UTILITY FUNCTIONS ==========
    
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function randFloat(min, max) {
      return Math.random() * (max - min) + min;
    }
    
    function formatCurrency(val) {
      return '$' + Math.round(val).toLocaleString();
    }
    
    function formatPercent(val) {
      return val.toFixed(1) + '%';
    }
    
    function getMonthName(monthNum) {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return months[monthNum - 1] || monthNum;
    }
    
    // ========== CSV PARSING ==========
    
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = values[idx] || '';
        });
        data.push(row);
      }
      return { headers, data };
    }
    
    function validateHeaders(actual, required) {
      return required.every(h => actual.includes(h));
    }
    
    function downloadCSV(filename, headers, rows) {
      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += headers.map(h => row[h] !== undefined ? row[h] : '').join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    }
    
    // ========== SAMPLE DATA GENERATION ==========

    // Prevent page jump when re-rendering: save scroll, run fn, restore scroll
    function withStableScroll(fn) {
      const scrollY = window.scrollY || window.pageYOffset;
      // Anchor the page height so content changes don't shift scroll position
      document.documentElement.style.minHeight = document.documentElement.scrollHeight + 'px';
      fn();
      // Use requestAnimationFrame to restore after DOM has updated
      requestAnimationFrame(function() {
        window.scrollTo({ top: scrollY, behavior: 'instant' });
        // Release the height lock after another frame
        requestAnimationFrame(function() {
          document.documentElement.style.minHeight = '';
        });
      });
    }
    
    function useSampleData() {
      withStableScroll(function() {
      dataMode = 'sample';
      updateDataModeBadge('sample');
      initializeSampleData();
      renderAll();
      });
    }

    // Alias used in loadWorstCase — ops uses updateDataModeBadge instead
    function _setSampleBtnState() { /* managed by updateDataModeBadge */ }
    
    function initializeSampleData() {
      // ── Seeded PRNG (mulberry32) — same seed = same data every page load ──
      let _seed = 20250101;
      function seededRand() {
        _seed |= 0; _seed = _seed + 0x6D2B79F5 | 0;
        let t = Math.imul(_seed ^ _seed >>> 15, 1 | _seed);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
      function sRandInt(min, max) { return Math.floor(seededRand() * (max - min + 1)) + min; }
      function sRandFloat(min, max) { return seededRand() * (max - min) + min; }

      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const categories = ['Logistics', 'Facilities', 'Support', 'Contractors', 'IT Ops'];
      const vendors = [
        { id: 'V001', name: 'QuickShip Logistics', category: 'Logistics', service: 'Delivery', unit: 'delivery', rate: 15 },
        { id: 'V002', name: 'FastHaul Express', category: 'Logistics', service: 'Delivery', unit: 'delivery', rate: 12 },
        { id: 'V003', name: 'BuildPro Facilities', category: 'Facilities', service: 'Maintenance', unit: 'job', rate: 250 },
        { id: 'V004', name: 'CleanCorp Services', category: 'Facilities', service: 'Cleaning', unit: 'hour', rate: 35 },
        { id: 'V005', name: 'HelpDesk Plus', category: 'Support', service: 'Ticket', unit: 'ticket', rate: 3.5 },
        { id: 'V006', name: 'TechStaff Solutions', category: 'Contractors', service: 'Hourly', unit: 'hour', rate: 65 },
        { id: 'V007', name: 'DevOps Experts', category: 'Contractors', service: 'Hourly', unit: 'hour', rate: 78 },
        { id: 'V008', name: 'CloudLicense Corp', category: 'IT Ops', service: 'License', unit: 'seat', rate: 25 }
      ];
      
      rateCards = vendors.map(v => ({
        vendor_id: v.id,
        vendor_name: v.name,
        service: v.service,
        unit: v.unit,
        contract_rate: v.rate,
        currency: 'USD',
        effective_start: '2025-01-01',
        effective_end: '2025-12-31',
        category: v.category
      }));
      
      transactions = [];
      let invoiceCounter = 1000;
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        const numTransactions = sRandInt(20, 35);
        for (let i = 0; i < numTransactions; i++) {
          const vendor = vendors[sRandInt(0, vendors.length - 1)];
          const units = sRandInt(5, 100);
          const hasLeakage = seededRand() < 0.25;
          let unitRate = vendor.rate;
          if (hasLeakage) {
            unitRate = vendor.rate * sRandFloat(1.02, 1.15);
          } else if (seededRand() < 0.05) {
            unitRate = vendor.rate * sRandFloat(0.92, 0.98);
          }
          transactions.push({
            date: `2025-${String(monthNum).padStart(2, '0')}-${String(sRandInt(1, 28)).padStart(2, '0')}`,
            vendor_id: vendor.id,
            service: vendor.service,
            units,
            unit_rate: unitRate.toFixed(2),
            amount: (units * unitRate).toFixed(2),
            cost_center: 'CC' + sRandInt(100, 105),
            category: vendor.category,
            invoice_id: 'INV' + (invoiceCounter++),
            po_id: 'PO' + sRandInt(2000, 2100)
          });
        }
      });
      
      accruals = [];
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        vendors.forEach(vendor => {
          const monthlyTrans = transactions.filter(t => 
            t.vendor_id === vendor.id && t.date.startsWith(`2025-${String(monthNum).padStart(2, '0')}`)
          );
          if (monthlyTrans.length > 0) {
            const incurred = monthlyTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const invoicedPct = sRandFloat(0.75, 1.0);
            const invoiced = incurred * invoicedPct;
            const accrual = incurred - invoiced;
            accruals.push({
              month: month,
              vendor_id: vendor.id,
              service: vendor.service,
              incurred_amount: incurred.toFixed(2),
              invoiced_amount: invoiced.toFixed(2),
              accrual_amount: accrual.toFixed(2),
              status: accrual > 0 ? 'Open' : 'Closed',
              notes: accrual > incurred * 0.2 ? 'Review timing' : ''
            });
          }
        });
      });
      
      forecastBudget = [];
      const costCenters = ['CC100', 'CC101', 'CC102', 'CC103'];
      months.forEach((month, mIdx) => {
        costCenters.forEach(cc => {
          categories.forEach(cat => {
            const baseAmount = sRandInt(3000, 12000);
            const forecastAmount = baseAmount;
            const budgetAmount = baseAmount * sRandFloat(0.95, 1.05);
            forecastBudget.push({
              month: month,
              cost_center: cc,
              category: cat,
              forecast_amount: forecastAmount.toFixed(2),
              budget_amount: budgetAmount.toFixed(2)
            });
          });
        });
      });
    }
    
    function randomizeSampleData() {
      withStableScroll(function() {
      dataMode = 'sample';

      // ── Pick outcome mode: positive / mid / negative ──────────────────────
      const modeRoll = Math.random();
      const outcomeMode = modeRoll < 0.33 ? 'positive' : modeRoll < 0.67 ? 'mid' : 'negative';
      // Tuning knobs per mode
      const modeConfig = {
        positive: { leakagePct: [0.02, 0.06], overrunProb: 0.05, accrualInvoicedMin: 0.92, label: '✅ Clean Run' },
        mid:      { leakagePct: [0.10, 0.22], overrunProb: 0.30, accrualInvoicedMin: 0.82, label: '⚠ Watch Spend' },
        negative: { leakagePct: [0.25, 0.40], overrunProb: 0.65, accrualInvoicedMin: 0.68, label: '🔴 Leakage Alert' },
      };
      const cfg = modeConfig[outcomeMode];

      updateDataModeBadge('random');
      const badge = document.getElementById('dataModeBadge');
      if (badge) badge.textContent = 'RANDOM';

      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const categories = ['Logistics', 'Facilities', 'Support', 'Contractors', 'IT Ops', 'Marketing Ops'].slice(0, randInt(4, 6));
      const numVendors = randInt(8, 15);

      const serviceTypes = {
        'Logistics':      [{ service: 'Delivery',    unit: 'delivery',  rateRange: [2, 25] }],
        'Facilities':     [{ service: 'Maintenance', unit: 'job',       rateRange: [20, 450] }, { service: 'Cleaning', unit: 'hour', rateRange: [25, 45] }],
        'Support':        [{ service: 'Ticket',      unit: 'ticket',    rateRange: [0.8, 6] }],
        'Contractors':    [{ service: 'Hourly',      unit: 'hour',      rateRange: [12, 85] }],
        'IT Ops':         [{ service: 'License',     unit: 'seat',      rateRange: [4, 35] }],
        'Marketing Ops':  [{ service: 'Campaign',    unit: 'campaign',  rateRange: [50, 300] }]
      };

      const vendors = [];
      for (let i = 0; i < numVendors; i++) {
        const cat = categories[randInt(0, categories.length - 1)];
        const serviceOptions = serviceTypes[cat];
        const serviceType = serviceOptions[randInt(0, serviceOptions.length - 1)];
        vendors.push({
          id: 'V' + String(i + 1).padStart(3, '0'),
          name: 'Vendor ' + String.fromCharCode(65 + i),
          category: cat,
          service: serviceType.service,
          unit: serviceType.unit,
          rate: randFloat(serviceType.rateRange[0], serviceType.rateRange[1])
        });
      }

      rateCards = vendors.map(v => ({
        vendor_id: v.id,
        vendor_name: v.name,
        service: v.service,
        unit: v.unit,
        contract_rate: v.rate.toFixed(2),
        currency: 'USD',
        effective_start: '2025-01-01',
        effective_end: '2025-12-31',
        category: v.category
      }));

      transactions = [];
      let invoiceCounter = randInt(1000, 2000);
      const [leakMin, leakMax] = cfg.leakagePct;
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        const numTransactions = randInt(80, 260);
        for (let i = 0; i < numTransactions; i++) {
          const vendor = vendors[randInt(0, vendors.length - 1)];
          const units = randInt(1, 150);
          const hasLeakage = Math.random() < randFloat(leakMin, leakMax);
          let unitRate = vendor.rate;
          if (hasLeakage) {
            unitRate = vendor.rate * randFloat(1.02, 1.18);
          }
          transactions.push({
            date: `2025-${String(monthNum).padStart(2, '0')}-${String(randInt(1, 28)).padStart(2, '0')}`,
            vendor_id: vendor.id,
            service: vendor.service,
            units,
            unit_rate: unitRate.toFixed(2),
            amount: (units * unitRate).toFixed(2),
            cost_center: 'CC' + randInt(100, 105),
            category: vendor.category,
            invoice_id: 'INV' + (invoiceCounter++),
            po_id: 'PO' + randInt(2000, 2500)
          });
        }
      });

      accruals = [];
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        vendors.forEach(vendor => {
          const monthlyTrans = transactions.filter(t =>
            t.vendor_id === vendor.id && t.date.startsWith(`2025-${String(monthNum).padStart(2, '0')}`));
          if (monthlyTrans.length > 0) {
            const incurred = monthlyTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const invoicedPct = randFloat(cfg.accrualInvoicedMin, 1.0);
            const invoiced = incurred * invoicedPct;
            const accrual = incurred - invoiced;
            accruals.push({
              month,
              vendor_id: vendor.id,
              service: vendor.service,
              incurred_amount: incurred.toFixed(2),
              invoiced_amount: invoiced.toFixed(2),
              accrual_amount: accrual.toFixed(2),
              status: accrual > 0 ? 'Open' : 'Closed',
              notes: accrual > incurred * 0.2 ? 'Review timing' : ''
            });
          }
        });
      });

      forecastBudget = [];
      const costCenters = ['CC100', 'CC101', 'CC102', 'CC103', 'CC104'];
      // In negative mode, more surprise months; positive: none
      const numSurprises = outcomeMode === 'negative' ? randInt(3, 5) : outcomeMode === 'mid' ? 1 : 0;
      const surpriseMonths = [];
      for (let s = 0; s < numSurprises; s++) { surpriseMonths.push(randInt(2, 11)); }

      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        costCenters.forEach(cc => {
          categories.forEach(cat => {
            let baseAmount = randInt(2000, 15000);
            const isSurprise = surpriseMonths.includes(monthNum);
            if (isSurprise) { baseAmount = baseAmount * randFloat(1.15, 1.35); }
            // Positive mode: actuals stay at or under forecast
            const actualVariance = outcomeMode === 'positive'
              ? randFloat(-0.08, 0.03)
              : outcomeMode === 'mid'
                ? randFloat(-0.05, 0.12)
                : randFloat(0.05, 0.30);
            const forecastAmount = baseAmount;
            const budgetAmount = baseAmount * randFloat(0.95, 1.05);
            forecastBudget.push({
              month,
              cost_center: cc,
              category: cat,
              forecast_amount: forecastAmount.toFixed(2),
              budget_amount: budgetAmount.toFixed(2)
            });
            // Patch transactions to over/under run based on mode
            // (done implicitly through the transaction generation above)
          });
        });
      });

      renderAll();
      }); // end withStableScroll
    }

    // ========== WORST CASE DEMO ==========
    // Engineered to push ALL four "So What" explainers into 🔴 red simultaneously:
    //   Rate Leakage  → leakagePct >= 5%   (need: >5% avg overbilling across vendors)
    //   Accruals      → pctNotInvoiced >= 25% (need: invoicedPct ~0.55–0.65)
    //   Forecast      → totalVariancePct > 10% OR overrunMonths >= 3
    //   Risk flags    → highCount > 0 (leakage >$2k, spike >40%, accrual ratio >30%, conc >40%)

    function loadWorstCase() {
      withStableScroll(function () {
        dataMode = 'sample';
        updateDataModeBadge('worst');
        const badge = document.getElementById('dataModeBadge');
        if (badge) badge.textContent = 'WORST CASE';

        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        // ── Vendors: a dominant one (concentration risk) + heavy leakers ──────
        const vendors = [
          // V001 will dominate spend → concentration risk >40%
          { id:'V001', name:'MegaHaul Logistics',   category:'Logistics',    service:'Delivery',     unit:'delivery', rate:15  },
          { id:'V002', name:'OverCharge Express',    category:'Logistics',    service:'Delivery',     unit:'delivery', rate:12  },
          { id:'V003', name:'BillingError Facilities',category:'Facilities',  service:'Maintenance',  unit:'job',      rate:250 },
          { id:'V004', name:'CleanSlate Corp',       category:'Facilities',   service:'Cleaning',     unit:'hour',     rate:35  },
          { id:'V005', name:'HelpDesk Unlimited',    category:'Support',      service:'Ticket',       unit:'ticket',   rate:3.5 },
          { id:'V006', name:'ContractBreach Staff',  category:'Contractors',  service:'Hourly',       unit:'hour',     rate:65  },
        ];

        rateCards = vendors.map(v => ({
          vendor_id: v.id, vendor_name: v.name, service: v.service,
          unit: v.unit, contract_rate: v.rate, currency: 'USD',
          effective_start: '2025-01-01', effective_end: '2025-12-31', category: v.category
        }));

        // ── Transactions: massive overbilling on all vendors ──────────────────
        // Target: leakagePct well above 5%, V001 eats >40% of total spend
        transactions = [];
        let invCounter = 3000;

        months.forEach((month, mIdx) => {
          const monthNum = mIdx + 1;
          const pad = n => String(n).padStart(2,'0');

          vendors.forEach(v => {
            // V001 gets 8x more units to create concentration risk
            const unitCount = v.id === 'V001' ? 800 : 60;
            // Every transaction is overbilled 20–45% above contract
            const leakMultiplier = 1.20 + Math.sin(mIdx + vendors.indexOf(v)) * 0.12 + 0.08;
            const billedRate = v.rate * leakMultiplier;
            const amount = unitCount * billedRate;

            transactions.push({
              date: `2025-${pad(monthNum)}-${pad(10 + (mIdx % 18))}`,
              vendor_id: v.id,
              service: v.service,
              units: unitCount,
              unit_rate: billedRate.toFixed(2),
              amount: amount.toFixed(2),
              cost_center: 'CC10' + (mIdx % 4),
              category: v.category,
              invoice_id: 'INV' + (invCounter++),
              po_id: 'PO' + (2000 + mIdx)
            });

            // Extra mid-month transactions for V001 (spend spike months: Mar, Jul, Oct)
            if (v.id === 'V001' && [2, 6, 9].includes(mIdx)) {
              const spikeUnits = 1200; // creates >40% spike above monthly avg
              transactions.push({
                date: `2025-${pad(monthNum)}-20`,
                vendor_id: v.id, service: v.service,
                units: spikeUnits,
                unit_rate: (v.rate * 1.35).toFixed(2),
                amount: (spikeUnits * v.rate * 1.35).toFixed(2),
                cost_center: 'CC102', category: v.category,
                invoice_id: 'INV' + (invCounter++),
                po_id: 'PO2099'
              });
            }
          });
        });

        // ── Accruals: only 55–62% invoiced → pctNotInvoiced ~38–45% ──────────
        accruals = [];
        months.forEach((month, mIdx) => {
          const monthNum = mIdx + 1;
          vendors.forEach(v => {
            const mt = transactions.filter(t =>
              t.vendor_id === v.id && t.date.startsWith(`2025-${String(monthNum).padStart(2,'0')}`)
            );
            if (!mt.length) return;
            const incurred  = mt.reduce((s,t) => s + parseFloat(t.amount), 0);
            // Invoiced only 55–63% of incurred → well above 25% not-invoiced threshold
            const invoicedPct = 0.55 + (mIdx % 3) * 0.027;
            const invoiced  = incurred * invoicedPct;
            const accrual   = incurred - invoiced;
            accruals.push({
              month, vendor_id: v.id, service: v.service,
              incurred_amount: incurred.toFixed(2),
              invoiced_amount: invoiced.toFixed(2),
              accrual_amount:  accrual.toFixed(2),
              status: 'Open', notes: 'Vendor invoicing severely delayed'
            });
          });
        });

        // ── Forecast vs Actual: set forecast at 65% of actual spend per month ──
        // This guarantees actuals always run ~54% over forecast (well past the 10% red threshold)
        forecastBudget = [];
        const costCenters = ['CC100','CC101','CC102','CC103'];
        months.forEach((month, mIdx) => {
          const monthNum = mIdx + 1;
          // Sum actual transactions for this month to anchor forecast below it
          const monthActual = transactions
            .filter(t => t.date.startsWith(`2025-${String(monthNum).padStart(2,'0')}`))
            .reduce((s, t) => s + parseFloat(t.amount), 0);
          // Spread forecast across cost_centers × categories (20 buckets), each = 65% of actual / 20
          const forecastPerBucket = (monthActual * 0.65) / 20;
          const budgetPerBucket   = forecastPerBucket * 1.02;
          costCenters.forEach(cc => {
            ['Logistics','Facilities','Support','Contractors','IT Ops'].forEach(cat => {
              forecastBudget.push({
                month, cost_center: cc, category: cat,
                forecast_amount: forecastPerBucket.toFixed(2),
                budget_amount:   budgetPerBucket.toFixed(2)
              });
            });
          });
        });

        renderAll();
      }); // end withStableScroll
    }

    // ========== RATE LEAKAGE FUNCTIONS ==========

    
    function renderRateLeakage() {
      const monthFilter = document.getElementById('rateMonthFilter').value;
      const categoryFilter = document.getElementById('rateCategoryFilter').value;
      const vendorFilter = document.getElementById('rateVendorFilter').value;
      
      let filtered = transactions.filter(t => {
        if (monthFilter !== 'all') {
          const tMonth = t.date.substring(5, 7);
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const tMonthName = months[parseInt(tMonth) - 1];
          if (tMonthName !== monthFilter) return false;
        }
        if (categoryFilter !== 'all' && t.category !== categoryFilter) return false;
        if (vendorFilter !== 'all' && t.vendor_id !== vendorFilter) return false;
        return true;
      });
      
      const vendorLeakage = {};
      filtered.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        if (!rc) return;
        
        if (!vendorLeakage[t.vendor_id]) {
          vendorLeakage[t.vendor_id] = {
            vendor_name: rc.vendor_name,
            service: rc.service,
            category: rc.category,
            contract_rate: parseFloat(rc.contract_rate),
            total_amount: 0,
            total_units: 0,
            leakage_amount: 0,
            flagged_count: 0
          };
        }
        
        const amount = parseFloat(t.amount);
        const units = parseFloat(t.units);
        const unitRate = parseFloat(t.unit_rate);
        const contractRate = parseFloat(rc.contract_rate);
        
        vendorLeakage[t.vendor_id].total_amount += amount;
        vendorLeakage[t.vendor_id].total_units += units;
        
        if (unitRate > contractRate) {
          const overpay = (unitRate - contractRate) * units;
          vendorLeakage[t.vendor_id].leakage_amount += overpay;
          vendorLeakage[t.vendor_id].flagged_count += 1;
        }
      });
      
      const leakageArray = Object.values(vendorLeakage).map(v => {
        v.avg_paid_rate = v.total_units > 0 ? v.total_amount / v.total_units : 0;
        v.rate_variance_pct = v.contract_rate > 0 ? ((v.avg_paid_rate - v.contract_rate) / v.contract_rate) * 100 : 0;
        return v;
      }).sort((a, b) => b.leakage_amount - a.leakage_amount);
      
      const totalSpend = leakageArray.reduce((sum, v) => sum + v.total_amount, 0);
      const totalLeakage = leakageArray.reduce((sum, v) => sum + v.leakage_amount, 0);
      const leakagePct = totalSpend > 0 ? (totalLeakage / totalSpend) * 100 : 0;
      const totalFlagged = leakageArray.reduce((sum, v) => sum + v.flagged_count, 0);
      
      document.getElementById('rateKPIs').innerHTML = `
        <div class="kpi-box">
          <div class="kpi-box-label">Total Spend (Selected) <span class="help-icon" data-help="The total amount invoiced by all vendors in the selected filter period. This is the pool of spend you're auditing for rate discipline."></span></div>
          <div class="kpi-box-value">${formatCurrency(totalSpend)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Total Leakage $ <span class="help-icon" data-help="The total dollar amount charged above contracted rates across all vendors. Even a small leakage percentage multiplied across high-volume vendors adds up to meaningful P&L impact."></span></div>
          <div class="kpi-box-value">${formatCurrency(totalLeakage)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Leakage % of Spend <span class="help-icon" data-help="What fraction of your total spend is being lost to above-contract billing. Industry best practice is below 2%. Anything above 5% signals a serious gap in procurement controls that needs immediate attention."></span></div>
          <div class="kpi-box-value">${formatPercent(leakagePct)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"># Flagged Transactions <span class="help-icon" data-help="How many individual invoices or transactions were billed above the agreed rate. A high count means the overcharging is systemic — not a one-off — and requires a process fix, not just a vendor conversation."></span></div>
          <div class="kpi-box-value">${totalFlagged}</div>
        </div>
      `;
      
      let tableHTML = `
        <colgroup>
          <col><col><col><col><col><col><col>
        </colgroup>
        <thead>
          <tr>
            <th>Vendor <span class="help-icon" data-help="The supplier being analysed. Focus on high-spend vendors first — even a small rate variance on a large-volume vendor costs more than a big variance on a small one."></span></th>
            <th>Service <span class="help-icon" data-help="The type of work or product being billed — e.g. delivery, cleaning, IT licenses. Rate cards are typically set per service type, so this tells you which contract line to check."></span></th>
            <th>Category <span class="help-icon" data-help="The cost bucket this vendor falls into — e.g. Logistics, Facilities, IT Ops. Helps you spot if leakage is concentrated in one area of the business."></span></th>
            <th>Contract Rate <span class="help-icon" data-help="The agreed price per unit in the signed contract or rate card. This is the 'should pay' number — the benchmark for every invoice."></span></th>
            <th>Avg Paid Rate <span class="help-icon" data-help="The average rate actually charged across all transactions for this vendor. If this is higher than the Contract Rate, money is leaking."></span></th>
            <th>Rate Variance % <span class="help-icon" data-help="How much higher the average paid rate is versus the contract rate, expressed as a percentage. Red = above threshold. This is the clearest signal of a contract compliance problem."></span></th>
            <th>Leakage $ <span class="help-icon" data-help="The total dollar amount overpaid to this vendor due to above-contract rates. This is real recoverable money — start with the vendors showing the highest leakage dollar value."></span></th>
          </tr>
        </thead>
        <tbody>
      `;
      leakageArray.forEach(v => {
        const varianceClass = v.rate_variance_pct > 5 ? 'highlight-red' : '';
        tableHTML += `
          <tr>
            <td>${v.vendor_name}</td>
            <td>${v.service}</td>
            <td>${v.category}</td>
            <td>$${v.contract_rate.toFixed(2)}</td>
            <td>$${v.avg_paid_rate.toFixed(2)}</td>
            <td class="${varianceClass}">${formatPercent(v.rate_variance_pct)}</td>
            <td class="${v.leakage_amount > 0 ? 'highlight-red' : ''}">${formatCurrency(v.leakage_amount)}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('rateTable').innerHTML = tableHTML;
      
      renderLeakageChart(leakageArray.slice(0, 8));

      // --- Dynamic So What: Rate Leakage ---
      const soWhatEl    = document.getElementById('rateSoWhat');
      const soWhatLabel = document.getElementById('rateSoWhatLabel');
      const soWhatList  = document.getElementById('rateSoWhatList');
      soWhatEl.style.display = '';

      const isClean    = leakagePct < 2;
      const isModerate = leakagePct >= 2 && leakagePct < 5;
      const isCritical = leakagePct >= 5;
      const accentColor = isCritical ? '#dc2626' : isModerate ? '#d97706' : '#0f766e';
      const borderColor = isCritical ? 'rgba(220,38,38,0.25)' : isModerate ? 'rgba(245,158,11,0.30)' : 'rgba(15,118,110,0.25)';
      const bgColor     = isCritical ? '#fef9f9' : isModerate ? '#fffbeb' : '#f0fdf9';

      soWhatEl.style.border    = `1.5px solid ${borderColor}`;
      soWhatEl.style.background = bgColor;

      const statusIcon  = isCritical ? '🔴' : isModerate ? '⚠️' : '✅';
      const statusLabel = isCritical ? 'Critical — Action Required' : isModerate ? 'Moderate — Watch Closely' : 'Healthy — Rate Discipline Working';
      soWhatLabel.style.color = accentColor;
      soWhatLabel.innerHTML   = `💡 What · So What · Now What — ${statusIcon} ${statusLabel} <span class="help-icon" style="margin-left:4px;vertical-align:middle;" data-help="How the status is determined — ✅ Healthy: leakage below 2% of total spend · ⚠️ Moderate: 2–5% · 🔴 Critical: 5%+. Leakage = total overbilled amount ÷ total spend."></span>`;

      const topVendor       = leakageArray[0];
      const leakVendorCount = leakageArray.filter(v => v.leakage_amount > 0).length;

      // ── WHAT — factual observations ─────────────────────────
      const whatParts = [];
      if (isCritical) {
        whatParts.push(`<strong style="color:#0b1220;">Leakage is ${formatPercent(leakagePct)} of total spend</strong> — ${formatCurrency(totalLeakage)} paid above contracted rates, exceeding the 5% critical threshold.`);
      } else if (isModerate) {
        whatParts.push(`<strong style="color:#0b1220;">Leakage is ${formatPercent(leakagePct)} of total spend</strong> — ${formatCurrency(totalLeakage)} overpaid vs contracted rates, in the 2–5% caution zone.`);
      } else {
        whatParts.push(`<strong style="color:#0b1220;">Leakage is ${formatPercent(leakagePct)} of total spend</strong> — ${totalLeakage > 0 ? formatCurrency(totalLeakage) + ' overpaid' : 'no material overcharging detected'}, below the 2% healthy threshold.`);
      }
      if (topVendor && topVendor.leakage_amount > 0) {
        whatParts.push(`Worst offender: <strong style="color:#0b1220;">${topVendor.vendor_name}</strong> — ${formatCurrency(topVendor.leakage_amount)} at a ${formatPercent(topVendor.rate_variance_pct)} rate premium.`);
      }
      if (leakVendorCount > 1) {
        whatParts.push(`<strong style="color:#0b1220;">${leakVendorCount} vendors</strong> are billing above contracted rates.`);
      }
      if (totalFlagged > 0) {
        whatParts.push(`<strong style="color:#0b1220;">${totalFlagged.toLocaleString()} transactions</strong> flagged above contracted rates.`);
      }

      // ── SO WHAT — business meaning & risk ────────────────────
      const soWhatParts = [];
      if (isCritical) {
        soWhatParts.push(`This is a procurement control failure — ${formatCurrency(totalLeakage)} is being lost to above-contract billing at scale.`);
        if (leakVendorCount >= 4) soWhatParts.push(`Breadth across ${leakVendorCount} vendors suggests the rate card enforcement process itself is broken, not just individual vendor behaviour.`);
        if (totalFlagged > 50) soWhatParts.push(`Volume of ${totalFlagged.toLocaleString()} flagged transactions makes manual review infeasible without a systematic fix.`);
      } else if (isModerate) {
        soWhatParts.push(`Not yet critical, but trending the wrong way — unchecked, this will cross the 5% threshold and require a formal escalation.`);
        if (leakVendorCount > 1) soWhatParts.push(`${leakVendorCount} vendors overcharging means this isn't a one-off — it signals a pattern.`);
      } else {
        soWhatParts.push(`Rate discipline is working. ${totalLeakage > 0 ? 'Remaining leakage is within normal tolerance for invoice rounding and timing differences.' : 'No material overcharging detected.'}`);
      }

      // ── NOW WHAT — action + owner + timeline ─────────────────
      const nowWhat = isCritical
        ? `Freeze payments to top leaking vendors pending invoice audit. Escalate to procurement. Implement PO-matched approval workflow before next payment run.`
        : isModerate
        ? `Schedule vendor reviews with the top 2–3 offenders this month. Add rate card compliance as a standing agenda item in vendor QBRs.`
        : `No urgent action needed. Review at next contract renewal cycle and tighten rate card clauses to include penalty clauses for over-billing.`;

      // ── Render as W/SW/NW grid ────────────────────────────────
      const row = (lblCls, lbl, content) =>
        `<div class="wswn-row">
           <span class="wswn-label ${lblCls}">${lbl}</span>
           <span class="wswn-content">${content}</span>
         </div>`;

      soWhatList.innerHTML = `<div class="wswn">
        ${row('lbl-what',    'What',     whatParts.join(' '))}
        ${row('lbl-sowhat',  'So What',  soWhatParts.join(' '))}
        ${row('lbl-nowwhat', 'Now What', `<strong style="color:#0b1220;">${nowWhat}</strong>`)}
      </div>`;
    }
    
    function renderLeakageChart(topVendors) {
      const canvas = document.getElementById('leakageChart');
      const container = canvas.parentElement.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      if (topVendors.length === 0) return;
      
      const maxLeakage = Math.max(...topVendors.map(v => v.leakage_amount));
      const paddingLeft = 120;
      const paddingRight = 50;
      const paddingTop = 20;
      const paddingBottom = 30;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const barHeight = 25;
      const barGap = 8;
      
      topVendors.forEach((v, i) => {
        const barW = (v.leakage_amount / maxLeakage) * chartW;
        const y = paddingTop + i * (barHeight + barGap);
        
        ctx.fillStyle = '#dc2626';
        ctx.fillRect(paddingLeft, y, barW, barHeight);
        
        ctx.fillStyle = '#0b1220';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        ctx.fillText(v.vendor_name.substring(0, 18), paddingLeft - 10, y + barHeight / 2);
        
        ctx.fillStyle = '#0b1220';
        ctx.textAlign = 'left';
        ctx.fillText(formatCurrency(v.leakage_amount), paddingLeft + barW + 6, y + barHeight / 2);
      });
    }
    
    function populateRateFilters() {
      const months = [...new Set(transactions.map(t => {
        const m = t.date.substring(5, 7);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return months[parseInt(m) - 1];
      }))];
      
      const categories = [...new Set(transactions.map(t => t.category))];
      const vendors = [...new Set(transactions.map(t => t.vendor_id))];
      
      document.getElementById('rateMonthFilter').innerHTML = '<option value="all">All Months</option>' +
        months.map(m => `<option value="${m}">${m}</option>`).join('');
      
      document.getElementById('rateCategoryFilter').innerHTML = '<option value="all">All Categories</option>' +
        categories.map(c => `<option value="${c}">${c}</option>`).join('');
      
      document.getElementById('rateVendorFilter').innerHTML = '<option value="all">All Vendors</option>' +
        vendors.map(v => {
          const rc = rateCards.find(r => r.vendor_id === v);
          return `<option value="${v}">${rc ? rc.vendor_name : v}</option>`;
        }).join('');
    }
    
    // ========== ACCRUAL FUNCTIONS ==========
    
    function renderAccruals() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      const monthlyTotals = months.map(month => {
        const monthAccruals = accruals.filter(a => a.month === month);
        const incurred = monthAccruals.reduce((sum, a) => sum + parseFloat(a.incurred_amount), 0);
        const invoiced = monthAccruals.reduce((sum, a) => sum + parseFloat(a.invoiced_amount), 0);
        const accrual  = monthAccruals.reduce((sum, a) => sum + parseFloat(a.accrual_amount), 0);
        // Count distinct invoice_ids from transactions for this month
        const monthNum = months.indexOf(month) + 1;
        const monthTrans = transactions.filter(t =>
          t.date.startsWith(`2025-${String(monthNum).padStart(2,'0')}`)
        );
        const invoiceCount = new Set(monthTrans.map(t => t.invoice_id).filter(Boolean)).size;
        return { month, incurred, invoiced, accrual, invoiceCount };
      });
      
      const totalAccrued  = monthlyTotals.reduce((sum, m) => sum + m.accrual, 0);
      const totalIncurred = monthlyTotals.reduce((sum, m) => sum + m.incurred, 0);
      const totalInvoiced = monthlyTotals.reduce((sum, m) => sum + m.invoiced, 0);
      const totalInvoiceCount = monthlyTotals.reduce((sum, m) => sum + m.invoiceCount, 0);
      const openMonths    = monthlyTotals.filter(m => m.accrual > 0).length;
      const pctNotInvoiced = totalIncurred > 0 ? ((totalIncurred - totalInvoiced) / totalIncurred) * 100 : 0;

      // This is the EXACT number the Decision Box shows as "Open accruals (not invoiced): 94"
      // = individual vendor-month records where accrual_amount > 0
      const openVendorMonthRecords = accruals.filter(a => parseFloat(a.accrual_amount) > 0);
      const openVendorMonthCount   = openVendorMonthRecords.length;
      
      document.getElementById('accrualKPIs').innerHTML = `
        <div class="kpi-box" style="border:1.5px solid rgba(220,38,38,0.35);background:rgba(220,38,38,0.04);">
          <div class="kpi-box-label" style="color:#dc2626;font-weight:700;">Open Vendor-Accrual Records
            <span class="help-icon" data-help="This is the exact number the Decision Box shows as 'Open accruals (not invoiced)'. It counts individual vendor × month combinations where the accrual is still unsettled — e.g. QuickShip in Jan + QuickShip in Feb = 2 records. Click any ▶ month row below to see the breakdown. The 12-month table shows aggregates; these vendor records are the underlying detail."></span>
          </div>
          <div class="kpi-box-value" style="color:#dc2626;">${openVendorMonthCount}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Total Accrued (YTD)
            <span class="help-icon" data-help="Total dollar value of costs incurred but not yet invoiced across the year."></span>
          </div>
          <div class="kpi-box-value">${formatCurrency(totalAccrued)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Total Invoices Received
            <span class="help-icon" data-help="Distinct invoice IDs across all transactions this year."></span>
          </div>
          <div class="kpi-box-value">${totalInvoiceCount.toLocaleString()}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">% Incurred Not Invoiced
            <span class="help-icon" data-help="Share of total incurred spend not yet formally invoiced — P&L is relying on estimates for this portion. Thresholds: ✅ Healthy = below 10% · ⚠️ Moderate = 10–24% · 🔴 High Risk = 25%+"></span>
          </div>
          <div class="kpi-box-value">${formatPercent(pctNotInvoiced)}</div>
        </div>
      `;

      // Small explanatory banner linking the KPI to the table
      const bannerColor = openVendorMonthCount > 0 ? '#dc2626' : '#059669';
      const bannerBg    = openVendorMonthCount > 0 ? 'rgba(220,38,38,0.05)' : 'rgba(5,150,105,0.05)';
      const bannerBorder= openVendorMonthCount > 0 ? 'rgba(220,38,38,0.20)' : 'rgba(5,150,105,0.20)';
      document.getElementById('accrualTableBanner').innerHTML = `
        <div style="padding:10px 14px;border:1px solid ${bannerBorder};border-radius:8px;background:${bannerBg};font-size:12px;color:${bannerColor};display:flex;align-items:center;gap:8px;margin-bottom:10px;">
          <span style="font-weight:700;">📋 How the Decision Box "Open accruals: ${openVendorMonthCount}" maps here:</span>
          <span style="color:#5d6b7a;">Each row below is one month. Click <strong>▶</strong> to expand and see which ${openVendorMonthCount} vendor records are still open — those are the exact records being counted.</span>
        </div>`;

      let tableHTML = `
        <colgroup>
          <col><col><col><col><col><col><col>
        </colgroup>
        <thead>
          <tr>
            <th style="width:60px;">Month</th>
            <th>Invoice Count <span class="help-icon" data-help="Distinct invoices received this month."></span></th>
            <th>Open Records <span class="help-icon" data-help="How many vendor-month accrual records are still open within this month. These add up to the total shown in the Decision Box. Expand the row to see each vendor."></span></th>
            <th>Incurred Amount</th>
            <th>Invoiced Amount</th>
            <th>Accrual Amount <span class="help-icon" data-help="Incurred minus Invoiced. Red = open balance. Expand ▶ to see which vendors account for it."></span></th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
      `;

      const totalAccrualAmt = monthlyTotals.reduce((s,m) => s + m.accrual, 0);

      monthlyTotals.forEach(m => {
        // Per-month open vendor records
        const monthVendorRows = accruals.filter(a => a.month === m.month);
        const openVendorRows  = monthVendorRows.filter(a => parseFloat(a.accrual_amount) > 0);
        const openVendorCt    = openVendorRows.length;
        const hasDetail       = openVendorCt > 0;
        const expandId        = `accrual-detail-${m.month}`;

        const statusBadge = m.accrual > 0
          ? `<span style="font-size:11px;font-weight:700;padding:2px 8px;border-radius:999px;background:rgba(220,38,38,0.10);color:#dc2626;">Open</span>`
          : `<span style="font-size:11px;font-weight:600;padding:2px 8px;border-radius:999px;background:rgba(5,150,105,0.10);color:#059669;">Closed</span>`;

        tableHTML += `
          <tr style="cursor:${hasDetail ? 'pointer' : 'default'};" onclick="${hasDetail ? `toggleAccrualRow('${expandId}','chevron-${m.month}')` : ''}">
            <td>
              <strong>${m.month}</strong>
              ${hasDetail ? `<span id="chevron-${m.month}" style="font-size:10px;color:var(--accent);margin-left:4px;">▶</span>` : ''}
            </td>
            <td>${m.invoiceCount > 0 ? m.invoiceCount : '<span style="color:var(--muted);">—</span>'}</td>
            <td>${openVendorCt > 0
              ? `<span style="font-weight:700;color:#dc2626;">${openVendorCt}</span> <span style="font-size:10px;color:var(--muted);">vendor${openVendorCt !== 1 ? 's' : ''}</span>`
              : `<span style="color:#059669;">0</span>`}</td>
            <td>${formatCurrency(m.incurred)}</td>
            <td>${formatCurrency(m.invoiced)}</td>
            <td class="${m.accrual > 0 ? 'highlight-red' : 'highlight-green'}">${formatCurrency(m.accrual)}</td>
            <td>${statusBadge}</td>
          </tr>
        `;

        // Expandable vendor detail (hidden by default)
        if (hasDetail) {
          tableHTML += `
            <tr id="${expandId}" style="display:none;">
              <td colspan="7" style="padding:0;background:rgba(254,249,249,0.8);">
                <table style="width:100%;font-size:12px;border-collapse:collapse;">
                  <thead>
                    <tr style="background:rgba(220,38,38,0.08);">
                      <th style="padding:6px 10px 6px 32px;font-size:10px;color:#dc2626;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;text-align:left;">Vendor</th>
                      <th style="padding:6px 10px;font-size:10px;color:#dc2626;font-weight:700;text-transform:uppercase;text-align:left;">Service</th>
                      <th style="padding:6px 10px;font-size:10px;color:#dc2626;font-weight:700;text-transform:uppercase;text-align:right;">Incurred</th>
                      <th style="padding:6px 10px;font-size:10px;color:#dc2626;font-weight:700;text-transform:uppercase;text-align:right;">Invoiced</th>
                      <th style="padding:6px 10px;font-size:10px;color:#dc2626;font-weight:700;text-transform:uppercase;text-align:right;">Open Accrual ← counted in Decision Box</th>
                    </tr>
                  </thead>
                  <tbody>
          `;
          openVendorRows.forEach(a => {
            const rc = rateCards.find(r => r.vendor_id === a.vendor_id);
            const vName = rc ? rc.vendor_name : a.vendor_id;
            tableHTML += `
              <tr style="border-top:1px solid rgba(220,38,38,0.10);">
                <td style="padding:5px 10px 5px 32px;">${vName}</td>
                <td style="padding:5px 10px;color:var(--muted);">${a.service}</td>
                <td style="padding:5px 10px;text-align:right;">${formatCurrency(parseFloat(a.incurred_amount))}</td>
                <td style="padding:5px 10px;text-align:right;">${formatCurrency(parseFloat(a.invoiced_amount))}</td>
                <td style="padding:5px 10px;text-align:right;color:#dc2626;font-weight:600;">${formatCurrency(parseFloat(a.accrual_amount))}</td>
              </tr>
            `;
          });
          tableHTML += `</tbody></table></td></tr>`;
        }
      });

      // Footer totals row
      tableHTML += `
        <tr style="background:rgba(246,248,251,0.9);font-weight:700;border-top:2px solid var(--border);">
          <td>Total</td>
          <td>${totalInvoiceCount.toLocaleString()}</td>
          <td style="color:#dc2626;">${openVendorMonthCount} <span style="font-size:10px;font-weight:400;color:var(--muted);">= Decision Box</span></td>
          <td>${formatCurrency(totalIncurred)}</td>
          <td>${formatCurrency(totalInvoiced)}</td>
          <td class="${totalAccrualAmt > 0 ? 'highlight-red' : ''}">${formatCurrency(totalAccrualAmt)}</td>
          <td><span style="font-size:11px;color:var(--muted);">${openMonths} open month${openMonths !== 1 ? 's' : ''}</span></td>
        </tr>
      `;
      tableHTML += '</tbody>';
      document.getElementById('accrualTable').innerHTML = tableHTML;
      
      renderAccrualChart(monthlyTotals);

      // --- Dynamic So What: Accrual Schedule ---
      const aSwEl    = document.getElementById('accrualSoWhat');
      const aSwLabel = document.getElementById('accrualSoWhatLabel');
      const aSwList  = document.getElementById('accrualSoWhatList');
      aSwEl.style.display = '';

      // Classify state
      const isAccrualClean    = pctNotInvoiced < 10;
      const isAccrualModerate = pctNotInvoiced >= 10 && pctNotInvoiced < 25;
      const isAccrualHigh     = pctNotInvoiced >= 25;
      const aColor  = isAccrualHigh ? '#dc2626' : isAccrualModerate ? '#d97706' : '#0f766e';
      const aBorder = isAccrualHigh ? 'rgba(220,38,38,0.25)' : isAccrualModerate ? 'rgba(245,158,11,0.30)' : 'rgba(15,118,110,0.25)';
      const aBg     = isAccrualHigh ? '#fef9f9' : isAccrualModerate ? '#fffbeb' : '#f0fdf9';

      aSwEl.style.border     = `1.5px solid ${aBorder}`;
      aSwEl.style.background = aBg;

      const aIcon  = isAccrualHigh ? '🔴' : isAccrualModerate ? '⚠️' : '✅';
      const aStatus = isAccrualHigh ? 'High Accrual Risk' : isAccrualModerate ? 'Moderate — Monitor Closely' : 'Healthy — Invoicing On Track';
      aSwLabel.style.color = aColor;
      aSwLabel.innerHTML   = `💡 What · So What · Now What — ${aIcon} ${aStatus} <span class="help-icon" style="margin-left:4px;vertical-align:middle;" data-help="How the status is determined — ✅ Healthy: un-invoiced accruals below 10% of total incurred · ⚠️ Moderate: 10–24% · 🔴 High Risk: 25%+. Metric = accrual amount ÷ total incurred spend."></span>`;

      const ab = (text) => `<li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:${aColor};font-weight:700;flex-shrink:0;">›</span>${text}</li>`;
      const aBullets = [];
      const worstAccrualMonth = monthlyTotals.reduce((a,b) => b.accrual > a.accrual ? b : a, monthlyTotals[0]);

      // ── WHAT — factual observations ─────────────────────────
      const aWhatParts = [];
      if (isAccrualHigh) {
        aWhatParts.push(`<strong style="color:#0b1220;">${formatPercent(pctNotInvoiced)} of incurred costs are not yet invoiced</strong> — ${formatCurrency(totalAccrued)} sitting as open accruals.`);
      } else if (isAccrualModerate) {
        aWhatParts.push(`<strong style="color:#0b1220;">${formatPercent(pctNotInvoiced)} of incurred costs are not yet invoiced</strong> — ${formatCurrency(totalAccrued)} in open accruals.`);
      } else {
        aWhatParts.push(`<strong style="color:#0b1220;">${formatPercent(pctNotInvoiced)} of incurred costs are un-invoiced</strong> — ${formatCurrency(totalAccrued)} in open accruals.`);
      }
      if (openMonths > 0) {
        aWhatParts.push(`<strong style="color:#0b1220;">${openMonths} of 12 months</strong> still have open accruals.`);
      }
      if (worstAccrualMonth && worstAccrualMonth.accrual > 0) {
        aWhatParts.push(`Highest open accrual: <strong style="color:#0b1220;">${worstAccrualMonth.month}</strong> — ${formatCurrency(worstAccrualMonth.accrual)} un-invoiced (${formatPercent(worstAccrualMonth.incurred > 0 ? worstAccrualMonth.accrual / worstAccrualMonth.incurred * 100 : 0)} of that month's spend).`);
      }
      if (totalInvoiceCount > 0) {
        aWhatParts.push(`${totalInvoiceCount.toLocaleString()} invoices received; ${openVendorMonthCount} vendor-accrual records remain open.`);
      }

      // ── SO WHAT — business meaning & risk ────────────────────
      const aSoWhatParts = [];
      if (isAccrualHigh) {
        aSoWhatParts.push(`This level of un-invoiced cost creates significant P&amp;L uncertainty and close risk — finance estimates are substituting for real invoices.`);
        if (openMonths >= 6) aSoWhatParts.push(`Over half the year has unsettled accruals, suggesting a systematic invoicing lag, not isolated delays.`);
        if (worstAccrualMonth && worstAccrualMonth.accrual > 0) aSoWhatParts.push(`${worstAccrualMonth.month}'s accrual estimate may diverge materially from the final invoice, creating a P&amp;L true-up at settlement.`);
      } else if (isAccrualModerate) {
        aSoWhatParts.push(`Manageable now, but if the gap between incurred and invoiced keeps widening month-on-month, invoice discipline is slipping.`);
        if (openVendorMonthCount > 0) aSoWhatParts.push(`Expand any red month in the table below to see exactly which vendors are still outstanding.`);
      } else {
        aSoWhatParts.push(`Vendors are billing on time and accrual estimates are closely matching actuals. Month-end close risk is low.`);
        if (openVendorMonthCount === 0) aSoWhatParts.push(`All vendor accruals are fully invoiced and balanced.`);
      }

      // ── NOW WHAT — action + owner + timeline ─────────────────
      const aNowWhat = isAccrualHigh
        ? `Immediately contact vendors with the largest open accruals and set a hard deadline for invoice submission. Review whether accrual estimates are based on contracts (good) or guesses (bad). Brief CFO on P&L close exposure before month-end.`
        : isAccrualModerate
        ? `Add accrual reconciliation to your monthly vendor review cadence. Ensure accrual amounts are based on contract rates, not estimates. Flag any accrual older than 60 days for escalation.`
        : `No urgent action. Maintain current invoicing requirements in vendor contracts and verify accrual methodology at next audit cycle.`;

      // ── Render as W/SW/NW grid ────────────────────────────────
      const aRow = (lblCls, lbl, content) =>
        `<div class="wswn-row">
           <span class="wswn-label ${lblCls}">${lbl}</span>
           <span class="wswn-content">${content}</span>
         </div>`;

      aSwList.innerHTML = `<div class="wswn">
        ${aRow('lbl-what',    'What',     aWhatParts.join(' '))}
        ${aRow('lbl-sowhat',  'So What',  aSoWhatParts.join(' '))}
        ${aRow('lbl-nowwhat', 'Now What', `<strong style="color:#0b1220;">${aNowWhat}</strong>`)}
      </div>`;
    }
    
    function renderAccrualChart(monthlyTotals) {
      const canvas = document.getElementById('accrualChart');
      const container = canvas.parentElement.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const maxVal = Math.max(...monthlyTotals.map(m => Math.max(m.incurred, m.invoiced)));
      const paddingLeft = 60;
      const paddingRight = 40;
      const paddingTop = 30;
      const paddingBottom = 40;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const pointGap = chartW / (monthlyTotals.length - 1);
      
      // Grid
      ctx.strokeStyle = 'rgba(12, 23, 45, 0.08)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = paddingTop + (i / 4) * chartH;
        ctx.beginPath();
        ctx.moveTo(paddingLeft, y);
        ctx.lineTo(w - paddingRight, y);
        ctx.stroke();
      }
      
      // Y-axis labels
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for (let i = 0; i <= 4; i++) {
        const val = maxVal * (1 - i / 4);
        const y = paddingTop + (i / 4) * chartH;
        ctx.fillText('$' + (val / 1000).toFixed(0) + 'K', paddingLeft - 10, y);
      }
      
      // Draw incurred line
      ctx.beginPath();
      ctx.strokeStyle = '#1b4d7a';
      ctx.lineWidth = 2;
      monthlyTotals.forEach((m, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (m.incurred / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      
      // Draw invoiced line
      ctx.beginPath();
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 2;
      ctx.setLineDash([4, 4]);
      monthlyTotals.forEach((m, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (m.invoiced / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Month labels
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      monthlyTotals.forEach((m, i) => {
        if (i % 2 === 0) {
          const x = paddingLeft + i * pointGap;
          ctx.fillText(m.month, x, h - paddingBottom + 5);
        }
      });
      
      // Legend
      ctx.fillStyle = '#1b4d7a';
      ctx.fillRect(paddingLeft, 10, 15, 3);
      ctx.fillStyle = '#0b1220';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText('Incurred', paddingLeft + 20, 12);
      
      ctx.fillStyle = '#0f766e';
      ctx.fillRect(paddingLeft + 80, 10, 15, 3);
      ctx.fillText('Invoiced', paddingLeft + 100, 12);
    }
    
    // ========== FORECAST VS ACTUAL FUNCTIONS ==========
    
    function setCompareMode(mode) {
      compareMode = mode;
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      renderForecastVsActual();
    }
    
    function renderForecastVsActual() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      // ── Plan Builder integration ──
      // If Plan Builder is enabled and has valid commitments, use its forecast/budget;
      // otherwise fall back to the existing forecastBudget (sample/random/upload).
      const activeForecastBudget = (typeof pbGetForecastBudget === 'function')
        ? pbGetForecastBudget(forecastBudget)
        : forecastBudget;
      
      const actualByMonth = months.map(month => {
        const monthNum = months.indexOf(month) + 1;
        const monthTrans = transactions.filter(t => t.date.startsWith(`2025-${String(monthNum).padStart(2, '0')}`));
        const actual = monthTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        return { month, actual };
      });
      
      const comparison = actualByMonth.map(a => {
        const monthForecast = activeForecastBudget.filter(f => f.month === a.month);
        const forecast = monthForecast.reduce((sum, f) => sum + parseFloat(f.forecast_amount), 0);
        const budget = monthForecast.reduce((sum, f) => sum + parseFloat(f.budget_amount), 0);
        const compare = compareMode === 'forecast' ? forecast : budget;
        const variance = a.actual - compare;
        const variancePct = compare > 0 ? (variance / compare) * 100 : 0;
        return { ...a, forecast, budget, compare, variance, variancePct };
      });
      
      const chartTitle = compareMode === 'forecast' ? 'Actual vs Forecast' : 'Actual vs Budget';
      document.getElementById('forecastChartTitle').textContent = chartTitle;
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Month <span class="help-icon" data-help="The reporting month. Scan down this column looking for consecutive months of overspend — that pattern means the forecast is systematically too low and needs to be revised upward."></span></th>
            <th>Actual <span class="help-icon" data-help="What was actually spent in this month, based on all vendor invoices and transactions processed. This is the ground truth."></span></th>
            <th>${compareMode === 'forecast' ? 'Forecast <span class="help-icon" data-help="The rolling best estimate of what spend would be for this month, updated during the period. Comparing actuals to forecast shows whether recent predictions are tracking reality."></span>' : 'Budget <span class="help-icon" data-help="The original spend approved at the start of the year. Comparing to budget shows whether you\'re on track versus the annual plan — even if the forecast has since been revised."></span>'}</th>
            <th>Variance $ <span class="help-icon" data-help="Actual minus Forecast/Budget in dollar terms. Red = you overspent. Green = you came in under. Large dollar variances on big cost categories need a written explanation for leadership."></span></th>
            <th>Variance % <span class="help-icon" data-help="The variance as a percentage of the plan. More useful than the dollar figure alone when comparing months or categories of different sizes. Above 10% typically triggers a formal reforecast."></span></th>
          </tr>
        </thead>
        <tbody>
      `;
      comparison.forEach(c => {
        // Positive variance = overspent (bad = red). Negative = underspent (good = green).
        const dollarClass  = c.variance > 0 ? 'highlight-red' : c.variance < 0 ? 'highlight-green' : '';
        const pctClass     = c.variancePct > 0 ? 'highlight-red' : c.variancePct < 0 ? 'highlight-green' : '';
        const dollarPrefix = c.variance > 0 ? '+' : '';
        const pctPrefix    = c.variancePct > 0 ? '+' : '';
        tableHTML += `
          <tr>
            <td>${c.month}</td>
            <td>${formatCurrency(c.actual)}</td>
            <td>${formatCurrency(c.compare)}</td>
            <td class="${dollarClass}">${dollarPrefix}${formatCurrency(c.variance)}</td>
            <td class="${pctClass}">${pctPrefix}${formatPercent(c.variancePct)}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('forecastTable').innerHTML = tableHTML;
      
      // --- Dynamic So What: Forecast vs Actual ---
      const totalActual      = comparison.reduce((s,c) => s + c.actual, 0);
      const totalCompare     = comparison.reduce((s,c) => s + c.compare, 0);
      const totalVariance    = totalActual - totalCompare;
      const totalVariancePct = totalCompare > 0 ? (totalVariance / totalCompare) * 100 : 0;
      const overrunMonths    = comparison.filter(c => c.variancePct > 10);
      const underrunMonths   = comparison.filter(c => c.variancePct < -10);
      const onTrackMonths    = comparison.filter(c => c.variancePct >= -10 && c.variancePct <= 10);
      const worstMonth       = comparison.reduce((a, b) => b.variancePct > a.variancePct ? b : a, comparison[0]);
      const bestMonth        = comparison.reduce((a, b) => b.variancePct < a.variancePct ? b : a, comparison[0]);
      const label            = compareMode === 'forecast' ? 'forecast' : 'budget';

      const soWhatEl    = document.getElementById('forecastSoWhat');
      const soWhatLabel = document.getElementById('forecastSoWhatLabel');
      const soWhatList  = document.getElementById('forecastSoWhatList');
      soWhatEl.style.display = '';

      // Classify overall state — mirrors exactly how sections 1 and 2 work
      const isCritical  = totalVariancePct > 10 || overrunMonths.length >= 3;
      const isModerate  = !isCritical && (totalVariancePct > 3 || overrunMonths.length >= 1);
      const isHealthy   = !isCritical && !isModerate;

      const accentColor = isCritical ? '#dc2626' : isModerate ? '#d97706' : '#0f766e';
      const borderColor = isCritical ? 'rgba(220,38,38,0.25)'    : isModerate ? 'rgba(245,158,11,0.30)' : 'rgba(15,118,110,0.25)';
      const bgColor     = isCritical ? '#fef9f9'                 : isModerate ? '#fffbeb'               : '#f0fdf9';
      const statusIcon  = isCritical ? '🔴' : isModerate ? '⚠️' : '✅';
      const statusLabel = isCritical
        ? 'Overspend — Reforecast Required'
        : isModerate
        ? 'Caution — Monitor Closely'
        : 'On Track — Forecast Discipline Holding';

      soWhatEl.style.border     = `1.5px solid ${borderColor}`;
      soWhatEl.style.background = bgColor;
      soWhatLabel.style.color   = accentColor;
      soWhatLabel.innerHTML     = `💡 What · So What · Now What — ${statusIcon} ${statusLabel} <span class="help-icon" style="margin-left:4px;vertical-align:middle;" data-help="How the status is determined — ✅ On Track: overall variance below 3% AND no overrun months · ⚠️ Moderate: variance 3–10% OR 1–2 overrun months · 🔴 Critical: variance above 10% OR 3+ overrun months."></span>`;

      const b = (text) =>
        `<li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:${accentColor};font-weight:700;flex-shrink:0;">›</span>${text}</li>`;

      const bullets = [];

      // ── WHAT — factual observations ─────────────────────────
      const fWhatParts = [];
      if (isCritical) {
        fWhatParts.push(`<strong style="color:#0b1220;">Overall: ${totalVariancePct > 0 ? '+' : ''}${formatPercent(totalVariancePct)} vs ${label}</strong> — actual spend exceeded the ${label} by ${formatCurrency(Math.abs(totalVariance))} across the year.`);
      } else if (isModerate) {
        fWhatParts.push(`<strong style="color:#0b1220;">Overall: ${totalVariancePct > 0 ? '+' : ''}${formatPercent(totalVariancePct)} vs ${label}</strong> — spend is running ${formatCurrency(Math.abs(totalVariance))} above plan.`);
      } else if (totalVariancePct < 0) {
        fWhatParts.push(`<strong style="color:#0b1220;">Overall: ${formatPercent(Math.abs(totalVariancePct))} under ${label}</strong> — actual spend came in ${formatCurrency(Math.abs(totalVariance))} below plan.`);
      } else {
        fWhatParts.push(`<strong style="color:#0b1220;">Overall: On track</strong> — total spend is within ${formatPercent(Math.abs(totalVariancePct))} of ${label} (${totalVariance >= 0 ? '+' : ''}${formatCurrency(totalVariance)}).`);
      }
      if (overrunMonths.length > 0) {
        const names = overrunMonths.map(c => `${c.month} (+${formatPercent(c.variancePct)})`).join(', ');
        fWhatParts.push(`<strong style="color:#0b1220;">${overrunMonths.length} month${overrunMonths.length > 1 ? 's' : ''}</strong> exceeded ${label} by &gt;10%: ${names}.`);
      }
      if (underrunMonths.length > 0 && overrunMonths.length === 0) {
        const names = underrunMonths.map(c => `${c.month} (${formatPercent(c.variancePct)})`).join(', ');
        fWhatParts.push(`<strong style="color:#0b1220;">${underrunMonths.length} month${underrunMonths.length > 1 ? 's' : ''}</strong> came in &gt;10% under ${label}: ${names}.`);
      }
      if (worstMonth && worstMonth.variancePct > 5) {
        fWhatParts.push(`Worst month: <strong style="color:#0b1220;">${worstMonth.month}</strong> — ${formatCurrency(worstMonth.variance)} over ${label} (+${formatPercent(worstMonth.variancePct)}).`);
      }
      if (isHealthy && bestMonth && bestMonth.variancePct < -5) {
        fWhatParts.push(`Best month: <strong style="color:#0b1220;">${bestMonth.month}</strong> — ${formatCurrency(Math.abs(bestMonth.variance))} under ${label} (${formatPercent(bestMonth.variancePct)}).`);
      }

      // ── SO WHAT — business meaning & risk ────────────────────
      const fSoWhatParts = [];
      if (isCritical) {
        fSoWhatParts.push(`This is a material overrun requiring a formal explanation to leadership and an updated rolling forecast.`);
        if (overrunMonths.length >= 3) fSoWhatParts.push(`${overrunMonths.length}+ overrun months signals a systematic bias — the forecast baseline is set too low and needs revising upward, not just explained away.`);
      } else if (isModerate) {
        fSoWhatParts.push(`Still within tolerance, but if overrun months persist, this will require a reforecast before it becomes material.`);
        if (overrunMonths.length >= 1) fSoWhatParts.push(`Before escalating: check whether the driver is timing (late invoice), rate (vendor overbilled), or genuine volume increase. Timing-only variances should be documented in close commentary — not treated as a control issue.`);
      } else if (totalVariancePct < 0) {
        fSoWhatParts.push(`Confirm whether spend was genuinely saved or just deferred — delayed costs will surface in later months and distort the forecast.`);
        if (isHealthy && bestMonth && bestMonth.variancePct < -5) fSoWhatParts.push(`Document what drove ${bestMonth.month}'s outperformance — delayed invoice, genuine saving, or tighter vendor management — so the practice can be repeated.`);
      } else {
        fSoWhatParts.push(`Forecast discipline is holding across the year. Methodology is working.`);
      }
      if (worstMonth && worstMonth.variancePct > 5) {
        fSoWhatParts.push(`Drill into ${worstMonth.month}: identify which vendors or cost centres drove the spike and confirm whether the driver is recurring before the next close.`);
      }

      // ── NOW WHAT — action + owner + timeline ─────────────────
      const fNowWhat = isCritical
        ? `Trigger a reforecast now. Identify the top 2–3 cost categories driving overruns, get owner sign-off on revised numbers, and present to leadership before next reporting cycle. Do not wait for month-end.`
        : isModerate
        ? `Review overrun months: if the driver is timing only, document in close commentary. If rate-driven, route to Procurement. If volume-driven, update the rolling forecast. Do not carry the variance forward without a written explanation.`
        : `No action required on variance. Maintain current controls and use this as a baseline for the next budget cycle — forecast methodology is working.`;

      // ── Render as W/SW/NW grid ────────────────────────────────
      const fRow = (lblCls, lbl, content) =>
        `<div class="wswn-row">
           <span class="wswn-label ${lblCls}">${lbl}</span>
           <span class="wswn-content">${content}</span>
         </div>`;

      soWhatList.innerHTML = `<div class="wswn">
        ${fRow('lbl-what',    'What',     fWhatParts.join(' '))}
        ${fRow('lbl-sowhat',  'So What',  fSoWhatParts.join(' '))}
        ${fRow('lbl-nowwhat', 'Now What', `<strong style="color:#0b1220;">${fNowWhat}</strong>`)}
      </div>`;
      
      renderForecastChart(comparison);
    }
    
    function renderForecastChart(comparison) {
      const canvas = document.getElementById('forecastChart');
      const container = canvas.parentElement.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const maxVal = Math.max(...comparison.map(c => Math.max(c.actual, c.compare)));
      const paddingLeft = 60;
      const paddingRight = 40;
      const paddingTop = 30;
      const paddingBottom = 40;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const pointGap = chartW / (comparison.length - 1);
      
      // Grid
      ctx.strokeStyle = 'rgba(12, 23, 45, 0.08)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = paddingTop + (i / 4) * chartH;
        ctx.beginPath();
        ctx.moveTo(paddingLeft, y);
        ctx.lineTo(w - paddingRight, y);
        ctx.stroke();
      }
      
      // Y-axis
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for (let i = 0; i <= 4; i++) {
        const val = maxVal * (1 - i / 4);
        const y = paddingTop + (i / 4) * chartH;
        ctx.fillText('$' + (val / 1000).toFixed(0) + 'K', paddingLeft - 10, y);
      }
      
      // Actual line
      ctx.beginPath();
      ctx.strokeStyle = '#0b1220';
      ctx.lineWidth = 2;
      comparison.forEach((c, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (c.actual / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      
      // Compare line
      ctx.beginPath();
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 2;
      ctx.setLineDash([4, 4]);
      comparison.forEach((c, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (c.compare / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Month labels
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      comparison.forEach((c, i) => {
        if (i % 2 === 0) {
          const x = paddingLeft + i * pointGap;
          ctx.fillText(c.month, x, h - paddingBottom + 5);
        }
      });
      
      // Legend
      ctx.fillStyle = '#0b1220';
      ctx.fillRect(paddingLeft, 10, 15, 3);
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText('Actual', paddingLeft + 20, 12);
      
      ctx.fillStyle = '#0f766e';
      ctx.fillRect(paddingLeft + 70, 10, 15, 3);
      ctx.fillText(compareMode === 'forecast' ? 'Forecast' : 'Budget', paddingLeft + 90, 12);
    }
    
    // ═══════════════════════════════════════════════════════════════════════
    // RISK v2 — Preset & mode controls
    // ═══════════════════════════════════════════════════════════════════════

    function applyRiskPreset(preset) {
      if (preset === 'custom') return;       // read-only placeholder
      _riskPreset = preset;
      _lastNamedPreset = preset;             // remember for reset
      const p = RISK_PRESETS[preset];
      document.getElementById('thresholdRate').value          = p.rateVariance;
      document.getElementById('thresholdSpike').value         = p.spike;
      document.getElementById('thresholdAccrual').value       = p.accrual;
      document.getElementById('thresholdConcentration').value = Math.min(p.concentration, 65);
      const rl = document.getElementById('resetPresetLink');
      if (rl) rl.style.display = 'none';
      computeRiskFlags();
    }

    function resetToLastPreset() {
      const preset = _lastNamedPreset || 'balanced';
      _riskPreset = preset;
      const p = RISK_PRESETS[preset];
      document.getElementById('thresholdRate').value          = p.rateVariance;
      document.getElementById('thresholdSpike').value         = p.spike;
      document.getElementById('thresholdAccrual').value       = p.accrual;
      document.getElementById('thresholdConcentration').value = Math.min(p.concentration, 65);
      const sel = document.getElementById('riskPreset');
      if (sel) sel.value = preset;
      const cOpt = sel ? sel.querySelector('option[value="custom"]') : null;
      if (cOpt) { cOpt.hidden = true; cOpt.disabled = true; }
      const rl = document.getElementById('resetPresetLink');
      if (rl) rl.style.display = 'none';
      computeRiskFlags();
    }

    function setDetectionMode(mode) {
      _detectionMode = mode;
      document.getElementById('modeThreshBtn').classList.toggle('active', mode === 'threshold');
      document.getElementById('modeAdaptBtn').classList.toggle('active',  mode === 'adaptive');
      computeRiskFlags();
    }

    function _updateDetectionModeBadges(thresholdCount, adaptiveCount) {
      const tEl = document.getElementById('modeThreshCount');
      const aEl = document.getElementById('modeAdaptCount');
      if (tEl) tEl.textContent = thresholdCount > 0 ? thresholdCount : '';
      if (aEl) aEl.textContent = adaptiveCount  > 0 ? adaptiveCount  : '';
    }

    // Called on every manual keypress — switches dropdown to Custom
    function onThresholdInput() {
      _riskPreset = 'custom';
      const sel  = document.getElementById('riskPreset');
      const cOpt = sel.querySelector('option[value="custom"]');
      cOpt.hidden = false; cOpt.disabled = false;
      sel.value = 'custom';
      const rl = document.getElementById('resetPresetLink');
      if (rl) rl.style.display = '';
      computeRiskFlags();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // RISK v2 — Adaptive detection helpers (MAD)
    //
    // WHY MAD?  Standard deviation is pulled upward by the very outliers we
    // want to catch, making them look less extreme. MAD (median of absolute
    // deviations from the median) is not affected by outliers — it's the
    // standard robust alternative to σ. A value is flagged when its modified
    // z-score  (value − median) / MAD > k. We use k=2.5 (≈97.5th pctile
    // under a normal distribution) — conservative enough to avoid noise but
    // sensitive to genuine spikes.  OR logic: fires if threshold OR adaptive
    // triggers, catching anomalies the fixed % would miss when a category's
    // normal spend is very flat.
    // ═══════════════════════════════════════════════════════════════════════

    function _median(arr) {
      if (!arr.length) return 0;
      const s = [...arr].sort((a, b) => a - b);
      const m = Math.floor(s.length / 2);
      return s.length % 2 ? s[m] : (s[m - 1] + s[m]) / 2;
    }

    function _mad(arr) {
      const med = _median(arr);
      return _median(arr.map(v => Math.abs(v - med)));
    }

    // Returns true if `value` is a high outlier in `series` (k = 2.5 by default)
    function _isMADAnomaly(value, series, k) {
      k = k || 2.5;
      if (series.length < 3) return false;   // need enough history
      const med = _median(series);
      const mad = _mad(series);
      if (mad === 0) return false;           // no variance → can't score
      return (value - med) / mad > k;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // RISK v2 — Guardrail helpers
    // ═══════════════════════════════════════════════════════════════════════

    // Show or hide an inline warning beneath one threshold input
    function _setWarn(elId, value, opts) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.className = 'threshold-warn';
      const { noisyBelow, strictAbove, isConc } = opts;
      if (isConc && value >= 65) {
        el.textContent = 'At 65%+, concentration alerts are very unlikely to trigger.';
        el.classList.add('w-dead'); el.style.display = 'block';
      } else if (value <= noisyBelow) {
        el.textContent = 'Very sensitive: may produce noisy alerts.';
        el.classList.add('w-noisy'); el.style.display = 'block';
      } else if (value >= strictAbove) {
        el.textContent = 'Very strict: may hide early warning signs.';
        el.classList.add('w-strict'); el.style.display = 'block';
      } else {
        el.style.display = 'none';
      }
    }

    // Update the live sensitivity pill next to the preset dropdown
    function _updateSensitivityPill(t) {
      // Simple normalised average — spike ÷5 to bring to same ~0-100 scale
      const avg  = (t.rateVariance + t.spike / 5 + t.accrual + t.concentration) / 4;
      const pill = document.getElementById('sensitivityPill');
      if (!pill) return;
      if (avg <= 15) {
        pill.textContent = 'High sensitivity (more alerts)';
        pill.className   = 'sens-pill sp-high';
      } else if (avg <= 28) {
        pill.textContent = 'Balanced';
        pill.className   = 'sens-pill sp-mid';
      } else {
        pill.textContent = 'Low sensitivity (fewer alerts)';
        pill.className   = 'sens-pill sp-low';
      }
    }

    // ═══════════════════════════════════════════════════════════════════════
    // RISK v2 — Main flag computation (replaces v1 computeRiskFlags entirely)
    // ═══════════════════════════════════════════════════════════════════════

    function computeRiskFlags() {
      // 1. Read & clamp inputs ──────────────────────────────────────────────
      thresholds.rateVariance  = Math.min(parseFloat(document.getElementById('thresholdRate').value)          || 20,  100);
      thresholds.spike         = Math.min(parseFloat(document.getElementById('thresholdSpike').value)         || 35,  500);
      thresholds.accrual       = Math.min(parseFloat(document.getElementById('thresholdAccrual').value)       || 25,  100);
      thresholds.concentration = Math.min(parseFloat(document.getElementById('thresholdConcentration').value) || 30,   65);
      // Sync concentration field if user typed > 65
      document.getElementById('thresholdConcentration').value = thresholds.concentration;

      // 2. Guardrail warnings & sensitivity pill ────────────────────────────
      _setWarn('warnRate',          thresholds.rateVariance,  { noisyBelow: 5,  strictAbove: 60 });
      _setWarn('warnSpike',         thresholds.spike,         { noisyBelow: 10, strictAbove: 80 });
      _setWarn('warnAccrual',       thresholds.accrual,       { noisyBelow: 8,  strictAbove: 60 });
      _setWarn('warnConcentration', thresholds.concentration, { noisyBelow: 10, strictAbove: 55, isConc: true });
      _updateSensitivityPill(thresholds);

      const alerts = [];

      // 3a. Rate leakage — threshold only ──────────────────────────────────
      const vendorLeakage = {};
      transactions.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        if (!rc) return;
        if (!vendorLeakage[t.vendor_id]) {
          vendorLeakage[t.vendor_id] = {
            vendor_name: rc.vendor_name, service: rc.service,
            contract_rate: parseFloat(rc.contract_rate),
            total_amount: 0, total_units: 0, leakage_amount: 0
          };
        }
        const units = parseFloat(t.units), unitRate = parseFloat(t.unit_rate), contractRate = parseFloat(rc.contract_rate);
        vendorLeakage[t.vendor_id].total_amount += parseFloat(t.amount);
        vendorLeakage[t.vendor_id].total_units  += units;
        if (unitRate > contractRate * (1 + thresholds.rateVariance / 100)) {
          vendorLeakage[t.vendor_id].leakage_amount += (unitRate - contractRate) * units;
        }
      });
      Object.values(vendorLeakage).forEach(v => {
        if (v.leakage_amount > 0) {
          alerts.push({
            severity:    v.leakage_amount > 2000 ? 'high' : v.leakage_amount > 500 ? 'med' : 'low',
            triggeredBy: 'Threshold',
            title:       `Rate Leakage: ${v.vendor_name}`,
            what:        `Paid ${formatCurrency(v.leakage_amount)} above contract rate for ${v.service}.`,
            why:         'Erodes margin and signals weak rate discipline.',
            action:      'Review invoices, renegotiate rate, or enforce PO controls.',
            owner:       'Procurement',
            ownerClass:  'owner-procurement',
            ownerNote:   'Finance flags the leakage; Procurement resolves with vendor.',
            triggerNote: `Rate variance trigger (>${thresholds.rateVariance}% above contract)`,
            impactDollar: v.leakage_amount > 2000 ? v.leakage_amount : undefined
          });
        }
      });

      // 3b. Spend spikes — threshold OR adaptive (MAD) ─────────────────────
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const catMonthSpend = {};
      transactions.forEach(t => {
        const mn  = parseInt(t.date.substring(5,7));
        const key = `${t.category}-${months[mn-1]}`;
        if (!catMonthSpend[key]) catMonthSpend[key] = { category: t.category, month: months[mn-1], amount: 0 };
        catMonthSpend[key].amount += parseFloat(t.amount);
      });
      // Build per-category series for MAD
      const catSeries = {};
      Object.values(catMonthSpend).forEach(cm => {
        if (!catSeries[cm.category]) catSeries[cm.category] = [];
        catSeries[cm.category].push(cm.amount);
      });
      const catAvgs = {};
      Object.values(catMonthSpend).forEach(cm => {
        if (!catAvgs[cm.category]) catAvgs[cm.category] = { total: 0, count: 0 };
        catAvgs[cm.category].total += cm.amount; catAvgs[cm.category].count++;
      });
      Object.values(catMonthSpend).forEach(cm => {
        const avg       = catAvgs[cm.category].total / catAvgs[cm.category].count;
        const spikePct  = avg > 0 ? ((cm.amount - avg) / avg) * 100 : 0;
        const threshHit = spikePct > thresholds.spike;
        // Adaptive: MAD outlier check — only active in adaptive mode
        const adaptHit  = _detectionMode === 'adaptive' && _isMADAnomaly(cm.amount, catSeries[cm.category]);

        if (!threshHit && !adaptHit) return;

        // Attribution
        let triggeredBy, triggerNote;
        if (threshHit && adaptHit) {
          triggeredBy = 'Both';
          triggerNote = `Spend spike: +${spikePct.toFixed(0)}% vs avg (Threshold) · Statistically unusual vs history (Adaptive)`;
        } else if (adaptHit) {
          triggeredBy = 'Adaptive';
          triggerNote = `Spend spike: Statistically unusual vs category history (MAD)`;
        } else {
          triggeredBy = 'Threshold';
          triggerNote = `Spend spike: +${spikePct.toFixed(0)}% vs avg (Threshold >${thresholds.spike}%)`;
        }

        const spikeExcess = cm.amount - avg;
        alerts.push({
          severity:    spikePct > 40 ? 'high' : spikePct > 25 ? 'med' : 'low',
          triggeredBy, triggerNote,
          title:  `Spend Spike: ${cm.category} (${cm.month})`,
          what:   `${formatPercent(spikePct)} above average (${formatCurrency(cm.amount)} vs ${formatCurrency(avg)}).`,
          why:    'May indicate a one-time event, vendor issue, or forecast miss.',
          action: 'Investigate root cause and update forecast if recurring.',
          owner:     'Budget Owner',
          ownerClass: 'owner-budget',
          ownerNote:  'Owner explains the driver — timing event, genuine volume, or forecast gap.',
          impactDollar: spikePct > 40 ? spikeExcess : undefined
        });
      });

      // 3c. Accrual risk — threshold only ──────────────────────────────────
      accruals.forEach(a => {
        const incurred = parseFloat(a.incurred_amount);
        const accrual  = parseFloat(a.accrual_amount);
        if (accrual > incurred * (thresholds.accrual / 100)) {
          const rc = rateCards.find(r => r.vendor_id === a.vendor_id);
          alerts.push({
            severity:    accrual > incurred * 0.3 ? 'high' : 'med',
            triggeredBy: 'Threshold',
            title:       `Accrual Risk: ${rc ? rc.vendor_name : a.vendor_id} (${a.month})`,
            what:        `Accrual of ${formatCurrency(accrual)} is ${formatPercent((accrual/incurred)*100)} of incurred cost.`,
            why:         'Large accruals increase close variance and signal invoice delays.',
            action:      'Follow up with vendor on invoice timing or true-up accrual.',
            owner:       'AP / Finance Ops',
            ownerClass:  'owner-ap',
            ownerNote:   'AP confirms whether invoice is pending or a true-up is needed before close.',
            triggerNote: `Accrual ratio exceeds trigger (>${thresholds.accrual}% of incurred)`,
            impactDollar: accrual > incurred * 0.3 ? accrual : undefined
          });
        }
      });

      // 3d. Concentration risk — threshold only, hard-capped at 65% ────────
      const vendorTotals = {};
      transactions.forEach(t => {
        vendorTotals[t.vendor_id] = (vendorTotals[t.vendor_id] || 0) + parseFloat(t.amount);
      });
      const totalSpend = Object.values(vendorTotals).reduce((s,v) => s+v, 0);
      Object.entries(vendorTotals).forEach(([vid, amt]) => {
        const pct = (amt / totalSpend) * 100;
        if (pct > thresholds.concentration) {
          const rc = rateCards.find(r => r.vendor_id === vid);
          alerts.push({
            severity:    pct > 40 ? 'high' : pct > 30 ? 'med' : 'low',
            triggeredBy: 'Threshold',
            title:       `Concentration Risk: ${rc ? rc.vendor_name : vid}`,
            what:        `${formatPercent(pct)} of total spend (${formatCurrency(amt)}).`,
            why:         'High dependency on one vendor creates pricing and operational risk.',
            action:      'Diversify suppliers or negotiate volume-discount protections.',
            owner:       'Procurement',
            ownerClass:  'owner-procurement',
            ownerNote:   'Procurement assesses whether a second vendor or framework contract can reduce dependency.',
            triggerNote: `Concentration exceeds trigger (>${thresholds.concentration}% of total spend)`,
            impactDollar: pct > 40 ? amt : undefined
          });
        }
      });

      // 4. Sort by severity ─────────────────────────────────────────────────
      const sevOrd = { high: 0, med: 1, low: 2 };
      alerts.sort((a,b) => sevOrd[a.severity] - sevOrd[b.severity]);

      // 5. Render alert cards ───────────────────────────────────────────────
      const tbClass = { Threshold: 'tb-thr', Adaptive: 'tb-adap', Both: 'tb-both' };
      let alertsHTML = '';
      if (alerts.length === 0) {
        alertsHTML = `
          <div class="alerts-empty">
            <div class="alerts-empty-icon">✓</div>
            <div class="alerts-empty-title">No issues flagged under current thresholds</div>
            <div class="alerts-empty-sub">
              All metrics are within your configured trigger levels.
              Lower a trigger or switch to the Conservative preset to cast a wider net.
            </div>
          </div>`;
      } else {
        alerts.forEach(alert => {
          const tb = alert.triggeredBy || 'Threshold';
          const impactBadge = (alert.severity === 'high' && alert.impactDollar)
            ? `<span style="display:inline-flex;align-items:center;gap:4px;margin-left:6px;font-size:11px;font-weight:700;padding:2px 8px;border-radius:999px;background:rgba(220,38,38,0.10);color:#dc2626;">💸 ${formatCurrency(alert.impactDollar)} at risk</span>`
            : '';
          const ownerBadge = alert.owner
            ? `<div style="margin-top:10px;display:flex;align-items:center;gap:8px;padding-top:8px;border-top:1px solid rgba(12,23,45,0.06);">
                <span class="alert-owner-badge ${alert.ownerClass || 'owner-finance'}">→ ${alert.owner}</span>
                ${alert.ownerNote ? `<span style="font-size:11px;color:var(--muted);">${alert.ownerNote}</span>` : ''}
               </div>`
            : '';
          alertsHTML += `
            <div class="alert-card ${alert.severity}">
              <div class="alert-header">
                <div class="alert-title">${alert.title}${impactBadge}</div>
                <div style="display:flex;gap:5px;align-items:center;">
                  <span class="trig-badge ${tbClass[tb] || 'tb-thr'}">${tb}</span>
                  <div class="severity-badge ${alert.severity}">${alert.severity}</div>
                </div>
              </div>
              <div class="wswn" style="margin-top:8px;">
                <div class="wswn-row">
                  <span class="wswn-label lbl-what">What</span>
                  <span class="wswn-content">${alert.what}</span>
                </div>
                <div class="wswn-row">
                  <span class="wswn-label lbl-sowhat">So What</span>
                  <span class="wswn-content">${alert.why}</span>
                </div>
                <div class="wswn-row">
                  <span class="wswn-label lbl-nowwhat">Now What</span>
                  <span class="wswn-content"><strong style="color:#0b1220;">${alert.action}</strong></span>
                </div>
              </div>
              ${ownerBadge}
              <div style="margin-top:8px;font-size:11px;color:var(--muted);">⚑ ${alert.triggerNote || ''}</div>
            </div>`;
        });
      }
      document.getElementById('alertsContainer').innerHTML = alertsHTML;

      // 6. Counter / filter buttons ─────────────────────────────────────────
      const counterBar = document.getElementById('alertCounterBar');
      const highCount  = alerts.filter(a => a.severity === 'high').length;
      const medCount   = alerts.filter(a => a.severity === 'med').length;
      const lowCount   = alerts.filter(a => a.severity === 'low').length;
      _riskAlertCounts = { total: alerts.length, high: highCount, med: medCount, low: lowCount };

      // Update detection mode count badges
      (function() {
        const threshCount = alerts.length;
        let adaptCount = threshCount;
        if (_detectionMode === 'threshold') {
          const catSeries2 = {};
          Object.values(catMonthSpend).forEach(cm => {
            if (!catSeries2[cm.category]) catSeries2[cm.category] = [];
            catSeries2[cm.category].push(cm.amount);
          });
          let adaptExtra = 0;
          Object.values(catMonthSpend).forEach(cm => {
            const avg2  = catAvgs[cm.category].total / catAvgs[cm.category].count;
            const spPct = avg2 > 0 ? ((cm.amount - avg2) / avg2) * 100 : 0;
            const tHit2 = spPct > thresholds.spike;
            const aHit2 = _isMADAnomaly(cm.amount, catSeries2[cm.category]);
            if (!tHit2 && aHit2) adaptExtra++;
          });
          adaptCount = threshCount + adaptExtra;
        }
        _updateDetectionModeBadges(threshCount, adaptCount);
      })();

      if (alerts.length > 0) {
        counterBar.style.display = 'flex';
        document.getElementById('alertCountTotal').textContent = alerts.length + ' total';
        const hEl = document.getElementById('alertCountHigh');
        const mEl = document.getElementById('alertCountMed');
        const lEl = document.getElementById('alertCountLow');
        hEl.textContent = highCount ? highCount + ' High' : ''; hEl.style.display = highCount ? '' : 'none';
        mEl.textContent = medCount  ? medCount  + ' Med'  : ''; mEl.style.display = medCount  ? '' : 'none';
        lEl.textContent = lowCount  ? lowCount  + ' Low'  : ''; lEl.style.display = lowCount  ? '' : 'none';
        filterAlerts('all');
      } else {
        counterBar.style.display = 'none';
      }

      // 7. So What explainer (W/SW/NW) ──────────────────────────────────────
      const riskSoWhat      = document.getElementById('riskSoWhat');
      const riskSoWhatLabel = document.getElementById('riskSoWhatLabel');
      const riskSoWhatList  = document.getElementById('riskSoWhatList');
      if (alerts.length === 0) {
        riskSoWhat.style.display = 'none';
      } else {
        riskSoWhat.style.display = '';
        const rColor  = highCount > 0 ? '#dc2626' : medCount > 0 ? '#d97706' : '#6b7280';
        const rBorder = highCount > 0 ? 'rgba(220,38,38,0.25)' : medCount > 0 ? 'rgba(245,158,11,0.30)' : 'rgba(107,114,128,0.20)';
        const rBg     = highCount > 0 ? '#fef9f9' : medCount > 0 ? '#fffbeb' : '#f9fafb';
        const rIcon   = highCount > 0 ? '🔴' : medCount > 0 ? '⚠️' : '✅';
        const rStatus = highCount > 0 ? 'High Severity — Immediate Action' : medCount > 0 ? 'Moderate — Monitor Closely' : 'Low Risk — No Critical Flags';
        riskSoWhat.style.border     = `1.5px solid ${rBorder}`;
        riskSoWhat.style.background = rBg;
        riskSoWhatLabel.style.color = rColor;
        riskSoWhatLabel.innerHTML   = `💡 What · So What · Now What — ${rIcon} ${rStatus} <span class="help-icon" style="margin-left:4px;vertical-align:middle;" data-help="How the status is determined — ✅ Low Risk: no high or medium severity flags · ⚠️ Moderate: medium-severity flags only · 🔴 High Severity: one or more high-severity flags present. Severity is set per-flag type (e.g. leakage above $2K = high)."></span>`;

        const rateFlags    = alerts.filter(a => a.title.startsWith('Rate Leakage'));
        const spikeFlags   = alerts.filter(a => a.title.startsWith('Spend Spike'));
        const concFlags    = alerts.filter(a => a.title.startsWith('Concentration'));
        const accrualFlags = alerts.filter(a => a.title.startsWith('Accrual Risk'));

        const rWhatParts = [];
        rWhatParts.push(`<strong style="color:#0b1220;">${alerts.length} issue${alerts.length!==1?'s':''} flagged</strong> — ${[highCount&&`${highCount} high`,medCount&&`${medCount} medium`,lowCount&&`${lowCount} low`].filter(Boolean).join(', ')} severity.`);
        if (rateFlags.length)    rWhatParts.push(`${rateFlags.length} vendor${rateFlags.length>1?'s':''} with <strong style="color:#0b1220;">rate leakage</strong>.`);
        if (spikeFlags.length)   rWhatParts.push(`${spikeFlags.length} <strong style="color:#0b1220;">spend spike${spikeFlags.length>1?'s':''}</strong>.`);
        if (concFlags.length)    rWhatParts.push(`${concFlags.length} <strong style="color:#0b1220;">concentration risk</strong> flag${concFlags.length>1?'s':''}.`);
        if (accrualFlags.length) rWhatParts.push(`${accrualFlags.length} <strong style="color:#0b1220;">accrual risk</strong> flag${accrualFlags.length>1?'s':''}.`);

        const rSoWhatParts = [];
        if (highCount > 0) {
          const totalHighImpact = alerts.filter(a => a.severity === 'high' && a.impactDollar).reduce((s, a) => s + a.impactDollar, 0);
          const impactStr = totalHighImpact > 0 ? ` — <strong style="color:#dc2626;">${formatCurrency(totalHighImpact)} quantified at risk</strong>` : '';
          rSoWhatParts.push(`<strong style="color:#0b1220;">${highCount} high-severity issue${highCount>1?'s':''}</strong> are the biggest risks to spend control${impactStr}. Resolve before the next reporting period.`);
        } else if (medCount > 0) rSoWhatParts.push(`<strong style="color:#0b1220;">${medCount} medium-severity flag${medCount>1?'s':''}</strong> warrant close monitoring — escalate if the same vendors recur.`);
        else                   rSoWhatParts.push(`Only low-severity anomalies. No immediate risk to margin or cash flow.`);
        if (rateFlags.length)    rSoWhatParts.push(`Rate leakage erodes margin silently — each flagged vendor needs an invoice audit.`);
        if (concFlags.length)    rSoWhatParts.push(`Single-vendor over-reliance is an operational hazard: rate hikes, delivery delays, or supplier exits leave you with limited options.`);
        if (accrualFlags.length) rSoWhatParts.push(`High un-invoiced accruals create P&amp;L uncertainty at close.`);
        if (spikeFlags.length)   rSoWhatParts.push(`Recurring spend spikes indicate the forecast baseline needs updating.`);

        const rNowWhat = highCount > 0
          ? `Pause payments to vendors flagged for rate leakage pending invoice audit. Escalate high flags to procurement + CFO before next payment run. Set a 48-hour deadline per flag.`
          : medCount > 0
          ? `Assign each medium flag to a vendor manager this week. Tighten contract clauses at next renewal if the same vendors recur. Re-run in 30 days.`
          : `No urgent action. Review thresholds to ensure sensitivity is right. Schedule a quarterly anomaly review.`;

        const rRow = (cls, lbl, content) =>
          `<div class="wswn-row"><span class="wswn-label ${cls}">${lbl}</span><span class="wswn-content">${content}</span></div>`;
        riskSoWhatList.innerHTML = `<div class="wswn">
          ${rRow('lbl-what',    'What',     rWhatParts.join(' '))}
          ${rRow('lbl-sowhat',  'So What',  rSoWhatParts.join(' '))}
          ${rRow('lbl-nowwhat', 'Now What', `<strong style="color:#0b1220;">${rNowWhat}</strong>`)}
        </div>`;
      }

      renderSpendDecisionBox();
    }

    // ── Alert filter ────────────────────────────────────────────────────────
    function filterAlerts(severity) {
      const ids     = { all: 'alertCountTotal', high: 'alertCountHigh', med: 'alertCountMed', low: 'alertCountLow' };
      const borders = { all: 'rgba(12,23,45,0.30)', high: '#dc2626', med: '#d97706', low: '#6b7280' };
      Object.entries(ids).forEach(([key, id]) => {
        const btn = document.getElementById(id);
        if (!btn) return;
        btn.style.borderColor = (key === severity) ? borders[key] : 'transparent';
        btn.style.boxShadow   = (key === severity) ? '0 0 0 0px transparent' : '';
      });
      document.querySelectorAll('#alertsContainer .alert-card').forEach(card => {
        card.style.display = (severity === 'all' || card.classList.contains(severity)) ? '' : 'none';
      });
    }

    // ═══════════════════════════════════════════════════════════════════════
    // RISK v2 — Export Alerts CSV (includes v2 metadata)
    // ═══════════════════════════════════════════════════════════════════════

    function downloadRiskFlagsCSV() {
      // Re-evaluate alerts using current state to build export rows
      const exportRows = [];
      const today = new Date().toISOString().slice(0,10);
      const thStr = `rate=${thresholds.rateVariance}%,spike=${thresholds.spike}%,accrual=${thresholds.accrual}%,conc=${thresholds.concentration}%`;

      // — Rate leakage —
      const vl = {};
      transactions.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        if (!rc) return;
        if (!vl[t.vendor_id]) vl[t.vendor_id] = { name: rc.vendor_name, svc: rc.service, leakage: 0 };
        const ur = parseFloat(t.unit_rate), cr = parseFloat(rc.contract_rate), un = parseFloat(t.units);
        if (ur > cr * (1 + thresholds.rateVariance / 100)) vl[t.vendor_id].leakage += (ur - cr) * un;
      });
      Object.values(vl).forEach(v => {
        if (v.leakage > 0) exportRows.push({
          date: today, type: 'Rate Leakage',
          detail: `${v.name} / ${v.svc} — ${formatCurrency(v.leakage)} above contract`,
          severity: v.leakage > 2000 ? 'high' : v.leakage > 500 ? 'med' : 'low',
          triggeredBy: 'Threshold', detectionMode: _detectionMode, preset: _riskPreset,
          thresholds_used: thStr, trigger_note: `Rate variance trigger (>${thresholds.rateVariance}%)`
        });
      });

      // — Spend spikes —
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const cms = {}; transactions.forEach(t => {
        const mn = parseInt(t.date.substring(5,7));
        const key = `${t.category}-${months[mn-1]}`;
        if (!cms[key]) cms[key] = { cat: t.category, mon: months[mn-1], amt: 0, arr: [] };
        cms[key].amt += parseFloat(t.amount);
      });
      // Rebuild per-category arrays for MAD
      const cArr = {};
      Object.values(cms).forEach(c => { if (!cArr[c.cat]) cArr[c.cat] = []; cArr[c.cat].push(c.amt); });
      const cAvg = {};
      Object.values(cms).forEach(c => { if (!cAvg[c.cat]) cAvg[c.cat]={t:0,n:0}; cAvg[c.cat].t+=c.amt; cAvg[c.cat].n++; });
      Object.values(cms).forEach(cm => {
        const avg=cAvg[cm.cat].t/cAvg[cm.cat].n, sp=avg>0?((cm.amt-avg)/avg)*100:0;
        const tHit=sp>thresholds.spike, aHit=_detectionMode==='adaptive'&&_isMADAnomaly(cm.amt,cArr[cm.cat]);
        if (!tHit && !aHit) return;
        const tb = (tHit&&aHit)?'Both':aHit?'Adaptive':'Threshold';
        exportRows.push({
          date: today, type: 'Spend Spike',
          detail: `${cm.cat} (${cm.mon}) — +${sp.toFixed(0)}% vs avg (${formatCurrency(cm.amt)} vs ${formatCurrency(avg)})`,
          severity: sp>40?'high':sp>25?'med':'low',
          triggeredBy: tb, detectionMode: _detectionMode, preset: _riskPreset,
          thresholds_used: thStr, trigger_note: tb==='Both'?'Threshold + MAD':tb==='Adaptive'?'MAD anomaly':`>${thresholds.spike}% above avg`
        });
      });

      // — Accrual risk —
      accruals.forEach(a => {
        const inc=parseFloat(a.incurred_amount), acc=parseFloat(a.accrual_amount);
        if (acc > inc*(thresholds.accrual/100)) {
          const rc=rateCards.find(r=>r.vendor_id===a.vendor_id);
          exportRows.push({
            date: today, type: 'Accrual Risk',
            detail: `${rc?rc.vendor_name:a.vendor_id} (${a.month}) — ${formatCurrency(acc)} un-invoiced (${formatPercent((acc/inc)*100)})`,
            severity: acc>inc*0.3?'high':'med',
            triggeredBy: 'Threshold', detectionMode: _detectionMode, preset: _riskPreset,
            thresholds_used: thStr, trigger_note: `Accrual ratio >${thresholds.accrual}%`
          });
        }
      });

      // — Concentration risk —
      const vt={}; transactions.forEach(t=>{ vt[t.vendor_id]=(vt[t.vendor_id]||0)+parseFloat(t.amount); });
      const tot=Object.values(vt).reduce((s,v)=>s+v,0);
      Object.entries(vt).forEach(([id,amt])=>{
        const pct=(amt/tot)*100;
        if (pct>thresholds.concentration) {
          const rc=rateCards.find(r=>r.vendor_id===id);
          exportRows.push({
            date: today, type: 'Concentration Risk',
            detail: `${rc?rc.vendor_name:id} — ${formatPercent(pct)} of total spend`,
            severity: pct>40?'high':pct>30?'med':'low',
            triggeredBy: 'Threshold', detectionMode: _detectionMode, preset: _riskPreset,
            thresholds_used: thStr, trigger_note: `Concentration >${thresholds.concentration}%`
          });
        }
      });

      if (exportRows.length === 0) {
        showNotification('No alerts to export under current thresholds.', 'info');
        return;
      }
      const headers = ['date','type','detail','severity','triggeredBy','detectionMode','preset','thresholds_used','trigger_note'];
      downloadCSV('risk_flags_export.csv', headers, exportRows);
      showNotification(`Exported ${exportRows.length} alert${exportRows.length>1?'s':''} to CSV.`, 'success');
    }

    function downloadRateLeakageCSV() {
      const headers = ['vendor_id', 'vendor_name', 'service', 'contract_rate', 'avg_paid_rate', 'rate_variance_pct', 'leakage_amount'];
      const rows = [];
      
      const vendorLeakage = {};
      transactions.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        if (!rc) return;
        
        if (!vendorLeakage[t.vendor_id]) {
          vendorLeakage[t.vendor_id] = {
            vendor_id: t.vendor_id,
            vendor_name: rc.vendor_name,
            service: rc.service,
            contract_rate: parseFloat(rc.contract_rate),
            total_amount: 0,
            total_units: 0,
            leakage_amount: 0
          };
        }
        
        vendorLeakage[t.vendor_id].total_amount += parseFloat(t.amount);
        vendorLeakage[t.vendor_id].total_units += parseFloat(t.units);
        
        const unitRate = parseFloat(t.unit_rate);
        const contractRate = parseFloat(rc.contract_rate);
        if (unitRate > contractRate) {
          vendorLeakage[t.vendor_id].leakage_amount += (unitRate - contractRate) * parseFloat(t.units);
        }
      });
      
      Object.values(vendorLeakage).forEach(v => {
        const avgPaidRate = v.total_units > 0 ? v.total_amount / v.total_units : 0;
        const variancePct = v.contract_rate > 0 ? ((avgPaidRate - v.contract_rate) / v.contract_rate) * 100 : 0;
        rows.push({
          vendor_id: v.vendor_id,
          vendor_name: v.vendor_name,
          service: v.service,
          contract_rate: v.contract_rate.toFixed(2),
          avg_paid_rate: avgPaidRate.toFixed(2),
          rate_variance_pct: variancePct.toFixed(2),
          leakage_amount: v.leakage_amount.toFixed(2)
        });
      });
      
      downloadCSV('rate_leakage_summary.csv', headers, rows);
    }
    
    function downloadAccrualsCSV() {
      const headers = ['month', 'vendor_id', 'service', 'incurred_amount', 'invoiced_amount', 'accrual_amount', 'status', 'notes'];
      downloadCSV('accrual_schedule_export.csv', headers, accruals);
    }
    
    function downloadForecastCSV() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const headers = ['month', 'actual', compareMode === 'forecast' ? 'forecast' : 'budget', 'variance', 'variance_pct'];
      const rows = [];
      
      months.forEach(month => {
        const monthNum = months.indexOf(month) + 1;
        const monthTrans = transactions.filter(t => t.date.startsWith(`2025-${String(monthNum).padStart(2, '0')}`));
        const actual = monthTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        
        const monthForecast = forecastBudget.filter(f => f.month === month);
        const forecast = monthForecast.reduce((sum, f) => sum + parseFloat(f.forecast_amount), 0);
        const budget = monthForecast.reduce((sum, f) => sum + parseFloat(f.budget_amount), 0);
        const compare = compareMode === 'forecast' ? forecast : budget;
        const variance = actual - compare;
        const variancePct = compare > 0 ? (variance / compare) * 100 : 0;
        
        rows.push({
          month,
          actual: actual.toFixed(2),
          [compareMode === 'forecast' ? 'forecast' : 'budget']: compare.toFixed(2),
          variance: variance.toFixed(2),
          variance_pct: variancePct.toFixed(2)
        });
      });
      
      downloadCSV('forecast_vs_actual_export.csv', headers, rows);
    }
    
    // ========== TEMPLATE DOWNLOADS ==========
    
    // Template downloads handled by downloadFlatTemplate() above
    function downloadRateCardsTemplate()    { downloadFlatTemplate(); }
    function downloadTransactionsTemplate() { downloadFlatTemplate(); }
    function downloadAccrualsTemplate()     { downloadFlatTemplate(); }
    function downloadForecastTemplate()     { downloadFlatTemplate(); }
    
    function showNotification(message, type) {
      type = type || 'info';
      const existing = document.querySelector('.ops-notification');
      if (existing) existing.remove();
      const n = document.createElement('div');
      n.className = 'ops-notification';
      n.style.cssText = 'position:fixed;top:80px;right:32px;background:white;border:1px solid rgba(12,23,45,0.10);border-radius:14px;padding:14px 20px;box-shadow:0 10px 30px rgba(11,18,32,0.10);z-index:200;display:flex;align-items:center;gap:10px;min-width:300px;animation:slideIn 300ms ease;';
      const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
      const color = type === 'success' ? '#059669' : type === 'error' ? '#dc2626' : '#0f766e';
      n.innerHTML = `<div style="width:22px;height:22px;border-radius:50%;background:${color};color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;">${icon}</div><div style="font-size:14px;font-weight:500;">${message}</div>`;
      document.body.appendChild(n);
      setTimeout(() => { if (n.parentNode) n.remove(); }, 4000);
    }

    function updateDataModeBadge(mode) {
      const badge = document.getElementById('dataModeBadge');
      const s = document.getElementById('btnSampleMode');
      const r = document.getElementById('btnRandomMode');
      if (!badge) return;
      if (mode === 'sample') {
        badge.textContent = 'SAMPLE'; badge.classList.remove('random');
        if (s) { s.style.background = 'var(--text)'; s.style.color = 'white'; }
        if (r) { r.style.background = 'transparent'; r.style.color = 'var(--muted)'; }
      } else if (mode === 'random') {
        badge.textContent = 'RANDOM'; badge.classList.add('random');
        if (s) { s.style.background = 'transparent'; s.style.color = 'var(--muted)'; }
        if (r) { r.style.background = 'var(--text)'; r.style.color = 'white'; }
      } else {
        badge.textContent = 'CSV'; badge.classList.remove('random');
        if (s) { s.style.background = 'transparent'; s.style.color = 'var(--muted)'; }
        if (r) { r.style.background = 'transparent'; r.style.color = 'var(--muted)'; }
      }
    }

    // ========== CSV UPLOADS ==========
    
    // ========== FLAT CSV UPLOAD (single dataset) ==========

    // Required columns in the flat CSV
    const FLAT_CSV_REQUIRED = [
      'date','vendor_id','vendor_name','category','service','unit',
      'contract_rate','unit_rate','units','amount','cost_center',
      'invoice_id','po_id','accrual_amount','invoiced_amount',
      'forecast_amount','budget_amount'
    ];

    function handleFlatUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.toLowerCase().endsWith('.csv')) {
        showNotification('Please upload a .csv file.', 'error');
        event.target.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const missing = FLAT_CSV_REQUIRED.filter(h => !headers.includes(h));
          if (missing.length > 0) {
            const plural = missing.length === 1 ? 'column is' : 'columns are';
            showNotification(
              `Upload failed — ${missing.length} required ${plural} missing: ${missing.join(', ')}. Download the template to see the expected format.`,
              'error'
            );
            event.target.value = '';
            return;
          }
          if (data.length === 0) {
            showNotification('The file has headers but no data rows. Please check your file.', 'error');
            event.target.value = '';
            return;
          }
          deriveDatasetsFromFlat(data);
          dataMode = 'uploaded';
          updateDataModeBadge('csv');
          renderAll();
          showNotification('✓ Loaded ' + data.length + ' rows — all sections updated', 'success');
        } catch (err) {
          showNotification('Error reading file: ' + err.message, 'error');
        }
      };
      reader.onerror = () => {
        showNotification('Could not read the file. Please try again.', 'error');
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Derive the 4 internal arrays from one flat file
    function deriveDatasetsFromFlat(rows) {
      // 1. Transactions (one row per invoice line)
      transactions = rows.map(r => ({
        date:        r.date,
        vendor_id:   r.vendor_id,
        service:     r.service,
        units:       r.units,
        unit_rate:   r.unit_rate,
        amount:      r.amount,
        cost_center: r.cost_center,
        category:    r.category,
        invoice_id:  r.invoice_id,
        po_id:       r.po_id
      }));

      // 2. Rate cards — one entry per unique vendor_id+service, use first-seen contract_rate
      const rcMap = {};
      rows.forEach(r => {
        const key = r.vendor_id + '|' + r.service;
        if (!rcMap[key]) {
          rcMap[key] = {
            vendor_id:       r.vendor_id,
            vendor_name:     r.vendor_name,
            service:         r.service,
            unit:            r.unit,
            contract_rate:   r.contract_rate,
            currency:        'USD',
            effective_start: r.date,
            effective_end:   r.date,
            category:        r.category
          };
        }
      });
      rateCards = Object.values(rcMap);

      // 3. Accruals — aggregate per month+vendor_id
      const accrualMap = {};
      const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      rows.forEach(r => {
        const monthNum = parseInt(r.date.substring(5,7));
        const month = monthNames[monthNum - 1];
        const key = month + '|' + r.vendor_id;
        if (!accrualMap[key]) {
          accrualMap[key] = {
            month, vendor_id: r.vendor_id, service: r.service,
            incurred_amount: 0, invoiced_amount: 0, accrual_amount: 0, status: 'Closed', notes: ''
          };
        }
        accrualMap[key].incurred_amount += parseFloat(r.amount) || 0;
        accrualMap[key].invoiced_amount += parseFloat(r.invoiced_amount) || 0;
        accrualMap[key].accrual_amount  += parseFloat(r.accrual_amount)  || 0;
      });
      accruals = Object.values(accrualMap).map(a => {
        a.status = a.accrual_amount > 0 ? 'Open' : 'Closed';
        a.incurred_amount = a.incurred_amount.toFixed(2);
        a.invoiced_amount = a.invoiced_amount.toFixed(2);
        a.accrual_amount  = a.accrual_amount.toFixed(2);
        return a;
      });

      // 4. Forecast/Budget — aggregate per month+cost_center+category
      const fbMap = {};
      rows.forEach(r => {
        const monthNum = parseInt(r.date.substring(5,7));
        const month = monthNames[monthNum - 1];
        const key = month + '|' + r.cost_center + '|' + r.category;
        if (!fbMap[key]) {
          fbMap[key] = {
            month, cost_center: r.cost_center, category: r.category,
            forecast_amount: 0, budget_amount: 0
          };
        }
        fbMap[key].forecast_amount += parseFloat(r.forecast_amount) || 0;
        fbMap[key].budget_amount   += parseFloat(r.budget_amount)   || 0;
      });
      forecastBudget = Object.values(fbMap).map(f => {
        f.forecast_amount = f.forecast_amount.toFixed(2);
        f.budget_amount   = f.budget_amount.toFixed(2);
        return f;
      });
    }

    // ========== FLAT TEMPLATE DOWNLOAD ==========

    function downloadFlatTemplate() {
      const headers = FLAT_CSV_REQUIRED;
      const rows = [
        {
          date:'2025-01-15', vendor_id:'V001', vendor_name:'QuickShip Logistics',
          category:'Logistics', service:'Delivery', unit:'delivery',
          contract_rate:'15.00', unit_rate:'15.50', units:'50', amount:'775.00',
          cost_center:'CC100', invoice_id:'INV1001', po_id:'PO2001',
          accrual_amount:'200.00', invoiced_amount:'575.00',
          forecast_amount:'8000.00', budget_amount:'8200.00'
        },
        {
          date:'2025-01-20', vendor_id:'V002', vendor_name:'TechStaff Solutions',
          category:'Contractors', service:'Hourly', unit:'hour',
          contract_rate:'65.00', unit_rate:'68.00', units:'40', amount:'2720.00',
          cost_center:'CC101', invoice_id:'INV1002', po_id:'PO2002',
          accrual_amount:'0.00', invoiced_amount:'2720.00',
          forecast_amount:'12000.00', budget_amount:'11800.00'
        },
        {
          date:'2025-02-10', vendor_id:'V001', vendor_name:'QuickShip Logistics',
          category:'Logistics', service:'Delivery', unit:'delivery',
          contract_rate:'15.00', unit_rate:'15.00', units:'60', amount:'900.00',
          cost_center:'CC100', invoice_id:'INV1003', po_id:'PO2003',
          accrual_amount:'0.00', invoiced_amount:'900.00',
          forecast_amount:'8000.00', budget_amount:'8200.00'
        }
      ];
      downloadCSV('ops_spend_template.csv', headers, rows);
      showNotification('✓ Template downloaded — fill it in and upload above', 'success');
    }

    // ========== EXPORT CURRENT DATASET ==========

    function exportDatasetCSV() {
      // Export flat representation of current transactions enriched with rate card + accrual + forecast data
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const headers = FLAT_CSV_REQUIRED;
      const rows = transactions.map(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service) || {};
        const monthNum = parseInt(t.date.substring(5,7));
        const month = months[monthNum - 1];
        const acc = accruals.find(a => a.month === month && a.vendor_id === t.vendor_id) || {};
        const fb  = forecastBudget.find(f => f.month === month && f.cost_center === t.cost_center && f.category === t.category) || {};
        return {
          date:             t.date,
          vendor_id:        t.vendor_id,
          vendor_name:      rc.vendor_name || t.vendor_id,
          category:         t.category,
          service:          t.service,
          unit:             rc.unit || '',
          contract_rate:    rc.contract_rate || '',
          unit_rate:        t.unit_rate,
          units:            t.units,
          amount:           t.amount,
          cost_center:      t.cost_center,
          invoice_id:       t.invoice_id,
          po_id:            t.po_id,
          accrual_amount:   acc.accrual_amount  || '0.00',
          invoiced_amount:  acc.invoiced_amount || t.amount,
          forecast_amount:  fb.forecast_amount  || '0.00',
          budget_amount:    fb.budget_amount    || '0.00'
        };
      });
      downloadCSV('ops_spend_export.csv', headers, rows);
      showNotification('✓ CSV exported (' + rows.length + ' rows)', 'success');
    }

    function exportDatasetXLSX() {
      // Build XLSX in-browser using SheetJS (loaded from CDN)
      if (typeof XLSX === 'undefined') {
        // Load SheetJS dynamically
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        s.onload = () => _doXLSXExport();
        s.onerror = () => showNotification('Could not load XLSX library. Try CSV export instead.', 'error');
        document.head.appendChild(s);
      } else {
        _doXLSXExport();
      }
    }

    function _doXLSXExport() {
      try {
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const wb = XLSX.utils.book_new();

        // ── Sheet 1: All Transactions (flat, same format as upload template) ──
        const txRows = transactions.map(t => {
          const rc  = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service) || {};
          const mN  = parseInt(t.date.substring(5,7));
          const mon = months[mN - 1];
          const acc = accruals.find(a => a.month === mon && a.vendor_id === t.vendor_id) || {};
          const fb  = forecastBudget.find(f => f.month === mon && f.cost_center === t.cost_center && f.category === t.category) || {};
          return {
            Date: t.date, Vendor_ID: t.vendor_id, Vendor_Name: rc.vendor_name || t.vendor_id,
            Category: t.category, Service: t.service, Unit: rc.unit || '',
            Contract_Rate: parseFloat(rc.contract_rate) || 0,
            Unit_Rate: parseFloat(t.unit_rate), Units: parseFloat(t.units),
            Amount: parseFloat(t.amount), Cost_Center: t.cost_center,
            Invoice_ID: t.invoice_id, PO_ID: t.po_id,
            Accrual_Amount: parseFloat(acc.accrual_amount) || 0,
            Invoiced_Amount: parseFloat(acc.invoiced_amount) || parseFloat(t.amount),
            Forecast_Amount: parseFloat(fb.forecast_amount) || 0,
            Budget_Amount: parseFloat(fb.budget_amount) || 0
          };
        });
        const ws1 = XLSX.utils.json_to_sheet(txRows);
        ws1['!cols'] = [{wch:12},{wch:10},{wch:24},{wch:14},{wch:14},{wch:10},
                        {wch:14},{wch:10},{wch:8},{wch:12},{wch:12},{wch:12},{wch:10},
                        {wch:14},{wch:15},{wch:15},{wch:14}];
        XLSX.utils.book_append_sheet(wb, ws1, 'Transactions');

        // ── Sheet 2: Accrual Summary by Month ──
        const accrualRows = months.map(month => {
          const monthAccruals = accruals.filter(a => a.month === month);
          const mN = months.indexOf(month) + 1;
          const mTx = transactions.filter(t => t.date.startsWith(`2025-${String(mN).padStart(2,'0')}`));
          const invoiceCount = new Set(mTx.map(t => t.invoice_id).filter(Boolean)).size;
          const incurred  = monthAccruals.reduce((s,a) => s + parseFloat(a.incurred_amount), 0);
          const invoiced  = monthAccruals.reduce((s,a) => s + parseFloat(a.invoiced_amount), 0);
          const accrual   = monthAccruals.reduce((s,a) => s + parseFloat(a.accrual_amount),  0);
          return {
            Month: month,
            Invoice_Count: invoiceCount,
            Incurred_Amount: incurred,
            Invoiced_Amount: invoiced,
            Accrual_Amount: accrual,
            Status: accrual > 0 ? 'Open' : 'Closed'
          };
        });
        const ws2 = XLSX.utils.json_to_sheet(accrualRows);
        ws2['!cols'] = [{wch:8},{wch:14},{wch:16},{wch:16},{wch:15},{wch:8}];
        XLSX.utils.book_append_sheet(wb, ws2, 'Accrual Summary');

        // ── Sheet 3: Forecast vs Actual by Month ──
        const fvRows = months.map(month => {
          const mN = months.indexOf(month) + 1;
          const mTx = transactions.filter(t => t.date.startsWith(`2025-${String(mN).padStart(2,'0')}`));
          const actual   = mTx.reduce((s,t) => s + parseFloat(t.amount), 0);
          const mFB      = forecastBudget.filter(f => f.month === month);
          const forecast = mFB.reduce((s,f) => s + parseFloat(f.forecast_amount), 0);
          const budget   = mFB.reduce((s,f) => s + parseFloat(f.budget_amount),   0);
          return {
            Month: month,
            Actual: actual,
            Forecast: forecast,
            Budget: budget,
            Variance_vs_Forecast: actual - forecast,
            Variance_Pct: forecast > 0 ? ((actual - forecast) / forecast * 100).toFixed(1) + '%' : 'N/A'
          };
        });
        const ws3 = XLSX.utils.json_to_sheet(fvRows);
        ws3['!cols'] = [{wch:8},{wch:12},{wch:12},{wch:12},{wch:20},{wch:16}];
        XLSX.utils.book_append_sheet(wb, ws3, 'Forecast vs Actual');

        // ── Sheet 4: Rate Leakage Summary ──
        const leakMap = {};
        transactions.forEach(t => {
          const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
          if (!rc) return;
          const key = t.vendor_id;
          if (!leakMap[key]) leakMap[key] = { vendor_id: t.vendor_id, vendor_name: rc.vendor_name, service: rc.service, contract_rate: parseFloat(rc.contract_rate), total_amount: 0, total_units: 0, leakage_amount: 0 };
          leakMap[key].total_amount += parseFloat(t.amount);
          leakMap[key].total_units  += parseFloat(t.units);
          if (parseFloat(t.unit_rate) > parseFloat(rc.contract_rate)) {
            leakMap[key].leakage_amount += (parseFloat(t.unit_rate) - parseFloat(rc.contract_rate)) * parseFloat(t.units);
          }
        });
        const leakRows = Object.values(leakMap).map(v => {
          const avg = v.total_units > 0 ? v.total_amount / v.total_units : 0;
          return {
            Vendor_ID: v.vendor_id, Vendor_Name: v.vendor_name, Service: v.service,
            Contract_Rate: v.contract_rate,
            Avg_Paid_Rate: parseFloat(avg.toFixed(2)),
            Variance_Pct: v.contract_rate > 0 ? parseFloat(((avg - v.contract_rate)/v.contract_rate*100).toFixed(2)) : 0,
            Leakage_Amount: parseFloat(v.leakage_amount.toFixed(2))
          };
        }).sort((a,b) => b.Leakage_Amount - a.Leakage_Amount);
        const ws4 = XLSX.utils.json_to_sheet(leakRows);
        ws4['!cols'] = [{wch:10},{wch:24},{wch:14},{wch:14},{wch:14},{wch:14},{wch:16}];
        XLSX.utils.book_append_sheet(wb, ws4, 'Rate Leakage');

        XLSX.writeFile(wb, 'ops_spend_analytics.xlsx');
        showNotification('✓ Excel exported — 4 sheets: Transactions, Accruals, Forecast, Leakage', 'success');
      } catch(err) {
        showNotification('Export failed: ' + err.message, 'error');
      }
    }

    // Keep old individual CSV export functions (used by section export buttons)
    function downloadAllTemplates() { downloadFlatTemplate(); }
    
    // ========== DECISION BOX (SPEND) ==========

    function renderSpendDecisionBox() {
      const fallback = document.getElementById('spendDecisionFallback');
      const content  = document.getElementById('spendDecisionContent');

      // Need data
      if (!transactions.length && !rateCards.length) {
        fallback.style.display = '';
        content.style.display  = 'none';
        return;
      }

      // --- Compute leakage from transactions vs rate cards ---
      const vendorLeakageMap = {};
      let totalLeakageDollar = 0;
      let totalLeakageRows   = 0;
      let totalSpend         = 0;

      transactions.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        totalSpend += parseFloat(t.amount);
        if (!rc) return;
        const unitRate     = parseFloat(t.unit_rate);
        const contractRate = parseFloat(rc.contract_rate);
        if (unitRate > contractRate) {
          const overpay = (unitRate - contractRate) * parseFloat(t.units);
          totalLeakageDollar += overpay;
          totalLeakageRows++;
          if (!vendorLeakageMap[t.vendor_id]) {
            vendorLeakageMap[t.vendor_id] = {
              label: rc.vendor_name,
              rows: 0,
              amount: 0
            };
          }
          vendorLeakageMap[t.vendor_id].rows   += 1;
          vendorLeakageMap[t.vendor_id].amount += overpay;
        }
      });

      // --- Compute forecast overrun risk ---
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      let overrunCount = 0;
      months.forEach(month => {
        const monthNum = months.indexOf(month) + 1;
        const monthTrans = transactions.filter(t =>
          t.date.startsWith(`2025-${String(monthNum).padStart(2,'0')}`)
        );
        const actual = monthTrans.reduce((s, t) => s + parseFloat(t.amount), 0);
        const fb = forecastBudget.filter(f => f.month === month);
        const forecast = fb.reduce((s, f) => s + parseFloat(f.forecast_amount), 0);
        if (forecast > 0 && (actual - forecast) / forecast > 0.10) overrunCount++;
      });

      const leakagePct   = totalSpend > 0 ? (totalLeakageDollar / totalSpend) * 100 : 0;
      const hasLeakage   = totalLeakageDollar > 0;
      const overrunRisk  = overrunCount >= 3; // 3+ months over = high risk

      // --- Decision logic ---
      let verdict;
      if (hasLeakage && leakagePct > 1) {
        verdict = 'Fix leakage first';
      } else if (overrunRisk) {
        verdict = 'Freeze spend';
      } else {
        verdict = 'Approve spend';
      }

      // --- Top 3 exceptions ---
      // Build exception list: rate card mismatches, overrun months, open accruals
      const exceptions = [];

      // 1. Rate card mismatches (from leakage)
      const leakageSorted = Object.values(vendorLeakageMap).sort((a, b) => b.amount - a.amount);
      if (leakageSorted.length > 0) {
        const top = leakageSorted[0];
        exceptions.push({
          label:  'Rate card mismatch',
          count:  totalLeakageRows,
          action: `Renegotiate or enforce PO controls`
        });
      }

      // 2. Spend spikes: categories with >20% above avg
      const catSpend = {};
      transactions.forEach(t => {
        const monthNum = parseInt(t.date.substring(5,7));
        const m = months[monthNum - 1];
        const key = t.category;
        if (!catSpend[key]) catSpend[key] = { total: 0, count: 0 };
        catSpend[key].total += parseFloat(t.amount);
        catSpend[key].count += 1;
      });
      // Count month-category pairs that spike
      const spikeCount = Object.values(catSpend).filter(c => {
        // rough heuristic: high variance
        return c.count > 5;
      }).length;
      if (overrunCount > 0) {
        exceptions.push({
          label:  'Unapproved spend spike',
          count:  overrunCount,
          action: `Investigate & update forecast`
        });
      }

      // 3. Open accruals
      const openAccruals = accruals.filter(a => a.status === 'Open' || parseFloat(a.accrual_amount) > 0);
      if (openAccruals.length > 0) {
        exceptions.push({
          label:  'Open accruals (not invoiced)',
          count:  openAccruals.length,
          action: `Follow up with vendors on invoice timing`
        });
      }

      // Limit to max 3
      const topExceptions = exceptions.slice(0, 3);

      // --- Render ---
      fallback.style.display = 'none';
      content.style.display  = '';

      // Apply color state
      const box = document.getElementById('spendDecisionBox');
      box.classList.remove('decision-box--positive', 'decision-box--caution', 'decision-box--negative');
      if (verdict === 'Fix leakage first') {
        box.classList.add('decision-box--negative');
      } else if (verdict === 'Freeze spend') {
        box.classList.add('decision-box--caution');
      } else {
        box.classList.add('decision-box--positive');
      }

      document.getElementById('spendDecisionVerdict').innerHTML =
        `Decision: <span class="verdict-action">${verdict}</span>`;

      // Plain-English one-liner summary
      const summaryEl = document.getElementById('spendDecisionSummary');
      if (summaryEl) {
        const highAlerts = _riskAlertCounts.high;
        const openAcc    = accruals.filter(a => a.status === 'Open' || parseFloat(a.accrual_amount) > 0).length;
        const parts = [];
        if (totalLeakageDollar > 0) parts.push(`<strong>${formatCurrency(totalLeakageDollar)}</strong> in rate leakage`);
        if (overrunCount > 0)       parts.push(`<strong>${overrunCount} month${overrunCount > 1 ? 's' : ''}</strong> over forecast`);
        if (openAcc > 0)            parts.push(`<strong>${openAcc}</strong> open accrual${openAcc > 1 ? 's' : ''}`);
        if (highAlerts > 0)         parts.push(`<strong>${highAlerts} high-severity</strong> risk flag${highAlerts > 1 ? 's' : ''}`);
        summaryEl.innerHTML = parts.length > 0
          ? parts.join(' · ') + ' require your attention.'
          : 'No critical issues detected — spend is within normal parameters.';
      }

      // Anchors
      const exceptionAnchors = {
        'Rate card mismatch':           { href: '#section-rate-leakage', label: '↓ Section 1' },
        'Open accruals (not invoiced)': { href: '#section-accruals',     label: '↓ Section 2' },
        'Unapproved spend spike':       { href: '#section-forecast',     label: '↓ Section 3' },
      };

      // Fixed row order: §1 Rate, §2 Accruals, §3 Spike
      const FIXED_ROWS = [
        { label: 'Rate card mismatch',           unit: 'transactions', action: 'Renegotiate or enforce PO controls' },
        { label: 'Open accruals (not invoiced)',  unit: 'records',      action: 'Follow up with vendors on invoice timing' },
        { label: 'Unapproved spend spike',        unit: 'months',       action: 'Investigate & update forecast' },
      ];

      // Build lookup
      const exMap = {};
      topExceptions.forEach(ex => { exMap[ex.label] = ex; });

      let exceptionsHTML = `
        <div class="exception-row exception-row-header">
          <span>Exception</span>
          <span>Flagged</span>
          <span>Action</span>
        </div>
      `;

      FIXED_ROWS.forEach(row => {
        const ex      = exMap[row.label];
        const anchor  = exceptionAnchors[row.label];
        const hasData = ex && ex.count > 0;

        if (hasData) {
          const countLabel = `${ex.count} <span style="font-size:10px;font-weight:500;color:var(--muted);">${row.unit}</span>`;
          const labelHTML = anchor
            ? `<a href="${anchor.href}" onclick="scrollToSection(event,'${anchor.href}')" style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:6px;cursor:pointer;">
                ${row.label}
                <span style="font-size:11px;font-weight:600;padding:2px 7px;border-radius:999px;background:rgba(12,23,45,0.07);color:var(--muted);flex-shrink:0;">${anchor.label}</span>
               </a>`
            : row.label;
          exceptionsHTML += `
            <div class="exception-row" style="cursor:pointer;" ${anchor ? `onclick="scrollToSection(event,'${anchor.href}')"` : ''}>
              <span class="exception-label">${labelHTML}</span>
              <span class="exception-count">${countLabel}</span>
              <span class="exception-action">${row.action}</span>
            </div>
          `;
        } else {
          const labelHTML = anchor
            ? `<span style="display:flex;align-items:center;gap:6px;">
                ${row.label}
                <span style="font-size:11px;font-weight:600;padding:2px 7px;border-radius:999px;background:rgba(12,23,45,0.05);color:var(--muted);flex-shrink:0;">${anchor.label}</span>
               </span>`
            : row.label;
          exceptionsHTML += `
            <div class="exception-row" style="opacity:0.42;pointer-events:none;">
              <span class="exception-label" style="color:var(--muted);">${labelHTML}</span>
              <span class="exception-count" style="color:var(--muted);">n/a</span>
              <span class="exception-action" style="color:var(--muted);">—</span>
            </div>
          `;
        }
      });

      // Section 4 row — Risk & Anomaly metric
      const rc = _riskAlertCounts;
      const hasRisk = rc.total > 0;
      const riskCountHTML = hasRisk
        ? `<span style="font-size:12px;font-weight:700;color:var(--text);">${rc.total} total</span>`
          + (rc.high ? `&nbsp;<span style="font-size:11px;font-weight:700;padding:1px 7px;border-radius:999px;background:rgba(220,38,38,0.12);color:#dc2626;">${rc.high} High</span>` : '')
          + (rc.med  ? `&nbsp;<span style="font-size:11px;font-weight:700;padding:1px 7px;border-radius:999px;background:rgba(245,158,11,0.12);color:#d97706;">${rc.med} Med</span>`  : '')
          + (rc.low  ? `&nbsp;<span style="font-size:11px;font-weight:700;padding:1px 7px;border-radius:999px;background:rgba(107,114,128,0.12);color:#6b7280;">${rc.low} Low</span>`  : '')
        : `<span style="color:var(--muted);font-size:11px;">—</span>`;

      exceptionsHTML += `
        <div class="exception-row" style="cursor:pointer;background:rgba(246,248,251,0.6);" onclick="scrollToSection(event,'#section-risk')">
          <span class="exception-label">
            <a href="#section-risk" onclick="scrollToSection(event,'#section-risk')" style="color:inherit;text-decoration:none;display:flex;align-items:center;gap:6px;cursor:pointer;">
              ⚑ Risk &amp; Anomaly Flags
              <span style="font-size:11px;font-weight:600;padding:2px 7px;border-radius:999px;background:rgba(12,23,45,0.07);color:var(--muted);flex-shrink:0;">↓ Section 4</span>
            </a>
          </span>
          <span style="display:flex;align-items:center;gap:4px;flex-wrap:nowrap;">${riskCountHTML}</span>
          <span class="exception-action" style="${hasRisk ? '' : 'color:var(--muted);'}">Review flagged issues</span>
        </div>
      `;

      document.getElementById('spendDecisionExceptions').innerHTML = exceptionsHTML;
    }

    // ========== SCROLL TO SECTION ==========

    function toggleAccrualRow(rowId, chevronId) {
      const row = document.getElementById(rowId);
      const chevron = document.getElementById(chevronId);
      if (!row) return;
      const isVisible = row.style.display !== 'none';
      row.style.display = isVisible ? 'none' : 'table-row';
      if (chevron) chevron.textContent = isVisible ? '▶' : '▼';
    }

    function scrollToSection(event, href) {
      event.preventDefault();
      const target = document.querySelector(href);
      if (!target) return;
      const offset = 80; // account for sticky nav
      const top = target.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top, behavior: 'smooth' });
      // Briefly highlight the section heading
      const heading = target.querySelector('h2');
      if (heading) {
        heading.style.transition = 'color 300ms ease';
        heading.style.color = 'var(--accent)';
        setTimeout(() => { heading.style.color = ''; }, 1800);
      }
    }

    // ========== PLAYBOOK TOGGLE ==========
    function togglePlaybook() {
      var body = document.getElementById('playbookBody');
      var btn  = document.getElementById('playbookToggleBtn');
      var chev = document.getElementById('playbookChevron');
      if (!body) return;
      var isOpen = body.style.display !== 'none';
      if (isOpen) {
        body.style.display = 'none';
        btn.setAttribute('aria-expanded', 'false');
        chev.style.transform = 'rotate(180deg)';
        var hint = btn.querySelector('.playbook-hint');
        if (hint) hint.textContent = 'Click to expand';
      } else {
        body.style.display = '';
        btn.setAttribute('aria-expanded', 'true');
        chev.style.transform = '';
        var hint = btn.querySelector('.playbook-hint');
        if (hint) hint.textContent = 'Click to collapse';
      }
    }

    // ========== RENDER ALL ==========
    
    // ========== FORECAST CONFIDENCE ==========
    function computeForecastConfidence() {
      // Guard — no data yet
      if (!accruals || accruals.length === 0) return;

      // ── 1. Dollar-weighted confidence from accrual records ──────────────────
      // High  = portion of total incurred that is already fully invoiced
      // Medium = portion incurred but not yet invoiced (open accrual gap)
      // Low   = estimated from forecastBudget rows that have NO matching transactions at all

      let totalIncurred  = 0;
      let totalInvoiced  = 0;
      let totalAccrual   = 0;

      accruals.forEach(a => {
        const inc = parseFloat(a.incurred_amount) || 0;
        const inv = parseFloat(a.invoiced_amount) || 0;
        const acc = parseFloat(a.accrual_amount)  || 0;
        totalIncurred += inc;
        totalInvoiced += inv;
        totalAccrual  += acc;
      });

      // ── 2. Low confidence: forecast $ with zero transactional backing ───────
      // Proxy: forecastBudget rows where matching category-month has no transactions
      const coveredKeys = new Set();
      transactions.forEach(t => {
        const mn = parseInt((t.date || '').substring(5, 7)) || 0;
        const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        if (mn >= 1 && mn <= 12) coveredKeys.add(`${t.category}-${months[mn-1]}`);
      });

      let totalForecast = 0;
      let forecastLow   = 0;
      forecastBudget.forEach(fb => {
        const amt = parseFloat(fb.forecast_amount) || 0;
        totalForecast += amt;
        const key = `${fb.category}-${fb.month}`;
        if (!coveredKeys.has(key)) forecastLow += amt;
      });

      // ── 3. Build confidence proportions (dollar-weighted) ───────────────────
      // We blend the two datasets: incurred spend + forecast-only spend
      const grandTotal = totalIncurred + forecastLow;

      let highAmt   = grandTotal > 0 ? totalInvoiced : 0;
      let mediumAmt = grandTotal > 0 ? totalAccrual  : 0;
      let lowAmt    = grandTotal > 0 ? forecastLow   : 0;

      // If grandTotal is 0, show equal thirds as placeholder
      const safeTotal = highAmt + mediumAmt + lowAmt || 1;
      const highPct   = (highAmt   / safeTotal) * 100;
      const mediumPct = (mediumAmt / safeTotal) * 100;
      const lowPct    = (lowAmt    / safeTotal) * 100;

      // ── 4. Overall rating ────────────────────────────────────────────────────
      let overallRating, overallLabel, overallClass;
      if (highPct >= 75) {
        overallRating = 'high';   overallLabel = 'High Confidence';
      } else if (highPct >= 50 || (highPct >= 40 && lowPct < 15)) {
        overallRating = 'medium'; overallLabel = 'Medium Confidence';
      } else {
        overallRating = 'low';    overallLabel = 'Low Confidence';
      }

      // ── 5. Update DOM ────────────────────────────────────────────────────────
      const pill = document.getElementById('confOverallPill');
      if (pill) {
        pill.textContent  = overallLabel;
        pill.className    = `conf-summary-pill ${overallRating}`;
      }

      const segH = document.getElementById('confSegHigh');
      const segM = document.getElementById('confSegMedium');
      const segL = document.getElementById('confSegLow');
      if (segH) segH.style.width = highPct.toFixed(1) + '%';
      if (segM) segM.style.width = mediumPct.toFixed(1) + '%';
      if (segL) segL.style.width = lowPct.toFixed(1) + '%';

      const pH = document.getElementById('confPctHigh');
      const pM = document.getElementById('confPctMedium');
      const pL = document.getElementById('confPctLow');
      if (pH) pH.textContent = Math.round(highPct)   + '%';
      if (pM) pM.textContent = Math.round(mediumPct) + '%';
      if (pL) pL.textContent = Math.round(lowPct)    + '%';

      // ── 6. Narrative sentence ────────────────────────────────────────────────
      const narrative = document.getElementById('confNarrative');
      if (narrative) {
        narrative.style.display = '';
        const invoicedFmt  = '$' + Math.round(totalInvoiced).toLocaleString();
        const accrualFmt   = '$' + Math.round(totalAccrual).toLocaleString();
        const lowFmt       = '$' + Math.round(forecastLow).toLocaleString();
        const totalRawSpend = transactions.reduce((s, t) => s + (parseFloat(t.amount) || 0), 0);
        const rawFmt        = '$' + Math.round(totalRawSpend).toLocaleString();

        // Line 1: confidence status — what the tiers mean for close readiness
        let statusLine = '';
        if (overallRating === 'high') {
          statusLine = `${Math.round(highPct)}% of spend (${invoicedFmt}) is confirmed by matched invoices.`;
          if (mediumPct > 0) statusLine += ` The remaining ${Math.round(mediumPct)}% (${accrualFmt}) is incurred but not yet invoiced — AP should chase these before close.`;
        } else if (overallRating === 'medium') {
          statusLine = `${Math.round(mediumPct)}% of incurred spend (${accrualFmt}) has no invoice yet — these are open accruals. AP needs to resolve them before period close or document in close commentary.`;
        } else {
          statusLine = `${Math.round(lowPct)}% of forecast spend (${lowFmt}) has no transactional backing — Finance is on estimates. Chase owners for confirmed inputs before locking the baseline.`;
        }

        // Line 2: explain why confidence total may differ from Section 1, using live numbers
        const reconciledTotal = totalInvoiced + totalAccrual;
        const reconciledFmt   = '$' + Math.round(reconciledTotal).toLocaleString();
        let sourceLine = `This bar reads the invoiced_amount and accrual_amount columns from the same CSV. Section 1 shows ${rawFmt} (raw amount column — everything vendors billed). This bar covers ${reconciledFmt} (the reconciled split). Both come from the same file.`;

        narrative.textContent = statusLine + ' — ' + sourceLine;
      }
    }

    function renderAll() {
      populateRateFilters();
      renderRateLeakage();
      renderAccruals();
      renderForecastVsActual();
      computeRiskFlags();
      renderSpendDecisionBox();
      computeForecastConfidence();
    }
    
    // ========== INIT ==========
    
    window.addEventListener('DOMContentLoaded', () => {
      initializeSampleData();
      renderAll();
    });
  
    /* ── Sidebar accordion: one section open at a time ── */
    function sidebarAccordion(headerEl) {
      var sidebar = headerEl.closest('.sidebar');
      var allHeaders = sidebar.querySelectorAll('.sb-acc-header');
      allHeaders.forEach(function(h) {
        if (h === headerEl) return;
        h.classList.remove('open');
        var b = h.nextElementSibling;
        if (b && b.classList.contains('sb-acc-body')) b.classList.remove('open');
      });
      headerEl.classList.toggle('open');
      var body = headerEl.nextElementSibling;
      if (body && body.classList.contains('sb-acc-body')) body.classList.toggle('open');
    }


    /* Mobile sidebar toggle */
    (function() {
      var btn = document.getElementById('mobileControlsBtn');
      var sb  = document.querySelector('.sidebar');
      if (!btn || !sb) return;
      btn.addEventListener('click', function() {
        var open = sb.classList.toggle('mobile-open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    })();


    /* ── Body-level tooltip engine ── */
    function initTooltips() {
      var ttEl = document.getElementById('tt-root');
      if (!ttEl) {
        ttEl = document.createElement('div');
        ttEl.id = 'tt-root';
        document.body.appendChild(ttEl);
      }

      var hideTimer = null;
      var activeEl = null;

      function show(text, targetEl) {
        clearTimeout(hideTimer);
        activeEl = targetEl;
        ttEl.textContent = text;
        ttEl.classList.add('tt-visible');
        position(targetEl);
      }

      function hide() {
        hideTimer = setTimeout(function() {
          ttEl.classList.remove('tt-visible');
          activeEl = null;
        }, 80);
      }

      function position(el) {
        var rect = el.getBoundingClientRect();
        var ttW = 270;
        var gap = 8;
        var left = rect.left + rect.width / 2 - ttW / 2;
        left = Math.max(12, Math.min(left, window.innerWidth - ttW - 12));
        ttEl.style.width = ttW + 'px';
        ttEl.style.left = left + 'px';
        ttEl.style.position = 'fixed';
        ttEl.style.transform = 'none';
        var ttH = ttEl.offsetHeight || 60;
        var top;
        if (rect.top - ttH - gap - 8 < 0) {
          top = rect.bottom + gap;
        } else {
          top = rect.top - ttH - gap;
        }
        ttEl.style.top = top + 'px';
      }

      /* Kill CSS ::after tooltips */
      var killStyle = document.createElement('style');
      killStyle.textContent = '.help-icon::after,.help-icon:hover::after,[data-help]::after,[data-tt]::after,.term-helper::after,.term-helper:hover::after{content:none!important;display:none!important;}';
      document.head.appendChild(killStyle);

      /* Desktop: mouse events */
      document.addEventListener('mouseover', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (!el) return;
        var text = el.getAttribute('data-help') || el.getAttribute('data-tt');
        if (text && text !== 'Loading...') show(text, el);
      });

      document.addEventListener('mouseout', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (el) hide();
      });

      /* Mobile: tap to toggle */
      document.addEventListener('click', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (!el) {
          if (ttEl.classList.contains('tt-visible')) {
            ttEl.classList.remove('tt-visible');
            activeEl = null;
          }
          return;
        }
        var text = el.getAttribute('data-help') || el.getAttribute('data-tt');
        if (!text || text === 'Loading...') return;
        if (activeEl === el && ttEl.classList.contains('tt-visible')) {
          ttEl.classList.remove('tt-visible');
          activeEl = null;
        } else {
          show(text, el);
        }
        e.stopPropagation();
      });

      /* Reposition on scroll */
      window.addEventListener('scroll', function() {
        if (activeEl && ttEl.classList.contains('tt-visible')) position(activeEl);
      }, { passive: true });

      /* Hide on resize */
      window.addEventListener('resize', function() {
        ttEl.classList.remove('tt-visible');
        activeEl = null;
      }, { passive: true });
    }

    // ── Initialize tooltip engine ──
    document.addEventListener('DOMContentLoaded', function() { initTooltips(); });

    // ════════════════════════════════════════════════════════════
    //  PLAN BUILDER GUIDE PANEL
    // ════════════════════════════════════════════════════════════
    const PB_GUIDE_STEPS = 5;
    let pbGuideDone = [false, false, false, false, false]; // always resets fresh on page load
    let pbGuideOpen = false;

    // NOTE: pbGuideLoad / pbGuideSave intentionally do NOT persist guide step state.
    // The guide resets to all-pending every time the page opens — so it always feels
    // like a live walkthrough, not a checklist with old checkmarks.
    function pbGuideLoad() {
      // intentionally blank — fresh start every session
    }

    function pbGuideSave() {
      // intentionally blank — guide steps are session-only
    }

    function pbGuideToggle() {
      pbGuideOpen = !pbGuideOpen;
      const panel = document.getElementById('pbGuidePanel');
      panel.classList.toggle('open', pbGuideOpen);
      pbGuideRender();
    }

    function pbGuideMarkDone(step) {
      pbGuideDone[step - 1] = true;
      pbGuideSave();
      pbGuideRender();
    }

    function pbGuideStepClick(step) {
      // Mark as active/focused — no-op UI feedback
      pbGuideRender(step);
    }

    function pbGuideRender(activeStep) {
      const doneCount = pbGuideDone.filter(Boolean).length;

      for (let i = 1; i <= PB_GUIDE_STEPS; i++) {
        const done    = pbGuideDone[i - 1];
        const active  = (activeStep === i);
        const stepEl  = document.getElementById('pbGS' + i);
        const numEl   = document.getElementById('pbGN' + i);
        const tickEl  = document.getElementById('pbGT' + i);
        if (!stepEl) continue;

        stepEl.classList.toggle('done', done);
        stepEl.classList.toggle('active', active);
        numEl.className = 'pb-guide-num ' + (done ? 'done' : active ? 'active' : 'pending');
        numEl.textContent = done ? '✓' : String(i);
        tickEl.style.display = done ? '' : 'none';
      }

      // Progress bar
      const pct = Math.round((doneCount / PB_GUIDE_STEPS) * 100);
      const fill = document.getElementById('pbGuideProgressFill');
      const txt  = document.getElementById('pbGuideProgressText');
      if (fill) fill.style.width = pct + '%';
      if (txt)  txt.textContent  = doneCount + ' / ' + PB_GUIDE_STEPS + ' steps';

      // Badge
      const badge = document.getElementById('pbGuideBadge');
      const remaining = PB_GUIDE_STEPS - doneCount;
      if (badge) {
        badge.textContent = remaining;
        badge.style.display = remaining > 0 ? '' : 'none';
      }
    }

    // Auto-detect step completion from Plan Builder actions
    // Hook into pbToggleChanged, pbBuildPlan, pbLockBudget
    const _origPbToggleChanged = typeof pbToggleChanged === 'function' ? pbToggleChanged : null;

    document.addEventListener('DOMContentLoaded', function() {
      pbGuideLoad();
      pbGuideRender();

      // Patch pbToggleChanged to auto-mark step 1
      const origToggle = window.pbToggleChanged;
      window.pbToggleChanged = function() {
        if (origToggle) origToggle();
        if (document.getElementById('pbToggle') && document.getElementById('pbToggle').checked) {
          pbGuideMarkDone(1);
        }
      };

      // Patch pbBuildPlan to auto-mark step 4
      const origBuild = window.pbBuildPlan;
      window.pbBuildPlan = function() {
        if (origBuild) origBuild();
        pbGuideMarkDone(4);
      };

      // Patch pbLockBudget to auto-mark step 5
      const origLock = window.pbLockBudget;
      window.pbLockBudget = function() {
        if (origLock) origLock();
        pbGuideMarkDone(5);
      };

      // Patch pbApproveToCommit to auto-mark step 3
      const origApprove = window.pbApproveToCommit;
      window.pbApproveToCommit = function(id) {
        if (origApprove) origApprove(id);
        pbGuideMarkDone(3);
      };

      // Patch pbSaveIntake to auto-mark step 2 on first save
      const origSaveIntake = window.pbSaveIntake;
      window.pbSaveIntake = function() {
        if (origSaveIntake) origSaveIntake();
        pbGuideMarkDone(2);
      };
    });



    // ════════════════════════════════════════════════════════════
    //  PLAN BUILDER: Intake → Commitments → Forecast
    // ════════════════════════════════════════════════════════════

    // ── State ──
    let pbEnabled       = false;
    let pbIntake        = [];   // { id, campaign, owner, category, costCenter, amount, startMonth, endMonth, status }
    let pbCommitments   = [];   // { id, linkedRequest, vendor, category, costCenter, amount, startMonth, endMonth, status, phasing }
    let pbBudgetBaseline = {};  // { "month|costCenter|category": amount }
    let pbBudgetLocked   = false;

    const PB_MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    // ── localStorage helpers ──
    function savePlanBuilderToStorage() {
      try {
        localStorage.setItem('planBuilderEnabled',    JSON.stringify(pbEnabled));
        localStorage.setItem('planIntake',            JSON.stringify(pbIntake));
        localStorage.setItem('planCommitments',       JSON.stringify(pbCommitments));
        localStorage.setItem('planBudgetBaseline',    JSON.stringify(pbBudgetBaseline));
        localStorage.setItem('planBudgetLocked',      JSON.stringify(pbBudgetLocked));
      } catch(e) { /* storage full / private mode */ }
    }

    function loadPlanBuilderFromStorage() {
      try {
        const en = localStorage.getItem('planBuilderEnabled');
        const pi = localStorage.getItem('planIntake');
        const pc = localStorage.getItem('planCommitments');
        const pb = localStorage.getItem('planBudgetBaseline');
        const pl = localStorage.getItem('planBudgetLocked');
        if (en !== null) pbEnabled       = JSON.parse(en);
        if (pi !== null) pbIntake        = JSON.parse(pi);
        if (pc !== null) pbCommitments   = JSON.parse(pc);
        if (pb !== null) pbBudgetBaseline = JSON.parse(pb);
        if (pl !== null) pbBudgetLocked  = JSON.parse(pl);
      } catch(e) { /* corrupt data — leave defaults */ }
    }

    // ── Toggle ──
    function pbToggleChanged() {
      pbEnabled = document.getElementById('pbToggle').checked;
      savePlanBuilderToStorage();
      pbRenderUI();
      renderForecastVsActual();
    }

    function pbRenderUI() {
      const toggle = document.getElementById('pbToggle');
      toggle.checked = pbEnabled;
      document.getElementById('pbDisabledMsg').style.display = pbEnabled ? 'none' : '';
      const body = document.getElementById('pbBody');
      body.classList.toggle('pb-hidden', !pbEnabled);
      document.getElementById('pbSourceBadgeRow').style.display =
        (pbEnabled && pbHasValidCommitments()) ? '' : 'none';
      pbRenderStatusChip();
      pbRenderIntakeTable();
      pbRenderCommitmentsTable();
    }

    function pbRenderStatusChip() {
      const chip = document.getElementById('pbStatusChip');
      chip.textContent = pbBudgetLocked ? 'Budget Baseline: Locked' : 'Budget Baseline: Not locked';
      chip.className = 'pb-status-chip ' + (pbBudgetLocked ? 'locked' : 'not-locked');
    }

    // ── Forecast calc ──
    function pbHasValidCommitments() {
      return pbCommitments.some(c => c.status === 'Committed' || c.status === 'Invoiced');
    }

    /**
     * Builds forecastBudget[] from Plan Builder commitments.
     * Returns entries shaped: { month, cost_center, category, forecast_amount, budget_amount }
     *
     * Budget amount:
     *   - If baseline is locked: use stored baseline for that key; 0 for new keys (strict governance).
     *   - If baseline not locked: budget_amount = forecast_amount (usable before approval).
     */
    function buildForecastBudgetFromPlanBuilder() {
      // Accumulate forecast allocations
      const forecastMap = {}; // key: "month|costCenter|category" → amount

      pbCommitments.forEach(c => {
        if (c.status !== 'Committed' && c.status !== 'Invoiced') return;
        const startIdx = PB_MONTHS.indexOf(c.startMonth);
        const endIdx   = PB_MONTHS.indexOf(c.endMonth);
        if (startIdx < 0 || endIdx < 0) return;
        const numMonths = endIdx - startIdx + 1;
        const monthly   = parseFloat(c.amount) / (numMonths > 0 ? numMonths : 1);
        for (let i = startIdx; i <= endIdx; i++) {
          const key = `${PB_MONTHS[i]}|${c.costCenter}|${c.category}`;
          forecastMap[key] = (forecastMap[key] || 0) + monthly;
        }
      });

      return Object.entries(forecastMap).map(([key, fa]) => {
        const [month, cost_center, category] = key.split('|');
        const budget_amount = pbBudgetLocked
          ? (pbBudgetBaseline[key] !== undefined ? pbBudgetBaseline[key] : 0)
          : fa; // not locked → budget = forecast
        return { month, cost_center, category, forecast_amount: fa, budget_amount };
      });
    }

    // ── Build Plan (trigger re-render) ──
    function pbBuildPlan() {
      savePlanBuilderToStorage();
      pbRenderUI();
      renderForecastVsActual();
    }

    // ── Lock Budget Baseline ──
    function pbLockBudget() {
      if (!pbEnabled) return;
      // Capture current forecast allocations as baseline snapshot
      pbBudgetBaseline = {};
      pbCommitments.forEach(c => {
        if (c.status !== 'Committed' && c.status !== 'Invoiced') return;
        const startIdx = PB_MONTHS.indexOf(c.startMonth);
        const endIdx   = PB_MONTHS.indexOf(c.endMonth);
        if (startIdx < 0 || endIdx < 0) return;
        const numMonths = endIdx - startIdx + 1;
        const monthly   = parseFloat(c.amount) / (numMonths > 0 ? numMonths : 1);
        for (let i = startIdx; i <= endIdx; i++) {
          const key = `${PB_MONTHS[i]}|${c.costCenter}|${c.category}`;
          pbBudgetBaseline[key] = (pbBudgetBaseline[key] || 0) + monthly;
        }
      });
      pbBudgetLocked = true;
      savePlanBuilderToStorage();
      pbRenderStatusChip();
      renderForecastVsActual();
    }

    // ── Reset Budget Baseline ──
    function pbResetBudget() {
      pbBudgetBaseline = {};
      pbBudgetLocked   = false;
      savePlanBuilderToStorage();
      pbRenderStatusChip();
      renderForecastVsActual();
    }

    // ── Reset ALL Plan Builder data ──
    function pbResetAllData() {
      const confirmed = window.confirm(
        '⚠️ Reset everything?\n\nThis will delete all intake requests, all commitments, and the budget baseline.\n\nExport your plan first if you want a backup. This cannot be undone.'
      );
      if (!confirmed) return;

      pbIntake         = [];
      pbCommitments    = [];
      pbBudgetBaseline = {};
      pbBudgetLocked   = false;
      // Keep pbEnabled as-is — user stays in Plan Builder mode, just with a clean slate

      savePlanBuilderToStorage();
      pbRenderUI();
      renderForecastVsActual();
    }

    // ── Export / Import JSON ──
    function pbExportJSON() {
      const payload = {
        enabled: pbEnabled,
        intake: pbIntake,
        commitments: pbCommitments,
        budgetBaseline: pbBudgetBaseline,
        budgetLocked: pbBudgetLocked
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'plan-builder-export.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function pbImportJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          // Minimal shape validation
          if (typeof data !== 'object') throw new Error('Not an object');
          if (Array.isArray(data.intake))      pbIntake        = data.intake;
          if (Array.isArray(data.commitments)) pbCommitments   = data.commitments;
          if (typeof data.budgetBaseline === 'object' && data.budgetBaseline !== null)
                                               pbBudgetBaseline = data.budgetBaseline;
          if (typeof data.budgetLocked === 'boolean') pbBudgetLocked = data.budgetLocked;
          if (typeof data.enabled === 'boolean') {
            pbEnabled = data.enabled;
            document.getElementById('pbToggle').checked = pbEnabled;
          }
          savePlanBuilderToStorage();
          pbRenderUI();
          renderForecastVsActual();
        } catch(err) {
          alert('Import failed: invalid JSON or unexpected format.\n' + err.message);
        }
        // reset the file input so same file can be re-imported
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    // ── Intake CRUD ──
    let _pbIntakeIdCounter = 1;

    function pbOpenIntakeModal(editId) {
      const existing = editId ? pbIntake.find(r => r.id === editId) : null;
      const modal = document.getElementById('pbIntakeModal');
      document.getElementById('pbIntakeModalTitle').textContent = existing ? 'Edit Intake Request' : 'Add Intake Request';
      document.getElementById('pbIM_id').value          = existing ? existing.id : '';
      document.getElementById('pbIM_campaign').value    = existing ? existing.campaign : '';
      document.getElementById('pbIM_owner').value       = existing ? existing.owner : '';
      document.getElementById('pbIM_category').value    = existing ? existing.category : '';
      document.getElementById('pbIM_costCenter').value  = existing ? existing.costCenter : '';
      document.getElementById('pbIM_amount').value      = existing ? existing.amount : '';
      document.getElementById('pbIM_startMonth').value  = existing ? existing.startMonth : 'Jan';
      document.getElementById('pbIM_endMonth').value    = existing ? existing.endMonth : 'Dec';
      document.getElementById('pbIM_status').value      = existing ? existing.status : 'Draft';
      modal.classList.add('open');
    }

    function pbCloseIntakeModal() {
      document.getElementById('pbIntakeModal').classList.remove('open');
    }

    function pbSaveIntake() {
      const id         = document.getElementById('pbIM_id').value.trim();
      const campaign   = document.getElementById('pbIM_campaign').value.trim();
      const owner      = document.getElementById('pbIM_owner').value.trim();
      const category   = document.getElementById('pbIM_category').value.trim();
      const costCenter = document.getElementById('pbIM_costCenter').value.trim();
      const amount     = parseFloat(document.getElementById('pbIM_amount').value) || 0;
      const startMonth = document.getElementById('pbIM_startMonth').value;
      const endMonth   = document.getElementById('pbIM_endMonth').value;
      const status     = document.getElementById('pbIM_status').value;

      if (!campaign) { alert('Campaign is required.'); return; }
      if (amount <= 0) { alert('Amount must be greater than 0.'); return; }

      const row = {
        id: id || ('REQ-' + String(_pbIntakeIdCounter++).padStart(3,'0')),
        campaign, owner, category, costCenter, amount, startMonth, endMonth, status
      };
      const idx = pbIntake.findIndex(r => r.id === row.id);
      if (idx >= 0) pbIntake[idx] = row; else pbIntake.push(row);

      savePlanBuilderToStorage();
      pbRenderIntakeTable();
      pbCloseIntakeModal();
    }

    function pbDeleteIntake(id) {
      pbIntake = pbIntake.filter(r => r.id !== id);
      savePlanBuilderToStorage();
      pbRenderIntakeTable();
    }

    function pbApproveToCommit(intakeId) {
      const row = pbIntake.find(r => r.id === intakeId);
      if (!row) return;
      // Update intake status to Approved
      row.status = 'Approved';
      // Create a matching commitment
      const cid = 'CMT-' + String(pbCommitments.length + 1).padStart(3,'0');
      pbCommitments.push({
        id: cid,
        linkedRequest: row.id,
        vendor: row.campaign, // default vendor = campaign name
        category: row.category,
        costCenter: row.costCenter,
        amount: row.amount,
        startMonth: row.startMonth,
        endMonth: row.endMonth,
        status: 'Committed',
        phasing: 'Even'
      });
      savePlanBuilderToStorage();
      pbRenderIntakeTable();
      pbRenderCommitmentsTable();
      pbRenderUI();
      renderForecastVsActual();
    }

    function pbRenderIntakeTable() {
      const tbody = document.getElementById('pbIntakeTbody');
      if (!pbIntake.length) {
        tbody.innerHTML = '<tr class="pb-table-empty"><td colspan="10">No intake requests yet — click "+ Add Intake" to begin.</td></tr>';
        return;
      }
      tbody.innerHTML = pbIntake.map(r => `
        <tr>
          <td><code style="font-size:11px;">${r.id}</code></td>
          <td>${escHtml(r.campaign)}</td>
          <td>${escHtml(r.owner)}</td>
          <td>${escHtml(r.category)}</td>
          <td>${escHtml(r.costCenter)}</td>
          <td>$${Number(r.amount).toLocaleString()}</td>
          <td>${r.startMonth}</td>
          <td>${r.endMonth}</td>
          <td><span class="pb-badge ${r.status.toLowerCase()}">${r.status}</span></td>
          <td style="display:flex;gap:5px;flex-wrap:nowrap;">
            ${r.status !== 'Approved' && r.status !== 'Rejected'
              ? `<button class="pb-action-btn" onclick="pbApproveToCommit('${r.id}')">Approve → Commit</button>`
              : ''}
            <button class="pb-action-btn" onclick="pbOpenIntakeModal('${r.id}')">Edit</button>
            <button class="pb-action-btn danger" onclick="pbDeleteIntake('${r.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    // ── Commitment CRUD ──
    let _pbCommitIdCounter = 1;

    function pbOpenCommitmentModal(editId) {
      const existing = editId ? pbCommitments.find(c => c.id === editId) : null;
      const modal = document.getElementById('pbCommitModal');
      document.getElementById('pbCM_modalTitle').textContent = existing ? 'Edit Commitment' : 'Add Commitment';
      document.getElementById('pbCM_id').value             = existing ? existing.id : '';
      document.getElementById('pbCM_linkedRequest').value  = existing ? existing.linkedRequest : '';
      document.getElementById('pbCM_vendor').value         = existing ? existing.vendor : '';
      document.getElementById('pbCM_category').value       = existing ? existing.category : '';
      document.getElementById('pbCM_costCenter').value     = existing ? existing.costCenter : '';
      document.getElementById('pbCM_amount').value         = existing ? existing.amount : '';
      document.getElementById('pbCM_startMonth').value     = existing ? existing.startMonth : 'Jan';
      document.getElementById('pbCM_endMonth').value       = existing ? existing.endMonth : 'Dec';
      document.getElementById('pbCM_status').value         = existing ? existing.status : 'Committed';
      modal.classList.add('open');
    }

    function pbCloseCommitmentModal() {
      document.getElementById('pbCommitModal').classList.remove('open');
    }

    function pbSaveCommitment() {
      const id            = document.getElementById('pbCM_id').value.trim();
      const linkedRequest = document.getElementById('pbCM_linkedRequest').value.trim();
      const vendor        = document.getElementById('pbCM_vendor').value.trim();
      const category      = document.getElementById('pbCM_category').value.trim();
      const costCenter    = document.getElementById('pbCM_costCenter').value.trim();
      const amount        = parseFloat(document.getElementById('pbCM_amount').value) || 0;
      const startMonth    = document.getElementById('pbCM_startMonth').value;
      const endMonth      = document.getElementById('pbCM_endMonth').value;
      const status        = document.getElementById('pbCM_status').value;

      if (!vendor) { alert('Vendor is required.'); return; }
      if (amount <= 0) { alert('Amount must be greater than 0.'); return; }

      const row = {
        id: id || ('CMT-' + String(_pbCommitIdCounter++).padStart(3,'0')),
        linkedRequest, vendor, category, costCenter, amount,
        startMonth, endMonth, status, phasing: 'Even'
      };
      const idx = pbCommitments.findIndex(c => c.id === row.id);
      if (idx >= 0) pbCommitments[idx] = row; else pbCommitments.push(row);

      savePlanBuilderToStorage();
      pbRenderCommitmentsTable();
      pbRenderUI();
      renderForecastVsActual();
      pbCloseCommitmentModal();
    }

    function pbDeleteCommitment(id) {
      pbCommitments = pbCommitments.filter(c => c.id !== id);
      savePlanBuilderToStorage();
      pbRenderCommitmentsTable();
      pbRenderUI();
      renderForecastVsActual();
    }

    function pbRenderCommitmentsTable() {
      const tbody = document.getElementById('pbCommitTbody');
      if (!pbCommitments.length) {
        tbody.innerHTML = '<tr class="pb-table-empty"><td colspan="11">No commitments yet — approve an intake request or click "+ Add Commitment".</td></tr>';
        return;
      }
      tbody.innerHTML = pbCommitments.map(c => `
        <tr>
          <td><code style="font-size:11px;">${c.id}</code></td>
          <td><code style="font-size:11px;color:var(--muted);">${c.linkedRequest || '—'}</code></td>
          <td>${escHtml(c.vendor)}</td>
          <td>${escHtml(c.category)}</td>
          <td>${escHtml(c.costCenter)}</td>
          <td>$${Number(c.amount).toLocaleString()}</td>
          <td>${c.startMonth}</td>
          <td>${c.endMonth}</td>
          <td><span class="pb-badge ${c.status.toLowerCase()}">${c.status}</span></td>
          <td style="font-size:11px;color:var(--muted);">${c.phasing}</td>
          <td style="display:flex;gap:5px;flex-wrap:nowrap;">
            <button class="pb-action-btn" onclick="pbOpenCommitmentModal('${c.id}')">Edit</button>
            <button class="pb-action-btn danger" onclick="pbDeleteCommitment('${c.id}')">Delete</button>
          </td>
        </tr>
      `).join('');
    }

    function escHtml(str) {
      return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // ── Integration: wire Plan Builder into forecastBudget ──
    // Called at the top of renderForecastVsActual (patched below via wrapper)
    function pbGetForecastBudget(existingForecastBudget) {
      if (pbEnabled && pbHasValidCommitments()) {
        return buildForecastBudgetFromPlanBuilder();
      }
      return existingForecastBudget;
    }

    // ── Init Plan Builder on DOMContentLoaded ──
    document.addEventListener('DOMContentLoaded', function() {
      loadPlanBuilderFromStorage();
      pbRenderUI();
    });

    // ── Month options helper ──
    function pbMonthOptions(selected) {
      return PB_MONTHS.map(m =>
        `<option value="${m}"${m === selected ? ' selected' : ''}>${m}</option>`
      ).join('');
    }



</script>

<!-- ═══ Plan Builder Modals ═══ -->

<!-- Intake Modal -->
<div class="pb-modal-overlay" id="pbIntakeModal" onclick="if(event.target===this)pbCloseIntakeModal()">
  <div class="pb-modal">
    <div class="pb-modal-title" id="pbIntakeModalTitle">Add Intake Request</div>
    <input type="hidden" id="pbIM_id">
    <div class="pb-form-grid">
      <div class="pb-form-field full">
        <label>Campaign *</label>
        <input type="text" id="pbIM_campaign" placeholder="e.g. Q3 Paid Social">
      </div>
      <div class="pb-form-field">
        <label>Owner</label>
        <input type="text" id="pbIM_owner" placeholder="e.g. J. Smith">
      </div>
      <div class="pb-form-field">
        <label>Category</label>
        <input type="text" id="pbIM_category" placeholder="e.g. Digital Marketing">
      </div>
      <div class="pb-form-field">
        <label>Cost Center</label>
        <input type="text" id="pbIM_costCenter" placeholder="e.g. CC-MKT">
      </div>
      <div class="pb-form-field">
        <label>Amount ($) *</label>
        <input type="number" id="pbIM_amount" placeholder="e.g. 12000" min="0" step="100">
      </div>
      <div class="pb-form-field">
        <label>Start Month</label>
        <select id="pbIM_startMonth"></select>
      </div>
      <div class="pb-form-field">
        <label>End Month</label>
        <select id="pbIM_endMonth"></select>
      </div>
      <div class="pb-form-field">
        <label>Status</label>
        <select id="pbIM_status">
          <option value="Draft">Draft</option>
          <option value="Submitted">Submitted</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
        </select>
      </div>
    </div>
    <div class="pb-modal-actions">
      <button class="btn-small" onclick="pbCloseIntakeModal()">Cancel</button>
      <button class="btn-small btn-accent" onclick="pbSaveIntake()">Save Intake</button>
    </div>
  </div>
</div>

<!-- Commitment Modal -->
<div class="pb-modal-overlay" id="pbCommitModal" onclick="if(event.target===this)pbCloseCommitmentModal()">
  <div class="pb-modal">
    <div class="pb-modal-title" id="pbCM_modalTitle">Add Commitment</div>
    <input type="hidden" id="pbCM_id">
    <div class="pb-form-grid">
      <div class="pb-form-field">
        <label>Linked Request ID</label>
        <input type="text" id="pbCM_linkedRequest" placeholder="e.g. REQ-001 (optional)">
      </div>
      <div class="pb-form-field">
        <label>Vendor *</label>
        <input type="text" id="pbCM_vendor" placeholder="e.g. Google Ads">
      </div>
      <div class="pb-form-field">
        <label>Category</label>
        <input type="text" id="pbCM_category" placeholder="e.g. Digital Marketing">
      </div>
      <div class="pb-form-field">
        <label>Cost Center</label>
        <input type="text" id="pbCM_costCenter" placeholder="e.g. CC-MKT">
      </div>
      <div class="pb-form-field">
        <label>Amount ($) *</label>
        <input type="number" id="pbCM_amount" placeholder="e.g. 12000" min="0" step="100">
      </div>
      <div class="pb-form-field">
        <label>Start Month</label>
        <select id="pbCM_startMonth"></select>
      </div>
      <div class="pb-form-field">
        <label>End Month</label>
        <select id="pbCM_endMonth"></select>
      </div>
      <div class="pb-form-field">
        <label>Status</label>
        <select id="pbCM_status">
          <option value="Committed">Committed</option>
          <option value="Invoiced">Invoiced</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>
    </div>
    <div class="pb-modal-actions">
      <button class="btn-small" onclick="pbCloseCommitmentModal()">Cancel</button>
      <button class="btn-small btn-accent" onclick="pbSaveCommitment()">Save Commitment</button>
    </div>
  </div>
</div>

<script>
// Populate month selects in modals once DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  ['pbIM_startMonth','pbIM_endMonth','pbCM_startMonth','pbCM_endMonth'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].forEach((m, i) => {
        const opt = document.createElement('option');
        opt.value = m; opt.textContent = m;
        // Default end = Dec, start = Jan
        if ((id.includes('end') && i === 11) || (id.includes('start') && i === 0)) opt.selected = true;
        el.appendChild(opt);
      });
    }
  });
});
</script>

<!-- ═══ Plan Builder Guide Panel ═══ -->
<button class="pb-guide-fab" id="pbGuideFab" onclick="pbGuideToggle()" title="Plan Builder step-by-step guide" aria-label="Open Plan Builder guide">
  <span>📋</span>
  <span class="pb-guide-fab-badge" id="pbGuideBadge">5</span>
</button>

<div class="pb-guide-panel" id="pbGuidePanel">
  <div class="pb-guide-panel-head">
    <div>
      <div class="pb-guide-panel-title">Budget Build Guide</div>
      <div class="pb-guide-panel-subtitle">Intake → Commitments → Locked Baseline</div>
    </div>
    <button class="pb-guide-close" onclick="pbGuideToggle()" aria-label="Close guide">✕</button>
  </div>

  <div class="pb-guide-body" id="pbGuideBody">

    <div class="pb-guide-step" id="pbGS1" onclick="pbGuideStepClick(1)">
      <div class="pb-guide-num pending" id="pbGN1">1</div>
      <div class="pb-guide-content">
        <div class="pb-guide-step-title">Enable the Plan Builder</div>
        <div class="pb-guide-step-desc">Flip the toggle in the Plan Builder card header. The module switches from Sample/Random data to your own commitments as the forecast source.</div>
        <span class="pb-guide-step-action" onclick="event.stopPropagation();document.getElementById('pbToggle').checked=true;pbToggleChanged();pbGuideMarkDone(1);">Enable now →</span>
      </div>
      <span class="pb-guide-done-tick" id="pbGT1" style="display:none;">✓</span>
    </div>

    <div class="pb-guide-step" id="pbGS2" onclick="pbGuideStepClick(2)">
      <div class="pb-guide-num pending" id="pbGN2">2</div>
      <div class="pb-guide-content">
        <div class="pb-guide-step-title">Add spend requests to Intake</div>
        <div class="pb-guide-step-desc">Click <strong>+ Add Intake</strong> for each campaign or spend request. Fill in: Campaign, Owner, Category, Cost Center, Amount, and the months it spans (Start → End Month). Set Status to <em>Draft</em> or <em>Submitted</em>.</div>
        <span class="pb-guide-step-action" onclick="event.stopPropagation();pbOpenIntakeModal();pbGuideMarkDone(2);">Add first intake →</span>
      </div>
      <span class="pb-guide-done-tick" id="pbGT2" style="display:none;">✓</span>
    </div>

    <div class="pb-guide-step" id="pbGS3" onclick="pbGuideStepClick(3)">
      <div class="pb-guide-num pending" id="pbGN3">3</div>
      <div class="pb-guide-content">
        <div class="pb-guide-step-title">Approve requests → Commitments</div>
        <div class="pb-guide-step-desc">For each intake row you want to fund, click <strong>Approve → Commit</strong>. This creates a matching Commitment row that finance controls. You can also add Commitments directly if you skip the Intake step.</div>
      </div>
      <span class="pb-guide-done-tick" id="pbGT3" style="display:none;">✓</span>
    </div>

    <div class="pb-guide-step" id="pbGS4" onclick="pbGuideStepClick(4)">
      <div class="pb-guide-num pending" id="pbGN4">4</div>
      <div class="pb-guide-content">
        <div class="pb-guide-step-title">Build the Plan</div>
        <div class="pb-guide-step-desc">Click <strong>Build Plan</strong> to calculate monthly allocations from your commitments. Each commitment's amount is spread evenly across its months. The Forecast chart and Variance table update instantly.</div>
        <span class="pb-guide-step-action" onclick="event.stopPropagation();pbBuildPlan();pbGuideMarkDone(4);">Build Plan now →</span>
      </div>
      <span class="pb-guide-done-tick" id="pbGT4" style="display:none;">✓</span>
    </div>

    <div class="pb-guide-step" id="pbGS5" onclick="pbGuideStepClick(5)">
      <div class="pb-guide-num pending" id="pbGN5">5</div>
      <div class="pb-guide-content">
        <div class="pb-guide-step-title">Lock the Budget Baseline</div>
        <div class="pb-guide-step-desc">Once the plan is reviewed and approved, click <strong>Lock Budget Baseline</strong>. This freezes the current forecast as the official Budget (Approved Forecast v1). Future commitment edits update the rolling Forecast but the Budget stays fixed — enabling real variance analysis (Actual vs Budget).</div>
        <span class="pb-guide-step-action" onclick="event.stopPropagation();pbLockBudget();pbGuideMarkDone(5);">Lock baseline now →</span>
      </div>
      <span class="pb-guide-done-tick" id="pbGT5" style="display:none;">✓</span>
    </div>

  </div>

  <div class="pb-guide-progress-bar-wrap">
    <div class="pb-guide-progress-label">
      <span>Progress</span>
      <span id="pbGuideProgressText">0 / 5 steps</span>
    </div>
    <div class="pb-guide-progress-track">
      <div class="pb-guide-progress-fill" id="pbGuideProgressFill" style="width:0%"></div>
    </div>
  </div>
</div>
<!-- ═══ /Plan Builder Guide Panel ═══ -->

</body>
</html>

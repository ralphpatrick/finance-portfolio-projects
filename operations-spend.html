<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Operations Finance & Spend Analytics ¬∑ FP&A Portfolio</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    /* module-hero, module-label, module-title, module-pill, module-subtitle,
       module-problem, module-role, feature-chips ‚Äî all in style.css */
    
    /* Main layout with sidebar */
    .module-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      align-items: start;
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    
    /* Main content area */
    .main-content {
      min-width: 0;
    }
    
    /* Module sections */
    .module-section {
      padding: 0 0 48px 0;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .module-layout {
        grid-template-columns: 1fr;
      }
    }

    .chip {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(246,248,251,0.8);
      color: var(--text);
    }
    

    .module-section-title {
      font-size: 24px;
      margin-bottom: 20px;
      letter-spacing: -0.02em;
    }
    .module-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-soft);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .card-title {
      font-size: 18px;
      font-weight: 650;
    }
    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* Buttons */
    .btn-small {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 999px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 140ms ease;
      white-space: nowrap;
    }
    .btn-small:hover {
      border-color: rgba(12, 23, 45, 0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.06);
    }
    .btn-small:active {
      transform: translateY(1px);
    }
    .btn-primary {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }
    .btn-primary:hover {
      box-shadow: 0 6px 18px rgba(11,18,32,0.12);
    }
    .btn-full {
      width: 100%;
      justify-content: center;
      display: flex;
    }
    
    /* KPI grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .kpi-box {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: rgba(246,248,251,0.6);
    }
    .kpi-box-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .kpi-box-value {
      font-size: 20px;
      font-weight: 650;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin: 16px 0;
      overflow-x: auto;
    }
    .data-table th {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 2px solid var(--border);
      font-weight: 650;
      color: var(--text);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .data-table tr:last-child td {
      border-bottom: none;
    }
    .data-table tr:hover {
      background: rgba(246,248,251,0.5);
    }
    .highlight-red {
      color: #dc2626;
      font-weight: 600;
    }
    .highlight-green {
      color: #059669;
      font-weight: 600;
    }
    
    /* Charts */
    .chart-container { overflow-anchor: none;
      margin: 20px 0;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
      position: relative;
    }
    .chart-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 16px;
      color: var(--text);
    }
    .chart-wrapper {
      position: relative;
      width: 100%;
    }
    .chart-canvas {
      display: block;
      width: 100%;
      height: auto;
    }
    
    /* Filters */
    .filter-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .filter-row select,
    .filter-row input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      background: white;
      font-family: var(--font-sans);
    }
    .filter-row label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      margin-right: 6px;
    }
    
    /* File upload */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    /* Alert cards */
    .alert-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 14px;
      margin-top: 16px;
    }
    .alert-card {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .alert-card.high {
      border-left: 4px solid #dc2626;
      background: rgba(220, 38, 38, 0.02);
    }
    .alert-card.med {
      border-left: 4px solid #f59e0b;
      background: rgba(245, 158, 11, 0.02);
    }
    .alert-card.low {
      border-left: 4px solid #6b7280;
      background: rgba(107, 114, 128, 0.02);
    }
    .alert-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .alert-title {
      font-size: 14px;
      font-weight: 650;
      color: var(--text);
    }
    .severity-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .severity-badge.high {
      background: rgba(220, 38, 38, 0.15);
      color: #dc2626;
    }
    .severity-badge.med {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }
    .severity-badge.low {
      background: rgba(107, 114, 128, 0.15);
      color: #6b7280;
    }
    .alert-text {
      font-size: 13px;
      color: var(--text);
      line-height: 1.5;
      margin-bottom: 8px;
    }
    .alert-why {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .alert-action {
      font-size: 12px;
      color: var(--accent);
      font-weight: 600;
    }
    
    /* Threshold controls */
    .threshold-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
      padding: 16px;
      background: rgba(246,248,251,0.6);
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
    }
    .threshold-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .threshold-field label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .threshold-field input {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      font-family: var(--font-sans);
      background: white;
    }
    
    /* Demo section */
    .demo-section {
      padding: 32px 0;
      border-top: 1px solid var(--border);
    }
    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
    }
    .demo-card {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .demo-card-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 8px;
    }
    .demo-card-text {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    
    /* Toggle */
    .toggle-group {
      display: flex;
      gap: 8px;
      padding: 4px;
      background: rgba(246,248,251,0.8);
      border-radius: 999px;
      border: 1px solid var(--border);
    }
    .toggle-btn {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 140ms ease;
      color: var(--muted);
    }
    .toggle-btn.active {
      background: white;
      color: var(--text);
      box-shadow: 0 2px 4px rgba(11,18,32,0.08);
    }

    /* ---- Decision Box ---- */
    .decision-box {
      background: white;
      border: 1.5px solid var(--accent);
      border-radius: var(--radius);
      padding: 20px 24px;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.08), var(--shadow-soft);
      margin-bottom: 24px;
      transition: border-color 200ms ease, box-shadow 200ms ease, background 200ms ease;
    }
    /* Positive ‚Äî green */
    .decision-box--positive {
      border-color: #0f766e;
      background: #f0fdf9;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.10), var(--shadow-soft);
    }
    .decision-box--positive .decision-box-eyebrow { color: #0f766e; }
    .decision-box--positive .verdict-action        { color: #0f766e; }
    /* Caution ‚Äî amber (Freeze spend: no leakage but overrun risk) */
    .decision-box--caution {
      border-color: #d97706;
      background: #fffbeb;
      box-shadow: 0 0 0 4px rgba(217,119,6,0.10), var(--shadow-soft);
    }
    .decision-box--caution .decision-box-eyebrow { color: #b45309; }
    .decision-box--caution .verdict-action        { color: #b45309; }
    /* Negative ‚Äî red (Fix leakage first) */
    .decision-box--negative {
      border-color: #dc2626;
      background: #fef2f2;
      box-shadow: 0 0 0 4px rgba(220,38,38,0.10), var(--shadow-soft);
    }
    .decision-box--negative .decision-box-eyebrow { color: #dc2626; }
    .decision-box--negative .verdict-action        { color: #dc2626; }
    .decision-box-eyebrow {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--accent);
      margin-bottom: 8px;
    }
    .decision-box-verdict {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
      margin-bottom: 14px;
    }
    .decision-box-verdict .verdict-action {
      color: var(--accent);
    }
    .decision-box-exceptions {
      margin: 0 0 12px 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .exception-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      padding: 9px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      align-items: center;
    }
    .exception-row:last-child {
      border-bottom: none;
    }
    .exception-row-header {
      background: rgba(246,248,251,0.8);
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
    }
    .exception-label {
      color: var(--text);
      font-weight: 600;
    }
    .exception-count {
      color: #dc2626;
      font-weight: 700;
      font-family: var(--font-mono);
      text-align: right;
    }
    .exception-action {
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
      text-align: right;
    }
    .decision-box-fallback {
      font-size: 14px;
      color: var(--muted);
      font-style: italic;
    }
      .main-content { overflow-anchor: none; }
    .module-card { overflow-anchor: none; }
    .data-table { overflow-anchor: none; }
  
    /* ‚îÄ‚îÄ Data-needed strip ‚îÄ‚îÄ */
    .data-needed-section {
      padding: 0 0 0 0;
      border-bottom: 1px solid var(--border, #e5e8ef);
    }
    .data-needed-wrap {
      max-width: var(--max-w, 1200px);
      margin: 0 auto;
      padding: 20px 32px 24px;
    }
    .data-needed-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--muted, #6b7280);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .data-needed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(185px, 1fr));
      gap: 8px;
    }
    .data-needed-item {
      padding: 10px 12px;
      border: 1px solid var(--border, #e5e8ef);
      border-radius: 9px;
      display: flex;
      align-items: flex-start;
      gap: 9px;
      background: #fafbfc;
    }
    .data-needed-icon {
      width: 26px;
      height: 26px;
      font-size: 13px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .data-needed-name {
      font-size: 11px;
      font-weight: 700;
      color: var(--text, #0b1220);
      margin-bottom: 3px;
      line-height: 1.35;
    }
    .data-needed-desc {
      font-size: 10px;
      color: var(--muted, #6b7280);
      line-height: 1.5;
    }


    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SIDEBAR ‚Äî Accordion (shared across all modules)
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .sidebar {
      position: sticky;
      top: 80px;
      padding: 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      max-height: calc(100vh - 100px);
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(12,23,45,0.15) transparent;
    }
    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }
    .sidebar::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.28); }

    /* Static top section (data mode badge + always-visible controls) */
    .sb-static {
      padding-bottom: 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }
    .sb-static-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    /* Accordion group */
    .sb-acc-group {
      border-bottom: 1px solid var(--border);
    }
    .sb-acc-group:last-child { border-bottom: none; }

    .sb-acc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 12px 0;
      cursor: pointer;
      user-select: none;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      transition: color 120ms ease;
    }
    .sb-acc-header:hover { color: var(--text); }
    .sb-acc-header.open  { color: var(--text); }
    .sb-acc-chevron {
      font-size: 10px;
      color: var(--muted);
      transition: transform 200ms ease;
      flex-shrink: 0;
    }
    .sb-acc-header.open .sb-acc-chevron {
      transform: rotate(180deg);
      color: var(--text);
    }
    .sb-acc-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft, rgba(15,118,110,0.10));
      color: var(--accent, #0f766e);
      flex-shrink: 0;
      margin-left: auto;
    }

    .sb-acc-body {
      display: none;
      padding-bottom: 14px;
    }
    .sb-acc-body.open { display: block; }

    /* Buttons inside accordion */
    .sb-acc-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      transition: all 140ms ease;
      text-align: left;
      white-space: nowrap;
      font-family: inherit;
    }
    .sb-acc-btn:first-child { margin-top: 0; }
    .sb-acc-btn:hover {
      border-color: rgba(12,23,45,0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.06);
    }
    .sb-acc-btn:active { transform: translateY(1px); }
    .sb-acc-btn.primary { background: var(--text, #0b1220); color: white; border-color: var(--text, #0b1220); }
    .sb-acc-btn.primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-acc-btn.accent  { background: var(--accent, #0f766e); color: white; border-color: var(--accent, #0f766e); }

    /* Scenario tabs inside accordion */
    .sb-acc-tabs { display: flex; flex-direction: column; gap: 6px; }
    .sb-acc-tab {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 140ms ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }
    .sb-acc-tab:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-tab.active { background: var(--text, #0b1220); color: white; border-color: var(--text, #0b1220); }

    /* Input rows inside accordion */
    .sb-acc-input-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .sb-acc-input-row:last-child { margin-bottom: 0; }
    .sb-acc-input-row label {
      font-size: 11px;
      color: var(--muted, #5d6b7a);
      flex: 1;
      line-height: 1.3;
    }
    .sb-acc-input-row input[type="number"] {
      width: 76px;
      padding: 5px 7px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      background: white;
      text-align: right;
      flex-shrink: 0;
      -moz-appearance: textfield;
    }
    .sb-acc-input-row input[type="number"]::-webkit-outer-spin-button,
    .sb-acc-input-row input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .sb-acc-input-row input[type="number"]:focus {
      outline: none;
      border-color: var(--accent, #0f766e);
      box-shadow: 0 0 0 2px rgba(15,118,110,0.15);
    }
    .sb-acc-sub {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.07em;
      text-transform: uppercase;
      margin: 10px 0 8px;
      border-top: 1px solid var(--border);
      padding-top: 9px;
    }

    /* Responsive: on mobile sidebar goes full width, no sticky, no scroll */
    @media (max-width: 860px) {
      .sidebar {
        position: static;
        max-height: none;
        overflow-y: visible;
      }
    }

  
    /* ‚îÄ‚îÄ Tooltip engine: body-level fixed div, never clipped by overflow ‚îÄ‚îÄ */
    /* Kill ALL CSS ::after tooltip rules ‚Äî they clip inside overflow containers */
    .help-icon::after,
    .help-icon:hover::after,
    .help-icon[data-help]::after,
    [data-tt]::after,
    [data-tt]:hover::after,
    .term-helper::after,
    .term-helper:hover::after {
      content: none !important;
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }

    /* #tt-root ‚Äî single fixed tooltip bubble appended to <body> by JS */
    #tt-root {
      position: fixed;
      z-index: 99999;
      pointer-events: none;
      padding: 9px 13px;
      background: rgba(11,18,32,0.95);
      color: #f0f4f8;
      font-size: 12px;
      font-weight: 400;
      line-height: 1.55;
      border-radius: 9px;
      white-space: normal;
      width: 260px;
      max-width: calc(100vw - 24px);
      box-shadow: 0 4px 18px rgba(0,0,0,0.28);
      text-align: left;
      opacity: 0;
      transition: opacity 120ms ease;
    }
    #tt-root.tt-visible { opacity: 1; }

    /* .help-icon visual ‚Äî keep the badge, remove position:relative (no longer needed) */
    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(15,118,110,0.10);
      border: 1px solid rgba(15,118,110,0.20);
      color: var(--accent);
      font-size: 11px;
      font-weight: 700;
      cursor: help;
      flex-shrink: 0;
      position: static;   /* was relative ‚Äî not needed with body-level tooltip */
    }
    .help-icon::before { content: '?'; line-height: 1; }

  
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SHARED SIDEBAR SHELL ‚Äî standardised across all modules
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* Layout */
    .module-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      align-items: start;
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .main-content { min-width: 0; }

    /* Mobile Controls Toggle Button */
    .mobile-controls-btn {
      display: none;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      cursor: pointer;
      margin-bottom: 4px;
      box-shadow: var(--shadow-soft);
      transition: all 140ms ease;
    }
    .mobile-controls-btn:hover {
      border-color: rgba(12,23,45,0.18);
      box-shadow: var(--shadow);
    }
    .mobile-controls-btn .mcb-icon { font-size: 16px; flex-shrink: 0; }
    .mobile-controls-btn .mcb-label { flex: 1; text-align: left; }
    .mobile-controls-btn .mcb-chevron {
      font-size: 11px; color: var(--muted);
      transition: transform 200ms ease;
    }
    .mobile-controls-btn[aria-expanded="true"] .mcb-chevron { transform: rotate(180deg); }

    /* Sidebar shell */
    .sidebar {
      position: sticky;
      top: 84px;
      padding: 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      max-height: calc(100vh - 104px);
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: rgba(12,23,45,0.15) transparent;
      width: 280px;
    }
    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: rgba(12,23,45,0.15); border-radius: 4px; }
    .sidebar::-webkit-scrollbar-thumb:hover { background: rgba(12,23,45,0.28); }

    /* Static section (Data Mode etc ‚Äî always visible) */
    .sb-static {
      padding-bottom: 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0;
    }
    .sb-static-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    /* ‚îÄ‚îÄ Data Mode segmented control (fixed height, no wrapping) ‚îÄ‚îÄ */
    .sb-data-mode-row {
      display: flex;
      gap: 0;
      height: 34px;              /* fixed height ‚Äî prevents layout shift */
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: var(--bg-muted);
      flex-wrap: nowrap;         /* never wrap */
    }
    .sb-data-mode-btn {
      flex: 1;
      min-width: 0;
      height: 100%;
      padding: 0 4px;
      background: transparent;
      border: none;
      border-right: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: background 120ms ease, color 120ms ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: inherit;
    }
    .sb-data-mode-btn:last-child { border-right: none; }
    .sb-data-mode-btn:hover { background: rgba(12,23,45,0.04); color: var(--text); }
    .sb-data-mode-btn.active {
      background: var(--text);
      color: white;
    }

    /* Mode pills (2-option) ‚Äî also fixed height */
    .sb-mode-pills {
      display: flex;
      gap: 0;
      height: 34px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      background: var(--bg-muted);
      flex-wrap: nowrap;
    }
    .sb-mode-pill {
      flex: 1;
      height: 100%;
      padding: 0 6px;
      border: none;
      border-right: 1px solid var(--border);
      background: transparent;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      transition: background 120ms ease, color 120ms ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: inherit;
      text-align: center;
    }
    .sb-mode-pill:last-child { border-right: none; }
    .sb-mode-pill:hover { background: rgba(12,23,45,0.04); color: var(--text); }
    .sb-mode-pill.active { background: var(--text); color: white; }

    /* Badge */
    .data-badge {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15,118,110,0.10);
      border: 1px solid rgba(15,118,110,0.20);
      color: var(--accent);
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .data-badge.random {
      background: #fef3c7;
      border-color: #fbbf24;
      color: #92400e;
    }

    /* Accordion groups */
    .sb-acc-group {
      border-bottom: 1px solid var(--border);
    }
    .sb-acc-group:last-child { border-bottom: none; }

    .sb-acc-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 12px 0;
      cursor: pointer;
      user-select: none;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      transition: color 120ms ease;
      font-family: inherit;
    }
    .sb-acc-header:hover { color: var(--text); }
    .sb-acc-header.open  { color: var(--text); }
    .sb-acc-chevron {
      font-size: 10px;
      color: var(--muted);
      transition: transform 200ms ease;
      flex-shrink: 0;
    }
    .sb-acc-header.open .sb-acc-chevron { transform: rotate(180deg); color: var(--text); }
    .sb-acc-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      flex-shrink: 0;
      margin-left: auto;
    }

    .sb-acc-body {
      display: none;
      padding-bottom: 14px;
    }
    .sb-acc-body.open { display: block; }

    /* Buttons inside accordion */
    .sb-acc-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      transition: all 140ms ease;
      text-align: left;
      white-space: nowrap;
      font-family: inherit;
    }
    .sb-acc-btn:first-child { margin-top: 0; }
    .sb-acc-btn:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-btn:active { transform: translateY(1px); }
    .sb-acc-btn.primary { background: var(--text); color: white; border-color: var(--text); }
    .sb-acc-btn.primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-acc-btn.accent  { background: var(--accent); color: white; border-color: var(--accent); }

    /* Tabs (scenario selectors etc.) */
    .sb-acc-tabs { display: flex; flex-direction: column; gap: 6px; }
    .sb-acc-tab {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 140ms ease;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: inherit;
    }
    .sb-acc-tab:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-acc-tab.active { background: var(--text); color: white; border-color: var(--text); }

    /* Input rows */
    .sb-acc-input-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .sb-acc-input-row:last-child { margin-bottom: 0; }
    .sb-acc-input-row label {
      font-size: 11px;
      color: var(--muted);
      flex: 1;
      line-height: 1.3;
    }
    .sb-acc-input-row input[type="number"] {
      width: 76px;
      padding: 5px 7px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      background: white;
      text-align: right;
      flex-shrink: 0;
      -moz-appearance: textfield;
    }
    .sb-acc-input-row input[type="number"]::-webkit-outer-spin-button,
    .sb-acc-input-row input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .sb-acc-input-row input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(15,118,110,0.15);
    }
    .sb-acc-sub {
      font-size: 10px;
      font-weight: 700;
      color: var(--muted);
      letter-spacing: 0.07em;
      text-transform: uppercase;
      margin: 10px 0 8px;
      border-top: 1px solid var(--border);
      padding-top: 9px;
    }

    /* Action buttons (full-width) */
    .sb-action-btn {
      display: flex; align-items: center; gap: 8px;
      width: 100%; padding: 7px 12px;
      border-radius: 999px; border: 1px solid var(--border);
      background: white; font-size: 12px; font-weight: 600;
      cursor: pointer; margin-top: 6px;
      transition: all 140ms ease; text-align: left;
      white-space: nowrap; font-family: inherit;
    }
    .sb-action-btn:hover { border-color: rgba(12,23,45,0.18); box-shadow: 0 4px 12px rgba(11,18,32,0.06); }
    .sb-action-btn:active { transform: translateY(1px); }
    .sb-action-btn.sb-action-primary { background: var(--text); color: white; border-color: var(--text); }
    .sb-action-btn.sb-action-primary:hover { box-shadow: 0 6px 18px rgba(11,18,32,0.12); }
    .sb-action-btn.sb-action-accent  { background: var(--accent); color: white; border-color: var(--accent); }
    .sb-file-hidden { position: absolute; opacity: 0; width: 0; height: 0; }

    /* Sliders */
    .control-item { margin-bottom: 16px; }
    .control-item:last-child { margin-bottom: 0; }
    .control-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }
    .control-value {
      font-size: 13px;
      font-weight: 700;
      color: var(--accent-2);
      font-family: var(--font-mono, monospace);
    }
    .control-input {
      -webkit-appearance: none; appearance: none;
      width: 100%; height: 6px;
      border-radius: 3px;
      background: var(--bg-muted);
      outline: none; cursor: pointer;
    }
    .control-input::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
      box-shadow: 0 2px 8px rgba(15,118,110,0.3);
      transition: all 140ms ease;
    }
    .control-input::-webkit-slider-thumb:hover { transform: scale(1.1); }
    .control-input::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent); cursor: pointer;
      box-shadow: 0 2px 8px rgba(15,118,110,0.3); border: none;
    }

    /* ‚îÄ‚îÄ Mobile responsive ‚îÄ‚îÄ */
    @media (max-width: 860px) {
      .module-layout {
        grid-template-columns: 1fr;
        padding: 16px;
      }
      .mobile-controls-btn { display: flex; }
      .sidebar {
        position: static;
        top: 0;
        width: 100%;
        max-height: none;
        overflow-y: visible;
        display: none;            /* hidden by default; JS toggles */
        border-radius: var(--radius-sm);
        margin-bottom: 8px;
      }
      .sidebar.mobile-open { display: block; }
    }

    @media (max-width: 560px) {
      .module-layout { padding: 12px; }
    }


</style>
</head>
<body>

  <a href="#main-content" class="skip-link">Skip to content</a>

  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html" class="brand">
          <span class="brand-mark" aria-hidden="true"></span>
          FP&A Portfolio
        </a>
        <div class="nav-cta">
          <a href="index.html#card-operations-spend" class="btn btn-ghost">‚Üê Back to Portfolio</a>
        </div>
      </nav>
    </div>
  </header>

  <main id="main-content">
    
    <!-- Hero -->
    <section class="module-hero">
      <div class="container">
        <div class="module-label">Operational spend</div>
        <h1 class="module-title">Operations Finance & Spend Analytics</h1>
        <div class="module-pill">Ops</div>
        <p class="module-subtitle">Controlling spend in complex, operational environments.</p>
        <p class="module-problem">Spot leakage early, enforce rate discipline, and reduce forecast surprises.</p>
        <p class="module-role">Operations Finance ‚Ä¢ Finance Operations ‚Ä¢ Spend Analytics</p>
        <div class="feature-chips">
          <span class="chip">Vendor rate cards</span>
          <span class="chip">Accrual tracking</span>
          <span class="chip">Forecast vs actual spend</span>
          <span class="chip">Risk & anomaly flags</span>
        </div>
      </div>
    </section>

  <!-- DATA NEEDED STRIP -->
  <div class="data-needed-section">
    <div class="data-needed-wrap">
      <div class="data-needed-label">üìÇ &nbsp;Data needed for this module</div>
      <div class="data-needed-grid">
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#eff6ff;">üìã</div><div><div class="data-needed-name">Vendor Rate Cards</div><div class="data-needed-desc">Agreed unit rates by vendor &amp; service type ‚Üí detects rate card mismatches</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#f0fdf9;">üßæ</div><div><div class="data-needed-name">Purchase Orders / Invoices</div><div class="data-needed-desc">Actual billed amounts vs. PO values ‚Üí flags unapproved spend</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#fef3c7;">üì¶</div><div><div class="data-needed-name">Accrual Register</div><div class="data-needed-desc">Services received but not yet invoiced ‚Üí open accrual tracking</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#f5f3ff;">üìä</div><div><div class="data-needed-name">Budget vs Actual Report</div><div class="data-needed-desc">Approved budget per cost centre ‚Üí spend vs forecast variance</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#fdf2f8;">üîç</div><div><div class="data-needed-name">Spend Anomaly Log</div><div class="data-needed-desc">Flagged transactions outside policy ‚Üí risk &amp; anomaly analysis</div></div></div>
      </div>
    </div>
  </div>

    <!-- Main Layout with Sidebar -->
    <div class="module-layout">
      
      <!-- Sticky Sidebar -->
          <!-- Mobile Controls Toggle (hidden on desktop) -->
    <button class="mobile-controls-btn" id="mobileControlsBtn" aria-expanded="false">
      <span class="mcb-icon">&#9881;</span>
      <span class="mcb-label">Controls</span>
      <span class="mcb-chevron">&#9660;</span>
    </button>
    <aside class="sidebar" id="sidebarPanel">

      <!-- Data Mode ‚Äî always visible -->
      <div class="sb-static">
        <div class="sb-static-title">
          <span>DATA MODE</span>
          <span id="dataModeBadge" class="data-badge">SAMPLE</span>
        </div>
        <div style="display:flex;gap:0;height:34px;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--bg-muted);flex-wrap:nowrap;">
          <button id="btnSampleMode" onclick="useSampleData()" style="flex:1;height:100%;padding:0 4px;background:var(--text);color:white;border:none;border-right:1px solid var(--border);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;">Sample</button>
          <button id="btnRandomMode" onclick="randomizeSampleData()" style="flex:1;height:100%;padding:0 4px;background:transparent;border:none;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;font-family:inherit;">Random</button>
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:6px;line-height:1.4;">Sample = fixed demo dataset &bull; Random = generated dataset</div>
      </div>

      <!-- Actions -->
      <div class="sb-acc-group">
        <button class="sb-acc-header" onclick="sidebarAccordion(this)">
          <span>Actions</span>
          <span class="sb-acc-chevron">‚ñº</span>
        </button>
        <div class="sb-acc-body">
          <button onclick="useSampleData()" class="sb-acc-btn">Use Sample</button>
          <button onclick="randomizeSampleData()" class="sb-acc-btn primary">üé≤ Generate Random</button>
          <button onclick="downloadAllTemplates()" class="sb-acc-btn">Download Templates</button>
        </div>
      </div>

      <!-- Upload Data -->
      <div class="sb-acc-group">
        <button class="sb-acc-header" onclick="sidebarAccordion(this)">
          <span>Data &amp; Upload</span>
          <span id="sbUploadLabel" class="sb-acc-badge">CSV</span>
          <span class="sb-acc-chevron">‚ñº</span>
        </button>
        <div class="sb-acc-body">
          <div style="font-size:10px;color:var(--muted);margin-bottom:8px;line-height:1.5;">Upload your own CSV files. Each replaces the corresponding sample dataset.</div>
          <div style="position:relative;margin-top:4px;">
            <input type="file" id="rateCardsUpload" accept=".csv" onchange="handleRateCardsUpload(event)" style="position:absolute;opacity:0;width:100%;height:100%;cursor:pointer;z-index:2;">
            <button class="sb-acc-btn" style="width:100%;">üìã Rate Cards CSV</button>
          </div>
          <div style="position:relative;margin-top:4px;">
            <input type="file" id="transactionsUpload" accept=".csv" onchange="handleTransactionsUpload(event)" style="position:absolute;opacity:0;width:100%;height:100%;cursor:pointer;z-index:2;">
            <button class="sb-acc-btn" style="width:100%;">üí≥ Transactions CSV</button>
          </div>
          <div style="position:relative;margin-top:4px;">
            <input type="file" id="accrualsUpload" accept=".csv" onchange="handleAccrualsUpload(event)" style="position:absolute;opacity:0;width:100%;height:100%;cursor:pointer;z-index:2;">
            <button class="sb-acc-btn" style="width:100%;">üìÖ Accruals CSV</button>
          </div>
          <div style="position:relative;margin-top:4px;">
            <input type="file" id="forecastUpload" accept=".csv" onchange="handleForecastUpload(event)" style="position:absolute;opacity:0;width:100%;height:100%;cursor:pointer;z-index:2;">
            <button class="sb-acc-btn" style="width:100%;">üìà Forecast CSV</button>
          </div>
          <button onclick="downloadAllTemplates()" class="sb-acc-btn" style="margin-top:8px;">‚¨á Download Templates</button>
        </div>
      </div>

    </aside>

      <!-- Main Content -->
      <div class="main-content">

        <!-- DECISION BOX -->
        <div class="decision-box" id="spendDecisionBox" aria-label="Spend Decision Summary">
          <div class="decision-box-eyebrow">Decision</div>
          <div class="decision-box-fallback" id="spendDecisionFallback">Load sample or upload data to see the decision.</div>
          <div id="spendDecisionContent" style="display:none;">
            <div class="decision-box-verdict" id="spendDecisionVerdict"></div>
            <div class="decision-box-exceptions" id="spendDecisionExceptions"></div>
          </div>
        </div>

        <!-- Rate Leakage -->
        <section class="module-section">
        <h2 class="module-section-title">1. Vendor Rate Cards (Rate Discipline)</h2>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Rate Leakage Analysis</h3>
            <div class="card-actions">
              <button onclick="downloadRateLeakageCSV()" class="btn-small">Export Results</button>
            </div>
          </div>

          <div class="filter-row">
            <label>Month:</label>
            <select id="rateMonthFilter" onchange="renderRateLeakage()">
              <option value="all">All Months</option>
            </select>
            <label>Category:</label>
            <select id="rateCategoryFilter" onchange="renderRateLeakage()">
              <option value="all">All Categories</option>
            </select>
            <label>Vendor:</label>
            <select id="rateVendorFilter" onchange="renderRateLeakage()">
              <option value="all">All Vendors</option>
            </select>
          </div>

          <div class="kpi-grid" id="rateKPIs">
            <!-- KPIs populated by JS -->
          </div>

          <div class="chart-container">
            <div class="chart-title">Top 8 Vendors by Leakage</div>
            <div class="chart-wrapper">
              <canvas id="leakageChart" class="chart-canvas"></canvas>
            </div>
          </div>

          <!-- So What: Rate Leakage -->
          <div style="margin:16px 0 8px;padding:18px 20px;border:1.5px solid rgba(220,38,38,0.25);border-radius:14px;background:#fef9f9;box-shadow:0 2px 8px rgba(220,38,38,0.06);">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#dc2626;margin-bottom:8px;">üí° So What ‚Äî Rate Leakage Analysis</div>
            <ul style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;">
              <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#dc2626;font-weight:700;flex-shrink:0;">‚Ä∫</span>Rate leakage is the gap between what you contracted to pay and what vendors actually charged ‚Äî direct P&amp;L impact that bypasses budget.</li>
              <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#dc2626;font-weight:700;flex-shrink:0;">‚Ä∫</span>Top leaking vendors should be prioritised for immediate contract review and rate re-negotiation; even a 50% reduction in leakage on the top 3 vendors typically saves 2‚Äì4% of total vendor spend.</li>
              <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#dc2626;font-weight:700;flex-shrink:0;">‚Ä∫</span><strong style="color:#0b1220;">If leakage is rising:</strong> Escalate to procurement ‚Äî add PO matching controls and require invoice approval against contract rates before payment.</li>
              <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#dc2626;font-weight:700;flex-shrink:0;">‚Ä∫</span><strong style="color:#0b1220;">If leakage is flat/low:</strong> Rate discipline is working ‚Äî document controls for audit and focus on contract renewal terms instead.</li>
            </ul>
          </div>

          <table class="data-table" id="rateTable">
            <!-- Table populated by JS -->
          </table>
        </div>
    </section>

    <!-- Accrual Tracking -->
    <section class="module-section section-muted">
      <div class="container">
        <h2 class="module-section-title">2. Accrual Tracking</h2>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Accrual Schedule</h3>
            <div class="card-actions">
              <button onclick="downloadAccrualsCSV()" class="btn-small">Export Schedule</button>
            </div>
          </div>

          <div class="kpi-grid" id="accrualKPIs">
            <!-- KPIs populated by JS -->
          </div>

          <div class="chart-container">
            <div class="chart-title">Accrued vs Invoiced Trend</div>
            <div class="chart-wrapper">
              <canvas id="accrualChart" class="chart-canvas"></canvas>
            </div>
          </div>

          <!-- So What: Accrual Schedule -->
          <div style="margin:16px 0 8px;padding:18px 20px;border:1.5px solid rgba(15,118,110,0.25);border-radius:14px;background:#f0fdf9;box-shadow:0 2px 8px rgba(15,118,110,0.06);">
            <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#0f766e;margin-bottom:8px;">üí° So What ‚Äî Accrual Schedule</div>
            <ul style="list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px;">
              <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚Ä∫</span>Accruals are expenses recognised in the P&amp;L before a vendor invoice arrives. A growing accrual balance means real cost is accumulating that may not yet be reflected in cash or AP ‚Äî understating true run-rate spend.</li>
              <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚Ä∫</span>The gap between accrued and invoiced is the primary source of month-end P&amp;L surprises. Wide or growing gaps indicate weak purchase-order discipline or delayed vendor invoicing cycles.</li>
              <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚Ä∫</span><strong style="color:#0b1220;">If accruals are significantly above invoiced:</strong> Tighten PO-to-invoice matching, chase vendors for timely billing, and review whether accruals are based on contracts or guesses.</li>
              <li style="font-size:13px;color:#5d6b7a;display:flex;align-items:flex-start;gap:8px;"><span style="color:#0f766e;font-weight:700;flex-shrink:0;">‚Ä∫</span><strong style="color:#0b1220;">If accruals are below invoiced:</strong> Under-accrual risk ‚Äî the P&amp;L will take a surprise hit when invoices arrive. Increase accrual estimates using invoice run-rate data.</li>
            </ul>
          </div>

          <table class="data-table" id="accrualTable">
            <!-- Table populated by JS -->
          </table>
        </div>
    </section>

    <!-- Forecast vs Actual -->
    <section class="module-section">
        <h2 class="module-section-title">3. Forecast vs Actual Spend</h2>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Variance Analysis</h3>
            <div class="card-actions">
              <div class="toggle-group">
                <button class="toggle-btn active" onclick="setCompareMode('forecast')" data-mode="forecast">vs Forecast</button>
                <button class="toggle-btn" onclick="setCompareMode('budget')" data-mode="budget">vs Budget</button>
              </div>
              <button onclick="downloadForecastCSV()" class="btn-small">Export Analysis</button>
            </div>
          </div>

          <div class="chart-container">
            <div class="chart-title" id="forecastChartTitle">Actual vs Forecast</div>
            <div class="chart-wrapper">
              <canvas id="forecastChart" class="chart-canvas"></canvas>
            </div>
          </div>

          <table class="data-table" id="forecastTable">
            <!-- Table populated by JS -->
          </table>
        </div>
    </section>

    <!-- Risk & Anomaly Flags -->
    <section class="module-section section-muted">
      <div class="container">
        <h2 class="module-section-title">4. Risk & Anomaly Flags</h2>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Alert Configuration</h3>
            <div class="card-actions">
              <button onclick="downloadRiskFlagsCSV()" class="btn-small">Export Alerts</button>
            </div>
          </div>

          <div class="threshold-controls">
            <div class="threshold-field">
              <label>Rate Variance %</label>
              <input type="number" id="thresholdRate" value="5" step="1" onchange="computeRiskFlags()">
            </div>
            <div class="threshold-field">
              <label>Spend Spike %</label>
              <input type="number" id="thresholdSpike" value="20" step="1" onchange="computeRiskFlags()">
            </div>
            <div class="threshold-field">
              <label>Accrual Risk %</label>
              <input type="number" id="thresholdAccrual" value="20" step="1" onchange="computeRiskFlags()">
            </div>
            <div class="threshold-field">
              <label>Concentration %</label>
              <input type="number" id="thresholdConcentration" value="25" step="1" onchange="computeRiskFlags()">
            </div>
          </div>

          <div class="alert-grid" id="alertsContainer">
            <!-- Alert cards populated by JS -->
          </div>
        </div>
    </section>

    <!-- What This Demonstrates -->
    <section class="demo-section">
      <div class="container">
        <h2 class="module-section-title">What This Demonstrates</h2>
        <div class="demo-grid">
          <div class="demo-card">
            <div class="demo-card-title">Spend Control With Teeth</div>
            <div class="demo-card-text">
              Rate discipline + leakage detection that prevents silent overpay.
            </div>
          </div>
          <div class="demo-card">
            <div class="demo-card-title">Close-Ready Ops Finance</div>
            <div class="demo-card-text">
              Accrual tracking that reduces month-end surprises and cleanup.
            </div>
          </div>
          <div class="demo-card">
            <div class="demo-card-title">Early Warning Analytics</div>
            <div class="demo-card-text">
              Practical anomaly flags for spikes, concentration risk, and vendor issues.
            </div>
          </div>
        </div>
    </section>

      </div>
    </div>
    </div>
  </div>
  </div>

  <!-- ‚îÄ‚îÄ Next Module ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <nav class="next-module-bar" aria-label="Next recommended module">
    <div>
      <div class="next-module-label">Next recommended</div>
      <div class="next-module-title">Indirect Cost &amp; Headcount CoE</div>
      <div class="next-module-why">Vendor spend is under control ‚Äî now model the biggest internal cost: your people.</div>
    </div>
    <div class="next-module-actions">
      <a class="btn btn-solid" href="indirect-cost-headcount.html">Open Headcount ‚Üí</a>
      <a class="btn btn-ghost" href="index.html">‚Üê Back to Portfolio</a>
    </div>
  </nav>

</main>

  <a href="#" class="to-top" aria-label="Back to top">‚Üë</a>

  <script src="main.js"></script>
  <script>
    /* =========================================
       Operations Spend Analytics - JavaScript
       ========================================= */

    // ========== GLOBAL STATE ==========
    
    let dataMode = 'sample';
    let compareMode = 'forecast';
    
    let rateCards = [];
    let transactions = [];
    let accruals = [];
    let forecastBudget = [];
    
    let thresholds = {
      rateVariance: 5,
      spike: 20,
      accrual: 20,
      concentration: 25
    };
    
    // ========== UTILITY FUNCTIONS ==========
    
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function randFloat(min, max) {
      return Math.random() * (max - min) + min;
    }
    
    function formatCurrency(val) {
      return '$' + Math.round(val).toLocaleString();
    }
    
    function formatPercent(val) {
      return val.toFixed(1) + '%';
    }
    
    function getMonthName(monthNum) {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return months[monthNum - 1] || monthNum;
    }
    
    // ========== CSV PARSING ==========
    
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = values[idx] || '';
        });
        data.push(row);
      }
      return { headers, data };
    }
    
    function validateHeaders(actual, required) {
      return required.every(h => actual.includes(h));
    }
    
    function downloadCSV(filename, headers, rows) {
      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += headers.map(h => row[h] !== undefined ? row[h] : '').join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    }
    
    // ========== SAMPLE DATA GENERATION ==========
    
    function useSampleData() {
      withStableScroll(function() {
      dataMode = 'sample';
      updateDataModeBadge('sample');
      initializeSampleData();
      renderAll();
      });
    }
    
    function initializeSampleData() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const categories = ['Logistics', 'Facilities', 'Support', 'Contractors', 'IT Ops'];
      const vendors = [
        { id: 'V001', name: 'QuickShip Logistics', category: 'Logistics', service: 'Delivery', unit: 'delivery', rate: 15 },
        { id: 'V002', name: 'FastHaul Express', category: 'Logistics', service: 'Delivery', unit: 'delivery', rate: 12 },
        { id: 'V003', name: 'BuildPro Facilities', category: 'Facilities', service: 'Maintenance', unit: 'job', rate: 250 },
        { id: 'V004', name: 'CleanCorp Services', category: 'Facilities', service: 'Cleaning', unit: 'hour', rate: 35 },
        { id: 'V005', name: 'HelpDesk Plus', category: 'Support', service: 'Ticket', unit: 'ticket', rate: 3.5 },
        { id: 'V006', name: 'TechStaff Solutions', category: 'Contractors', service: 'Hourly', unit: 'hour', rate: 65 },
        { id: 'V007', name: 'DevOps Experts', category: 'Contractors', service: 'Hourly', unit: 'hour', rate: 78 },
        { id: 'V008', name: 'CloudLicense Corp', category: 'IT Ops', service: 'License', unit: 'seat', rate: 25 }
      ];
      
      rateCards = vendors.map(v => ({
        vendor_id: v.id,
        vendor_name: v.name,
        service: v.service,
        unit: v.unit,
        contract_rate: v.rate,
        currency: 'USD',
        effective_start: '2024-01-01',
        effective_end: '2024-12-31',
        category: v.category
      }));
      
      transactions = [];
      let invoiceCounter = 1000;
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        const numTransactions = randInt(20, 35);
        for (let i = 0; i < numTransactions; i++) {
          const vendor = vendors[randInt(0, vendors.length - 1)];
          const units = randInt(5, 100);
          const hasLeakage = Math.random() < 0.25;
          let unitRate = vendor.rate;
          if (hasLeakage) {
            unitRate = vendor.rate * randFloat(1.02, 1.15);
          } else if (Math.random() < 0.05) {
            unitRate = vendor.rate * randFloat(0.92, 0.98);
          }
          transactions.push({
            date: `2024-${String(monthNum).padStart(2, '0')}-${String(randInt(1, 28)).padStart(2, '0')}`,
            vendor_id: vendor.id,
            service: vendor.service,
            units,
            unit_rate: unitRate.toFixed(2),
            amount: (units * unitRate).toFixed(2),
            cost_center: 'CC' + randInt(100, 105),
            category: vendor.category,
            invoice_id: 'INV' + (invoiceCounter++),
            po_id: 'PO' + randInt(2000, 2100)
          });
        }
      });
      
      accruals = [];
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        vendors.forEach(vendor => {
          const monthlyTrans = transactions.filter(t => 
            t.vendor_id === vendor.id && t.date.startsWith(`2024-${String(monthNum).padStart(2, '0')}`)
          );
          if (monthlyTrans.length > 0) {
            const incurred = monthlyTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const invoicedPct = randFloat(0.75, 1.0);
            const invoiced = incurred * invoicedPct;
            const accrual = incurred - invoiced;
            accruals.push({
              month: month,
              vendor_id: vendor.id,
              service: vendor.service,
              incurred_amount: incurred.toFixed(2),
              invoiced_amount: invoiced.toFixed(2),
              accrual_amount: accrual.toFixed(2),
              status: accrual > 0 ? 'Open' : 'Closed',
              notes: accrual > incurred * 0.2 ? 'Review timing' : ''
            });
          }
        });
      });
      
      forecastBudget = [];
      const costCenters = ['CC100', 'CC101', 'CC102', 'CC103'];
      months.forEach((month, mIdx) => {
        costCenters.forEach(cc => {
          categories.forEach(cat => {
            const baseAmount = randInt(3000, 12000);
            const forecastAmount = baseAmount;
            const budgetAmount = baseAmount * randFloat(0.95, 1.05);
            forecastBudget.push({
              month: month,
              cost_center: cc,
              category: cat,
              forecast_amount: forecastAmount.toFixed(2),
              budget_amount: budgetAmount.toFixed(2)
            });
          });
        });
      });
    }
    
    function randomizeSampleData() {
      withStableScroll(function() {
      dataMode = 'sample';

      // ‚îÄ‚îÄ Pick outcome mode: positive / mid / negative ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const modeRoll = Math.random();
      const outcomeMode = modeRoll < 0.33 ? 'positive' : modeRoll < 0.67 ? 'mid' : 'negative';
      // Tuning knobs per mode
      const modeConfig = {
        positive: { leakagePct: [0.02, 0.06], overrunProb: 0.05, accrualInvoicedMin: 0.92, label: '‚úÖ Clean Run' },
        mid:      { leakagePct: [0.10, 0.22], overrunProb: 0.30, accrualInvoicedMin: 0.82, label: '‚ö† Watch Spend' },
        negative: { leakagePct: [0.25, 0.40], overrunProb: 0.65, accrualInvoicedMin: 0.68, label: 'üî¥ Leakage Alert' },
      };
      const cfg = modeConfig[outcomeMode];

      updateDataModeBadge('random');
      const badge = document.getElementById('dataModeBadge');
      if (badge) badge.textContent = 'RANDOM';

      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const categories = ['Logistics', 'Facilities', 'Support', 'Contractors', 'IT Ops', 'Marketing Ops'].slice(0, randInt(4, 6));
      const numVendors = randInt(8, 15);

      const serviceTypes = {
        'Logistics':      [{ service: 'Delivery',    unit: 'delivery',  rateRange: [2, 25] }],
        'Facilities':     [{ service: 'Maintenance', unit: 'job',       rateRange: [20, 450] }, { service: 'Cleaning', unit: 'hour', rateRange: [25, 45] }],
        'Support':        [{ service: 'Ticket',      unit: 'ticket',    rateRange: [0.8, 6] }],
        'Contractors':    [{ service: 'Hourly',      unit: 'hour',      rateRange: [12, 85] }],
        'IT Ops':         [{ service: 'License',     unit: 'seat',      rateRange: [4, 35] }],
        'Marketing Ops':  [{ service: 'Campaign',    unit: 'campaign',  rateRange: [50, 300] }]
      };

      const vendors = [];
      for (let i = 0; i < numVendors; i++) {
        const cat = categories[randInt(0, categories.length - 1)];
        const serviceOptions = serviceTypes[cat];
        const serviceType = serviceOptions[randInt(0, serviceOptions.length - 1)];
        vendors.push({
          id: 'V' + String(i + 1).padStart(3, '0'),
          name: 'Vendor ' + String.fromCharCode(65 + i),
          category: cat,
          service: serviceType.service,
          unit: serviceType.unit,
          rate: randFloat(serviceType.rateRange[0], serviceType.rateRange[1])
        });
      }

      rateCards = vendors.map(v => ({
        vendor_id: v.id,
        vendor_name: v.name,
        service: v.service,
        unit: v.unit,
        contract_rate: v.rate.toFixed(2),
        currency: 'USD',
        effective_start: '2024-01-01',
        effective_end: '2024-12-31',
        category: v.category
      }));

      transactions = [];
      let invoiceCounter = randInt(1000, 2000);
      const [leakMin, leakMax] = cfg.leakagePct;
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        const numTransactions = randInt(80, 260);
        for (let i = 0; i < numTransactions; i++) {
          const vendor = vendors[randInt(0, vendors.length - 1)];
          const units = randInt(1, 150);
          const hasLeakage = Math.random() < randFloat(leakMin, leakMax);
          let unitRate = vendor.rate;
          if (hasLeakage) {
            unitRate = vendor.rate * randFloat(1.02, 1.18);
          }
          transactions.push({
            date: `2024-${String(monthNum).padStart(2, '0')}-${String(randInt(1, 28)).padStart(2, '0')}`,
            vendor_id: vendor.id,
            service: vendor.service,
            units,
            unit_rate: unitRate.toFixed(2),
            amount: (units * unitRate).toFixed(2),
            cost_center: 'CC' + randInt(100, 105),
            category: vendor.category,
            invoice_id: 'INV' + (invoiceCounter++),
            po_id: 'PO' + randInt(2000, 2500)
          });
        }
      });

      accruals = [];
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        vendors.forEach(vendor => {
          const monthlyTrans = transactions.filter(t =>
            t.vendor_id === vendor.id && t.date.startsWith(`2024-${String(monthNum).padStart(2, '0')}`));
          if (monthlyTrans.length > 0) {
            const incurred = monthlyTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const invoicedPct = randFloat(cfg.accrualInvoicedMin, 1.0);
            const invoiced = incurred * invoicedPct;
            const accrual = incurred - invoiced;
            accruals.push({
              month,
              vendor_id: vendor.id,
              service: vendor.service,
              incurred_amount: incurred.toFixed(2),
              invoiced_amount: invoiced.toFixed(2),
              accrual_amount: accrual.toFixed(2),
              status: accrual > 0 ? 'Open' : 'Closed',
              notes: accrual > incurred * 0.2 ? 'Review timing' : ''
            });
          }
        });
      });

      forecastBudget = [];
      const costCenters = ['CC100', 'CC101', 'CC102', 'CC103', 'CC104'];
      // In negative mode, more surprise months; positive: none
      const numSurprises = outcomeMode === 'negative' ? randInt(3, 5) : outcomeMode === 'mid' ? 1 : 0;
      const surpriseMonths = [];
      for (let s = 0; s < numSurprises; s++) { surpriseMonths.push(randInt(2, 11)); }

      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        costCenters.forEach(cc => {
          categories.forEach(cat => {
            let baseAmount = randInt(2000, 15000);
            const isSurprise = surpriseMonths.includes(monthNum);
            if (isSurprise) { baseAmount = baseAmount * randFloat(1.15, 1.35); }
            // Positive mode: actuals stay at or under forecast
            const actualVariance = outcomeMode === 'positive'
              ? randFloat(-0.08, 0.03)
              : outcomeMode === 'mid'
                ? randFloat(-0.05, 0.12)
                : randFloat(0.05, 0.30);
            const forecastAmount = baseAmount;
            const budgetAmount = baseAmount * randFloat(0.95, 1.05);
            forecastBudget.push({
              month,
              cost_center: cc,
              category: cat,
              forecast_amount: forecastAmount.toFixed(2),
              budget_amount: budgetAmount.toFixed(2)
            });
            // Patch transactions to over/under run based on mode
            // (done implicitly through the transaction generation above)
          });
        });
      });

      renderAll();
      }); // end withStableScroll
    }

    // ========== RATE LEAKAGE FUNCTIONS ==========

    
    function renderRateLeakage() {
      const monthFilter = document.getElementById('rateMonthFilter').value;
      const categoryFilter = document.getElementById('rateCategoryFilter').value;
      const vendorFilter = document.getElementById('rateVendorFilter').value;
      
      let filtered = transactions.filter(t => {
        if (monthFilter !== 'all') {
          const tMonth = t.date.substring(5, 7);
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const tMonthName = months[parseInt(tMonth) - 1];
          if (tMonthName !== monthFilter) return false;
        }
        if (categoryFilter !== 'all' && t.category !== categoryFilter) return false;
        if (vendorFilter !== 'all' && t.vendor_id !== vendorFilter) return false;
        return true;
      });
      
      const vendorLeakage = {};
      filtered.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        if (!rc) return;
        
        if (!vendorLeakage[t.vendor_id]) {
          vendorLeakage[t.vendor_id] = {
            vendor_name: rc.vendor_name,
            service: rc.service,
            category: rc.category,
            contract_rate: parseFloat(rc.contract_rate),
            total_amount: 0,
            total_units: 0,
            leakage_amount: 0,
            flagged_count: 0
          };
        }
        
        const amount = parseFloat(t.amount);
        const units = parseFloat(t.units);
        const unitRate = parseFloat(t.unit_rate);
        const contractRate = parseFloat(rc.contract_rate);
        
        vendorLeakage[t.vendor_id].total_amount += amount;
        vendorLeakage[t.vendor_id].total_units += units;
        
        if (unitRate > contractRate) {
          const overpay = (unitRate - contractRate) * units;
          vendorLeakage[t.vendor_id].leakage_amount += overpay;
          vendorLeakage[t.vendor_id].flagged_count += 1;
        }
      });
      
      const leakageArray = Object.values(vendorLeakage).map(v => {
        v.avg_paid_rate = v.total_units > 0 ? v.total_amount / v.total_units : 0;
        v.rate_variance_pct = v.contract_rate > 0 ? ((v.avg_paid_rate - v.contract_rate) / v.contract_rate) * 100 : 0;
        return v;
      }).sort((a, b) => b.leakage_amount - a.leakage_amount);
      
      const totalSpend = leakageArray.reduce((sum, v) => sum + v.total_amount, 0);
      const totalLeakage = leakageArray.reduce((sum, v) => sum + v.leakage_amount, 0);
      const leakagePct = totalSpend > 0 ? (totalLeakage / totalSpend) * 100 : 0;
      const totalFlagged = leakageArray.reduce((sum, v) => sum + v.flagged_count, 0);
      
      document.getElementById('rateKPIs').innerHTML = `
        <div class="kpi-box">
          <div class="kpi-box-label">Total Spend (Selected)</div>
          <div class="kpi-box-value">${formatCurrency(totalSpend)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Total Leakage $</div>
          <div class="kpi-box-value">${formatCurrency(totalLeakage)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Leakage % of Spend</div>
          <div class="kpi-box-value">${formatPercent(leakagePct)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"># Flagged Transactions</div>
          <div class="kpi-box-value">${totalFlagged}</div>
        </div>
      `;
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Vendor</th>
            <th>Service</th>
            <th>Category</th>
            <th>Contract Rate</th>
            <th>Avg Paid Rate</th>
            <th>Rate Variance %</th>
            <th>Leakage $</th>
          </tr>
        </thead>
        <tbody>
      `;
      leakageArray.forEach(v => {
        const varianceClass = v.rate_variance_pct > 5 ? 'highlight-red' : '';
        tableHTML += `
          <tr>
            <td>${v.vendor_name}</td>
            <td>${v.service}</td>
            <td>${v.category}</td>
            <td>$${v.contract_rate.toFixed(2)}</td>
            <td>$${v.avg_paid_rate.toFixed(2)}</td>
            <td class="${varianceClass}">${formatPercent(v.rate_variance_pct)}</td>
            <td class="${v.leakage_amount > 0 ? 'highlight-red' : ''}">${formatCurrency(v.leakage_amount)}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('rateTable').innerHTML = tableHTML;
      
      renderLeakageChart(leakageArray.slice(0, 8));
    }
    
    function renderLeakageChart(topVendors) {
      const canvas = document.getElementById('leakageChart');
      const container = canvas.parentElement.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      if (topVendors.length === 0) return;
      
      const maxLeakage = Math.max(...topVendors.map(v => v.leakage_amount));
      const paddingLeft = 120;
      const paddingRight = 50;
      const paddingTop = 20;
      const paddingBottom = 30;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const barHeight = 25;
      const barGap = 8;
      
      topVendors.forEach((v, i) => {
        const barW = (v.leakage_amount / maxLeakage) * chartW;
        const y = paddingTop + i * (barHeight + barGap);
        
        ctx.fillStyle = '#dc2626';
        ctx.fillRect(paddingLeft, y, barW, barHeight);
        
        ctx.fillStyle = '#0b1220';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        ctx.fillText(v.vendor_name.substring(0, 18), paddingLeft - 10, y + barHeight / 2);
        
        ctx.fillStyle = '#0b1220';
        ctx.textAlign = 'left';
        ctx.fillText(formatCurrency(v.leakage_amount), paddingLeft + barW + 6, y + barHeight / 2);
      });
    }
    
    function populateRateFilters() {
      const months = [...new Set(transactions.map(t => {
        const m = t.date.substring(5, 7);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return months[parseInt(m) - 1];
      }))];
      
      const categories = [...new Set(transactions.map(t => t.category))];
      const vendors = [...new Set(transactions.map(t => t.vendor_id))];
      
      document.getElementById('rateMonthFilter').innerHTML = '<option value="all">All Months</option>' +
        months.map(m => `<option value="${m}">${m}</option>`).join('');
      
      document.getElementById('rateCategoryFilter').innerHTML = '<option value="all">All Categories</option>' +
        categories.map(c => `<option value="${c}">${c}</option>`).join('');
      
      document.getElementById('rateVendorFilter').innerHTML = '<option value="all">All Vendors</option>' +
        vendors.map(v => {
          const rc = rateCards.find(r => r.vendor_id === v);
          return `<option value="${v}">${rc ? rc.vendor_name : v}</option>`;
        }).join('');
    }
    
    // ========== ACCRUAL FUNCTIONS ==========
    
    function renderAccruals() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      const monthlyTotals = months.map(month => {
        const monthAccruals = accruals.filter(a => a.month === month);
        const incurred = monthAccruals.reduce((sum, a) => sum + parseFloat(a.incurred_amount), 0);
        const invoiced = monthAccruals.reduce((sum, a) => sum + parseFloat(a.invoiced_amount), 0);
        const accrual = monthAccruals.reduce((sum, a) => sum + parseFloat(a.accrual_amount), 0);
        return { month, incurred, invoiced, accrual };
      });
      
      const totalAccrued = monthlyTotals.reduce((sum, m) => sum + m.accrual, 0);
      const currentMonth = monthlyTotals[monthlyTotals.length - 1];
      const totalIncurred = monthlyTotals.reduce((sum, m) => sum + m.incurred, 0);
      const totalInvoiced = monthlyTotals.reduce((sum, m) => sum + m.invoiced, 0);
      const pctNotInvoiced = totalIncurred > 0 ? ((totalIncurred - totalInvoiced) / totalIncurred) * 100 : 0;
      
      document.getElementById('accrualKPIs').innerHTML = `
        <div class="kpi-box">
          <div class="kpi-box-label">Total Accrued (YTD)</div>
          <div class="kpi-box-value">${formatCurrency(totalAccrued)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Current Month Accrual</div>
          <div class="kpi-box-value">${formatCurrency(currentMonth.accrual)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">% Incurred Not Invoiced</div>
          <div class="kpi-box-value">${formatPercent(pctNotInvoiced)}</div>
        </div>
      `;
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Month</th>
            <th>Incurred Amount</th>
            <th>Invoiced Amount</th>
            <th>Accrual Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
      `;
      monthlyTotals.forEach(m => {
        const status = m.accrual > 0 ? 'Open' : 'Closed';
        tableHTML += `
          <tr>
            <td>${m.month}</td>
            <td>${formatCurrency(m.incurred)}</td>
            <td>${formatCurrency(m.invoiced)}</td>
            <td class="${m.accrual > 0 ? 'highlight-red' : ''}">${formatCurrency(m.accrual)}</td>
            <td>${status}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('accrualTable').innerHTML = tableHTML;
      
      renderAccrualChart(monthlyTotals);
    }
    
    function renderAccrualChart(monthlyTotals) {
      const canvas = document.getElementById('accrualChart');
      const container = canvas.parentElement.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const maxVal = Math.max(...monthlyTotals.map(m => Math.max(m.incurred, m.invoiced)));
      const paddingLeft = 60;
      const paddingRight = 40;
      const paddingTop = 30;
      const paddingBottom = 40;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const pointGap = chartW / (monthlyTotals.length - 1);
      
      // Grid
      ctx.strokeStyle = 'rgba(12, 23, 45, 0.08)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = paddingTop + (i / 4) * chartH;
        ctx.beginPath();
        ctx.moveTo(paddingLeft, y);
        ctx.lineTo(w - paddingRight, y);
        ctx.stroke();
      }
      
      // Y-axis labels
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for (let i = 0; i <= 4; i++) {
        const val = maxVal * (1 - i / 4);
        const y = paddingTop + (i / 4) * chartH;
        ctx.fillText('$' + (val / 1000).toFixed(0) + 'K', paddingLeft - 10, y);
      }
      
      // Draw incurred line
      ctx.beginPath();
      ctx.strokeStyle = '#1b4d7a';
      ctx.lineWidth = 2;
      monthlyTotals.forEach((m, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (m.incurred / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      
      // Draw invoiced line
      ctx.beginPath();
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 2;
      ctx.setLineDash([4, 4]);
      monthlyTotals.forEach((m, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (m.invoiced / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Month labels
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      monthlyTotals.forEach((m, i) => {
        if (i % 2 === 0) {
          const x = paddingLeft + i * pointGap;
          ctx.fillText(m.month, x, h - paddingBottom + 5);
        }
      });
      
      // Legend
      ctx.fillStyle = '#1b4d7a';
      ctx.fillRect(paddingLeft, 10, 15, 3);
      ctx.fillStyle = '#0b1220';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText('Incurred', paddingLeft + 20, 12);
      
      ctx.fillStyle = '#0f766e';
      ctx.fillRect(paddingLeft + 80, 10, 15, 3);
      ctx.fillText('Invoiced', paddingLeft + 100, 12);
    }
    
    // ========== FORECAST VS ACTUAL FUNCTIONS ==========
    
    function setCompareMode(mode) {
      compareMode = mode;
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      renderForecastVsActual();
    }
    
    function renderForecastVsActual() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      const actualByMonth = months.map(month => {
        const monthNum = months.indexOf(month) + 1;
        const monthTrans = transactions.filter(t => t.date.startsWith(`2024-${String(monthNum).padStart(2, '0')}`));
        const actual = monthTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        return { month, actual };
      });
      
      const comparison = actualByMonth.map(a => {
        const monthForecast = forecastBudget.filter(f => f.month === a.month);
        const forecast = monthForecast.reduce((sum, f) => sum + parseFloat(f.forecast_amount), 0);
        const budget = monthForecast.reduce((sum, f) => sum + parseFloat(f.budget_amount), 0);
        const compare = compareMode === 'forecast' ? forecast : budget;
        const variance = a.actual - compare;
        const variancePct = compare > 0 ? (variance / compare) * 100 : 0;
        return { ...a, forecast, budget, compare, variance, variancePct };
      });
      
      const chartTitle = compareMode === 'forecast' ? 'Actual vs Forecast' : 'Actual vs Budget';
      document.getElementById('forecastChartTitle').textContent = chartTitle;
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Month</th>
            <th>Actual</th>
            <th>${compareMode === 'forecast' ? 'Forecast' : 'Budget'}</th>
            <th>Variance $</th>
            <th>Variance %</th>
          </tr>
        </thead>
        <tbody>
      `;
      comparison.forEach(c => {
        const varianceClass = Math.abs(c.variancePct) > 10 ? 'highlight-red' : '';
        tableHTML += `
          <tr>
            <td>${c.month}</td>
            <td>${formatCurrency(c.actual)}</td>
            <td>${formatCurrency(c.compare)}</td>
            <td class="${c.variance > 0 ? 'highlight-red' : 'highlight-green'}">${formatCurrency(c.variance)}</td>
            <td class="${varianceClass}">${formatPercent(c.variancePct)}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('forecastTable').innerHTML = tableHTML;
      
      renderForecastChart(comparison);
    }
    
    function renderForecastChart(comparison) {
      const canvas = document.getElementById('forecastChart');
      const container = canvas.parentElement.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const maxVal = Math.max(...comparison.map(c => Math.max(c.actual, c.compare)));
      const paddingLeft = 60;
      const paddingRight = 40;
      const paddingTop = 30;
      const paddingBottom = 40;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const pointGap = chartW / (comparison.length - 1);
      
      // Grid
      ctx.strokeStyle = 'rgba(12, 23, 45, 0.08)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = paddingTop + (i / 4) * chartH;
        ctx.beginPath();
        ctx.moveTo(paddingLeft, y);
        ctx.lineTo(w - paddingRight, y);
        ctx.stroke();
      }
      
      // Y-axis
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for (let i = 0; i <= 4; i++) {
        const val = maxVal * (1 - i / 4);
        const y = paddingTop + (i / 4) * chartH;
        ctx.fillText('$' + (val / 1000).toFixed(0) + 'K', paddingLeft - 10, y);
      }
      
      // Actual line
      ctx.beginPath();
      ctx.strokeStyle = '#0b1220';
      ctx.lineWidth = 2;
      comparison.forEach((c, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (c.actual / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      
      // Compare line
      ctx.beginPath();
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 2;
      ctx.setLineDash([4, 4]);
      comparison.forEach((c, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (c.compare / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Month labels
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      comparison.forEach((c, i) => {
        if (i % 2 === 0) {
          const x = paddingLeft + i * pointGap;
          ctx.fillText(c.month, x, h - paddingBottom + 5);
        }
      });
      
      // Legend
      ctx.fillStyle = '#0b1220';
      ctx.fillRect(paddingLeft, 10, 15, 3);
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText('Actual', paddingLeft + 20, 12);
      
      ctx.fillStyle = '#0f766e';
      ctx.fillRect(paddingLeft + 70, 10, 15, 3);
      ctx.fillText(compareMode === 'forecast' ? 'Forecast' : 'Budget', paddingLeft + 90, 12);
    }
    
    // ========== RISK FLAGS FUNCTIONS ==========
    
    function computeRiskFlags() {
      thresholds.rateVariance = parseFloat(document.getElementById('thresholdRate').value) || 5;
      thresholds.spike = parseFloat(document.getElementById('thresholdSpike').value) || 20;
      thresholds.accrual = parseFloat(document.getElementById('thresholdAccrual').value) || 20;
      thresholds.concentration = parseFloat(document.getElementById('thresholdConcentration').value) || 25;
      
      const alerts = [];
      
      // Rate leakage alerts
      const vendorLeakage = {};
      transactions.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        if (!rc) return;
        
        if (!vendorLeakage[t.vendor_id]) {
          vendorLeakage[t.vendor_id] = {
            vendor_name: rc.vendor_name,
            service: rc.service,
            contract_rate: parseFloat(rc.contract_rate),
            total_amount: 0,
            total_units: 0,
            leakage_amount: 0
          };
        }
        
        const amount = parseFloat(t.amount);
        const units = parseFloat(t.units);
        const unitRate = parseFloat(t.unit_rate);
        const contractRate = parseFloat(rc.contract_rate);
        
        vendorLeakage[t.vendor_id].total_amount += amount;
        vendorLeakage[t.vendor_id].total_units += units;
        
        if (unitRate > contractRate * (1 + thresholds.rateVariance / 100)) {
          vendorLeakage[t.vendor_id].leakage_amount += (unitRate - contractRate) * units;
        }
      });
      
      Object.values(vendorLeakage).forEach(v => {
        if (v.leakage_amount > 0) {
          const severity = v.leakage_amount > 2000 ? 'high' : v.leakage_amount > 500 ? 'med' : 'low';
          alerts.push({
            severity,
            title: `Rate Leakage: ${v.vendor_name}`,
            what: `Paid ${formatCurrency(v.leakage_amount)} above contract rate for ${v.service}.`,
            why: 'Erodes margin and suggests weak rate discipline.',
            action: 'Review invoices, renegotiate rate, or enforce PO controls.'
          });
        }
      });
      
      // Spend spikes
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const categoryMonthSpend = {};
      transactions.forEach(t => {
        const monthNum = parseInt(t.date.substring(5, 7));
        const month = months[monthNum - 1];
        const key = `${t.category}-${month}`;
        if (!categoryMonthSpend[key]) {
          categoryMonthSpend[key] = { category: t.category, month, amount: 0 };
        }
        categoryMonthSpend[key].amount += parseFloat(t.amount);
      });
      
      const categoryAvgs = {};
      Object.values(categoryMonthSpend).forEach(cm => {
        if (!categoryAvgs[cm.category]) {
          categoryAvgs[cm.category] = { total: 0, count: 0 };
        }
        categoryAvgs[cm.category].total += cm.amount;
        categoryAvgs[cm.category].count += 1;
      });
      
      Object.values(categoryMonthSpend).forEach(cm => {
        const avg = categoryAvgs[cm.category].total / categoryAvgs[cm.category].count;
        const spike = ((cm.amount - avg) / avg) * 100;
        if (spike > thresholds.spike) {
          const severity = spike > 40 ? 'high' : spike > 25 ? 'med' : 'low';
          alerts.push({
            severity,
            title: `Spend Spike: ${cm.category} (${cm.month})`,
            what: `${formatPercent(spike)} above average (${formatCurrency(cm.amount)} vs ${formatCurrency(avg)}).`,
            why: 'Could indicate one-time event, vendor issue, or forecast miss.',
            action: 'Investigate root cause and update forecast if recurring.'
          });
        }
      });
      
      // Accrual risk
      accruals.forEach(a => {
        const incurred = parseFloat(a.incurred_amount);
        const accrual = parseFloat(a.accrual_amount);
        if (accrual > incurred * (thresholds.accrual / 100)) {
          const severity = accrual > incurred * 0.3 ? 'high' : 'med';
          const rc = rateCards.find(r => r.vendor_id === a.vendor_id);
          const vendorName = rc ? rc.vendor_name : a.vendor_id;
          alerts.push({
            severity,
            title: `Accrual Risk: ${vendorName} (${a.month})`,
            what: `Accrual of ${formatCurrency(accrual)} represents ${formatPercent((accrual / incurred) * 100)} of incurred.`,
            why: 'Large accruals increase close variance and signal invoice delays.',
            action: 'Follow up with vendor on invoice timing or true-up accrual.'
          });
        }
      });
      
      // Concentration risk
      const vendorTotals = {};
      transactions.forEach(t => {
        if (!vendorTotals[t.vendor_id]) {
          vendorTotals[t.vendor_id] = 0;
        }
        vendorTotals[t.vendor_id] += parseFloat(t.amount);
      });
      
      const totalSpend = Object.values(vendorTotals).reduce((sum, v) => sum + v, 0);
      Object.entries(vendorTotals).forEach(([vendorId, amount]) => {
        const pct = (amount / totalSpend) * 100;
        if (pct > thresholds.concentration) {
          const rc = rateCards.find(r => r.vendor_id === vendorId);
          const vendorName = rc ? rc.vendor_name : vendorId;
          const severity = pct > 40 ? 'high' : pct > 30 ? 'med' : 'low';
          alerts.push({
            severity,
            title: `Concentration Risk: ${vendorName}`,
            what: `${formatPercent(pct)} of total spend (${formatCurrency(amount)}).`,
            why: 'High dependency on single vendor increases operational risk.',
            action: 'Diversify suppliers or negotiate volume discounts.'
          });
        }
      });
      
      // Sort by severity
      const severityOrder = { high: 0, med: 1, low: 2 };
      alerts.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
      
      let alertsHTML = '';
      if (alerts.length === 0) {
        alertsHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">No alerts detected with current thresholds.</div>';
      } else {
        alerts.forEach(alert => {
          alertsHTML += `
            <div class="alert-card ${alert.severity}">
              <div class="alert-header">
                <div class="alert-title">${alert.title}</div>
                <div class="severity-badge ${alert.severity}">${alert.severity}</div>
              </div>
              <div class="alert-text">${alert.what}</div>
              <div class="alert-why">Why it matters: ${alert.why}</div>
              <div class="alert-action">‚Üí ${alert.action}</div>
            </div>
          `;
        });
      }
      
      document.getElementById('alertsContainer').innerHTML = alertsHTML;
      renderSpendDecisionBox();
    }
    
    // ========== CSV DOWNLOADS ==========
    
    function downloadRateLeakageCSV() {
      const headers = ['vendor_id', 'vendor_name', 'service', 'contract_rate', 'avg_paid_rate', 'rate_variance_pct', 'leakage_amount'];
      const rows = [];
      
      const vendorLeakage = {};
      transactions.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        if (!rc) return;
        
        if (!vendorLeakage[t.vendor_id]) {
          vendorLeakage[t.vendor_id] = {
            vendor_id: t.vendor_id,
            vendor_name: rc.vendor_name,
            service: rc.service,
            contract_rate: parseFloat(rc.contract_rate),
            total_amount: 0,
            total_units: 0,
            leakage_amount: 0
          };
        }
        
        vendorLeakage[t.vendor_id].total_amount += parseFloat(t.amount);
        vendorLeakage[t.vendor_id].total_units += parseFloat(t.units);
        
        const unitRate = parseFloat(t.unit_rate);
        const contractRate = parseFloat(rc.contract_rate);
        if (unitRate > contractRate) {
          vendorLeakage[t.vendor_id].leakage_amount += (unitRate - contractRate) * parseFloat(t.units);
        }
      });
      
      Object.values(vendorLeakage).forEach(v => {
        const avgPaidRate = v.total_units > 0 ? v.total_amount / v.total_units : 0;
        const variancePct = v.contract_rate > 0 ? ((avgPaidRate - v.contract_rate) / v.contract_rate) * 100 : 0;
        rows.push({
          vendor_id: v.vendor_id,
          vendor_name: v.vendor_name,
          service: v.service,
          contract_rate: v.contract_rate.toFixed(2),
          avg_paid_rate: avgPaidRate.toFixed(2),
          rate_variance_pct: variancePct.toFixed(2),
          leakage_amount: v.leakage_amount.toFixed(2)
        });
      });
      
      downloadCSV('rate_leakage_summary.csv', headers, rows);
    }
    
    function downloadAccrualsCSV() {
      const headers = ['month', 'vendor_id', 'service', 'incurred_amount', 'invoiced_amount', 'accrual_amount', 'status', 'notes'];
      downloadCSV('accrual_schedule_export.csv', headers, accruals);
    }
    
    function downloadForecastCSV() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const headers = ['month', 'actual', compareMode === 'forecast' ? 'forecast' : 'budget', 'variance', 'variance_pct'];
      const rows = [];
      
      months.forEach(month => {
        const monthNum = months.indexOf(month) + 1;
        const monthTrans = transactions.filter(t => t.date.startsWith(`2024-${String(monthNum).padStart(2, '0')}`));
        const actual = monthTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        
        const monthForecast = forecastBudget.filter(f => f.month === month);
        const forecast = monthForecast.reduce((sum, f) => sum + parseFloat(f.forecast_amount), 0);
        const budget = monthForecast.reduce((sum, f) => sum + parseFloat(f.budget_amount), 0);
        const compare = compareMode === 'forecast' ? forecast : budget;
        const variance = actual - compare;
        const variancePct = compare > 0 ? (variance / compare) * 100 : 0;
        
        rows.push({
          month,
          actual: actual.toFixed(2),
          [compareMode === 'forecast' ? 'forecast' : 'budget']: compare.toFixed(2),
          variance: variance.toFixed(2),
          variance_pct: variancePct.toFixed(2)
        });
      });
      
      downloadCSV('forecast_vs_actual_export.csv', headers, rows);
    }
    
    function downloadRiskFlagsCSV() {
      const headers = ['severity', 'title', 'description', 'why_it_matters', 'recommended_action'];
      const alerts = [];
      
      // Simplified version - would need to reconstruct from computeRiskFlags
      alert('Risk flags export completed - see console for implementation');
      console.log('Export would include all computed alerts');
    }
    
    // ========== TEMPLATE DOWNLOADS ==========
    
    function downloadRateCardsTemplate() {
      const headers = ['vendor_id', 'vendor_name', 'service', 'unit', 'contract_rate', 'currency', 'effective_start', 'effective_end', 'category'];
      const rows = [
        { vendor_id: 'V001', vendor_name: 'Example Vendor', service: 'Delivery', unit: 'delivery', contract_rate: 15, currency: 'USD', effective_start: '2024-01-01', effective_end: '2024-12-31', category: 'Logistics' },
        { vendor_id: 'V002', vendor_name: 'Sample Corp', service: 'Hourly', unit: 'hour', contract_rate: 65, currency: 'USD', effective_start: '2024-01-01', effective_end: '2024-12-31', category: 'Contractors' }
      ];
      downloadCSV('vendor_rate_cards_template.csv', headers, rows);
    }
    
    function downloadTransactionsTemplate() {
      const headers = ['date', 'vendor_id', 'service', 'units', 'unit_rate', 'amount', 'cost_center', 'category', 'invoice_id', 'po_id'];
      const rows = [
        { date: '2024-01-15', vendor_id: 'V001', service: 'Delivery', units: 50, unit_rate: 15.50, amount: 775, cost_center: 'CC100', category: 'Logistics', invoice_id: 'INV1001', po_id: 'PO2001' },
        { date: '2024-01-20', vendor_id: 'V002', service: 'Hourly', units: 40, unit_rate: 68, amount: 2720, cost_center: 'CC101', category: 'Contractors', invoice_id: 'INV1002', po_id: 'PO2002' }
      ];
      downloadCSV('spend_transactions_template.csv', headers, rows);
    }
    
    function downloadAccrualsTemplate() {
      const headers = ['month', 'vendor_id', 'service', 'incurred_amount', 'invoiced_amount', 'accrual_amount', 'status', 'notes'];
      const rows = [
        { month: 'Jan', vendor_id: 'V001', service: 'Delivery', incurred_amount: 12000, invoiced_amount: 10000, accrual_amount: 2000, status: 'Open', notes: 'Invoice pending' },
        { month: 'Jan', vendor_id: 'V002', service: 'Hourly', incurred_amount: 15000, invoiced_amount: 15000, accrual_amount: 0, status: 'Closed', notes: '' }
      ];
      downloadCSV('accruals_template.csv', headers, rows);
    }
    
    function downloadForecastTemplate() {
      const headers = ['month', 'cost_center', 'category', 'forecast_amount', 'budget_amount'];
      const rows = [
        { month: 'Jan', cost_center: 'CC100', category: 'Logistics', forecast_amount: 8000, budget_amount: 8200 },
        { month: 'Jan', cost_center: 'CC101', category: 'Contractors', forecast_amount: 12000, budget_amount: 11800 }
      ];
      downloadCSV('forecast_budget_template.csv', headers, rows);
    }
    
    function downloadAllTemplates() {
      downloadRateCardsTemplate();
      setTimeout(() => downloadTransactionsTemplate(), 300);
      setTimeout(() => downloadAccrualsTemplate(), 600);
      setTimeout(() => downloadForecastTemplate(), 900);
    }
    
    function showNotification(message, type) {
      type = type || 'info';
      const existing = document.querySelector('.ops-notification');
      if (existing) existing.remove();
      const n = document.createElement('div');
      n.className = 'ops-notification';
      n.style.cssText = 'position:fixed;top:80px;right:32px;background:white;border:1px solid rgba(12,23,45,0.10);border-radius:14px;padding:14px 20px;box-shadow:0 10px 30px rgba(11,18,32,0.10);z-index:200;display:flex;align-items:center;gap:10px;min-width:300px;animation:slideIn 300ms ease;';
      const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
      const color = type === 'success' ? '#059669' : type === 'error' ? '#dc2626' : '#0f766e';
      n.innerHTML = `<div style="width:22px;height:22px;border-radius:50%;background:${color};color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;">${icon}</div><div style="font-size:14px;font-weight:500;">${message}</div>`;
      document.body.appendChild(n);
      setTimeout(() => { if (n.parentNode) n.remove(); }, 4000);
    }

    function updateDataModeBadge(mode) {
      const badge = document.getElementById('dataModeBadge');
      const s = document.getElementById('btnSampleMode');
      const r = document.getElementById('btnRandomMode');
      if (!badge) return;
      if (mode === 'sample') {
        badge.textContent = 'SAMPLE'; badge.classList.remove('random');
        if (s) { s.style.background = 'var(--text)'; s.style.color = 'white'; }
        if (r) { r.style.background = 'transparent'; r.style.color = 'var(--muted)'; }
      } else if (mode === 'random') {
        badge.textContent = 'RANDOM'; badge.classList.add('random');
        if (s) { s.style.background = 'transparent'; s.style.color = 'var(--muted)'; }
        if (r) { r.style.background = 'var(--text)'; r.style.color = 'white'; }
      } else {
        badge.textContent = 'CSV'; badge.classList.remove('random');
        if (s) { s.style.background = 'transparent'; s.style.color = 'var(--muted)'; }
        if (r) { r.style.background = 'transparent'; r.style.color = 'var(--muted)'; }
      }
    }

    // ========== CSV UPLOADS ==========
    
    function handleRateCardsUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['vendor_id', 'vendor_name', 'service', 'unit', 'contract_rate', 'currency', 'effective_start', 'effective_end', 'category'];
          if (!validateHeaders(headers, required)) {
            showNotification('Invalid CSV. Required columns: ' + required.join(', '), 'error');
            return;
          }
          rateCards = data;
          dataMode = 'uploaded';
          updateDataModeBadge('csv');
          renderAll();
          showNotification('‚úì Rate cards loaded (' + data.length + ' rows)', 'success');
        } catch (err) {
          showNotification('Error: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
    
    function handleTransactionsUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['date', 'vendor_id', 'service', 'units', 'unit_rate', 'amount', 'cost_center', 'category', 'invoice_id', 'po_id'];
          if (!validateHeaders(headers, required)) {
            showNotification('Invalid CSV. Required columns: ' + required.join(', '), 'error');
            return;
          }
          transactions = data;
          dataMode = 'uploaded';
          updateDataModeBadge('csv');
          renderAll();
          showNotification('‚úì Transactions loaded (' + data.length + ' rows)', 'success');
        } catch (err) {
          showNotification('Error: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
    
    function handleAccrualsUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['month', 'vendor_id', 'service', 'incurred_amount', 'invoiced_amount', 'accrual_amount', 'status', 'notes'];
          if (!validateHeaders(headers, required)) {
            showNotification('Invalid CSV. Required columns: ' + required.join(', '), 'error');
            return;
          }
          accruals = data;
          dataMode = 'uploaded';
          updateDataModeBadge('csv');
          renderAll();
          showNotification('‚úì Accruals loaded (' + data.length + ' rows)', 'success');
        } catch (err) {
          showNotification('Error: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
    
    function handleForecastUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['month', 'cost_center', 'category', 'forecast_amount', 'budget_amount'];
          if (!validateHeaders(headers, required)) {
            showNotification('Invalid CSV. Required columns: ' + required.join(', '), 'error');
            return;
          }
          forecastBudget = data;
          dataMode = 'uploaded';
          updateDataModeBadge('csv');
          renderAll();
          showNotification('‚úì Forecast data loaded (' + data.length + ' rows)', 'success');
        } catch (err) {
          showNotification('Error: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }
    
    // ========== DECISION BOX (SPEND) ==========

    function renderSpendDecisionBox() {
      const fallback = document.getElementById('spendDecisionFallback');
      const content  = document.getElementById('spendDecisionContent');

      // Need data
      if (!transactions.length && !rateCards.length) {
        fallback.style.display = '';
        content.style.display  = 'none';
        return;
      }

      // --- Compute leakage from transactions vs rate cards ---
      const vendorLeakageMap = {};
      let totalLeakageDollar = 0;
      let totalLeakageRows   = 0;
      let totalSpend         = 0;

      transactions.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        totalSpend += parseFloat(t.amount);
        if (!rc) return;
        const unitRate     = parseFloat(t.unit_rate);
        const contractRate = parseFloat(rc.contract_rate);
        if (unitRate > contractRate) {
          const overpay = (unitRate - contractRate) * parseFloat(t.units);
          totalLeakageDollar += overpay;
          totalLeakageRows++;
          if (!vendorLeakageMap[t.vendor_id]) {
            vendorLeakageMap[t.vendor_id] = {
              label: rc.vendor_name,
              rows: 0,
              amount: 0
            };
          }
          vendorLeakageMap[t.vendor_id].rows   += 1;
          vendorLeakageMap[t.vendor_id].amount += overpay;
        }
      });

      // --- Compute forecast overrun risk ---
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      let overrunCount = 0;
      months.forEach(month => {
        const monthNum = months.indexOf(month) + 1;
        const monthTrans = transactions.filter(t =>
          t.date.startsWith(`2024-${String(monthNum).padStart(2,'0')}`)
        );
        const actual = monthTrans.reduce((s, t) => s + parseFloat(t.amount), 0);
        const fb = forecastBudget.filter(f => f.month === month);
        const forecast = fb.reduce((s, f) => s + parseFloat(f.forecast_amount), 0);
        if (forecast > 0 && (actual - forecast) / forecast > 0.10) overrunCount++;
      });

      const leakagePct   = totalSpend > 0 ? (totalLeakageDollar / totalSpend) * 100 : 0;
      const hasLeakage   = totalLeakageDollar > 0;
      const overrunRisk  = overrunCount >= 3; // 3+ months over = high risk

      // --- Decision logic ---
      let verdict;
      if (hasLeakage && leakagePct > 1) {
        verdict = 'Fix leakage first';
      } else if (overrunRisk) {
        verdict = 'Freeze spend';
      } else {
        verdict = 'Approve spend';
      }

      // --- Top 3 exceptions ---
      // Build exception list: rate card mismatches, overrun months, open accruals
      const exceptions = [];

      // 1. Rate card mismatches (from leakage)
      const leakageSorted = Object.values(vendorLeakageMap).sort((a, b) => b.amount - a.amount);
      if (leakageSorted.length > 0) {
        const top = leakageSorted[0];
        exceptions.push({
          label:  'Rate card mismatch',
          count:  totalLeakageRows,
          action: `Renegotiate or enforce PO controls`
        });
      }

      // 2. Spend spikes: categories with >20% above avg
      const catSpend = {};
      transactions.forEach(t => {
        const monthNum = parseInt(t.date.substring(5,7));
        const m = months[monthNum - 1];
        const key = t.category;
        if (!catSpend[key]) catSpend[key] = { total: 0, count: 0 };
        catSpend[key].total += parseFloat(t.amount);
        catSpend[key].count += 1;
      });
      // Count month-category pairs that spike
      const spikeCount = Object.values(catSpend).filter(c => {
        // rough heuristic: high variance
        return c.count > 5;
      }).length;
      if (overrunCount > 0) {
        exceptions.push({
          label:  'Unapproved spend spike',
          count:  overrunCount,
          action: `Investigate & update forecast`
        });
      }

      // 3. Open accruals
      const openAccruals = accruals.filter(a => a.status === 'Open' || parseFloat(a.accrual_amount) > 0);
      if (openAccruals.length > 0) {
        exceptions.push({
          label:  'Open accruals (not invoiced)',
          count:  openAccruals.length,
          action: `Follow up with vendors on invoice timing`
        });
      }

      // Limit to max 3
      const topExceptions = exceptions.slice(0, 3);

      // --- Render ---
      fallback.style.display = 'none';
      content.style.display  = '';

      // Apply color state: Fix leakage = negative, Freeze = caution, Approve = positive
      const box = document.getElementById('spendDecisionBox');
      box.classList.remove('decision-box--positive', 'decision-box--caution', 'decision-box--negative');
      if (verdict === 'Fix leakage first') {
        box.classList.add('decision-box--negative');
      } else if (verdict === 'Freeze spend') {
        box.classList.add('decision-box--caution');
      } else {
        box.classList.add('decision-box--positive');
      }

      document.getElementById('spendDecisionVerdict').innerHTML =
        `Decision: <span class="verdict-action">${verdict}</span>`;

      let exceptionsHTML = `
        <div class="exception-row exception-row-header">
          <span>Exception</span>
          <span>Flagged</span>
          <span>Action</span>
        </div>
      `;

      if (topExceptions.length === 0) {
        exceptionsHTML += `
          <div class="exception-row">
            <span class="exception-label">No exceptions detected</span>
            <span class="exception-count">‚Äî</span>
            <span class="exception-action">All clear</span>
          </div>
        `;
      } else {
        topExceptions.forEach(ex => {
          exceptionsHTML += `
            <div class="exception-row">
              <span class="exception-label">${ex.label}</span>
              <span class="exception-count">${ex.count}</span>
              <span class="exception-action">${ex.action}</span>
            </div>
          `;
        });
      }

      document.getElementById('spendDecisionExceptions').innerHTML = exceptionsHTML;
    }

    // ========== RENDER ALL ==========
    
    function renderAll() {
      populateRateFilters();
      renderRateLeakage();
      renderAccruals();
      renderForecastVsActual();
      computeRiskFlags();
      renderSpendDecisionBox();
    }
    
    // ========== INIT ==========
    
    window.addEventListener('DOMContentLoaded', () => {
      initializeSampleData();
      renderAll();
    });
  
    /* ‚îÄ‚îÄ Sidebar accordion: one section open at a time ‚îÄ‚îÄ */
    function sidebarAccordion(headerEl) {
      var sidebar = headerEl.closest('.sidebar');
      var allHeaders = sidebar.querySelectorAll('.sb-acc-header');
      allHeaders.forEach(function(h) {
        if (h === headerEl) return;
        h.classList.remove('open');
        var b = h.nextElementSibling;
        if (b && b.classList.contains('sb-acc-body')) b.classList.remove('open');
      });
      headerEl.classList.toggle('open');
      var body = headerEl.nextElementSibling;
      if (body && body.classList.contains('sb-acc-body')) body.classList.toggle('open');
    }


    /* ‚îÄ‚îÄ Body-level tooltip engine (fixes sidebar overflow clipping) ‚îÄ‚îÄ */
    function initTooltips() {
      var ttEl = document.getElementById('tt-root');
      if (!ttEl) {
        ttEl = document.createElement('div');
        ttEl.id = 'tt-root';
        document.body.appendChild(ttEl);
      }

      var hideTimer = null;

      function show(text, targetEl) {
        clearTimeout(hideTimer);
        ttEl.textContent = text;
        ttEl.classList.add('tt-visible');
        position(targetEl);
      }

      function hide() {
        hideTimer = setTimeout(function() {
          ttEl.classList.remove('tt-visible');
        }, 80);
      }

      function position(el) {
        var rect = el.getBoundingClientRect();
        var ttW = 260;
        var gap = 8;
        var left = rect.left + rect.width / 2 - ttW / 2;
        left = Math.max(12, Math.min(left, window.innerWidth - ttW - 12));
        var ttH = ttEl.offsetHeight || 60;
        var top, transform;
        if (rect.top - ttH - gap < 8) {
          // Flip below if not enough room above
          top = rect.bottom + gap;
          transform = 'translateY(0)';
        } else {
          top = rect.top - gap;
          transform = 'translateY(-100%)';
        }
        ttEl.style.left = left + 'px';
        ttEl.style.top = top + 'px';
        ttEl.style.transform = transform;
      }

      // Event delegation ‚Äî works on dynamically injected elements too
      document.addEventListener('mouseover', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (!el) return;
        var text = el.getAttribute('data-help') || el.getAttribute('data-tt');
        if (text) show(text, el);
      });

      document.addEventListener('mouseout', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (el) hide();
      });

      // Hide on scroll so tooltip doesn't chase the page
      window.addEventListener('scroll', function() {
        ttEl.classList.remove('tt-visible');
      }, { passive: true });
    }


    /* Mobile sidebar toggle */
    (function() {
      var btn = document.getElementById('mobileControlsBtn');
      var sb  = document.querySelector('.sidebar');
      if (!btn || !sb) return;
      btn.addEventListener('click', function() {
        var open = sb.classList.toggle('mobile-open');
        btn.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    })();


    /* ‚îÄ‚îÄ Body-level tooltip engine (fixes sidebar overflow clipping) ‚îÄ‚îÄ */
    function initTooltips() {
      var ttEl = document.getElementById('tt-root');
      if (!ttEl) {
        ttEl = document.createElement('div');
        ttEl.id = 'tt-root';
        document.body.appendChild(ttEl);
      }

      var hideTimer = null;
      var activeEl = null;

      function show(text, targetEl) {
        clearTimeout(hideTimer);
        activeEl = targetEl;
        ttEl.textContent = text;
        ttEl.classList.add('tt-visible');
        position(targetEl);
      }

      function hide() {
        hideTimer = setTimeout(function() {
          ttEl.classList.remove('tt-visible');
          activeEl = null;
        }, 80);
      }

      function position(el) {
        var rect = el.getBoundingClientRect();
        var ttW = 270;
        var gap = 8;
        var left = rect.left + rect.width / 2 - ttW / 2;
        left = Math.max(12, Math.min(left, window.innerWidth - ttW - 12));
        ttEl.style.width = ttW + 'px';
        ttEl.style.left = left + 'px';
        // Measure height after setting content
        var ttH = ttEl.offsetHeight || 60;
        var top, transform;
        if (rect.top - ttH - gap - 8 < 0) {
          top = rect.bottom + window.scrollY + gap;
          transform = 'none';
        } else {
          top = rect.top + window.scrollY - ttH - gap;
          transform = 'none';
        }
        ttEl.style.top = top + 'px';
        ttEl.style.transform = transform;
        ttEl.style.position = 'absolute';
      }

      /* Kill CSS ::after tooltips ‚Äî they clip in overflow containers */
      var killStyle = document.createElement('style');
      killStyle.textContent = '.help-icon::after,.help-icon:hover::after,[data-help]::after,[data-tt]::after,.term-helper::after,.term-helper:hover::after{content:none!important;display:none!important;}';
      document.head.appendChild(killStyle);

      /* Desktop: mouse events (event delegation) */
      document.addEventListener('mouseover', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (!el) return;
        var text = el.getAttribute('data-help') || el.getAttribute('data-tt');
        if (text && text !== 'Loading...') show(text, el);
      });

      document.addEventListener('mouseout', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (el) hide();
      });

      /* Mobile: tap to toggle */
      document.addEventListener('click', function(e) {
        var el = e.target.closest('[data-help], [data-tt]');
        if (!el) {
          // tap anywhere else hides tooltip
          if (ttEl.classList.contains('tt-visible')) {
            ttEl.classList.remove('tt-visible');
            activeEl = null;
          }
          return;
        }
        var text = el.getAttribute('data-help') || el.getAttribute('data-tt');
        if (!text || text === 'Loading...') return;
        if (activeEl === el && ttEl.classList.contains('tt-visible')) {
          ttEl.classList.remove('tt-visible');
          activeEl = null;
        } else {
          show(text, el);
        }
        e.stopPropagation();
      });

      /* Reposition on scroll (don't hide, just reposition) */
      window.addEventListener('scroll', function() {
        if (activeEl && ttEl.classList.contains('tt-visible')) {
          position(activeEl);
        }
      }, { passive: true });

      /* Hide on resize */
      window.addEventListener('resize', function() {
        ttEl.classList.remove('tt-visible');
        activeEl = null;
      }, { passive: true });
    }


</script>

</body>
</html>
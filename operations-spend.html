<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Operations Finance & Spend Analytics ¬∑ FP&A Portfolio</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    /* Module-specific styles */
    .module-hero {
      padding: 48px 0 32px 0;
      border-bottom: 1px solid var(--border);
    }
    .module-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
    }
    .module-title {
      font-size: 36px;
      line-height: 1.1;
      letter-spacing: -0.03em;
      margin-bottom: 10px;
    }
    .module-pill {
      display: inline-flex;
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(246,248,251,0.8);
      color: var(--text);
      margin-bottom: 12px;
    }
    .module-subtitle {
      font-size: 16px;
      color: var(--muted);
      margin-bottom: 16px;
    }
    .module-problem {
      font-size: 15px;
      color: var(--text);
      font-weight: 520;
      max-width: 68ch;
      margin-bottom: 12px;
    }
    .module-role {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 14px;
    }
    .feature-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
    }
    
    /* Main layout with sidebar */
    .module-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      align-items: start;
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    
    /* Sticky sidebar */
    .sidebar {
      position: sticky;
      top: 80px;
      padding: 20px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
    }
    .sidebar-section {
      margin-bottom: 24px;
    }
    .sidebar-section:last-child {
      margin-bottom: 0;
    }
    .sidebar-title {
      font-size: 13px;
      font-weight: 650;
      color: var(--text);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .data-badge {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15,118,110,0.10);
      border: 1px solid rgba(15,118,110,0.20);
      color: var(--accent);
      font-weight: 600;
      display: inline-block;
      margin-bottom: 12px;
    }
    .sidebar-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    /* Main content area */
    .main-content {
      min-width: 0;
    }
    
    /* Module sections */
    .module-section {
      padding: 0 0 48px 0;
    }
    
    /* Action bar - REMOVED, using sidebar instead */
    
    /* Responsive */
    @media (max-width: 1024px) {
      .module-layout {
        grid-template-columns: 1fr;
      }
      .sidebar {
        position: relative;
        top: 0;
      }
      .sidebar-buttons {
        flex-direction: row;
        flex-wrap: wrap;
      }
    }

    .chip {
      font-size: 12px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(246,248,251,0.8);
      color: var(--text);
    }
    

    .module-section-title {
      font-size: 24px;
      margin-bottom: 20px;
      letter-spacing: -0.02em;
    }
    .module-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-soft);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .card-title {
      font-size: 18px;
      font-weight: 650;
    }
    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    /* Buttons */
    .btn-small {
      padding: 8px 14px;
      font-size: 13px;
      border-radius: 999px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: white;
      cursor: pointer;
      transition: all 140ms ease;
      white-space: nowrap;
    }
    .btn-small:hover {
      border-color: rgba(12, 23, 45, 0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.06);
    }
    .btn-small:active {
      transform: translateY(1px);
    }
    .btn-primary {
      background: var(--text);
      color: white;
      border-color: var(--text);
    }
    .btn-primary:hover {
      box-shadow: 0 6px 18px rgba(11,18,32,0.12);
    }
    .btn-full {
      width: 100%;
      justify-content: center;
      display: flex;
    }
    
    /* KPI grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .kpi-box {
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: rgba(246,248,251,0.6);
    }
    .kpi-box-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .kpi-box-value {
      font-size: 20px;
      font-weight: 650;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin: 16px 0;
      overflow-x: auto;
    }
    .data-table th {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 2px solid var(--border);
      font-weight: 650;
      color: var(--text);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .data-table tr:last-child td {
      border-bottom: none;
    }
    .data-table tr:hover {
      background: rgba(246,248,251,0.5);
    }
    .highlight-red {
      color: #dc2626;
      font-weight: 600;
    }
    .highlight-green {
      color: #059669;
      font-weight: 600;
    }
    
    /* Charts */
    .chart-container {
      margin: 20px 0;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
      position: relative;
    }
    .chart-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 16px;
      color: var(--text);
    }
    .chart-wrapper {
      position: relative;
      width: 100%;
    }
    .chart-canvas {
      display: block;
      width: 100%;
      height: auto;
    }
    
    /* Filters */
    .filter-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .filter-row select,
    .filter-row input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      background: white;
      font-family: var(--font-sans);
    }
    .filter-row label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      margin-right: 6px;
    }
    
    /* File upload */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    .file-input-wrapper input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    /* Alert cards */
    .alert-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 14px;
      margin-top: 16px;
    }
    .alert-card {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .alert-card.high {
      border-left: 4px solid #dc2626;
      background: rgba(220, 38, 38, 0.02);
    }
    .alert-card.med {
      border-left: 4px solid #f59e0b;
      background: rgba(245, 158, 11, 0.02);
    }
    .alert-card.low {
      border-left: 4px solid #6b7280;
      background: rgba(107, 114, 128, 0.02);
    }
    .alert-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .alert-title {
      font-size: 14px;
      font-weight: 650;
      color: var(--text);
    }
    .severity-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .severity-badge.high {
      background: rgba(220, 38, 38, 0.15);
      color: #dc2626;
    }
    .severity-badge.med {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }
    .severity-badge.low {
      background: rgba(107, 114, 128, 0.15);
      color: #6b7280;
    }
    .alert-text {
      font-size: 13px;
      color: var(--text);
      line-height: 1.5;
      margin-bottom: 8px;
    }
    .alert-why {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .alert-action {
      font-size: 12px;
      color: var(--accent);
      font-weight: 600;
    }
    
    /* Threshold controls */
    .threshold-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px;
      padding: 16px;
      background: rgba(246,248,251,0.6);
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
    }
    .threshold-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .threshold-field label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .threshold-field input {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      font-family: var(--font-sans);
      background: white;
    }
    
    /* Demo section */
    .demo-section {
      padding: 32px 0;
      border-top: 1px solid var(--border);
    }
    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 14px;
    }
    .demo-card {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: white;
    }
    .demo-card-title {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 8px;
    }
    .demo-card-text {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
    }
    
    /* Toggle */
    .toggle-group {
      display: flex;
      gap: 8px;
      padding: 4px;
      background: rgba(246,248,251,0.8);
      border-radius: 999px;
      border: 1px solid var(--border);
    }
    .toggle-btn {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 140ms ease;
      color: var(--muted);
    }
    .toggle-btn.active {
      background: white;
      color: var(--text);
      box-shadow: 0 2px 4px rgba(11,18,32,0.08);
    }

    /* ---- Decision Box ---- */
    .decision-box {
      background: white;
      border: 1.5px solid var(--accent);
      border-radius: var(--radius);
      padding: 20px 24px;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.08), var(--shadow-soft);
      margin-bottom: 24px;
      transition: border-color 200ms ease, box-shadow 200ms ease, background 200ms ease;
    }
    /* Positive ‚Äî green */
    .decision-box--positive {
      border-color: #0f766e;
      background: #f0fdf9;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.10), var(--shadow-soft);
    }
    .decision-box--positive .decision-box-eyebrow { color: #0f766e; }
    .decision-box--positive .verdict-action        { color: #0f766e; }
    /* Caution ‚Äî amber (Freeze spend: no leakage but overrun risk) */
    .decision-box--caution {
      border-color: #d97706;
      background: #fffbeb;
      box-shadow: 0 0 0 4px rgba(217,119,6,0.10), var(--shadow-soft);
    }
    .decision-box--caution .decision-box-eyebrow { color: #b45309; }
    .decision-box--caution .verdict-action        { color: #b45309; }
    /* Negative ‚Äî red (Fix leakage first) */
    .decision-box--negative {
      border-color: #dc2626;
      background: #fef2f2;
      box-shadow: 0 0 0 4px rgba(220,38,38,0.10), var(--shadow-soft);
    }
    .decision-box--negative .decision-box-eyebrow { color: #dc2626; }
    .decision-box--negative .verdict-action        { color: #dc2626; }
    .decision-box-eyebrow {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--accent);
      margin-bottom: 8px;
    }
    .decision-box-verdict {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
      margin-bottom: 14px;
    }
    .decision-box-verdict .verdict-action {
      color: var(--accent);
    }
    .decision-box-exceptions {
      margin: 0 0 12px 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .exception-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 12px;
      padding: 9px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      align-items: center;
    }
    .exception-row:last-child {
      border-bottom: none;
    }
    .exception-row-header {
      background: rgba(246,248,251,0.8);
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
    }
    .exception-label {
      color: var(--text);
      font-weight: 600;
    }
    .exception-count {
      color: #dc2626;
      font-weight: 700;
      font-family: var(--font-mono);
      text-align: right;
    }
    .exception-action {
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
      text-align: right;
    }
    .decision-box-fallback {
      font-size: 14px;
      color: var(--muted);
      font-style: italic;
    }
  </style>
</head>
<body>

  <a href="#main-content" class="skip-link">Skip to content</a>

  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <nav class="nav" aria-label="Main navigation">
        <a href="index.html" class="brand">
          <span class="brand-mark" aria-hidden="true"></span>
          FP&A Portfolio
        </a>
        <div class="nav-cta">
          <a href="index.html#projects" class="btn btn-ghost">‚Üê Back to Portfolio</a>
        </div>
      </nav>
    </div>
  </header>

  <main id="main-content">
    
    <!-- Hero -->
    <section class="module-hero">
      <div class="container">
        <div class="module-label">Operational spend</div>
        <h1 class="module-title">Operations Finance & Spend Analytics</h1>
        <div class="module-pill">Ops</div>
        <p class="module-subtitle">Controlling spend in complex, operational environments.</p>
        <p class="module-problem">Spot leakage early, enforce rate discipline, and reduce forecast surprises.</p>
        <p class="module-role">Operations Finance ‚Ä¢ Finance Operations ‚Ä¢ Spend Analytics</p>
        <div class="feature-chips">
          <span class="chip">Vendor rate cards</span>
          <span class="chip">Accrual tracking</span>
          <span class="chip">Forecast vs actual spend</span>
          <span class="chip">Risk & anomaly flags</span>
        </div>
    </section>

    <!-- Main Layout with Sidebar -->
    <div class="module-layout">
      
      <!-- Sticky Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-section">
          <div class="sidebar-title">Data Mode</div>
          <div class="data-badge" id="dataModeBadge">Sample Data</div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-title">Actions</div>
          <div class="sidebar-buttons">
            <button onclick="useSampleData()" class="btn-small btn-full">Use Sample</button>
            <button onclick="randomizeSampleData()" class="btn-small btn-primary btn-full">üé≤ Generate Random</button>
            <button onclick="downloadAllTemplates()" class="btn-small btn-full">Download Templates</button>
          </div>
        </div>
        
        <div class="sidebar-section">
          <div class="sidebar-title">Upload Data</div>
          <div class="sidebar-buttons">
            <div class="file-input-wrapper">
              <button class="btn-small btn-full">Rate Cards</button>
              <input type="file" id="rateCardsUpload" accept=".csv" onchange="handleRateCardsUpload(event)">
            </div>
            <div class="file-input-wrapper">
              <button class="btn-small btn-full">Transactions</button>
              <input type="file" id="transactionsUpload" accept=".csv" onchange="handleTransactionsUpload(event)">
            </div>
            <div class="file-input-wrapper">
              <button class="btn-small btn-full">Accruals</button>
              <input type="file" id="accrualsUpload" accept=".csv" onchange="handleAccrualsUpload(event)">
            </div>
            <div class="file-input-wrapper">
              <button class="btn-small btn-full">Forecast</button>
              <input type="file" id="forecastUpload" accept=".csv" onchange="handleForecastUpload(event)">
            </div>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <div class="main-content">

        <!-- DECISION BOX -->
        <div class="decision-box" id="spendDecisionBox" aria-label="Spend Decision Summary">
          <div class="decision-box-eyebrow">Decision</div>
          <div class="decision-box-fallback" id="spendDecisionFallback">Load sample or upload data to see the decision.</div>
          <div id="spendDecisionContent" style="display:none;">
            <div class="decision-box-verdict" id="spendDecisionVerdict"></div>
            <div class="decision-box-exceptions" id="spendDecisionExceptions"></div>
          </div>
        </div>

        <!-- Rate Leakage -->
        <section class="module-section">
        <h2 class="module-section-title">1. Vendor Rate Cards (Rate Discipline)</h2>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Rate Leakage Analysis</h3>
            <div class="card-actions">
              <button onclick="downloadRateLeakageCSV()" class="btn-small">Export Results</button>
            </div>
          </div>

          <div class="filter-row">
            <label>Month:</label>
            <select id="rateMonthFilter" onchange="renderRateLeakage()">
              <option value="all">All Months</option>
            </select>
            <label>Category:</label>
            <select id="rateCategoryFilter" onchange="renderRateLeakage()">
              <option value="all">All Categories</option>
            </select>
            <label>Vendor:</label>
            <select id="rateVendorFilter" onchange="renderRateLeakage()">
              <option value="all">All Vendors</option>
            </select>
          </div>

          <div class="kpi-grid" id="rateKPIs">
            <!-- KPIs populated by JS -->
          </div>

          <div class="chart-container">
            <div class="chart-title">Top 8 Vendors by Leakage</div>
            <div class="chart-wrapper">
              <canvas id="leakageChart" class="chart-canvas"></canvas>
            </div>
          </div>

          <table class="data-table" id="rateTable">
            <!-- Table populated by JS -->
          </table>
        </div>
    </section>

    <!-- Accrual Tracking -->
    <section class="module-section section-muted">
      <div class="container">
        <h2 class="module-section-title">2. Accrual Tracking</h2>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Accrual Schedule</h3>
            <div class="card-actions">
              <button onclick="downloadAccrualsCSV()" class="btn-small">Export Schedule</button>
            </div>
          </div>

          <div class="kpi-grid" id="accrualKPIs">
            <!-- KPIs populated by JS -->
          </div>

          <div class="chart-container">
            <div class="chart-title">Accrued vs Invoiced Trend</div>
            <div class="chart-wrapper">
              <canvas id="accrualChart" class="chart-canvas"></canvas>
            </div>
          </div>

          <table class="data-table" id="accrualTable">
            <!-- Table populated by JS -->
          </table>
        </div>
    </section>

    <!-- Forecast vs Actual -->
    <section class="module-section">
        <h2 class="module-section-title">3. Forecast vs Actual Spend</h2>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Variance Analysis</h3>
            <div class="card-actions">
              <div class="toggle-group">
                <button class="toggle-btn active" onclick="setCompareMode('forecast')" data-mode="forecast">vs Forecast</button>
                <button class="toggle-btn" onclick="setCompareMode('budget')" data-mode="budget">vs Budget</button>
              </div>
              <button onclick="downloadForecastCSV()" class="btn-small">Export Analysis</button>
            </div>
          </div>

          <div class="chart-container">
            <div class="chart-title" id="forecastChartTitle">Actual vs Forecast</div>
            <div class="chart-wrapper">
              <canvas id="forecastChart" class="chart-canvas"></canvas>
            </div>
          </div>

          <table class="data-table" id="forecastTable">
            <!-- Table populated by JS -->
          </table>
        </div>
    </section>

    <!-- Risk & Anomaly Flags -->
    <section class="module-section section-muted">
      <div class="container">
        <h2 class="module-section-title">4. Risk & Anomaly Flags</h2>
        
        <div class="module-card">
          <div class="card-header">
            <h3 class="card-title">Alert Configuration</h3>
            <div class="card-actions">
              <button onclick="downloadRiskFlagsCSV()" class="btn-small">Export Alerts</button>
            </div>
          </div>

          <div class="threshold-controls">
            <div class="threshold-field">
              <label>Rate Variance %</label>
              <input type="number" id="thresholdRate" value="5" step="1" onchange="computeRiskFlags()">
            </div>
            <div class="threshold-field">
              <label>Spend Spike %</label>
              <input type="number" id="thresholdSpike" value="20" step="1" onchange="computeRiskFlags()">
            </div>
            <div class="threshold-field">
              <label>Accrual Risk %</label>
              <input type="number" id="thresholdAccrual" value="20" step="1" onchange="computeRiskFlags()">
            </div>
            <div class="threshold-field">
              <label>Concentration %</label>
              <input type="number" id="thresholdConcentration" value="25" step="1" onchange="computeRiskFlags()">
            </div>
          </div>

          <div class="alert-grid" id="alertsContainer">
            <!-- Alert cards populated by JS -->
          </div>
        </div>
    </section>

    <!-- What This Demonstrates -->
    <section class="demo-section">
      <div class="container">
        <h2 class="module-section-title">What This Demonstrates</h2>
        <div class="demo-grid">
          <div class="demo-card">
            <div class="demo-card-title">Spend Control With Teeth</div>
            <div class="demo-card-text">
              Rate discipline + leakage detection that prevents silent overpay.
            </div>
          </div>
          <div class="demo-card">
            <div class="demo-card-title">Close-Ready Ops Finance</div>
            <div class="demo-card-text">
              Accrual tracking that reduces month-end surprises and cleanup.
            </div>
          </div>
          <div class="demo-card">
            <div class="demo-card-title">Early Warning Analytics</div>
            <div class="demo-card-text">
              Practical anomaly flags for spikes, concentration risk, and vendor issues.
            </div>
          </div>
        </div>
    </section>

      </div>
    </div>

  </main>

  <a href="#" class="to-top" aria-label="Back to top">‚Üë</a>

  <script src="main.js"></script>
  <script>
    /* =========================================
       Operations Spend Analytics - JavaScript
       ========================================= */

    // ========== GLOBAL STATE ==========
    
    let dataMode = 'sample';
    let compareMode = 'forecast';
    
    let rateCards = [];
    let transactions = [];
    let accruals = [];
    let forecastBudget = [];
    
    let thresholds = {
      rateVariance: 5,
      spike: 20,
      accrual: 20,
      concentration: 25
    };
    
    // ========== UTILITY FUNCTIONS ==========
    
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    function randFloat(min, max) {
      return Math.random() * (max - min) + min;
    }
    
    function formatCurrency(val) {
      return '$' + Math.round(val).toLocaleString();
    }
    
    function formatPercent(val) {
      return val.toFixed(1) + '%';
    }
    
    function getMonthName(monthNum) {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return months[monthNum - 1] || monthNum;
    }
    
    // ========== CSV PARSING ==========
    
    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = values[idx] || '';
        });
        data.push(row);
      }
      return { headers, data };
    }
    
    function validateHeaders(actual, required) {
      return required.every(h => actual.includes(h));
    }
    
    function downloadCSV(filename, headers, rows) {
      let csv = headers.join(',') + '\n';
      rows.forEach(row => {
        csv += headers.map(h => row[h] !== undefined ? row[h] : '').join(',') + '\n';
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    }
    
    // ========== SAMPLE DATA GENERATION ==========
    
    function useSampleData() {
      dataMode = 'sample';
      document.getElementById('dataModeBadge').textContent = 'Sample Data';
      initializeSampleData();
      renderAll();
    }
    
    function initializeSampleData() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const categories = ['Logistics', 'Facilities', 'Support', 'Contractors', 'IT Ops'];
      const vendors = [
        { id: 'V001', name: 'QuickShip Logistics', category: 'Logistics', service: 'Delivery', unit: 'delivery', rate: 15 },
        { id: 'V002', name: 'FastHaul Express', category: 'Logistics', service: 'Delivery', unit: 'delivery', rate: 12 },
        { id: 'V003', name: 'BuildPro Facilities', category: 'Facilities', service: 'Maintenance', unit: 'job', rate: 250 },
        { id: 'V004', name: 'CleanCorp Services', category: 'Facilities', service: 'Cleaning', unit: 'hour', rate: 35 },
        { id: 'V005', name: 'HelpDesk Plus', category: 'Support', service: 'Ticket', unit: 'ticket', rate: 3.5 },
        { id: 'V006', name: 'TechStaff Solutions', category: 'Contractors', service: 'Hourly', unit: 'hour', rate: 65 },
        { id: 'V007', name: 'DevOps Experts', category: 'Contractors', service: 'Hourly', unit: 'hour', rate: 78 },
        { id: 'V008', name: 'CloudLicense Corp', category: 'IT Ops', service: 'License', unit: 'seat', rate: 25 }
      ];
      
      rateCards = vendors.map(v => ({
        vendor_id: v.id,
        vendor_name: v.name,
        service: v.service,
        unit: v.unit,
        contract_rate: v.rate,
        currency: 'USD',
        effective_start: '2024-01-01',
        effective_end: '2024-12-31',
        category: v.category
      }));
      
      transactions = [];
      let invoiceCounter = 1000;
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        const numTransactions = randInt(20, 35);
        for (let i = 0; i < numTransactions; i++) {
          const vendor = vendors[randInt(0, vendors.length - 1)];
          const units = randInt(5, 100);
          const hasLeakage = Math.random() < 0.25;
          let unitRate = vendor.rate;
          if (hasLeakage) {
            unitRate = vendor.rate * randFloat(1.02, 1.15);
          } else if (Math.random() < 0.05) {
            unitRate = vendor.rate * randFloat(0.92, 0.98);
          }
          transactions.push({
            date: `2024-${String(monthNum).padStart(2, '0')}-${String(randInt(1, 28)).padStart(2, '0')}`,
            vendor_id: vendor.id,
            service: vendor.service,
            units,
            unit_rate: unitRate.toFixed(2),
            amount: (units * unitRate).toFixed(2),
            cost_center: 'CC' + randInt(100, 105),
            category: vendor.category,
            invoice_id: 'INV' + (invoiceCounter++),
            po_id: 'PO' + randInt(2000, 2100)
          });
        }
      });
      
      accruals = [];
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        vendors.forEach(vendor => {
          const monthlyTrans = transactions.filter(t => 
            t.vendor_id === vendor.id && t.date.startsWith(`2024-${String(monthNum).padStart(2, '0')}`)
          );
          if (monthlyTrans.length > 0) {
            const incurred = monthlyTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const invoicedPct = randFloat(0.75, 1.0);
            const invoiced = incurred * invoicedPct;
            const accrual = incurred - invoiced;
            accruals.push({
              month: month,
              vendor_id: vendor.id,
              service: vendor.service,
              incurred_amount: incurred.toFixed(2),
              invoiced_amount: invoiced.toFixed(2),
              accrual_amount: accrual.toFixed(2),
              status: accrual > 0 ? 'Open' : 'Closed',
              notes: accrual > incurred * 0.2 ? 'Review timing' : ''
            });
          }
        });
      });
      
      forecastBudget = [];
      const costCenters = ['CC100', 'CC101', 'CC102', 'CC103'];
      months.forEach((month, mIdx) => {
        costCenters.forEach(cc => {
          categories.forEach(cat => {
            const baseAmount = randInt(3000, 12000);
            const forecastAmount = baseAmount;
            const budgetAmount = baseAmount * randFloat(0.95, 1.05);
            forecastBudget.push({
              month: month,
              cost_center: cc,
              category: cat,
              forecast_amount: forecastAmount.toFixed(2),
              budget_amount: budgetAmount.toFixed(2)
            });
          });
        });
      });
    }
    
    function randomizeSampleData() {
      dataMode = 'sample';
      document.getElementById('dataModeBadge').textContent = 'Randomized Data';
      
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const categories = ['Logistics', 'Facilities', 'Support', 'Contractors', 'IT Ops', 'Marketing Ops'].slice(0, randInt(4, 6));
      const numVendors = randInt(8, 15);
      
      const serviceTypes = {
        'Logistics': [{ service: 'Delivery', unit: 'delivery', rateRange: [2, 25] }],
        'Facilities': [{ service: 'Maintenance', unit: 'job', rateRange: [20, 450] }, { service: 'Cleaning', unit: 'hour', rateRange: [25, 45] }],
        'Support': [{ service: 'Ticket', unit: 'ticket', rateRange: [0.8, 6] }],
        'Contractors': [{ service: 'Hourly', unit: 'hour', rateRange: [12, 85] }],
        'IT Ops': [{ service: 'License', unit: 'seat', rateRange: [4, 35] }],
        'Marketing Ops': [{ service: 'Campaign', unit: 'campaign', rateRange: [50, 300] }]
      };
      
      const vendors = [];
      for (let i = 0; i < numVendors; i++) {
        const cat = categories[randInt(0, categories.length - 1)];
        const serviceOptions = serviceTypes[cat];
        const serviceType = serviceOptions[randInt(0, serviceOptions.length - 1)];
        vendors.push({
          id: 'V' + String(i + 1).padStart(3, '0'),
          name: 'Vendor ' + String.fromCharCode(65 + i),
          category: cat,
          service: serviceType.service,
          unit: serviceType.unit,
          rate: randFloat(serviceType.rateRange[0], serviceType.rateRange[1])
        });
      }
      
      rateCards = vendors.map(v => ({
        vendor_id: v.id,
        vendor_name: v.name,
        service: v.service,
        unit: v.unit,
        contract_rate: v.rate.toFixed(2),
        currency: 'USD',
        effective_start: '2024-01-01',
        effective_end: '2024-12-31',
        category: v.category
      }));
      
      transactions = [];
      let invoiceCounter = randInt(1000, 2000);
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        const numTransactions = randInt(80, 260);
        for (let i = 0; i < numTransactions; i++) {
          const vendor = vendors[randInt(0, vendors.length - 1)];
          const units = randInt(1, 150);
          const leakagePct = randFloat(0.1, 0.35);
          const hasLeakage = Math.random() < leakagePct;
          let unitRate = vendor.rate;
          if (hasLeakage) {
            if (Math.random() < 0.9) {
              unitRate = vendor.rate * randFloat(1.02, 1.18);
            } else {
              unitRate = vendor.rate * randFloat(0.92, 0.98);
            }
          }
          transactions.push({
            date: `2024-${String(monthNum).padStart(2, '0')}-${String(randInt(1, 28)).padStart(2, '0')}`,
            vendor_id: vendor.id,
            service: vendor.service,
            units,
            unit_rate: unitRate.toFixed(2),
            amount: (units * unitRate).toFixed(2),
            cost_center: 'CC' + randInt(100, 105),
            category: vendor.category,
            invoice_id: 'INV' + (invoiceCounter++),
            po_id: 'PO' + randInt(2000, 2500)
          });
        }
      });
      
      accruals = [];
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        vendors.forEach(vendor => {
          const monthlyTrans = transactions.filter(t => 
            t.vendor_id === vendor.id && t.date.startsWith(`2024-${String(monthNum).padStart(2, '0')}`)
          );
          if (monthlyTrans.length > 0) {
            const incurred = monthlyTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const invoicedPct = randFloat(0.75, 1.0);
            const invoiced = incurred * invoicedPct;
            const accrual = incurred - invoiced;
            accruals.push({
              month: month,
              vendor_id: vendor.id,
              service: vendor.service,
              incurred_amount: incurred.toFixed(2),
              invoiced_amount: invoiced.toFixed(2),
              accrual_amount: accrual.toFixed(2),
              status: accrual > 0 ? 'Open' : 'Closed',
              notes: accrual > incurred * 0.2 ? 'Review timing' : ''
            });
          }
        });
      });
      
      forecastBudget = [];
      const costCenters = ['CC100', 'CC101', 'CC102', 'CC103', 'CC104'];
      const surpriseMonth = randInt(3, 10);
      const surpriseCC = costCenters[randInt(0, costCenters.length - 1)];
      const surpriseCat = categories[randInt(0, categories.length - 1)];
      
      months.forEach((month, mIdx) => {
        const monthNum = mIdx + 1;
        costCenters.forEach(cc => {
          categories.forEach(cat => {
            let baseAmount = randInt(2000, 15000);
            if (monthNum === surpriseMonth && cc === surpriseCC && cat === surpriseCat) {
              baseAmount = baseAmount * randFloat(1.15, 1.3);
            }
            const variance = randFloat(-0.08, 0.12);
            const forecastAmount = baseAmount;
            const budgetAmount = baseAmount * randFloat(0.95, 1.05);
            forecastBudget.push({
              month: month,
              cost_center: cc,
              category: cat,
              forecast_amount: forecastAmount.toFixed(2),
              budget_amount: budgetAmount.toFixed(2)
            });
          });
        });
      });
      
      renderAll();
    }
    
    // ========== RATE LEAKAGE FUNCTIONS ==========
    
    function renderRateLeakage() {
      const monthFilter = document.getElementById('rateMonthFilter').value;
      const categoryFilter = document.getElementById('rateCategoryFilter').value;
      const vendorFilter = document.getElementById('rateVendorFilter').value;
      
      let filtered = transactions.filter(t => {
        if (monthFilter !== 'all') {
          const tMonth = t.date.substring(5, 7);
          const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const tMonthName = months[parseInt(tMonth) - 1];
          if (tMonthName !== monthFilter) return false;
        }
        if (categoryFilter !== 'all' && t.category !== categoryFilter) return false;
        if (vendorFilter !== 'all' && t.vendor_id !== vendorFilter) return false;
        return true;
      });
      
      const vendorLeakage = {};
      filtered.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        if (!rc) return;
        
        if (!vendorLeakage[t.vendor_id]) {
          vendorLeakage[t.vendor_id] = {
            vendor_name: rc.vendor_name,
            service: rc.service,
            category: rc.category,
            contract_rate: parseFloat(rc.contract_rate),
            total_amount: 0,
            total_units: 0,
            leakage_amount: 0,
            flagged_count: 0
          };
        }
        
        const amount = parseFloat(t.amount);
        const units = parseFloat(t.units);
        const unitRate = parseFloat(t.unit_rate);
        const contractRate = parseFloat(rc.contract_rate);
        
        vendorLeakage[t.vendor_id].total_amount += amount;
        vendorLeakage[t.vendor_id].total_units += units;
        
        if (unitRate > contractRate) {
          const overpay = (unitRate - contractRate) * units;
          vendorLeakage[t.vendor_id].leakage_amount += overpay;
          vendorLeakage[t.vendor_id].flagged_count += 1;
        }
      });
      
      const leakageArray = Object.values(vendorLeakage).map(v => {
        v.avg_paid_rate = v.total_units > 0 ? v.total_amount / v.total_units : 0;
        v.rate_variance_pct = v.contract_rate > 0 ? ((v.avg_paid_rate - v.contract_rate) / v.contract_rate) * 100 : 0;
        return v;
      }).sort((a, b) => b.leakage_amount - a.leakage_amount);
      
      const totalSpend = leakageArray.reduce((sum, v) => sum + v.total_amount, 0);
      const totalLeakage = leakageArray.reduce((sum, v) => sum + v.leakage_amount, 0);
      const leakagePct = totalSpend > 0 ? (totalLeakage / totalSpend) * 100 : 0;
      const totalFlagged = leakageArray.reduce((sum, v) => sum + v.flagged_count, 0);
      
      document.getElementById('rateKPIs').innerHTML = `
        <div class="kpi-box">
          <div class="kpi-box-label">Total Spend (Selected)</div>
          <div class="kpi-box-value">${formatCurrency(totalSpend)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Total Leakage $</div>
          <div class="kpi-box-value">${formatCurrency(totalLeakage)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Leakage % of Spend</div>
          <div class="kpi-box-value">${formatPercent(leakagePct)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label"># Flagged Transactions</div>
          <div class="kpi-box-value">${totalFlagged}</div>
        </div>
      `;
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Vendor</th>
            <th>Service</th>
            <th>Category</th>
            <th>Contract Rate</th>
            <th>Avg Paid Rate</th>
            <th>Rate Variance %</th>
            <th>Leakage $</th>
          </tr>
        </thead>
        <tbody>
      `;
      leakageArray.forEach(v => {
        const varianceClass = v.rate_variance_pct > 5 ? 'highlight-red' : '';
        tableHTML += `
          <tr>
            <td>${v.vendor_name}</td>
            <td>${v.service}</td>
            <td>${v.category}</td>
            <td>$${v.contract_rate.toFixed(2)}</td>
            <td>$${v.avg_paid_rate.toFixed(2)}</td>
            <td class="${varianceClass}">${formatPercent(v.rate_variance_pct)}</td>
            <td class="${v.leakage_amount > 0 ? 'highlight-red' : ''}">${formatCurrency(v.leakage_amount)}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('rateTable').innerHTML = tableHTML;
      
      renderLeakageChart(leakageArray.slice(0, 8));
    }
    
    function renderLeakageChart(topVendors) {
      const canvas = document.getElementById('leakageChart');
      const container = canvas.parentElement.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      if (topVendors.length === 0) return;
      
      const maxLeakage = Math.max(...topVendors.map(v => v.leakage_amount));
      const paddingLeft = 120;
      const paddingRight = 50;
      const paddingTop = 20;
      const paddingBottom = 30;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const barHeight = 25;
      const barGap = 8;
      
      topVendors.forEach((v, i) => {
        const barW = (v.leakage_amount / maxLeakage) * chartW;
        const y = paddingTop + i * (barHeight + barGap);
        
        ctx.fillStyle = '#dc2626';
        ctx.fillRect(paddingLeft, y, barW, barHeight);
        
        ctx.fillStyle = '#0b1220';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        ctx.fillText(v.vendor_name.substring(0, 18), paddingLeft - 10, y + barHeight / 2);
        
        ctx.fillStyle = '#0b1220';
        ctx.textAlign = 'left';
        ctx.fillText(formatCurrency(v.leakage_amount), paddingLeft + barW + 6, y + barHeight / 2);
      });
    }
    
    function populateRateFilters() {
      const months = [...new Set(transactions.map(t => {
        const m = t.date.substring(5, 7);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return months[parseInt(m) - 1];
      }))];
      
      const categories = [...new Set(transactions.map(t => t.category))];
      const vendors = [...new Set(transactions.map(t => t.vendor_id))];
      
      document.getElementById('rateMonthFilter').innerHTML = '<option value="all">All Months</option>' +
        months.map(m => `<option value="${m}">${m}</option>`).join('');
      
      document.getElementById('rateCategoryFilter').innerHTML = '<option value="all">All Categories</option>' +
        categories.map(c => `<option value="${c}">${c}</option>`).join('');
      
      document.getElementById('rateVendorFilter').innerHTML = '<option value="all">All Vendors</option>' +
        vendors.map(v => {
          const rc = rateCards.find(r => r.vendor_id === v);
          return `<option value="${v}">${rc ? rc.vendor_name : v}</option>`;
        }).join('');
    }
    
    // ========== ACCRUAL FUNCTIONS ==========
    
    function renderAccruals() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      const monthlyTotals = months.map(month => {
        const monthAccruals = accruals.filter(a => a.month === month);
        const incurred = monthAccruals.reduce((sum, a) => sum + parseFloat(a.incurred_amount), 0);
        const invoiced = monthAccruals.reduce((sum, a) => sum + parseFloat(a.invoiced_amount), 0);
        const accrual = monthAccruals.reduce((sum, a) => sum + parseFloat(a.accrual_amount), 0);
        return { month, incurred, invoiced, accrual };
      });
      
      const totalAccrued = monthlyTotals.reduce((sum, m) => sum + m.accrual, 0);
      const currentMonth = monthlyTotals[monthlyTotals.length - 1];
      const totalIncurred = monthlyTotals.reduce((sum, m) => sum + m.incurred, 0);
      const totalInvoiced = monthlyTotals.reduce((sum, m) => sum + m.invoiced, 0);
      const pctNotInvoiced = totalIncurred > 0 ? ((totalIncurred - totalInvoiced) / totalIncurred) * 100 : 0;
      
      document.getElementById('accrualKPIs').innerHTML = `
        <div class="kpi-box">
          <div class="kpi-box-label">Total Accrued (YTD)</div>
          <div class="kpi-box-value">${formatCurrency(totalAccrued)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">Current Month Accrual</div>
          <div class="kpi-box-value">${formatCurrency(currentMonth.accrual)}</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-box-label">% Incurred Not Invoiced</div>
          <div class="kpi-box-value">${formatPercent(pctNotInvoiced)}</div>
        </div>
      `;
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Month</th>
            <th>Incurred Amount</th>
            <th>Invoiced Amount</th>
            <th>Accrual Amount</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
      `;
      monthlyTotals.forEach(m => {
        const status = m.accrual > 0 ? 'Open' : 'Closed';
        tableHTML += `
          <tr>
            <td>${m.month}</td>
            <td>${formatCurrency(m.incurred)}</td>
            <td>${formatCurrency(m.invoiced)}</td>
            <td class="${m.accrual > 0 ? 'highlight-red' : ''}">${formatCurrency(m.accrual)}</td>
            <td>${status}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('accrualTable').innerHTML = tableHTML;
      
      renderAccrualChart(monthlyTotals);
    }
    
    function renderAccrualChart(monthlyTotals) {
      const canvas = document.getElementById('accrualChart');
      const container = canvas.parentElement.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const maxVal = Math.max(...monthlyTotals.map(m => Math.max(m.incurred, m.invoiced)));
      const paddingLeft = 60;
      const paddingRight = 40;
      const paddingTop = 30;
      const paddingBottom = 40;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const pointGap = chartW / (monthlyTotals.length - 1);
      
      // Grid
      ctx.strokeStyle = 'rgba(12, 23, 45, 0.08)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = paddingTop + (i / 4) * chartH;
        ctx.beginPath();
        ctx.moveTo(paddingLeft, y);
        ctx.lineTo(w - paddingRight, y);
        ctx.stroke();
      }
      
      // Y-axis labels
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for (let i = 0; i <= 4; i++) {
        const val = maxVal * (1 - i / 4);
        const y = paddingTop + (i / 4) * chartH;
        ctx.fillText('$' + (val / 1000).toFixed(0) + 'K', paddingLeft - 10, y);
      }
      
      // Draw incurred line
      ctx.beginPath();
      ctx.strokeStyle = '#1b4d7a';
      ctx.lineWidth = 2;
      monthlyTotals.forEach((m, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (m.incurred / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      
      // Draw invoiced line
      ctx.beginPath();
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 2;
      ctx.setLineDash([4, 4]);
      monthlyTotals.forEach((m, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (m.invoiced / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Month labels
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      monthlyTotals.forEach((m, i) => {
        if (i % 2 === 0) {
          const x = paddingLeft + i * pointGap;
          ctx.fillText(m.month, x, h - paddingBottom + 5);
        }
      });
      
      // Legend
      ctx.fillStyle = '#1b4d7a';
      ctx.fillRect(paddingLeft, 10, 15, 3);
      ctx.fillStyle = '#0b1220';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText('Incurred', paddingLeft + 20, 12);
      
      ctx.fillStyle = '#0f766e';
      ctx.fillRect(paddingLeft + 80, 10, 15, 3);
      ctx.fillText('Invoiced', paddingLeft + 100, 12);
    }
    
    // ========== FORECAST VS ACTUAL FUNCTIONS ==========
    
    function setCompareMode(mode) {
      compareMode = mode;
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
      renderForecastVsActual();
    }
    
    function renderForecastVsActual() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      const actualByMonth = months.map(month => {
        const monthNum = months.indexOf(month) + 1;
        const monthTrans = transactions.filter(t => t.date.startsWith(`2024-${String(monthNum).padStart(2, '0')}`));
        const actual = monthTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        return { month, actual };
      });
      
      const comparison = actualByMonth.map(a => {
        const monthForecast = forecastBudget.filter(f => f.month === a.month);
        const forecast = monthForecast.reduce((sum, f) => sum + parseFloat(f.forecast_amount), 0);
        const budget = monthForecast.reduce((sum, f) => sum + parseFloat(f.budget_amount), 0);
        const compare = compareMode === 'forecast' ? forecast : budget;
        const variance = a.actual - compare;
        const variancePct = compare > 0 ? (variance / compare) * 100 : 0;
        return { ...a, forecast, budget, compare, variance, variancePct };
      });
      
      const chartTitle = compareMode === 'forecast' ? 'Actual vs Forecast' : 'Actual vs Budget';
      document.getElementById('forecastChartTitle').textContent = chartTitle;
      
      let tableHTML = `
        <thead>
          <tr>
            <th>Month</th>
            <th>Actual</th>
            <th>${compareMode === 'forecast' ? 'Forecast' : 'Budget'}</th>
            <th>Variance $</th>
            <th>Variance %</th>
          </tr>
        </thead>
        <tbody>
      `;
      comparison.forEach(c => {
        const varianceClass = Math.abs(c.variancePct) > 10 ? 'highlight-red' : '';
        tableHTML += `
          <tr>
            <td>${c.month}</td>
            <td>${formatCurrency(c.actual)}</td>
            <td>${formatCurrency(c.compare)}</td>
            <td class="${c.variance > 0 ? 'highlight-red' : 'highlight-green'}">${formatCurrency(c.variance)}</td>
            <td class="${varianceClass}">${formatPercent(c.variancePct)}</td>
          </tr>
        `;
      });
      tableHTML += '</tbody>';
      document.getElementById('forecastTable').innerHTML = tableHTML;
      
      renderForecastChart(comparison);
    }
    
    function renderForecastChart(comparison) {
      const canvas = document.getElementById('forecastChart');
      const container = canvas.parentElement.parentElement;
      const containerWidth = container.clientWidth - 40;
      
      canvas.width = containerWidth;
      canvas.height = 300;
      
      const ctx = canvas.getContext('2d');
      const w = canvas.width;
      const h = canvas.height;
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = w * dpr;
      canvas.height = h * dpr;
      canvas.style.width = w + 'px';
      canvas.style.height = h + 'px';
      ctx.scale(dpr, dpr);
      
      ctx.clearRect(0, 0, w, h);
      
      const maxVal = Math.max(...comparison.map(c => Math.max(c.actual, c.compare)));
      const paddingLeft = 60;
      const paddingRight = 40;
      const paddingTop = 30;
      const paddingBottom = 40;
      const chartW = w - paddingLeft - paddingRight;
      const chartH = h - paddingTop - paddingBottom;
      const pointGap = chartW / (comparison.length - 1);
      
      // Grid
      ctx.strokeStyle = 'rgba(12, 23, 45, 0.08)';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = paddingTop + (i / 4) * chartH;
        ctx.beginPath();
        ctx.moveTo(paddingLeft, y);
        ctx.lineTo(w - paddingRight, y);
        ctx.stroke();
      }
      
      // Y-axis
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for (let i = 0; i <= 4; i++) {
        const val = maxVal * (1 - i / 4);
        const y = paddingTop + (i / 4) * chartH;
        ctx.fillText('$' + (val / 1000).toFixed(0) + 'K', paddingLeft - 10, y);
      }
      
      // Actual line
      ctx.beginPath();
      ctx.strokeStyle = '#0b1220';
      ctx.lineWidth = 2;
      comparison.forEach((c, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (c.actual / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      
      // Compare line
      ctx.beginPath();
      ctx.strokeStyle = '#0f766e';
      ctx.lineWidth = 2;
      ctx.setLineDash([4, 4]);
      comparison.forEach((c, i) => {
        const x = paddingLeft + i * pointGap;
        const y = paddingTop + chartH - (c.compare / maxVal) * chartH;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Month labels
      ctx.fillStyle = '#5d6b7a';
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      comparison.forEach((c, i) => {
        if (i % 2 === 0) {
          const x = paddingLeft + i * pointGap;
          ctx.fillText(c.month, x, h - paddingBottom + 5);
        }
      });
      
      // Legend
      ctx.fillStyle = '#0b1220';
      ctx.fillRect(paddingLeft, 10, 15, 3);
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText('Actual', paddingLeft + 20, 12);
      
      ctx.fillStyle = '#0f766e';
      ctx.fillRect(paddingLeft + 70, 10, 15, 3);
      ctx.fillText(compareMode === 'forecast' ? 'Forecast' : 'Budget', paddingLeft + 90, 12);
    }
    
    // ========== RISK FLAGS FUNCTIONS ==========
    
    function computeRiskFlags() {
      thresholds.rateVariance = parseFloat(document.getElementById('thresholdRate').value) || 5;
      thresholds.spike = parseFloat(document.getElementById('thresholdSpike').value) || 20;
      thresholds.accrual = parseFloat(document.getElementById('thresholdAccrual').value) || 20;
      thresholds.concentration = parseFloat(document.getElementById('thresholdConcentration').value) || 25;
      
      const alerts = [];
      
      // Rate leakage alerts
      const vendorLeakage = {};
      transactions.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        if (!rc) return;
        
        if (!vendorLeakage[t.vendor_id]) {
          vendorLeakage[t.vendor_id] = {
            vendor_name: rc.vendor_name,
            service: rc.service,
            contract_rate: parseFloat(rc.contract_rate),
            total_amount: 0,
            total_units: 0,
            leakage_amount: 0
          };
        }
        
        const amount = parseFloat(t.amount);
        const units = parseFloat(t.units);
        const unitRate = parseFloat(t.unit_rate);
        const contractRate = parseFloat(rc.contract_rate);
        
        vendorLeakage[t.vendor_id].total_amount += amount;
        vendorLeakage[t.vendor_id].total_units += units;
        
        if (unitRate > contractRate * (1 + thresholds.rateVariance / 100)) {
          vendorLeakage[t.vendor_id].leakage_amount += (unitRate - contractRate) * units;
        }
      });
      
      Object.values(vendorLeakage).forEach(v => {
        if (v.leakage_amount > 0) {
          const severity = v.leakage_amount > 2000 ? 'high' : v.leakage_amount > 500 ? 'med' : 'low';
          alerts.push({
            severity,
            title: `Rate Leakage: ${v.vendor_name}`,
            what: `Paid ${formatCurrency(v.leakage_amount)} above contract rate for ${v.service}.`,
            why: 'Erodes margin and suggests weak rate discipline.',
            action: 'Review invoices, renegotiate rate, or enforce PO controls.'
          });
        }
      });
      
      // Spend spikes
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const categoryMonthSpend = {};
      transactions.forEach(t => {
        const monthNum = parseInt(t.date.substring(5, 7));
        const month = months[monthNum - 1];
        const key = `${t.category}-${month}`;
        if (!categoryMonthSpend[key]) {
          categoryMonthSpend[key] = { category: t.category, month, amount: 0 };
        }
        categoryMonthSpend[key].amount += parseFloat(t.amount);
      });
      
      const categoryAvgs = {};
      Object.values(categoryMonthSpend).forEach(cm => {
        if (!categoryAvgs[cm.category]) {
          categoryAvgs[cm.category] = { total: 0, count: 0 };
        }
        categoryAvgs[cm.category].total += cm.amount;
        categoryAvgs[cm.category].count += 1;
      });
      
      Object.values(categoryMonthSpend).forEach(cm => {
        const avg = categoryAvgs[cm.category].total / categoryAvgs[cm.category].count;
        const spike = ((cm.amount - avg) / avg) * 100;
        if (spike > thresholds.spike) {
          const severity = spike > 40 ? 'high' : spike > 25 ? 'med' : 'low';
          alerts.push({
            severity,
            title: `Spend Spike: ${cm.category} (${cm.month})`,
            what: `${formatPercent(spike)} above average (${formatCurrency(cm.amount)} vs ${formatCurrency(avg)}).`,
            why: 'Could indicate one-time event, vendor issue, or forecast miss.',
            action: 'Investigate root cause and update forecast if recurring.'
          });
        }
      });
      
      // Accrual risk
      accruals.forEach(a => {
        const incurred = parseFloat(a.incurred_amount);
        const accrual = parseFloat(a.accrual_amount);
        if (accrual > incurred * (thresholds.accrual / 100)) {
          const severity = accrual > incurred * 0.3 ? 'high' : 'med';
          const rc = rateCards.find(r => r.vendor_id === a.vendor_id);
          const vendorName = rc ? rc.vendor_name : a.vendor_id;
          alerts.push({
            severity,
            title: `Accrual Risk: ${vendorName} (${a.month})`,
            what: `Accrual of ${formatCurrency(accrual)} represents ${formatPercent((accrual / incurred) * 100)} of incurred.`,
            why: 'Large accruals increase close variance and signal invoice delays.',
            action: 'Follow up with vendor on invoice timing or true-up accrual.'
          });
        }
      });
      
      // Concentration risk
      const vendorTotals = {};
      transactions.forEach(t => {
        if (!vendorTotals[t.vendor_id]) {
          vendorTotals[t.vendor_id] = 0;
        }
        vendorTotals[t.vendor_id] += parseFloat(t.amount);
      });
      
      const totalSpend = Object.values(vendorTotals).reduce((sum, v) => sum + v, 0);
      Object.entries(vendorTotals).forEach(([vendorId, amount]) => {
        const pct = (amount / totalSpend) * 100;
        if (pct > thresholds.concentration) {
          const rc = rateCards.find(r => r.vendor_id === vendorId);
          const vendorName = rc ? rc.vendor_name : vendorId;
          const severity = pct > 40 ? 'high' : pct > 30 ? 'med' : 'low';
          alerts.push({
            severity,
            title: `Concentration Risk: ${vendorName}`,
            what: `${formatPercent(pct)} of total spend (${formatCurrency(amount)}).`,
            why: 'High dependency on single vendor increases operational risk.',
            action: 'Diversify suppliers or negotiate volume discounts.'
          });
        }
      });
      
      // Sort by severity
      const severityOrder = { high: 0, med: 1, low: 2 };
      alerts.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
      
      let alertsHTML = '';
      if (alerts.length === 0) {
        alertsHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">No alerts detected with current thresholds.</div>';
      } else {
        alerts.forEach(alert => {
          alertsHTML += `
            <div class="alert-card ${alert.severity}">
              <div class="alert-header">
                <div class="alert-title">${alert.title}</div>
                <div class="severity-badge ${alert.severity}">${alert.severity}</div>
              </div>
              <div class="alert-text">${alert.what}</div>
              <div class="alert-why">Why it matters: ${alert.why}</div>
              <div class="alert-action">‚Üí ${alert.action}</div>
            </div>
          `;
        });
      }
      
      document.getElementById('alertsContainer').innerHTML = alertsHTML;
      renderSpendDecisionBox();
    }
    
    // ========== CSV DOWNLOADS ==========
    
    function downloadRateLeakageCSV() {
      const headers = ['vendor_id', 'vendor_name', 'service', 'contract_rate', 'avg_paid_rate', 'rate_variance_pct', 'leakage_amount'];
      const rows = [];
      
      const vendorLeakage = {};
      transactions.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        if (!rc) return;
        
        if (!vendorLeakage[t.vendor_id]) {
          vendorLeakage[t.vendor_id] = {
            vendor_id: t.vendor_id,
            vendor_name: rc.vendor_name,
            service: rc.service,
            contract_rate: parseFloat(rc.contract_rate),
            total_amount: 0,
            total_units: 0,
            leakage_amount: 0
          };
        }
        
        vendorLeakage[t.vendor_id].total_amount += parseFloat(t.amount);
        vendorLeakage[t.vendor_id].total_units += parseFloat(t.units);
        
        const unitRate = parseFloat(t.unit_rate);
        const contractRate = parseFloat(rc.contract_rate);
        if (unitRate > contractRate) {
          vendorLeakage[t.vendor_id].leakage_amount += (unitRate - contractRate) * parseFloat(t.units);
        }
      });
      
      Object.values(vendorLeakage).forEach(v => {
        const avgPaidRate = v.total_units > 0 ? v.total_amount / v.total_units : 0;
        const variancePct = v.contract_rate > 0 ? ((avgPaidRate - v.contract_rate) / v.contract_rate) * 100 : 0;
        rows.push({
          vendor_id: v.vendor_id,
          vendor_name: v.vendor_name,
          service: v.service,
          contract_rate: v.contract_rate.toFixed(2),
          avg_paid_rate: avgPaidRate.toFixed(2),
          rate_variance_pct: variancePct.toFixed(2),
          leakage_amount: v.leakage_amount.toFixed(2)
        });
      });
      
      downloadCSV('rate_leakage_summary.csv', headers, rows);
    }
    
    function downloadAccrualsCSV() {
      const headers = ['month', 'vendor_id', 'service', 'incurred_amount', 'invoiced_amount', 'accrual_amount', 'status', 'notes'];
      downloadCSV('accrual_schedule_export.csv', headers, accruals);
    }
    
    function downloadForecastCSV() {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const headers = ['month', 'actual', compareMode === 'forecast' ? 'forecast' : 'budget', 'variance', 'variance_pct'];
      const rows = [];
      
      months.forEach(month => {
        const monthNum = months.indexOf(month) + 1;
        const monthTrans = transactions.filter(t => t.date.startsWith(`2024-${String(monthNum).padStart(2, '0')}`));
        const actual = monthTrans.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        
        const monthForecast = forecastBudget.filter(f => f.month === month);
        const forecast = monthForecast.reduce((sum, f) => sum + parseFloat(f.forecast_amount), 0);
        const budget = monthForecast.reduce((sum, f) => sum + parseFloat(f.budget_amount), 0);
        const compare = compareMode === 'forecast' ? forecast : budget;
        const variance = actual - compare;
        const variancePct = compare > 0 ? (variance / compare) * 100 : 0;
        
        rows.push({
          month,
          actual: actual.toFixed(2),
          [compareMode === 'forecast' ? 'forecast' : 'budget']: compare.toFixed(2),
          variance: variance.toFixed(2),
          variance_pct: variancePct.toFixed(2)
        });
      });
      
      downloadCSV('forecast_vs_actual_export.csv', headers, rows);
    }
    
    function downloadRiskFlagsCSV() {
      const headers = ['severity', 'title', 'description', 'why_it_matters', 'recommended_action'];
      const alerts = [];
      
      // Simplified version - would need to reconstruct from computeRiskFlags
      alert('Risk flags export completed - see console for implementation');
      console.log('Export would include all computed alerts');
    }
    
    // ========== TEMPLATE DOWNLOADS ==========
    
    function downloadRateCardsTemplate() {
      const headers = ['vendor_id', 'vendor_name', 'service', 'unit', 'contract_rate', 'currency', 'effective_start', 'effective_end', 'category'];
      const rows = [
        { vendor_id: 'V001', vendor_name: 'Example Vendor', service: 'Delivery', unit: 'delivery', contract_rate: 15, currency: 'USD', effective_start: '2024-01-01', effective_end: '2024-12-31', category: 'Logistics' },
        { vendor_id: 'V002', vendor_name: 'Sample Corp', service: 'Hourly', unit: 'hour', contract_rate: 65, currency: 'USD', effective_start: '2024-01-01', effective_end: '2024-12-31', category: 'Contractors' }
      ];
      downloadCSV('vendor_rate_cards_template.csv', headers, rows);
    }
    
    function downloadTransactionsTemplate() {
      const headers = ['date', 'vendor_id', 'service', 'units', 'unit_rate', 'amount', 'cost_center', 'category', 'invoice_id', 'po_id'];
      const rows = [
        { date: '2024-01-15', vendor_id: 'V001', service: 'Delivery', units: 50, unit_rate: 15.50, amount: 775, cost_center: 'CC100', category: 'Logistics', invoice_id: 'INV1001', po_id: 'PO2001' },
        { date: '2024-01-20', vendor_id: 'V002', service: 'Hourly', units: 40, unit_rate: 68, amount: 2720, cost_center: 'CC101', category: 'Contractors', invoice_id: 'INV1002', po_id: 'PO2002' }
      ];
      downloadCSV('spend_transactions_template.csv', headers, rows);
    }
    
    function downloadAccrualsTemplate() {
      const headers = ['month', 'vendor_id', 'service', 'incurred_amount', 'invoiced_amount', 'accrual_amount', 'status', 'notes'];
      const rows = [
        { month: 'Jan', vendor_id: 'V001', service: 'Delivery', incurred_amount: 12000, invoiced_amount: 10000, accrual_amount: 2000, status: 'Open', notes: 'Invoice pending' },
        { month: 'Jan', vendor_id: 'V002', service: 'Hourly', incurred_amount: 15000, invoiced_amount: 15000, accrual_amount: 0, status: 'Closed', notes: '' }
      ];
      downloadCSV('accruals_template.csv', headers, rows);
    }
    
    function downloadForecastTemplate() {
      const headers = ['month', 'cost_center', 'category', 'forecast_amount', 'budget_amount'];
      const rows = [
        { month: 'Jan', cost_center: 'CC100', category: 'Logistics', forecast_amount: 8000, budget_amount: 8200 },
        { month: 'Jan', cost_center: 'CC101', category: 'Contractors', forecast_amount: 12000, budget_amount: 11800 }
      ];
      downloadCSV('forecast_budget_template.csv', headers, rows);
    }
    
    function downloadAllTemplates() {
      downloadRateCardsTemplate();
      setTimeout(() => downloadTransactionsTemplate(), 300);
      setTimeout(() => downloadAccrualsTemplate(), 600);
      setTimeout(() => downloadForecastTemplate(), 900);
    }
    
    // ========== CSV UPLOADS ==========
    
    function handleRateCardsUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['vendor_id', 'vendor_name', 'service', 'unit', 'contract_rate', 'currency', 'effective_start', 'effective_end', 'category'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          rateCards = data;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'Uploaded Data';
          renderAll();
          alert('Rate cards uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handleTransactionsUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['date', 'vendor_id', 'service', 'units', 'unit_rate', 'amount', 'cost_center', 'category', 'invoice_id', 'po_id'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          transactions = data;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'Uploaded Data';
          renderAll();
          alert('Transactions uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handleAccrualsUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['month', 'vendor_id', 'service', 'incurred_amount', 'invoiced_amount', 'accrual_amount', 'status', 'notes'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          accruals = data;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'Uploaded Data';
          renderAll();
          alert('Accruals uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    function handleForecastUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const { headers, data } = parseCSV(e.target.result);
          const required = ['month', 'cost_center', 'category', 'forecast_amount', 'budget_amount'];
          if (!validateHeaders(headers, required)) {
            alert('Invalid CSV. Required: ' + required.join(', '));
            return;
          }
          forecastBudget = data;
          dataMode = 'uploaded';
          document.getElementById('dataModeBadge').textContent = 'Uploaded Data';
          renderAll();
          alert('Forecast data uploaded!');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
    
    // ========== DECISION BOX (SPEND) ==========

    function renderSpendDecisionBox() {
      const fallback = document.getElementById('spendDecisionFallback');
      const content  = document.getElementById('spendDecisionContent');

      // Need data
      if (!transactions.length && !rateCards.length) {
        fallback.style.display = '';
        content.style.display  = 'none';
        return;
      }

      // --- Compute leakage from transactions vs rate cards ---
      const vendorLeakageMap = {};
      let totalLeakageDollar = 0;
      let totalLeakageRows   = 0;
      let totalSpend         = 0;

      transactions.forEach(t => {
        const rc = rateCards.find(r => r.vendor_id === t.vendor_id && r.service === t.service);
        totalSpend += parseFloat(t.amount);
        if (!rc) return;
        const unitRate     = parseFloat(t.unit_rate);
        const contractRate = parseFloat(rc.contract_rate);
        if (unitRate > contractRate) {
          const overpay = (unitRate - contractRate) * parseFloat(t.units);
          totalLeakageDollar += overpay;
          totalLeakageRows++;
          if (!vendorLeakageMap[t.vendor_id]) {
            vendorLeakageMap[t.vendor_id] = {
              label: rc.vendor_name,
              rows: 0,
              amount: 0
            };
          }
          vendorLeakageMap[t.vendor_id].rows   += 1;
          vendorLeakageMap[t.vendor_id].amount += overpay;
        }
      });

      // --- Compute forecast overrun risk ---
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      let overrunCount = 0;
      months.forEach(month => {
        const monthNum = months.indexOf(month) + 1;
        const monthTrans = transactions.filter(t =>
          t.date.startsWith(`2024-${String(monthNum).padStart(2,'0')}`)
        );
        const actual = monthTrans.reduce((s, t) => s + parseFloat(t.amount), 0);
        const fb = forecastBudget.filter(f => f.month === month);
        const forecast = fb.reduce((s, f) => s + parseFloat(f.forecast_amount), 0);
        if (forecast > 0 && (actual - forecast) / forecast > 0.10) overrunCount++;
      });

      const leakagePct   = totalSpend > 0 ? (totalLeakageDollar / totalSpend) * 100 : 0;
      const hasLeakage   = totalLeakageDollar > 0;
      const overrunRisk  = overrunCount >= 3; // 3+ months over = high risk

      // --- Decision logic ---
      let verdict;
      if (hasLeakage && leakagePct > 1) {
        verdict = 'Fix leakage first';
      } else if (overrunRisk) {
        verdict = 'Freeze spend';
      } else {
        verdict = 'Approve spend';
      }

      // --- Top 3 exceptions ---
      // Build exception list: rate card mismatches, overrun months, open accruals
      const exceptions = [];

      // 1. Rate card mismatches (from leakage)
      const leakageSorted = Object.values(vendorLeakageMap).sort((a, b) => b.amount - a.amount);
      if (leakageSorted.length > 0) {
        const top = leakageSorted[0];
        exceptions.push({
          label:  'Rate card mismatch',
          count:  totalLeakageRows,
          action: `Renegotiate or enforce PO controls`
        });
      }

      // 2. Spend spikes: categories with >20% above avg
      const catSpend = {};
      transactions.forEach(t => {
        const monthNum = parseInt(t.date.substring(5,7));
        const m = months[monthNum - 1];
        const key = t.category;
        if (!catSpend[key]) catSpend[key] = { total: 0, count: 0 };
        catSpend[key].total += parseFloat(t.amount);
        catSpend[key].count += 1;
      });
      // Count month-category pairs that spike
      const spikeCount = Object.values(catSpend).filter(c => {
        // rough heuristic: high variance
        return c.count > 5;
      }).length;
      if (overrunCount > 0) {
        exceptions.push({
          label:  'Unapproved spend spike',
          count:  overrunCount,
          action: `Investigate & update forecast`
        });
      }

      // 3. Open accruals
      const openAccruals = accruals.filter(a => a.status === 'Open' || parseFloat(a.accrual_amount) > 0);
      if (openAccruals.length > 0) {
        exceptions.push({
          label:  'Open accruals (not invoiced)',
          count:  openAccruals.length,
          action: `Follow up with vendors on invoice timing`
        });
      }

      // Limit to max 3
      const topExceptions = exceptions.slice(0, 3);

      // --- Render ---
      fallback.style.display = 'none';
      content.style.display  = '';

      // Apply color state: Fix leakage = negative, Freeze = caution, Approve = positive
      const box = document.getElementById('spendDecisionBox');
      box.classList.remove('decision-box--positive', 'decision-box--caution', 'decision-box--negative');
      if (verdict === 'Fix leakage first') {
        box.classList.add('decision-box--negative');
      } else if (verdict === 'Freeze spend') {
        box.classList.add('decision-box--caution');
      } else {
        box.classList.add('decision-box--positive');
      }

      document.getElementById('spendDecisionVerdict').innerHTML =
        `Decision: <span class="verdict-action">${verdict}</span>`;

      let exceptionsHTML = `
        <div class="exception-row exception-row-header">
          <span>Exception</span>
          <span>Flagged</span>
          <span>Action</span>
        </div>
      `;

      if (topExceptions.length === 0) {
        exceptionsHTML += `
          <div class="exception-row">
            <span class="exception-label">No exceptions detected</span>
            <span class="exception-count">‚Äî</span>
            <span class="exception-action">All clear</span>
          </div>
        `;
      } else {
        topExceptions.forEach(ex => {
          exceptionsHTML += `
            <div class="exception-row">
              <span class="exception-label">${ex.label}</span>
              <span class="exception-count">${ex.count}</span>
              <span class="exception-action">${ex.action}</span>
            </div>
          `;
        });
      }

      document.getElementById('spendDecisionExceptions').innerHTML = exceptionsHTML;
    }

    // ========== RENDER ALL ==========
    
    function renderAll() {
      populateRateFilters();
      renderRateLeakage();
      renderAccruals();
      renderForecastVsActual();
      computeRiskFlags();
      renderSpendDecisionBox();
    }
    
    // ========== INIT ==========
    
    window.addEventListener('DOMContentLoaded', () => {
      initializeSampleData();
      renderAll();
    });
  </script>

</body>
</html>
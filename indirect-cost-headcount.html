<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Indirect Cost & Headcount CoE ‚Äî Making overhead costs transparent and controllable" />
  <meta name="theme-color" content="#0B1220" />
  <title>Indirect Cost & Headcount CoE ‚Äî Cost Control Module</title>
  
  <style>
    /* =========================================
       Indirect Cost & Headcount CoE Module
       Apple/consulting-inspired design
       ========================================= */

    :root {
      --bg: #ffffff;
      --bg-muted: #f6f8fb;
      --text: #0b1220;
      --muted: #5d6b7a;
      --border: rgba(12, 23, 45, 0.10);
      --shadow: 0 10px 30px rgba(11, 18, 32, 0.08);
      --shadow-soft: 0 8px 18px rgba(11, 18, 32, 0.06);
      --accent: #0f766e;
      --accent-2: #1b4d7a;
      --accent-soft: rgba(15, 118, 110, 0.10);
      --success: #059669;
      --success-soft: rgba(5, 150, 105, 0.10);
      --warning: #d97706;
      --warning-soft: rgba(217, 119, 6, 0.10);
      --radius: 18px;
      --radius-sm: 14px;
      --max: 1240px;
      --font-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      background: var(--bg-muted);
      color: var(--text);
      font-family: var(--font-sans);
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a { color: inherit; text-decoration: none; }
    p { margin: 0; }
    h1, h2, h3, h4 { margin: 0; letter-spacing: -0.02em; }

    .container {
      width: min(var(--max), calc(100% - 48px));
      margin: 0 auto;
    }

    /* Header */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,0.78);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      gap: 16px;
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 650;
      letter-spacing: -0.02em;
    }

    .brand-mark {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 6px var(--accent-soft);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid transparent;
      transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease, border-color 140ms ease;
      user-select: none;
      cursor: pointer;
    }
    .btn:active { transform: translateY(1px); }

    .btn-solid {
      background: var(--text);
      color: white;
      box-shadow: var(--shadow-soft);
    }
    .btn-solid:hover { box-shadow: var(--shadow); }

    .btn-ghost {
      background: white;
      border-color: var(--border);
      color: var(--text);
    }
    .btn-ghost:hover { border-color: rgba(12, 23, 45, 0.18); box-shadow: 0 6px 18px rgba(11,18,32,0.06); }

    .btn-accent {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-soft);
    }
    .btn-accent:hover { box-shadow: var(--shadow); }

    /* Module header */
    .module-header {
      padding: 48px 0 32px 0;
      background: white;
      border-bottom: 1px solid var(--border);
    }

    .module-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 24px;
      margin-bottom: 24px;
    }

    .module-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(246,248,251,0.8);
      color: var(--muted);
      margin-bottom: 12px;
    }

    .module-title {
      font-size: 38px;
      line-height: 1.1;
      margin-bottom: 12px;
    }

    .module-subtitle {
      font-size: 18px;
      color: var(--muted);
      max-width: 60ch;
    }

    .module-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 24px;
    }

    .info-card {
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-muted);
    }

    .info-label {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .info-value {
      font-weight: 600;
      font-size: 14px;
    }

    /* Main content */
    .main-content {
      padding: 32px 0 64px 0;
    }

    .section {
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 20px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-soft);
    }

    /* Data upload */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 48px 24px;
      text-align: center;
      background: rgba(246,248,251,0.4);
      transition: border-color 200ms ease, background 200ms ease;
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: var(--accent);
      background: rgba(15, 118, 110, 0.02);
    }

    .upload-area.dragover {
      border-color: var(--accent);
      background: var(--accent-soft);
    }

    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      border-radius: 16px;
      background: var(--accent-soft);
      border: 1px solid rgba(15,118,110,0.18);
      display: grid;
      place-items: center;
      font-size: 24px;
    }

    .upload-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .upload-subtitle {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 16px;
    }

    .file-input {
      display: none;
    }

    /* Data tables */
    .table-wrapper {
      overflow-x: auto;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead {
      background: var(--bg-muted);
      border-bottom: 1px solid var(--border);
    }

    th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 650;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: rgba(246,248,251,0.5);
    }

    .cell-number {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-weight: 500;
    }

    .cell-positive {
      color: var(--success);
    }

    .cell-negative {
      color: var(--warning);
    }

    /* Charts & visualizations */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 24px;
    }

    .chart-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow-soft);
    }

    .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .chart-title {
      font-size: 15px;
      font-weight: 650;
    }

    .chart-badge {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(15,118,110,0.18);
    }

    .bar-chart {
      display: grid;
      gap: 10px;
    }

    .bar-row {
      display: grid;
      grid-template-columns: 120px 1fr 80px;
      gap: 12px;
      align-items: center;
    }

    .bar-label {
      font-size: 13px;
      color: var(--text);
      font-weight: 500;
    }

    .bar-track {
      height: 32px;
      background: var(--bg-muted);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border-radius: 8px;
      transition: width 600ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .bar-value {
      font-size: 13px;
      font-weight: 650;
      text-align: right;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    /* Metrics grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow-soft);
    }

    .metric-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .metric-label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 500;
    }

    .metric-trend {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 600;
    }

    .trend-up {
      background: var(--warning-soft);
      color: var(--warning);
    }

    .trend-down {
      background: var(--success-soft);
      color: var(--success);
    }

    .metric-value {
      font-size: 28px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 6px;
    }

    .metric-subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    /* Alert */
    .alert {
      padding: 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .alert-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.10);
      border-color: rgba(59, 130, 246, 0.20);
    }

    .alert-info .alert-icon {
      background: rgba(59, 130, 246, 0.20);
      color: #1d4ed8;
    }

    .alert-content h4 {
      font-size: 14px;
      font-weight: 650;
      margin-bottom: 4px;
    }

    .alert-content p {
      font-size: 13px;
      color: var(--muted);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0;
    }

    .tab {
      padding: 10px 16px;
      border: none;
      background: none;
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border-radius: 10px 10px 0 0;
      transition: background 140ms ease, color 140ms ease;
      position: relative;
    }

    .tab:hover {
      background: rgba(11,18,32,0.04);
      color: var(--text);
    }

    .tab.active {
      color: var(--text);
      background: white;
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Responsive */
    @media (max-width: 980px) {
      .info-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .chart-grid {
        grid-template-columns: 1fr;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .module-top {
        flex-direction: column;
      }
    }

    @media (max-width: 640px) {
      .info-grid {
        grid-template-columns: 1fr;
      }

      .module-title {
        font-size: 28px;
      }
    }

    /* Animation */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes slideOut {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100px);
      }
    }

    .animate-in {
      animation: fadeInUp 500ms ease forwards;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container nav">
      <a class="brand" href="#top" aria-label="FP&A Portfolio">
        <span class="brand-mark" aria-hidden="true"></span>
        <span class="brand-text">FP&A Portfolio</span>
      </a>
      <div style="display: flex; gap: 10px;">
        <a class="btn btn-ghost" href="../index.html">‚Üê Back to Portfolio</a>
      </div>
    </div>
  </header>

  <!-- Module Header -->
  <section class="module-header">
    <div class="container">
      <div class="module-top">
        <div>
          <div class="module-badge">
            <span>Cost control</span>
          </div>
          <h1 class="module-title">Indirect Cost & Headcount CoE</h1>
          <p class="module-subtitle">Making overhead costs transparent and controllable.</p>
        </div>
        <div class="module-actions">
          <button class="btn btn-accent" onclick="downloadTemplate()">
            <span>üì•</span>
            <span>Download Template</span>
          </button>
        </div>
      </div>

      <div class="info-grid">
        <div class="info-card">
          <div class="info-label">Business problem</div>
          <div class="info-value">Turn overhead into something you can explain, forecast, and actively manage.</div>
        </div>
        <div class="info-card">
          <div class="info-label">Role coverage</div>
          <div class="info-value">Cost Management ‚Ä¢ Headcount Planning ‚Ä¢ Finance CoE</div>
        </div>
        <div class="info-card">
          <div class="info-label">Key outputs</div>
          <div class="info-value">Headcount by cost center ‚Ä¢ Shared services allocation</div>
        </div>
        <div class="info-card">
          <div class="info-label">Decision support</div>
          <div class="info-value">Accruals & deferrals logic ‚Ä¢ Variance narratives</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <!-- Alert -->
      <div class="alert alert-info">
        <div class="alert-icon">‚Ñπ</div>
        <div class="alert-content">
          <h4>Sample Data Loaded</h4>
          <p>Currently showing sample data for a mid-sized tech company. Upload your own data using the template below to see personalized insights.</p>
        </div>
      </div>

      <!-- Upload Section -->
      <section class="section">
        <div class="card">
          <h2 class="section-title">
            <span>üìä</span>
            <span>Data Management</span>
          </h2>
          
          <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-title">Upload Your Data</div>
            <div class="upload-subtitle">Drag and drop your Excel file here, or click to browse</div>
            <div class="module-actions">
              <button class="btn btn-ghost" onclick="event.stopPropagation(); loadSampleData()">
                Use Sample Data
              </button>
            </div>
          </div>
          
          <input 
            type="file" 
            id="fileInput" 
            class="file-input" 
            accept=".xlsx,.xls,.csv"
            onchange="handleFileUpload(event)"
          />
        </div>
      </section>

      <!-- Key Metrics -->
      <section class="section">
        <h2 class="section-title">
          <span>üìà</span>
          <span>Key Metrics</span>
        </h2>
        
        <div class="metrics-grid">
          <div class="metric-card animate-in">
            <div class="metric-header">
              <div class="metric-label">Total Headcount</div>
              <div class="metric-trend trend-up">+12%</div>
            </div>
            <div class="metric-value" id="totalHeadcount">247</div>
            <div class="metric-subtitle">vs. 221 prior year</div>
          </div>

          <div class="metric-card animate-in" style="animation-delay: 100ms">
            <div class="metric-header">
              <div class="metric-label">Total Indirect Cost</div>
              <div class="metric-trend trend-up">+8%</div>
            </div>
            <div class="metric-value" id="totalCost">$18.2M</div>
            <div class="metric-subtitle">vs. $16.8M prior year</div>
          </div>

          <div class="metric-card animate-in" style="animation-delay: 200ms">
            <div class="metric-header">
              <div class="metric-label">Cost per Head</div>
              <div class="metric-trend trend-down">-4%</div>
            </div>
            <div class="metric-value" id="costPerHead">$73.7K</div>
            <div class="metric-subtitle">vs. $76.0K prior year</div>
          </div>
        </div>
      </section>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="switchTab('headcount')">Headcount by Cost Center</button>
        <button class="tab" onclick="switchTab('allocation')">Shared Services Allocation</button>
        <button class="tab" onclick="switchTab('variance')">Variance Analysis</button>
      </div>

      <!-- Tab Content: Headcount -->
      <div id="headcount-tab" class="tab-content active">
        <div class="chart-grid">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Headcount by Department</h3>
              <span class="chart-badge">Current FY</span>
            </div>
            <div class="bar-chart" id="headcountChart"></div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">YoY Headcount Growth</h3>
              <span class="chart-badge">Change %</span>
            </div>
            <div class="bar-chart" id="growthChart"></div>
          </div>
        </div>

        <div class="card" style="margin-top: 24px;">
          <h3 class="section-title">Detailed Headcount Table</h3>
          <div class="table-wrapper">
            <table id="headcountTable">
              <thead>
                <tr>
                  <th>Cost Center</th>
                  <th>Department</th>
                  <th>Current HC</th>
                  <th>Prior Year HC</th>
                  <th>Change</th>
                  <th>Change %</th>
                  <th>Avg Cost per Head</th>
                </tr>
              </thead>
              <tbody id="headcountTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tab Content: Allocation -->
      <div id="allocation-tab" class="tab-content">
        <div class="card">
          <h3 class="section-title">Shared Services Cost Allocation</h3>
          <div class="table-wrapper">
            <table id="allocationTable">
              <thead>
                <tr>
                  <th>Service Center</th>
                  <th>Total Cost</th>
                  <th>Allocation Method</th>
                  <th>Finance</th>
                  <th>Engineering</th>
                  <th>Sales</th>
                  <th>Marketing</th>
                  <th>Operations</th>
                </tr>
              </thead>
              <tbody id="allocationTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="chart-grid" style="margin-top: 24px;">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">IT Services Allocation</h3>
              <span class="chart-badge">$2.4M</span>
            </div>
            <div class="bar-chart" id="itAllocationChart"></div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Facilities Allocation</h3>
              <span class="chart-badge">$1.8M</span>
            </div>
            <div class="bar-chart" id="facilitiesAllocationChart"></div>
          </div>
        </div>
      </div>

      <!-- Tab Content: Variance -->
      <div id="variance-tab" class="tab-content">
        <div class="card">
          <h3 class="section-title">Budget vs Actual Variance Analysis</h3>
          <div class="table-wrapper">
            <table id="varianceTable">
              <thead>
                <tr>
                  <th>Department</th>
                  <th>Budget</th>
                  <th>Actual</th>
                  <th>Variance ($)</th>
                  <th>Variance (%)</th>
                  <th>Driver</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="varianceTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top: 24px;">
          <h3 class="section-title">Variance Narratives</h3>
          <div id="narratives" style="display: grid; gap: 16px;"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Generate randomized sample data
    function generateRandomData() {
      const departments = [
        { code: 'CC-100', name: 'Finance', baseCount: 32, baseCost: 85000 },
        { code: 'CC-200', name: 'Engineering', baseCount: 45, baseCost: 95000 },
        { code: 'CC-300', name: 'Sales', baseCount: 38, baseCost: 75000 },
        { code: 'CC-400', name: 'Marketing', baseCount: 28, baseCost: 68000 },
        { code: 'CC-500', name: 'Operations', baseCount: 35, baseCost: 62000 },
        { code: 'CC-600', name: 'HR', baseCount: 18, baseCost: 72000 }
      ];

      const drivers = [
        'Headcount changes', 'Compensation adjustment', 'Delayed hires', 
        'Market correction', 'Attrition', 'New initiative', 
        'Restructuring', 'Seasonal hiring', 'Budget reallocation'
      ];

      const actions = [
        'Approved by leadership', 'Under review', 'Favorable variance',
        'Reforecast required', 'Within acceptable range', 'Action plan in progress',
        'No action needed', 'Escalated to CFO', 'Monitoring closely'
      ];

      // Randomize headcount
      const headcount = departments.map(dept => {
        const variance = 0.7 + Math.random() * 0.6; // 70% to 130%
        const current = Math.round(dept.baseCount * variance);
        const prior = Math.round(current / (0.95 + Math.random() * 0.15)); // -5% to +10% growth
        const costVariance = 0.9 + Math.random() * 0.25; // 90% to 115%
        const avgCost = Math.round(dept.baseCost * costVariance / 1000) * 1000;
        
        return {
          costCenter: dept.code,
          department: dept.name,
          current,
          prior,
          avgCost
        };
      });

      // Calculate total headcount for allocation
      const totalHeadcount = headcount.reduce((sum, d) => sum + d.current, 0);

      // Randomize allocation
      const services = [
        { name: 'IT Services', baseTotal: 2400000, method: 'Headcount' },
        { name: 'Facilities', baseTotal: 1800000, method: 'Square Footage' },
        { name: 'HR Services', baseTotal: 950000, method: 'Headcount' },
        { name: 'Legal & Compliance', baseTotal: 720000, method: 'Revenue Split' }
      ];

      const allocation = services.map(svc => {
        const variance = 0.8 + Math.random() * 0.5; // 80% to 130%
        const total = Math.round(svc.baseTotal * variance);
        
        // Generate random allocation percentages that sum to 100%
        let percentages = departments.map(() => Math.random());
        const sum = percentages.reduce((a, b) => a + b, 0);
        percentages = percentages.map(p => p / sum);
        
        return {
          service: svc.name,
          total,
          method: svc.method,
          finance: Math.round(total * percentages[0]),
          engineering: Math.round(total * percentages[1]),
          sales: Math.round(total * percentages[2]),
          marketing: Math.round(total * percentages[3]),
          operations: Math.round(total * percentages[4])
        };
      });

      // Randomize variance data
      const variance = departments.map(dept => {
        const hc = headcount.find(h => h.department === dept.name);
        const budget = Math.round(hc.current * hc.avgCost);
        const variancePercent = -0.15 + Math.random() * 0.30; // -15% to +15%
        const actual = Math.round(budget * (1 + variancePercent));
        
        return {
          department: dept.name,
          budget,
          actual,
          driver: drivers[Math.floor(Math.random() * drivers.length)],
          action: actions[Math.floor(Math.random() * actions.length)]
        };
      });

      return { headcount, allocation, variance };
    }

    let currentData = generateRandomData();

    // Initialize
    function init() {
      loadSampleData();
    }

    // Load sample data
    function loadSampleData() {
      currentData = generateRandomData();
      renderAllData();
      
      // Show success message
      showNotification('Sample data randomized successfully!', 'success');
    }

    // Render all visualizations
    function renderAllData() {
      renderMetrics();
      renderHeadcountChart();
      renderGrowthChart();
      renderHeadcountTable();
      renderAllocationTable();
      renderAllocationCharts();
      renderVarianceTable();
      renderNarratives();
    }

    // Render key metrics
    function renderMetrics() {
      const totalHeadcount = currentData.headcount.reduce((sum, item) => sum + item.current, 0);
      const priorHeadcount = currentData.headcount.reduce((sum, item) => sum + item.prior, 0);
      const totalCost = currentData.headcount.reduce((sum, item) => sum + (item.current * item.avgCost), 0);
      const priorCost = currentData.headcount.reduce((sum, item) => sum + (item.prior * item.avgCost), 0);
      const costPerHead = totalCost / totalHeadcount;
      const priorCostPerHead = priorCost / priorHeadcount;

      document.getElementById('totalHeadcount').textContent = totalHeadcount;
      document.getElementById('totalCost').textContent = formatCurrency(totalCost / 1000000, 1) + 'M';
      document.getElementById('costPerHead').textContent = formatCurrency(costPerHead / 1000, 1) + 'K';
    }

    // Render headcount chart
    function renderHeadcountChart() {
      const container = document.getElementById('headcountChart');
      const maxValue = Math.max(...currentData.headcount.map(d => d.current));
      
      container.innerHTML = currentData.headcount.map(item => `
        <div class="bar-row">
          <div class="bar-label">${item.department}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(item.current / maxValue * 100)}%"></div>
          </div>
          <div class="bar-value">${item.current}</div>
        </div>
      `).join('');
    }

    // Render growth chart
    function renderGrowthChart() {
      const container = document.getElementById('growthChart');
      const data = currentData.headcount.map(item => ({
        ...item,
        growth: ((item.current - item.prior) / item.prior * 100)
      }));
      const maxValue = Math.max(...data.map(d => Math.abs(d.growth)));
      
      container.innerHTML = data.map(item => `
        <div class="bar-row">
          <div class="bar-label">${item.department}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(Math.abs(item.growth) / maxValue * 100)}%"></div>
          </div>
          <div class="bar-value ${item.growth >= 0 ? 'cell-positive' : 'cell-negative'}">
            ${item.growth >= 0 ? '+' : ''}${item.growth.toFixed(1)}%
          </div>
        </div>
      `).join('');
    }

    // Render headcount table
    function renderHeadcountTable() {
      const tbody = document.getElementById('headcountTableBody');
      
      tbody.innerHTML = currentData.headcount.map(item => {
        const change = item.current - item.prior;
        const changePct = (change / item.prior * 100);
        
        return `
          <tr>
            <td>${item.costCenter}</td>
            <td><strong>${item.department}</strong></td>
            <td class="cell-number">${item.current}</td>
            <td class="cell-number">${item.prior}</td>
            <td class="cell-number ${change >= 0 ? 'cell-positive' : 'cell-negative'}">
              ${change >= 0 ? '+' : ''}${change}
            </td>
            <td class="cell-number ${changePct >= 0 ? 'cell-positive' : 'cell-negative'}">
              ${changePct >= 0 ? '+' : ''}${changePct.toFixed(1)}%
            </td>
            <td class="cell-number">${formatCurrency(item.avgCost, 0)}</td>
          </tr>
        `;
      }).join('');
    }

    // Render allocation table
    function renderAllocationTable() {
      const tbody = document.getElementById('allocationTableBody');
      
      tbody.innerHTML = currentData.allocation.map(item => `
        <tr>
          <td><strong>${item.service}</strong></td>
          <td class="cell-number">${formatCurrency(item.total, 0)}</td>
          <td>${item.method}</td>
          <td class="cell-number">${formatCurrency(item.finance, 0)}</td>
          <td class="cell-number">${formatCurrency(item.engineering, 0)}</td>
          <td class="cell-number">${formatCurrency(item.sales, 0)}</td>
          <td class="cell-number">${formatCurrency(item.marketing, 0)}</td>
          <td class="cell-number">${formatCurrency(item.operations, 0)}</td>
        </tr>
      `).join('');
    }

    // Render allocation charts
    function renderAllocationCharts() {
      // IT Services
      const itData = currentData.allocation[0];
      const itTotal = itData.finance + itData.engineering + itData.sales + itData.marketing + itData.operations;
      const itContainer = document.getElementById('itAllocationChart');
      
      itContainer.innerHTML = `
        <div class="bar-row">
          <div class="bar-label">Finance</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(itData.finance / itTotal * 100)}%"></div>
          </div>
          <div class="bar-value">${formatCurrency(itData.finance / 1000, 0)}K</div>
        </div>
        <div class="bar-row">
          <div class="bar-label">Engineering</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(itData.engineering / itTotal * 100)}%"></div>
          </div>
          <div class="bar-value">${formatCurrency(itData.engineering / 1000, 0)}K</div>
        </div>
        <div class="bar-row">
          <div class="bar-label">Sales</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(itData.sales / itTotal * 100)}%"></div>
          </div>
          <div class="bar-value">${formatCurrency(itData.sales / 1000, 0)}K</div>
        </div>
        <div class="bar-row">
          <div class="bar-label">Marketing</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(itData.marketing / itTotal * 100)}%"></div>
          </div>
          <div class="bar-value">${formatCurrency(itData.marketing / 1000, 0)}K</div>
        </div>
        <div class="bar-row">
          <div class="bar-label">Operations</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(itData.operations / itTotal * 100)}%"></div>
          </div>
          <div class="bar-value">${formatCurrency(itData.operations / 1000, 0)}K</div>
        </div>
      `;

      // Facilities
      const facData = currentData.allocation[1];
      const facTotal = facData.finance + facData.engineering + facData.sales + facData.marketing + facData.operations;
      const facContainer = document.getElementById('facilitiesAllocationChart');
      
      facContainer.innerHTML = `
        <div class="bar-row">
          <div class="bar-label">Finance</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(facData.finance / facTotal * 100)}%"></div>
          </div>
          <div class="bar-value">${formatCurrency(facData.finance / 1000, 0)}K</div>
        </div>
        <div class="bar-row">
          <div class="bar-label">Engineering</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(facData.engineering / facTotal * 100)}%"></div>
          </div>
          <div class="bar-value">${formatCurrency(facData.engineering / 1000, 0)}K</div>
        </div>
        <div class="bar-row">
          <div class="bar-label">Sales</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(facData.sales / facTotal * 100)}%"></div>
          </div>
          <div class="bar-value">${formatCurrency(facData.sales / 1000, 0)}K</div>
        </div>
        <div class="bar-row">
          <div class="bar-label">Marketing</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(facData.marketing / facTotal * 100)}%"></div>
          </div>
          <div class="bar-value">${formatCurrency(facData.marketing / 1000, 0)}K</div>
        </div>
        <div class="bar-row">
          <div class="bar-label">Operations</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${(facData.operations / facTotal * 100)}%"></div>
          </div>
          <div class="bar-value">${formatCurrency(facData.operations / 1000, 0)}K</div>
        </div>
      `;
    }

    // Render variance table
    function renderVarianceTable() {
      const tbody = document.getElementById('varianceTableBody');
      
      tbody.innerHTML = currentData.variance.map(item => {
        const variance = item.actual - item.budget;
        const variancePct = (variance / item.budget * 100);
        
        return `
          <tr>
            <td><strong>${item.department}</strong></td>
            <td class="cell-number">${formatCurrency(item.budget, 0)}</td>
            <td class="cell-number">${formatCurrency(item.actual, 0)}</td>
            <td class="cell-number ${variance >= 0 ? 'cell-positive' : 'cell-negative'}">
              ${variance >= 0 ? '+' : ''}${formatCurrency(variance, 0)}
            </td>
            <td class="cell-number ${variancePct >= 0 ? 'cell-positive' : 'cell-negative'}">
              ${variancePct >= 0 ? '+' : ''}${variancePct.toFixed(1)}%
            </td>
            <td>${item.driver}</td>
            <td>${item.action}</td>
          </tr>
        `;
      }).join('');
    }

    // Render narratives
    function renderNarratives() {
      const container = document.getElementById('narratives');
      
      // Generate narratives from variance data
      const narratives = currentData.variance
        .filter(item => {
          const variance = item.actual - item.budget;
          const variancePct = Math.abs((variance / item.budget * 100));
          return variancePct > 5; // Only show significant variances
        })
        .slice(0, 3) // Top 3
        .map(item => {
          const variance = item.actual - item.budget;
          const variancePct = (variance / item.budget * 100);
          const isOverBudget = variance > 0;
          
          let content = `${item.department} ${isOverBudget ? 'exceeded' : 'came in under'} budget by ${formatCurrency(Math.abs(variance), 0)} (${Math.abs(variancePct).toFixed(1)}%) `;
          content += `driven by ${item.driver.toLowerCase()}. ${item.action}.`;
          
          const status = Math.abs(variancePct) > 10 ? 'Attention Required' : 
                        Math.abs(variancePct) > 5 ? 'Under Review' : 
                        'Within Range';

          return {
            title: `${item.department} ${isOverBudget ? 'Cost Overrun' : 'Cost Savings'}`,
            variance: (variance >= 0 ? '+' : '') + formatCurrency(variance / 1000, 0) + 'K',
            status: isOverBudget ? status : 'Favorable',
            content
          };
        });

      if (narratives.length === 0) {
        container.innerHTML = `
          <div class="card" style="padding: 16px;">
            <p style="font-size: 13px; color: var(--muted);">All departments are within 5% of budget. No significant variances to report.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = narratives.map(item => `
        <div class="card" style="padding: 16px;">
          <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 8px;">
            <h4 style="font-size: 15px; font-weight: 650;">${item.title}</h4>
            <div style="display: flex; gap: 8px; align-items: center;">
              <span class="metric-trend ${item.variance.startsWith('+') ? 'trend-up' : 'trend-down'}">${item.variance}</span>
              <span style="font-size: 11px; color: var(--muted);">${item.status}</span>
            </div>
          </div>
          <p style="font-size: 13px; color: var(--muted); line-height: 1.5;">${item.content}</p>
        </div>
      `).join('');
    }

    // Tab switching
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
    }

    // File upload handling
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const parsedData = parseCSV(text);
          
          if (parsedData) {
            currentData = parsedData;
            renderAllData();
            showNotification('File uploaded successfully!', 'success');
          } else {
            showNotification('Invalid file format. Please use the template.', 'error');
          }
        } catch (error) {
          console.error('Parse error:', error);
          showNotification('Error parsing file: ' + error.message, 'error');
        }
        
        // Reset file input so the same file can be uploaded again
        event.target.value = '';
      };

      reader.onerror = function() {
        showNotification('Error reading file. Please try again.', 'error');
        event.target.value = '';
      };

      reader.readAsText(file);
    }

    // Parse CSV file
    function parseCSV(text) {
      try {
        const lines = text.trim().split('\n').map(line => line.trim()).filter(line => line && !line.toLowerCase().startsWith('notes'));
        
        if (lines.length < 2) {
          throw new Error('File appears to be empty or invalid.');
        }

        // Parse header
        const header = lines[0].split(',').map(h => h.trim().toLowerCase());
        
        // Validate required columns
        const requiredColumns = ['cost center', 'department', 'current headcount', 'prior year headcount', 'avg cost per head', 'budget', 'actual'];
        const missingColumns = requiredColumns.filter(col => !header.includes(col));
        
        if (missingColumns.length > 0) {
          throw new Error(`Missing required columns: ${missingColumns.join(', ')}`);
        }

        // Get column indices
        const getIndex = (name) => header.findIndex(h => h.includes(name));
        
        const indices = {
          costCenter: getIndex('cost center'),
          department: getIndex('department'),
          currentHC: getIndex('current headcount'),
          priorHC: getIndex('prior year headcount'),
          avgCost: getIndex('avg cost per head'),
          budget: getIndex('budget'),
          actual: getIndex('actual'),
          driver: getIndex('driver'),
          action: getIndex('action'),
          itAlloc: getIndex('it services'),
          facAlloc: getIndex('facilities'),
          hrAlloc: getIndex('hr services'),
          legalAlloc: getIndex('legal')
        };

        // Parse data rows
        const headcount = [];
        const variance = [];
        let totalIT = 0, totalFac = 0, totalHR = 0, totalLegal = 0;

        for (let i = 1; i < lines.length; i++) {
          const cols = lines[i].split(',').map(c => c.trim());
          if (cols.length < requiredColumns.length) continue;

          const dept = cols[indices.department];
          
          // Headcount data
          headcount.push({
            costCenter: cols[indices.costCenter],
            department: dept,
            current: parseInt(cols[indices.currentHC]) || 0,
            prior: parseInt(cols[indices.priorHC]) || 0,
            avgCost: parseInt(cols[indices.avgCost]) || 0
          });

          // Variance data
          variance.push({
            department: dept,
            budget: parseInt(cols[indices.budget]) || 0,
            actual: parseInt(cols[indices.actual]) || 0,
            driver: cols[indices.driver] || 'N/A',
            action: cols[indices.action] || 'N/A'
          });

          // Accumulate allocation totals
          if (indices.itAlloc >= 0) totalIT += parseInt(cols[indices.itAlloc]) || 0;
          if (indices.facAlloc >= 0) totalFac += parseInt(cols[indices.facAlloc]) || 0;
          if (indices.hrAlloc >= 0) totalHR += parseInt(cols[indices.hrAlloc]) || 0;
          if (indices.legalAlloc >= 0) totalLegal += parseInt(cols[indices.legalAlloc]) || 0;
        }

        // Build allocation data from individual department allocations
        const allocation = [];
        
        if (totalIT > 0) {
          allocation.push({
            service: 'IT Services',
            total: totalIT,
            method: 'Headcount',
            finance: parseInt(lines[1].split(',')[indices.itAlloc]) || 0,
            engineering: parseInt(lines[2].split(',')[indices.itAlloc]) || 0,
            sales: parseInt(lines[3].split(',')[indices.itAlloc]) || 0,
            marketing: parseInt(lines[4].split(',')[indices.itAlloc]) || 0,
            operations: parseInt(lines[5].split(',')[indices.itAlloc]) || 0
          });
        }

        if (totalFac > 0) {
          allocation.push({
            service: 'Facilities',
            total: totalFac,
            method: 'Square Footage',
            finance: parseInt(lines[1].split(',')[indices.facAlloc]) || 0,
            engineering: parseInt(lines[2].split(',')[indices.facAlloc]) || 0,
            sales: parseInt(lines[3].split(',')[indices.facAlloc]) || 0,
            marketing: parseInt(lines[4].split(',')[indices.facAlloc]) || 0,
            operations: parseInt(lines[5].split(',')[indices.facAlloc]) || 0
          });
        }

        if (totalHR > 0) {
          allocation.push({
            service: 'HR Services',
            total: totalHR,
            method: 'Headcount',
            finance: parseInt(lines[1].split(',')[indices.hrAlloc]) || 0,
            engineering: parseInt(lines[2].split(',')[indices.hrAlloc]) || 0,
            sales: parseInt(lines[3].split(',')[indices.hrAlloc]) || 0,
            marketing: parseInt(lines[4].split(',')[indices.hrAlloc]) || 0,
            operations: parseInt(lines[5].split(',')[indices.hrAlloc]) || 0
          });
        }

        if (totalLegal > 0) {
          allocation.push({
            service: 'Legal & Compliance',
            total: totalLegal,
            method: 'Revenue Split',
            finance: parseInt(lines[1].split(',')[indices.legalAlloc]) || 0,
            engineering: parseInt(lines[2].split(',')[indices.legalAlloc]) || 0,
            sales: parseInt(lines[3].split(',')[indices.legalAlloc]) || 0,
            marketing: parseInt(lines[4].split(',')[indices.legalAlloc]) || 0,
            operations: parseInt(lines[5].split(',')[indices.legalAlloc]) || 0
          });
        }

        if (headcount.length === 0) {
          throw new Error('No valid data rows found in file.');
        }

        // If no allocation data, generate default
        if (allocation.length === 0) {
          const totalHeadcount = headcount.reduce((sum, d) => sum + d.current, 0);
          allocation.push({
            service: 'Shared Services',
            total: 1000000,
            method: 'Headcount',
            finance: Math.round(1000000 * headcount[0].current / totalHeadcount),
            engineering: Math.round(1000000 * headcount[1].current / totalHeadcount),
            sales: Math.round(1000000 * headcount[2].current / totalHeadcount),
            marketing: Math.round(1000000 * headcount[3].current / totalHeadcount),
            operations: Math.round(1000000 * headcount[4].current / totalHeadcount)
          });
        }

        return { headcount, allocation, variance };
      } catch (error) {
        throw new Error('CSV parsing failed: ' + error.message);
      }
    }

    // Show notification
    function showNotification(message, type = 'info') {
      // Remove existing notification
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();

      // Create notification
      const notification = document.createElement('div');
      notification.className = 'notification notification-' + type;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-size: 20px;">${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span>
          <span>${message}</span>
        </div>
      `;

      // Add styles
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 24px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px 20px;
        box-shadow: var(--shadow);
        z-index: 1000;
        animation: slideIn 300ms ease;
        max-width: 400px;
      `;

      if (type === 'success') {
        notification.style.borderColor = 'rgba(5, 150, 105, 0.3)';
        notification.style.background = 'rgba(5, 150, 105, 0.05)';
      } else if (type === 'error') {
        notification.style.borderColor = 'rgba(239, 68, 68, 0.3)';
        notification.style.background = 'rgba(239, 68, 68, 0.05)';
      }

      document.body.appendChild(notification);

      // Auto remove after 4 seconds
      setTimeout(() => {
        notification.style.animation = 'slideOut 300ms ease';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }

    // Drag and drop
    const uploadArea = document.getElementById('uploadArea');
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileUpload({ target: { files } });
      }
    });

    // Download template
    function downloadTemplate() {
      // Create CSV template with single unified structure
      const template = `Cost Center,Department,Current Headcount,Prior Year Headcount,Avg Cost per Head,Budget,Actual,Variance Driver,Variance Action,IT Services Allocation,Facilities Allocation,HR Services Allocation,Legal Allocation
CC-100,Finance,32,30,85000,2720000,2800000,Headcount +2,Approved hire for compliance,320000,240000,120000,96000
CC-200,Engineering,45,42,95000,4275000,4420000,Compensation adjustment,Market rate correction Q2,450000,337500,168750,135000
CC-300,Sales,38,35,75000,2850000,2775000,Lower commission rate,Favorable variance,380000,285000,142500,114000
CC-400,Marketing,28,26,68000,1904000,2070000,Campaign overspend,Review and reforecast,280000,210000,105000,84000
CC-500,Operations,35,33,62000,2170000,2100000,Delayed hires,On track to close gap Q3,350000,262500,131250,105000
CC-600,HR,18,16,72000,1296000,1350000,Recruiting fees,Within acceptable range,180000,135000,67500,54000

Notes:
- Keep the header row (row 1) unchanged
- Edit the data rows (rows 2-7) with your actual data
- All allocation columns should sum to the total cost for each service
- IT Services total: 1960000
- Facilities total: 1470000
- HR Services total: 735000
- Legal & Compliance total: 588000`;

      const blob = new Blob([template], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'indirect-cost-headcount-template.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
      
      showNotification('Template downloaded! Fill it out and upload to see your data.', 'success');
    }

    // Utility: Format currency
    function formatCurrency(value, decimals = 2) {
      return '$' + value.toLocaleString('en-US', {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

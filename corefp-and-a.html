<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Industry-Adaptive FP&A Simulator ‚Äî Real-time financial planning and scenario modeling" />
  <meta name="theme-color" content="#0B1220" />
  <title>FP&A Simulator ‚Äî Industry-Adaptive Financial Planning</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Favicon -->
<link rel="icon" type="image/png" href="favicon.png">

  
  <style>
    :root {
      --bg: #ffffff;
      --bg-muted: #f6f8fb;
      --text: #0b1220;
      --muted: #5d6b7a;
      --border: rgba(12, 23, 45, 0.10);
      --shadow: 0 10px 30px rgba(11, 18, 32, 0.08);
      --shadow-soft: 0 8px 18px rgba(11, 18, 32, 0.06);
      --accent: #0f766e;
      --accent-2: #1b4d7a;
      --accent-soft: rgba(15, 118, 110, 0.10);
      --radius: 18px;
      --radius-sm: 14px;
      --max: 1120px;
      --font-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-sans);
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a { color: inherit; text-decoration: none; }
    p { margin: 0; }
    h1, h2, h3, h4 { margin: 0; letter-spacing: -0.02em; }

    .container {
      width: min(var(--max), calc(100% - 48px));
      margin: 0 auto;
    }

    .skip-link {
      position: absolute;
      left: -999px;
      top: 12px;
      padding: 10px 12px;
      background: var(--text);
      color: white;
      border-radius: 10px;
      z-index: 9999;
    }
    .skip-link:focus { left: 12px; }

    /* Header / Nav */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,0.78);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      gap: 16px;
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 650;
      letter-spacing: -0.02em;
    }

    .brand-mark {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 6px var(--accent-soft);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      transition: all 140ms ease;
    }
    .back-link:hover {
      border-color: rgba(12, 23, 45, 0.18);
      box-shadow: 0 6px 18px rgba(11,18,32,0.06);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid transparent;
      transition: all 140ms ease;
      user-select: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn:active { transform: translateY(1px); }

    .btn-solid {
      background: var(--text);
      color: white;
      box-shadow: var(--shadow-soft);
    }
    .btn-solid:hover { box-shadow: var(--shadow); }

    .btn-ghost {
      background: white;
      border-color: var(--border);
      color: var(--text);
    }
    .btn-ghost:hover { border-color: rgba(12, 23, 45, 0.18); box-shadow: 0 6px 18px rgba(11,18,32,0.06); }

    .btn-accent {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-soft);
    }
    .btn-accent:hover { box-shadow: var(--shadow); }

    .btn-sm {
      padding: 7px 12px;
      font-size: 13px;
    }

    /* Module section */
    .module-section {
      padding: 32px 0;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }

    .module-header {
      margin-bottom: 24px;
    }

    .module-eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(246,248,251,0.8);
      color: var(--muted);
      margin-bottom: 10px;
    }

    .module-title {
      font-size: 32px;
      line-height: 1.1;
      margin-bottom: 8px;
    }

    .module-subtitle {
      font-size: 16px;
      color: var(--muted);
      max-width: 60ch;
    }

    .module-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    /* Industry & Scenario Tabs */
    .tab-section {
      margin: 20px 0;
    }

    .tab-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
      margin-bottom: 10px;
      display: block;
    }

    .tab-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 9px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      cursor: pointer;
      transition: all 140ms ease;
    }

    .tab:hover {
      border-color: rgba(12, 23, 45, 0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.05);
    }

    .tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      box-shadow: var(--shadow-soft);
    }

    /* Main content */
    .main-content {
      padding: 24px 0 0 0;
      background: var(--bg);
    }

    .layout-grid {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 20px;
      align-items: start;
    }

    /* Sidebar */
    .sidebar {
      position: sticky;
      top: 84px;
      display: grid;
      gap: 12px;
    }

    .sidebar-section {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-soft);
    }

    .sidebar-title {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
      margin-bottom: 12px;
    }

    /* Controls */
    .control-item {
      margin-bottom: 18px;
    }

    .control-item:last-child {
      margin-bottom: 0;
    }

    .control-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .control-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-2);
      font-family: var(--font-mono);
    }

    .control-input-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-input {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--bg-muted);
      outline: none;
      cursor: pointer;
    }

    .control-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(15, 118, 110, 0.3);
      transition: all 140ms ease;
    }

    .control-input::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.4);
    }

    .control-input::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(15, 118, 110, 0.3);
      border: none;
    }

    .control-buttons {
      display: flex;
      gap: 4px;
    }

    .control-btn {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 140ms ease;
    }

    .control-btn:hover {
      background: var(--bg-muted);
      border-color: rgba(12, 23, 45, 0.18);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    /* Cards */
    .card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-soft);
    }

    .card-title {
      font-size: 18px;
      font-weight: 650;
      margin-bottom: 20px;
      color: var(--text);
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      transition: all 140ms ease;
    }

    .kpi-card:hover {
      box-shadow: var(--shadow);
      transform: translateY(-2px);
    }

    .kpi-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
      margin-bottom: 4px;
    }

    .kpi-change {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .kpi-change.positive {
      color: #059669;
    }

    .kpi-change.negative {
      color: #dc2626;
    }

    .kpi-change.neutral {
      color: var(--muted);
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 380px;
      padding: 16px 0;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    /* Data Preview */
    .data-preview {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }

    .data-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .data-preview-title {
      font-size: 18px;
      font-weight: 650;
      color: var(--text);
    }

    .data-preview-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 650;
      background: var(--accent-soft);
      color: var(--accent-2);
    }

    .data-table-wrapper {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .data-table th {
      background: var(--bg-muted);
      padding: 12px 16px;
      text-align: left;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }

    .data-table tbody tr:last-child td {
      border-bottom: none;
    }

    .data-table tbody tr:hover {
      background: var(--bg-muted);
    }

    /* Commentary */
    .commentary {
      background: linear-gradient(135deg, var(--accent-soft), rgba(27,77,122,0.05));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-soft);
    }

    .commentary-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .commentary-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--accent);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .commentary-title {
      font-size: 16px;
      font-weight: 650;
      color: var(--text);
    }

    .commentary-content {
      font-size: 14px;
      line-height: 1.6;
      color: var(--muted);
    }

    .commentary-content p {
      margin-bottom: 14px;
    }

    .commentary-content p:last-child {
      margin-bottom: 0;
    }

    .commentary-content strong {
      color: var(--text);
      font-weight: 650;
    }

    .commentary-highlight {
      display: inline-flex;
      padding: 2px 8px;
      background: white;
      border-radius: 6px;
      font-weight: 700;
      color: var(--accent-2);
      font-family: var(--font-mono);
      font-size: 13px;
    }

    /* File Upload */
    .file-upload {
      position: relative;
      display: inline-block;
    }

    .file-upload input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 80px;
      right: 32px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px 20px;
      box-shadow: var(--shadow);
      z-index: 200;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 340px;
      animation: slideIn 300ms ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .notification.success .notification-icon {
      background: #059669;
      color: white;
    }

    .notification.error .notification-icon {
      background: #dc2626;
      color: white;
    }

    .notification.info .notification-icon {
      background: var(--accent);
      color: white;
    }

    .notification-message {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .layout-grid {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: relative;
        top: 0;
      }

      .chart-grid {
        grid-template-columns: 1fr;
      }

      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }

      .module-title {
        font-size: 28px;
      }
    }

    /* ‚îÄ‚îÄ Next module banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .next-module-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 14px;
      padding: 24px 32px;
      background: var(--bg-muted);
      border-top: 1px solid var(--border);
      margin-top: 64px;
    }
    .next-module-label {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
    }
    .next-module-title {
      font-size: 15px;
      font-weight: 650;
      color: var(--text);
      margin-top: 2px;
    }
    .next-module-why {
      font-size: 13px;
      color: var(--muted);
      margin-top: 2px;
    }
    .next-module-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
  
    /* ‚îÄ‚îÄ Print / CFO Pack ‚îÄ‚îÄ */
    @media print {
      .site-header, .module-actions, .tab-section, .sidebar, .data-needed-section,
      .next-module-bar, .notification, #varianceUploadSection, .btn-no-print,
      #topDriversCard { display: none !important; }
      .layout-grid { grid-template-columns: 1fr !important; }
      .chart-grid > *:not(:first-child) { display: none !important; }
      body { background: white; color: #000; }
      .kpi-grid { grid-template-columns: repeat(4,1fr) !important; }
      .main-content { padding: 0 !important; }
      .card, .kpi-card, .commentary { box-shadow: none !important; border: 1px solid #ccc !important; }
      #varianceModeContent { display: none !important; }
      #printTitle { display: block !important; font-size: 22px; font-weight: 700; margin-bottom: 16px; }
    }
    #printTitle { display: none; }

    /* ‚îÄ‚îÄ Mode Toggle ‚îÄ‚îÄ */
    .mode-toggle {
      display: flex; gap: 4px; align-items: center;
      background: var(--bg-muted); border: 1px solid var(--border);
      border-radius: 999px; padding: 4px; margin-bottom: 16px;
    }
    .mode-toggle .tab { border-radius: 999px; padding: 7px 18px; font-size: 13px; background: transparent; border: none; }
    .mode-toggle .tab.active { background: var(--accent); color: white; border: none; }

    /* ‚îÄ‚îÄ Error Banner ‚îÄ‚îÄ */
    .error-banner {
      background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px;
      padding: 12px 16px; margin-bottom: 16px; color: #dc2626; font-size: 14px; font-weight: 600;
    }

    /* ‚îÄ‚îÄ Variance Table ‚îÄ‚îÄ */
    .variance-table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 16px; }
    .variance-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .variance-table th { background: var(--bg-muted); padding: 10px 14px; text-align: left;
      font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;
      color: var(--muted); border-bottom: 1px solid var(--border); }
    .variance-table td { padding: 10px 14px; border-bottom: 1px solid var(--border); color: var(--text); }
    .variance-table tbody tr:last-child td { border-bottom: none; }
    .variance-table tbody tr:hover { background: var(--bg-muted); }
    .var-pos, .fav { color: #059669; font-weight: 700; }
    .var-neg, .unfav { color: #dc2626; font-weight: 700; }
    .var-neutral { color: var(--muted); }
    .row-total td { font-weight: 700; background: var(--bg-muted); }
    .narrative-item { margin-bottom: 16px; }
    .narrative-item-label { font-size: 14px; font-weight: 650; color: var(--text); margin-bottom: 6px; }
    .narrative-item-actions { font-size: 13px; color: var(--muted); white-space: pre-line; line-height: 1.6; }

    /* ‚îÄ‚îÄ Narrative Card ‚îÄ‚îÄ */
    .narrative-card {
      background: linear-gradient(135deg, var(--accent-soft), rgba(27,77,122,0.05));
      border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px;
    }
    .narrative-card h4 { font-size: 15px; font-weight: 700; margin-bottom: 12px; color: var(--text); }
    .narrative-card ul { margin: 0; padding-left: 18px; }
    .narrative-card li { font-size: 13px; line-height: 1.7; color: var(--muted); }
    .narrative-card strong { color: var(--text); }

    /* ‚îÄ‚îÄ Top Drivers Card ‚îÄ‚îÄ */
    #topDriversCard { background: white; border: 1px solid var(--border); border-radius: var(--radius);
      padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-soft); }
    .driver-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 13px; }
    .driver-bar-bg { flex: 1; height: 8px; background: var(--bg-muted); border-radius: 4px; overflow: hidden; }
    .driver-bar-fill { height: 100%; border-radius: 4px; background: var(--accent); transition: width 300ms; }
    .driver-label { width: 140px; font-weight: 600; color: var(--text); flex-shrink: 0; }
    .driver-impact { width: 80px; text-align: right; font-weight: 700; font-family: var(--font-mono);
      font-size: 12px; flex-shrink: 0; }

    /* ‚îÄ‚îÄ Scenario Save/Load ‚îÄ‚îÄ */
    .scenario-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; padding-top: 12px;
      border-top: 1px solid var(--border); }
    #scenarioModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      z-index: 300; align-items: center; justify-content: center; }
    #scenarioModal.open { display: flex; }
    .modal-box { background: white; border-radius: var(--radius); padding: 28px;
      width: min(440px, 90vw); box-shadow: var(--shadow); }
    .modal-box h3 { margin-bottom: 16px; font-size: 18px; }
    .modal-list { max-height: 240px; overflow-y: auto; margin-bottom: 16px; }
    .modal-item { display: flex; justify-content: space-between; align-items: center;
      padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
    .modal-item:hover { background: var(--bg-muted); }
    .modal-item-name { font-weight: 600; font-size: 14px; }
    .modal-item-meta { font-size: 12px; color: var(--muted); }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }

    /* ‚îÄ‚îÄ Collapsible sidebar sections ‚îÄ‚îÄ */
    .sb-group {
      border: 1px solid var(--border);
      border-radius: 14px;
      margin-bottom: 8px;
      overflow: hidden;
      background: white;
    }
    .sb-group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 14px;
      cursor: pointer;
      user-select: none;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      transition: background 120ms ease;
      gap: 8px;
    }
    .sb-group-header:hover { background: var(--bg-muted); }
    .sb-group-header .sb-chevron {
      font-size: 10px; color: var(--muted); transition: transform 200ms ease; flex-shrink: 0;
    }
    .sb-group-header.open .sb-chevron { transform: rotate(180deg); }
    .sb-group-header .sb-badge {
      font-size: 10px; font-weight: 600;
      padding: 2px 8px; border-radius: 999px;
      background: var(--accent-soft); color: var(--accent);
      flex-shrink: 0; margin-left: auto;
    }
    .sb-group-body {
      display: none; padding: 0 12px 12px 12px;
      border-top: 1px solid var(--border);
    }
    .sb-group-body.open { display: block; }
    .sb-tabs { display: flex; flex-direction: column; gap: 6px; padding-top: 10px; }
    .sb-tab {
      padding: 9px 12px; border-radius: 10px;
      border: 1px solid var(--border); background: white;
      font-size: 13px; font-weight: 600; cursor: pointer; text-align: left;
      transition: all 120ms ease; display: flex; align-items: center; gap: 8px;
    }
    .sb-tab:hover { background: var(--bg-muted); border-color: rgba(12,23,45,0.16); }
    .sb-tab.active { background: var(--accent); color: white; border-color: var(--accent); }
    .sb-tab .sb-tab-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: currentColor; opacity: 0.6; flex-shrink: 0;
    }
    .sb-action-btn {
      display: flex; align-items: center; gap: 8px;
      width: 100%; padding: 9px 12px;
      border-radius: 10px; border: 1px solid var(--border);
      background: white; font-size: 13px; font-weight: 600;
      cursor: pointer; margin-top: 6px;
      transition: all 120ms ease; text-align: left;
    }
    .sb-action-btn:hover { background: var(--bg-muted); border-color: rgba(12,23,45,0.16); }
    .sb-action-btn.sb-action-primary {
      background: var(--text); color: white; border-color: var(--text);
    }
    .sb-action-btn.sb-action-primary:hover { box-shadow: 0 4px 12px rgba(11,18,32,0.18); }
    .sb-action-btn.sb-action-accent {
      background: var(--accent); color: white; border-color: var(--accent);
    }
    .sb-file-hidden { position: absolute; opacity: 0; width: 0; height: 0; }
    .sb-mode-pills { display: flex; gap: 6px; padding-top: 10px; flex-wrap: wrap; }
    .sb-mode-pill {
      flex: 1; min-width: 70px; padding: 8px 6px; border-radius: 10px;
      border: 1px solid var(--border); background: white;
      font-size: 12px; font-weight: 600; cursor: pointer; text-align: center;
      transition: all 120ms ease;
    }
    .sb-mode-pill:hover { background: var(--bg-muted); }
    .sb-mode-pill.active { background: var(--accent); color: white; border-color: var(--accent); }

    /* ‚îÄ‚îÄ Decision / So What? Box ‚îÄ‚îÄ */
    .decision-box {
      border: 1.5px solid var(--accent);
      border-radius: 18px;
      padding: 20px 24px;
      margin-bottom: 24px;
      background: white;
      box-shadow: 0 0 0 4px rgba(15,118,110,0.08), 0 8px 18px rgba(11,18,32,0.06);
      transition: border-color 200ms ease, background 200ms ease;
    }
    .decision-box--run    { border-color: #0f766e; background: #f0fdf9; box-shadow: 0 0 0 4px rgba(15,118,110,0.10), 0 8px 18px rgba(11,18,32,0.06); }
    .decision-box--caution{ border-color: #d97706; background: #fffbeb; box-shadow: 0 0 0 4px rgba(217,119,6,0.10), 0 8px 18px rgba(11,18,32,0.06); }
    .decision-box--hold   { border-color: #dc2626; background: #fef2f2; box-shadow: 0 0 0 4px rgba(220,38,38,0.10), 0 8px 18px rgba(11,18,32,0.06); }
    .decision-box-eyebrow {
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em;
      color: #0f766e; margin-bottom: 8px;
    }
    .decision-box--caution .decision-box-eyebrow { color: #d97706; }
    .decision-box--hold   .decision-box-eyebrow { color: #dc2626; }
    .decision-box-verdict {
      font-size: 20px; font-weight: 700; letter-spacing: -0.02em;
      color: var(--text); margin-bottom: 12px;
    }
    .verdict-action { color: #0f766e; }
    .decision-box--caution .verdict-action { color: #d97706; }
    .decision-box--hold   .verdict-action { color: #dc2626; }
    .decision-box-bullets {
      list-style: none; margin: 0 0 12px 0; padding: 0;
      display: flex; flex-direction: column; gap: 6px;
    }
    .decision-box-bullets li {
      font-size: 13px; color: var(--muted);
      display: flex; align-items: flex-start; gap: 8px; line-height: 1.45;
    }
    .decision-box-bullets li::before {
      content: '‚Ä∫'; color: #0f766e; font-weight: 700; flex-shrink: 0; margin-top: 1px;
    }
    .decision-box--caution .decision-box-bullets li::before { color: #d97706; }
    .decision-box--hold   .decision-box-bullets li::before { color: #dc2626; }
    .decision-box-guardrails {
      border-top: 1px solid rgba(12,23,45,0.10);
      padding-top: 12px; margin-top: 4px;
      display: flex; flex-wrap: wrap; gap: 8px;
    }
    .guardrail-flag {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 12px; font-weight: 600; padding: 5px 10px; border-radius: 999px;
    }
    .guardrail-flag--ok   { background: rgba(15,118,110,0.10); border: 1px solid rgba(15,118,110,0.20); color: #0f766e; }
    .guardrail-flag--warn { background: rgba(217,119,6,0.10);  border: 1px solid rgba(217,119,6,0.25);  color: #d97706; }
    .guardrail-flag--risk { background: rgba(220,38,38,0.10);  border: 1px solid rgba(220,38,38,0.20);  color: #dc2626; }

    /* ‚îÄ‚îÄ Sensitivity item styles ‚îÄ‚îÄ */
    .sensitivity-outcome-btn {
      padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border);
      background: white; font-size: 11px; font-weight: 600; cursor: pointer;
    }
    .sensitivity-outcome-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    .sensitivity-item { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; font-size: 12px; }
    .sensitivity-rank { width: 20px; color: var(--muted); font-weight: 700; flex-shrink: 0; }
    .sensitivity-label { width: 100px; font-weight: 600; color: var(--text); flex-shrink: 0; font-size: 11px; }
    .sensitivity-bar-wrap { flex: 1; height: 6px; background: var(--bg-muted); border-radius: 3px; overflow: hidden; }
    .sensitivity-bar { height: 100%; border-radius: 3px; }
    .sensitivity-value { width: 60px; text-align: right; font-weight: 700; font-family: var(--font-mono); font-size: 11px; flex-shrink: 0; }

    /* ‚îÄ‚îÄ Data-needed strip ‚îÄ‚îÄ */
    .data-needed-section {
      padding: 0 0 0 0;
      border-bottom: 1px solid var(--border, #e5e8ef);
    }
    .data-needed-wrap {
      max-width: var(--max-w, 1200px);
      margin: 0 auto;
      padding: 20px 32px 24px;
    }
    .data-needed-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--muted, #6b7280);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .data-needed-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(185px, 1fr));
      gap: 8px;
    }
    .data-needed-item {
      padding: 10px 12px;
      border: 1px solid var(--border, #e5e8ef);
      border-radius: 9px;
      display: flex;
      align-items: flex-start;
      gap: 9px;
      background: #fafbfc;
    }
    .data-needed-icon {
      width: 26px;
      height: 26px;
      font-size: 13px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .data-needed-name {
      font-size: 11px;
      font-weight: 700;
      color: var(--text, #0b1220);
      margin-bottom: 3px;
      line-height: 1.35;
    }
    .data-needed-desc {
      font-size: 10px;
      color: var(--muted, #6b7280);
      line-height: 1.5;
    }

</style>
</head>
<body>
  <!-- Skip link for accessibility -->
  <a class="skip-link" href="#main">Skip to content</a>

  <!-- HEADER -->
  <header class="site-header" id="top">
    <div class="container nav">
      <a class="brand" href="index.html#projects" aria-label="Back to portfolio">
        <span class="brand-mark" aria-hidden="true"></span>
        <span>FP&A Portfolio</span>
      </a>

      <a class="back-link" href="index.html#projects">
        ‚Üê Back to Portfolio
      </a>
    </div>
  </header>

  <!-- MODULE SECTION ‚Äî clean title only, controls live in sidebar -->
  <section class="module-section">
    <div class="container">
      <div class="module-header">
        <div class="module-eyebrow">‚≠ê Industry-Adaptive Model</div>
        <h1 class="module-title" id="moduleTitle">SaaS Financial Model</h1>
        <p class="module-subtitle">Real-time financial simulation and scenario planning with dynamic driver modeling</p>
      </div>
    </div>
  </section>



  <!-- DATA NEEDED STRIP -->
  <div class="data-needed-section">
    <div class="data-needed-wrap">
      <div class="data-needed-label">üìÇ &nbsp;Data needed for this module</div>
      <div class="data-needed-grid">
        <div class="data-needed-item"><div class="data-needed-icon" style="background:#eff6ff;">üìä</div><div><div class="data-needed-name">P&L / Income Statement</div><div class="data-needed-desc">Revenue, COGS, gross margin &amp; OpEx ‚Üí core model inputs</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#f0fdf9;">üè¶</div><div><div class="data-needed-name">Balance Sheet Snapshot</div><div class="data-needed-desc">Assets, liabilities &amp; equity ‚Üí working capital &amp; solvency context</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#fef3c7;">üíµ</div><div><div class="data-needed-name">Cash Flow Statement</div><div class="data-needed-desc">Operating, investing &amp; financing flows ‚Üí runway &amp; liquidity</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#f5f3ff;">üìÖ</div><div><div class="data-needed-name">Budget / Annual Plan</div><div class="data-needed-desc">Approved targets by cost centre ‚Üí variance &amp; scenario base</div></div></div>
          <div class="data-needed-item"><div class="data-needed-icon" style="background:#fdf2f8;">üìà</div><div><div class="data-needed-name">Historical Actuals (2‚Äì3 yrs)</div><div class="data-needed-desc">Past performance by month ‚Üí trend &amp; seasonality calibration</div></div></div>
      </div>
    </div>
  </div>

<!-- MAIN CONTENT -->
  <main id="main" class="main-content">
    <div class="container">
      <div class="layout-grid">
        <!-- SIDEBAR: collapsible control groups -->
        <aside class="sidebar">

          <!-- ‚ë† DATA MODE ‚Äî always visible as status -->
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding:0 2px;">
            <span style="font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--muted);">Data</span>
            <span id="dataModeIndicator" style="font-size:11px;font-weight:600;padding:3px 10px;border-radius:999px;background:var(--accent-soft);color:var(--accent);">üìä Sample</span>
          </div>

          <!-- ‚ë° MODE (Simulator / Variance) -->
          <div class="sb-group">
            <div class="sb-group-header open" onclick="toggleSbGroup(this)">
              <span>Mode</span>
              <span id="sbModeLabel" class="sb-badge">Simulator</span>
              <span class="sb-chevron">‚ñº</span>
            </div>
            <div class="sb-group-body open">
              <div class="sb-mode-pills">
                <button class="sb-mode-pill active" id="modeSimulator" onclick="switchMode('simulator')">‚öô Simulator</button>
                <button class="sb-mode-pill" id="modeVariance" onclick="switchMode('variance')">üìä Variance</button>
              </div>
              <button class="sb-action-btn" onclick="window.print()" style="margin-top:10px;">üñ® Export CFO Pack</button>
            </div>
          </div>

          <!-- ‚ë¢ INDUSTRY -->
          <div class="sb-group">
            <div class="sb-group-header open" onclick="toggleSbGroup(this)">
              <span>Industry</span>
              <span id="sbIndustryLabel" class="sb-badge">SaaS</span>
              <span class="sb-chevron">‚ñº</span>
            </div>
            <div class="sb-group-body open" id="industryTabs">
              <div class="sb-tabs">
                <button class="sb-tab active" data-industry="saas" onclick="switchIndustry('saas')"><span class="sb-tab-dot"></span>SaaS</button>
                <button class="sb-tab" data-industry="media" onclick="switchIndustry('media')"><span class="sb-tab-dot"></span>Media &amp; Platforms</button>
                <button class="sb-tab" data-industry="manufacturing" onclick="switchIndustry('manufacturing')"><span class="sb-tab-dot"></span>Manufacturing</button>
                <button class="sb-tab" data-industry="lending" onclick="switchIndustry('lending')"><span class="sb-tab-dot"></span>Lending</button>
                <button class="sb-tab" data-industry="realestate" onclick="switchIndustry('realestate')"><span class="sb-tab-dot"></span>Real Estate</button>
              </div>
            </div>
          </div>

          <!-- ‚ë£ SCENARIO -->
          <div class="sb-group">
            <div class="sb-group-header open" onclick="toggleSbGroup(this)">
              <span>Scenario</span>
              <span id="sbScenarioLabel" class="sb-badge">Base Case</span>
              <span class="sb-chevron">‚ñº</span>
            </div>
            <div class="sb-group-body open" id="scenarioTabs">
              <div class="sb-tabs">
                <button class="sb-tab active" data-scenario="base" onclick="switchScenario('base')"><span class="sb-tab-dot"></span>Base Case</button>
                <button class="sb-tab" data-scenario="upside" onclick="switchScenario('upside')"><span class="sb-tab-dot"></span>Upside</button>
                <button class="sb-tab" data-scenario="downside" onclick="switchScenario('downside')"><span class="sb-tab-dot"></span>Downside</button>
              </div>
            </div>
          </div>

          <!-- ‚ë§ DRIVERS & CONSTRAINTS (collapsed by default on mobile, open on desktop) -->
          <div class="sb-group">
            <div class="sb-group-header open" onclick="toggleSbGroup(this)">
              <span>Drivers</span>
              <span class="sb-chevron">‚ñº</span>
            </div>
            <div class="sb-group-body open" style="padding-top:10px;">
              <div id="controlsContainer"></div>
              <div class="scenario-actions" id="scenarioActions" style="padding-top:8px;border-top:1px solid var(--border);margin-top:4px;">
                <button class="btn btn-ghost btn-sm" onclick="saveScenario()">üíæ Save</button>
                <button class="btn btn-ghost btn-sm" onclick="openLoadModal()">üìÇ Load</button>
                <button class="btn btn-ghost btn-sm" onclick="copyShareLink()">üîó Share</button>
              </div>
            </div>
          </div>

          <!-- ‚ë• DATA ACTIONS (collapsed by default) -->
          <div class="sb-group">
            <div class="sb-group-header" onclick="toggleSbGroup(this)">
              <span>Data &amp; Upload</span>
              <span class="sb-chevron">‚ñº</span>
            </div>
            <div class="sb-group-body" style="padding-top:10px;">
              <button class="sb-action-btn" onclick="useSampleData()">üìä Use Sample Data</button>
              <button class="sb-action-btn sb-action-primary" onclick="generateRandomData()">üé≤ Generate Random</button>
              <button class="sb-action-btn sb-action-accent" onclick="downloadTemplate()">‚¨á Download Template</button>
              <div style="position:relative;margin-top:6px;">
                <input type="file" id="fileUpload" accept=".csv" onchange="handleFileUpload(event)" class="sb-file-hidden">
                <button class="sb-action-btn" onclick="document.getElementById('fileUpload').click()">üìÅ Upload CSV Data</button>
              </div>
            </div>
          </div>

          <!-- ‚ë¶ TOP DRIVERS SENSITIVITY -->
          <div id="topDriversCard" class="sb-group">
            <div class="sb-group-header" onclick="toggleSbGroup(this)">
              <span>Top Drivers</span>
              <span class="sb-chevron">‚ñº</span>
            </div>
            <div class="sb-group-body" style="padding-top:10px;">
              <div id="sensitivityOutcomeSelector" style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;"></div>
              <div style="font-size:11px;color:var(--muted);margin-bottom:8px;">Impact of +10% on each driver</div>
              <div id="sensitivityList"></div>
              <div id="topDriversList" style="display:none;"></div>
            </div>
          </div>

        </aside>

        <!-- MAIN CONTENT AREA -->
        <div>
          <!-- Variance Mode Content -->
          <div id="varianceModeContent" style="display:none;">
            <div id="varianceUploadSection" class="card" style="margin-bottom:20px;">
              <div class="card-title">üìä Actual vs Budget vs Forecast</div>
              <div id="varianceErrorBanner" class="error-banner" style="display:none;"></div>
              <p style="font-size:13px;color:var(--muted);margin-bottom:14px;">Upload a CSV with monthly actuals, budget, and forecast data to analyze variances.</p>
              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;">
                <button class="btn btn-accent btn-sm" onclick="downloadVarianceTemplate()">‚¨á Download Template</button>
                <div class="file-upload">
                  <input type="file" id="varianceFileUpload" accept=".csv" onchange="handleVarianceUpload(event)">
                  <button class="btn btn-solid btn-sm" onclick="document.getElementById('varianceFileUpload').click()">Upload Variance CSV</button>
                </div>
              </div>
              <div id="varianceMonthSelector" style="display:none;margin-bottom:16px;">
                <label style="font-size:13px;font-weight:600;margin-right:8px;">Month:</label>
                <select id="varianceMonthSelect" onchange="renderVarianceTable()" style="border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:13px;"></select>
              </div>
            </div>
            <div id="varianceTableContainer" style="display:none;">
              <div class="card" style="margin-bottom:20px;">
                <div class="card-title" id="varianceTableTitle">Variance Analysis</div>
                <div class="variance-table-wrap">
                  <table class="variance-table" id="varianceTable"></table>
                </div>
              </div>
              <div class="narrative-card">
                <div id="varianceNarrative"></div>
              </div>
            </div>
          </div>

          <!-- Print title (hidden on screen, shown in print) -->
          <div id="printTitle" style="display:none;font-size:22px;font-weight:700;margin-bottom:16px;"></div>

          <!-- ‚ú¶ DECISION BOX ‚Äî "So What?" -->
          <div id="decisionBox" class="decision-box decision-box--run" style="display:none;"></div>

          <!-- KPIs -->
          <div class="kpi-grid" id="kpiGrid">
            <!-- KPIs will be injected here -->
          </div>

          <!-- Data Preview Section -->
          <div class="data-preview" id="dataPreviewSection" style="display: none;">
            <div class="data-preview-header">
              <div class="data-preview-title">Uploaded Data Preview</div>
              <div class="data-preview-badge" id="dataPreviewBadge">
                <span id="dataPreviewCount">0 rows</span>
              </div>
            </div>
            <div class="data-table-wrapper">
              <table class="data-table" id="dataTable">
                <thead id="dataTableHead">
                  <!-- Table headers will be injected here -->
                </thead>
                <tbody id="dataTableBody">
                  <!-- Table rows will be injected here -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Charts -->
          <div class="chart-grid">
            <div class="card">
              <div class="card-title" id="chart1Title">Revenue Growth</div>
              <div class="chart-container">
                <canvas id="chart1"></canvas>
              </div>
            </div>

            <div class="card">
              <div class="card-title" id="chart2Title">Profitability</div>
              <div class="chart-container">
                <canvas id="chart2"></canvas>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom: 20px;">
            <div class="card-title" id="chart3Title">Cash Flow Forecast</div>
            <div class="chart-container">
              <canvas id="chart3"></canvas>
            </div>
          </div>

          <!-- Commentary -->
          <div class="commentary" id="commentarySection">
            <!-- Commentary will be injected here -->
          </div>
        </div>
      </div>
    </div>
  
  <!-- ‚îÄ‚îÄ Next Module ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <nav class="next-module-bar" aria-label="Next recommended module">
    <div>
      <div class="next-module-label">Next recommended</div>
      <div class="next-module-title">Commercial / Sales Finance</div>
      <div class="next-module-why">Plan is built ‚Äî now see how revenue decisions hold up at the channel and margin level.</div>
    </div>
    <div class="next-module-actions">
      <a class="btn btn-solid" href="commercial-sales.html">Open Commercial Sales ‚Üí</a>
      <a class="btn btn-ghost" href="index.html">‚Üê Back to Portfolio</a>
    </div>
  </nav>

<!-- Scenario Load Modal -->
<div id="scenarioModal" role="dialog" aria-modal="true" aria-label="Load Scenario">
  <div class="modal-box">
    <h3>üìÇ Saved Scenarios</h3>
    <div class="modal-list" id="savedScenarioList"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost btn-sm" onclick="closeLoadModal()">Cancel</button>
    </div>
  </div>
</div>

</main>

  <script>
    // ============================================
    // CONFIGURATION ENGINE
    // ============================================
    
    const INDUSTRIES = {
      saas: {
        name: 'SaaS',
        title: 'SaaS Financial Model',
        drivers: [
          { id: 'startingCustomers', label: 'Starting Customers', min: 50, max: 5000, default: 500, step: 50, format: 'number' },
          { id: 'mrr', label: 'Avg MRR per Customer', min: 50, max: 1000, default: 300, step: 10, format: 'currency' },
          { id: 'growth', label: 'Monthly Growth %', min: 0, max: 20, default: 8, step: 0.5, format: 'percent' },
          { id: 'churn', label: 'Churn Rate %', min: 0, max: 10, default: 3, step: 0.5, format: 'percent' },
          { id: 'cac', label: 'Customer CAC', min: 100, max: 2000, default: 500, step: 50, format: 'currency' },
          { id: 'grossMargin', label: 'Gross Margin %', min: 50, max: 95, default: 80, step: 1, format: 'percent' }
        ],
        kpis: [
          { id: 'arr', label: 'ARR', format: 'currency' },
          { id: 'customers', label: 'Customers', format: 'number' },
          { id: 'ltv', label: 'LTV/CAC', format: 'ratio' },
          { id: 'nrr', label: 'NRR', format: 'percent' }
        ],
        charts: [
          { id: 'chart1', title: 'MRR Growth', metric: 'mrrTrend', yLabel: 'MRR ($)' },
          { id: 'chart2', title: 'Net Revenue Retention', metric: 'nrrTrend', yLabel: 'NRR %' },
          { id: 'chart3', title: 'Cash Runway', metric: 'cash', yLabel: 'Cash Balance ($)' }
        ]
      },
      
      media: {
        name: 'Media & Platforms',
        title: 'Media & Advertising Model',
        drivers: [
          { id: 'users', label: 'Active Users', min: 100000, max: 10000000, default: 1000000, step: 100000, format: 'number' },
          { id: 'userGrowth', label: 'User Growth %', min: 0, max: 30, default: 10, step: 1, format: 'percent' },
          { id: 'engagement', label: 'Engagement min/user', min: 10, max: 120, default: 45, step: 5, format: 'number' },
          { id: 'cpm', label: 'Ad CPM', min: 1, max: 20, default: 8, step: 0.5, format: 'currency' },
          { id: 'fillRate', label: 'Ad Fill Rate %', min: 40, max: 95, default: 75, step: 5, format: 'percent' }
        ],
        kpis: [
          { id: 'adRevenue', label: 'Ad Revenue', format: 'currency' },
          { id: 'arpu', label: 'ARPU', format: 'currency' },
          { id: 'dau', label: 'DAU', format: 'number' },
          { id: 'ebitdaMargin', label: 'EBITDA Margin', format: 'percent' }
        ],
        charts: [
          { id: 'chart1', title: 'User Growth', metric: 'users', yLabel: 'Users' },
          { id: 'chart2', title: 'Revenue per User (ARPU)', metric: 'arpuTrend', yLabel: 'ARPU ($)' },
          { id: 'chart3', title: 'EBITDA Margin', metric: 'ebitdaMarginTrend', yLabel: 'Margin %' }
        ]
      },
      
      manufacturing: {
        name: 'Manufacturing',
        title: 'Manufacturing Operations Model',
        drivers: [
          { id: 'unitsPerMonth', label: 'Units per Month', min: 1000, max: 100000, default: 10000, step: 1000, format: 'number' },
          { id: 'sellPrice', label: 'Avg Sell Price', min: 10, max: 500, default: 100, step: 10, format: 'currency' },
          { id: 'materialCost', label: 'Material Cost %', min: 20, max: 60, default: 35, step: 1, format: 'percent' },
          { id: 'laborCost', label: 'Labor Cost %', min: 10, max: 40, default: 20, step: 1, format: 'percent' },
          { id: 'utilizationRate', label: 'Utilization Rate %', min: 50, max: 95, default: 75, step: 5, format: 'percent' }
        ],
        kpis: [
          { id: 'revenue', label: 'Revenue', format: 'currency' },
          { id: 'grossProfit', label: 'Gross Profit', format: 'currency' },
          { id: 'grossMargin', label: 'Gross Margin', format: 'percent' },
          { id: 'unitEconomics', label: 'Unit Contribution', format: 'currency' }
        ],
        charts: [
          { id: 'chart1', title: 'Production Volume', metric: 'units', yLabel: 'Units' },
          { id: 'chart2', title: 'Gross Margin Trend', metric: 'grossMarginTrend', yLabel: 'Margin %' },
          { id: 'chart3', title: 'Operating Cash Flow', metric: 'cashFlow', yLabel: 'Cash Flow ($)' }
        ]
      },
      
      lending: {
        name: 'Lending',
        title: 'Lending Portfolio Model',
        drivers: [
          { id: 'originations', label: 'Monthly Originations', min: 1000000, max: 50000000, default: 10000000, step: 1000000, format: 'currency' },
          { id: 'avgRate', label: 'Avg Interest Rate %', min: 3, max: 20, default: 8, step: 0.5, format: 'percent' },
          { id: 'defaultRate', label: 'Default Rate %', min: 0, max: 10, default: 2, step: 0.25, format: 'percent' },
          { id: 'recoveryRate', label: 'Recovery Rate %', min: 0, max: 80, default: 40, step: 5, format: 'percent' },
          { id: 'fundingCost', label: 'Funding Cost %', min: 1, max: 10, default: 4, step: 0.25, format: 'percent' }
        ],
        kpis: [
          { id: 'portfolioSize', label: 'Portfolio Size', format: 'currency' },
          { id: 'netInterestMargin', label: 'Net Interest Margin', format: 'percent' },
          { id: 'lossRate', label: 'Net Loss Rate', format: 'percent' },
          { id: 'roe', label: 'ROE', format: 'percent' }
        ],
        charts: [
          { id: 'chart1', title: 'Portfolio Growth', metric: 'portfolio', yLabel: 'Portfolio Size ($)' },
          { id: 'chart2', title: 'Credit Performance', metric: 'defaultsTrend', yLabel: 'Defaults ($)' },
          { id: 'chart3', title: 'Net Income', metric: 'netIncome', yLabel: 'Net Income ($)' }
        ]
      },
      
      realestate: {
        name: 'Real Estate',
        title: 'Real Estate & Leasing Model',
        drivers: [
          { id: 'totalSqm', label: 'Total Sqm', min: 10000, max: 500000, default: 100000, step: 10000, format: 'number' },
          { id: 'occupancyRate', label: 'Occupancy Rate %', min: 50, max: 100, default: 85, step: 5, format: 'percent' },
          { id: 'rentPerSqm', label: 'Rent per Sqm', min: 10, max: 100, default: 30, step: 5, format: 'currency' },
          { id: 'opexRatio', label: 'OpEx % of Revenue', min: 20, max: 50, default: 30, step: 2, format: 'percent' },
          { id: 'debtService', label: 'Debt Service', min: 0, max: 500000, default: 150000, step: 10000, format: 'currency' }
        ],
        kpis: [
          { id: 'rentalIncome', label: 'Rental Income', format: 'currency' },
          { id: 'noi', label: 'NOI', format: 'currency' },
          { id: 'noiMargin', label: 'NOI Margin', format: 'percent' },
          { id: 'capRate', label: 'Cap Rate', format: 'percent' }
        ],
        charts: [
          { id: 'chart1', title: 'Rental Revenue', metric: 'rent', yLabel: 'Revenue ($)' },
          { id: 'chart2', title: 'Net Operating Income', metric: 'noiTrend', yLabel: 'NOI ($)' },
          { id: 'chart3', title: 'Free Cash Flow', metric: 'fcf', yLabel: 'FCF ($)' }
        ]
      }
    };

    // ============================================
    // STATE MANAGEMENT
    // ============================================
    
    let currentIndustry = 'saas';
    let currentScenario = 'base';
    let currentDataMode = 'sample';
    let driverValues = {};
    let modelData = {};
    let charts = {};
    let uploadedData = null;

    // ============================================
    // INITIALIZATION
    // ============================================
    
    function init() {
      initializeDrivers();
      generateSampleData();
      renderAll();
    }

    function initializeDrivers() {
      const industry = INDUSTRIES[currentIndustry];
      driverValues = {};
      industry.drivers.forEach(driver => {
        driverValues[driver.id] = driver.default;
      });
    }

    // ============================================
    // INDUSTRY SWITCHING
    // ============================================
    
    function switchIndustry(industry) {
      currentIndustry = industry;
      
      // Update sb-tab active state (new sidebar)
      document.querySelectorAll('#industryTabs .sb-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.industry === industry);
      });
      // Legacy tab support
      document.querySelectorAll('#industryTabs .tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.industry === industry);
      });

      // Update sidebar badge
      const lbl = document.getElementById('sbIndustryLabel');
      if (lbl) lbl.textContent = INDUSTRIES[industry].name;
      
      document.getElementById('moduleTitle').textContent = INDUSTRIES[industry].title;
      
      initializeDrivers();
      generateSampleData();
      renderAll();
      
      showNotification(`Switched to ${INDUSTRIES[industry].name} model`, 'info');
    }

    // ============================================
    // SCENARIO SWITCHING
    // ============================================
    
    function switchScenario(scenario) {
      currentScenario = scenario;
      
      // Update sb-tab active state
      document.querySelectorAll('#scenarioTabs .sb-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.scenario === scenario);
      });
      document.querySelectorAll('#scenarioTabs .tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.scenario === scenario);
      });

      // Update sidebar badge
      const lbl = document.getElementById('sbScenarioLabel');
      if (lbl) {
        const names = { base: 'Base Case', upside: 'Upside', downside: 'Downside' };
        lbl.textContent = names[scenario] || scenario;
      }
      
      renderKPIs();
      updateCharts();
      renderCommentary();
      renderDecisionBox();
    }

    // ============================================
    // DATA GENERATION
    // ============================================
    
    function generateSampleData() {
      currentDataMode = 'sample';
      updateDataModeIndicator();
      hideDataPreview();
      
      const months = 12;
      modelData = {
        months: [],
        scenarios: {}
      };
      
      const startDate = new Date();
      for (let i = 0; i < months; i++) {
        const date = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
        modelData.months.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
      }
      
      ['base', 'upside', 'downside'].forEach(scenario => {
        modelData.scenarios[scenario] = generateScenarioData(scenario, months);
      });
    }

    function generateRandomData() {
      currentDataMode = 'random';
      updateDataModeIndicator();
      hideDataPreview();
      
      const industry = INDUSTRIES[currentIndustry];
      industry.drivers.forEach(driver => {
        const range = driver.max - driver.min;
        const variance = range * 0.3;
        const newValue = driver.default + (Math.random() - 0.5) * variance;
        driverValues[driver.id] = Math.max(driver.min, Math.min(driver.max, newValue));
      });
      
      const months = 12;
      ['base', 'upside', 'downside'].forEach(scenario => {
        modelData.scenarios[scenario] = generateScenarioData(scenario, months);
      });
      
      renderAll();
      showNotification('Random data generated with varied business conditions', 'success');
    }

    function generateScenarioData(scenario, months) {
      const multipliers = {
        base: 1.0,
        upside: 1.25,
        downside: 0.75
      };
      const mult = multipliers[scenario];
      
      const data = {};
      
      switch (currentIndustry) {
        case 'saas':
          data.mrrTrend = [];
          data.customersTrend = [];
          data.cash = [];
          data.nrrTrend = [];
          
          let customers = driverValues.startingCustomers || 500;
          let cash = 5000000;
          
          for (let i = 0; i < months; i++) {
            const growth = (driverValues.growth / 100) * mult;
            const churn = (driverValues.churn / 100) / mult;
            const netGrowth = growth - churn;
            
            const newCustomers = customers * growth;
            const avgMRR = driverValues.mrr || 300;
            const mrr = customers * avgMRR;
            const expansion = mrr * 0.02 * mult;
            
            customers = customers * (1 + netGrowth);
            
            const revenue = mrr;
            const cogs = revenue * (1 - driverValues.grossMargin / 100);
            const salesCost = newCustomers * driverValues.cac;
            const opex = 200000;
            const netBurn = revenue - cogs - salesCost - opex;
            cash += netBurn;
            
            const nrr = 100 + (netGrowth * 100) + ((expansion / mrr) * 100);
            
            data.mrrTrend.push(mrr);
            data.customersTrend.push(customers);
            data.cash.push(Math.max(0, cash));
            data.nrrTrend.push(Math.max(80, Math.min(140, nrr)));
          }
          
          data.arr = data.mrrTrend[months - 1] * 12;
          data.customers = data.customersTrend[months - 1];
          data.ltv = (driverValues.mrr * 12 / (driverValues.churn / 100)) * (driverValues.grossMargin / 100) / driverValues.cac;
          data.nrr = data.nrrTrend[months - 1];
          break;
          
        case 'media':
          data.users = [];
          data.revenue = [];
          data.arpuTrend = [];
          data.ebitdaMarginTrend = [];
          
          let users = driverValues.users;
          
          for (let i = 0; i < months; i++) {
            const growth = (driverValues.userGrowth / 100) * mult;
            users = users * (1 + growth);
            
            const dailyEngagement = driverValues.engagement;
            const monthlyImpressions = users * dailyEngagement * 30;
            const adRevenue = (monthlyImpressions / 1000) * driverValues.cpm * (driverValues.fillRate / 100);
            const contentCost = adRevenue * 0.4;
            const opex = 500000;
            const ebitda = adRevenue - contentCost - opex;
            const ebitdaMargin = (ebitda / adRevenue) * 100;
            const arpu = adRevenue / users;
            
            data.users.push(users);
            data.revenue.push(adRevenue);
            data.arpuTrend.push(arpu);
            data.ebitdaMarginTrend.push(ebitdaMargin);
          }
          
          data.adRevenue = data.revenue[months - 1];
          data.arpu = data.arpuTrend[months - 1];
          data.dau = data.users[months - 1] * 0.4;
          data.ebitdaMargin = data.ebitdaMarginTrend[months - 1];
          break;
          
        case 'manufacturing':
          data.units = [];
          data.revenueTrend = [];
          data.grossProfitTrend = [];
          data.grossMarginTrend = [];
          data.cashFlow = [];
          
          for (let i = 0; i < months; i++) {
            const units = driverValues.unitsPerMonth * (driverValues.utilizationRate / 100) * mult;
            const revenue = units * driverValues.sellPrice;
            const materialCost = revenue * (driverValues.materialCost / 100);
            const laborCost = revenue * (driverValues.laborCost / 100);
            const cogs = materialCost + laborCost;
            const grossProfit = revenue - cogs;
            const grossMargin = revenue > 0 ? (grossProfit / revenue) * 100 : 0;
            const opex = 300000;
            const cashFlow = grossProfit - opex;
            
            data.units.push(units);
            data.revenueTrend.push(revenue);
            data.grossProfitTrend.push(grossProfit);
            data.grossMarginTrend.push(grossMargin);
            data.cashFlow.push(cashFlow);
          }
          
          data.revenue = data.revenueTrend[months - 1];
          data.grossProfit = data.grossProfitTrend[months - 1];
          data.grossMargin = data.grossMarginTrend[months - 1];
          data.unitEconomics = data.units[months - 1] > 0 ? data.grossProfitTrend[months - 1] / data.units[months - 1] : 0;
          break;
          
        case 'lending':
          data.portfolio = [];
          data.netIncome = [];
          data.defaultsTrend = [];
          
          let portfolio = driverValues.originations * 6;
          
          for (let i = 0; i < months; i++) {
            portfolio += driverValues.originations * mult;
            const monthlyInterest = portfolio * (driverValues.avgRate / 100 / 12);
            const monthlyFundingCost = portfolio * (driverValues.fundingCost / 100 / 12);
            const monthlyDefaults = portfolio * (driverValues.defaultRate / 100 / 12);
            const recovery = monthlyDefaults * (driverValues.recoveryRate / 100);
            const netLoss = monthlyDefaults - recovery;
            const opex = 100000;
            const netIncome = monthlyInterest - monthlyFundingCost - netLoss - opex;
            
            data.portfolio.push(portfolio);
            data.netIncome.push(netIncome);
            data.defaultsTrend.push(monthlyDefaults);
          }
          
          data.portfolioSize = data.portfolio[months - 1];
          data.netInterestMargin = ((driverValues.avgRate - driverValues.fundingCost) / driverValues.avgRate) * 100;
          data.lossRate = driverValues.defaultRate * (1 - driverValues.recoveryRate / 100);
          data.roe = (data.netIncome[months - 1] * 12 / (data.portfolio[months - 1] * 0.1)) * 100;
          break;
          
        case 'realestate':
          data.rent = [];
          data.noiTrend = [];
          data.fcf = [];
          
          for (let i = 0; i < months; i++) {
            const occupiedSqm = driverValues.totalSqm * (driverValues.occupancyRate / 100) * mult;
            const monthlyRent = occupiedSqm * driverValues.rentPerSqm;
            const opex = monthlyRent * (driverValues.opexRatio / 100);
            const noi = monthlyRent - opex;
            const fcf = noi - driverValues.debtService;
            
            data.rent.push(monthlyRent);
            data.noiTrend.push(noi);
            data.fcf.push(fcf);
          }
          
          data.rentalIncome = data.rent[months - 1];
          data.noi = data.noiTrend[months - 1];
          data.noiMargin = (data.noi / data.rentalIncome) * 100;
          data.capRate = (data.noi * 12 / (driverValues.totalSqm * driverValues.rentPerSqm * 200)) * 100;
          break;
      }
      
      return data;
    }

    // ============================================
    // RENDERING
    // ============================================
    
    function renderAll() {
      renderControls();
      renderKPIs();
      renderCharts();
      renderCommentary();
      renderSensitivity();
      renderDecisionBox();
      // Update print title
      const pt = document.getElementById('printTitle');
      if (pt) pt.textContent = `${INDUSTRIES[currentIndustry].title} ‚Äî ${currentScenario.charAt(0).toUpperCase() + currentScenario.slice(1)} Scenario`;
    }

    function renderControls() {
      const industry = INDUSTRIES[currentIndustry];
      const container = document.getElementById('controlsContainer');
      
      container.innerHTML = industry.drivers.map(driver => {
        const value = driverValues[driver.id];
        const formattedValue = formatValue(value, driver.format);
        
        return `
          <div class="control-item">
            <div class="control-label">
              <span>${driver.label}</span>
              <span class="control-value" id="value-${driver.id}">${formattedValue}</span>
            </div>
            <div class="control-input-wrapper">
              <input 
                type="range" 
                class="control-input" 
                id="input-${driver.id}"
                min="${driver.min}" 
                max="${driver.max}" 
                step="${driver.step}" 
                value="${value}"
                oninput="updateDriver('${driver.id}', this.value)"
              >
              <div class="control-buttons">
                <button class="control-btn" onclick="decrementDriver('${driver.id}')">‚àí</button>
                <button class="control-btn" onclick="incrementDriver('${driver.id}')">+</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderKPIs() {
      const industry = INDUSTRIES[currentIndustry];
      const grid = document.getElementById('kpiGrid');
      const data = modelData.scenarios[currentScenario];
      
      if (!data) return;
      
      grid.innerHTML = industry.kpis.map(kpi => {
        const value = data[kpi.id];
        const formattedValue = formatValue(value, kpi.format);
        
        let change = 0;
        let changeClass = 'neutral';
        if (currentScenario !== 'base') {
          const baseValue = modelData.scenarios['base'][kpi.id];
          if (baseValue && value) {
            change = ((value - baseValue) / baseValue) * 100;
            changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';
          }
        }
        
        return `
          <div class="kpi-card">
            <div class="kpi-label">${kpi.label}</div>
            <div class="kpi-value">${formattedValue}</div>
            ${currentScenario !== 'base' ? `
              <div class="kpi-change ${changeClass}">
                ${change > 0 ? '‚Üë' : change < 0 ? '‚Üì' : '‚Üí'} ${Math.abs(change).toFixed(1)}% vs Base
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function renderCharts() {
      const industry = INDUSTRIES[currentIndustry];
      
      Object.values(charts).forEach(chart => chart.destroy());
      charts = {};
      
      industry.charts.forEach((chartConfig, index) => {
        const canvas = document.getElementById(`chart${index + 1}`);
        const ctx = canvas.getContext('2d');
        
        document.getElementById(`chart${index + 1}Title`).textContent = chartConfig.title;
        
        const datasets = ['base', 'upside', 'downside'].map(scenario => {
          const data = modelData.scenarios[scenario][chartConfig.metric];
          const colors = {
            base: { border: '#0b1220', bg: 'rgba(11, 18, 32, 0.08)' },
            upside: { border: '#059669', bg: 'rgba(5, 150, 105, 0.10)' },
            downside: { border: '#dc2626', bg: 'rgba(220, 38, 38, 0.10)' }
          };
          
          return {
            label: scenario.charAt(0).toUpperCase() + scenario.slice(1),
            data: data || [],
            borderColor: colors[scenario].border,
            backgroundColor: colors[scenario].bg,
            borderWidth: currentScenario === scenario ? 3 : 2,
            tension: 0.4,
            fill: currentScenario === scenario,
            pointRadius: currentScenario === scenario ? 4 : 0,
            pointHoverRadius: 6
          };
        });
        
        charts[chartConfig.id] = new Chart(ctx, {
          type: 'line',
          data: {
            labels: modelData.months,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                align: 'end',
                labels: {
                  boxWidth: 12,
                  boxHeight: 12,
                  padding: 15,
                  font: {
                    size: 12,
                    weight: '600',
                    family: 'ui-sans-serif, system-ui, -apple-system'
                  },
                  color: '#5d6b7a',
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                titleColor: '#0b1220',
                bodyColor: '#5d6b7a',
                borderColor: 'rgba(12, 23, 45, 0.10)',
                borderWidth: 1,
                padding: 12,
                boxPadding: 6,
                usePointStyle: true,
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    label += formatValue(context.parsed.y, 'short');
                    return label;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: {
                    size: 11,
                    family: 'ui-sans-serif, system-ui'
                  },
                  color: '#5d6b7a'
                }
              },
              y: {
                beginAtZero: false,
                grid: {
                  color: 'rgba(12, 23, 45, 0.05)',
                  drawBorder: false
                },
                ticks: {
                  font: {
                    size: 11,
                    family: 'ui-sans-serif, system-ui'
                  },
                  color: '#5d6b7a',
                  callback: function(value) {
                    return formatValue(value, 'short');
                  }
                }
              }
            }
          }
        });
      });
    }

    function updateCharts() {
      Object.values(charts).forEach(chart => {
        chart.data.datasets.forEach((dataset, index) => {
          const scenarios = ['base', 'upside', 'downside'];
          const scenario = scenarios[index];
          
          dataset.borderWidth = currentScenario === scenario ? 3 : 2;
          dataset.fill = currentScenario === scenario;
          dataset.pointRadius = currentScenario === scenario ? 4 : 0;
        });
        chart.update('none');
      });
    }

    function renderCommentary() {
      const section = document.getElementById('commentarySection');
      const industry = INDUSTRIES[currentIndustry];
      const data = modelData.scenarios[currentScenario];
      
      if (!data) return;
      
      let commentary = generateCommentary(industry, data);
      
      section.innerHTML = `
        <div class="commentary-header">
          <div class="commentary-icon">üí°</div>
          <div>
            <div class="commentary-title">CFO Commentary ‚Äî ${currentScenario.charAt(0).toUpperCase() + currentScenario.slice(1)} Scenario</div>
          </div>
        </div>
        <div class="commentary-content">
          ${commentary}
        </div>
      `;
    }

    function generateCommentary(industry, data) {
      const months = modelData.months.length;
      
      switch (currentIndustry) {
        case 'saas':
          const runway = data.cash[months - 1] / 200000;
          const mrrGrowth = ((data.mrrTrend[months - 1] - data.mrrTrend[0]) / data.mrrTrend[0]) * 100;
          return `
            <p><strong>Performance:</strong> ARR stands at <span class="commentary-highlight">${formatValue(data.arr, 'currency')}</span> with ${formatValue(data.customers, 'number')} active customers. MRR grew ${mrrGrowth > 0 ? mrrGrowth.toFixed(1) + '% over the period' : 'with negative momentum'}.</p>
            <p><strong>Unit Economics:</strong> LTV/CAC ratio is <span class="commentary-highlight">${data.ltv.toFixed(2)}x</span>. ${data.ltv > 3 ? 'Strong unit economics support efficient growth.' : 'Consider optimizing CAC or reducing churn to improve unit economics.'} Net Revenue Retention at ${data.nrr.toFixed(0)}% ${data.nrr > 110 ? 'demonstrates strong expansion' : 'shows baseline retention'}.</p>
            <p><strong>Cash Position:</strong> Current cash balance of <span class="commentary-highlight">${formatValue(data.cash[months - 1], 'currency')}</span> provides approximately ${runway.toFixed(1)} months of runway. ${runway > 12 ? 'Healthy runway allows strategic investments.' : runway > 6 ? 'Monitor burn rate closely.' : 'Immediate action required to extend runway.'}</p>
          `;
          
        case 'media':
          const userGrowth = ((data.users[months - 1] - data.users[0]) / data.users[0]) * 100;
          return `
            <p><strong>Audience Growth:</strong> Platform reached <span class="commentary-highlight">${formatValue(data.users[months - 1], 'number')}</span> active users, growing ${userGrowth.toFixed(1)}% over the period. ARPU of <span class="commentary-highlight">${formatValue(data.arpu, 'currency')}</span> ${data.arpu > 5 ? 'exceeds industry benchmarks' : 'aligns with platform economics'}.</p>
            <p><strong>Monetization:</strong> Monthly ad revenue of <span class="commentary-highlight">${formatValue(data.adRevenue, 'currency')}</span> driven by engagement and fill rate optimization. EBITDA margin at ${data.ebitdaMargin.toFixed(1)}% ${data.ebitdaMargin > 20 ? 'demonstrates strong operating leverage' : 'requires scale for profitability'}.</p>
            <p><strong>Outlook:</strong> ${data.ebitdaMargin > 0 ? 'Positive unit economics achieved through scale.' : 'Path to profitability requires user base expansion or ARPU improvement.'} DAU estimated at ${formatValue(data.dau, 'number')} with engagement driving monetization.</p>
          `;
          
        case 'manufacturing':
          return `
            <p><strong>Production:</strong> Manufacturing ${formatValue(data.units[months - 1], 'number')} units per month generating <span class="commentary-highlight">${formatValue(data.revenue, 'currency')}</span> in revenue. Utilization rate at ${driverValues.utilizationRate}% provides ${driverValues.utilizationRate < 85 ? 'capacity for volume growth' : 'optimal efficiency'}.</p>
            <p><strong>Margin Performance:</strong> Gross margin of <span class="commentary-highlight">${data.grossMargin.toFixed(1)}%</span> driven by material efficiency and labor optimization. Unit contribution of ${formatValue(data.unitEconomics, 'currency')} ${data.grossMargin > 40 ? 'supports profitable scaling' : 'requires cost optimization'}.</p>
            <p><strong>Cash Generation:</strong> Operating cash flow of <span class="commentary-highlight">${formatValue(data.cashFlow[months - 1], 'currency')}</span> per month. ${data.cashFlow[months - 1] > 0 ? 'Positive cash generation funds growth initiatives.' : 'Focus on margin improvement to achieve cash flow positivity.'}</p>
          `;
          
        case 'lending':
          return `
            <p><strong>Portfolio:</strong> Outstanding loan portfolio of <span class="commentary-highlight">${formatValue(data.portfolioSize, 'currency')}</span> with net interest margin of ${data.netInterestMargin.toFixed(2)}%. Monthly originations drive steady ${driverValues.originations > 5000000 ? 'aggressive' : 'moderate'} portfolio growth.</p>
            <p><strong>Credit Quality:</strong> Net loss rate of <span class="commentary-highlight">${data.lossRate.toFixed(2)}%</span> with ${driverValues.recoveryRate}% recovery on defaults. ${data.lossRate < 1 ? 'Credit performance remains strong with controlled losses.' : 'Monitor credit quality and underwriting standards closely.'}</p>
            <p><strong>Returns:</strong> Annualized ROE of ${data.roe.toFixed(1)}% ${data.roe > 15 ? 'demonstrates attractive returns on equity' : 'shows moderate profitability requiring optimization'}. Monthly net income of ${formatValue(data.netIncome[months - 1], 'currency')}.</p>
          `;
          
        case 'realestate':
          return `
            <p><strong>Occupancy:</strong> Property portfolio generating <span class="commentary-highlight">${formatValue(data.rentalIncome, 'currency')}</span> in monthly rental income at ${driverValues.occupancyRate}% occupancy. ${driverValues.occupancyRate > 90 ? 'Near-full occupancy maximizes revenue potential.' : 'Opportunity to improve occupancy through active leasing.'}</p>
            <p><strong>Operating Performance:</strong> NOI of <span class="commentary-highlight">${formatValue(data.noi, 'currency')}</span> with ${data.noiMargin.toFixed(1)}% margin. Operating efficiency ${data.noiMargin > 65 ? 'exceeds market standards' : 'aligns with industry benchmarks'}. Cap rate at ${data.capRate.toFixed(2)}%.</p>
            <p><strong>Cash Flow:</strong> Free cash flow after debt service of <span class="commentary-highlight">${formatValue(data.fcf[months - 1], 'currency')}</span> ${data.fcf[months - 1] > 0 ? 'supports distributions and reinvestment opportunities' : 'portfolio requires deleveraging or occupancy improvement'}.</p>
          `;
      }
    }

    // ============================================
    // DRIVER UPDATES
    // ============================================
    
    function updateDriver(driverId, value) {
      const numValue = parseFloat(value);
      driverValues[driverId] = numValue;
      
      const industry = INDUSTRIES[currentIndustry];
      const driver = industry.drivers.find(d => d.id === driverId);
      
      document.getElementById(`value-${driverId}`).textContent = formatValue(numValue, driver.format);
      
      const months = 12;
      ['base', 'upside', 'downside'].forEach(scenario => {
        modelData.scenarios[scenario] = generateScenarioData(scenario, months);
      });
      
      renderKPIs();
      updateChartsData();
      renderCommentary();
    }

    function updateChartsData() {
      const industry = INDUSTRIES[currentIndustry];
      
      industry.charts.forEach((chartConfig, index) => {
        const chart = charts[chartConfig.id];
        if (!chart) return;
        
        ['base', 'upside', 'downside'].forEach((scenario, datasetIndex) => {
          const data = modelData.scenarios[scenario][chartConfig.metric];
          chart.data.datasets[datasetIndex].data = data || [];
        });
        
        chart.update('active');
      });
    }

    function incrementDriver(driverId) {
      const industry = INDUSTRIES[currentIndustry];
      const driver = industry.drivers.find(d => d.id === driverId);
      const currentValue = driverValues[driverId];
      const newValue = Math.min(driver.max, currentValue + driver.step);
      
      driverValues[driverId] = newValue;
      document.getElementById(`input-${driverId}`).value = newValue;
      updateDriver(driverId, newValue);
    }

    function decrementDriver(driverId) {
      const industry = INDUSTRIES[currentIndustry];
      const driver = industry.drivers.find(d => d.id === driverId);
      const currentValue = driverValues[driverId];
      const newValue = Math.max(driver.min, currentValue - driver.step);
      
      driverValues[driverId] = newValue;
      document.getElementById(`input-${driverId}`).value = newValue;
      updateDriver(driverId, newValue);
    }

    // ============================================
    // DATA MODE
    // ============================================
    
    function updateDataModeIndicator() {
      const indicator = document.getElementById('dataModeIndicator');
      if (!indicator) return;
      const labels = {
        sample: 'üìä Sample',
        random: 'üé≤ Random',
        uploaded: 'üìÅ Uploaded'
      };
      indicator.textContent = labels[currentDataMode] || labels.sample;
    }

    function useSampleData() {
      initializeDrivers();
      generateSampleData();
      renderAll();
      showNotification('Switched to sample data', 'info');
    }

    // ============================================
    // FILE HANDLING
    // ============================================
    
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          
          Papa.parse(text, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
              if (results.data && results.data.length > 0) {
                uploadedData = results.data;
                currentDataMode = 'uploaded';
                updateDataModeIndicator();
                showDataPreview(results.data, results.meta.fields);
                showNotification(`${results.data.length} rows uploaded successfully`, 'success');
              } else {
                showNotification('No valid data found in file', 'error');
              }
            },
            error: function(error) {
              showNotification('Error parsing file: ' + error.message, 'error');
            }
          });
        } catch (error) {
          showNotification('Error reading file: ' + error.message, 'error');
        }
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    function showDataPreview(data, headers) {
      const section = document.getElementById('dataPreviewSection');
      const count = document.getElementById('dataPreviewCount');
      const thead = document.getElementById('dataTableHead');
      const tbody = document.getElementById('dataTableBody');
      
      section.style.display = 'block';
      count.textContent = `${data.length} rows`;
      
      thead.innerHTML = `
        <tr>
          ${headers.map(h => `<th>${h}</th>`).join('')}
        </tr>
      `;
      
      const rowsToShow = data.slice(0, 10);
      tbody.innerHTML = rowsToShow.map(row => `
        <tr>
          ${headers.map(h => `<td>${row[h] !== null && row[h] !== undefined ? row[h] : '-'}</td>`).join('')}
        </tr>
      `).join('');
    }

    function hideDataPreview() {
      document.getElementById('dataPreviewSection').style.display = 'none';
      uploadedData = null;
    }

    function downloadTemplate() {
      const industry = INDUSTRIES[currentIndustry];
      
      let csv = '';
      switch (currentIndustry) {
        case 'saas':
          csv = 'Month,Customer ID,Status,MRR,Churned,Expansion,CAC,Service Cost\n';
          csv += 'Jan 2025,CUST001,New,5000,0,0,1500,800\n';
          csv += 'Jan 2025,CUST002,Existing,3000,0,500,0,480\n';
          csv += 'Feb 2025,CUST003,New,4500,0,0,1500,720\n';
          break;
        case 'media':
          csv = 'Date,Users,Engagement Minutes,Ad Impressions,Fill Rate,CPM,Subscription Revenue,Content Cost\n';
          csv += 'Jan 2025,1000000,45,50000000,75,8,500000,2000000\n';
          csv += 'Feb 2025,1100000,46,55000000,76,8.2,520000,2100000\n';
          break;
        case 'manufacturing':
          csv = 'Date,SKU,Units Produced,Units Sold,Material Cost,Labor Cost,Overhead,Standard Cost,Selling Price\n';
          csv += 'Jan 2025,SKU001,10000,9500,35,20,15,70,100\n';
          csv += 'Jan 2025,SKU002,5000,4800,40,18,12,70,95\n';
          break;
        case 'lending':
          csv = 'Date,Loan ID,Origination Amount,Interest Rate,Term,Outstanding Balance,Days Past Due,Default Flag,Recovery Amount,Funding Cost\n';
          csv += 'Jan 2025,LOAN001,50000,8,36,45000,0,0,0,4\n';
          csv += 'Jan 2025,LOAN002,30000,9.5,24,25000,45,0,0,4.2\n';
          break;
        case 'realestate':
          csv = 'Month,Unit ID,Available Sqm,Occupied Flag,Rent Rate,Operating Cost,Maintenance,Debt Service\n';
          csv += 'Jan 2025,UNIT001,5000,1,30,45000,5000,12500\n';
          csv += 'Jan 2025,UNIT002,3000,0,30,27000,3000,7500\n';
          break;
      }
      
      csv += '\n# Notes:\n';
      csv += '# - Keep the header row unchanged\n';
      csv += '# - Fill in your actual data\n';
      csv += '# - Ensure data types match the template\n';
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentIndustry}-fpa-template.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification(`${INDUSTRIES[currentIndustry].name} template downloaded`, 'success');
    }

    // ============================================
    // UTILITIES
    // ============================================
    
    function formatValue(value, format) {
      if (value === null || value === undefined || isNaN(value)) return 'N/A';
      
      const numValue = Number(value);
      
      switch (format) {
        case 'currency':
          if (Math.abs(numValue) >= 1000000) {
            return '$' + (numValue / 1000000).toFixed(2) + 'M';
          } else if (Math.abs(numValue) >= 1000) {
            return '$' + (numValue / 1000).toFixed(1) + 'K';
          }
          return '$' + numValue.toLocaleString('en-US', { maximumFractionDigits: 0 });
          
        case 'percent':
          return numValue.toFixed(1) + '%';
          
        case 'ratio':
          return numValue.toFixed(2) + 'x';
          
        case 'number':
          if (numValue >= 1000000) {
            return (numValue / 1000000).toFixed(2) + 'M';
          } else if (numValue >= 1000) {
            return (numValue / 1000).toFixed(1) + 'K';
          }
          return Math.round(numValue).toLocaleString('en-US');
          
        case 'short':
          if (Math.abs(numValue) >= 1000000) {
            return '$' + (numValue / 1000000).toFixed(1) + 'M';
          } else if (Math.abs(numValue) >= 1000) {
            return '$' + (numValue / 1000).toFixed(0) + 'K';
          }
          return '$' + Math.round(numValue).toLocaleString('en-US');
          
        default:
          return numValue.toLocaleString('en-US');
      }
    }

    function showNotification(message, type = 'info') {
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-icon">${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</div>
        <div class="notification-message">${message}</div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideIn 300ms reverse';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // ============================================
    // MODE SWITCHING (Simulator / Variance)
    // ============================================

    let currentMode = 'simulator';

    function switchMode(mode) {
      currentMode = mode;
      // Update sidebar mode pills
      document.getElementById('modeSimulator').classList.toggle('active', mode === 'simulator');
      document.getElementById('modeVariance').classList.toggle('active', mode === 'variance');
      // Update sidebar badge
      const modeLbl = document.getElementById('sbModeLabel');
      if (modeLbl) modeLbl.textContent = mode === 'simulator' ? 'Simulator' : 'Variance';

      const varianceContent = document.getElementById('varianceModeContent');
      const kpiGrid = document.getElementById('kpiGrid');
      const commentary = document.getElementById('commentarySection');
      const chartGrid = document.querySelector('.chart-grid');
      const chart3Card = chartGrid && chartGrid.nextElementSibling;
      const topDriversCard = document.getElementById('topDriversCard');
      const scenarioActions = document.querySelector('.scenario-actions');
      const decisionBox = document.getElementById('decisionBox');

      if (mode === 'simulator') {
        varianceContent.style.display = 'none';
        if (kpiGrid) kpiGrid.style.display = '';
        if (commentary) commentary.style.display = '';
        if (chartGrid) chartGrid.style.display = '';
        if (chart3Card && chart3Card.classList.contains('card')) chart3Card.style.display = '';
        if (topDriversCard) topDriversCard.style.display = '';
        if (scenarioActions) scenarioActions.style.display = '';
        if (decisionBox) decisionBox.style.display = '';
      } else {
        varianceContent.style.display = '';
        if (kpiGrid) kpiGrid.style.display = 'none';
        if (commentary) commentary.style.display = 'none';
        if (chartGrid) chartGrid.style.display = 'none';
        if (chart3Card && chart3Card.classList.contains('card')) chart3Card.style.display = 'none';
        if (topDriversCard) topDriversCard.style.display = 'none';
        if (scenarioActions) scenarioActions.style.display = 'none';
        if (decisionBox) decisionBox.style.display = 'none';
        if (varianceData) renderVarianceTable();
      }
    }

    // ============================================
    // VARIANCE MODE
    // ============================================

    const VARIANCE_REQUIRED_COLS = [
      'Month',
      'Actual_Revenue','Budget_Revenue','Forecast_Revenue',
      'Actual_COGS','Budget_COGS','Forecast_COGS',
      'Actual_Opex','Budget_Opex','Forecast_Opex'
    ];

    let varianceData = null;

    function showError(message) {
      const banner = document.getElementById('varianceErrorBanner');
      banner.style.display = 'block';
      banner.innerHTML = `<strong>Error:</strong> ${message}`;
    }
    function clearError() {
      const banner = document.getElementById('varianceErrorBanner');
      banner.style.display = 'none';
      banner.innerHTML = '';
    }

    function validateVarianceCsv(headers) {
      const missing = VARIANCE_REQUIRED_COLS.filter(c => !headers.includes(c));
      return missing;
    }

    function downloadVarianceTemplate() {
      let csv = VARIANCE_REQUIRED_COLS.join(',') + '\n';
      csv += 'Jan 2025,500000,480000,490000,150000,145000,148000,200000,195000,198000\n';
      csv += 'Feb 2025,520000,495000,510000,156000,149000,153000,202000,196000,199000\n';
      csv += 'Mar 2025,540000,510000,530000,162000,153000,159000,205000,197000,200000\n';
      csv += '\n# Notes:\n# Actual_* = what actually happened\n# Budget_* = approved plan\n# Forecast_* = latest re-forecast\n';
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'variance-template.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification('Variance template downloaded', 'success');
    }

    function handleVarianceUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        Papa.parse(e.target.result, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          comments: '#',
          complete: function(results) {
            clearError();
            if (!results.data || results.data.length === 0) {
              showError('No valid data rows found in file.');
              return;
            }
            const missing = validateVarianceCsv(results.meta.fields || []);
            if (missing.length > 0) {
              showError(`Missing required columns: <strong>${missing.join(', ')}</strong>`);
              return;
            }
            varianceData = results.data;
            // Populate month dropdown
            const monthSelect = document.getElementById('varianceMonthSelect');
            const months = [...new Set(results.data.map(r => r.Month).filter(Boolean))];
            if (months.length === 0) {
              showError('Could not parse Month column. Ensure format like "Jan 2025".');
              return;
            }
            monthSelect.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('');
            monthSelect.value = months[months.length - 1];
            document.getElementById('varianceMonthSelector').style.display = '';
            document.getElementById('varianceTableContainer').style.display = '';
            renderVarianceTable();
            showNotification('Variance data loaded successfully', 'success');
          },
          error: function(err) {
            showError('Parse error: ' + err.message);
          }
        });
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    function renderVarianceTable() {
      if (!varianceData) return;
      const selectedMonth = document.getElementById('varianceMonthSelect').value;
      const rows = varianceData.filter(r => r.Month === selectedMonth);
      if (rows.length === 0) {
        showError('No data found for selected month.');
        return;
      }
      clearError();

      // Aggregate rows for the month (sum in case of multiple rows per month)
      const agg = { Actual_Revenue:0, Budget_Revenue:0, Forecast_Revenue:0,
                    Actual_COGS:0, Budget_COGS:0, Forecast_COGS:0,
                    Actual_Opex:0, Budget_Opex:0, Forecast_Opex:0 };
      rows.forEach(r => {
        Object.keys(agg).forEach(k => { agg[k] += (r[k] || 0); });
      });

      // Compute derived lines
      const A_Rev = agg.Actual_Revenue, B_Rev = agg.Budget_Revenue, F_Rev = agg.Forecast_Revenue;
      const A_COGS = agg.Actual_COGS, B_COGS = agg.Budget_COGS, F_COGS = agg.Forecast_COGS;
      const A_Opex = agg.Actual_Opex, B_Opex = agg.Budget_Opex, F_Opex = agg.Forecast_Opex;
      const A_GP = A_Rev - A_COGS, B_GP = B_Rev - B_COGS, F_GP = F_Rev - F_COGS;
      const A_EBITDA = A_GP - A_Opex, B_EBITDA = B_GP - B_Opex, F_EBITDA = F_GP - F_Opex;

      function varRow(label, actual, budget, forecast, isTotal) {
        const avbAmt = actual - budget;
        const avbPct = budget !== 0 ? ((actual - budget) / Math.abs(budget)) * 100 : 0;
        const avfAmt = actual - forecast;
        const avfPct = forecast !== 0 ? ((actual - forecast) / Math.abs(forecast)) * 100 : 0;
        // For COGS/Opex, negative variance (actual < budget) is favorable
        const isExpense = label.includes('COGS') || label.includes('Opex');
        const avbFav = isExpense ? avbAmt <= 0 : avbAmt >= 0;
        const avfFav = isExpense ? avfAmt <= 0 : avfAmt >= 0;
        const rowClass = isTotal ? ' class="row-total"' : '';
        return `<tr${rowClass}>
          <td>${label}</td>
          <td>${formatValue(actual, 'short')}</td>
          <td>${formatValue(budget, 'short')}</td>
          <td>${formatValue(forecast, 'short')}</td>
          <td class="${avbFav ? 'fav' : 'unfav'}">${avbFav ? '‚ñ≤' : '‚ñº'} ${formatValue(Math.abs(avbAmt), 'short')}</td>
          <td class="${avbFav ? 'fav' : 'unfav'}">${avbFav ? '+' : ''}${avbPct.toFixed(1)}%</td>
          <td class="${avfFav ? 'fav' : 'unfav'}">${avfFav ? '‚ñ≤' : '‚ñº'} ${formatValue(Math.abs(avfAmt), 'short')}</td>
          <td class="${avfFav ? 'fav' : 'unfav'}">${avfFav ? '+' : ''}${avfPct.toFixed(1)}%</td>
        </tr>`;
      }

      const tableHTML = `
        <thead>
          <tr>
            <th>Line Item</th>
            <th>Actual</th>
            <th>Budget</th>
            <th>Forecast</th>
            <th>A vs B ($)</th>
            <th>A vs B (%)</th>
            <th>A vs F ($)</th>
            <th>A vs F (%)</th>
          </tr>
        </thead>
        <tbody>
          ${varRow('Revenue', A_Rev, B_Rev, F_Rev, false)}
          ${varRow('COGS', A_COGS, B_COGS, F_COGS, false)}
          ${varRow('Gross Profit', A_GP, B_GP, F_GP, true)}
          ${varRow('Opex', A_Opex, B_Opex, F_Opex, false)}
          ${varRow('EBITDA', A_EBITDA, B_EBITDA, F_EBITDA, true)}
        </tbody>
      `;
      document.getElementById('varianceTable').innerHTML = tableHTML;
      document.getElementById('varianceTableTitle').textContent = `Variance Analysis ‚Äî ${selectedMonth}`;
      renderVarianceNarrative(A_Rev, B_Rev, A_COGS, B_COGS, A_Opex, B_Opex, A_EBITDA, B_EBITDA);
    }

    function renderVarianceNarrative(A_Rev, B_Rev, A_COGS, B_COGS, A_Opex, B_Opex, A_EBITDA, B_EBITDA) {
      const ebitdaVar = A_EBITDA - B_EBITDA;
      const revenueVar = A_Rev - B_Rev;
      const cogsVar = -(A_COGS - B_COGS); // negative COGS variance is favorable
      const opexVar = -(A_Opex - B_Opex);

      const contributors = [
        { name: 'Revenue', impact: revenueVar, pct: B_Rev !== 0 ? (revenueVar / Math.abs(B_Rev)) * 100 : 0 },
        { name: 'COGS Efficiency', impact: cogsVar, pct: B_COGS !== 0 ? (cogsVar / Math.abs(B_COGS)) * 100 : 0 },
        { name: 'Opex Control', impact: opexVar, pct: B_Opex !== 0 ? (opexVar / Math.abs(B_Opex)) * 100 : 0 }
      ].sort((a, b) => Math.abs(b.impact) - Math.abs(a.impact)).slice(0, 3);

      function action(name, impact) {
        if (name === 'Revenue') {
          return impact >= 0
            ? '‚Ä¢ Identify top-performing channels or products and allocate more budget to scale them.\n‚Ä¢ Recognize and reward the sales/marketing teams responsible.'
            : '‚Ä¢ Conduct pipeline review and identify deal slippage root causes.\n‚Ä¢ Adjust pricing or promotional activity to close the gap next month.';
        } else if (name === 'COGS Efficiency') {
          return impact >= 0
            ? '‚Ä¢ Document the efficiency gains (vendor negotiations, yield improvements) for replication.\n‚Ä¢ Consider revising cost targets upward to reflect improved run rate.'
            : '‚Ä¢ Review vendor contracts and material waste; escalate to procurement.\n‚Ä¢ Assess whether volume shortfalls inflated unit COGS via fixed cost absorption.';
        } else {
          return impact >= 0
            ? '‚Ä¢ Confirm savings are structural (not timing) before releasing to forecast.\n‚Ä¢ Review deferred spend to ensure it doesn\'t create a backlog.'
            : '‚Ä¢ Identify the cost centre(s) driving overspend and request explanations.\n‚Ä¢ Tighten approval thresholds for discretionary spend for the remainder of the quarter.';
        }
      }

      const narrativeHTML = `
        <h3>üí° What Moved & Why ‚Äî EBITDA ${ebitdaVar >= 0 ? '‚ñ≤' : '‚ñº'} ${formatValue(Math.abs(ebitdaVar), 'short')} vs Budget</h3>
        ${contributors.map((c, i) => `
          <div class="narrative-item">
            <div class="narrative-item-label">${i + 1}. ${c.name}: <span style="color:${c.impact >= 0 ? '#059669' : '#dc2626'}">${c.impact >= 0 ? '+' : ''}${formatValue(c.impact, 'short')} (${c.pct >= 0 ? '+' : ''}${c.pct.toFixed(1)}%)</span></div>
            <div class="narrative-item-actions">${action(c.name, c.impact)}</div>
          </div>
        `).join('')}
      `;
      document.getElementById('varianceNarrative').innerHTML = narrativeHTML;
    }

    // ============================================
    // SENSITIVITY MINI-VIEW (Tornado-lite)
    // ============================================

    let sensitivityOutcome = 'ebitda';

    function computeEbitdaProxy(scenario) {
      // Return a single EBITDA-like scalar from scenario data
      const data = scenario;
      const months = 12;
      switch (currentIndustry) {
        case 'saas': {
          const mrr = data.mrrTrend ? data.mrrTrend[months - 1] : 0;
          const customers = data.customersTrend ? data.customersTrend[months - 1] : 1;
          const cogs = mrr * (1 - driverValues.grossMargin / 100);
          const opex = 200000;
          return mrr - cogs - opex;
        }
        case 'media': {
          const rev = data.revenue ? data.revenue[months - 1] : 0;
          const contentCost = rev * 0.4;
          const opex = 500000;
          return rev - contentCost - opex;
        }
        case 'manufacturing': {
          return data.cashFlow ? data.cashFlow[months - 1] : 0;
        }
        case 'lending': {
          return data.netIncome ? data.netIncome[months - 1] : 0;
        }
        case 'realestate': {
          return data.fcf ? data.fcf[months - 1] : 0;
        }
        default: return 0;
      }
    }

    function computeRevenueProxy(scenario) {
      const months = 12;
      switch (currentIndustry) {
        case 'saas': return scenario.mrrTrend ? scenario.mrrTrend[months - 1] * 12 : 0;
        case 'media': return scenario.revenue ? scenario.revenue[months - 1] : 0;
        case 'manufacturing': return scenario.revenueTrend ? scenario.revenueTrend[months - 1] : 0;
        case 'lending': return scenario.portfolio ? scenario.portfolio[months - 1] * (driverValues.avgRate / 100 / 12) : 0;
        case 'realestate': return scenario.rent ? scenario.rent[months - 1] : 0;
        default: return 0;
      }
    }

    function computeCashProxy(scenario) {
      const months = 12;
      switch (currentIndustry) {
        case 'saas': return scenario.cash ? scenario.cash[months - 1] : 0;
        default: return computeEbitdaProxy(scenario);
      }
    }

    function getOutcomeValue(scenario) {
      if (sensitivityOutcome === 'revenue') return computeRevenueProxy(scenario);
      if (sensitivityOutcome === 'cash') return computeCashProxy(scenario);
      return computeEbitdaProxy(scenario);
    }

    function renderSensitivity() {
      const industry = INDUSTRIES[currentIndustry];
      
      // Render outcome selector
      const outcomes = [
        { id: 'ebitda', label: 'EBITDA' },
        { id: 'revenue', label: 'Revenue' },
        { id: 'cash', label: 'Cash/Runway' }
      ];
      document.getElementById('sensitivityOutcomeSelector').innerHTML = outcomes.map(o => `
        <button class="sensitivity-outcome-btn ${sensitivityOutcome === o.id ? 'active' : ''}" onclick="setSensitivityOutcome('${o.id}')">${o.label}</button>
      `).join('');

      // Baseline
      const baseScenario = modelData.scenarios['base'];
      const baseValue = getOutcomeValue(baseScenario);

      // For each driver, compute impact of +10% (or +1 step for % drivers)
      const impacts = industry.drivers.map(driver => {
        const savedValue = driverValues[driver.id];
        const bump = driver.format === 'percent' ? driver.step : savedValue * 0.1;
        const newValue = Math.min(driver.max, savedValue + Math.max(bump, driver.step));
        
        // Clone driverValues, change this driver
        const savedDriverValues = { ...driverValues };
        driverValues[driver.id] = newValue;
        
        // Recompute base scenario
        const testScenario = generateScenarioData('base', 12);
        const testValue = getOutcomeValue(testScenario);
        
        // Restore
        driverValues = { ...savedDriverValues };
        
        return {
          label: driver.label,
          impact: testValue - baseValue,
          absImpact: Math.abs(testValue - baseValue)
        };
      });

      impacts.sort((a, b) => b.absImpact - a.absImpact);
      const top5 = impacts.slice(0, 5);
      const maxImpact = top5[0]?.absImpact || 1;

      document.getElementById('sensitivityList').innerHTML = top5.map((item, i) => `
        <div class="sensitivity-item">
          <span class="sensitivity-rank">#${i + 1}</span>
          <span class="sensitivity-label">${item.label}</span>
          <div class="sensitivity-bar-wrap">
            <div class="sensitivity-bar" style="width:${(item.absImpact / maxImpact * 100).toFixed(0)}%;background:${item.impact >= 0 ? '#059669' : '#dc2626'}"></div>
          </div>
          <span class="sensitivity-value" style="color:${item.impact >= 0 ? '#059669' : '#dc2626'}">${item.impact >= 0 ? '+' : ''}${formatValue(item.impact, 'short')}</span>
        </div>
      `).join('');
    }

    function setSensitivityOutcome(outcome) {
      sensitivityOutcome = outcome;
      renderSensitivity();
    }

    // ============================================
    // SAVE / LOAD / SHARE SCENARIO
    // ============================================

    function encodeState() {
      const state = { industry: currentIndustry, scenario: currentScenario, drivers: { ...driverValues } };
      return btoa(JSON.stringify(state));
    }

    function decodeState(encoded) {
      try {
        return JSON.parse(atob(encoded));
      } catch(e) { return null; }
    }

    function saveScenario() {
      const name = prompt('Name this scenario (optional):', `${INDUSTRIES[currentIndustry].name} ‚Äî ${new Date().toLocaleDateString()}`) || `Scenario ${Date.now()}`;
      const key = 'fpa_scenario_' + Date.now();
      const entry = { name, timestamp: Date.now(), encoded: encodeState() };
      try {
        localStorage.setItem(key, JSON.stringify(entry));
        showNotification(`Scenario "${name}" saved`, 'success');
      } catch(e) {
        showNotification('Could not save: localStorage unavailable', 'error');
      }
    }

    function openLoadScenario() {
      const modal = document.getElementById('scenarioModal');
      modal.classList.add('open');
      const list = document.getElementById('savedScenariosList') || document.getElementById('savedScenarioList');
      const keys = Object.keys(localStorage).filter(k => k.startsWith('fpa_scenario_'));
      if (keys.length === 0) {
        list.innerHTML = '<p style="color:var(--muted);font-size:14px;">No saved scenarios yet.</p>';
        return;
      }
      list.innerHTML = keys.map(k => {
        try {
          const entry = JSON.parse(localStorage.getItem(k));
          const date = new Date(entry.timestamp).toLocaleString();
          return `<div class="modal-item">
            <div onclick="loadScenarioByKey('${k}')" style="flex:1;cursor:pointer;">
              <div class="modal-item-name">${entry.name}</div>
              <div class="modal-item-meta">${date}</div>
            </div>
            <button class="btn btn-ghost btn-sm" onclick="deleteScenarioByKey('${k}')">‚úï</button>
          </div>`;
        } catch(e) { return ''; }
      }).join('');
    }
    function openLoadModal() { openLoadScenario(); }

    function closeLoadScenario() {
      const modal = document.getElementById('scenarioModal');
      modal.classList.remove('open');
    }
    function closeLoadModal() { closeLoadScenario(); }

    function loadScenarioByKey(key) {
      try {
        const entry = JSON.parse(localStorage.getItem(key));
        const state = decodeState(entry.encoded);
        if (!state) { showNotification('Could not restore scenario', 'error'); return; }
        currentIndustry = state.industry;
        currentScenario = state.scenario;
        driverValues = state.drivers;

        document.querySelectorAll('#industryTabs .sb-tab, #industryTabs .tab').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.industry === currentIndustry);
        });
        document.querySelectorAll('#scenarioTabs .sb-tab, #scenarioTabs .tab').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.scenario === currentScenario);
        });
        document.getElementById('moduleTitle').textContent = INDUSTRIES[currentIndustry].title;
        const lbl1 = document.getElementById('sbIndustryLabel');
        if (lbl1) lbl1.textContent = INDUSTRIES[currentIndustry].name;
        const lbl2 = document.getElementById('sbScenarioLabel');
        if (lbl2) { const names = {base:'Base Case',upside:'Upside',downside:'Downside'}; lbl2.textContent = names[currentScenario] || currentScenario; }

        generateSampleData();
        renderAll();
        renderSensitivity();
        closeLoadScenario();
        showNotification(`Scenario "${entry.name}" loaded`, 'success');
      } catch(e) {
        showNotification('Failed to load scenario', 'error');
      }
    }

    function deleteScenarioByKey(key) {
      localStorage.removeItem(key);
      openLoadScenario(); // refresh list
    }

    function copyShareLink() {
      const hash = '#state=' + encodeState();
      const url = window.location.href.split('#')[0] + hash;
      try {
        navigator.clipboard.writeText(url).then(() => showNotification('Share link copied to clipboard', 'success'));
      } catch(e) {
        prompt('Copy this link:', url);
      }
    }

    function restoreFromHash() {
      const hash = window.location.hash;
      if (!hash || !hash.startsWith('#state=')) return;
      const encoded = hash.slice(7);
      const state = decodeState(encoded);
      if (!state) return;
      currentIndustry = state.industry || 'saas';
      currentScenario = state.scenario || 'base';
      driverValues = state.drivers || {};

      document.querySelectorAll('#industryTabs .sb-tab, #industryTabs .tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.industry === currentIndustry);
      });
      document.querySelectorAll('#scenarioTabs .sb-tab, #scenarioTabs .tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.scenario === currentScenario);
      });
      document.getElementById('moduleTitle').textContent = INDUSTRIES[currentIndustry].title;
      const lbl1 = document.getElementById('sbIndustryLabel');
      if (lbl1) lbl1.textContent = INDUSTRIES[currentIndustry].name;
      const lbl2 = document.getElementById('sbScenarioLabel');
      if (lbl2) {
        const names = { base: 'Base Case', upside: 'Upside', downside: 'Downside' };
        lbl2.textContent = names[currentScenario] || currentScenario;
      }
    }

    // ============================================
    // COLLAPSIBLE SIDEBAR GROUPS
    // ============================================

    function toggleSbGroup(headerEl) {
      headerEl.classList.toggle('open');
      const body = headerEl.nextElementSibling;
      if (body) body.classList.toggle('open');
    }

    // ============================================
    // DECISION BOX ‚Äî "So What?"
    // ============================================

    function computeGuardrails(data) {
      const flags = [];
      const months = (modelData.months || []).length || 12;
      const idx = months - 1;

      if (currentIndustry === 'saas') {
        const ltv = data.ltv || 0;
        const nrr = data.nrr || 0;
        const cashMonths = data.cash && data.cash[idx] > 0 ? data.cash[idx] / 200000 : 0;
        flags.push(ltv >= 3
          ? { label: `LTV/CAC ${ltv.toFixed(1)}x ‚Äî healthy`, cls: 'guardrail-flag--ok' }
          : ltv >= 2
          ? { label: `LTV/CAC ${ltv.toFixed(1)}x ‚Äî watch`, cls: 'guardrail-flag--warn' }
          : { label: `LTV/CAC ${ltv.toFixed(1)}x ‚Äî below 2√ó threshold ‚ö†`, cls: 'guardrail-flag--risk' });
        flags.push(nrr >= 110
          ? { label: `NRR ${nrr.toFixed(0)}% ‚Äî expansion`, cls: 'guardrail-flag--ok' }
          : nrr >= 100
          ? { label: `NRR ${nrr.toFixed(0)}% ‚Äî stable`, cls: 'guardrail-flag--warn' }
          : { label: `NRR ${nrr.toFixed(0)}% ‚Äî contraction risk ‚ö†`, cls: 'guardrail-flag--risk' });
        flags.push(cashMonths > 12
          ? { label: `Runway ${cashMonths.toFixed(0)} mo ‚Äî safe`, cls: 'guardrail-flag--ok' }
          : cashMonths > 6
          ? { label: `Runway ${cashMonths.toFixed(0)} mo ‚Äî monitor`, cls: 'guardrail-flag--warn' }
          : { label: `Runway ${cashMonths.toFixed(0)} mo ‚Äî critical ‚ö†`, cls: 'guardrail-flag--risk' });
      } else if (currentIndustry === 'manufacturing') {
        const gm = data.grossMargin || 0;
        const baseGm = modelData.scenarios['base'] ? modelData.scenarios['base'].grossMargin || 0 : gm;
        // KEY GUARDRAIL: promo GP% below baseline
        if (currentScenario !== 'base' && gm < baseGm) {
          flags.push({ label: `Gross margin ${gm.toFixed(1)}% < Base ${baseGm.toFixed(1)}% ‚Äî promo GP below baseline ‚ö†`, cls: 'guardrail-flag--risk' });
        } else {
          flags.push({ label: `Gross margin ${gm.toFixed(1)}% ‚Äî ${gm >= 40 ? 'healthy' : 'thin'}`, cls: gm >= 40 ? 'guardrail-flag--ok' : 'guardrail-flag--warn' });
        }
        const ue = data.unitEconomics || 0;
        flags.push(ue > 0
          ? { label: `Unit contribution $${ue.toFixed(0)} ‚Äî positive`, cls: 'guardrail-flag--ok' }
          : { label: `Unit contribution $${ue.toFixed(0)} ‚Äî negative ‚ö†`, cls: 'guardrail-flag--risk' });
      } else if (currentIndustry === 'media') {
        const em = data.ebitdaMargin || 0;
        flags.push(em > 20
          ? { label: `EBITDA margin ${em.toFixed(1)}% ‚Äî strong`, cls: 'guardrail-flag--ok' }
          : em > 0
          ? { label: `EBITDA margin ${em.toFixed(1)}% ‚Äî marginal`, cls: 'guardrail-flag--warn' }
          : { label: `EBITDA margin ${em.toFixed(1)}% ‚Äî loss-making ‚ö†`, cls: 'guardrail-flag--risk' });
      } else if (currentIndustry === 'lending') {
        const lr = data.lossRate || 0;
        flags.push(lr < 1
          ? { label: `Net loss rate ${lr.toFixed(2)}% ‚Äî controlled`, cls: 'guardrail-flag--ok' }
          : lr < 3
          ? { label: `Net loss rate ${lr.toFixed(2)}% ‚Äî elevated`, cls: 'guardrail-flag--warn' }
          : { label: `Net loss rate ${lr.toFixed(2)}% ‚Äî impairment risk ‚ö†`, cls: 'guardrail-flag--risk' });
        const nim = data.netInterestMargin || 0;
        flags.push(nim > 40
          ? { label: `NIM ${nim.toFixed(0)}% ‚Äî healthy spread`, cls: 'guardrail-flag--ok' }
          : { label: `NIM ${nim.toFixed(0)}% ‚Äî compressed`, cls: 'guardrail-flag--warn' });
      } else if (currentIndustry === 'realestate') {
        const noi = data.noiMargin || 0;
        const baseNoi = modelData.scenarios['base'] ? modelData.scenarios['base'].noiMargin || 0 : noi;
        if (currentScenario !== 'base' && noi < baseNoi) {
          flags.push({ label: `NOI margin ${noi.toFixed(1)}% < Base ${baseNoi.toFixed(1)}% ‚ö†`, cls: 'guardrail-flag--risk' });
        } else {
          flags.push({ label: `NOI margin ${noi.toFixed(1)}% ‚Äî ${noi >= 65 ? 'above market' : 'watch costs'}`, cls: noi >= 65 ? 'guardrail-flag--ok' : 'guardrail-flag--warn' });
        }
      }
      return flags;
    }

    function renderDecisionBox() {
      const box = document.getElementById('decisionBox');
      if (!box || currentMode === 'variance') return;
      box.style.display = '';

      const data = modelData.scenarios && modelData.scenarios[currentScenario];
      if (!data) { box.style.display = 'none'; return; }

      const months = (modelData.months || []).length || 12;
      const idx = months - 1;
      const guardrails = computeGuardrails(data);
      const hasRisk = guardrails.some(f => f.cls === 'guardrail-flag--risk');
      const hasWarn = guardrails.some(f => f.cls === 'guardrail-flag--warn');

      let verdict, bullets, boxClass, eyebrow, nextStep;

      if (currentIndustry === 'saas') {
        const ltv = data.ltv || 0;
        const runway = data.cash && data.cash[idx] > 0 ? data.cash[idx] / 200000 : 0;
        const mrrGrowth = data.mrrTrend ? ((data.mrrTrend[idx] - data.mrrTrend[0]) / data.mrrTrend[0]) * 100 : 0;
        if (hasRisk) {
          boxClass = 'decision-box--hold'; eyebrow = 'DECISION';
          verdict = `Don't scale spend ‚Äî <span class="verdict-action">fix unit economics first</span>`;
          bullets = [
            `LTV/CAC of ${ltv.toFixed(1)}√ó is below the 3√ó threshold; each new customer acquired at current CAC destroys value.`,
            runway < 6 ? `Runway of ${runway.toFixed(0)} months is critically short ‚Äî stop discretionary growth spend immediately.` : `Focus on churn reduction before increasing new customer acquisition spend.`,
            `Run ‚Üí only after LTV/CAC exceeds 2.5√ó and NRR stabilizes above 100%.`
          ];
          nextStep = `Prioritize churn reduction & gross margin improvement before next growth push.`;
        } else if (hasWarn) {
          boxClass = 'decision-box--caution'; eyebrow = 'DECISION';
          verdict = `Run cautiously ‚Äî <span class="verdict-action">monitor NRR & runway weekly</span>`;
          bullets = [
            `MRR grew ${mrrGrowth.toFixed(0)}% with LTV/CAC at ${ltv.toFixed(1)}√ó ‚Äî viable but not yet exceptional.`,
            `Prioritize channels with CAC payback under 12 months; cut or pause others.`,
            `Set a hard floor: if NRR dips below 100%, pause acquisition spend that week.`
          ];
          nextStep = `Tighten cohort analysis ‚Äî identify which segments have best NRR and double down.`;
        } else {
          boxClass = 'decision-box--run'; eyebrow = 'DECISION';
          verdict = `Run the growth plan ‚Äî <span class="verdict-action">unit economics support acceleration</span>`;
          bullets = [
            `LTV/CAC of ${ltv.toFixed(1)}√ó clears the 3√ó bar; growth investment will compound positively.`,
            `NRR above 110% means existing customers are funding net-new acquisition ‚Äî efficient engine.`,
            `With ${runway.toFixed(0)} months of runway, there is headroom to invest ahead of the ARR curve.`
          ];
          nextStep = `Allocate growth budget toward highest-NRR cohort channels; review quarterly.`;
        }

      } else if (currentIndustry === 'manufacturing') {
        const gm = data.grossMargin || 0;
        const baseGm = modelData.scenarios['base'] ? modelData.scenarios['base'].grossMargin || 0 : gm;
        const gmDrop = baseGm - gm;
        const ue = data.unitEconomics || 0;

        if (currentScenario !== 'base' && gmDrop > 5) {
          boxClass = 'decision-box--hold'; eyebrow = 'DECISION';
          verdict = `Don't run this promo ‚Äî <span class="verdict-action">gross margin falls ${gmDrop.toFixed(1)}pp below base</span>`;
          bullets = [
            `Promo/downside scenario cuts gross margin from ${baseGm.toFixed(1)}% to ${gm.toFixed(1)}% ‚Äî a ${gmDrop.toFixed(1)}pp erosion that exceeds acceptable discount tolerance.`,
            `Unit contribution drops to ${formatValue(ue, 'currency')}; at this level fixed cost absorption becomes a risk at any volume dip.`,
            `Only run if volume uplift is at least ${Math.ceil(gmDrop / gm * 100)}%+ ‚Äî model the break-even volume before committing.`
          ];
          nextStep = `Recalibrate discount pool or channel mix to protect a minimum ${baseGm.toFixed(0)}% gross margin floor.`;
        } else if (hasWarn || gm < 35) {
          boxClass = 'decision-box--caution'; eyebrow = 'DECISION';
          verdict = `Run with guardrails ‚Äî <span class="verdict-action">set a minimum GP% floor before launch</span>`;
          bullets = [
            `Gross margin of ${gm.toFixed(1)}% is thin; any further COGS inflation or discount pressure will compress to breakeven.`,
            `Promo GP% is ${currentScenario !== 'base' ? (gmDrop > 0 ? `${gmDrop.toFixed(1)}pp below baseline ‚Äî ensure volume compensates` : 'in line with base case') : 'the baseline ‚Äî model downside promo scenario before committing'}.`,
            `Cap maximum discount at ${Math.max(0, gm - 30).toFixed(0)}pp to maintain a 30% gross margin floor.`
          ];
          nextStep = `Push discount pool decision to SKU-level P&L ‚Äî blended margin can hide individual product losses.`;
        } else {
          boxClass = 'decision-box--run'; eyebrow = 'DECISION';
          verdict = `Run the promo ‚Äî <span class="verdict-action">margin supports the discount pool</span>`;
          bullets = [
            `Gross margin of ${gm.toFixed(1)}% provides ${(gm - 30).toFixed(1)}pp of discount headroom above a 30% floor.`,
            `Unit contribution of ${formatValue(ue, 'currency')} remains positive even after modeled discounting.`,
            `Push digital/direct channels first ‚Äî lower distribution cost preserves more of the margin benefit.`
          ];
          nextStep = `Lock in the discount pool at ‚â§${Math.max(0, gm - 30).toFixed(0)}pp; track sell-through weekly to catch early margin slippage.`;
        }

      } else if (currentIndustry === 'media') {
        const em = data.ebitdaMargin || 0;
        const arpu = data.arpu || 0;
        if (em < 0) {
          boxClass = 'decision-box--hold'; eyebrow = 'DECISION';
          verdict = `Don't push volume yet ‚Äî <span class="verdict-action">achieve EBITDA breakeven first</span>`;
          bullets = [
            `EBITDA margin of ${em.toFixed(1)}% means every incremental user adds revenue but also negative margin ‚Äî scale accelerates losses.`,
            `ARPU of ${formatValue(arpu, 'currency')} is insufficient to cover content + OpEx at this fill rate; either raise CPM floor or cut content cost.`,
            `Model the CPM and fill rate required to hit breakeven, then set those as launch criteria for the next push.`
          ];
          nextStep = `Negotiate a CPM floor with top 3 demand partners before the next user growth campaign.`;
        } else if (em < 15) {
          boxClass = 'decision-box--caution'; eyebrow = 'DECISION';
          verdict = `Run cautiously ‚Äî <span class="verdict-action">push high-CPM inventory, not volume</span>`;
          bullets = [
            `EBITDA margin of ${em.toFixed(1)}% is positive but fragile; one content cost spike or fill rate dip erases it.`,
            `Prioritize premium ad formats and direct-sold inventory to lift effective CPM before buying traffic.`,
            `Set a kill switch: if fill rate drops below 70%, pause paid acquisition until monetization stabilizes.`
          ];
          nextStep = `Test programmatic floor price increase in top 2 markets ‚Äî model CPM elasticity on 30-day data.`;
        } else {
          boxClass = 'decision-box--run'; eyebrow = 'DECISION';
          verdict = `Run the growth campaign ‚Äî <span class="verdict-action">monetization supports user acquisition</span>`;
          bullets = [
            `EBITDA margin of ${em.toFixed(1)}% provides operating leverage; incremental users are additive to the bottom line.`,
            `ARPU of ${formatValue(arpu, 'currency')} clears content cost at scale ‚Äî push the channel with best DAU retention.`,
            `Reinvest 40‚Äì50% of EBITDA into user acquisition to compound the audience flywheel.`
          ];
          nextStep = `Allocate growth budget to cohorts with highest D30 retention; pull back on high-churn acquisition channels.`;
        }

      } else if (currentIndustry === 'lending') {
        const lr = data.lossRate || 0;
        const nim = data.netInterestMargin || 0;
        const roe = data.roe || 0;
        if (lr >= 3 || roe < 0) {
          boxClass = 'decision-box--hold'; eyebrow = 'DECISION';
          verdict = `Pause originations ‚Äî <span class="verdict-action">tighten underwriting before scaling</span>`;
          bullets = [
            `Net loss rate of ${lr.toFixed(2)}% and ROE of ${roe.toFixed(0)}% signal the portfolio is destroying value at current credit standards.`,
            `Do not grow origination volume until vintage analysis confirms the loss curve is stabilizing.`,
            `Activate recovery collections on DPD 60+ accounts ‚Äî prioritize recovery before adding new risk.`
          ];
          nextStep = `Cut approval rates by 20‚Äì30% and re-underwrite using last 6 months of vintage performance.`;
        } else if (lr >= 1.5 || nim < 30) {
          boxClass = 'decision-box--caution'; eyebrow = 'DECISION';
          verdict = `Grow selectively ‚Äî <span class="verdict-action">tighten credit box on riskier segments</span>`;
          bullets = [
            `NIM of ${nim.toFixed(0)}% and loss rate of ${lr.toFixed(2)}% are manageable but leaves limited buffer for macro deterioration.`,
            `Focus origination on the top 2 credit tiers by DSCR/score; pull back on borderline approvals.`,
            `Set a monthly loss rate ceiling of 2%; if breached, auto-tighten approval criteria for the following month.`
          ];
          nextStep = `Segment vintage P&L by credit band ‚Äî identify which cohorts are profitable and allocate capital accordingly.`;
        } else {
          boxClass = 'decision-box--run'; eyebrow = 'DECISION';
          verdict = `Scale originations ‚Äî <span class="verdict-action">credit economics are attractive</span>`;
          bullets = [
            `NIM of ${nim.toFixed(0)}% with net loss rate of ${lr.toFixed(2)}% yields ROE of ${roe.toFixed(0)}% ‚Äî well above hurdle rate.`,
            `Increase origination volume in highest-NIM segments while maintaining underwriting discipline.`,
            `Expand funding facilities to support growth ‚Äî current capital efficiency ratio supports leverage increase.`
          ];
          nextStep = `Raise warehouse line by 20‚Äì30% to fund next origination tranche; hedge rate exposure if fixed-rate book > 60%.`;
        }

      } else if (currentIndustry === 'realestate') {
        const noi = data.noiMargin || 0;
        const cap = data.capRate || 0;
        const fcf = data.fcf && data.fcf[idx];
        if (fcf !== undefined && fcf < 0) {
          boxClass = 'decision-box--hold'; eyebrow = 'DECISION';
          verdict = `Hold ‚Äî <span class="verdict-action">negative FCF after debt service</span>`;
          bullets = [
            `Free cash flow of ${formatValue(fcf, 'currency')}/mo after debt service is negative ‚Äî the asset is consuming equity capital.`,
            `Either refinance at a lower debt service cost, increase occupancy to above 90%, or divest and redeploy.`,
            `Cap rate of ${cap.toFixed(2)}% vs implied hurdle rate ‚Äî current valuation may exceed intrinsic value.`
          ];
          nextStep = `Model three scenarios: (1) lease-up timeline, (2) refinance terms, (3) exit cap rate ‚Äî present to investment committee within 30 days.`;
        } else if (noi < 60 || cap < 5) {
          boxClass = 'decision-box--caution'; eyebrow = 'DECISION';
          verdict = `Hold and optimise ‚Äî <span class="verdict-action">NOI margin needs improvement before expansion</span>`;
          bullets = [
            `NOI margin of ${noi.toFixed(1)}% is below the 65% benchmark ‚Äî operating efficiency is dragging net return.`,
            `Renegotiate maintenance and management contracts; target 300bps of OpEx reduction over 12 months.`,
            `Do not acquire additional assets at this cap rate (${cap.toFixed(2)}%) until existing portfolio FCF is stable.`
          ];
          nextStep = `Commission an independent OpEx audit; benchmark against comparable assets in the same sub-market.`;
        } else {
          boxClass = 'decision-box--run'; eyebrow = 'DECISION';
          verdict = `Deploy capital ‚Äî <span class="verdict-action">asset economics support acquisition or development</span>`;
          bullets = [
            `NOI margin of ${noi.toFixed(1)}% and cap rate of ${cap.toFixed(2)}% indicate strong operating performance with positive FCF.`,
            `Pursue value-add acquisitions in the same sub-market to leverage management platform at scale.`,
            `Consider refinancing at current LTV to pull equity for next acquisition without dilution.`
          ];
          nextStep = `Run a pipeline analysis of off-market assets within 500m; prioritise sub-5% cap rate acquisitions with 90%+ occupancy.`;
        }
      }

      if (!verdict) { box.style.display = 'none'; return; }

      box.className = `decision-box ${boxClass}`;
      box.innerHTML = `
        <div class="decision-box-eyebrow">${eyebrow}</div>
        <div class="decision-box-verdict">${verdict}</div>
        <ul class="decision-box-bullets">
          ${bullets.map(b => `<li>${b}</li>`).join('')}
        </ul>
        <div class="decision-box-guardrails">
          ${guardrails.map(f => `<span class="guardrail-flag ${f.cls}">${f.label}</span>`).join('')}
        </div>
        <div class="decision-box-next" style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(12,23,45,0.10);font-size:12px;font-weight:600;color:var(--muted);">
          Next action: <span style="color:var(--accent-2);">${nextStep}</span>
        </div>
      `;
    }

    // ============================================
    // INITIALIZE ON LOAD
    // ============================================
    
    window.addEventListener('DOMContentLoaded', function() {
      restoreFromHash();
      init();
      renderSensitivity();
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Industry-Adaptive FP&A Simulator ‚Äî Real-time financial planning and scenario modeling" />
  <meta name="theme-color" content="#0B1220" />
  <title>FP&A Simulator ‚Äî Industry-Adaptive Financial Planning</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Favicon -->
<link rel="icon" type="image/png" href="favicon.png">

  
  <style>
    :root {
      --bg: #ffffff;
      --bg-muted: #f6f8fb;
      --text: #0b1220;
      --muted: #5d6b7a;
      --border: rgba(12, 23, 45, 0.10);
      --shadow: 0 10px 30px rgba(11, 18, 32, 0.08);
      --shadow-soft: 0 8px 18px rgba(11, 18, 32, 0.06);
      --accent: #0f766e;
      --accent-2: #1b4d7a;
      --accent-soft: rgba(15, 118, 110, 0.10);
      --radius: 18px;
      --radius-sm: 14px;
      --max: 1120px;
      --font-sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    * { box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-sans);
      line-height: 1.45;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a { color: inherit; text-decoration: none; }
    p { margin: 0; }
    h1, h2, h3, h4 { margin: 0; letter-spacing: -0.02em; }

    .container {
      width: min(var(--max), calc(100% - 48px));
      margin: 0 auto;
    }

    .skip-link {
      position: absolute;
      left: -999px;
      top: 12px;
      padding: 10px 12px;
      background: var(--text);
      color: white;
      border-radius: 10px;
      z-index: 9999;
    }
    .skip-link:focus { left: 12px; }

    /* Header / Nav */
    .site-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,0.78);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 0;
      gap: 16px;
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-weight: 650;
      letter-spacing: -0.02em;
    }

    .brand-mark {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 0 6px var(--accent-soft);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      transition: all 140ms ease;
    }
    .back-link:hover {
      border-color: rgba(12, 23, 45, 0.18);
      box-shadow: 0 6px 18px rgba(11,18,32,0.06);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid transparent;
      transition: all 140ms ease;
      user-select: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn:active { transform: translateY(1px); }

    .btn-solid {
      background: var(--text);
      color: white;
      box-shadow: var(--shadow-soft);
    }
    .btn-solid:hover { box-shadow: var(--shadow); }

    .btn-ghost {
      background: white;
      border-color: var(--border);
      color: var(--text);
    }
    .btn-ghost:hover { border-color: rgba(12, 23, 45, 0.18); box-shadow: 0 6px 18px rgba(11,18,32,0.06); }

    .btn-accent {
      background: var(--accent);
      color: white;
      box-shadow: var(--shadow-soft);
    }
    .btn-accent:hover { box-shadow: var(--shadow); }

    .btn-sm {
      padding: 7px 12px;
      font-size: 13px;
    }

    /* Module section */
    .module-section {
      padding: 32px 0;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }

    .module-header {
      margin-bottom: 24px;
    }

    .module-eyebrow {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(246,248,251,0.8);
      color: var(--muted);
      margin-bottom: 10px;
    }

    .module-title {
      font-size: 32px;
      line-height: 1.1;
      margin-bottom: 8px;
    }

    .module-subtitle {
      font-size: 16px;
      color: var(--muted);
      max-width: 60ch;
    }

    .module-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    /* Industry & Scenario Tabs */
    .tab-section {
      margin: 20px 0;
    }

    .tab-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
      margin-bottom: 10px;
      display: block;
    }

    .tab-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 9px 16px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      cursor: pointer;
      transition: all 140ms ease;
    }

    .tab:hover {
      border-color: rgba(12, 23, 45, 0.18);
      box-shadow: 0 4px 12px rgba(11,18,32,0.05);
    }

    .tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      box-shadow: var(--shadow-soft);
    }

    /* Main content */
    .main-content {
      padding: 24px 0 64px 0;
      background: var(--bg-muted);
    }

    .layout-grid {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 20px;
      align-items: start;
    }

    /* Sidebar */
    .sidebar {
      position: sticky;
      top: 84px;
      display: grid;
      gap: 12px;
    }

    .sidebar-section {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow-soft);
    }

    .sidebar-title {
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
      margin-bottom: 12px;
    }

    /* Controls */
    .control-item {
      margin-bottom: 18px;
    }

    .control-item:last-child {
      margin-bottom: 0;
    }

    .control-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .control-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-2);
      font-family: var(--font-mono);
    }

    .control-input-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-input {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--bg-muted);
      outline: none;
      cursor: pointer;
    }

    .control-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(15, 118, 110, 0.3);
      transition: all 140ms ease;
    }

    .control-input::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.4);
    }

    .control-input::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(15, 118, 110, 0.3);
      border: none;
    }

    .control-buttons {
      display: flex;
      gap: 4px;
    }

    .control-btn {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text);
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 140ms ease;
    }

    .control-btn:hover {
      background: var(--bg-muted);
      border-color: rgba(12, 23, 45, 0.18);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    /* Cards */
    .card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-soft);
    }

    .card-title {
      font-size: 18px;
      font-weight: 650;
      margin-bottom: 20px;
      color: var(--text);
    }

    /* KPI Cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 20px;
      box-shadow: var(--shadow-soft);
      transition: all 140ms ease;
    }

    .kpi-card:hover {
      box-shadow: var(--shadow);
      transform: translateY(-2px);
    }

    .kpi-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
      margin-bottom: 4px;
    }

    .kpi-change {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .kpi-change.positive {
      color: #059669;
    }

    .kpi-change.negative {
      color: #dc2626;
    }

    .kpi-change.neutral {
      color: var(--muted);
    }

    /* Charts */
    .chart-container {
      position: relative;
      height: 380px;
      padding: 16px 0;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    /* Data Preview */
    .data-preview {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 24px;
    }

    .data-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .data-preview-title {
      font-size: 18px;
      font-weight: 650;
      color: var(--text);
    }

    .data-preview-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 650;
      background: var(--accent-soft);
      color: var(--accent-2);
    }

    .data-table-wrapper {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .data-table th {
      background: var(--bg-muted);
      padding: 12px 16px;
      text-align: left;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }

    .data-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
    }

    .data-table tbody tr:last-child td {
      border-bottom: none;
    }

    .data-table tbody tr:hover {
      background: var(--bg-muted);
    }

    /* Commentary */
    .commentary {
      background: linear-gradient(135deg, var(--accent-soft), rgba(27,77,122,0.05));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-soft);
    }

    .commentary-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .commentary-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--accent);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .commentary-title {
      font-size: 16px;
      font-weight: 650;
      color: var(--text);
    }

    .commentary-content {
      font-size: 14px;
      line-height: 1.6;
      color: var(--muted);
    }

    .commentary-content p {
      margin-bottom: 14px;
    }

    .commentary-content p:last-child {
      margin-bottom: 0;
    }

    .commentary-content strong {
      color: var(--text);
      font-weight: 650;
    }

    .commentary-highlight {
      display: inline-flex;
      padding: 2px 8px;
      background: white;
      border-radius: 6px;
      font-weight: 700;
      color: var(--accent-2);
      font-family: var(--font-mono);
      font-size: 13px;
    }

    /* File Upload */
    .file-upload {
      position: relative;
      display: inline-block;
    }

    .file-upload input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 80px;
      right: 32px;
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 16px 20px;
      box-shadow: var(--shadow);
      z-index: 200;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 340px;
      animation: slideIn 300ms ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .notification.success .notification-icon {
      background: #059669;
      color: white;
    }

    .notification.error .notification-icon {
      background: #dc2626;
      color: white;
    }

    .notification.info .notification-icon {
      background: var(--accent);
      color: white;
    }

    .notification-message {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .layout-grid {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: relative;
        top: 0;
      }

      .chart-grid {
        grid-template-columns: 1fr;
      }

      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .kpi-grid {
        grid-template-columns: 1fr;
      }

      .module-title {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <!-- Skip link for accessibility -->
  <a class="skip-link" href="#main">Skip to content</a>

  <!-- HEADER -->
  <header class="site-header" id="top">
    <div class="container nav">
      <a class="brand" href="index.html" aria-label="Back to portfolio">
        <span class="brand-mark" aria-hidden="true"></span>
        <span>FP&A Portfolio</span>
      </a>

      <a class="back-link" href="index.html">
        ‚Üê Back to Portfolio
      </a>
    </div>
  </header>

  <!-- MODULE SECTION -->
  <section class="module-section">
    <div class="container">
      <div class="module-header">
        <div class="module-eyebrow">
          ‚≠ê Industry-Adaptive Model
        </div>
        <h1 class="module-title" id="moduleTitle">SaaS Financial Model</h1>
        <p class="module-subtitle">Real-time financial simulation and scenario planning with dynamic driver modeling</p>
        
        <div class="module-actions">
          <span class="module-eyebrow" id="dataModeIndicator">
            üìä Sample Data
          </span>
          <button class="btn btn-ghost btn-sm" onclick="useSampleData()">Use Sample</button>
          <button class="btn btn-ghost btn-sm" onclick="generateRandomData()">Generate Random</button>
          <button class="btn btn-accent btn-sm" onclick="downloadTemplate()">Download Template</button>
          <div class="file-upload">
            <input type="file" id="fileUpload" accept=".csv" onchange="handleFileUpload(event)">
            <button class="btn btn-solid btn-sm" onclick="document.getElementById('fileUpload').click()">Upload Data</button>
          </div>
        </div>
      </div>

      <!-- Industry Selector -->
      <div class="tab-section">
        <span class="tab-label">Industry</span>
        <div class="tab-group" id="industryTabs">
          <button class="tab active" data-industry="saas" onclick="switchIndustry('saas')">SaaS</button>
          <button class="tab" data-industry="media" onclick="switchIndustry('media')">Media & Platforms</button>
          <button class="tab" data-industry="manufacturing" onclick="switchIndustry('manufacturing')">Manufacturing</button>
          <button class="tab" data-industry="lending" onclick="switchIndustry('lending')">Lending</button>
          <button class="tab" data-industry="realestate" onclick="switchIndustry('realestate')">Real Estate</button>
        </div>
      </div>

      <!-- Scenario Selector -->
      <div class="tab-section">
        <span class="tab-label">Scenario</span>
        <div class="tab-group" id="scenarioTabs">
          <button class="tab active" data-scenario="base" onclick="switchScenario('base')">Base Case</button>
          <button class="tab" data-scenario="upside" onclick="switchScenario('upside')">Upside</button>
          <button class="tab" data-scenario="downside" onclick="switchScenario('downside')">Downside</button>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIN CONTENT -->
  <main id="main" class="main-content">
    <div class="container">
      <div class="layout-grid">
        <!-- SIDEBAR: DRIVERS & CONSTRAINTS -->
        <aside class="sidebar">
          <div class="sidebar-section">
            <div class="sidebar-title">Drivers & Constraints</div>
            <div id="controlsContainer">
              <!-- Controls will be injected here -->
            </div>
          </div>
        </aside>

        <!-- MAIN CONTENT AREA -->
        <div>
          <!-- KPIs -->
          <div class="kpi-grid" id="kpiGrid">
            <!-- KPIs will be injected here -->
          </div>

          <!-- Data Preview Section -->
          <div class="data-preview" id="dataPreviewSection" style="display: none;">
            <div class="data-preview-header">
              <div class="data-preview-title">Uploaded Data Preview</div>
              <div class="data-preview-badge" id="dataPreviewBadge">
                <span id="dataPreviewCount">0 rows</span>
              </div>
            </div>
            <div class="data-table-wrapper">
              <table class="data-table" id="dataTable">
                <thead id="dataTableHead">
                  <!-- Table headers will be injected here -->
                </thead>
                <tbody id="dataTableBody">
                  <!-- Table rows will be injected here -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Charts -->
          <div class="chart-grid">
            <div class="card">
              <div class="card-title" id="chart1Title">Revenue Growth</div>
              <div class="chart-container">
                <canvas id="chart1"></canvas>
              </div>
            </div>

            <div class="card">
              <div class="card-title" id="chart2Title">Profitability</div>
              <div class="chart-container">
                <canvas id="chart2"></canvas>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom: 20px;">
            <div class="card-title" id="chart3Title">Cash Flow Forecast</div>
            <div class="chart-container">
              <canvas id="chart3"></canvas>
            </div>
          </div>

          <!-- Commentary -->
          <div class="commentary" id="commentarySection">
            <!-- Commentary will be injected here -->
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ============================================
    // CONFIGURATION ENGINE
    // ============================================
    
    const INDUSTRIES = {
      saas: {
        name: 'SaaS',
        title: 'SaaS Financial Model',
        drivers: [
          { id: 'startingCustomers', label: 'Starting Customers', min: 50, max: 5000, default: 500, step: 50, format: 'number' },
          { id: 'mrr', label: 'Avg MRR per Customer', min: 50, max: 1000, default: 300, step: 10, format: 'currency' },
          { id: 'growth', label: 'Monthly Growth %', min: 0, max: 20, default: 8, step: 0.5, format: 'percent' },
          { id: 'churn', label: 'Churn Rate %', min: 0, max: 10, default: 3, step: 0.5, format: 'percent' },
          { id: 'cac', label: 'Customer CAC', min: 100, max: 2000, default: 500, step: 50, format: 'currency' },
          { id: 'grossMargin', label: 'Gross Margin %', min: 50, max: 95, default: 80, step: 1, format: 'percent' }
        ],
        kpis: [
          { id: 'arr', label: 'ARR', format: 'currency' },
          { id: 'customers', label: 'Customers', format: 'number' },
          { id: 'ltv', label: 'LTV/CAC', format: 'ratio' },
          { id: 'nrr', label: 'NRR', format: 'percent' }
        ],
        charts: [
          { id: 'chart1', title: 'MRR Growth', metric: 'mrrTrend', yLabel: 'MRR ($)' },
          { id: 'chart2', title: 'Net Revenue Retention', metric: 'nrrTrend', yLabel: 'NRR %' },
          { id: 'chart3', title: 'Cash Runway', metric: 'cash', yLabel: 'Cash Balance ($)' }
        ]
      },
      
      media: {
        name: 'Media & Platforms',
        title: 'Media & Advertising Model',
        drivers: [
          { id: 'users', label: 'Active Users', min: 100000, max: 10000000, default: 1000000, step: 100000, format: 'number' },
          { id: 'userGrowth', label: 'User Growth %', min: 0, max: 30, default: 10, step: 1, format: 'percent' },
          { id: 'engagement', label: 'Engagement min/user', min: 10, max: 120, default: 45, step: 5, format: 'number' },
          { id: 'cpm', label: 'Ad CPM', min: 1, max: 20, default: 8, step: 0.5, format: 'currency' },
          { id: 'fillRate', label: 'Ad Fill Rate %', min: 40, max: 95, default: 75, step: 5, format: 'percent' }
        ],
        kpis: [
          { id: 'adRevenue', label: 'Ad Revenue', format: 'currency' },
          { id: 'arpu', label: 'ARPU', format: 'currency' },
          { id: 'dau', label: 'DAU', format: 'number' },
          { id: 'ebitdaMargin', label: 'EBITDA Margin', format: 'percent' }
        ],
        charts: [
          { id: 'chart1', title: 'User Growth', metric: 'users', yLabel: 'Users' },
          { id: 'chart2', title: 'Revenue per User (ARPU)', metric: 'arpuTrend', yLabel: 'ARPU ($)' },
          { id: 'chart3', title: 'EBITDA Margin', metric: 'ebitdaMarginTrend', yLabel: 'Margin %' }
        ]
      },
      
      manufacturing: {
        name: 'Manufacturing',
        title: 'Manufacturing Operations Model',
        drivers: [
          { id: 'unitsPerMonth', label: 'Units per Month', min: 1000, max: 100000, default: 10000, step: 1000, format: 'number' },
          { id: 'sellPrice', label: 'Avg Sell Price', min: 10, max: 500, default: 100, step: 10, format: 'currency' },
          { id: 'materialCost', label: 'Material Cost %', min: 20, max: 60, default: 35, step: 1, format: 'percent' },
          { id: 'laborCost', label: 'Labor Cost %', min: 10, max: 40, default: 20, step: 1, format: 'percent' },
          { id: 'utilizationRate', label: 'Utilization Rate %', min: 50, max: 95, default: 75, step: 5, format: 'percent' }
        ],
        kpis: [
          { id: 'revenue', label: 'Revenue', format: 'currency' },
          { id: 'grossProfit', label: 'Gross Profit', format: 'currency' },
          { id: 'grossMargin', label: 'Gross Margin', format: 'percent' },
          { id: 'unitEconomics', label: 'Unit Contribution', format: 'currency' }
        ],
        charts: [
          { id: 'chart1', title: 'Production Volume', metric: 'units', yLabel: 'Units' },
          { id: 'chart2', title: 'Gross Margin Trend', metric: 'grossMarginTrend', yLabel: 'Margin %' },
          { id: 'chart3', title: 'Operating Cash Flow', metric: 'cashFlow', yLabel: 'Cash Flow ($)' }
        ]
      },
      
      lending: {
        name: 'Lending',
        title: 'Lending Portfolio Model',
        drivers: [
          { id: 'originations', label: 'Monthly Originations', min: 1000000, max: 50000000, default: 10000000, step: 1000000, format: 'currency' },
          { id: 'avgRate', label: 'Avg Interest Rate %', min: 3, max: 20, default: 8, step: 0.5, format: 'percent' },
          { id: 'defaultRate', label: 'Default Rate %', min: 0, max: 10, default: 2, step: 0.25, format: 'percent' },
          { id: 'recoveryRate', label: 'Recovery Rate %', min: 0, max: 80, default: 40, step: 5, format: 'percent' },
          { id: 'fundingCost', label: 'Funding Cost %', min: 1, max: 10, default: 4, step: 0.25, format: 'percent' }
        ],
        kpis: [
          { id: 'portfolioSize', label: 'Portfolio Size', format: 'currency' },
          { id: 'netInterestMargin', label: 'Net Interest Margin', format: 'percent' },
          { id: 'lossRate', label: 'Net Loss Rate', format: 'percent' },
          { id: 'roe', label: 'ROE', format: 'percent' }
        ],
        charts: [
          { id: 'chart1', title: 'Portfolio Growth', metric: 'portfolio', yLabel: 'Portfolio Size ($)' },
          { id: 'chart2', title: 'Credit Performance', metric: 'defaultsTrend', yLabel: 'Defaults ($)' },
          { id: 'chart3', title: 'Net Income', metric: 'netIncome', yLabel: 'Net Income ($)' }
        ]
      },
      
      realestate: {
        name: 'Real Estate',
        title: 'Real Estate & Leasing Model',
        drivers: [
          { id: 'totalSqm', label: 'Total Sqm', min: 10000, max: 500000, default: 100000, step: 10000, format: 'number' },
          { id: 'occupancyRate', label: 'Occupancy Rate %', min: 50, max: 100, default: 85, step: 5, format: 'percent' },
          { id: 'rentPerSqm', label: 'Rent per Sqm', min: 10, max: 100, default: 30, step: 5, format: 'currency' },
          { id: 'opexRatio', label: 'OpEx % of Revenue', min: 20, max: 50, default: 30, step: 2, format: 'percent' },
          { id: 'debtService', label: 'Debt Service', min: 0, max: 500000, default: 150000, step: 10000, format: 'currency' }
        ],
        kpis: [
          { id: 'rentalIncome', label: 'Rental Income', format: 'currency' },
          { id: 'noi', label: 'NOI', format: 'currency' },
          { id: 'noiMargin', label: 'NOI Margin', format: 'percent' },
          { id: 'capRate', label: 'Cap Rate', format: 'percent' }
        ],
        charts: [
          { id: 'chart1', title: 'Rental Revenue', metric: 'rent', yLabel: 'Revenue ($)' },
          { id: 'chart2', title: 'Net Operating Income', metric: 'noiTrend', yLabel: 'NOI ($)' },
          { id: 'chart3', title: 'Free Cash Flow', metric: 'fcf', yLabel: 'FCF ($)' }
        ]
      }
    };

    // ============================================
    // STATE MANAGEMENT
    // ============================================
    
    let currentIndustry = 'saas';
    let currentScenario = 'base';
    let currentDataMode = 'sample';
    let driverValues = {};
    let modelData = {};
    let charts = {};
    let uploadedData = null;

    // ============================================
    // INITIALIZATION
    // ============================================
    
    function init() {
      initializeDrivers();
      generateSampleData();
      renderAll();
    }

    function initializeDrivers() {
      const industry = INDUSTRIES[currentIndustry];
      driverValues = {};
      industry.drivers.forEach(driver => {
        driverValues[driver.id] = driver.default;
      });
    }

    // ============================================
    // INDUSTRY SWITCHING
    // ============================================
    
    function switchIndustry(industry) {
      currentIndustry = industry;
      
      document.querySelectorAll('#industryTabs .tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.industry === industry);
      });
      
      document.getElementById('moduleTitle').textContent = INDUSTRIES[industry].title;
      
      initializeDrivers();
      generateSampleData();
      renderAll();
      
      showNotification(`Switched to ${INDUSTRIES[industry].name} model`, 'info');
    }

    // ============================================
    // SCENARIO SWITCHING
    // ============================================
    
    function switchScenario(scenario) {
      currentScenario = scenario;
      
      document.querySelectorAll('#scenarioTabs .tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.scenario === scenario);
      });
      
      renderKPIs();
      updateCharts();
      renderCommentary();
    }

    // ============================================
    // DATA GENERATION
    // ============================================
    
    function generateSampleData() {
      currentDataMode = 'sample';
      updateDataModeIndicator();
      hideDataPreview();
      
      const months = 12;
      modelData = {
        months: [],
        scenarios: {}
      };
      
      const startDate = new Date();
      for (let i = 0; i < months; i++) {
        const date = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
        modelData.months.push(date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
      }
      
      ['base', 'upside', 'downside'].forEach(scenario => {
        modelData.scenarios[scenario] = generateScenarioData(scenario, months);
      });
    }

    function generateRandomData() {
      currentDataMode = 'random';
      updateDataModeIndicator();
      hideDataPreview();
      
      const industry = INDUSTRIES[currentIndustry];
      industry.drivers.forEach(driver => {
        const range = driver.max - driver.min;
        const variance = range * 0.3;
        const newValue = driver.default + (Math.random() - 0.5) * variance;
        driverValues[driver.id] = Math.max(driver.min, Math.min(driver.max, newValue));
      });
      
      const months = 12;
      ['base', 'upside', 'downside'].forEach(scenario => {
        modelData.scenarios[scenario] = generateScenarioData(scenario, months);
      });
      
      renderAll();
      showNotification('Random data generated with varied business conditions', 'success');
    }

    function generateScenarioData(scenario, months) {
      const multipliers = {
        base: 1.0,
        upside: 1.25,
        downside: 0.75
      };
      const mult = multipliers[scenario];
      
      const data = {};
      
      switch (currentIndustry) {
        case 'saas':
          data.mrrTrend = [];
          data.customersTrend = [];
          data.cash = [];
          data.nrrTrend = [];
          
          let customers = driverValues.startingCustomers || 500;
          let cash = 5000000;
          
          for (let i = 0; i < months; i++) {
            const growth = (driverValues.growth / 100) * mult;
            const churn = (driverValues.churn / 100) / mult;
            const netGrowth = growth - churn;
            
            const newCustomers = customers * growth;
            const avgMRR = driverValues.mrr || 300;
            const mrr = customers * avgMRR;
            const expansion = mrr * 0.02 * mult;
            
            customers = customers * (1 + netGrowth);
            
            const revenue = mrr;
            const cogs = revenue * (1 - driverValues.grossMargin / 100);
            const salesCost = newCustomers * driverValues.cac;
            const opex = 200000;
            const netBurn = revenue - cogs - salesCost - opex;
            cash += netBurn;
            
            const nrr = 100 + (netGrowth * 100) + ((expansion / mrr) * 100);
            
            data.mrrTrend.push(mrr);
            data.customersTrend.push(customers);
            data.cash.push(Math.max(0, cash));
            data.nrrTrend.push(Math.max(80, Math.min(140, nrr)));
          }
          
          data.arr = data.mrrTrend[months - 1] * 12;
          data.customers = data.customersTrend[months - 1];
          data.ltv = (driverValues.mrr * 12 / (driverValues.churn / 100)) * (driverValues.grossMargin / 100) / driverValues.cac;
          data.nrr = data.nrrTrend[months - 1];
          break;
          
        case 'media':
          data.users = [];
          data.revenue = [];
          data.arpuTrend = [];
          data.ebitdaMarginTrend = [];
          
          let users = driverValues.users;
          
          for (let i = 0; i < months; i++) {
            const growth = (driverValues.userGrowth / 100) * mult;
            users = users * (1 + growth);
            
            const dailyEngagement = driverValues.engagement;
            const monthlyImpressions = users * dailyEngagement * 30;
            const adRevenue = (monthlyImpressions / 1000) * driverValues.cpm * (driverValues.fillRate / 100);
            const contentCost = adRevenue * 0.4;
            const opex = 500000;
            const ebitda = adRevenue - contentCost - opex;
            const ebitdaMargin = (ebitda / adRevenue) * 100;
            const arpu = adRevenue / users;
            
            data.users.push(users);
            data.revenue.push(adRevenue);
            data.arpuTrend.push(arpu);
            data.ebitdaMarginTrend.push(ebitdaMargin);
          }
          
          data.adRevenue = data.revenue[months - 1];
          data.arpu = data.arpuTrend[months - 1];
          data.dau = data.users[months - 1] * 0.4;
          data.ebitdaMargin = data.ebitdaMarginTrend[months - 1];
          break;
          
        case 'manufacturing':
          data.units = [];
          data.revenue = [];
          data.grossProfit = [];
          data.grossMarginTrend = [];
          data.cashFlow = [];
          
          for (let i = 0; i < months; i++) {
            const units = driverValues.unitsPerMonth * (driverValues.utilizationRate / 100) * mult;
            const revenue = units * driverValues.sellPrice;
            const materialCost = revenue * (driverValues.materialCost / 100);
            const laborCost = revenue * (driverValues.laborCost / 100);
            const cogs = materialCost + laborCost;
            const grossProfit = revenue - cogs;
            const grossMargin = (grossProfit / revenue) * 100;
            const opex = 300000;
            const cashFlow = grossProfit - opex;
            
            data.units.push(units);
            data.revenue.push(revenue);
            data.grossProfit.push(grossProfit);
            data.grossMarginTrend.push(grossMargin);
            data.cashFlow.push(cashFlow);
          }
          
          data.grossMargin = data.grossMarginTrend[months - 1];
          data.unitEconomics = data.grossProfit[months - 1] / data.units[months - 1];
          break;
          
        case 'lending':
          data.portfolio = [];
          data.netIncome = [];
          data.defaultsTrend = [];
          
          let portfolio = driverValues.originations * 6;
          
          for (let i = 0; i < months; i++) {
            portfolio += driverValues.originations * mult;
            const monthlyInterest = portfolio * (driverValues.avgRate / 100 / 12);
            const monthlyFundingCost = portfolio * (driverValues.fundingCost / 100 / 12);
            const monthlyDefaults = portfolio * (driverValues.defaultRate / 100 / 12);
            const recovery = monthlyDefaults * (driverValues.recoveryRate / 100);
            const netLoss = monthlyDefaults - recovery;
            const opex = 100000;
            const netIncome = monthlyInterest - monthlyFundingCost - netLoss - opex;
            
            data.portfolio.push(portfolio);
            data.netIncome.push(netIncome);
            data.defaultsTrend.push(monthlyDefaults);
          }
          
          data.portfolioSize = data.portfolio[months - 1];
          data.netInterestMargin = ((driverValues.avgRate - driverValues.fundingCost) / driverValues.avgRate) * 100;
          data.lossRate = driverValues.defaultRate * (1 - driverValues.recoveryRate / 100);
          data.roe = (data.netIncome[months - 1] * 12 / (data.portfolio[months - 1] * 0.1)) * 100;
          break;
          
        case 'realestate':
          data.rent = [];
          data.noiTrend = [];
          data.fcf = [];
          
          for (let i = 0; i < months; i++) {
            const occupiedSqm = driverValues.totalSqm * (driverValues.occupancyRate / 100) * mult;
            const monthlyRent = occupiedSqm * driverValues.rentPerSqm;
            const opex = monthlyRent * (driverValues.opexRatio / 100);
            const noi = monthlyRent - opex;
            const fcf = noi - driverValues.debtService;
            
            data.rent.push(monthlyRent);
            data.noiTrend.push(noi);
            data.fcf.push(fcf);
          }
          
          data.rentalIncome = data.rent[months - 1];
          data.noi = data.noiTrend[months - 1];
          data.noiMargin = (data.noi / data.rentalIncome) * 100;
          data.capRate = (data.noi * 12 / (driverValues.totalSqm * driverValues.rentPerSqm * 200)) * 100;
          break;
      }
      
      return data;
    }

    // ============================================
    // RENDERING
    // ============================================
    
    function renderAll() {
      renderControls();
      renderKPIs();
      renderCharts();
      renderCommentary();
    }

    function renderControls() {
      const industry = INDUSTRIES[currentIndustry];
      const container = document.getElementById('controlsContainer');
      
      container.innerHTML = industry.drivers.map(driver => {
        const value = driverValues[driver.id];
        const formattedValue = formatValue(value, driver.format);
        
        return `
          <div class="control-item">
            <div class="control-label">
              <span>${driver.label}</span>
              <span class="control-value" id="value-${driver.id}">${formattedValue}</span>
            </div>
            <div class="control-input-wrapper">
              <input 
                type="range" 
                class="control-input" 
                id="input-${driver.id}"
                min="${driver.min}" 
                max="${driver.max}" 
                step="${driver.step}" 
                value="${value}"
                oninput="updateDriver('${driver.id}', this.value)"
              >
              <div class="control-buttons">
                <button class="control-btn" onclick="decrementDriver('${driver.id}')">‚àí</button>
                <button class="control-btn" onclick="incrementDriver('${driver.id}')">+</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderKPIs() {
      const industry = INDUSTRIES[currentIndustry];
      const grid = document.getElementById('kpiGrid');
      const data = modelData.scenarios[currentScenario];
      
      if (!data) return;
      
      grid.innerHTML = industry.kpis.map(kpi => {
        const value = data[kpi.id];
        const formattedValue = formatValue(value, kpi.format);
        
        let change = 0;
        let changeClass = 'neutral';
        if (currentScenario !== 'base') {
          const baseValue = modelData.scenarios['base'][kpi.id];
          if (baseValue && value) {
            change = ((value - baseValue) / baseValue) * 100;
            changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';
          }
        }
        
        return `
          <div class="kpi-card">
            <div class="kpi-label">${kpi.label}</div>
            <div class="kpi-value">${formattedValue}</div>
            ${currentScenario !== 'base' ? `
              <div class="kpi-change ${changeClass}">
                ${change > 0 ? '‚Üë' : change < 0 ? '‚Üì' : '‚Üí'} ${Math.abs(change).toFixed(1)}% vs Base
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function renderCharts() {
      const industry = INDUSTRIES[currentIndustry];
      
      Object.values(charts).forEach(chart => chart.destroy());
      charts = {};
      
      industry.charts.forEach((chartConfig, index) => {
        const canvas = document.getElementById(`chart${index + 1}`);
        const ctx = canvas.getContext('2d');
        
        document.getElementById(`chart${index + 1}Title`).textContent = chartConfig.title;
        
        const datasets = ['base', 'upside', 'downside'].map(scenario => {
          const data = modelData.scenarios[scenario][chartConfig.metric];
          const colors = {
            base: { border: '#0b1220', bg: 'rgba(11, 18, 32, 0.08)' },
            upside: { border: '#059669', bg: 'rgba(5, 150, 105, 0.10)' },
            downside: { border: '#dc2626', bg: 'rgba(220, 38, 38, 0.10)' }
          };
          
          return {
            label: scenario.charAt(0).toUpperCase() + scenario.slice(1),
            data: data || [],
            borderColor: colors[scenario].border,
            backgroundColor: colors[scenario].bg,
            borderWidth: currentScenario === scenario ? 3 : 2,
            tension: 0.4,
            fill: currentScenario === scenario,
            pointRadius: currentScenario === scenario ? 4 : 0,
            pointHoverRadius: 6
          };
        });
        
        charts[chartConfig.id] = new Chart(ctx, {
          type: 'line',
          data: {
            labels: modelData.months,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                align: 'end',
                labels: {
                  boxWidth: 12,
                  boxHeight: 12,
                  padding: 15,
                  font: {
                    size: 12,
                    weight: '600',
                    family: 'ui-sans-serif, system-ui, -apple-system'
                  },
                  color: '#5d6b7a',
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              },
              tooltip: {
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                titleColor: '#0b1220',
                bodyColor: '#5d6b7a',
                borderColor: 'rgba(12, 23, 45, 0.10)',
                borderWidth: 1,
                padding: 12,
                boxPadding: 6,
                usePointStyle: true,
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    label += formatValue(context.parsed.y, 'short');
                    return label;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: {
                    size: 11,
                    family: 'ui-sans-serif, system-ui'
                  },
                  color: '#5d6b7a'
                }
              },
              y: {
                beginAtZero: false,
                grid: {
                  color: 'rgba(12, 23, 45, 0.05)',
                  drawBorder: false
                },
                ticks: {
                  font: {
                    size: 11,
                    family: 'ui-sans-serif, system-ui'
                  },
                  color: '#5d6b7a',
                  callback: function(value) {
                    return formatValue(value, 'short');
                  }
                }
              }
            }
          }
        });
      });
    }

    function updateCharts() {
      Object.values(charts).forEach(chart => {
        chart.data.datasets.forEach((dataset, index) => {
          const scenarios = ['base', 'upside', 'downside'];
          const scenario = scenarios[index];
          
          dataset.borderWidth = currentScenario === scenario ? 3 : 2;
          dataset.fill = currentScenario === scenario;
          dataset.pointRadius = currentScenario === scenario ? 4 : 0;
        });
        chart.update('none');
      });
    }

    function renderCommentary() {
      const section = document.getElementById('commentarySection');
      const industry = INDUSTRIES[currentIndustry];
      const data = modelData.scenarios[currentScenario];
      
      if (!data) return;
      
      let commentary = generateCommentary(industry, data);
      
      section.innerHTML = `
        <div class="commentary-header">
          <div class="commentary-icon">üí°</div>
          <div>
            <div class="commentary-title">CFO Commentary ‚Äî ${currentScenario.charAt(0).toUpperCase() + currentScenario.slice(1)} Scenario</div>
          </div>
        </div>
        <div class="commentary-content">
          ${commentary}
        </div>
      `;
    }

    function generateCommentary(industry, data) {
      const months = modelData.months.length;
      
      switch (currentIndustry) {
        case 'saas':
          const runway = data.cash[months - 1] / 200000;
          const mrrGrowth = ((data.mrrTrend[months - 1] - data.mrrTrend[0]) / data.mrrTrend[0]) * 100;
          return `
            <p><strong>Performance:</strong> ARR stands at <span class="commentary-highlight">${formatValue(data.arr, 'currency')}</span> with ${formatValue(data.customers, 'number')} active customers. MRR grew ${mrrGrowth > 0 ? mrrGrowth.toFixed(1) + '% over the period' : 'with negative momentum'}.</p>
            <p><strong>Unit Economics:</strong> LTV/CAC ratio is <span class="commentary-highlight">${data.ltv.toFixed(2)}x</span>. ${data.ltv > 3 ? 'Strong unit economics support efficient growth.' : 'Consider optimizing CAC or reducing churn to improve unit economics.'} Net Revenue Retention at ${data.nrr.toFixed(0)}% ${data.nrr > 110 ? 'demonstrates strong expansion' : 'shows baseline retention'}.</p>
            <p><strong>Cash Position:</strong> Current cash balance of <span class="commentary-highlight">${formatValue(data.cash[months - 1], 'currency')}</span> provides approximately ${runway.toFixed(1)} months of runway. ${runway > 12 ? 'Healthy runway allows strategic investments.' : runway > 6 ? 'Monitor burn rate closely.' : 'Immediate action required to extend runway.'}</p>
          `;
          
        case 'media':
          const userGrowth = ((data.users[months - 1] - data.users[0]) / data.users[0]) * 100;
          return `
            <p><strong>Audience Growth:</strong> Platform reached <span class="commentary-highlight">${formatValue(data.users[months - 1], 'number')}</span> active users, growing ${userGrowth.toFixed(1)}% over the period. ARPU of <span class="commentary-highlight">${formatValue(data.arpu, 'currency')}</span> ${data.arpu > 5 ? 'exceeds industry benchmarks' : 'aligns with platform economics'}.</p>
            <p><strong>Monetization:</strong> Monthly ad revenue of <span class="commentary-highlight">${formatValue(data.adRevenue, 'currency')}</span> driven by engagement and fill rate optimization. EBITDA margin at ${data.ebitdaMargin.toFixed(1)}% ${data.ebitdaMargin > 20 ? 'demonstrates strong operating leverage' : 'requires scale for profitability'}.</p>
            <p><strong>Outlook:</strong> ${data.ebitdaMargin > 0 ? 'Positive unit economics achieved through scale.' : 'Path to profitability requires user base expansion or ARPU improvement.'} DAU estimated at ${formatValue(data.dau, 'number')} with engagement driving monetization.</p>
          `;
          
        case 'manufacturing':
          return `
            <p><strong>Production:</strong> Manufacturing ${formatValue(data.units[months - 1], 'number')} units per month generating <span class="commentary-highlight">${formatValue(data.revenue[months - 1], 'currency')}</span> in revenue. Utilization rate at ${driverValues.utilizationRate}% provides ${driverValues.utilizationRate < 85 ? 'capacity for volume growth' : 'optimal efficiency'}.</p>
            <p><strong>Margin Performance:</strong> Gross margin of <span class="commentary-highlight">${data.grossMargin.toFixed(1)}%</span> driven by material efficiency and labor optimization. Unit contribution of ${formatValue(data.unitEconomics, 'currency')} ${data.grossMargin > 40 ? 'supports profitable scaling' : 'requires cost optimization'}.</p>
            <p><strong>Cash Generation:</strong> Operating cash flow of <span class="commentary-highlight">${formatValue(data.cashFlow[months - 1], 'currency')}</span> per month. ${data.cashFlow[months - 1] > 0 ? 'Positive cash generation funds growth initiatives.' : 'Focus on margin improvement to achieve cash flow positivity.'}</p>
          `;
          
        case 'lending':
          return `
            <p><strong>Portfolio:</strong> Outstanding loan portfolio of <span class="commentary-highlight">${formatValue(data.portfolioSize, 'currency')}</span> with net interest margin of ${data.netInterestMargin.toFixed(2)}%. Monthly originations drive steady ${driverValues.originations > 5000000 ? 'aggressive' : 'moderate'} portfolio growth.</p>
            <p><strong>Credit Quality:</strong> Net loss rate of <span class="commentary-highlight">${data.lossRate.toFixed(2)}%</span> with ${driverValues.recoveryRate}% recovery on defaults. ${data.lossRate < 1 ? 'Credit performance remains strong with controlled losses.' : 'Monitor credit quality and underwriting standards closely.'}</p>
            <p><strong>Returns:</strong> Annualized ROE of ${data.roe.toFixed(1)}% ${data.roe > 15 ? 'demonstrates attractive returns on equity' : 'shows moderate profitability requiring optimization'}. Monthly net income of ${formatValue(data.netIncome[months - 1], 'currency')}.</p>
          `;
          
        case 'realestate':
          return `
            <p><strong>Occupancy:</strong> Property portfolio generating <span class="commentary-highlight">${formatValue(data.rentalIncome, 'currency')}</span> in monthly rental income at ${driverValues.occupancyRate}% occupancy. ${driverValues.occupancyRate > 90 ? 'Near-full occupancy maximizes revenue potential.' : 'Opportunity to improve occupancy through active leasing.'}</p>
            <p><strong>Operating Performance:</strong> NOI of <span class="commentary-highlight">${formatValue(data.noi, 'currency')}</span> with ${data.noiMargin.toFixed(1)}% margin. Operating efficiency ${data.noiMargin > 65 ? 'exceeds market standards' : 'aligns with industry benchmarks'}. Cap rate at ${data.capRate.toFixed(2)}%.</p>
            <p><strong>Cash Flow:</strong> Free cash flow after debt service of <span class="commentary-highlight">${formatValue(data.fcf[months - 1], 'currency')}</span> ${data.fcf[months - 1] > 0 ? 'supports distributions and reinvestment opportunities' : 'portfolio requires deleveraging or occupancy improvement'}.</p>
          `;
      }
    }

    // ============================================
    // DRIVER UPDATES
    // ============================================
    
    function updateDriver(driverId, value) {
      const numValue = parseFloat(value);
      driverValues[driverId] = numValue;
      
      const industry = INDUSTRIES[currentIndustry];
      const driver = industry.drivers.find(d => d.id === driverId);
      
      document.getElementById(`value-${driverId}`).textContent = formatValue(numValue, driver.format);
      
      const months = 12;
      ['base', 'upside', 'downside'].forEach(scenario => {
        modelData.scenarios[scenario] = generateScenarioData(scenario, months);
      });
      
      renderKPIs();
      updateChartsData();
      renderCommentary();
    }

    function updateChartsData() {
      const industry = INDUSTRIES[currentIndustry];
      
      industry.charts.forEach((chartConfig, index) => {
        const chart = charts[chartConfig.id];
        if (!chart) return;
        
        ['base', 'upside', 'downside'].forEach((scenario, datasetIndex) => {
          const data = modelData.scenarios[scenario][chartConfig.metric];
          chart.data.datasets[datasetIndex].data = data || [];
        });
        
        chart.update('active');
      });
    }

    function incrementDriver(driverId) {
      const industry = INDUSTRIES[currentIndustry];
      const driver = industry.drivers.find(d => d.id === driverId);
      const currentValue = driverValues[driverId];
      const newValue = Math.min(driver.max, currentValue + driver.step);
      
      driverValues[driverId] = newValue;
      document.getElementById(`input-${driverId}`).value = newValue;
      updateDriver(driverId, newValue);
    }

    function decrementDriver(driverId) {
      const industry = INDUSTRIES[currentIndustry];
      const driver = industry.drivers.find(d => d.id === driverId);
      const currentValue = driverValues[driverId];
      const newValue = Math.max(driver.min, currentValue - driver.step);
      
      driverValues[driverId] = newValue;
      document.getElementById(`input-${driverId}`).value = newValue;
      updateDriver(driverId, newValue);
    }

    // ============================================
    // DATA MODE
    // ============================================
    
    function updateDataModeIndicator() {
      const indicator = document.getElementById('dataModeIndicator');
      
      const labels = {
        sample: 'üìä Sample Data',
        random: 'üé≤ Random Data',
        uploaded: 'üìÅ User Data'
      };
      
      indicator.textContent = labels[currentDataMode];
    }

    function useSampleData() {
      initializeDrivers();
      generateSampleData();
      renderAll();
      showNotification('Switched to sample data', 'info');
    }

    // ============================================
    // FILE HANDLING
    // ============================================
    
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          
          Papa.parse(text, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
              if (results.data && results.data.length > 0) {
                uploadedData = results.data;
                currentDataMode = 'uploaded';
                updateDataModeIndicator();
                showDataPreview(results.data, results.meta.fields);
                showNotification(`${results.data.length} rows uploaded successfully`, 'success');
              } else {
                showNotification('No valid data found in file', 'error');
              }
            },
            error: function(error) {
              showNotification('Error parsing file: ' + error.message, 'error');
            }
          });
        } catch (error) {
          showNotification('Error reading file: ' + error.message, 'error');
        }
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    function showDataPreview(data, headers) {
      const section = document.getElementById('dataPreviewSection');
      const count = document.getElementById('dataPreviewCount');
      const thead = document.getElementById('dataTableHead');
      const tbody = document.getElementById('dataTableBody');
      
      section.style.display = 'block';
      count.textContent = `${data.length} rows`;
      
      thead.innerHTML = `
        <tr>
          ${headers.map(h => `<th>${h}</th>`).join('')}
        </tr>
      `;
      
      const rowsToShow = data.slice(0, 10);
      tbody.innerHTML = rowsToShow.map(row => `
        <tr>
          ${headers.map(h => `<td>${row[h] !== null && row[h] !== undefined ? row[h] : '-'}</td>`).join('')}
        </tr>
      `).join('');
    }

    function hideDataPreview() {
      document.getElementById('dataPreviewSection').style.display = 'none';
      uploadedData = null;
    }

    function downloadTemplate() {
      const industry = INDUSTRIES[currentIndustry];
      
      let csv = '';
      switch (currentIndustry) {
        case 'saas':
          csv = 'Month,Customer ID,Status,MRR,Churned,Expansion,CAC,Service Cost\n';
          csv += 'Jan 2025,CUST001,New,5000,0,0,1500,800\n';
          csv += 'Jan 2025,CUST002,Existing,3000,0,500,0,480\n';
          csv += 'Feb 2025,CUST003,New,4500,0,0,1500,720\n';
          break;
        case 'media':
          csv = 'Date,Users,Engagement Minutes,Ad Impressions,Fill Rate,CPM,Subscription Revenue,Content Cost\n';
          csv += 'Jan 2025,1000000,45,50000000,75,8,500000,2000000\n';
          csv += 'Feb 2025,1100000,46,55000000,76,8.2,520000,2100000\n';
          break;
        case 'manufacturing':
          csv = 'Date,SKU,Units Produced,Units Sold,Material Cost,Labor Cost,Overhead,Standard Cost,Selling Price\n';
          csv += 'Jan 2025,SKU001,10000,9500,35,20,15,70,100\n';
          csv += 'Jan 2025,SKU002,5000,4800,40,18,12,70,95\n';
          break;
        case 'lending':
          csv = 'Date,Loan ID,Origination Amount,Interest Rate,Term,Outstanding Balance,Days Past Due,Default Flag,Recovery Amount,Funding Cost\n';
          csv += 'Jan 2025,LOAN001,50000,8,36,45000,0,0,0,4\n';
          csv += 'Jan 2025,LOAN002,30000,9.5,24,25000,45,0,0,4.2\n';
          break;
        case 'realestate':
          csv = 'Month,Unit ID,Available Sqm,Occupied Flag,Rent Rate,Operating Cost,Maintenance,Debt Service\n';
          csv += 'Jan 2025,UNIT001,5000,1,30,45000,5000,12500\n';
          csv += 'Jan 2025,UNIT002,3000,0,30,27000,3000,7500\n';
          break;
      }
      
      csv += '\n# Notes:\n';
      csv += '# - Keep the header row unchanged\n';
      csv += '# - Fill in your actual data\n';
      csv += '# - Ensure data types match the template\n';
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentIndustry}-fpa-template.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification(`${INDUSTRIES[currentIndustry].name} template downloaded`, 'success');
    }

    // ============================================
    // UTILITIES
    // ============================================
    
    function formatValue(value, format) {
      if (value === null || value === undefined || isNaN(value)) return 'N/A';
      
      const numValue = Number(value);
      
      switch (format) {
        case 'currency':
          if (Math.abs(numValue) >= 1000000) {
            return '$' + (numValue / 1000000).toFixed(2) + 'M';
          } else if (Math.abs(numValue) >= 1000) {
            return '$' + (numValue / 1000).toFixed(1) + 'K';
          }
          return '$' + numValue.toLocaleString('en-US', { maximumFractionDigits: 0 });
          
        case 'percent':
          return numValue.toFixed(1) + '%';
          
        case 'ratio':
          return numValue.toFixed(2) + 'x';
          
        case 'number':
          if (numValue >= 1000000) {
            return (numValue / 1000000).toFixed(2) + 'M';
          } else if (numValue >= 1000) {
            return (numValue / 1000).toFixed(1) + 'K';
          }
          return Math.round(numValue).toLocaleString('en-US');
          
        case 'short':
          if (Math.abs(numValue) >= 1000000) {
            return '$' + (numValue / 1000000).toFixed(1) + 'M';
          } else if (Math.abs(numValue) >= 1000) {
            return '$' + (numValue / 1000).toFixed(0) + 'K';
          }
          return '$' + Math.round(numValue).toLocaleString('en-US');
          
        default:
          return numValue.toLocaleString('en-US');
      }
    }

    function showNotification(message, type = 'info') {
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-icon">${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</div>
        <div class="notification-message">${message}</div>
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideIn 300ms reverse';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // ============================================
    // INITIALIZE ON LOAD
    // ============================================
    
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
